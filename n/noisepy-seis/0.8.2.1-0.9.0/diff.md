# Comparing `tmp/noisepy_seis-0.8.2.1.tar.gz` & `tmp/noisepy_seis-0.9.0.tar.gz`

## Comparing `noisepy_seis-0.8.2.1.tar` & `noisepy_seis-0.9.0.tar`

### file list

```diff
@@ -1,25 +1,25 @@
--rw-r--r--   0        0        0    12029 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/S0A_download_ASDF_MPI.py
--rw-r--r--   0        0        0     9641 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/S0B_to_ASDF.py
--rw-r--r--   0        0        0    13473 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/S1_fft_cc_MPI.py
--rw-r--r--   0        0        0    15939 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/S2_stacking.py
--rw-r--r--   0        0        0     1484 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/__init__.py
--rw-r--r--   0        0        0      165 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/_version.py
--rw-r--r--   0        0        0     6492 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/asdfstore.py
--rw-r--r--   0        0        0     5326 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/channelcatalog.py
--rw-r--r--   0        0        0      158 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/constants.py
--rw-r--r--   0        0        0     5521 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/datatypes.py
--rw-r--r--   0        0        0     7274 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/main.py
--rw-r--r--   0        0        0   112958 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/noise_module.py
--rw-r--r--   0        0        0    34988 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/plotting_modules.py
--rw-r--r--   0        0        0     5805 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/scedc_s3store.py
--rw-r--r--   0        0        0     2390 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/stores.py
--rw-r--r--   0        0        0      832 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/utils.py
--rw-r--r--   0        0        0    12253 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/comp_stacking.py
--rw-r--r--   0        0        0     6882 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/dispersion_analysis.py
--rw-r--r--   0        0        0    14886 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/measure_dvv.py
--rw-r--r--   0        0        0     4697 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/write_sac.py
--rw-r--r--   0        0        0     3223 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/.gitignore
--rw-r--r--   0        0        0     1088 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/LICENSE
--rw-r--r--   0        0        0     7569 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/README.md
--rw-r--r--   0        0        0     1743 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/pyproject.toml
--rw-r--r--   0        0        0    10028 2020-02-02 00:00:00.000000 noisepy_seis-0.8.2.1/PKG-INFO
+-rw-r--r--   0        0        0    11830 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/S0A_download_ASDF_MPI.py
+-rw-r--r--   0        0        0     9641 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/S0B_to_ASDF.py
+-rw-r--r--   0        0        0    12770 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/S1_fft_cc_MPI.py
+-rw-r--r--   0        0        0    14238 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/S2_stacking.py
+-rw-r--r--   0        0        0     1484 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/__init__.py
+-rw-r--r--   0        0        0      160 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/_version.py
+-rw-r--r--   0        0        0     8500 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/asdfstore.py
+-rw-r--r--   0        0        0     5326 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/channelcatalog.py
+-rw-r--r--   0        0        0      186 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/constants.py
+-rw-r--r--   0        0        0     8194 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/datatypes.py
+-rw-r--r--   0        0        0     7241 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/main.py
+-rw-r--r--   0        0        0   112850 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/noise_module.py
+-rw-r--r--   0        0        0    34995 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/plotting_modules.py
+-rw-r--r--   0        0        0     5802 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/scedc_s3store.py
+-rw-r--r--   0        0        0     2607 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/stores.py
+-rw-r--r--   0        0        0     2280 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/utils.py
+-rw-r--r--   0        0        0    12253 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/application_modules/comp_stacking.py
+-rw-r--r--   0        0        0     6882 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/application_modules/dispersion_analysis.py
+-rw-r--r--   0        0        0    14886 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/application_modules/measure_dvv.py
+-rw-r--r--   0        0        0     4697 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/src/noisepy/seis/application_modules/write_sac.py
+-rw-r--r--   0        0        0     3242 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/.gitignore
+-rw-r--r--   0        0        0     1088 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/LICENSE
+-rw-r--r--   0        0        0     7569 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/README.md
+-rw-r--r--   0        0        0     1864 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/pyproject.toml
+-rw-r--r--   0        0        0    10203 2020-02-02 00:00:00.000000 noisepy_seis-0.9.0/PKG-INFO
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/S0A_download_ASDF_MPI.py` & `noisepy_seis-0.9.0/src/noisepy/seis/S0A_download_ASDF_MPI.py`

 * *Files 6% similar despite different names*

```diff
@@ -4,15 +4,14 @@
    isort:skip_file
 """
 
 
 import logging
 import sys
 import time
-from typing import List
 import obspy
 import pyasdf
 import os
 import numpy as np
 import pandas as pd
 
 from noisepy.seis.datatypes import ConfigParameters
@@ -70,21 +69,21 @@
 
 ##################################################
 # we expect no parameters need to be changed below
 
 
 def download(
     direc: str,
-    chan_list: List[str],
-    sta_list: List[str],
     prepro_para: ConfigParameters,
     client_url_key: str = "SCEDC",
 ):
     # client/data center. see https://docs.obspy.org/packages/obspy.clients.fdsn.html for a list
     client = Client(client_url_key)
+    chan_list = prepro_para.channels
+    sta_list = prepro_para.stations
 
     tt0 = time.time()
     dlist = os.path.join(direc, "station.txt")  # CSV file for station location info
     prepro_para.respdir = os.path.join(
         direc, "../resp"
     )  # directory where resp files are located (required if rm_resp is neither 'no' nor 'inv')
     # time tags
@@ -99,15 +98,14 @@
         From: {starttime}
         To: {endtime}
         Stations: {sta_list}
         Channels: {chan_list}
         """
     )
     ncomp = len(chan_list)
-    metadata = os.path.join(direc, "download_info.txt")
 
     # prepare station info (existing station list vs. fetching from client)
     if prepro_para.down_list:
         if not os.path.isfile(dlist):
             raise IOError("file %s not exist! double check!" % dlist)
 
         # read station info from list
@@ -205,19 +203,14 @@
                 "latitude": lat,
                 "longitude": lon,
                 "elevation": elev,
             }
             locs = pd.DataFrame(dict)
             locs.to_csv(os.path.join(direc, "station.txt"), index=False)
 
-        # save parameters for future reference
-        fout = open(metadata, "w")
-        fout.write(str(prepro_para))
-        fout.close()
-
         # get MPI variables ready
         all_chunk = noise_module.get_event_list(prepro_para.start_date, prepro_para.end_date, prepro_para.inc_hours)
         if len(all_chunk) < 1:
             raise ValueError("Abort! no data chunk between %s and %s" % (prepro_para.start_date, prepro_para.end_date))
         splits = len(all_chunk) - 1
     else:
         splits, all_chunk = [None for _ in range(2)]
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/S0B_to_ASDF.py` & `noisepy_seis-0.9.0/src/noisepy/seis/S0B_to_ASDF.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/S1_fft_cc_MPI.py` & `noisepy_seis-0.9.0/src/noisepy/seis/S1_fft_cc_MPI.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,23 +1,24 @@
 import gc
 import logging
 import sys
-import time
-from typing import List, Tuple
+from collections import OrderedDict
+from typing import Dict, List, Tuple
 
 import numpy as np
 import obspy
+import ray
 from datetimerange import DateTimeRange
-from mpi4py import MPI
 from scipy.fftpack.helper import next_fast_len
 
-from noisepy.seis.datatypes import Channel, ChannelData, ConfigParameters
+from noisepy.seis.datatypes import Channel, ChannelData, ConfigParameters, NoiseFFT
 
 from . import noise_module
 from .stores import CrossCorrelationDataStore, RawDataStore
+from .utils import TimeLogger
 
 logger = logging.getLogger(__name__)
 # ignore warnings
 if not sys.warnoptions:
     import warnings
 
     warnings.simplefilter("ignore")
@@ -62,225 +63,214 @@
         Parameters:
                 raw_store: Store to load data from
                 fft_params: Parameters for the FFT calculations
                 cc_store: Store for saving cross correlations
 
     """
 
-    #######################################
-    # #########PROCESSING SECTION##########
-    #######################################
-
-    tt0 = time.time()
-    # --------MPI---------
-    comm = MPI.COMM_WORLD
-    rank = comm.Get_rank()
-    size = comm.Get_size()
-
-    if rank == 0:
-        # save metadata
-        cc_store.save_parameters(fft_params)
-
-        # set variables to broadcast
-        timespans = raw_store.get_timespans()
-        splits = len(timespans)
-        if splits == 0:
-            raise IOError("Abort! no available seismic files for FFT")
-    else:
-        splits, timespans = (None, None)
+    tlog = TimeLogger(logger, logging.INFO)
+    t_s1_total = tlog.reset()
+
+    if not ray.is_initialized():
+        context = ray.init(ignore_reinit_error=True)
+        tlog.log("Ray init")
+        logger.info(context.dashboard_url)
+
+    # set variables to broadcast
+    timespans = raw_store.get_timespans()
+    splits = len(timespans)
+    if splits == 0:
+        raise IOError("Abort! no available seismic files for FFT")
 
-    # broadcast the variables
-    splits = comm.bcast(splits, root=0)
-    timespans = comm.bcast(timespans, root=0)
-
-    # MPI loop: loop through each user-defined time chunk
-    for ick in range(rank, splits, size):
-        t10 = time.time()
-        ts = timespans[ick]
+    for ts in timespans:
         if cc_store.is_done(ts):
             continue
 
-        # ###########LOADING NOISE DATA AND DO FFT##################
-        t0 = time.time()
-        channels = raw_store.get_channels(ts)
-        ch_data_tuples = _read_channels(ts, raw_store, channels, fft_params.samp_freq)
-        t01 = time.time()
+        """
+        LOADING NOISE DATA AND DO FFT
+        """
+        nnfft = int(next_fast_len(int(fft_params.cc_len * fft_params.samp_freq)))  # samp_freq should be sampling_rate
+
+        t_chunk = tlog.reset()  # for tracking overall chunk processing time
+        all_channels = raw_store.get_channels(ts)
+        tlog.log("get channels")
+        ch_data_tuples = _read_channels(ts, raw_store, all_channels, fft_params.samp_freq)
+        # only the channels we are using
+        channels = list(zip(*ch_data_tuples))[0]
+        tlog.log("read channel data")
+
         ch_data_tuples = preprocess(ch_data_tuples, raw_store, fft_params, ts)
-        t02 = time.time()
+        tlog.log("preprocess")
 
         nchannels = len(ch_data_tuples)
         nseg_chunk = check_memory(fft_params, nchannels)
-        nnfft = int(next_fast_len(int(fft_params.cc_len * fft_params.samp_freq)))  # samp_freq should be sampling_rate
-        # open array to store fft data/info in memory
-        fft_array = np.zeros((nchannels, nseg_chunk * (nnfft // 2)), dtype=np.complex64)
-        fft_std = np.zeros((nchannels, nseg_chunk), dtype=np.float32)
-        fft_flag = np.zeros(nchannels, dtype=np.int16)
-        fft_time = np.zeros((nchannels, nseg_chunk), dtype=np.float64)
+        # Dictionary to store all the FFTs, keyed by channel index
+        ffts: Dict[int, NoiseFFT] = OrderedDict()
 
         logger.debug(f"nseg_chunk: {nseg_chunk}, nnfft: {nnfft}")
         # loop through all channels
-        N: int
-        Nfft2: int
-        for ix_ch, (ch, ch_data) in enumerate(ch_data_tuples):
-            # TODO: Below the last values for N and Nfft are used?
-            fft_array[ix_ch], fft_std[ix_ch], fft_time[ix_ch], N, Nfft2 = compute_fft(fft_params, ch_data)
-            fft_flag[ix_ch] = fft_array[ix_ch].size > 0
-            if not fft_flag[ix_ch]:
-                logger.warning(f"No data available for channel '{ch}', skipped")
-        Nfft = Nfft2 * 2
+        tlog.reset()
 
-        # check whether array size is enough
-        if np.sum(fft_flag) != nchannels:
+        fft_refs = [compute_fft_ray.remote(fft_params, chd[1]) for chd in ch_data_tuples]
+        fft_datas = ray.get(fft_refs)
+        for ix_ch, fft_data in enumerate(fft_datas):
+            if fft_data.fft.size > 0:
+                ffts[ix_ch] = fft_data
+            else:
+                logger.warning(f"No data available for channel '{channels[ix_ch]}', skipped")
+        Nfft = fft_data.length
+        t_tasks = tlog.log("Compute FFTs")
+
+        if len(ffts) != nchannels:
             logger.warning("it seems some stations miss data in download step, but it is OKAY!")
 
-        # ###########PERFORM CROSS-CORRELATION##################
-        for iiS in range(nchannels):  # looping over the channel source
-            src_chan = channels[iiS]  # this is the name of the source channel
-            fft1 = fft_array[iiS]
-            source_std = fft_std[iiS]  # this is the array of data metrics
-
-            # this finds the windows of "good" noise
-            sou_ind = np.where((source_std < fft_params.max_over_std) & (source_std > 0) & (np.isnan(source_std) == 0))[
-                0
-            ]
-            if not fft_flag[iiS] or not len(sou_ind):
-                continue
-            # in the case of pure deconvolution, we recommend smoothing anyway.
-            if fft_params.cc_method == "deconv":
-                t00 = time.time()
-                # -----------get the smoothed source spectrum for decon later----------
-                sfft1 = noise_module.smooth_source_spect(fft_params, fft1)
-                sfft1 = sfft1.reshape(N, Nfft2)
-                t10 = time.time()
-                logger.debug("smoothing source takes %6.4fs" % (t10 - t00))
-            else:
-                sfft1 = np.conj(fft1).reshape(N, Nfft2)
+        tasks = []
+
+        # Put the FFTs into Ray's shared memory since they will be used by all tasks
+        ffts_ref = ray.put(ffts)
+        tlog.log("ray.put(ffts)")
+        # # ###########PERFORM CROSS-CORRELATION##################
+        for iiS in ffts.keys():  # looping over the channel source
+            # We parallelize over the channel sources. This is less than ideal because for each subsequent
+            # source there are fewer receiving channels to correlate with (ie. its a diagonal) matrix.
+            # This means the first task is the longest and the last one if very short. However,
+            # parallelizing over the full set of pairs results in too many tiny tasks and the parallelization
+            # overhead outweighs the benefits.
+            task = source_cross_correlation.remote(fft_params, channels, ffts_ref, Nfft, iiS)
+            tasks.append(task)
+        tlog.log(f"Created {len(tasks)} CC tasks", t_tasks)
+        while len(tasks) > 0:
+            # Use partial waits so we can start savign results to the store
+            # while other computations are still running
+            ready, tasks = ray.wait(tasks, num_returns=min(len(tasks), 4), timeout=0.250)
+            results = ray.get(ready)
+            results = [r for subresult in results for r in subresult]
+            for src_chan, rec_chan, parameters, corr in results:
+                cc_store.append(ts, src_chan, rec_chan, parameters, corr)
 
-            # get index right for auto/cross correlation
-            istart = iiS  # start at the channel source / only fills the upper right triangle matrix of channel pairs
-            iend = nchannels
-            #             if ncomp==1:
-            #                 iend=np.minimum(iiS+ncomp,iii)
-            #             else:
-            #                 if (channel[iiS][-1]=='Z'): # THIS IS NOT GENERALIZABLE. WE need to
-            #                                               change this to the order there are
-            #                                               bugs that shifts the components
-            #                     iend=np.minimum(iiS+1,iii)
-            #                 elif (channel[iiS][-1]=='N'):
-            #                     iend=np.minimum(iiS+2,iii)
-            #                 else:
-            #                     iend=np.minimum(iiS+ncomp,iii)
-
-            #         if fft_params.xcorr_only:
-            #             if ncomp==1:
-            #                 istart=np.minimum(iiS+ncomp,iii)
-            #             else:
-            #                 if (channel[iiS][-1]=='Z'):
-            #                     istart=np.minimum(iiS+1,iii)
-            #                 elif (channel[iiS][-1]=='N'):
-            #                     istart=np.minimum(iiS+2,iii)
-            #                 else:
-            #                     istart=np.minimum(iiS+ncomp,iii)
-
-            # -----------now loop III for each receiver B----------
-            for iiR in range(istart, iend):
-                rec_chan = channels[iiR]
-                if fft_params.acorr_only:
-                    if src_chan.station != rec_chan.station:
-                        continue
-                logger.debug(f"receiver: {rec_chan}")
-                if not fft_flag[iiR]:
-                    continue
-                if cc_store.contains(ts, src_chan, rec_chan, fft_params):
-                    continue
-
-                # read the receiver data
-                fft2 = fft_array[iiR]
-                sfft2 = fft2.reshape(N, Nfft2)
-                receiver_std = fft_std[iiR]
-
-                # ---------- check the existence of earthquakes or spikes ----------
-                rec_ind = np.where(
-                    (receiver_std < fft_params.max_over_std) & (receiver_std > 0) & (np.isnan(receiver_std) == 0)
-                )[0]
-                bb = np.intersect1d(sou_ind, rec_ind)
-                if len(bb) == 0:
-                    continue
-
-                # ----------- GAME TIME: cross correlation step ---------------
-                t2 = time.time()
-                corr, tcorr, ncorr = noise_module.correlate(
-                    sfft1[bb, :], sfft2[bb, :], fft_params, Nfft, fft_time[iiR][bb]
-                )
-                t3 = time.time()
-
-                # ---------- OUTPUT: store metadata and data into file ------------
-                coor = {
-                    "lonS": src_chan.station.lon,
-                    "latS": src_chan.station.lat,
-                    "lonR": rec_chan.station.lon,
-                    "latR": rec_chan.station.lat,
-                }
-                comp = src_chan.type.get_orientation() + rec_chan.type.get_orientation()
-                parameters = noise_module.cc_parameters(fft_params, coor, tcorr, ncorr, comp)
-                cc_store.append(ts, src_chan, rec_chan, fft_params, parameters, corr)
-                t4 = time.time()
-                logger.debug(
-                    "read S %6.4fs, process %6.4fs, cc %6.4fs, write cc %6.4fs"
-                    % ((t01 - t0), (t02 - t01), (t3 - t2), (t4 - t3))
-                )
-
-                del fft2, sfft2, receiver_std
-            del fft1, sfft1, source_std
-
-        fft_array = []
-        fft_std = []
-        fft_flag = []
-        fft_time = []
-        n = gc.collect()
-        print("unreadable garbarge", n)
+        ffts.clear()
+        gc.collect()
 
-        t11 = time.time()
-        print("it takes %6.2fs to process the chunk of %s" % (t11 - t10, ts))
+        tlog.log(f"Process the chunk of {ts}", t_chunk)
         cc_store.mark_done(ts)
 
-    tt1 = time.time()
-    print("it takes %6.2fs to process step 1 in total" % (tt1 - tt0))
-    comm.barrier()
+    tlog.log("Step 1 in total", t_s1_total)
+
+
+@ray.remote
+def source_cross_correlation(
+    fft_params: ConfigParameters,
+    channels: List[Channel],
+    ffts: Dict[int, NoiseFFT],
+    Nfft: int,
+    iiS: int,
+) -> List[Tuple[Channel, Channel, dict, np.ndarray]]:
+    src_chan = channels[iiS]  # this is the name of the source channel
+    src_fft = ffts[iiS]
+    src_std = src_fft.std
+    # this finds the windows of "good" noise
+    sou_ind = np.where((src_std < fft_params.max_over_std) & (src_std > 0) & (np.isnan(src_std) == 0))[0]
+    if len(sou_ind) == 0:
+        return None
+
+    # in the case of pure deconvolution, we recommend smoothing anyway.
+    if fft_params.cc_method == "deconv":
+        # -----------get the smoothed source spectrum for decon later----------
+        sfft1 = noise_module.smooth_source_spect(fft_params, src_fft.fft)
+        sfft1 = sfft1.reshape(src_fft.window_count, src_fft.length // 2)
+    else:
+        sfft1 = np.conj(src_fft.fft).reshape(src_fft.window_count, src_fft.length // 2)
+
+        # get index right for auto/cross correlation
+    istart = iiS  # start at the channel source / only fills the upper right triangle matrix of channel pairs
+    iend = len(channels)
+    # -----------now loop III for each receiver B----------
+    results = []
+    for iiR in range(istart, iend):
+        rec_chan = channels[iiR]
+        if fft_params.acorr_only:
+            if src_chan.station != rec_chan.station:
+                continue
+        if iiR not in ffts:
+            continue
+        result = cross_corr(fft_params, src_chan, rec_chan, sfft1, sou_ind, ffts[iiR], Nfft)
+        results.append(result)
+    del sfft1
+    return results
 
 
 def preprocess(
     ch_data: List[Tuple[Channel, ChannelData]], raw_store: RawDataStore, fft_params: ConfigParameters, ts: DateTimeRange
 ) -> List[Tuple[Channel, ChannelData]]:
-    new_streams = [
-        noise_module.preprocess_raw(
-            tup[1].stream,
-            raw_store.get_inventory(ts, tup[0].station),
-            fft_params,
-            obspy.UTCDateTime(ts.start_datetime),
-            obspy.UTCDateTime(ts.end_datetime),
-        )
-        for tup in ch_data
-    ]
+    stream_refs = [preprocess_ray.remote(raw_store, t[0], t[1], fft_params, ts) for t in ch_data]
+    new_streams = ray.get(stream_refs)
     channels = list(zip(*ch_data))[0]
     return list(zip(channels, [ChannelData(st) for st in new_streams]))
 
 
-def compute_fft(
-    fft_params: ConfigParameters, ch_data: ChannelData
-) -> Tuple[np.ndarray, np.ndarray, np.ndarray, int, int]:
+def cross_corr(
+    fft_params: ConfigParameters,
+    src_chan: Channel,
+    rec_chan: Channel,
+    sfft1: np.ndarray,
+    sou_ind: np.ndarray,
+    rec_fft: NoiseFFT,
+    Nfft: int,
+) -> Tuple[Channel, Channel, dict, np.ndarray]:
+    logger.debug(f"receiver: {rec_chan}")
+    # read the receiver data
+    sfft2 = rec_fft.fft.reshape(rec_fft.window_count, rec_fft.length // 2)
+    rec_std = rec_fft.std
+
+    # ---------- check the existence of earthquakes or spikes ----------
+    rec_ind = np.where((rec_std < fft_params.max_over_std) & (rec_std > 0) & (np.isnan(rec_std) == 0))[0]
+    bb = np.intersect1d(sou_ind, rec_ind)
+    if len(bb) == 0:
+        return
+
+    # ----------- GAME TIME: cross correlation step ---------------
+    corr, tcorr, ncorr = noise_module.correlate(sfft1[bb, :], sfft2[bb, :], fft_params, Nfft, rec_fft.fft_time[bb])
+
+    del sfft2
+    # ---------- OUTPUT: store metadata and data into file ------------
+    coor = {
+        "lonS": src_chan.station.lon,
+        "latS": src_chan.station.lat,
+        "lonR": rec_chan.station.lon,
+        "latR": rec_chan.station.lat,
+    }
+    comp = src_chan.type.get_orientation() + rec_chan.type.get_orientation()
+    parameters = noise_module.cc_parameters(fft_params, coor, tcorr, ncorr, comp)
+    return (src_chan, rec_chan, parameters, corr)
+
+
+@ray.remote
+def preprocess_ray(
+    raw_store: RawDataStore, ch: Channel, ch_data: ChannelData, fft_params: ConfigParameters, ts: DateTimeRange
+) -> obspy.Stream:
+    return noise_module.preprocess_raw(
+        ch_data.stream.copy(),  # If we don't copy it's not writeable
+        raw_store.get_inventory(ts, ch.station),
+        fft_params,
+        obspy.UTCDateTime(ts.start_datetime),
+        obspy.UTCDateTime(ts.end_datetime),
+    )
+
+
+@ray.remote
+def compute_fft_ray(fft_params: ConfigParameters, ch_data: ChannelData) -> NoiseFFT:
     if ch_data.data.size == 0:
-        return (np.empty, np.empty, np.empty, 0, 0)
+        return NoiseFFT(np.empty(0), np.empty(0), np.empty(0), 0, 0)
 
     # cut daily-long data into smaller segments (dataS always in 2D)
     trace_stdS, dataS_t, dataS = noise_module.cut_trace_make_stat(
         fft_params, ch_data
     )  # optimized version:3-4 times faster
     if not len(dataS):
-        return (np.empty, np.empty, np.empty, 0, 0)
+        return NoiseFFT(np.empty(0), np.empty(0), np.empty(0), 0, 0)
 
     N = dataS.shape[0]
 
     # do normalization if needed
     source_white = noise_module.noise_processing(fft_params, dataS)
     Nfft = source_white.shape[1]
     Nfft2 = Nfft // 2
@@ -288,25 +278,31 @@
 
     # load fft data in memory for cross-correlations
     data = source_white[:, :Nfft2]
     fft = data.reshape(data.size)
     std = trace_stdS
     fft_time = dataS_t
     del trace_stdS, dataS_t, dataS, source_white, data
-    return fft, std, fft_time, N, Nfft2
+    return NoiseFFT(fft, std, fft_time, N, Nfft)
 
 
 def _read_channels(
     ts: DateTimeRange, store: RawDataStore, channels: List[Channel], samp_freq: int
 ) -> List[Tuple[Channel, ChannelData]]:
-    ch_data = [store.read_data(ts, ch) for ch in channels]
+    ch_data_refs = [read_data_ray.remote(store, ts, ch) for ch in channels]
+    ch_data = ray.get(ch_data_refs)
     tuples = list(zip(channels, ch_data))
     return _filter_channel_data(tuples, samp_freq)
 
 
+@ray.remote
+def read_data_ray(store: RawDataStore, ts: DateTimeRange, ch: Channel) -> ChannelData:
+    return store.read_data(ts, ch)
+
+
 def _filter_channel_data(
     tuples: List[Tuple[Channel, ChannelData]], samp_freq: int
 ) -> List[Tuple[Channel, ChannelData]]:
     frequencies = set(t[1].sampling_rate for t in tuples)
     closest_freq = min(
         filter(lambda f: f >= samp_freq, frequencies),
         key=lambda f: max(f - samp_freq, 0),
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/S2_stacking.py` & `noisepy_seis-0.9.0/src/noisepy/seis/S2_stacking.py`

 * *Files 11% similar despite different names*

```diff
@@ -1,19 +1,22 @@
-import glob
 import logging
 import os
 import sys
-import time
-from typing import List
+from typing import Tuple
 
 import numpy as np
 import pandas as pd
 import pyasdf
+from datetimerange import DateTimeRange
 from mpi4py import MPI
 
+from noisepy.seis.datatypes import ConfigParameters
+from noisepy.seis.stores import CrossCorrelationDataStore
+from noisepy.seis.utils import TimeLogger
+
 from . import noise_module
 
 logger = logging.getLogger(__name__)
 if not sys.warnoptions:
     import warnings
 
     warnings.simplefilter("ignore")
@@ -32,285 +35,191 @@
 NOTE:
     0. MOST occasions you just need to change parameters followed with detailed explanations to run the script.
     1. assuming 3 components are E-N-Z
     2. auto-correlation is not kept in the stacking due to the fact that it has only 6 cross-component.
     this tends to mess up the orders of matrix that stores the CCFs data
 """
 
-tt0 = time.time()
-
-########################################
-# #######PARAMETER SECTION##############
-########################################
-
-
-# define new stacking para
-keep_substack = False  # keep all sub-stacks in final ASDF file
-
-# new rotation para
-rotation = True  # rotation from E-N-Z to R-T-Z
-correction = False  # angle correction due to mis-orientation
 
 # maximum memory allowed per core in GB
 MAX_MEM = 4.0
 
 
 # TODO: make stack_method an enum
-def stack(sta: List[str], ccf_dir: str, stack_dir: str, stack_method: str):
-    if rotation and correction:
-        corrfile = os.path.join(ccf_dir, "../meso_angles.txt")  # csv file containing angle info to be corrected
+def stack(cc_store: CrossCorrelationDataStore, stack_dir: str, fft_params: ConfigParameters):
+    tlog = TimeLogger(logger=logger)
+    t_tot = tlog.reset()
+    if fft_params.rotation and fft_params.correction:
+        corrfile = os.path.join(stack_dir, "../meso_angles.txt")  # csv file containing angle info to be corrected
         locs = pd.read_csv(corrfile)
     else:
         locs = []
 
-    ##################################################
-    # we expect no parameters need to be changed below
-
-    # load fc_para parameters from Step1
-    fc_metadata = os.path.join(ccf_dir, "fft_cc_data.txt")
-    fc_para = eval(open(fc_metadata).read())
-    ncomp = fc_para["ncomp"]
-    samp_freq = fc_para["samp_freq"]
-    start_date = fc_para["start_date"]
-    end_date = fc_para["end_date"]
-    inc_hours = fc_para["inc_hours"]
-    cc_len = fc_para["cc_len"]
-    step = fc_para["step"]
-    maxlag = fc_para["maxlag"]
-    substack = fc_para["substack"]
-    substack_len = fc_para["substack_len"]
-
     # cross component info
-    if ncomp == 1:
+    if fft_params.ncomp == 1:
         enz_system = ["ZZ"]
     else:
         enz_system = ["EE", "EN", "EZ", "NE", "NN", "NZ", "ZE", "ZN", "ZZ"]
 
     rtz_components = ["ZR", "ZT", "ZZ", "RR", "RT", "RZ", "TR", "TT", "TZ"]
 
-    # make a dictionary to store all variables: also for later cc
-    stack_para = {
-        "samp_freq": samp_freq,
-        "cc_len": cc_len,
-        "step": step,
-        "stack_dir": stack_dir,
-        "start_date": start_date,
-        "end_date": end_date,
-        "inc_hours": inc_hours,
-        "substack": substack,
-        "substack_len": substack_len,
-        "maxlag": maxlag,
-        "keep_substack": keep_substack,
-        "stack_method": stack_method,
-        "rotation": rotation,
-        "correction": correction,
-    }
-    # save fft metadata for future reference
-    stack_metadata = os.path.join(stack_dir, "stack_data.txt")
-
     #######################################
     # #########PROCESSING SECTION##########
     #######################################
 
     # --------MPI---------
     comm = MPI.COMM_WORLD
     rank = comm.Get_rank()
     size = comm.Get_size()
 
     if rank == 0:
         if not os.path.isdir(stack_dir):
             os.mkdir(stack_dir)
-        # save metadata
-        fout = open(stack_metadata, "w")
-        fout.write(str(stack_para))
-        fout.close()
-
-        # cross-correlation files
-        ccfiles = sorted(glob.glob(os.path.join(ccf_dir, "*.h5")))
-        logger.debug(ccfiles)
-
-        for ii in range(len(sta)):
-            tmp = os.path.join(stack_dir, sta[ii])
-            if not os.path.isdir(tmp):
-                os.mkdir(tmp)
-
-        # station-pairs
-        pairs_all = []
-        for ii in range(len(sta) - 1):
-            for jj in range(ii, len(sta)):
-                pairs_all.append(sta[ii] + "_" + sta[jj])
+
+        timespans = cc_store.get_timespans()
+        pairs_all = list(set(pair for ts in timespans for pair in cc_store.get_station_pairs(ts)))
+        logger.info(f"Station pairs: {pairs_all}")
+        stations = set(pair[0] for pair in pairs_all)
+
+        for station in stations:
+            os.makedirs(os.path.join(stack_dir, str(station)), exist_ok=True)
 
         splits = len(pairs_all)
-        if len(ccfiles) == 0 or splits == 0:
+        if len(timespans) == 0 or splits == 0:
             raise IOError("Abort! no available CCF data for stacking")
-
     else:
-        splits, ccfiles, pairs_all = [None for _ in range(3)]
+        splits, timespans, pairs_all = [None for _ in range(3)]
 
     # broadcast the variables
     splits = comm.bcast(splits, root=0)
-    ccfiles = comm.bcast(ccfiles, root=0)
+    timespans = comm.bcast(timespans, root=0)
     pairs_all = comm.bcast(pairs_all, root=0)
+    nccomp = fft_params.ncomp * fft_params.ncomp
+    num_chunk = len(timespans) * nccomp
+    num_segmts = 1
 
     # MPI loop: loop through each user-defined time chunck
     for ipair in range(rank, splits, size):
-        t0 = time.time()
+        tlog.reset()
 
         logger.debug("%dth path for station-pair %s" % (ipair, pairs_all[ipair]))
-        # source folder
-        ttr = pairs_all[ipair].split("_")
-        snet, ssta = ttr[0].split(".")
-        rnet, rsta = ttr[1].split(".")
-        idir = ttr[0]
+        sta_pair = pairs_all[ipair]
+        src_sta = sta_pair[0]
+        rec_sta = sta_pair[1]
+        idir = str(src_sta)
 
         # check if it is auto-correlation
-        if ssta == rsta and snet == rnet:
+        if src_sta == rec_sta:
             fauto = 1
         else:
             fauto = 0
 
         # continue when file is done: TODO: Remove this and use a Store.contains() function.
-        toutfn = os.path.join(stack_dir, idir + "/" + pairs_all[ipair] + ".tmp")
+        toutfn = os.path.join(stack_dir, idir, f"{src_sta}_{rec_sta}.tmp")
         if os.path.isfile(toutfn):
             continue
 
         # crude estimation on memory needs (assume float32)
-        nccomp = ncomp * ncomp
-        num_chunck = len(ccfiles) * nccomp
-        num_segmts = 1
-        if substack:  # things are difference when do substack
-            if substack_len == cc_len:
-                num_segmts = int(np.floor((inc_hours * 3600 - cc_len) / step))
-            else:
-                num_segmts = int(inc_hours / (substack_len / 3600))
-        npts_segmt = int(2 * maxlag * samp_freq) + 1
-        memory_size = num_chunck * num_segmts * npts_segmt * 4 / 1024**3
-
-        if memory_size > MAX_MEM:
-            raise ValueError(
-                "Require %5.3fG memory but only %5.3fG provided)! Cannot load cc data all once!"
-                % (memory_size, MAX_MEM)
-            )
-        logger.debug("Good on memory (need %5.2f G and %s G provided)!" % (memory_size, MAX_MEM))
+        num_segmts, npts_segmt = calc_segments(fft_params, num_chunk)
         # allocate array to store fft data/info
-        cc_array = np.zeros((num_chunck * num_segmts, npts_segmt), dtype=np.float32)
-        cc_time = np.zeros(num_chunck * num_segmts, dtype=np.float32)
-        cc_ngood = np.zeros(num_chunck * num_segmts, dtype=np.int16)
-        cc_comp = np.chararray(num_chunck * num_segmts, itemsize=2, unicode=True)
+        cc_array = np.zeros((num_chunk * num_segmts, npts_segmt), dtype=np.float32)
+        cc_time = np.zeros(num_chunk * num_segmts, dtype=np.float32)
+        cc_ngood = np.zeros(num_chunk * num_segmts, dtype=np.int16)
+        cc_comp = np.chararray(num_chunk * num_segmts, itemsize=2, unicode=True)
 
         # loop through all time-chuncks
         iseg = 0
-        dtype = pairs_all[ipair]
-        for ifile in ccfiles:
+        for ts in timespans:
             # load the data from daily compilation
-            ds = pyasdf.ASDFDataSet(ifile, mpi=False, mode="r")
-            try:
-                path_list = ds.auxiliary_data[dtype].list()
-                tparameters = ds.auxiliary_data[dtype][path_list[0]].parameters
-            except Exception:
-                logger.debug("continue! no pair of %s in %s" % (dtype, ifile))
-                continue
-            logger.debug(f"path_list for {dtype}: {path_list}")
-            # seperate auto and cross-correlation
-            if fauto == 1:
-                if ncomp == 3 and len(path_list) < 6:
-                    logger.warning(
-                        "continue! not enough cross components for auto-correlation %s in %s" % (dtype, ifile)
-                    )
-                    continue
-            else:
-                if ncomp == 3 and len(path_list) < 9:
-                    logger.warning(
-                        "continue! not enough cross components for cross-correlation %s in %s" % (dtype, ifile)
-                    )
-                    continue
+            ch_pairs = cc_store.get_channeltype_pairs(ts, src_sta, rec_sta)
 
-            if len(path_list) > 9:
-                raise ValueError("more than 9 cross-component exists for %s %s! please double check" % (ifile, dtype))
+            logger.debug(f"path_list for {src_sta}-{rec_sta}: {ch_pairs}")
+            # seperate auto and cross-correlation
+            if not validate_pairs(fft_params.ncomp, str(sta_pair), fauto, ts, len(ch_pairs)):
+                continue
 
             # load the 9-component data, which is in order in the ASDF
-            for tpath in path_list:
-                cmp1 = tpath.split("_")[0]
-                cmp2 = tpath.split("_")[1]
-                tcmp1 = cmp1[-1]
-                tcmp2 = cmp2[-1]
+            for ch_pair in ch_pairs:
+                src_chan, rec_chan = ch_pair
+                tcmp1 = src_chan.get_orientation()
+                tcmp2 = rec_chan.get_orientation()
 
                 # read data and parameter matrix
-                tdata = ds.auxiliary_data[dtype][tpath].data[:]
-                ttime = ds.auxiliary_data[dtype][tpath].parameters["time"]
-                tgood = ds.auxiliary_data[dtype][tpath].parameters["ngood"]
-                if substack:
+                tparameters, tdata = cc_store.read(ts, src_sta, rec_sta, src_chan, rec_chan)
+                ttime = tparameters["time"]
+                tgood = tparameters["ngood"]
+                if fft_params.substack:
                     for ii in range(tdata.shape[0]):
                         cc_array[iseg] = tdata[ii]
                         cc_time[iseg] = ttime[ii]
                         cc_ngood[iseg] = tgood[ii]
                         cc_comp[iseg] = tcmp1 + tcmp2
                         iseg += 1
                 else:
                     cc_array[iseg] = tdata
                     cc_time[iseg] = ttime
                     cc_ngood[iseg] = tgood
                     cc_comp[iseg] = tcmp1 + tcmp2
                     iseg += 1
 
-        t1 = time.time()
-        logger.debug("loading CCF data takes %6.2fs" % (t1 - t0))
+        t_load = tlog.log("loading CCF data")
 
         # continue when there is no data or for auto-correlation
         if iseg <= 1 and fauto == 1:
             continue
-        outfn = pairs_all[ipair] + ".h5"
+        outfn = f"{src_sta}_{rec_sta}.h5"
         logger.debug("ready to output to %s" % (outfn))
 
         # matrix used for rotation
-        if rotation:
+        if fft_params.rotation:
             bigstack = np.zeros(shape=(9, npts_segmt), dtype=np.float32)
-        if stack_method == "all":
+        if fft_params.stack_method == "all":
             bigstack1 = np.zeros(shape=(9, npts_segmt), dtype=np.float32)
             bigstack2 = np.zeros(shape=(9, npts_segmt), dtype=np.float32)
 
         # loop through cross-component for stacking
         iflag = 1
         for icomp in range(nccomp):
+            tlog.reset()
             comp = enz_system[icomp]
             indx = np.where(cc_comp.lower() == comp.lower())[0]
             logger.debug(f"index to find the comp: {indx}")
 
             # jump if there are not enough data
             if len(indx) < 2:
                 iflag = 0
-                break
+                continue
 
             stack_h5 = os.path.join(stack_dir, idir + "/" + outfn)
             logger.debug(f"h5 stack path: {stack_h5}")
             # output stacked data
             (
                 cc_final,
                 ngood_final,
                 stamps_final,
                 allstacks1,
                 allstacks2,
                 allstacks3,
                 nstacks,
-            ) = noise_module.stacking(cc_array[indx], cc_time[indx], cc_ngood[indx], stack_para)
+            ) = noise_module.stacking(cc_array[indx], cc_time[indx], cc_ngood[indx], fft_params)
             logger.debug(f"after stacking nstacks: {nstacks}")
             if not len(allstacks1):
                 continue
-            if rotation:
+            if fft_params.rotation:
                 bigstack[icomp] = allstacks1
-                if stack_method == "all":
+                if fft_params.stack_method == "all":
                     bigstack1[icomp] = allstacks2
                     bigstack2[icomp] = allstacks3
 
             # write stacked data into ASDF file
             with pyasdf.ASDFDataSet(stack_h5, mpi=False) as ds:
                 tparameters["time"] = stamps_final[0]
                 tparameters["ngood"] = nstacks
-                if stack_method != "all":
-                    data_type = "Allstack_" + stack_method
+                if fft_params.stack_method != "all":
+                    data_type = "Allstack_" + fft_params.stack_method
                     ds.add_auxiliary_data(
                         data=allstacks1,
                         data_type=data_type,
                         path=comp,
                         parameters=tparameters,
                     )
                 else:
@@ -329,45 +238,44 @@
                     ds.add_auxiliary_data(
                         data=allstacks3,
                         data_type="Allstack_robust",
                         path=comp,
                         parameters=tparameters,
                     )
             # keep a track of all sub-stacked data from S1
-            if keep_substack:
+            if fft_params.keep_substack:
                 for ii in range(cc_final.shape[0]):
                     with pyasdf.ASDFDataSet(stack_h5, mpi=False) as ds:
                         tparameters["time"] = stamps_final[ii]
                         tparameters["ngood"] = ngood_final[ii]
                         data_type = "T" + str(int(stamps_final[ii]))
                         ds.add_auxiliary_data(
                             data=cc_final[ii],
                             data_type=data_type,
                             path=comp,
                             parameters=tparameters,
                         )
 
-            t3 = time.time()
-            logger.debug("takes %6.2fs to stack one component with %s stacking method" % (t3 - t1, stack_method))
+            tlog.log(f"stack one component with {fft_params.stack_method} stacking method")
 
         # do rotation if needed
-        if rotation and iflag:
+        if fft_params.rotation and iflag:
             if np.all(bigstack == 0):
                 continue
-            tparameters["station_source"] = ssta
-            tparameters["station_receiver"] = rsta
-            if stack_method != "all":
+            tparameters["station_source"] = src_sta.name
+            tparameters["station_receiver"] = rec_sta.name
+            if fft_params.stack_method != "all":
                 bigstack_rotated = noise_module.rotation(bigstack, tparameters, locs)
 
                 # write to file
                 for icomp in range(nccomp):
                     comp = rtz_components[icomp]
                     tparameters["time"] = stamps_final[0]
                     tparameters["ngood"] = nstacks
-                    data_type = "Allstack_" + stack_method
+                    data_type = "Allstack_" + fft_params.stack_method
                     with pyasdf.ASDFDataSet(stack_h5, mpi=False) as ds2:
                         ds2.add_auxiliary_data(
                             data=bigstack_rotated[icomp],
                             data_type=data_type,
                             path=comp,
                             parameters=tparameters,
                         )
@@ -397,23 +305,53 @@
                         ds2.add_auxiliary_data(
                             data=bigstack_rotated2[icomp],
                             data_type="Allstack_robust",
                             path=comp,
                             parameters=tparameters,
                         )
 
-        t4 = time.time()
-        logger.debug("takes %6.2fs to stack/rotate all station pairs %s" % (t4 - t1, pairs_all[ipair]))
+        tlog.log(f"stack/rotate all station pairs {pairs_all[ipair]}", t_load)
 
         # write file stamps
         ftmp = open(toutfn, "w")
         ftmp.write("done")
         ftmp.close()
 
-    tt1 = time.time()
-    logger.info("it takes %6.2fs to process step 2 in total" % (tt1 - tt0))
+    tlog.log("step 2 in total", t_tot)
     comm.barrier()
 
 
+def validate_pairs(ncomp: int, sta_pair: str, fauto: int, ts: DateTimeRange, n_pairs: int) -> bool:
+    if fauto == 1:
+        if ncomp == 3 and n_pairs < 6:
+            logger.warning("continue! not enough cross components for auto-correlation %s in %s" % (sta_pair, ts))
+            return False
+    else:
+        if ncomp == 3 and n_pairs < 9:
+            logger.warning("continue! not enough cross components for cross-correlation %s in %s" % (sta_pair, ts))
+            return False
+
+    if n_pairs > 9:
+        raise ValueError("more than 9 cross-component exists for %s %s! please double check" % (ts, sta_pair))
+    return True
+
+
+def calc_segments(fft_params: ConfigParameters, num_chunk: int) -> Tuple[int, int]:
+    if fft_params.substack:  # things are difference when do substack
+        if fft_params.substack_len == fft_params.cc_len:
+            num_segmts = int(np.floor((fft_params.inc_hours * 3600 - fft_params.cc_len) / fft_params.step))
+        else:
+            num_segmts = int(fft_params.inc_hours / (fft_params.substack_len / 3600))
+    npts_segmt = int(2 * fft_params.maxlag * fft_params.samp_freq) + 1
+    memory_size = num_chunk * num_segmts * npts_segmt * 4 / 1024**3
+
+    if memory_size > MAX_MEM:
+        raise ValueError(
+            "Require %5.3fG memory but only %5.3fG provided)! Cannot load cc data all once!" % (memory_size, MAX_MEM)
+        )
+    logger.debug("Good on memory (need %5.2f G and %s G provided)!" % (memory_size, MAX_MEM))
+    return num_segmts, npts_segmt
+
+
 # Point people to new entry point:
 if __name__ == "__main__":
     print("Please see:\n\npython noisepy.py stack --help\n")
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/__init__.py` & `noisepy_seis-0.9.0/src/noisepy/seis/__init__.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/asdfstore.py` & `noisepy_seis-0.9.0/src/noisepy/seis/scedc_s3store.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,158 +1,143 @@
-import datetime
-import glob
 import logging
 import os
-from functools import lru_cache
-from pathlib import Path
-from typing import Any, Dict, List, Optional
+import re
+from datetime import datetime, timedelta, timezone
+from typing import Callable, List
 
-import numpy as np
 import obspy
-import pyasdf
 from datetimerange import DateTimeRange
 
-from . import noise_module
-from .constants import DATE_FORMAT, DONE_PATH, PROGRESS_DATATYPE
-from .datatypes import Channel, ChannelData, ChannelType, ConfigParameters, Station
-from .stores import CrossCorrelationDataStore, RawDataStore
+from noisepy.seis.channelcatalog import ChannelCatalog
+from noisepy.seis.stores import RawDataStore
+
+from .datatypes import Channel, ChannelData, ChannelType, Station
+from .utils import fs_join, get_filesystem
 
 logger = logging.getLogger(__name__)
 
 
-class ASDFRawDataStore(RawDataStore):
+def channel_filter(stations: List[str], ch_prefix: str) -> Callable[[Channel], bool]:
     """
-    A data store implementation to read from a directory of ASDF files. Each file is considered
-    a timespan with the naming convention: 2019_02_01_00_00_00T2019_02_02_00_00_00.h5
+    Helper function for creating a channel filter to be used in the constructor of the store.
+    This filter uses a list of allowed station name along with a channel filter prefix.
     """
+    sta_set = set(stations)
+
+    def filter(ch: Channel) -> bool:
+        return ch.station.name in sta_set and ch.type.name.lower().startswith(ch_prefix.lower())
+
+    return filter
 
-    def __init__(self, directory: str):
+
+class SCEDCS3DataStore(RawDataStore):
+    """
+    A data store implementation to read from a directory of miniSEED (.ms) files from the SCEDC S3 bucket.
+    Every directory is a a day and each .ms file contains the data for a channel.
+    """
+
+    # TODO: Support reading directly from the S3 bucket
+
+    # for checking the filename has the form: CIGMR__LHN___2022002.ms
+    file_re = re.compile(r".*[0-9]{7}\.ms$", re.IGNORECASE)
+
+    def __init__(
+        self,
+        path: str,
+        chan_catalog: ChannelCatalog,
+        ch_filter: Callable[[Channel], bool] = None,
+        date_range: DateTimeRange = None,
+    ):
+        """
+        Parameters:
+            path: path to look for ms files. Can be a local file directory or an s3://... url path
+            chan_catalog: ChannelCatalog to retrieve inventory information for the channels
+            channel_filter: Function to decide whether a channel should be used or not,
+                            if None, all channels are used
+        """
         super().__init__()
-        self.directory = directory
-        h5files = sorted(glob.glob(os.path.join(directory, "*.h5")))
-        self.files = {str(self._parse_timespans(f)): f for f in h5files}
-        logger.info(f"Initialized store with {len(self.files)}")
+        self.fs = get_filesystem(path)
+        self.channel_catalog = chan_catalog
+        self.path = path
+        self.paths = {}
+        # to store a dict of {timerange: list of channels}
+        self.channels = {}
+        if ch_filter is None:
+            ch_filter = lambda s: True  # noqa: E731
+
+        if date_range is None:
+            self._load_channels(self.path, ch_filter)
+        else:
+            dt = date_range.end_datetime - date_range.start_datetime
+            for d in range(0, dt.days):
+                date = date_range.start_datetime + timedelta(days=d)
+                date_path = str(date.year) + "/" + str(date.year) + "_" + str(date.timetuple().tm_yday).zfill(3) + "/"
+                full_path = fs_join(self.path, date_path)
+                self._load_channels(full_path, ch_filter)
+
+    def _load_channels(self, full_path: str, ch_filter: Callable[[Channel], bool]):
+        msfiles = [f for f in self.fs.glob(fs_join(full_path, "*.ms")) if self.file_re.match(f) is not None]
+        logger.info(f"Loading {len(msfiles)} files from {full_path}")
+        timespans = []
+        for f in msfiles:
+            timespan = SCEDCS3DataStore._parse_timespan(f)
+            self.paths[timespan.start_datetime] = full_path
+            channel = SCEDCS3DataStore._parse_channel(os.path.basename(f))
+            if not ch_filter(channel):
+                continue
+            key = str(timespan)  # DataTimeFrame is not hashable
+            if key not in self.channels:
+                timespans.append(timespan)
+                self.channels[key] = [channel]
+            else:
+                self.channels[key].append(channel)
+        logger.info(
+            f"Init: {len(self.channels)} timespans and {sum(len(ch) for ch in  self.channels.values())} channels"
+        )
 
     def get_channels(self, timespan: DateTimeRange) -> List[Channel]:
-        ds = self.get_dataset(str(timespan))
-        stations = [self._create_station(timespan, sta) for sta in ds.waveforms.list() if sta is not None]
-        channels = [
-            Channel(ChannelType(tag), sta) for sta in stations for tag in ds.waveforms[str(sta)].get_waveform_tags()
-        ]
-        return channels
+        tmp_channels = self.channels.get(str(timespan), [])
+        return list(map(lambda c: self.channel_catalog.get_full_channel(timespan, c), tmp_channels))
 
     def get_timespans(self) -> List[DateTimeRange]:
-        return [DateTimeRange.from_range_text(d) for d in sorted(self.files.keys())]
+        return list([DateTimeRange.from_range_text(d) for d in sorted(self.channels.keys())])
+
+    def read_data(self, timespan: DateTimeRange, chan: Channel) -> ChannelData:
+        # reconstruct the file name from the channel parameters
+        chan_str = (
+            f"{chan.station.network}{chan.station.name.ljust(5, '_')}{chan.type.name}"
+            f"{chan.station.location.ljust(3, '_')}"
+        )
+        filename = fs_join(
+            self.paths[timespan.start_datetime], f"{chan_str}{timespan.start_datetime.strftime('%Y%j')}.ms"
+        )
+        if not self.fs.exists(filename):
+            logger.warning(f"Could not find file {filename}")
+            return ChannelData.empty()
 
-    def read_data(self, timespan: DateTimeRange, chan: Channel) -> np.ndarray:
-        ds = self.get_dataset(str(timespan))
-        stream = ds.waveforms[str(chan.station)][str(chan.type)]
+        with self.fs.open(filename) as f:
+            stream = obspy.read(f)
         return ChannelData(stream)
 
     def get_inventory(self, timespan: DateTimeRange, station: Station) -> obspy.Inventory:
-        ds = self.get_dataset(str(timespan))
-        return ds.waveforms[str(station)]["StationXML"]
-
-    def _parse_timespans(self, filename: str) -> DateTimeRange:
-        parts = os.path.splitext(os.path.basename(filename))[0].split("T")
-        dates = [obspy.UTCDateTime(p).datetime.replace(tzinfo=datetime.timezone.utc) for p in parts]
-        return DateTimeRange(dates[0], dates[1])
-
-    def _create_station(self, timespan: DateTimeRange, name: str) -> Optional[Station]:
-        # What should we do if there's no StationXML?
-        try:
-            inventory = self.get_dataset(str(timespan)).waveforms[name]["StationXML"]
-            sta, net, lon, lat, elv, loc = noise_module.sta_info_from_inv(inventory)
-            return Station(net, sta, lat, lon, elv, loc)
-        except Exception as e:
-            logger.warning(f"Missing StationXML for station {name}. {e}")
-            return None
-
-    @lru_cache
-    def get_dataset(self, ts_str: str) -> pyasdf.ASDFDataSet:
-        return pyasdf.ASDFDataSet(self.files[ts_str], mode="r", mpi=False)
-
+        return self.channel_catalog.get_inventory(timespan, station)
 
-class ASDFCCStore(CrossCorrelationDataStore):
-    def __init__(self, directory: str) -> None:
-        super().__init__()
-        self.directory = directory
-        Path(directory).mkdir(exist_ok=True)
-
-    # CrossCorrelationDataStore implementation
-    def contains(
-        self, timespan: DateTimeRange, src_chan: Channel, rec_chan: Channel, parameters: ConfigParameters
-    ) -> bool:
-        station_pair = self._get_station_pair(src_chan, rec_chan)
-        channel_pair = self._get_channel_pair(src_chan, rec_chan)
-        logger.debug(f"station pair {station_pair} channel pair {channel_pair}")
-        contains = self._contains(timespan, station_pair, channel_pair)
-        if contains:
-            logger.info(f"Cross-correlation {station_pair} and {channel_pair} already exists")
-        return contains
-
-    def save_parameters(self, parameters: ConfigParameters):
-        fc_metadata = os.path.join(self.directory, "fft_cc_data.txt")
-
-        fout = open(fc_metadata, "w")
-        # WIP actually serialize this
-        fout.write(str(parameters.__dict__))
-        fout.close()
-
-    def append(
-        self,
-        timespan: DateTimeRange,
-        src_chan: Channel,
-        rec_chan: Channel,
-        params: ConfigParameters,
-        cc_params: Dict[str, Any],
-        corr: np.ndarray,
-    ):
-        # source-receiver pair: e.g. CI.ARV_CI.BAK
-        station_pair = self._get_station_pair(src_chan, rec_chan)
-        # channels, e.g. bhn_bhn
-        channels = f"{src_chan.type.name}_{rec_chan.type.name}"
-        data = np.zeros(corr.shape, dtype=corr.dtype)
-        data[:] = corr[:]
-        self._add_aux_data(timespan, cc_params, station_pair, channels, data)
-
-    def mark_done(self, timespan: DateTimeRange):
-        self._add_aux_data(timespan, {}, PROGRESS_DATATYPE, DONE_PATH, np.zeros(0))
-
-    def is_done(self, timespan: DateTimeRange):
-        done = self._contains(timespan, PROGRESS_DATATYPE, DONE_PATH)
-        if done:
-            logger.info(f"Timespan {timespan} already computed")
-        return done
-
-    def read(self, chan1: Channel, chan2: Channel, start: datetime, end: datetime) -> np.ndarray:
-        pass
-
-    # private helper methods
-    def _contains(self, timespan: DateTimeRange, data_type: str, path: str = None):
-        filename = self._get_filename(timespan)
-        if not os.path.isfile(filename):
-            return False
-
-        with pyasdf.ASDFDataSet(filename, mpi=False, mode="r") as ccf_ds:
-            # source-receiver pair
-            exists = data_type in ccf_ds.auxiliary_data
-            if path is not None and exists:
-                return path in ccf_ds.auxiliary_data[data_type]
-            return exists
-
-    def _add_aux_data(self, timespan: DateTimeRange, params: Dict, data_type: str, path: str, data: np.ndarray):
-        filename = self._get_filename(timespan)
-        with pyasdf.ASDFDataSet(filename, mpi=False) as ccf_ds:
-            ccf_ds.add_auxiliary_data(data=data, data_type=data_type, path=path, parameters=params)
-
-    def _get_station_pair(self, src_chan: Channel, rec_chan: Channel) -> str:
-        return f"{src_chan.station}_{rec_chan.station}"
-
-    def _get_channel_pair(self, src_chan: Channel, rec_chan: Channel) -> str:
-        return f"{src_chan.type.name}_{rec_chan.type.name}"
-
-    def _get_filename(self, timespan: DateTimeRange) -> str:
-        return os.path.join(
-            self.directory,
-            f"{timespan.start_datetime.strftime(DATE_FORMAT)}T{timespan.end_datetime.strftime(DATE_FORMAT)}.h5",
+    def _parse_timespan(filename: str) -> DateTimeRange:
+        # The SCEDC S3 bucket stores files in the form: CIGMR__LHN___2022002.ms
+        year = int(filename[-10:-6])
+        day = int(filename[-5:-3])
+        jan1 = datetime(year, 1, 1, tzinfo=timezone.utc)
+        return DateTimeRange(jan1 + timedelta(days=day - 1), jan1 + timedelta(days=day))
+
+    def _parse_channel(filename: str) -> Channel:
+        # e.g.
+        # CIGMR__LHN___2022002
+        # CE13884HNZ10_2022002
+        network = filename[:2]
+        station = filename[2:7].rstrip("_")
+        channel = filename[7:10]
+        location = filename[10:12].strip("_")
+        return Channel(
+            ChannelType(channel, location),
+            # lat/lon/elev will be populated later
+            Station(network, station, location=location),
         )
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/channelcatalog.py` & `noisepy_seis-0.9.0/src/noisepy/seis/channelcatalog.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/main.py` & `noisepy_seis-0.9.0/src/noisepy/seis/main.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,162 +1,184 @@
 import argparse
+import logging
 import os
+import sys
 import typing
+from datetime import datetime
+
+# from datetime import datetime
 from enum import Enum
-from typing import Any, Callable, List
+from typing import Any, Callable, Iterable, List
 
+import dateutil.parser
 import obspy
 from datetimerange import DateTimeRange
 
 from .asdfstore import ASDFCCStore, ASDFRawDataStore
 from .channelcatalog import CSVChannelCatalog, XMLStationChannelCatalog
-from .constants import DATE_FORMAT_HELP, STATION_FILE
+from .constants import CONFIG_FILE, STATION_FILE
 from .datatypes import Channel, ConfigParameters
 from .S0A_download_ASDF_MPI import download
 from .S1_fft_cc_MPI import cross_correlate
 from .S2_stacking import stack
 from .scedc_s3store import SCEDCS3DataStore
 from .utils import fs_join, get_filesystem
 
+logger = logging.getLogger(__name__)
 # Utility running the different steps from the command line. Defines the arguments for each step
 
 default_data_path = "Documents/SCAL"
 
 
-class Step(Enum):
+class Command(Enum):
     DOWNLOAD = 1
     CROSS_CORRELATE = 2
     STACK = 3
     ALL = 4
 
 
 def valid_date(d: str) -> str:
     _ = obspy.UTCDateTime(d)
     return d
 
 
-def initialize_fft_params(raw_dir: str) -> ConfigParameters:
-    params = ConfigParameters()
-    dfile = fs_join(raw_dir, "download_info.txt")
-    if os.path.isfile(dfile):
-        down_info = eval(open(dfile).read())  # TODO: do proper json/yaml serialization
-        params.samp_freq = down_info["samp_freq"]
-        params.freqmin = down_info["freqmin"]
-        params.freqmax = down_info["freqmax"]
-        params.start_date = down_info["start_date"]
-        params.end_date = down_info["end_date"]
-        params.inc_hours = down_info["inc_hours"]
-        params.ncomp = down_info["ncomp"]
-    return params
+def list_str(values: str) -> List[str]:
+    return values.split(",")
+
+
+def _valid_config_file(parser, f: str) -> str:
+    if os.path.isfile(f):
+        return f
+    parser.error(f"'{f}' is not a valid config file")
+
+
+def parse_bool(bstr: str) -> bool:
+    if bstr.upper() == "TRUE":
+        return True
+    elif bstr.upper() == "FALSE":
+        return False
+    raise ValueError(f"Invalid boolean value: '{bstr}'")
+
+
+def get_arg_type(arg_type):
+    if arg_type == list:
+        return list_str
+    if arg_type == datetime:
+        return dateutil.parser.isoparse
+    if arg_type == bool:
+        return parse_bool
+    return arg_type
+
+
+def add_model(parser: argparse.ArgumentParser, model: ConfigParameters):
+    # Add config model to the parser
+    fields = model.__fields__
+    for name, field in fields.items():
+        parser.add_argument(
+            f"--{name}",
+            dest=name,
+            type=get_arg_type(field.type_),
+            default=argparse.SUPPRESS,
+            help=field.field_info.description,
+        )
+
+
+def initialize_params(args, data_dir: str) -> ConfigParameters:
+    """
+    Loads initial parameters from 3 options:
+    - --config_path option
+    - <data_dir>/config.yaml
+    - Default parameters
+
+    Then overrides with values passed in the command line
+    """
+    config_path = args.config
+    if config_path is None and data_dir is not None:
+        config_path = fs_join(data_dir, CONFIG_FILE)
+    if config_path is not None and os.path.isfile(config_path):
+        logger.info(f"Loading parameters from {config_path}")
+        params = ConfigParameters.parse_file(config_path)
+    else:
+        logger.warning(f"Config file {config_path if config_path else ''} not found. Using default parameters.")
+        params = ConfigParameters()
+    cpy = params.copy(update={k: v for (k, v) in vars(args).items() if k in params.__fields__})
+    return cpy
 
 
 def get_channel_filter(sta_list: List[str]) -> Callable[[Channel], bool]:
     if len(sta_list) == 1 and sta_list[0] == "*":
         return lambda ch: True
     else:
         stations = set(sta_list)
         return lambda ch: ch.station.name in stations
 
 
 def get_date_range(args) -> DateTimeRange:
-    if args.start is None or args.end is None:
+    if "start_date" not in args or args.start_date is None or "end_date" not in args or args.end_date is None:
         return None
-    return DateTimeRange(obspy.UTCDateTime(args.start).datetime, obspy.UTCDateTime(args.end).datetime)
+    return DateTimeRange(obspy.UTCDateTime(args.start_date).datetime, obspy.UTCDateTime(args.end_date).datetime)
 
 
-def create_raw_store(args):
-    stations = args.stations if "stations" in args else []
-    xml_path = args.xml_path if "xml_path" in args else None
+def create_raw_store(args, params: ConfigParameters):
     raw_dir = args.raw_data_path
 
     fs = get_filesystem(raw_dir)
 
     def count(pat):
         return len(fs.glob(fs_join(raw_dir, pat)))
 
     # Use heuristics around which store to use by the files present
     if count("*.h5") > 0:
         return ASDFRawDataStore(raw_dir)
     else:
         # assert count("*.ms") > 0 or count("*.sac") > 0, f"Can not find any .h5, .ms or .sac files in {raw_dir}"
-        if xml_path is not None:
-            catalog = XMLStationChannelCatalog(xml_path)
+        if args.xml_path is not None:
+            catalog = XMLStationChannelCatalog(args.xml_path)
         elif os.path.isfile(os.path.join(raw_dir, STATION_FILE)):
             catalog = CSVChannelCatalog(raw_dir)
         else:
             raise ValueError(f"Either an --xml_path argument or a {STATION_FILE} must be provided")
 
         date_range = get_date_range(args)
-        return SCEDCS3DataStore(raw_dir, catalog, get_channel_filter(stations), date_range)
+        return SCEDCS3DataStore(raw_dir, catalog, get_channel_filter(params.stations), date_range)
 
 
 def main(args: typing.Any):
-    raw_dir = args.raw_data_path
+    logger = logging.getLogger(__package__)
+    logger.setLevel(args.loglevel.upper())
+
+    def run_download():
+        params = initialize_params(args, None)
+        download(args.raw_data_path, params)
+        params.save_yaml(fs_join(args.raw_data_path, CONFIG_FILE))
 
     def run_cross_correlation():
         ccf_dir = args.ccf_path
-        fft_params = initialize_fft_params(raw_dir)
-        fft_params.freq_norm = args.freq_norm
         cc_store = ASDFCCStore(ccf_dir)
-        raw_store = create_raw_store(args)
-        cross_correlate(raw_store, fft_params, cc_store)
-
-    def run_download():
-        params = ConfigParameters()
-        params.start_date = args.start
-        params.end_date = args.end
-        params.inc_hours = args.inc_hours
-        download(args.raw_data_path, args.channels, args.stations, params)
+        params = initialize_params(args, args.raw_data_path)
+        raw_store = create_raw_store(args, params)
+        cross_correlate(raw_store, params, cc_store)
+        params.save_yaml(fs_join(ccf_dir, CONFIG_FILE))
+
+    def run_stack():
+        cc_store = ASDFCCStore(args.ccf_path, "r")
+        params = initialize_params(args, args.ccf_path)
+        stack(cc_store, args.stack_path, params)
+        params.save_yaml(fs_join(args.stack_path, CONFIG_FILE))
 
-    if args.step == Step.DOWNLOAD:
+    if args.cmd == Command.DOWNLOAD:
         run_download()
-    if args.step == Step.CROSS_CORRELATE:
+    if args.cmd == Command.CROSS_CORRELATE:
         run_cross_correlation()
-    if args.step == Step.STACK:
-        raw_store = create_raw_store(args)
-        stack(raw_store.get_station_list(), args.ccf_path, args.stack_path, args.method)
-    if args.step == Step.ALL:
+    if args.cmd == Command.STACK:
+        run_stack()
+    if args.cmd == Command.ALL:
         run_download()
         run_cross_correlation()
-        raw_store = create_raw_store(args)
-        stack(raw_store.get_station_list(), args.ccf_path, args.stack_path, args.method)
-
-
-def add_date_args(parser, required):
-    parser.add_argument(
-        "--start",
-        type=valid_date,
-        required=required,
-        help="Start date in the format: " + DATE_FORMAT_HELP,
-    )
-    parser.add_argument(
-        "--end",
-        type=valid_date,
-        required=required,
-        help="End date in the format: " + DATE_FORMAT_HELP,
-    )
-
-
-def add_download_args(down_parser: argparse.ArgumentParser):
-    down_parser.add_argument(
-        "--channels",
-        type=lambda s: s.split(","),
-        help="Comma separated list of channels",
-        default="BHE,BHN,BHZ",
-    )
-    down_parser.add_argument("--inc_hours", type=int, default=24, help="Time increment size (hrs)")
-
-
-def add_stations_arg(parser: argparse.ArgumentParser):
-    parser.add_argument(
-        "--stations",
-        type=lambda s: s.split(","),
-        help="Comma separated list of stations or '*' for all",
-        default="*",
-    )
+        run_stack()
 
 
 def add_path(parser, prefix: str):
     parser.add_argument(
         f"--{prefix}_path",
         type=str,
         default=os.path.join(os.path.join(os.path.expanduser("~"), default_data_path), prefix.upper()),
@@ -165,72 +187,47 @@
 
 
 def add_paths(parser, types: List[str]):
     for t in types:
         add_path(parser, t)
 
 
-def add_cc_args(parser):
-    parser.add_argument("--freq_norm", choices=["rma", "no", "phase_only"], default="rma")
-    parser.add_argument("--xml_path", required=False, default=None)
-
-
-def add_stack_args(parser):
-    parser.add_argument(
-        "--method",
-        type=str,
-        required=True,
-        choices=[
-            "linear",
-            "pws",
-            "robust",
-            "nroot",
-            "selective",
-            "auto_covariance",
-            "all",
-        ],
-        help="Stacking method",
-    )
-
-
-def make_step_parser(subparsers: Any, step: Step, parser_config_funcs: List[Callable[[argparse.ArgumentParser], None]]):
+def make_step_parser(subparsers: Any, cmd: Command, paths: List[str]):
     parser = subparsers.add_parser(
-        step.name.lower(),
+        cmd.name.lower(),
         formatter_class=argparse.ArgumentDefaultsHelpFormatter,
     )
-    for config_fn in parser_config_funcs:
-        config_fn(parser)
+    add_paths(parser, paths)
+    parser.add_argument(
+        "-log",
+        "--loglevel",
+        type=str.lower,
+        default="info",
+        choices=["notset", "debug", "info", "warning", "error", "critical"],
+    )
+    parser.add_argument(
+        "-c", "--config", type=lambda f: _valid_config_file(parser, f), required=False, help="Configuration YAML file"
+    )
+    add_model(parser, ConfigParameters())
 
 
 def main_cli():
+    args = parse_args(sys.argv[1:])
+    main(args)
+
+
+def parse_args(arguments: Iterable[str]) -> argparse.Namespace:
     parser = argparse.ArgumentParser()
-    subparsers = parser.add_subparsers(dest="step", required=True)
-    make_step_parser(
-        subparsers,
-        Step.DOWNLOAD,
-        [lambda p: add_paths(p, ["raw_data"]), add_download_args, add_stations_arg, lambda p: add_date_args(p, True)],
-    )
-    make_step_parser(
-        subparsers,
-        Step.CROSS_CORRELATE,
-        [lambda p: add_paths(p, ["raw_data", "ccf"]), add_cc_args, add_stations_arg, lambda p: add_date_args(p, False)],
-    )
-    make_step_parser(subparsers, Step.STACK, [lambda p: add_paths(p, ["raw_data", "stack", "ccf"]), add_stack_args])
-    make_step_parser(
-        subparsers,
-        Step.ALL,
-        [
-            lambda p: add_paths(p, ["raw_data", "ccf", "stack"]),
-            add_download_args,
-            add_cc_args,
-            add_stack_args,
-            add_stations_arg,
-        ],
-    )
+    subparsers = parser.add_subparsers(dest="cmd", required=True)
+    make_step_parser(subparsers, Command.DOWNLOAD, ["raw_data"])
+    make_step_parser(subparsers, Command.CROSS_CORRELATE, ["raw_data", "ccf", "xml"])
+    make_step_parser(subparsers, Command.STACK, ["raw_data", "stack", "ccf"])
+    make_step_parser(subparsers, Command.ALL, ["raw_data", "ccf", "stack", "xml"])
 
-    args = parser.parse_args()
-    args.step = Step[args.step.upper()]
-    main(args)
+    args = parser.parse_args(arguments)
+
+    args.cmd = Command[args.cmd.upper()]
+    return args
 
 
 if __name__ == "__main__":
     main_cli()
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/noise_module.py` & `noisepy_seis-0.9.0/src/noisepy/seis/noise_module.py`

 * *Files 1% similar despite different names*

```diff
@@ -6,7055 +6,7049 @@
 00000050: 206d 6f64 756c 6573 2077 6974 680a 2320   modules with.# 
 00000060: 7468 6520 7361 6d65 206e 616d 6520 6275  the same name bu
 00000070: 7420 6469 6666 6572 656e 7420 696e 7075  t different inpu
 00000080: 7473 0a23 206e 6f71 613a 2046 3831 310a  ts.# noqa: F811.
 00000090: 2320 696d 706f 7274 2070 7961 7364 660a  # import pyasdf.
 000000a0: 696d 706f 7274 2064 6174 6574 696d 650a  import datetime.
 000000b0: 696d 706f 7274 2067 6c6f 620a 696d 706f  import glob.impo
-000000c0: 7274 206f 730a 0a69 6d70 6f72 7420 6e75  rt os..import nu
-000000d0: 6d70 7920 6173 206e 700a 696d 706f 7274  mpy as np.import
-000000e0: 206f 6273 7079 0a69 6d70 6f72 7420 7061   obspy.import pa
-000000f0: 6e64 6173 2061 7320 7064 0a69 6d70 6f72  ndas as pd.impor
-00000100: 7420 7079 6377 740a 696d 706f 7274 2073  t pycwt.import s
-00000110: 6369 7079 0a66 726f 6d20 6e75 6d62 6120  cipy.from numba 
-00000120: 696d 706f 7274 206a 6974 0a66 726f 6d20  import jit.from 
-00000130: 6f62 7370 792e 636f 7265 2e69 6e76 656e  obspy.core.inven
-00000140: 746f 7279 2069 6d70 6f72 7420 4368 616e  tory import Chan
-00000150: 6e65 6c2c 2049 6e76 656e 746f 7279 2c20  nel, Inventory, 
-00000160: 4e65 7477 6f72 6b2c 2053 6974 652c 2053  Network, Site, S
-00000170: 7461 7469 6f6e 0a66 726f 6d20 6f62 7370  tation.from obsp
-00000180: 792e 636f 7265 2e75 7469 6c2e 6261 7365  y.core.util.base
-00000190: 2069 6d70 6f72 7420 5f67 6574 5f66 756e   import _get_fun
-000001a0: 6374 696f 6e5f 6672 6f6d 5f65 6e74 7279  ction_from_entry
-000001b0: 5f70 6f69 6e74 0a66 726f 6d20 6f62 7370  _point.from obsp
-000001c0: 792e 7369 676e 616c 2e66 696c 7465 7220  y.signal.filter 
-000001d0: 696d 706f 7274 2062 616e 6470 6173 730a  import bandpass.
-000001e0: 6672 6f6d 206f 6273 7079 2e73 6967 6e61  from obspy.signa
-000001f0: 6c2e 696e 7673 696d 2069 6d70 6f72 7420  l.invsim import 
-00000200: 636f 7369 6e65 5f74 6170 6572 0a66 726f  cosine_taper.fro
-00000210: 6d20 6f62 7370 792e 7369 676e 616c 2e72  m obspy.signal.r
-00000220: 6567 7265 7373 696f 6e20 696d 706f 7274  egression import
-00000230: 206c 696e 6561 725f 7265 6772 6573 7369   linear_regressi
-00000240: 6f6e 0a66 726f 6d20 6f62 7370 792e 7369  on.from obspy.si
-00000250: 676e 616c 2e75 7469 6c20 696d 706f 7274  gnal.util import
-00000260: 205f 6e70 7473 326e 6666 740a 6672 6f6d   _npts2nfft.from
-00000270: 2073 6369 7079 2e66 6674 7061 636b 2069   scipy.fftpack i
-00000280: 6d70 6f72 7420 6e65 7874 5f66 6173 745f  mport next_fast_
-00000290: 6c65 6e0a 6672 6f6d 2073 6369 7079 2e73  len.from scipy.s
-000002a0: 6967 6e61 6c20 696d 706f 7274 2068 696c  ignal import hil
-000002b0: 6265 7274 0a0a 6672 6f6d 206e 6f69 7365  bert..from noise
-000002c0: 7079 2e73 6569 732e 6461 7461 7479 7065  py.seis.datatype
-000002d0: 7320 696d 706f 7274 2043 6861 6e6e 656c  s import Channel
-000002e0: 4461 7461 0a66 726f 6d20 6e6f 6973 6570  Data.from noisep
-000002f0: 792e 7365 6973 2e53 315f 6666 745f 6363  y.seis.S1_fft_cc
-00000300: 5f4d 5049 2069 6d70 6f72 7420 436f 6e66  _MPI import Conf
-00000310: 6967 5061 7261 6d65 7465 7273 0a0a 2222  igParameters..""
-00000320: 220a 5468 6973 2056 4552 5920 4c4f 4e47  ".This VERY LONG
-00000330: 206e 6f69 7365 206d 6f64 756c 6520 6669   noise module fi
-00000340: 6c65 2069 7320 6e65 6365 7373 6172 7920  le is necessary 
-00000350: 746f 206b 6565 7020 7468 6520 4e6f 6973  to keep the Nois
-00000360: 6550 7920 776f 726b 696e 6720 7072 6f70  ePy working prop
-00000370: 6572 6c79 2e20 496e 2067 656e 6572 616c  erly. In general
-00000380: 2c0a 7468 6520 6d6f 6475 6c65 7320 6172  ,.the modules ar
-00000390: 6520 6f72 6761 6e69 7a65 6420 6261 7365  e organized base
-000003a0: 6420 6f6e 2074 6865 6972 2066 756e 6374  d on their funct
-000003b0: 696f 6e61 6c69 7479 2069 6e20 7468 6520  ionality in the 
-000003c0: 666f 6c6c 6f77 696e 6720 7761 792e 2069  following way. i
-000003d0: 7420 696e 636c 7564 6573 3a0a 0a31 2920  t includes:..1) 
-000003e0: 636f 7265 2066 756e 6374 696f 6e73 2063  core functions c
-000003f0: 616c 6c65 6420 6469 7265 6374 6c79 2062  alled directly b
-00000400: 7920 7468 6520 6d61 696e 204e 6f69 7365  y the main Noise
-00000410: 5079 2073 6372 6970 7473 3b0a 3229 2075  Py scripts;.2) u
-00000420: 7469 6c69 7479 2066 756e 6374 696f 6e73  tility functions
-00000430: 2075 7365 6420 6279 2074 6865 2063 6f72   used by the cor
-00000440: 6520 6675 6e63 7469 6f6e 733b 0a33 2920  e functions;.3) 
-00000450: 6d6f 6e69 746f 7269 6e67 2066 756e 6374  monitoring funct
-00000460: 696f 6e73 2072 6570 7265 7365 6e74 696e  ions representin
-00000470: 6720 6469 6666 6572 656e 7420 6d65 7468  g different meth
-00000480: 6f64 7320 746f 206d 6561 7375 7265 2064  ods to measure d
-00000490: 762f 763b 0a34 2920 6d6f 6e69 746f 7269  v/v;.4) monitori
-000004a0: 6e67 2075 7469 6c69 7479 2066 756e 6374  ng utility funct
-000004b0: 696f 6e73 2075 7365 6420 6279 2074 6865  ions used by the
-000004c0: 206d 6f6e 6974 6f72 696e 6720 6675 6e63   monitoring func
-000004d0: 7469 6f6e 732e 0a0a 6279 3a20 4368 656e  tions...by: Chen
-000004e0: 6778 696e 204a 6961 6e67 2028 6368 656e  gxin Jiang (chen
-000004f0: 6778 696e 5f6a 6961 6e67 4066 6173 2e68  gxin_jiang@fas.h
-00000500: 6172 7661 7264 2e65 6475 290a 2020 2020  arvard.edu).    
-00000510: 4d61 7269 6e65 2044 656e 6f6c 6c65 2028  Marine Denolle (
-00000520: 6d64 656e 6f6c 6c65 4066 6173 2e68 6172  mdenolle@fas.har
-00000530: 7661 7264 2e65 6475 290a 0a73 6576 6572  vard.edu)..sever
-00000540: 616c 2075 7469 6c69 7479 2066 756e 6374  al utility funct
-00000550: 696f 6e73 2061 7265 206d 6f64 6966 6965  ions are modifie
-00000560: 6420 6261 7365 6420 6f6e 2068 7474 7073  d based on https
-00000570: 3a2f 2f67 6974 6875 622e 636f 6d2f 7463  ://github.com/tc
-00000580: 6c65 6d65 6e74 732f 6e6f 6973 650a 2222  lements/noise.""
-00000590: 220a 0a23 2323 2323 2323 2323 2323 2323  "..#############
-000005a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000005b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000005c0: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
-000005d0: 2323 2323 2323 2043 4f52 4520 4655 4e43  ###### CORE FUNC
-000005e0: 5449 4f4e 5320 2323 2323 2323 2323 2323  TIONS ##########
-000005f0: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
-00000600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000000c0: 7274 206c 6f67 6769 6e67 0a69 6d70 6f72  rt logging.impor
+000000d0: 7420 6f73 0a0a 696d 706f 7274 206e 756d  t os..import num
+000000e0: 7079 2061 7320 6e70 0a69 6d70 6f72 7420  py as np.import 
+000000f0: 6f62 7370 790a 696d 706f 7274 2070 616e  obspy.import pan
+00000100: 6461 7320 6173 2070 640a 696d 706f 7274  das as pd.import
+00000110: 2070 7963 7774 0a69 6d70 6f72 7420 7363   pycwt.import sc
+00000120: 6970 790a 6672 6f6d 206e 756d 6261 2069  ipy.from numba i
+00000130: 6d70 6f72 7420 6a69 740a 6672 6f6d 206f  mport jit.from o
+00000140: 6273 7079 2e63 6f72 652e 696e 7665 6e74  bspy.core.invent
+00000150: 6f72 7920 696d 706f 7274 2043 6861 6e6e  ory import Chann
+00000160: 656c 2c20 496e 7665 6e74 6f72 792c 204e  el, Inventory, N
+00000170: 6574 776f 726b 2c20 5369 7465 2c20 5374  etwork, Site, St
+00000180: 6174 696f 6e0a 6672 6f6d 206f 6273 7079  ation.from obspy
+00000190: 2e63 6f72 652e 7574 696c 2e62 6173 6520  .core.util.base 
+000001a0: 696d 706f 7274 205f 6765 745f 6675 6e63  import _get_func
+000001b0: 7469 6f6e 5f66 726f 6d5f 656e 7472 795f  tion_from_entry_
+000001c0: 706f 696e 740a 6672 6f6d 206f 6273 7079  point.from obspy
+000001d0: 2e73 6967 6e61 6c2e 6669 6c74 6572 2069  .signal.filter i
+000001e0: 6d70 6f72 7420 6261 6e64 7061 7373 0a66  mport bandpass.f
+000001f0: 726f 6d20 6f62 7370 792e 7369 676e 616c  rom obspy.signal
+00000200: 2e69 6e76 7369 6d20 696d 706f 7274 2063  .invsim import c
+00000210: 6f73 696e 655f 7461 7065 720a 6672 6f6d  osine_taper.from
+00000220: 206f 6273 7079 2e73 6967 6e61 6c2e 7265   obspy.signal.re
+00000230: 6772 6573 7369 6f6e 2069 6d70 6f72 7420  gression import 
+00000240: 6c69 6e65 6172 5f72 6567 7265 7373 696f  linear_regressio
+00000250: 6e0a 6672 6f6d 206f 6273 7079 2e73 6967  n.from obspy.sig
+00000260: 6e61 6c2e 7574 696c 2069 6d70 6f72 7420  nal.util import 
+00000270: 5f6e 7074 7332 6e66 6674 0a66 726f 6d20  _npts2nfft.from 
+00000280: 7363 6970 792e 6666 7470 6163 6b20 696d  scipy.fftpack im
+00000290: 706f 7274 206e 6578 745f 6661 7374 5f6c  port next_fast_l
+000002a0: 656e 0a66 726f 6d20 7363 6970 792e 7369  en.from scipy.si
+000002b0: 676e 616c 2069 6d70 6f72 7420 6869 6c62  gnal import hilb
+000002c0: 6572 740a 0a66 726f 6d20 6e6f 6973 6570  ert..from noisep
+000002d0: 792e 7365 6973 2e64 6174 6174 7970 6573  y.seis.datatypes
+000002e0: 2069 6d70 6f72 7420 4368 616e 6e65 6c44   import ChannelD
+000002f0: 6174 610a 6672 6f6d 206e 6f69 7365 7079  ata.from noisepy
+00000300: 2e73 6569 732e 5331 5f66 6674 5f63 635f  .seis.S1_fft_cc_
+00000310: 4d50 4920 696d 706f 7274 2043 6f6e 6669  MPI import Confi
+00000320: 6750 6172 616d 6574 6572 730a 0a6c 6f67  gParameters..log
+00000330: 6765 7220 3d20 6c6f 6767 696e 672e 6765  ger = logging.ge
+00000340: 744c 6f67 6765 7228 5f5f 6e61 6d65 5f5f  tLogger(__name__
+00000350: 290a 2222 220a 5468 6973 2056 4552 5920  ).""".This VERY 
+00000360: 4c4f 4e47 206e 6f69 7365 206d 6f64 756c  LONG noise modul
+00000370: 6520 6669 6c65 2069 7320 6e65 6365 7373  e file is necess
+00000380: 6172 7920 746f 206b 6565 7020 7468 6520  ary to keep the 
+00000390: 4e6f 6973 6550 7920 776f 726b 696e 6720  NoisePy working 
+000003a0: 7072 6f70 6572 6c79 2e20 496e 2067 656e  properly. In gen
+000003b0: 6572 616c 2c0a 7468 6520 6d6f 6475 6c65  eral,.the module
+000003c0: 7320 6172 6520 6f72 6761 6e69 7a65 6420  s are organized 
+000003d0: 6261 7365 6420 6f6e 2074 6865 6972 2066  based on their f
+000003e0: 756e 6374 696f 6e61 6c69 7479 2069 6e20  unctionality in 
+000003f0: 7468 6520 666f 6c6c 6f77 696e 6720 7761  the following wa
+00000400: 792e 2069 7420 696e 636c 7564 6573 3a0a  y. it includes:.
+00000410: 0a31 2920 636f 7265 2066 756e 6374 696f  .1) core functio
+00000420: 6e73 2063 616c 6c65 6420 6469 7265 6374  ns called direct
+00000430: 6c79 2062 7920 7468 6520 6d61 696e 204e  ly by the main N
+00000440: 6f69 7365 5079 2073 6372 6970 7473 3b0a  oisePy scripts;.
+00000450: 3229 2075 7469 6c69 7479 2066 756e 6374  2) utility funct
+00000460: 696f 6e73 2075 7365 6420 6279 2074 6865  ions used by the
+00000470: 2063 6f72 6520 6675 6e63 7469 6f6e 733b   core functions;
+00000480: 0a33 2920 6d6f 6e69 746f 7269 6e67 2066  .3) monitoring f
+00000490: 756e 6374 696f 6e73 2072 6570 7265 7365  unctions represe
+000004a0: 6e74 696e 6720 6469 6666 6572 656e 7420  nting different 
+000004b0: 6d65 7468 6f64 7320 746f 206d 6561 7375  methods to measu
+000004c0: 7265 2064 762f 763b 0a34 2920 6d6f 6e69  re dv/v;.4) moni
+000004d0: 746f 7269 6e67 2075 7469 6c69 7479 2066  toring utility f
+000004e0: 756e 6374 696f 6e73 2075 7365 6420 6279  unctions used by
+000004f0: 2074 6865 206d 6f6e 6974 6f72 696e 6720   the monitoring 
+00000500: 6675 6e63 7469 6f6e 732e 0a0a 6279 3a20  functions...by: 
+00000510: 4368 656e 6778 696e 204a 6961 6e67 2028  Chengxin Jiang (
+00000520: 6368 656e 6778 696e 5f6a 6961 6e67 4066  chengxin_jiang@f
+00000530: 6173 2e68 6172 7661 7264 2e65 6475 290a  as.harvard.edu).
+00000540: 2020 2020 4d61 7269 6e65 2044 656e 6f6c      Marine Denol
+00000550: 6c65 2028 6d64 656e 6f6c 6c65 4066 6173  le (mdenolle@fas
+00000560: 2e68 6172 7661 7264 2e65 6475 290a 0a73  .harvard.edu)..s
+00000570: 6576 6572 616c 2075 7469 6c69 7479 2066  everal utility f
+00000580: 756e 6374 696f 6e73 2061 7265 206d 6f64  unctions are mod
+00000590: 6966 6965 6420 6261 7365 6420 6f6e 2068  ified based on h
+000005a0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+000005b0: 6d2f 7463 6c65 6d65 6e74 732f 6e6f 6973  m/tclements/nois
+000005c0: 650a 2222 220a 0a23 2323 2323 2323 2323  e."""..#########
+000005d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000005e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000005f0: 2323 2323 2323 2323 2323 230a 2323 2323  ###########.####
+00000600: 2323 2323 2323 2323 2323 2043 4f52 4520  ########## CORE 
+00000610: 4655 4e43 5449 4f4e 5320 2323 2323 2323  FUNCTIONS ######
 00000620: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000630: 230a 0a0a 6465 6620 6765 745f 6576 656e  #...def get_even
-00000640: 745f 6c69 7374 2873 7472 312c 2073 7472  t_list(str1, str
-00000650: 322c 2069 6e63 5f68 6f75 7273 293a 0a20  2, inc_hours):. 
-00000660: 2020 2022 2222 0a20 2020 2074 6869 7320     """.    this 
-00000670: 6675 6e63 7469 6f6e 2063 616c 6375 6c61  function calcula
-00000680: 7465 7320 7468 6520 6576 656e 7420 6c69  tes the event li
-00000690: 7374 2062 6574 7765 656e 2074 696d 6531  st between time1
-000006a0: 2061 6e64 2074 696d 6532 2062 7920 696e   and time2 by in
-000006b0: 6372 656d 656e 7420 6f66 2069 6e63 5f68  crement of inc_h
-000006c0: 6f75 7273 0a20 2020 2069 6e20 7468 6520  ours.    in the 
-000006d0: 666f 726d 6174 6520 6f66 2025 595f 256d  formate of %Y_%m
-000006e0: 5f25 645f 2548 5f25 4d5f 2553 2720 2875  _%d_%H_%M_%S' (u
-000006f0: 7365 6420 696e 2053 3041 2026 2053 3042  sed in S0A & S0B
-00000700: 290a 2020 2020 5041 5241 4d45 5445 5253  ).    PARAMETERS
-00000710: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-00000720: 2d2d 2d2d 2d2d 0a20 2020 2073 7472 313a  ------.    str1:
-00000730: 2073 7472 696e 6720 6f66 2074 6865 2073   string of the s
-00000740: 7461 7274 696e 6720 7469 6d65 202d 3e20  tarting time -> 
-00000750: 3230 3130 5f30 315f 3031 5f30 5f30 0a20  2010_01_01_0_0. 
-00000760: 2020 2073 7472 323a 2073 7472 696e 6720     str2: string 
-00000770: 6f66 2074 6865 2065 6e64 696e 6720 7469  of the ending ti
-00000780: 6d65 202d 3e20 3230 3130 5f31 305f 3131  me -> 2010_10_11
-00000790: 5f30 5f30 0a20 2020 2069 6e63 5f68 6f75  _0_0.    inc_hou
-000007a0: 7273 3a20 696e 7465 6765 7220 6f66 2069  rs: integer of i
-000007b0: 6e63 7265 6d65 6e74 616c 2068 6f75 7273  ncremental hours
-000007c0: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
-000007d0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-000007e0: 2d2d 0a20 2020 2065 7665 6e74 3a20 6120  --.    event: a 
-000007f0: 6e75 6d70 7920 6368 6172 6163 7465 7220  numpy character 
-00000800: 6c69 7374 0a20 2020 2022 2222 0a20 2020  list.    """.   
-00000810: 2064 6174 6531 203d 2073 7472 312e 7370   date1 = str1.sp
-00000820: 6c69 7428 225f 2229 0a20 2020 2064 6174  lit("_").    dat
-00000830: 6532 203d 2073 7472 322e 7370 6c69 7428  e2 = str2.split(
-00000840: 225f 2229 0a20 2020 2079 3120 3d20 696e  "_").    y1 = in
-00000850: 7428 6461 7465 315b 305d 290a 2020 2020  t(date1[0]).    
-00000860: 6d31 203d 2069 6e74 2864 6174 6531 5b31  m1 = int(date1[1
-00000870: 5d29 0a20 2020 2064 3120 3d20 696e 7428  ]).    d1 = int(
-00000880: 6461 7465 315b 325d 290a 2020 2020 6831  date1[2]).    h1
-00000890: 203d 2069 6e74 2864 6174 6531 5b33 5d29   = int(date1[3])
-000008a0: 0a20 2020 206d 6d31 203d 2069 6e74 2864  .    mm1 = int(d
-000008b0: 6174 6531 5b34 5d29 0a20 2020 206d 6e31  ate1[4]).    mn1
-000008c0: 203d 2069 6e74 2864 6174 6531 5b35 5d29   = int(date1[5])
-000008d0: 0a20 2020 2079 3220 3d20 696e 7428 6461  .    y2 = int(da
-000008e0: 7465 325b 305d 290a 2020 2020 6d32 203d  te2[0]).    m2 =
-000008f0: 2069 6e74 2864 6174 6532 5b31 5d29 0a20   int(date2[1]). 
-00000900: 2020 2064 3220 3d20 696e 7428 6461 7465     d2 = int(date
-00000910: 325b 325d 290a 2020 2020 6832 203d 2069  2[2]).    h2 = i
-00000920: 6e74 2864 6174 6532 5b33 5d29 0a20 2020  nt(date2[3]).   
-00000930: 206d 6d32 203d 2069 6e74 2864 6174 6532   mm2 = int(date2
-00000940: 5b34 5d29 0a20 2020 206d 6e32 203d 2069  [4]).    mn2 = i
-00000950: 6e74 2864 6174 6532 5b35 5d29 0a0a 2020  nt(date2[5])..  
-00000960: 2020 6431 203d 2064 6174 6574 696d 652e    d1 = datetime.
-00000970: 6461 7465 7469 6d65 2879 312c 206d 312c  datetime(y1, m1,
-00000980: 2064 312c 2068 312c 206d 6d31 2c20 6d6e   d1, h1, mm1, mn
-00000990: 3129 0a20 2020 2064 3220 3d20 6461 7465  1).    d2 = date
-000009a0: 7469 6d65 2e64 6174 6574 696d 6528 7932  time.datetime(y2
-000009b0: 2c20 6d32 2c20 6432 2c20 6832 2c20 6d6d  , m2, d2, h2, mm
-000009c0: 322c 206d 6e32 290a 2020 2020 6474 203d  2, mn2).    dt =
-000009d0: 2064 6174 6574 696d 652e 7469 6d65 6465   datetime.timede
-000009e0: 6c74 6128 686f 7572 733d 696e 635f 686f  lta(hours=inc_ho
-000009f0: 7572 7329 0a0a 2020 2020 6576 656e 7420  urs)..    event 
-00000a00: 3d20 5b5d 0a20 2020 2077 6869 6c65 2064  = [].    while d
-00000a10: 3120 3c20 6432 3a0a 2020 2020 2020 2020  1 < d2:.        
-00000a20: 6576 656e 742e 6170 7065 6e64 2864 312e  event.append(d1.
-00000a30: 7374 7266 7469 6d65 2822 2559 5f25 6d5f  strftime("%Y_%m_
-00000a40: 2564 5f25 485f 254d 5f25 5322 2929 0a20  %d_%H_%M_%S")). 
-00000a50: 2020 2020 2020 2064 3120 2b3d 2064 740a         d1 += dt.
-00000a60: 2020 2020 6576 656e 742e 6170 7065 6e64      event.append
-00000a70: 2864 322e 7374 7266 7469 6d65 2822 2559  (d2.strftime("%Y
-00000a80: 5f25 6d5f 2564 5f25 485f 254d 5f25 5322  _%m_%d_%H_%M_%S"
-00000a90: 2929 0a0a 2020 2020 7265 7475 726e 2065  ))..    return e
-00000aa0: 7665 6e74 0a0a 0a64 6566 206d 616b 655f  vent...def make_
-00000ab0: 7469 6d65 7374 616d 7073 2870 7265 7072  timestamps(prepr
-00000ac0: 6f5f 7061 7261 293a 0a20 2020 2022 2222  o_para):.    """
-00000ad0: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-00000ae0: 6f6e 2070 7265 7061 7265 7320 7468 6520  on prepares the 
-00000af0: 7469 6d65 7374 616d 7073 206f 6620 626f  timestamps of bo
-00000b00: 7468 2074 6865 2073 7461 7274 696e 6720  th the starting 
-00000b10: 616e 6420 656e 6469 6e67 2074 696d 6520  and ending time 
-00000b20: 6f66 2065 6163 6820 6d73 6565 642f 7361  of each mseed/sa
-00000b30: 6320 6669 6c65 2074 6861 740a 2020 2020  c file that.    
-00000b40: 6973 2073 746f 7265 6420 6f6e 206c 6f63  is stored on loc
-00000b50: 616c 206d 6163 6869 6e65 2e20 7468 6973  al machine. this
-00000b60: 2074 696d 6520 696e 666f 2069 7320 7573   time info is us
-00000b70: 6564 2074 6f20 7365 6172 6368 2061 6c6c  ed to search all
-00000b80: 2073 7461 7469 6f6e 7320 696e 2073 7065   stations in spe
-00000b90: 6369 6669 6320 7469 6d65 2063 6875 6e63  cific time chunc
-00000ba0: 6b0a 2020 2020 7768 656e 2070 7265 7061  k.    when prepa
-00000bb0: 7269 6e67 206e 6f69 7365 2064 6174 6120  ring noise data 
-00000bc0: 696e 2041 5344 4620 666f 726d 6174 2e20  in ASDF format. 
-00000bd0: 6974 2063 7265 6174 6573 2061 2063 7376  it creates a csv
-00000be0: 2066 696c 6520 636f 6e74 6169 6e69 6e67   file containing
-00000bf0: 2061 6c6c 2074 696d 6573 7461 6d70 2069   all timestamp i
-00000c00: 6e66 6f20 6966 2074 6865 0a20 2020 2066  nfo if the.    f
-00000c10: 696c 6520 646f 6573 206e 6f74 2065 7869  ile does not exi
-00000c20: 7374 2028 7573 6564 2069 6e20 5330 4229  st (used in S0B)
-00000c30: 660a 2020 2020 5041 5241 4d45 5445 5253  f.    PARAMETERS
-00000c40: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-00000c50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-00000c60: 2020 7072 6570 726f 5f70 6172 613a 2061    prepro_para: a
-00000c70: 2064 6963 2063 6f6e 7461 696e 696e 6720   dic containing 
-00000c80: 616c 6c20 7072 652d 7072 6f63 6573 7369  all pre-processi
-00000c90: 6e67 2070 6172 616d 6574 6572 7320 7573  ng parameters us
-00000ca0: 6564 2069 6e20 5330 420a 2020 2020 5245  ed in S0B.    RE
-00000cb0: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
-00000cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000cd0: 2d2d 0a20 2020 2061 6c6c 5f73 7469 6d65  --.    all_stime
-00000ce0: 733a 206e 756d 7079 2066 6c6f 6174 2061  s: numpy float a
-00000cf0: 7272 6179 2063 6f6e 7461 696e 696e 6720  rray containing 
-00000d00: 7374 6172 7474 696e 6720 616e 6420 656e  startting and en
-00000d10: 6469 6e67 2074 696d 6520 666f 7220 616c  ding time for al
-00000d20: 6c20 5341 432f 6d73 6565 6420 6669 6c65  l SAC/mseed file
-00000d30: 730a 2020 2020 2222 220a 2020 2020 2320  s.    """.    # 
-00000d40: 6c6f 6164 2070 6172 616d 6574 6572 7320  load parameters 
-00000d50: 6672 6f6d 2070 6172 6120 6469 630a 2020  from para dic.  
-00000d60: 2020 7769 6b69 5f66 696c 6520 3d20 7072    wiki_file = pr
-00000d70: 6570 726f 5f70 6172 615b 2277 696b 695f  epro_para["wiki_
-00000d80: 6669 6c65 225d 0a20 2020 206d 6573 7379  file"].    messy
-00000d90: 6461 7461 203d 2070 7265 7072 6f5f 7061  data = prepro_pa
-00000da0: 7261 5b22 6d65 7373 7964 6174 6122 5d0a  ra["messydata"].
-00000db0: 2020 2020 5241 5744 4154 4120 3d20 7072      RAWDATA = pr
-00000dc0: 6570 726f 5f70 6172 615b 2252 4157 4441  epro_para["RAWDA
-00000dd0: 5441 225d 0a20 2020 2061 6c6c 6669 6c65  TA"].    allfile
-00000de0: 735f 7061 7468 203d 2070 7265 7072 6f5f  s_path = prepro_
-00000df0: 7061 7261 5b22 616c 6c66 696c 6573 5f70  para["allfiles_p
-00000e00: 6174 6822 5d0a 0a20 2020 2069 6620 6f73  ath"]..    if os
-00000e10: 2e70 6174 682e 6973 6669 6c65 2877 696b  .path.isfile(wik
-00000e20: 695f 6669 6c65 293a 0a20 2020 2020 2020  i_file):.       
-00000e30: 2074 6d70 203d 2070 642e 7265 6164 5f63   tmp = pd.read_c
-00000e40: 7376 2877 696b 695f 6669 6c65 290a 2020  sv(wiki_file).  
-00000e50: 2020 2020 2020 616c 6c66 696c 6573 203d        allfiles =
-00000e60: 2074 6d70 5b22 6e61 6d65 7322 5d0a 2020   tmp["names"].  
-00000e70: 2020 2020 2020 616c 6c5f 7374 696d 6573        all_stimes
-00000e80: 203d 206e 702e 7a65 726f 7328 7368 6170   = np.zeros(shap
-00000e90: 653d 286c 656e 2861 6c6c 6669 6c65 7329  e=(len(allfiles)
-00000ea0: 2c20 3229 2c20 6474 7970 653d 6e70 2e66  , 2), dtype=np.f
-00000eb0: 6c6f 6174 290a 2020 2020 2020 2020 616c  loat).        al
-00000ec0: 6c5f 7374 696d 6573 5b3a 2c20 305d 203d  l_stimes[:, 0] =
-00000ed0: 2074 6d70 5b22 7374 6172 7474 696d 6522   tmp["starttime"
-00000ee0: 5d0a 2020 2020 2020 2020 616c 6c5f 7374  ].        all_st
-00000ef0: 696d 6573 5b3a 2c20 315d 203d 2074 6d70  imes[:, 1] = tmp
-00000f00: 5b22 656e 6474 696d 6522 5d0a 0a20 2020  ["endtime"]..   
-00000f10: 2023 2068 6176 6520 746f 2072 6561 6420   # have to read 
-00000f20: 6561 6368 2073 6163 2f6d 7365 6564 2064  each sac/mseed d
-00000f30: 6174 6120 6f6e 6520 6279 206f 6e65 0a20  ata one by one. 
-00000f40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00000f50: 2061 6c6c 6669 6c65 7320 3d20 676c 6f62   allfiles = glob
-00000f60: 2e67 6c6f 6228 616c 6c66 696c 6573 5f70  .glob(allfiles_p
-00000f70: 6174 6829 0a20 2020 2020 2020 206e 6669  ath).        nfi
-00000f80: 6c65 7320 3d20 6c65 6e28 616c 6c66 696c  les = len(allfil
-00000f90: 6573 290a 2020 2020 2020 2020 6966 206e  es).        if n
-00000fa0: 6f74 206e 6669 6c65 733a 0a20 2020 2020  ot nfiles:.     
-00000fb0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00000fc0: 7565 4572 726f 7228 2241 626f 7274 2120  ueError("Abort! 
-00000fd0: 6e6f 2064 6174 6120 666f 756e 6420 696e  no data found in
-00000fe0: 2073 7562 6469 7265 6374 6f72 7920 6f66   subdirectory of
-00000ff0: 2025 7322 2025 2052 4157 4441 5441 290a   %s" % RAWDATA).
-00001000: 2020 2020 2020 2020 616c 6c5f 7374 696d          all_stim
-00001010: 6573 203d 206e 702e 7a65 726f 7328 7368  es = np.zeros(sh
-00001020: 6170 653d 286e 6669 6c65 732c 2032 292c  ape=(nfiles, 2),
-00001030: 2064 7479 7065 3d6e 702e 666c 6f61 7429   dtype=np.float)
-00001040: 0a0a 2020 2020 2020 2020 6966 206d 6573  ..        if mes
-00001050: 7379 6461 7461 3a0a 2020 2020 2020 2020  sydata:.        
-00001060: 2020 2020 2320 6765 7420 5645 5259 2070      # get VERY p
-00001070: 7265 6369 7365 2074 7261 6365 2d74 696d  recise trace-tim
-00001080: 6520 6672 6f6d 2074 6865 2068 6561 6465  e from the heade
-00001090: 720a 2020 2020 2020 2020 2020 2020 666f  r.            fo
-000010a0: 7220 6969 2069 6e20 7261 6e67 6528 6e66  r ii in range(nf
-000010b0: 696c 6573 293a 0a20 2020 2020 2020 2020  iles):.         
-000010c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000010d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000010e0: 7472 203d 206f 6273 7079 2e72 6561 6428  tr = obspy.read(
-000010f0: 616c 6c66 696c 6573 5b69 695d 290a 2020  allfiles[ii]).  
-00001100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001110: 2020 616c 6c5f 7374 696d 6573 5b69 692c    all_stimes[ii,
-00001120: 2030 5d20 3d20 7472 5b30 5d2e 7374 6174   0] = tr[0].stat
-00001130: 732e 7374 6172 7474 696d 6520 2d20 6f62  s.starttime - ob
-00001140: 7370 792e 5554 4344 6174 6554 696d 6528  spy.UTCDateTime(
-00001150: 3139 3730 2c20 312c 2031 290a 2020 2020  1970, 1, 1).    
-00001160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001170: 616c 6c5f 7374 696d 6573 5b69 692c 2031  all_stimes[ii, 1
-00001180: 5d20 3d20 7472 5b30 5d2e 7374 6174 732e  ] = tr[0].stats.
-00001190: 656e 6474 696d 6520 2d20 6f62 7370 792e  endtime - obspy.
-000011a0: 5554 4344 6174 6554 696d 6528 3139 3730  UTCDateTime(1970
-000011b0: 2c20 312c 2031 290a 2020 2020 2020 2020  , 1, 1).        
-000011c0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-000011d0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011f0: 2020 2070 7269 6e74 2865 290a 2020 2020     print(e).    
-00001200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001210: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00001220: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00001230: 2020 2023 2067 6574 2072 6f75 6768 2065     # get rough e
-00001240: 7374 696d 6174 6573 206f 6620 7468 6520  stimates of the 
-00001250: 7469 6d65 2062 6173 6564 206f 6e20 7468  time based on th
-00001260: 6520 666f 6c64 6572 3a20 6e65 6564 206d  e folder: need m
-00001270: 6f64 6966 6965 6420 746f 2061 6363 6f6d  odified to accom
-00001280: 6d6f 6461 7465 2079 6f75 7220 6461 7461  modate your data
-00001290: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000012a0: 2069 6920 696e 2072 616e 6765 286e 6669   ii in range(nfi
-000012b0: 6c65 7329 3a0a 2020 2020 2020 2020 2020  les):.          
-000012c0: 2020 2020 2020 7965 6172 203d 2069 6e74        year = int
-000012d0: 2861 6c6c 6669 6c65 735b 6969 5d2e 7370  (allfiles[ii].sp
-000012e0: 6c69 7428 222f 2229 5b2d 325d 2e73 706c  lit("/")[-2].spl
-000012f0: 6974 2822 5f22 295b 315d 290a 2020 2020  it("_")[1]).    
-00001300: 2020 2020 2020 2020 2020 2020 2320 6a75              # ju
-00001310: 6c69 6120 3d20 696e 7428 616c 6c66 696c  lia = int(allfil
-00001320: 6573 5b69 695d 2e73 706c 6974 2827 2f27  es[ii].split('/'
-00001330: 295b 2d32 5d2e 7370 6c69 7428 275f 2729  )[-2].split('_')
-00001340: 5b32 5d29 0a20 2020 2020 2020 2020 2020  [2]).           
-00001350: 2020 2020 2023 2061 6c6c 5f73 7469 6d65       # all_stime
-00001360: 735b 6969 2c30 5d20 3d20 6f62 7370 792e  s[ii,0] = obspy.
-00001370: 5554 4344 6174 6554 696d 6528 7965 6172  UTCDateTime(year
-00001380: 3d79 6561 722c 6a75 6c64 6179 3d6a 756c  =year,julday=jul
-00001390: 6961 290a 2020 2020 2020 2020 2020 2020  ia).            
-000013a0: 2020 2020 2320 2d6f 6273 7079 2e55 5443      # -obspy.UTC
-000013b0: 4461 7465 5469 6d65 2879 6561 723d 3139  DateTime(year=19
-000013c0: 3730 2c6d 6f6e 7468 3d31 2c64 6179 3d31  70,month=1,day=1
-000013d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000013e0: 2020 6d6f 6e74 6820 3d20 696e 7428 616c    month = int(al
-000013f0: 6c66 696c 6573 5b69 695d 2e73 706c 6974  lfiles[ii].split
-00001400: 2822 2f22 295b 2d32 5d2e 7370 6c69 7428  ("/")[-2].split(
-00001410: 225f 2229 5b32 5d29 0a20 2020 2020 2020  "_")[2]).       
-00001420: 2020 2020 2020 2020 2064 6179 203d 2069           day = i
-00001430: 6e74 2861 6c6c 6669 6c65 735b 6969 5d2e  nt(allfiles[ii].
-00001440: 7370 6c69 7428 222f 2229 5b2d 325d 2e73  split("/")[-2].s
-00001450: 706c 6974 2822 5f22 295b 335d 290a 2020  plit("_")[3]).  
-00001460: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00001470: 6c5f 7374 696d 6573 5b69 692c 2030 5d20  l_stimes[ii, 0] 
-00001480: 3d20 6f62 7370 792e 5554 4344 6174 6554  = obspy.UTCDateT
-00001490: 696d 6528 7965 6172 3d79 6561 722c 206d  ime(year=year, m
-000014a0: 6f6e 7468 3d6d 6f6e 7468 2c20 6461 793d  onth=month, day=
-000014b0: 6461 7929 202d 206f 6273 7079 2e55 5443  day) - obspy.UTC
-000014c0: 4461 7465 5469 6d65 280a 2020 2020 2020  DateTime(.      
-000014d0: 2020 2020 2020 2020 2020 2020 2020 7965                ye
-000014e0: 6172 3d31 3937 302c 206d 6f6e 7468 3d31  ar=1970, month=1
-000014f0: 2c20 6461 793d 310a 2020 2020 2020 2020  , day=1.        
-00001500: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00001510: 2020 2020 2020 2020 2020 616c 6c5f 7374            all_st
-00001520: 696d 6573 5b69 692c 2031 5d20 3d20 616c  imes[ii, 1] = al
-00001530: 6c5f 7374 696d 6573 5b69 692c 2030 5d20  l_stimes[ii, 0] 
-00001540: 2b20 3836 3430 300a 0a20 2020 2020 2020  + 86400..       
-00001550: 2023 2073 6176 6520 6e61 6d65 2061 6e64   # save name and
-00001560: 2074 696d 6520 696e 666f 2066 6f72 206c   time info for l
-00001570: 6174 6572 2075 7365 2069 6620 7468 6520  ater use if the 
-00001580: 6669 6c65 206e 6f74 2065 7869 7374 0a20  file not exist. 
-00001590: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
-000015a0: 2e70 6174 682e 6973 6669 6c65 2877 696b  .path.isfile(wik
-000015b0: 695f 6669 6c65 293a 0a20 2020 2020 2020  i_file):.       
-000015c0: 2020 2020 2077 696b 695f 696e 666f 203d       wiki_info =
-000015d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000015e0: 2020 2022 6e61 6d65 7322 3a20 616c 6c66     "names": allf
-000015f0: 696c 6573 2c0a 2020 2020 2020 2020 2020  iles,.          
-00001600: 2020 2020 2020 2273 7461 7274 7469 6d65        "starttime
-00001610: 223a 2061 6c6c 5f73 7469 6d65 735b 3a2c  ": all_stimes[:,
-00001620: 2030 5d2c 0a20 2020 2020 2020 2020 2020   0],.           
-00001630: 2020 2020 2022 656e 6474 696d 6522 3a20       "endtime": 
-00001640: 616c 6c5f 7374 696d 6573 5b3a 2c20 315d  all_stimes[:, 1]
-00001650: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00001660: 2020 2020 2020 2020 2020 2020 6466 203d              df =
-00001670: 2070 642e 4461 7461 4672 616d 6528 7769   pd.DataFrame(wi
-00001680: 6b69 5f69 6e66 6f2c 2063 6f6c 756d 6e73  ki_info, columns
-00001690: 3d5b 226e 616d 6573 222c 2022 7374 6172  =["names", "star
-000016a0: 7474 696d 6522 2c20 2265 6e64 7469 6d65  ttime", "endtime
-000016b0: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-000016c0: 6466 2e74 6f5f 6373 7628 7769 6b69 5f66  df.to_csv(wiki_f
-000016d0: 696c 6529 0a20 2020 2072 6574 7572 6e20  ile).    return 
-000016e0: 616c 6c5f 7374 696d 6573 0a0a 0a64 6566  all_stimes...def
-000016f0: 2070 7265 7072 6f63 6573 735f 7261 7728   preprocess_raw(
-00001700: 0a20 2020 2073 743a 206f 6273 7079 2e53  .    st: obspy.S
-00001710: 7472 6561 6d2c 0a20 2020 2069 6e76 3a20  tream,.    inv: 
-00001720: 6f62 7370 792e 496e 7665 6e74 6f72 792c  obspy.Inventory,
-00001730: 0a20 2020 2070 7265 7072 6f5f 7061 7261  .    prepro_para
-00001740: 3a20 436f 6e66 6967 5061 7261 6d65 7465  : ConfigParamete
-00001750: 7273 2c0a 2020 2020 7374 6172 7474 696d  rs,.    starttim
-00001760: 653a 206f 6273 7079 2e55 5443 4461 7465  e: obspy.UTCDate
-00001770: 5469 6d65 2c0a 2020 2020 656e 6474 696d  Time,.    endtim
-00001780: 653a 206f 6273 7079 2e55 5443 4461 7465  e: obspy.UTCDate
-00001790: 5469 6d65 2c0a 293a 0a20 2020 2022 2222  Time,.):.    """
-000017a0: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-000017b0: 6f6e 2070 7265 2d70 726f 6365 7373 6573  on pre-processes
-000017c0: 2074 6865 2072 6177 2064 6174 6120 7374   the raw data st
-000017d0: 7265 616d 2062 793a 0a20 2020 2020 2020  ream by:.       
-000017e0: 2031 2920 6368 6563 6b20 7361 6d70 696e   1) check sampin
-000017f0: 6720 7261 7465 2061 6e64 2067 6170 7320  g rate and gaps 
-00001800: 696e 2074 6865 2064 6174 613b 0a20 2020  in the data;.   
-00001810: 2020 2020 2032 2920 7265 6d6f 7665 2073       2) remove s
-00001820: 6967 756c 6172 6974 792c 2074 7265 6e64  igularity, trend
-00001830: 2061 6e64 206d 6561 6e20 6f66 2065 6163   and mean of eac
-00001840: 6820 7472 6163 650a 2020 2020 2020 2020  h trace.        
-00001850: 3329 2066 696c 7465 7220 616e 6420 636f  3) filter and co
-00001860: 7272 6563 7420 7468 6520 7469 6d65 2069  rrect the time i
-00001870: 6620 696e 7465 6765 7220 7469 6d65 2061  f integer time a
-00001880: 7265 2062 6574 7765 656e 2073 616d 706c  re between sampl
-00001890: 696e 6720 706f 696e 7473 0a20 2020 2020  ing points.     
-000018a0: 2020 2034 2920 7265 6d6f 7665 2069 6e73     4) remove ins
-000018b0: 7472 756d 656e 7420 7265 7370 6f6e 7365  trument response
-000018c0: 7320 7769 7468 2073 656c 6563 7465 6420  s with selected 
-000018d0: 6d65 7468 6f64 7320 696e 636c 7564 696e  methods includin
-000018e0: 673a 0a20 2020 2020 2020 2020 2020 2022  g:.            "
-000018f0: 696e 7622 2020 202d 3e20 7573 696e 6720  inv"   -> using 
-00001900: 696e 7665 6e74 6f72 7920 696e 666f 726d  inventory inform
-00001910: 6174 696f 6e20 746f 2072 656d 6f76 655f  ation to remove_
-00001920: 7265 7370 6f6e 7365 3b0a 2020 2020 2020  response;.      
-00001930: 2020 2020 2020 2273 7065 6374 7275 6d22        "spectrum"
-00001940: 2020 202d 3e20 7573 6520 7468 6520 696e     -> use the in
-00001950: 7665 7273 6520 6f66 2072 6573 706f 6e73  verse of respons
-00001960: 6520 7370 6563 7472 756d 2e0a 2020 2020  e spectrum..    
-00001970: 2020 2020 2020 2020 2861 2073 6372 6970          (a scrip
-00001980: 7420 6973 2070 726f 7669 6465 6420 696e  t is provided in
-00001990: 2061 6464 6974 696f 6e61 6c5f 6d6f 6475   additional_modu
-000019a0: 6c65 2074 6f20 6573 7469 6d61 7465 2072  le to estimate r
-000019b0: 6573 706f 6e73 6520 7370 6563 7472 756d  esponse spectrum
-000019c0: 2066 726f 6d20 5245 5350 2066 696c 6573   from RESP files
-000019d0: 290a 2020 2020 2020 2020 2020 2020 2252  ).            "R
-000019e0: 4553 505f 6669 6c65 7322 202d 3e20 7573  ESP_files" -> us
-000019f0: 6520 7468 6520 7261 7720 646f 776e 6c6f  e the raw downlo
-00001a00: 6164 2052 4553 5020 6669 6c65 730a 2020  ad RESP files.  
-00001a10: 2020 2020 2020 2020 2020 2270 6f6c 657a            "polez
-00001a20: 6572 6f73 2220 202d 3e20 7573 6520 706f  eros"  -> use po
-00001a30: 6c65 2f7a 6572 6f20 696e 666f 2066 6f72  le/zero info for
-00001a40: 2061 2063 7275 6465 2063 6f72 7265 6374   a crude correct
-00001a50: 696f 6e20 6f66 2072 6573 706f 6e73 650a  ion of response.
-00001a60: 2020 2020 2020 2020 3529 2074 7269 6d20          5) trim 
-00001a70: 6461 7461 2074 6f20 6120 6461 792d 6c6f  data to a day-lo
-00001a80: 6e67 2073 6571 7565 6e63 6520 616e 6420  ng sequence and 
-00001a90: 696e 7465 7270 6f6c 6174 6520 6974 2074  interpolate it t
-00001aa0: 6f20 656e 7375 7265 2073 7461 7274 696e  o ensure startin
-00001ab0: 6720 6174 2030 303a 3030 3a30 302e 3030  g at 00:00:00.00
-00001ac0: 300a 2020 2020 2875 7365 6420 696e 2053  0.    (used in S
-00001ad0: 3041 2026 2053 3042 290a 2020 2020 5041  0A & S0B).    PA
-00001ae0: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
-00001af0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00001b00: 2d2d 2d2d 2d0a 2020 2020 7374 3a20 206f  -----.    st:  o
-00001b10: 6273 7079 2073 7472 6561 6d20 6f62 6a65  bspy stream obje
-00001b20: 6374 2c20 636f 6e74 6169 6e69 6e67 206e  ct, containing n
-00001b30: 6f69 7365 2064 6174 6120 746f 2062 6520  oise data to be 
-00001b40: 7072 6f63 6573 7365 640a 2020 2020 696e  processed.    in
-00001b50: 763a 206f 6273 7079 2069 6e76 656e 746f  v: obspy invento
-00001b60: 7279 206f 626a 6563 742c 2063 6f6e 7461  ry object, conta
-00001b70: 696e 696e 6720 7374 6174 696f 6e73 2069  ining stations i
-00001b80: 6e66 6f0a 2020 2020 7072 6570 726f 5f70  nfo.    prepro_p
-00001b90: 6172 613a 2064 6963 7420 636f 6e74 6169  ara: dict contai
-00001ba0: 6e69 6e67 2066 6674 2070 6172 616d 6574  ning fft paramet
-00001bb0: 6572 732c 2073 7563 6820 6173 2066 7265  ers, such as fre
-00001bc0: 7175 656e 6379 2062 616e 6473 2061 6e64  quency bands and
-00001bd0: 0a20 2020 2073 656c 6563 7469 6f6e 2066  .    selection f
-00001be0: 6f72 2069 6e73 7472 756d 656e 7420 7265  or instrument re
-00001bf0: 7370 6f6e 7365 2072 656d 6f76 616c 2065  sponse removal e
-00001c00: 7463 2e0a 2020 2020 6461 7465 5f69 6e66  tc..    date_inf
-00001c10: 6f3a 2020 2064 6963 7420 6f66 2073 7461  o:   dict of sta
-00001c20: 7274 2061 6e64 2065 6e64 2074 696d 6520  rt and end time 
-00001c30: 6f66 2074 6865 2073 7472 6561 6d20 6461  of the stream da
-00001c40: 7461 0a20 2020 2052 4554 5552 4e53 3a0a  ta.    RETURNS:.
-00001c50: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00001c60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-00001c70: 6e74 723a 206f 6273 7079 2073 7472 6561  ntr: obspy strea
-00001c80: 6d20 6f62 6a65 6374 206f 6620 636c 6561  m object of clea
-00001c90: 6e65 642c 206d 6572 6765 6420 616e 6420  ned, merged and 
-00001ca0: 6669 6c74 6572 6564 206e 6f69 7365 2064  filtered noise d
-00001cb0: 6174 610a 2020 2020 2222 220a 2020 2020  ata.    """.    
-00001cc0: 2320 6c6f 6164 2070 6172 616d 7465 7273  # load paramters
-00001cd0: 2066 726f 6d20 6666 7420 6469 6374 0a20   from fft dict. 
-00001ce0: 2020 2072 6d5f 7265 7370 203d 2070 7265     rm_resp = pre
-00001cf0: 7072 6f5f 7061 7261 5b22 726d 5f72 6573  pro_para["rm_res
-00001d00: 7022 5d0a 2020 2020 726d 5f72 6573 705f  p"].    rm_resp_
-00001d10: 6f75 7420 3d20 7072 6570 726f 5f70 6172  out = prepro_par
-00001d20: 615b 2272 6d5f 7265 7370 5f6f 7574 225d  a["rm_resp_out"]
-00001d30: 0a20 2020 2072 6573 7064 6972 203d 2070  .    respdir = p
-00001d40: 7265 7072 6f5f 7061 7261 5b22 7265 7370  repro_para["resp
-00001d50: 6469 7222 5d0a 2020 2020 6672 6571 6d69  dir"].    freqmi
-00001d60: 6e20 3d20 7072 6570 726f 5f70 6172 615b  n = prepro_para[
-00001d70: 2266 7265 716d 696e 225d 0a20 2020 2066  "freqmin"].    f
-00001d80: 7265 716d 6178 203d 2070 7265 7072 6f5f  reqmax = prepro_
-00001d90: 7061 7261 5b22 6672 6571 6d61 7822 5d0a  para["freqmax"].
-00001da0: 2020 2020 7361 6d70 5f66 7265 7120 3d20      samp_freq = 
-00001db0: 7072 6570 726f 5f70 6172 615b 2273 616d  prepro_para["sam
-00001dc0: 705f 6672 6571 225d 0a0a 2020 2020 2320  p_freq"]..    # 
-00001dd0: 7061 7261 6d65 7465 7273 2066 6f72 2062  parameters for b
-00001de0: 7574 7465 7277 6f72 7468 2066 696c 7465  utterworth filte
-00001df0: 720a 2020 2020 6631 203d 2030 2e39 202a  r.    f1 = 0.9 *
-00001e00: 2066 7265 716d 696e 0a20 2020 2066 3220   freqmin.    f2 
-00001e10: 3d20 6672 6571 6d69 6e0a 2020 2020 6966  = freqmin.    if
-00001e20: 2031 2e31 202a 2066 7265 716d 6178 203e   1.1 * freqmax >
-00001e30: 2030 2e34 3520 2a20 7361 6d70 5f66 7265   0.45 * samp_fre
-00001e40: 713a 0a20 2020 2020 2020 2066 3320 3d20  q:.        f3 = 
-00001e50: 302e 3420 2a20 7361 6d70 5f66 7265 710a  0.4 * samp_freq.
-00001e60: 2020 2020 2020 2020 6634 203d 2030 2e34          f4 = 0.4
-00001e70: 3520 2a20 7361 6d70 5f66 7265 710a 2020  5 * samp_freq.  
-00001e80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00001e90: 6633 203d 2066 7265 716d 6178 0a20 2020  f3 = freqmax.   
-00001ea0: 2020 2020 2066 3420 3d20 312e 3120 2a20       f4 = 1.1 * 
-00001eb0: 6672 6571 6d61 780a 2020 2020 7072 655f  freqmax.    pre_
-00001ec0: 6669 6c74 203d 205b 6631 2c20 6632 2c20  filt = [f1, f2, 
-00001ed0: 6633 2c20 6634 5d0a 0a20 2020 2023 2063  f3, f4]..    # c
-00001ee0: 6865 636b 2073 616d 706c 696e 6720 7261  heck sampling ra
-00001ef0: 7465 2061 6e64 2074 7261 6365 206c 656e  te and trace len
-00001f00: 6774 680a 2020 2020 7374 203d 2063 6865  gth.    st = che
-00001f10: 636b 5f73 616d 706c 655f 6761 7073 2873  ck_sample_gaps(s
-00001f20: 742c 2073 7461 7274 7469 6d65 2c20 656e  t, starttime, en
-00001f30: 6474 696d 6529 0a20 2020 2069 6620 6c65  dtime).    if le
-00001f40: 6e28 7374 2920 3d3d 2030 3a0a 2020 2020  n(st) == 0:.    
-00001f50: 2020 2020 7072 696e 7428 224e 6f20 7472      print("No tr
-00001f60: 6163 6573 2069 6e20 5374 7265 616d 3a20  aces in Stream: 
-00001f70: 436f 6e74 696e 7565 2122 290a 2020 2020  Continue!").    
-00001f80: 2020 2020 7265 7475 726e 2073 740a 2020      return st.  
-00001f90: 2020 7370 7320 3d20 696e 7428 7374 5b30    sps = int(st[0
-00001fa0: 5d2e 7374 6174 732e 7361 6d70 6c69 6e67  ].stats.sampling
-00001fb0: 5f72 6174 6529 0a20 2020 2073 7461 7469  _rate).    stati
-00001fc0: 6f6e 203d 2073 745b 305d 2e73 7461 7473  on = st[0].stats
-00001fd0: 2e73 7461 7469 6f6e 0a0a 2020 2020 2320  .station..    # 
-00001fe0: 7265 6d6f 7665 206e 616e 2f69 6e66 2c20  remove nan/inf, 
-00001ff0: 6d65 616e 2061 6e64 2074 7265 6e64 206f  mean and trend o
-00002000: 6620 6561 6368 2074 7261 6365 2062 6566  f each trace bef
-00002010: 6f72 6520 6d65 7267 696e 670a 2020 2020  ore merging.    
-00002020: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-00002030: 6c65 6e28 7374 2929 3a0a 2020 2020 2020  len(st)):.      
-00002040: 2020 2320 2d2d 2d2d 2d73 6574 206e 616e    # -----set nan
-00002050: 2f69 6e66 2076 616c 7565 7320 746f 207a  /inf values to z
-00002060: 6572 6f73 2028 6974 2064 6f65 7320 6861  eros (it does ha
-00002070: 7070 656e 7321 292d 2d2d 2d2d 0a20 2020  ppens!)-----.   
-00002080: 2020 2020 2074 7474 696e 6478 203d 206e       tttindx = n
-00002090: 702e 7768 6572 6528 6e70 2e69 736e 616e  p.where(np.isnan
-000020a0: 2873 745b 6969 5d2e 6461 7461 2929 0a20  (st[ii].data)). 
-000020b0: 2020 2020 2020 2069 6620 6c65 6e28 7474         if len(tt
-000020c0: 7469 6e64 7829 203e 2030 3a0a 2020 2020  tindx) > 0:.    
-000020d0: 2020 2020 2020 2020 7374 5b69 695d 2e64          st[ii].d
-000020e0: 6174 615b 7474 7469 6e64 785d 203d 2030  ata[tttindx] = 0
-000020f0: 0a20 2020 2020 2020 2074 7474 696e 6478  .        tttindx
-00002100: 203d 206e 702e 7768 6572 6528 6e70 2e69   = np.where(np.i
-00002110: 7369 6e66 2873 745b 6969 5d2e 6461 7461  sinf(st[ii].data
-00002120: 2929 0a20 2020 2020 2020 2069 6620 6c65  )).        if le
-00002130: 6e28 7474 7469 6e64 7829 203e 2030 3a0a  n(tttindx) > 0:.
-00002140: 2020 2020 2020 2020 2020 2020 7374 5b69              st[i
-00002150: 695d 2e64 6174 615b 7474 7469 6e64 785d  i].data[tttindx]
-00002160: 203d 2030 0a0a 2020 2020 2020 2020 7374   = 0..        st
-00002170: 5b69 695d 2e64 6174 6120 3d20 6e70 2e66  [ii].data = np.f
-00002180: 6c6f 6174 3332 2873 745b 6969 5d2e 6461  loat32(st[ii].da
-00002190: 7461 290a 2020 2020 2020 2020 7374 5b69  ta).        st[i
-000021a0: 695d 2e64 6174 6120 3d20 7363 6970 792e  i].data = scipy.
-000021b0: 7369 676e 616c 2e64 6574 7265 6e64 2873  signal.detrend(s
-000021c0: 745b 6969 5d2e 6461 7461 2c20 7479 7065  t[ii].data, type
-000021d0: 3d22 636f 6e73 7461 6e74 2229 0a20 2020  ="constant").   
-000021e0: 2020 2020 2073 745b 6969 5d2e 6461 7461       st[ii].data
-000021f0: 203d 2073 6369 7079 2e73 6967 6e61 6c2e   = scipy.signal.
-00002200: 6465 7472 656e 6428 7374 5b69 695d 2e64  detrend(st[ii].d
-00002210: 6174 612c 2074 7970 653d 226c 696e 6561  ata, type="linea
-00002220: 7222 290a 0a20 2020 2023 206d 6572 6765  r")..    # merge
-00002230: 2c20 7461 7065 7220 616e 6420 6669 6c74  , taper and filt
-00002240: 6572 2074 6865 2064 6174 610a 2020 2020  er the data.    
-00002250: 6966 206c 656e 2873 7429 203e 2031 3a0a  if len(st) > 1:.
-00002260: 2020 2020 2020 2020 7374 2e6d 6572 6765          st.merge
-00002270: 286d 6574 686f 643d 312c 2066 696c 6c5f  (method=1, fill_
-00002280: 7661 6c75 653d 3029 0a20 2020 2073 745b  value=0).    st[
-00002290: 305d 2e74 6170 6572 286d 6178 5f70 6572  0].taper(max_per
-000022a0: 6365 6e74 6167 653d 302e 3035 2c20 6d61  centage=0.05, ma
-000022b0: 785f 6c65 6e67 7468 3d35 3029 2020 2320  x_length=50)  # 
-000022c0: 7461 7065 7220 7769 6e64 6f77 0a20 2020  taper window.   
-000022d0: 2073 745b 305d 2e64 6174 6120 3d20 6e70   st[0].data = np
-000022e0: 2e66 6c6f 6174 3332 2862 616e 6470 6173  .float32(bandpas
-000022f0: 7328 7374 5b30 5d2e 6461 7461 2c20 7072  s(st[0].data, pr
-00002300: 655f 6669 6c74 5b30 5d2c 2070 7265 5f66  e_filt[0], pre_f
-00002310: 696c 745b 2d31 5d2c 2064 663d 7370 732c  ilt[-1], df=sps,
-00002320: 2063 6f72 6e65 7273 3d34 2c20 7a65 726f   corners=4, zero
-00002330: 7068 6173 653d 5472 7565 2929 0a0a 2020  phase=True))..  
-00002340: 2020 2320 6d61 6b65 2064 6f77 6e73 616d    # make downsam
-00002350: 706c 696e 6720 6966 206e 6565 6465 640a  pling if needed.
-00002360: 2020 2020 6966 2061 6273 2873 616d 705f      if abs(samp_
-00002370: 6672 6571 202d 2073 7073 2920 3e20 3165  freq - sps) > 1e
-00002380: 2d34 3a0a 2020 2020 2020 2020 2320 646f  -4:.        # do
-00002390: 776e 7361 6d70 6c69 6e67 2068 6572 650a  wnsampling here.
-000023a0: 2020 2020 2020 2020 7374 2e69 6e74 6572          st.inter
-000023b0: 706f 6c61 7465 2873 616d 705f 6672 6571  polate(samp_freq
-000023c0: 2c20 6d65 7468 6f64 3d22 7765 6967 6874  , method="weight
-000023d0: 6564 5f61 7665 7261 6765 5f73 6c6f 7065  ed_average_slope
-000023e0: 7322 290a 2020 2020 2020 2020 6465 6c74  s").        delt
-000023f0: 6120 3d20 7374 5b30 5d2e 7374 6174 732e  a = st[0].stats.
-00002400: 6465 6c74 610a 0a20 2020 2020 2020 2023  delta..        #
-00002410: 2077 6865 6e20 7374 6172 7474 696d 6573   when starttimes
-00002420: 2061 7265 2062 6574 7765 656e 2073 616d   are between sam
-00002430: 706c 696e 6720 706f 696e 7473 0a20 2020  pling points.   
-00002440: 2020 2020 2066 7269 6320 3d20 7374 5b30       fric = st[0
-00002450: 5d2e 7374 6174 732e 7374 6172 7474 696d  ].stats.starttim
-00002460: 652e 6d69 6372 6f73 6563 6f6e 6420 2520  e.microsecond % 
-00002470: 2864 656c 7461 202a 2031 6536 290a 2020  (delta * 1e6).  
-00002480: 2020 2020 2020 6966 2066 7269 6320 3e20        if fric > 
-00002490: 3165 2d34 3a0a 2020 2020 2020 2020 2020  1e-4:.          
-000024a0: 2020 7374 5b30 5d2e 6461 7461 203d 2073    st[0].data = s
-000024b0: 6567 6d65 6e74 5f69 6e74 6572 706f 6c61  egment_interpola
-000024c0: 7465 286e 702e 666c 6f61 7433 3228 7374  te(np.float32(st
-000024d0: 5b30 5d2e 6461 7461 292c 2066 6c6f 6174  [0].data), float
-000024e0: 2866 7269 6320 2f20 2864 656c 7461 202a  (fric / (delta *
-000024f0: 2031 6536 2929 290a 2020 2020 2020 2020   1e6))).        
-00002500: 2020 2020 2320 2d2d 7265 7365 7420 7468      # --reset th
-00002510: 6520 7469 6d65 2074 6f20 7265 6d6f 7665  e time to remove
-00002520: 2074 6865 2064 6973 6372 6570 616e 6379   the discrepancy
-00002530: 2d2d 2d0a 2020 2020 2020 2020 2020 2020  ---.            
-00002540: 7374 5b30 5d2e 7374 6174 732e 7374 6172  st[0].stats.star
-00002550: 7474 696d 6520 2d3d 2066 7269 6320 2a20  ttime -= fric * 
-00002560: 3165 2d36 0a0a 2020 2020 2320 7265 6d6f  1e-6..    # remo
-00002570: 7665 2074 7261 6365 7320 6f66 2074 6f6f  ve traces of too
-00002580: 2073 6d61 6c6c 206c 656e 6774 680a 0a20   small length.. 
-00002590: 2020 2023 206f 7074 696f 6e73 2074 6f20     # options to 
-000025a0: 7265 6d6f 7665 2069 6e73 7472 756d 656e  remove instrumen
-000025b0: 7420 7265 7370 6f6e 7365 0a20 2020 2069  t response.    i
-000025c0: 6620 726d 5f72 6573 7020 213d 2022 6e6f  f rm_resp != "no
-000025d0: 223a 0a20 2020 2020 2020 2069 6620 726d  ":.        if rm
-000025e0: 5f72 6573 7020 213d 2022 696e 7622 3a0a  _resp != "inv":.
-000025f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00002600: 7265 7370 6469 7220 6973 204e 6f6e 6529  respdir is None)
-00002610: 206f 7220 286e 6f74 206f 732e 7061 7468   or (not os.path
-00002620: 2e69 7364 6972 2872 6573 7064 6972 2929  .isdir(respdir))
-00002630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00002640: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00002650: 6f72 2822 7265 7370 6f6e 7365 2066 696c  or("response fil
-00002660: 6520 666f 6c64 6572 206e 6f74 2066 6f75  e folder not fou
-00002670: 6e64 2120 6162 6f72 7421 2229 0a0a 2020  nd! abort!")..  
-00002680: 2020 2020 2020 6966 2072 6d5f 7265 7370        if rm_resp
-00002690: 203d 3d20 2269 6e76 223a 0a20 2020 2020   == "inv":.     
-000026a0: 2020 2020 2020 2023 202d 2d2d 2d63 6865         # ----che
-000026b0: 636b 2077 6865 7468 6572 2069 6e76 656e  ck whether inven
-000026c0: 746f 7279 2069 7320 6174 7461 6368 6564  tory is attached
-000026d0: 2d2d 2d2d 0a20 2020 2020 2020 2020 2020  ----.           
-000026e0: 2069 6620 6e6f 7420 696e 765b 305d 5b30   if not inv[0][0
-000026f0: 5d5b 305d 2e72 6573 706f 6e73 653a 0a20  ][0].response:. 
-00002700: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00002710: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00002720: 226e 6f20 7265 7370 6f6e 7365 2066 6f75  "no response fou
-00002730: 6e64 2069 6e20 7468 6520 696e 7665 6e74  nd in the invent
-00002740: 6f72 7921 2061 626f 7274 2122 290a 2020  ory! abort!").  
-00002750: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
-00002760: 6e76 5b30 5d5b 305d 5b30 5d2e 7265 7370  nv[0][0][0].resp
-00002770: 6f6e 7365 203d 3d20 6f62 7370 792e 636f  onse == obspy.co
-00002780: 7265 2e69 6e76 656e 746f 7279 2e72 6573  re.inventory.res
-00002790: 706f 6e73 652e 5265 7370 6f6e 7365 2829  ponse.Response()
-000027a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000027b0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-000027c0: 6f72 2822 5468 6520 7265 7370 6f6e 7365  or("The response
-000027d0: 2066 6f75 6e64 2069 6e20 7468 6520 696e   found in the in
-000027e0: 7665 6e74 6f72 7920 6973 2065 6d70 7479  ventory is empty
-000027f0: 2028 6e6f 2073 7461 6765 7329 2120 6162   (no stages)! ab
-00002800: 6f72 7421 2229 0a20 2020 2020 2020 2020  ort!").         
-00002810: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00002820: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00002830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002840: 2020 7072 696e 7428 2272 656d 6f76 696e    print("removin
-00002850: 6720 7265 7370 6f6e 7365 2066 6f72 2025  g response for %
-00002860: 7320 7573 696e 6720 696e 7622 2025 2073  s using inv" % s
-00002870: 745b 305d 290a 2020 2020 2020 2020 2020  t[0]).          
-00002880: 2020 2020 2020 2020 2020 7374 5b30 5d2e            st[0].
-00002890: 6174 7461 6368 5f72 6573 706f 6e73 6528  attach_response(
-000028a0: 696e 7629 0a20 2020 2020 2020 2020 2020  inv).           
-000028b0: 2020 2020 2020 2020 2073 745b 305d 2e72           st[0].r
-000028c0: 656d 6f76 655f 7265 7370 6f6e 7365 286f  emove_response(o
-000028d0: 7574 7075 743d 726d 5f72 6573 705f 6f75  utput=rm_resp_ou
-000028e0: 742c 2070 7265 5f66 696c 743d 7072 655f  t, pre_filt=pre_
-000028f0: 6669 6c74 2c20 7761 7465 725f 6c65 7665  filt, water_leve
-00002900: 6c3d 3630 290a 2020 2020 2020 2020 2020  l=60).          
-00002910: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00002920: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00002930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002940: 2070 7269 6e74 2822 5741 524e 494e 473a   print("WARNING:
-00002950: 2046 6169 6c65 6420 746f 2072 656d 6f76   Failed to remov
-00002960: 6520 7265 7370 6f6e 7365 2066 726f 6d20  e response from 
-00002970: 2573 2e20 5265 7475 726e 696e 6720 656d  %s. Returning em
-00002980: 7074 7920 7374 7265 616d 2e20 2573 2220  pty stream. %s" 
-00002990: 2520 2873 745b 305d 2c20 6529 290a 2020  % (st[0], e)).  
-000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029b0: 2020 7374 203d 205b 5d0a 2020 2020 2020    st = [].      
-000029c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000029d0: 7475 726e 2073 740a 0a20 2020 2020 2020  turn st..       
-000029e0: 2065 6c69 6620 726d 5f72 6573 7020 3d3d   elif rm_resp ==
-000029f0: 2022 7370 6563 7472 756d 223a 0a20 2020   "spectrum":.   
-00002a00: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-00002a10: 7265 6d6f 7665 2072 6573 706f 6e73 6520  remove response 
-00002a20: 7573 696e 6720 7370 6563 7472 756d 2229  using spectrum")
-00002a30: 0a20 2020 2020 2020 2020 2020 2073 7065  .            spe
-00002a40: 6366 696c 6520 3d20 676c 6f62 2e67 6c6f  cfile = glob.glo
-00002a50: 6228 6f73 2e70 6174 682e 6a6f 696e 2872  b(os.path.join(r
-00002a60: 6573 7064 6972 2c20 222a 2220 2b20 7374  espdir, "*" + st
-00002a70: 6174 696f 6e20 2b20 222a 2229 290a 2020  ation + "*")).  
-00002a80: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00002a90: 2873 7065 6366 696c 6529 203d 3d20 303a  (specfile) == 0:
-00002aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002ab0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00002ac0: 7228 226e 6f20 7265 7370 6f6e 7365 2073  r("no response s
-00002ad0: 6570 6374 7275 6d20 666f 756e 6420 666f  epctrum found fo
-00002ae0: 7220 2573 2220 2520 7374 6174 696f 6e29  r %s" % station)
-00002af0: 0a20 2020 2020 2020 2020 2020 2073 7420  .            st 
-00002b00: 3d20 7265 7370 5f73 7065 6374 7275 6d28  = resp_spectrum(
-00002b10: 7374 2c20 7370 6563 6669 6c65 5b30 5d2c  st, specfile[0],
-00002b20: 2073 616d 705f 6672 6571 2c20 7072 655f   samp_freq, pre_
-00002b30: 6669 6c74 290a 0a20 2020 2020 2020 2065  filt)..        e
-00002b40: 6c69 6620 726d 5f72 6573 7020 3d3d 2022  lif rm_resp == "
-00002b50: 5245 5350 223a 0a20 2020 2020 2020 2020  RESP":.         
-00002b60: 2020 2070 7269 6e74 2822 7265 6d6f 7665     print("remove
-00002b70: 2072 6573 706f 6e73 6520 7573 696e 6720   response using 
-00002b80: 5245 5350 2066 696c 6573 2229 0a20 2020  RESP files").   
-00002b90: 2020 2020 2020 2020 2072 6573 7020 3d20           resp = 
-00002ba0: 676c 6f62 2e67 6c6f 6228 6f73 2e70 6174  glob.glob(os.pat
-00002bb0: 682e 6a6f 696e 2872 6573 7064 6972 2c20  h.join(respdir, 
-00002bc0: 2252 4553 502e 2220 2b20 7374 6174 696f  "RESP." + statio
-00002bd0: 6e20 2b20 222a 2229 290a 2020 2020 2020  n + "*")).      
-00002be0: 2020 2020 2020 6966 206c 656e 2872 6573        if len(res
-00002bf0: 7029 203d 3d20 303a 0a20 2020 2020 2020  p) == 0:.       
-00002c00: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00002c10: 616c 7565 4572 726f 7228 226e 6f20 5245  alueError("no RE
-00002c20: 5350 2066 696c 6573 2066 6f75 6e64 2066  SP files found f
-00002c30: 6f72 2025 7322 2025 2073 7461 7469 6f6e  or %s" % station
-00002c40: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00002c50: 6564 7265 7370 203d 207b 0a20 2020 2020  edresp = {.     
-00002c60: 2020 2020 2020 2020 2020 2022 6669 6c65             "file
-00002c70: 6e61 6d65 223a 2072 6573 705b 305d 2c0a  name": resp[0],.
-00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c90: 2264 6174 6522 3a20 7374 6172 7474 696d  "date": starttim
-00002ca0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00002cb0: 2020 2022 756e 6974 7322 3a20 2244 4953     "units": "DIS
-00002cc0: 222c 0a20 2020 2020 2020 2020 2020 207d  ",.            }
-00002cd0: 0a20 2020 2020 2020 2020 2020 2073 742e  .            st.
-00002ce0: 7369 6d75 6c61 7465 2870 617a 5f72 656d  simulate(paz_rem
-00002cf0: 6f76 653d 4e6f 6e65 2c20 7072 655f 6669  ove=None, pre_fi
-00002d00: 6c74 3d70 7265 5f66 696c 742c 2073 6565  lt=pre_filt, see
-00002d10: 6472 6573 703d 7365 6564 7265 7370 290a  dresp=seedresp).
-00002d20: 0a20 2020 2020 2020 2065 6c69 6620 726d  .        elif rm
-00002d30: 5f72 6573 7020 3d3d 2022 706f 6c65 737a  _resp == "polesz
-00002d40: 6572 6f73 223a 0a20 2020 2020 2020 2020  eros":.         
-00002d50: 2020 2070 7269 6e74 2822 7265 6d6f 7665     print("remove
-00002d60: 2072 6573 706f 6e73 6520 7573 696e 6720   response using 
-00002d70: 706f 6c65 7320 616e 6420 7a65 726f 7322  poles and zeros"
-00002d80: 290a 2020 2020 2020 2020 2020 2020 7061  ).            pa
-00002d90: 7a5f 7374 7320 3d20 676c 6f62 2e67 6c6f  z_sts = glob.glo
-00002da0: 6228 6f73 2e70 6174 682e 6a6f 696e 2872  b(os.path.join(r
-00002db0: 6573 7064 6972 2c20 222a 2220 2b20 7374  espdir, "*" + st
-00002dc0: 6174 696f 6e20 2b20 222a 2229 290a 2020  ation + "*")).  
-00002dd0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00002de0: 2870 617a 5f73 7473 2920 3d3d 2030 3a0a  (paz_sts) == 0:.
-00002df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002e00: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00002e10: 2822 6e6f 2070 6f6c 6573 7a65 726f 7320  ("no poleszeros 
-00002e20: 666f 756e 6420 666f 7220 2573 2220 2520  found for %s" % 
-00002e30: 7374 6174 696f 6e29 0a20 2020 2020 2020  station).       
-00002e40: 2020 2020 2073 742e 7369 6d75 6c61 7465       st.simulate
-00002e50: 2870 617a 5f72 656d 6f76 653d 7061 7a5f  (paz_remove=paz_
-00002e60: 7374 735b 305d 2c20 7072 655f 6669 6c74  sts[0], pre_filt
-00002e70: 3d70 7265 5f66 696c 7429 0a0a 2020 2020  =pre_filt)..    
-00002e80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00002e90: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00002ea0: 6545 7272 6f72 2822 6e6f 2073 7563 6820  eError("no such 
-00002eb0: 6f70 7469 6f6e 2066 6f72 2072 6d5f 7265  option for rm_re
-00002ec0: 7370 2120 706c 6561 7365 2064 6f75 626c  sp! please doubl
-00002ed0: 6520 6368 6563 6b21 2229 0a0a 2020 2020  e check!")..    
-00002ee0: 6e74 7220 3d20 6f62 7370 792e 5374 7265  ntr = obspy.Stre
-00002ef0: 616d 2829 0a20 2020 2023 2074 7269 6d20  am().    # trim 
-00002f00: 6120 636f 6e74 696e 6f75 7320 7365 676d  a continous segm
-00002f10: 656e 7420 696e 746f 2075 7365 722d 6465  ent into user-de
-00002f20: 6669 6e65 6420 7365 7175 656e 6365 730a  fined sequences.
-00002f30: 2020 2020 7374 5b30 5d2e 7472 696d 280a      st[0].trim(.
-00002f40: 2020 2020 2020 2020 7374 6172 7474 696d          starttim
-00002f50: 653d 7374 6172 7474 696d 652c 0a20 2020  e=starttime,.   
-00002f60: 2020 2020 2065 6e64 7469 6d65 3d65 6e64       endtime=end
-00002f70: 7469 6d65 2c0a 2020 2020 2020 2020 7061  time,.        pa
-00002f80: 643d 5472 7565 2c0a 2020 2020 2020 2020  d=True,.        
-00002f90: 6669 6c6c 5f76 616c 7565 3d30 2c0a 2020  fill_value=0,.  
-00002fa0: 2020 290a 2020 2020 6e74 722e 6170 7065    ).    ntr.appe
-00002fb0: 6e64 2873 745b 305d 290a 0a20 2020 2072  nd(st[0])..    r
-00002fc0: 6574 7572 6e20 6e74 720a 0a0a 6465 6620  eturn ntr...def 
-00002fd0: 7374 6174 7332 696e 7628 7374 6174 732c  stats2inv(stats,
-00002fe0: 2070 7265 7072 6f5f 7061 7261 2c20 6c6f   prepro_para, lo
-00002ff0: 6373 3d4e 6f6e 6529 3a0a 2020 2020 2222  cs=None):.    ""
-00003000: 220a 2020 2020 7468 6973 2066 756e 6374  ".    this funct
-00003010: 696f 6e20 6372 6561 7465 7320 696e 7665  ion creates inve
-00003020: 6e74 6f72 7920 6769 7665 6e20 7468 6520  ntory given the 
-00003030: 7374 6174 7320 7061 7261 6d65 7465 7273  stats parameters
-00003040: 2069 6e20 616e 206f 6273 7079 2073 7472   in an obspy str
-00003050: 6561 6d20 6f72 2061 2073 7461 7469 6f6e  eam or a station
-00003060: 206c 6973 742e 0a20 2020 2028 7573 6564   list..    (used
-00003070: 2069 6e20 5330 4229 0a20 2020 2050 4152   in S0B).    PAR
-00003080: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
-00003090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000030a0: 2d2d 2d2d 2d0a 2020 2020 7374 6174 733a  -----.    stats:
-000030b0: 206f 6273 7079 2074 7261 6365 2073 7461   obspy trace sta
-000030c0: 7473 206f 626a 6563 7420 636f 6e74 6169  ts object contai
-000030d0: 6e69 6e67 2061 6c6c 2073 7461 7469 6f6e  ning all station
-000030e0: 2068 6561 6465 7220 696e 666f 0a20 2020   header info.   
-000030f0: 2070 7265 7072 6f5f 7061 7261 3a20 6469   prepro_para: di
-00003100: 6374 2063 6f6e 7461 696e 696e 6720 6666  ct containing ff
-00003110: 7420 7061 7261 6d65 7465 7273 2c20 7375  t parameters, su
-00003120: 6368 2061 7320 6672 6571 7565 6e63 7920  ch as frequency 
-00003130: 6261 6e64 7320 616e 6420 7365 6c65 6374  bands and select
-00003140: 696f 6e20 666f 7220 696e 7374 7275 6d65  ion for instrume
-00003150: 6e74 0a20 2020 2072 6573 706f 6e73 6520  nt.    response 
-00003160: 7265 6d6f 7661 6c20 6574 632e 0a20 2020  removal etc..   
-00003170: 206c 6f63 733a 2020 7061 6e64 6120 6461   locs:  panda da
-00003180: 7461 2066 7261 6d65 206f 6620 7468 6520  ta frame of the 
-00003190: 7374 6174 696f 6e20 6c69 7374 2e20 6974  station list. it
-000031a0: 2069 7320 6e65 6564 6564 2066 6f72 2063   is needed for c
-000031b0: 6f6e 7665 7269 6e67 206d 696e 6973 6565  onvering minisee
-000031c0: 6420 6669 6c65 7320 696e 746f 2041 5344  d files into ASD
-000031d0: 460a 2020 2020 5245 5455 524e 533a 0a20  F.    RETURNS:. 
-000031e0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-000031f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-00003200: 696e 763a 206f 6273 7079 2069 6e76 656e  inv: obspy inven
-00003210: 746f 7279 206f 626a 6563 7420 6f66 2061  tory object of a
-00003220: 6c6c 2073 7461 7469 6f6e 2069 6e66 6f20  ll station info 
-00003230: 746f 2062 6520 7573 6564 206c 6174 6572  to be used later
-00003240: 0a20 2020 2022 2222 0a20 2020 2073 7461  .    """.    sta
-00003250: 786d 6c20 3d20 7072 6570 726f 5f70 6172  xml = prepro_par
-00003260: 615b 2273 7461 7469 6f6e 786d 6c22 5d0a  a["stationxml"].
-00003270: 2020 2020 7265 7370 6469 7220 3d20 7072      respdir = pr
-00003280: 6570 726f 5f70 6172 615b 2272 6573 7064  epro_para["respd
-00003290: 6972 225d 0a20 2020 2069 6e70 7574 5f66  ir"].    input_f
-000032a0: 6d74 203d 2070 7265 7072 6f5f 7061 7261  mt = prepro_para
-000032b0: 5b22 696e 7075 745f 666d 7422 5d0a 2020  ["input_fmt"].  
-000032c0: 2020 6966 2073 7461 786d 6c3a 0a20 2020    if staxml:.   
-000032d0: 2020 2020 2072 6574 7572 6e20 7374 6174       return stat
-000032e0: 7332 496e 765f 7374 6178 6d6c 2873 7461  s2Inv_staxml(sta
-000032f0: 7473 2c20 7265 7370 6469 7229 0a20 2020  ts, respdir).   
-00003300: 2069 6620 696e 7075 745f 666d 7420 3d3d   if input_fmt ==
-00003310: 2022 7361 6322 3a0a 2020 2020 2020 2020   "sac":.        
-00003320: 7265 7475 726e 2073 7461 7473 3269 6e76  return stats2inv
-00003330: 5f73 6163 2873 7461 7473 290a 2020 2020  _sac(stats).    
-00003340: 656c 6966 2069 6e70 7574 5f66 6d74 203d  elif input_fmt =
-00003350: 3d20 226d 7365 6564 223a 0a20 2020 2020  = "mseed":.     
-00003360: 2020 2072 6574 7572 6e20 7374 6174 7332     return stats2
-00003370: 696e 765f 6d73 6565 6428 7374 6174 732c  inv_mseed(stats,
-00003380: 206c 6f63 7329 0a0a 0a64 6566 2073 7461   locs)...def sta
-00003390: 7473 3249 6e76 5f73 7461 786d 6c28 7374  ts2Inv_staxml(st
-000033a0: 6174 732c 2072 6573 7064 6972 2920 2d3e  ats, respdir) ->
-000033b0: 2049 6e76 656e 746f 7279 3a0a 2020 2020   Inventory:.    
-000033c0: 6966 206e 6f74 2072 6573 7064 6972 3a0a  if not respdir:.
-000033d0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-000033e0: 6c75 6545 7272 6f72 2822 4162 6f72 7421  lueError("Abort!
-000033f0: 2073 7461 786d 6c20 6973 2073 656c 6563   staxml is selec
-00003400: 7465 6420 6275 7420 6e6f 2064 6972 6563  ted but no direc
-00003410: 746f 7279 2069 7320 6769 7665 6e20 746f  tory is given to
-00003420: 2061 6363 6573 7320 7468 6520 6669 6c65   access the file
-00003430: 7322 290a 2020 2020 656c 7365 3a0a 2020  s").    else:.  
-00003440: 2020 2020 2020 696e 7666 696c 656c 6973        invfilelis
-00003450: 7420 3d20 676c 6f62 2e67 6c6f 6228 6f73  t = glob.glob(os
-00003460: 2e70 6174 682e 6a6f 696e 2872 6573 7064  .path.join(respd
-00003470: 6972 2c20 222a 2220 2b20 7374 6174 732e  ir, "*" + stats.
-00003480: 7374 6174 696f 6e20 2b20 222a 2229 290a  station + "*")).
-00003490: 2020 2020 2020 2020 6966 206c 656e 2869          if len(i
-000034a0: 6e76 6669 6c65 6c69 7374 2920 3e20 303a  nvfilelist) > 0:
-000034b0: 0a20 2020 2020 2020 2020 2020 2069 6e76  .            inv
-000034c0: 6669 6c65 203d 2069 6e76 6669 6c65 6c69  file = invfileli
-000034d0: 7374 5b30 5d0a 2020 2020 2020 2020 2020  st[0].          
-000034e0: 2020 6966 206c 656e 2869 6e76 6669 6c65    if len(invfile
-000034f0: 6c69 7374 2920 3e20 313a 0a20 2020 2020  list) > 1:.     
-00003500: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00003510: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00003520: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
-00003530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003540: 2257 6172 6e69 6e67 2120 4d6f 7265 2074  "Warning! More t
-00003550: 6861 6e20 6f6e 6520 5374 6174 696f 6e58  han one StationX
-00003560: 4d4c 2066 696c 6520 7761 7320 666f 756e  ML file was foun
-00003570: 6420 666f 7220 7374 6174 696f 6e20 2573  d for station %s
-00003580: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
-00003590: 2020 2020 2020 2020 2020 202b 2022 4b65             + "Ke
-000035a0: 6570 696e 6720 7468 6520 6669 7273 7420  eping the first 
-000035b0: 6669 6c65 2069 6e20 6c69 7374 2e22 0a20  file in list.". 
-000035c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000035d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000035e0: 2020 2020 2020 2020 2025 2073 7461 7473           % stats
-000035f0: 2e73 7461 7469 6f6e 0a20 2020 2020 2020  .station.       
-00003600: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00003610: 2020 2020 2020 2069 6620 6f73 2e70 6174         if os.pat
-00003620: 682e 6973 6669 6c65 2873 7472 2869 6e76  h.isfile(str(inv
-00003630: 6669 6c65 2929 3a0a 2020 2020 2020 2020  file)):.        
-00003640: 2020 2020 2020 2020 696e 7620 3d20 6f62          inv = ob
-00003650: 7370 792e 7265 6164 5f69 6e76 656e 746f  spy.read_invento
-00003660: 7279 2869 6e76 6669 6c65 290a 2020 2020  ry(invfile).    
-00003670: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00003680: 726e 2069 6e76 0a20 2020 2020 2020 2065  rn inv.        e
-00003690: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000036a0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000036b0: 7228 2243 6f75 6c64 206e 6f74 2066 696e  r("Could not fin
-000036c0: 6420 6120 5374 6174 696f 6e58 4d4c 2066  d a StationXML f
-000036d0: 696c 6520 666f 7220 7374 6174 696f 6e3a  ile for station:
-000036e0: 2025 732e 2220 2520 7374 6174 732e 7374   %s." % stats.st
-000036f0: 6174 696f 6e29 0a0a 0a64 6566 2073 7461  ation)...def sta
-00003700: 7473 3269 6e76 5f73 6163 2873 7461 7473  ts2inv_sac(stats
-00003710: 293a 0a20 2020 2069 6e76 203d 2049 6e76  ):.    inv = Inv
-00003720: 656e 746f 7279 286e 6574 776f 726b 733d  entory(networks=
-00003730: 5b5d 2c20 736f 7572 6365 3d22 686f 6d65  [], source="home
-00003740: 6772 6f77 6e22 290a 2020 2020 6e65 7420  grown").    net 
-00003750: 3d20 4e65 7477 6f72 6b28 0a20 2020 2020  = Network(.     
-00003760: 2020 2023 2054 6869 7320 6973 2074 6865     # This is the
-00003770: 206e 6574 776f 726b 2063 6f64 6520 6163   network code ac
-00003780: 636f 7264 696e 6720 746f 2074 6865 2053  cording to the S
-00003790: 4545 4420 7374 616e 6461 7264 2e0a 2020  EED standard..  
-000037a0: 2020 2020 2020 636f 6465 3d73 7461 7473        code=stats
-000037b0: 2e6e 6574 776f 726b 2c0a 2020 2020 2020  .network,.      
-000037c0: 2020 7374 6174 696f 6e73 3d5b 5d2c 0a20    stations=[],. 
-000037d0: 2020 2020 2020 2064 6573 6372 6970 7469         descripti
-000037e0: 6f6e 3d22 6372 6561 7465 6420 6672 6f6d  on="created from
-000037f0: 2053 4143 2061 6e64 2072 6573 7020 6669   SAC and resp fi
-00003800: 6c65 7322 2c0a 2020 2020 2020 2020 7374  les",.        st
-00003810: 6172 745f 6461 7465 3d73 7461 7473 2e73  art_date=stats.s
-00003820: 7461 7274 7469 6d65 2c0a 2020 2020 290a  tarttime,.    ).
-00003830: 0a20 2020 2073 7461 203d 2053 7461 7469  .    sta = Stati
-00003840: 6f6e 280a 2020 2020 2020 2020 2320 5468  on(.        # Th
-00003850: 6973 2069 7320 7468 6520 7374 6174 696f  is is the statio
-00003860: 6e20 636f 6465 2061 6363 6f72 6469 6e67  n code according
-00003870: 2074 6f20 7468 6520 5345 4544 2073 7461   to the SEED sta
-00003880: 6e64 6172 642e 0a20 2020 2020 2020 2063  ndard..        c
-00003890: 6f64 653d 7374 6174 732e 7374 6174 696f  ode=stats.statio
-000038a0: 6e2c 0a20 2020 2020 2020 206c 6174 6974  n,.        latit
-000038b0: 7564 653d 7374 6174 732e 7361 635b 2273  ude=stats.sac["s
-000038c0: 746c 6122 5d2c 0a20 2020 2020 2020 206c  tla"],.        l
-000038d0: 6f6e 6769 7475 6465 3d73 7461 7473 2e73  ongitude=stats.s
-000038e0: 6163 5b22 7374 6c6f 225d 2c0a 2020 2020  ac["stlo"],.    
-000038f0: 2020 2020 656c 6576 6174 696f 6e3d 7374      elevation=st
-00003900: 6174 732e 7361 635b 2273 7465 6c22 5d2c  ats.sac["stel"],
-00003910: 0a20 2020 2020 2020 2063 7265 6174 696f  .        creatio
-00003920: 6e5f 6461 7465 3d73 7461 7473 2e73 7461  n_date=stats.sta
-00003930: 7274 7469 6d65 2c0a 2020 2020 2020 2020  rttime,.        
-00003940: 7369 7465 3d53 6974 6528 6e61 6d65 3d22  site=Site(name="
-00003950: 4669 7273 7420 7374 6174 696f 6e22 292c  First station"),
-00003960: 0a20 2020 2029 0a0a 2020 2020 6368 6120  .    )..    cha 
-00003970: 3d20 4368 616e 6e65 6c28 0a20 2020 2020  = Channel(.     
-00003980: 2020 2023 2054 6869 7320 6973 2074 6865     # This is the
-00003990: 2063 6861 6e6e 656c 2063 6f64 6520 6163   channel code ac
-000039a0: 636f 7264 696e 6720 746f 2074 6865 2053  cording to the S
-000039b0: 4545 4420 7374 616e 6461 7264 2e0a 2020  EED standard..  
-000039c0: 2020 2020 2020 636f 6465 3d73 7461 7473        code=stats
-000039d0: 2e63 6861 6e6e 656c 2c0a 2020 2020 2020  .channel,.      
-000039e0: 2020 2320 5468 6973 2069 7320 7468 6520    # This is the 
-000039f0: 6c6f 6361 7469 6f6e 2063 6f64 6520 6163  location code ac
-00003a00: 636f 7264 696e 6720 746f 2074 6865 2053  cording to the S
-00003a10: 4545 4420 7374 616e 6461 7264 2e0a 2020  EED standard..  
-00003a20: 2020 2020 2020 6c6f 6361 7469 6f6e 5f63        location_c
-00003a30: 6f64 653d 7374 6174 732e 6c6f 6361 7469  ode=stats.locati
-00003a40: 6f6e 2c0a 2020 2020 2020 2020 2320 4e6f  on,.        # No
-00003a50: 7465 2074 6861 7420 7468 6573 6520 636f  te that these co
-00003a60: 6f72 6469 6e61 7465 7320 6361 6e20 6469  ordinates can di
-00003a70: 6666 6572 2066 726f 6d20 7468 6520 7374  ffer from the st
-00003a80: 6174 696f 6e20 636f 6f72 6469 6e61 7465  ation coordinate
-00003a90: 732e 0a20 2020 2020 2020 206c 6174 6974  s..        latit
-00003aa0: 7564 653d 7374 6174 732e 7361 635b 2273  ude=stats.sac["s
-00003ab0: 746c 6122 5d2c 0a20 2020 2020 2020 206c  tla"],.        l
-00003ac0: 6f6e 6769 7475 6465 3d73 7461 7473 2e73  ongitude=stats.s
-00003ad0: 6163 5b22 7374 6c6f 225d 2c0a 2020 2020  ac["stlo"],.    
-00003ae0: 2020 2020 656c 6576 6174 696f 6e3d 7374      elevation=st
-00003af0: 6174 732e 7361 635b 2273 7465 6c22 5d2c  ats.sac["stel"],
-00003b00: 0a20 2020 2020 2020 2064 6570 7468 3d2d  .        depth=-
-00003b10: 7374 6174 732e 7361 635b 2273 7465 6c22  stats.sac["stel"
-00003b20: 5d2c 0a20 2020 2020 2020 2061 7a69 6d75  ],.        azimu
-00003b30: 7468 3d73 7461 7473 2e73 6163 5b22 636d  th=stats.sac["cm
-00003b40: 7061 7a22 5d2c 0a20 2020 2020 2020 2064  paz"],.        d
-00003b50: 6970 3d73 7461 7473 2e73 6163 5b22 636d  ip=stats.sac["cm
-00003b60: 7069 6e63 225d 2c0a 2020 2020 2020 2020  pinc"],.        
-00003b70: 7361 6d70 6c65 5f72 6174 653d 7374 6174  sample_rate=stat
-00003b80: 732e 7361 6d70 6c69 6e67 5f72 6174 652c  s.sampling_rate,
-00003b90: 0a20 2020 2029 0a20 2020 2072 6573 706f  .    ).    respo
-00003ba0: 6e73 6520 3d20 6f62 7370 792e 636f 7265  nse = obspy.core
-00003bb0: 2e69 6e76 656e 746f 7279 2e72 6573 706f  .inventory.respo
-00003bc0: 6e73 652e 5265 7370 6f6e 7365 2829 0a0a  nse.Response()..
-00003bd0: 2020 2020 2320 4e6f 7720 7469 6520 6974      # Now tie it
-00003be0: 2061 6c6c 2074 6f67 6574 6865 722e 0a20   all together.. 
-00003bf0: 2020 2063 6861 2e72 6573 706f 6e73 6520     cha.response 
-00003c00: 3d20 7265 7370 6f6e 7365 0a20 2020 2073  = response.    s
-00003c10: 7461 2e63 6861 6e6e 656c 732e 6170 7065  ta.channels.appe
-00003c20: 6e64 2863 6861 290a 2020 2020 6e65 742e  nd(cha).    net.
-00003c30: 7374 6174 696f 6e73 2e61 7070 656e 6428  stations.append(
-00003c40: 7374 6129 0a20 2020 2069 6e76 2e6e 6574  sta).    inv.net
-00003c50: 776f 726b 732e 6170 7065 6e64 286e 6574  works.append(net
-00003c60: 290a 0a20 2020 2072 6574 7572 6e20 696e  )..    return in
-00003c70: 760a 0a0a 6465 6620 7374 6174 7332 696e  v...def stats2in
-00003c80: 765f 6d73 6565 6428 7374 6174 732c 206c  v_mseed(stats, l
-00003c90: 6f63 733a 2070 642e 4461 7461 4672 616d  ocs: pd.DataFram
-00003ca0: 6529 202d 3e20 496e 7665 6e74 6f72 793a  e) -> Inventory:
-00003cb0: 0a20 2020 2069 6e76 203d 2049 6e76 656e  .    inv = Inven
-00003cc0: 746f 7279 286e 6574 776f 726b 733d 5b5d  tory(networks=[]
-00003cd0: 2c20 736f 7572 6365 3d22 686f 6d65 6772  , source="homegr
-00003ce0: 6f77 6e22 290a 2020 2020 6973 7461 203d  own").    ista =
-00003cf0: 206c 6f63 735b 6c6f 6373 5b22 7374 6174   locs[locs["stat
-00003d00: 696f 6e22 5d20 3d3d 2073 7461 7473 2e73  ion"] == stats.s
-00003d10: 7461 7469 6f6e 5d2e 696e 6465 782e 7661  tation].index.va
-00003d20: 6c75 6573 2e61 7374 7970 6528 2269 6e74  lues.astype("int
-00003d30: 3634 2229 5b30 5d0a 0a20 2020 206e 6574  64")[0]..    net
-00003d40: 203d 204e 6574 776f 726b 280a 2020 2020   = Network(.    
-00003d50: 2020 2020 2320 5468 6973 2069 7320 7468      # This is th
-00003d60: 6520 6e65 7477 6f72 6b20 636f 6465 2061  e network code a
-00003d70: 6363 6f72 6469 6e67 2074 6f20 7468 6520  ccording to the 
-00003d80: 5345 4544 2073 7461 6e64 6172 642e 0a20  SEED standard.. 
-00003d90: 2020 2020 2020 2063 6f64 653d 6c6f 6373         code=locs
-00003da0: 2e69 6c6f 635b 6973 7461 5d5b 226e 6574  .iloc[ista]["net
-00003db0: 776f 726b 225d 2c0a 2020 2020 2020 2020  work"],.        
-00003dc0: 7374 6174 696f 6e73 3d5b 5d2c 0a20 2020  stations=[],.   
-00003dd0: 2020 2020 2064 6573 6372 6970 7469 6f6e       description
-00003de0: 3d22 6372 6561 7465 6420 6672 6f6d 2053  ="created from S
-00003df0: 4143 2061 6e64 2072 6573 7020 6669 6c65  AC and resp file
-00003e00: 7322 2c0a 2020 2020 2020 2020 7374 6172  s",.        star
-00003e10: 745f 6461 7465 3d73 7461 7473 2e73 7461  t_date=stats.sta
-00003e20: 7274 7469 6d65 2c0a 2020 2020 290a 0a20  rttime,.    ).. 
-00003e30: 2020 2073 7461 203d 2053 7461 7469 6f6e     sta = Station
-00003e40: 280a 2020 2020 2020 2020 2320 5468 6973  (.        # This
-00003e50: 2069 7320 7468 6520 7374 6174 696f 6e20   is the station 
-00003e60: 636f 6465 2061 6363 6f72 6469 6e67 2074  code according t
-00003e70: 6f20 7468 6520 5345 4544 2073 7461 6e64  o the SEED stand
-00003e80: 6172 642e 0a20 2020 2020 2020 2063 6f64  ard..        cod
-00003e90: 653d 6c6f 6373 2e69 6c6f 635b 6973 7461  e=locs.iloc[ista
-00003ea0: 5d5b 2273 7461 7469 6f6e 225d 2c0a 2020  ]["station"],.  
-00003eb0: 2020 2020 2020 6c61 7469 7475 6465 3d6c        latitude=l
-00003ec0: 6f63 732e 696c 6f63 5b69 7374 615d 5b22  ocs.iloc[ista]["
-00003ed0: 6c61 7469 7475 6465 225d 2c0a 2020 2020  latitude"],.    
-00003ee0: 2020 2020 6c6f 6e67 6974 7564 653d 6c6f      longitude=lo
-00003ef0: 6373 2e69 6c6f 635b 6973 7461 5d5b 226c  cs.iloc[ista]["l
-00003f00: 6f6e 6769 7475 6465 225d 2c0a 2020 2020  ongitude"],.    
-00003f10: 2020 2020 656c 6576 6174 696f 6e3d 6c6f      elevation=lo
-00003f20: 6373 2e69 6c6f 635b 6973 7461 5d5b 2265  cs.iloc[ista]["e
-00003f30: 6c65 7661 7469 6f6e 225d 2c0a 2020 2020  levation"],.    
-00003f40: 2020 2020 6372 6561 7469 6f6e 5f64 6174      creation_dat
-00003f50: 653d 7374 6174 732e 7374 6172 7474 696d  e=stats.starttim
-00003f60: 652c 0a20 2020 2020 2020 2073 6974 653d  e,.        site=
-00003f70: 5369 7465 286e 616d 653d 2246 6972 7374  Site(name="First
-00003f80: 2073 7461 7469 6f6e 2229 2c0a 2020 2020   station"),.    
-00003f90: 290a 0a20 2020 2063 6861 203d 2043 6861  )..    cha = Cha
-00003fa0: 6e6e 656c 280a 2020 2020 2020 2020 636f  nnel(.        co
-00003fb0: 6465 3d73 7461 7473 2e63 6861 6e6e 656c  de=stats.channel
-00003fc0: 2c0a 2020 2020 2020 2020 6c6f 6361 7469  ,.        locati
-00003fd0: 6f6e 5f63 6f64 653d 7374 6174 732e 6c6f  on_code=stats.lo
-00003fe0: 6361 7469 6f6e 2c0a 2020 2020 2020 2020  cation,.        
-00003ff0: 6c61 7469 7475 6465 3d6c 6f63 732e 696c  latitude=locs.il
-00004000: 6f63 5b69 7374 615d 5b22 6c61 7469 7475  oc[ista]["latitu
-00004010: 6465 225d 2c0a 2020 2020 2020 2020 6c6f  de"],.        lo
-00004020: 6e67 6974 7564 653d 6c6f 6373 2e69 6c6f  ngitude=locs.ilo
-00004030: 635b 6973 7461 5d5b 226c 6f6e 6769 7475  c[ista]["longitu
-00004040: 6465 225d 2c0a 2020 2020 2020 2020 656c  de"],.        el
-00004050: 6576 6174 696f 6e3d 6c6f 6373 2e69 6c6f  evation=locs.ilo
-00004060: 635b 6973 7461 5d5b 2265 6c65 7661 7469  c[ista]["elevati
-00004070: 6f6e 225d 2c0a 2020 2020 2020 2020 6465  on"],.        de
-00004080: 7074 683d 2d6c 6f63 732e 696c 6f63 5b69  pth=-locs.iloc[i
-00004090: 7374 615d 5b22 656c 6576 6174 696f 6e22  sta]["elevation"
-000040a0: 5d2c 0a20 2020 2020 2020 2061 7a69 6d75  ],.        azimu
-000040b0: 7468 3d30 2c0a 2020 2020 2020 2020 6469  th=0,.        di
-000040c0: 703d 302c 0a20 2020 2020 2020 2073 616d  p=0,.        sam
-000040d0: 706c 655f 7261 7465 3d73 7461 7473 2e73  ple_rate=stats.s
-000040e0: 616d 706c 696e 675f 7261 7465 2c0a 2020  ampling_rate,.  
-000040f0: 2020 290a 0a20 2020 2072 6573 706f 6e73    )..    respons
-00004100: 6520 3d20 6f62 7370 792e 636f 7265 2e69  e = obspy.core.i
-00004110: 6e76 656e 746f 7279 2e72 6573 706f 6e73  nventory.respons
-00004120: 652e 5265 7370 6f6e 7365 2829 0a0a 2020  e.Response()..  
-00004130: 2020 2320 4e6f 7720 7469 6520 6974 2061    # Now tie it a
-00004140: 6c6c 2074 6f67 6574 6865 722e 0a20 2020  ll together..   
-00004150: 2063 6861 2e72 6573 706f 6e73 6520 3d20   cha.response = 
-00004160: 7265 7370 6f6e 7365 0a20 2020 2073 7461  response.    sta
-00004170: 2e63 6861 6e6e 656c 732e 6170 7065 6e64  .channels.append
-00004180: 2863 6861 290a 2020 2020 6e65 742e 7374  (cha).    net.st
-00004190: 6174 696f 6e73 2e61 7070 656e 6428 7374  ations.append(st
-000041a0: 6129 0a20 2020 2069 6e76 2e6e 6574 776f  a).    inv.netwo
-000041b0: 726b 732e 6170 7065 6e64 286e 6574 290a  rks.append(net).
-000041c0: 0a20 2020 2072 6574 7572 6e20 696e 760a  .    return inv.
-000041d0: 0a0a 6465 6620 7374 615f 696e 666f 5f66  ..def sta_info_f
-000041e0: 726f 6d5f 696e 7628 696e 763a 206f 6273  rom_inv(inv: obs
-000041f0: 7079 2e63 6f72 652e 696e 7665 6e74 6f72  py.core.inventor
-00004200: 792e 696e 7665 6e74 6f72 792e 496e 7665  y.inventory.Inve
-00004210: 6e74 6f72 7929 3a0a 2020 2020 2222 220a  ntory):.    """.
-00004220: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
-00004230: 6e20 6f75 7470 7574 7320 7374 6174 696f  n outputs statio
-00004240: 6e20 696e 666f 2066 726f 6d20 7468 6520  n info from the 
-00004250: 6f62 7370 7920 696e 7665 6e74 6f72 7920  obspy inventory 
-00004260: 6f62 6a65 6374 0a20 2020 2028 7573 6564  object.    (used
-00004270: 2069 6e20 5330 4229 0a20 2020 2050 4152   in S0B).    PAR
-00004280: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
-00004290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000042a0: 2d2d 2d0a 2020 2020 696e 763a 206f 6273  ---.    inv: obs
-000042b0: 7079 2069 6e76 656e 746f 7279 206f 626a  py inventory obj
-000042c0: 6563 740a 2020 2020 5245 5455 524e 533a  ect.    RETURNS:
-000042d0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-000042e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-000042f0: 7374 613a 2073 7461 7469 6f6e 206e 616d  sta: station nam
-00004300: 650a 2020 2020 6e65 743a 206e 6574 6f77  e.    net: netow
-00004310: 726b 206e 616d 650a 2020 2020 6c6f 6e3a  rk name.    lon:
-00004320: 206c 6f6e 6769 7475 6465 206f 6620 7468   longitude of th
-00004330: 6520 7374 6174 696f 6e0a 2020 2020 6c61  e station.    la
-00004340: 743a 206c 6174 6974 7564 6520 6f66 2074  t: latitude of t
-00004350: 6865 2073 7461 7469 6f6e 0a20 2020 2065  he station.    e
-00004360: 6c76 3a20 656c 6576 6174 696f 6e20 6f66  lv: elevation of
-00004370: 2074 6865 2073 7461 7469 6f6e 0a20 2020   the station.   
-00004380: 206c 6f63 6174 696f 6e3a 206c 6f63 6174   location: locat
-00004390: 696f 6e20 636f 6465 206f 6620 7468 6520  ion code of the 
-000043a0: 7374 6174 696f 6e0a 2020 2020 2222 220a  station.    """.
-000043b0: 2020 2020 2320 6c6f 6164 2066 726f 6d20      # load from 
-000043c0: 7374 6174 696f 6e20 696e 7665 6e74 6f72  station inventor
-000043d0: 790a 2020 2020 7374 6120 3d20 696e 765b  y.    sta = inv[
-000043e0: 305d 5b30 5d2e 636f 6465 0a20 2020 206e  0][0].code.    n
-000043f0: 6574 203d 2069 6e76 5b30 5d2e 636f 6465  et = inv[0].code
-00004400: 0a20 2020 206c 6f6e 203d 2069 6e76 5b30  .    lon = inv[0
-00004410: 5d5b 305d 2e6c 6f6e 6769 7475 6465 0a20  ][0].longitude. 
-00004420: 2020 206c 6174 203d 2069 6e76 5b30 5d5b     lat = inv[0][
-00004430: 305d 2e6c 6174 6974 7564 650a 2020 2020  0].latitude.    
-00004440: 6966 2069 6e76 5b30 5d5b 305d 2e65 6c65  if inv[0][0].ele
-00004450: 7661 7469 6f6e 3a0a 2020 2020 2020 2020  vation:.        
-00004460: 656c 7620 3d20 696e 765b 305d 5b30 5d2e  elv = inv[0][0].
-00004470: 656c 6576 6174 696f 6e0a 2020 2020 656c  elevation.    el
-00004480: 7365 3a0a 2020 2020 2020 2020 656c 7620  se:.        elv 
-00004490: 3d20 302e 300a 0a20 2020 2069 6620 696e  = 0.0..    if in
-000044a0: 765b 305d 5b30 5d5b 305d 2e6c 6f63 6174  v[0][0][0].locat
-000044b0: 696f 6e5f 636f 6465 3a0a 2020 2020 2020  ion_code:.      
-000044c0: 2020 6c6f 6361 7469 6f6e 203d 2069 6e76    location = inv
-000044d0: 5b30 5d5b 305d 5b30 5d2e 6c6f 6361 7469  [0][0][0].locati
-000044e0: 6f6e 5f63 6f64 650a 2020 2020 656c 7365  on_code.    else
-000044f0: 3a0a 2020 2020 2020 2020 6c6f 6361 7469  :.        locati
-00004500: 6f6e 203d 2022 3030 220a 0a20 2020 2072  on = "00"..    r
-00004510: 6574 7572 6e20 7374 612c 206e 6574 2c20  eturn sta, net, 
-00004520: 6c6f 6e2c 206c 6174 2c20 656c 762c 206c  lon, lat, elv, l
-00004530: 6f63 6174 696f 6e0a 0a0a 6465 6620 6375  ocation...def cu
-00004540: 745f 7472 6163 655f 6d61 6b65 5f73 7461  t_trace_make_sta
-00004550: 7428 6663 5f70 6172 613a 2043 6f6e 6669  t(fc_para: Confi
-00004560: 6750 6172 616d 6574 6572 732c 2063 685f  gParameters, ch_
-00004570: 6461 7461 3a20 4368 616e 6e65 6c44 6174  data: ChannelDat
-00004580: 6129 3a0a 2020 2020 2222 220a 2020 2020  a):.    """.    
-00004590: 7468 6973 2066 756e 6374 696f 6e20 6375  this function cu
-000045a0: 7473 2063 6f6e 7469 6e6f 7573 206e 6f69  ts continous noi
-000045b0: 7365 2064 6174 6120 696e 746f 2075 7365  se data into use
-000045c0: 722d 6465 6669 6e65 6420 7365 676d 656e  r-defined segmen
-000045d0: 7473 2c20 6573 7469 6d61 7465 2074 6865  ts, estimate the
-000045e0: 2073 7461 7469 7374 6963 7320 6f66 0a20   statistics of. 
-000045f0: 2020 2065 6163 6820 7365 676d 656e 7420     each segment 
-00004600: 616e 6420 6b65 6570 2074 696d 6573 7461  and keep timesta
-00004610: 6d70 206f 6620 6561 6368 2073 6567 6d65  mp of each segme
-00004620: 6e74 2066 6f72 206c 6174 6572 2075 7365  nt for later use
-00004630: 2e20 2875 7365 6420 696e 2053 3129 0a20  . (used in S1). 
-00004640: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
-00004650: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00004660: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6666  ---------.    ff
-00004670: 745f 7061 7261 3a20 4120 6469 6374 696f  t_para: A dictio
-00004680: 6e61 7279 2063 6f6e 7461 696e 696e 6720  nary containing 
-00004690: 616c 6c20 6666 7420 616e 6420 6363 2070  all fft and cc p
-000046a0: 6172 616d 6574 6572 732e 0a20 2020 2073  arameters..    s
-000046b0: 6f75 7263 653a 206f 6273 7079 2073 7472  ource: obspy str
-000046c0: 6561 6d20 6f62 6a65 6374 0a20 2020 2052  eam object.    R
-000046d0: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-000046e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000046f0: 2d2d 0a20 2020 2074 7261 6365 5f73 7464  --.    trace_std
-00004700: 533a 2073 7461 6e64 6172 6420 6465 7669  S: standard devi
-00004710: 6174 696f 6e20 6f66 2074 6865 206e 6f69  ation of the noi
-00004720: 7365 2061 6d70 6c69 7475 6465 206f 6620  se amplitude of 
-00004730: 6561 6368 2073 6567 6d65 6e74 0a20 2020  each segment.   
-00004740: 2064 6174 6153 5f74 3a20 2020 2074 696d   dataS_t:    tim
-00004750: 6573 7461 6d70 7320 6f66 2065 6163 6820  estamps of each 
-00004760: 7365 676d 656e 740a 2020 2020 6461 7461  segment.    data
-00004770: 533a 2020 2020 2020 3244 206d 6174 7269  S:      2D matri
-00004780: 7820 6f66 2074 6865 2073 6567 6d65 6e74  x of the segment
-00004790: 6564 2064 6174 610a 2020 2020 2222 220a  ed data.    """.
-000047a0: 2020 2020 2320 6465 6669 6e65 2072 6574      # define ret
-000047b0: 7572 6e20 7661 7269 6162 6c65 7320 6669  urn variables fi
-000047c0: 7273 740a 2020 2020 736f 7572 6365 5f70  rst.    source_p
-000047d0: 6172 616d 7320 3d20 5b5d 0a20 2020 2064  arams = [].    d
-000047e0: 6174 6153 5f74 203d 205b 5d0a 2020 2020  ataS_t = [].    
-000047f0: 6461 7461 5320 3d20 5b5d 0a0a 2020 2020  dataS = []..    
-00004800: 2320 7573 6566 756c 2070 6172 616d 6574  # useful paramet
-00004810: 6572 7320 666f 7220 7472 6163 6520 736c  ers for trace sl
-00004820: 6964 696e 670a 2020 2020 6e73 6567 203d  iding.    nseg =
-00004830: 2069 6e74 286e 702e 666c 6f6f 7228 2866   int(np.floor((f
-00004840: 635f 7061 7261 2e69 6e63 5f68 6f75 7273  c_para.inc_hours
-00004850: 202f 2032 3420 2a20 3836 3430 3020 2d20   / 24 * 86400 - 
-00004860: 6663 5f70 6172 612e 6363 5f6c 656e 2920  fc_para.cc_len) 
-00004870: 2f20 6663 5f70 6172 612e 7374 6570 2929  / fc_para.step))
-00004880: 0a20 2020 2073 7073 203d 2069 6e74 2863  .    sps = int(c
-00004890: 685f 6461 7461 2e73 616d 706c 696e 675f  h_data.sampling_
-000048a0: 7261 7465 290a 2020 2020 7374 6172 7474  rate).    startt
-000048b0: 696d 6520 3d20 6368 5f64 6174 612e 7374  ime = ch_data.st
-000048c0: 6172 745f 7469 6d65 7374 616d 700a 2020  art_timestamp.  
-000048d0: 2020 2320 636f 7079 2064 6174 6120 696e    # copy data in
-000048e0: 746f 2061 7272 6179 0a20 2020 2064 6174  to array.    dat
-000048f0: 6120 3d20 6368 5f64 6174 612e 6461 7461  a = ch_data.data
-00004900: 0a0a 2020 2020 2320 6966 2074 6865 2064  ..    # if the d
-00004910: 6174 6120 6973 2073 686f 7274 6572 2074  ata is shorter t
-00004920: 6861 6e20 7468 6520 7469 6d20 6368 756e  han the tim chun
-00004930: 636b 2c20 7265 7475 726e 207a 6572 6f20  ck, return zero 
-00004940: 7661 6c75 6573 0a20 2020 2069 6620 6461  values.    if da
-00004950: 7461 2e73 697a 6520 3c20 7370 7320 2a20  ta.size < sps * 
-00004960: 6663 5f70 6172 612e 696e 635f 686f 7572  fc_para.inc_hour
-00004970: 7320 2a20 3336 3030 3a0a 2020 2020 2020  s * 3600:.      
-00004980: 2020 7265 7475 726e 2073 6f75 7263 655f    return source_
-00004990: 7061 7261 6d73 2c20 6461 7461 535f 742c  params, dataS_t,
-000049a0: 2064 6174 6153 0a0a 2020 2020 2320 7374   dataS..    # st
-000049b0: 6174 6973 7469 6320 746f 2064 6574 6563  atistic to detec
-000049c0: 7420 7365 676d 656e 7473 2074 6861 7420  t segments that 
-000049d0: 6d61 7920 6265 2061 7373 6f63 6961 7465  may be associate
-000049e0: 6420 7769 7468 2065 6172 7468 7175 616b  d with earthquak
-000049f0: 6573 0a20 2020 2061 6c6c 5f6d 6164 5320  es.    all_madS 
-00004a00: 3d20 6d61 6428 6461 7461 2920 2023 206d  = mad(data)  # m
-00004a10: 6564 6961 6e20 6162 736f 6c75 7465 2064  edian absolute d
-00004a20: 6576 6961 7469 6f6e 206f 7665 7220 616c  eviation over al
-00004a30: 6c20 6e6f 6973 6520 7769 6e64 6f77 0a20  l noise window. 
-00004a40: 2020 2061 6c6c 5f73 7464 5320 3d20 6e70     all_stdS = np
-00004a50: 2e73 7464 2864 6174 6129 2020 2320 7374  .std(data)  # st
-00004a60: 616e 6461 7264 2064 6576 6961 7469 6f6e  andard deviation
-00004a70: 206f 7665 7220 616c 6c20 6e6f 6973 6520   over all noise 
-00004a80: 7769 6e64 6f77 0a20 2020 2069 6620 616c  window.    if al
-00004a90: 6c5f 6d61 6453 203d 3d20 3020 6f72 2061  l_madS == 0 or a
-00004aa0: 6c6c 5f73 7464 5320 3d3d 2030 206f 7220  ll_stdS == 0 or 
-00004ab0: 6e70 2e69 736e 616e 2861 6c6c 5f6d 6164  np.isnan(all_mad
-00004ac0: 5329 206f 7220 6e70 2e69 736e 616e 2861  S) or np.isnan(a
-00004ad0: 6c6c 5f73 7464 5329 3a0a 2020 2020 2020  ll_stdS):.      
-00004ae0: 2020 7072 696e 7428 2263 6f6e 7469 6e75    print("continu
-00004af0: 6521 206d 6164 5320 6f72 2073 7464 5320  e! madS or stdS 
-00004b00: 6571 7561 6c73 2074 6f20 3020 666f 7220  equals to 0 for 
-00004b10: 2573 2229 0a20 2020 2020 2020 2072 6574  %s").        ret
-00004b20: 7572 6e20 736f 7572 6365 5f70 6172 616d  urn source_param
-00004b30: 732c 2064 6174 6153 5f74 2c20 6461 7461  s, dataS_t, data
-00004b40: 530a 0a20 2020 2023 2069 6e69 7469 616c  S..    # initial
-00004b50: 697a 6520 7661 7269 6162 6c65 730a 2020  ize variables.  
-00004b60: 2020 6e70 7473 203d 2069 6e74 2866 635f    npts = int(fc_
-00004b70: 7061 7261 2e63 635f 6c65 6e20 2a20 7370  para.cc_len * sp
-00004b80: 7329 0a20 2020 2023 2074 7261 6365 5f6d  s).    # trace_m
-00004b90: 6164 5320 3d20 6e70 2e7a 6572 6f73 286e  adS = np.zeros(n
-00004ba0: 7365 672c 6474 7970 653d 6e70 2e66 6c6f  seg,dtype=np.flo
-00004bb0: 6174 3332 290a 2020 2020 7472 6163 655f  at32).    trace_
-00004bc0: 7374 6453 203d 206e 702e 7a65 726f 7328  stdS = np.zeros(
-00004bd0: 6e73 6567 2c20 6474 7970 653d 6e70 2e66  nseg, dtype=np.f
-00004be0: 6c6f 6174 3332 290a 2020 2020 6461 7461  loat32).    data
-00004bf0: 5320 3d20 6e70 2e7a 6572 6f73 2873 6861  S = np.zeros(sha
-00004c00: 7065 3d28 696e 7428 6e73 6567 292c 2069  pe=(int(nseg), i
-00004c10: 6e74 286e 7074 7329 292c 2064 7479 7065  nt(npts)), dtype
-00004c20: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
-00004c30: 2064 6174 6153 5f74 203d 206e 702e 7a65   dataS_t = np.ze
-00004c40: 726f 7328 6e73 6567 2c20 6474 7970 653d  ros(nseg, dtype=
-00004c50: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-00004c60: 2069 6e64 7831 203d 2030 0a20 2020 2066   indx1 = 0.    f
-00004c70: 6f72 2069 7365 6720 696e 2072 616e 6765  or iseg in range
-00004c80: 286e 7365 6729 3a0a 2020 2020 2020 2020  (nseg):.        
-00004c90: 696e 6478 3220 3d20 696e 6478 3120 2b20  indx2 = indx1 + 
-00004ca0: 6e70 7473 0a20 2020 2020 2020 2064 6174  npts.        dat
-00004cb0: 6153 5b69 7365 675d 203d 2064 6174 615b  aS[iseg] = data[
-00004cc0: 696e 6478 313a 696e 6478 325d 0a20 2020  indx1:indx2].   
-00004cd0: 2020 2020 2023 2074 7261 6365 5f6d 6164       # trace_mad
-00004ce0: 535b 6973 6567 5d20 3d20 286e 702e 6d61  S[iseg] = (np.ma
-00004cf0: 7828 6e70 2e61 6273 2864 6174 6153 5b69  x(np.abs(dataS[i
-00004d00: 7365 675d 2929 2f61 6c6c 5f6d 6164 5329  seg]))/all_madS)
-00004d10: 0a20 2020 2020 2020 2074 7261 6365 5f73  .        trace_s
-00004d20: 7464 535b 6973 6567 5d20 3d20 6e70 2e6d  tdS[iseg] = np.m
-00004d30: 6178 286e 702e 6162 7328 6461 7461 535b  ax(np.abs(dataS[
-00004d40: 6973 6567 5d29 2920 2f20 616c 6c5f 7374  iseg])) / all_st
-00004d50: 6453 0a20 2020 2020 2020 2064 6174 6153  dS.        dataS
-00004d60: 5f74 5b69 7365 675d 203d 2073 7461 7274  _t[iseg] = start
-00004d70: 7469 6d65 202b 2066 635f 7061 7261 2e73  time + fc_para.s
-00004d80: 7465 7020 2a20 6973 6567 0a20 2020 2020  tep * iseg.     
-00004d90: 2020 2069 6e64 7831 203d 2069 6e64 7831     indx1 = indx1
-00004da0: 202b 2069 6e74 2866 635f 7061 7261 2e73   + int(fc_para.s
-00004db0: 7465 7029 202a 2073 7073 0a0a 2020 2020  tep) * sps..    
-00004dc0: 2320 3244 2061 7272 6179 2070 726f 6365  # 2D array proce
-00004dd0: 7373 696e 670a 2020 2020 6461 7461 5320  ssing.    dataS 
-00004de0: 3d20 6465 6d65 616e 2864 6174 6153 290a  = demean(dataS).
-00004df0: 2020 2020 6461 7461 5320 3d20 6465 7472      dataS = detr
-00004e00: 656e 6428 6461 7461 5329 0a20 2020 2064  end(dataS).    d
-00004e10: 6174 6153 203d 2074 6170 6572 2864 6174  ataS = taper(dat
-00004e20: 6153 290a 0a20 2020 2072 6574 7572 6e20  aS)..    return 
-00004e30: 7472 6163 655f 7374 6453 2c20 6461 7461  trace_stdS, data
-00004e40: 535f 742c 2064 6174 6153 0a0a 0a64 6566  S_t, dataS...def
-00004e50: 206e 6f69 7365 5f70 726f 6365 7373 696e   noise_processin
-00004e60: 6728 6666 745f 7061 7261 2c20 6461 7461  g(fft_para, data
-00004e70: 5329 3a0a 2020 2020 2222 220a 2020 2020  S):.    """.    
-00004e80: 7468 6973 2066 756e 6374 696f 6e20 7065  this function pe
-00004e90: 7266 6f72 6d73 2074 696d 6520 646f 6d61  rforms time doma
-00004ea0: 696e 2061 6e64 2066 7265 7175 656e 6379  in and frequency
-00004eb0: 2064 6f6d 6169 6e20 6e6f 726d 616c 697a   domain normaliz
-00004ec0: 6174 696f 6e20 6966 206e 6565 6465 642e  ation if needed.
-00004ed0: 2069 6e20 7265 616c 2063 6173 652c 2077   in real case, w
-00004ee0: 6520 7072 6566 6572 2075 7365 2069 6e63  e prefer use inc
-00004ef0: 6c75 6465 0a20 2020 2074 6865 206e 6f72  lude.    the nor
-00004f00: 6d61 6c69 7a61 7469 6f6e 2069 6e20 7468  malization in th
-00004f10: 6520 6372 6f73 732d 636f 7272 6561 6c74  e cross-correalt
-00004f20: 696f 6e20 7374 6570 7320 6279 2073 656c  ion steps by sel
-00004f30: 6563 7469 6e67 2063 6f68 6572 656e 6379  ecting coherency
-00004f40: 206f 7220 6465 636f 6e0a 2020 2020 2850   or decon.    (P
-00004f50: 7269 6574 6f20 6574 2061 6c2c 2032 3030  rieto et al, 200
-00004f60: 382c 2032 3030 393b 2044 656e 6f6c 6c65  8, 2009; Denolle
-00004f70: 2065 7420 616c 2c20 3230 3133 290a 2020   et al, 2013).  
-00004f80: 2020 5041 524d 4145 5445 5253 3a0a 2020    PARMAETERS:.  
-00004f90: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-00004fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2066  ----------.    f
-00004fb0: 6674 5f70 6172 613a 2064 6963 7469 6f6e  ft_para: diction
-00004fc0: 6172 7920 636f 6e74 6169 6e69 6e67 2061  ary containing a
-00004fd0: 6c6c 2075 7365 6675 6c20 7661 7269 6162  ll useful variab
-00004fe0: 6c65 7320 7573 6564 2066 6f72 2066 6674  les used for fft
-00004ff0: 2061 6e64 2063 630a 2020 2020 6461 7461   and cc.    data
-00005000: 533a 2032 4420 6d61 7472 6978 206f 6620  S: 2D matrix of 
-00005010: 616c 6c20 7365 676d 656e 7465 6420 6e6f  all segmented no
-00005020: 6973 6520 6461 7461 0a20 2020 2023 204f  ise data.    # O
-00005030: 5554 5055 5420 5641 5249 4142 4c45 533a  UTPUT VARIABLES:
-00005040: 0a20 2020 2073 6f75 7263 655f 7768 6974  .    source_whit
-00005050: 653a 2032 4420 6d61 7472 6978 206f 6620  e: 2D matrix of 
-00005060: 6461 7461 2073 7065 6374 7261 0a20 2020  data spectra.   
-00005070: 2022 2222 0a20 2020 2023 206c 6f61 6420   """.    # load 
-00005080: 7061 7261 6d65 7465 7273 2066 6972 7374  parameters first
-00005090: 0a20 2020 2074 696d 655f 6e6f 726d 203d  .    time_norm =
-000050a0: 2066 6674 5f70 6172 615b 2274 696d 655f   fft_para["time_
-000050b0: 6e6f 726d 225d 0a20 2020 2066 7265 715f  norm"].    freq_
-000050c0: 6e6f 726d 203d 2066 6674 5f70 6172 615b  norm = fft_para[
-000050d0: 2266 7265 715f 6e6f 726d 225d 0a20 2020  "freq_norm"].   
-000050e0: 2073 6d6f 6f74 685f 4e20 3d20 6666 745f   smooth_N = fft_
-000050f0: 7061 7261 5b22 736d 6f6f 7468 5f4e 225d  para["smooth_N"]
-00005100: 0a20 2020 204e 203d 2064 6174 6153 2e73  .    N = dataS.s
-00005110: 6861 7065 5b30 5d0a 0a20 2020 2023 202d  hape[0]..    # -
-00005120: 2d2d 2d2d 2d74 6f20 6e6f 726d 616c 697a  -----to normaliz
-00005130: 6520 696e 2074 696d 6520 6f72 206e 6f74  e in time or not
-00005140: 2d2d 2d2d 2d2d 0a20 2020 2069 6620 7469  ------.    if ti
-00005150: 6d65 5f6e 6f72 6d20 213d 2022 6e6f 223a  me_norm != "no":
-00005160: 0a20 2020 2020 2020 2069 6620 7469 6d65  .        if time
-00005170: 5f6e 6f72 6d20 3d3d 2022 6f6e 655f 6269  _norm == "one_bi
-00005180: 7422 3a20 2023 2073 6967 6e20 6e6f 726d  t":  # sign norm
-00005190: 616c 697a 6174 696f 6e0a 2020 2020 2020  alization.      
-000051a0: 2020 2020 2020 7768 6974 6520 3d20 6e70        white = np
-000051b0: 2e73 6967 6e28 6461 7461 5329 0a20 2020  .sign(dataS).   
-000051c0: 2020 2020 2065 6c69 6620 7469 6d65 5f6e       elif time_n
-000051d0: 6f72 6d20 3d3d 2022 726d 6122 3a20 2023  orm == "rma":  #
-000051e0: 2072 756e 6e69 6e67 206d 6561 6e3a 206e   running mean: n
-000051f0: 6f72 6d61 6c69 7a61 7469 6f6e 206f 7665  ormalization ove
-00005200: 7220 736d 6f6f 7468 6564 2061 6273 6f6c  r smoothed absol
-00005210: 7574 6520 6176 6572 6167 650a 2020 2020  ute average.    
-00005220: 2020 2020 2020 2020 7768 6974 6520 3d20          white = 
-00005230: 6e70 2e7a 6572 6f73 2873 6861 7065 3d64  np.zeros(shape=d
-00005240: 6174 6153 2e73 6861 7065 2c20 6474 7970  ataS.shape, dtyp
-00005250: 653d 6461 7461 532e 6474 7970 6529 0a20  e=dataS.dtype). 
-00005260: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00005270: 6b6b 2069 6e20 7261 6e67 6528 4e29 3a0a  kk in range(N):.
-00005280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005290: 7768 6974 655b 6b6b 6b2c 203a 5d20 3d20  white[kkk, :] = 
-000052a0: 6461 7461 535b 6b6b 6b2c 203a 5d20 2f20  dataS[kkk, :] / 
-000052b0: 6d6f 7669 6e67 5f61 7665 286e 702e 6162  moving_ave(np.ab
-000052c0: 7328 6461 7461 535b 6b6b 6b2c 203a 5d29  s(dataS[kkk, :])
-000052d0: 2c20 736d 6f6f 7468 5f4e 290a 0a20 2020  , smooth_N)..   
-000052e0: 2065 6c73 653a 2020 2320 646f 6e27 7420   else:  # don't 
-000052f0: 6e6f 726d 616c 697a 650a 2020 2020 2020  normalize.      
-00005300: 2020 7768 6974 6520 3d20 6461 7461 530a    white = dataS.
-00005310: 0a20 2020 2023 202d 2d2d 2d2d 746f 2077  .    # -----to w
-00005320: 6869 7465 6e20 6f72 206e 6f74 2d2d 2d2d  hiten or not----
-00005330: 2d2d 0a20 2020 2069 6620 6672 6571 5f6e  --.    if freq_n
-00005340: 6f72 6d20 213d 2022 6e6f 223a 0a20 2020  orm != "no":.   
-00005350: 2020 2020 2073 6f75 7263 655f 7768 6974       source_whit
-00005360: 6520 3d20 7768 6974 656e 2877 6869 7465  e = whiten(white
-00005370: 2c20 6666 745f 7061 7261 2920 2023 2077  , fft_para)  # w
-00005380: 6869 7465 6e20 616e 6420 7265 7475 726e  hiten and return
-00005390: 2046 4654 0a20 2020 2065 6c73 653a 0a20   FFT.    else:. 
-000053a0: 2020 2020 2020 204e 6666 7420 3d20 696e         Nfft = in
-000053b0: 7428 6e65 7874 5f66 6173 745f 6c65 6e28  t(next_fast_len(
-000053c0: 696e 7428 6461 7461 532e 7368 6170 655b  int(dataS.shape[
-000053d0: 315d 2929 290a 2020 2020 2020 2020 736f  1]))).        so
-000053e0: 7572 6365 5f77 6869 7465 203d 2073 6369  urce_white = sci
-000053f0: 7079 2e66 6674 7061 636b 2e66 6674 2877  py.fftpack.fft(w
-00005400: 6869 7465 2c20 4e66 6674 2c20 6178 6973  hite, Nfft, axis
-00005410: 3d31 2920 2023 2072 6574 7572 6e20 4646  =1)  # return FF
-00005420: 540a 0a20 2020 2072 6574 7572 6e20 736f  T..    return so
-00005430: 7572 6365 5f77 6869 7465 0a0a 0a64 6566  urce_white...def
-00005440: 2073 6d6f 6f74 685f 736f 7572 6365 5f73   smooth_source_s
-00005450: 7065 6374 2863 635f 7061 7261 2c20 6666  pect(cc_para, ff
-00005460: 7431 293a 0a20 2020 2022 2222 0a20 2020  t1):.    """.   
-00005470: 2074 6869 7320 6675 6e63 7469 6f6e 2073   this function s
-00005480: 6d6f 6f74 6865 7320 616d 706c 6974 7564  moothes amplitud
-00005490: 6520 7370 6563 7472 756d 206f 6620 7468  e spectrum of th
-000054a0: 6520 3244 2073 7065 6374 7261 6c20 6d61  e 2D spectral ma
-000054b0: 7472 6978 2e20 2875 7365 6420 696e 2053  trix. (used in S
-000054c0: 3129 0a20 2020 2050 4152 414d 4554 4552  1).    PARAMETER
-000054d0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-000054e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-000054f0: 2063 635f 7061 7261 3a20 6469 6374 696f   cc_para: dictio
-00005500: 6e61 7279 2063 6f6e 7461 696e 696e 6720  nary containing 
-00005510: 7573 6566 756c 2063 6320 7061 7261 6d65  useful cc parame
-00005520: 7465 7273 0a20 2020 2066 6674 313a 2020  ters.    fft1:  
-00005530: 2020 736f 7572 6365 2073 7065 6374 7275    source spectru
-00005540: 6d20 6d61 7472 6978 0a0a 2020 2020 5245  m matrix..    RE
-00005550: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
-00005560: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00005570: 0a20 2020 2073 6666 7431 3a20 636f 6d70  .    sfft1: comp
-00005580: 6c65 7820 6e75 6d70 7920 6172 7261 7920  lex numpy array 
-00005590: 7769 7468 206e 6f72 6d61 6c69 7a65 6420  with normalized 
-000055a0: 7370 6563 7472 756d 0a20 2020 2022 2222  spectrum.    """
-000055b0: 0a20 2020 2063 635f 6d65 7468 6f64 203d  .    cc_method =
-000055c0: 2063 635f 7061 7261 5b22 6363 5f6d 6574   cc_para["cc_met
-000055d0: 686f 6422 5d0a 2020 2020 736d 6f6f 7468  hod"].    smooth
-000055e0: 7370 6563 745f 4e20 3d20 6363 5f70 6172  spect_N = cc_par
-000055f0: 615b 2273 6d6f 6f74 6873 7065 6374 5f4e  a["smoothspect_N
-00005600: 225d 0a0a 2020 2020 6966 2063 635f 6d65  "]..    if cc_me
-00005610: 7468 6f64 203d 3d20 2264 6563 6f6e 7622  thod == "deconv"
-00005620: 3a0a 2020 2020 2020 2020 2320 2d2d 2d2d  :.        # ----
-00005630: 2d6e 6f72 6d61 6c69 7a65 2073 696e 676c  -normalize singl
-00005640: 652d 7374 6174 696f 6e20 6363 2074 6f20  e-station cc to 
-00005650: 7a20 636f 6d70 6f6e 656e 742d 2d2d 2d2d  z component-----
-00005660: 0a20 2020 2020 2020 2074 656d 7020 3d20  .        temp = 
-00005670: 6d6f 7669 6e67 5f61 7665 286e 702e 6162  moving_ave(np.ab
-00005680: 7328 6666 7431 292c 2073 6d6f 6f74 6873  s(fft1), smooths
-00005690: 7065 6374 5f4e 290a 2020 2020 2020 2020  pect_N).        
-000056a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000056b0: 2073 6666 7431 203d 206e 702e 636f 6e6a   sfft1 = np.conj
-000056c0: 2866 6674 3129 202f 2074 656d 702a 2a32  (fft1) / temp**2
-000056d0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-000056e0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
-000056f0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00005700: 7565 4572 726f 7228 2273 6d6f 6f74 6865  ueError("smoothe
-00005710: 6420 7370 6563 7472 756d 2068 6173 207a  d spectrum has z
-00005720: 6572 6f20 7661 6c75 6573 2229 0a0a 2020  ero values")..  
-00005730: 2020 656c 6966 2063 635f 6d65 7468 6f64    elif cc_method
-00005740: 203d 3d20 2263 6f68 6572 656e 6379 223a   == "coherency":
-00005750: 0a20 2020 2020 2020 2074 656d 7020 3d20  .        temp = 
-00005760: 6d6f 7669 6e67 5f61 7665 286e 702e 6162  moving_ave(np.ab
-00005770: 7328 6666 7431 292c 2073 6d6f 6f74 6873  s(fft1), smooths
-00005780: 7065 6374 5f4e 290a 2020 2020 2020 2020  pect_N).        
-00005790: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000057a0: 2073 6666 7431 203d 206e 702e 636f 6e6a   sfft1 = np.conj
-000057b0: 2866 6674 3129 202f 2074 656d 700a 2020  (fft1) / temp.  
-000057c0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-000057d0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-000057e0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-000057f0: 7272 6f72 2822 736d 6f6f 7468 6564 2073  rror("smoothed s
-00005800: 7065 6374 7275 6d20 6861 7320 7a65 726f  pectrum has zero
-00005810: 2076 616c 7565 7322 290a 0a20 2020 2065   values")..    e
-00005820: 6c69 6620 6363 5f6d 6574 686f 6420 3d3d  lif cc_method ==
-00005830: 2022 7863 6f72 7222 3a0a 2020 2020 2020   "xcorr":.      
-00005840: 2020 7366 6674 3120 3d20 6e70 2e63 6f6e    sfft1 = np.con
-00005850: 6a28 6666 7431 290a 0a20 2020 2065 6c73  j(fft1)..    els
-00005860: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
-00005870: 2056 616c 7565 4572 726f 7228 226e 6f20   ValueError("no 
-00005880: 636f 7272 6563 7469 6f6e 2063 6f72 7265  correction corre
-00005890: 6c61 7469 6f6e 206d 6574 686f 6420 6973  lation method is
-000058a0: 2073 656c 6563 7465 6420 6174 204c 3539   selected at L59
-000058b0: 2229 0a0a 2020 2020 7265 7475 726e 2073  ")..    return s
-000058c0: 6666 7431 0a0a 0a64 6566 2063 6f72 7265  fft1...def corre
-000058d0: 6c61 7465 2866 6674 315f 736d 6f6f 7468  late(fft1_smooth
-000058e0: 6564 5f61 6273 2c20 6666 7432 2c20 442c  ed_abs, fft2, D,
-000058f0: 204e 6666 742c 2064 6174 6153 5f74 293a   Nfft, dataS_t):
-00005900: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-00005910: 7320 6675 6e63 7469 6f6e 2064 6f65 7320  s function does 
-00005920: 7468 6520 6372 6f73 732d 636f 7272 656c  the cross-correl
-00005930: 6174 696f 6e20 696e 2066 7265 7120 646f  ation in freq do
-00005940: 6d61 696e 2061 6e64 2068 6173 2074 6865  main and has the
-00005950: 206f 7074 696f 6e20 746f 206b 6565 7020   option to keep 
-00005960: 7375 622d 7374 6163 6b73 206f 660a 2020  sub-stacks of.  
-00005970: 2020 7468 6520 6372 6f73 732d 636f 7272    the cross-corr
-00005980: 656c 6174 696f 6e20 6966 206e 6565 6465  elation if neede
-00005990: 642e 2069 7420 7461 6b65 7320 6164 7661  d. it takes adva
-000059a0: 6e74 6167 6520 6f66 2074 6865 206c 696e  ntage of the lin
-000059b0: 6561 7220 7265 6c61 7469 6f6e 7368 6970  ear relationship
-000059c0: 206f 6620 6966 6674 2c20 736f 2074 6861   of ifft, so tha
-000059d0: 740a 2020 2020 7374 6163 6b69 6e67 2069  t.    stacking i
-000059e0: 7320 7065 7266 6f72 6d65 6420 696e 2073  s performed in s
-000059f0: 7065 6374 7275 6d20 646f 6d61 696e 2066  pectrum domain f
-00005a00: 6972 7374 2074 6f20 7265 6475 6365 2074  irst to reduce t
-00005a10: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-00005a20: 6f66 2069 6666 742e 2028 7573 6564 2069  of ifft. (used i
-00005a30: 6e20 5331 290a 2020 2020 5041 5241 4d45  n S1).    PARAME
-00005a40: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
-00005a50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-00005a60: 2020 2020 6666 7431 5f73 6d6f 6f74 6865      fft1_smoothe
-00005a70: 645f 6162 733a 2073 6d6f 6f74 6865 6420  d_abs: smoothed 
-00005a80: 706f 7765 7220 7370 6563 7472 616c 2064  power spectral d
-00005a90: 656e 7369 7479 206f 6620 7468 6520 4646  ensity of the FF
-00005aa0: 5420 666f 7220 7468 6520 736f 7572 6365  T for the source
-00005ab0: 2073 7461 7469 6f6e 0a20 2020 2066 6674   station.    fft
-00005ac0: 323a 2072 6177 2046 4654 2073 7065 6374  2: raw FFT spect
-00005ad0: 7275 6d20 6f66 2074 6865 2072 6563 6569  rum of the recei
-00005ae0: 7665 7220 7374 6174 696f 6e0a 2020 2020  ver station.    
-00005af0: 443a 2064 6963 7469 6f6e 6172 7920 636f  D: dictionary co
-00005b00: 6e74 6169 6e69 6e67 2066 6f6c 6c6f 7769  ntaining followi
-00005b10: 6e67 2070 6172 616d 6574 6572 733a 0a20  ng parameters:. 
-00005b20: 2020 2020 2020 206d 6178 6c61 673a 2020         maxlag:  
-00005b30: 6d61 7869 6d75 6d20 6c61 6773 2074 6f20  maximum lags to 
-00005b40: 6b65 6570 2069 6e20 7468 6520 6372 6f73  keep in the cros
-00005b50: 7320 636f 7272 656c 6174 696f 6e0a 2020  s correlation.  
-00005b60: 2020 2020 2020 6474 3a20 2020 2020 2073        dt:      s
-00005b70: 616d 706c 696e 6720 7261 7465 2028 696e  ampling rate (in
-00005b80: 2073 290a 2020 2020 2020 2020 6e77 696e   s).        nwin
-00005b90: 3a20 2020 206e 756d 6265 7220 6f66 2073  :    number of s
-00005ba0: 6567 6d65 6e74 7320 696e 2074 6865 2032  egments in the 2
-00005bb0: 4420 6d61 7472 6978 0a20 2020 2020 2020  D matrix.       
-00005bc0: 206d 6574 686f 643a 2020 6372 6f73 732d   method:  cross-
-00005bd0: 636f 7272 656c 6174 696f 6e20 6d65 7468  correlation meth
-00005be0: 6f64 7320 7365 6c65 6374 6564 2062 7920  ods selected by 
-00005bf0: 7468 6520 7573 6572 0a20 2020 2020 2020  the user.       
-00005c00: 2066 7265 716d 696e 3a20 6d69 6e69 6d75   freqmin: minimu
-00005c10: 6d20 6672 6571 7565 6e63 7920 2848 7a29  m frequency (Hz)
-00005c20: 0a20 2020 2020 2020 2066 7265 716d 6178  .        freqmax
-00005c30: 3a20 6d61 7869 6d75 6d20 6672 6571 7565  : maximum freque
-00005c40: 6e63 7920 2848 7a29 0a20 2020 204e 6666  ncy (Hz).    Nff
-00005c50: 743a 2020 2020 6e75 6d62 6572 206f 6620  t:    number of 
-00005c60: 6672 6571 7565 6e63 7920 706f 696e 7473  frequency points
-00005c70: 2066 6f72 2069 6666 740a 2020 2020 6461   for ifft.    da
-00005c80: 7461 535f 743a 206d 6174 7269 7820 6f66  taS_t: matrix of
-00005c90: 2064 6174 6574 696d 6520 6f62 6a65 6374   datetime object
-00005ca0: 2e0a 0a20 2020 2052 4554 5552 4e53 3a0a  ...    RETURNS:.
-00005cb0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00005cc0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 735f  ---------.    s_
-00005cd0: 636f 7272 3a20 3144 206f 7220 3244 206d  corr: 1D or 2D m
-00005ce0: 6174 7269 7820 6f66 2074 6865 2061 7665  atrix of the ave
-00005cf0: 7261 6765 6420 6f72 2073 7562 2d73 7461  raged or sub-sta
-00005d00: 636b 7320 6f66 2063 726f 7373 2d63 6f72  cks of cross-cor
-00005d10: 7265 6c61 7469 6f6e 2066 756e 6374 696f  relation functio
-00005d20: 6e73 2069 6e20 7469 6d65 2064 6f6d 6169  ns in time domai
-00005d30: 6e0a 2020 2020 745f 636f 7272 3a20 7469  n.    t_corr: ti
-00005d40: 6d65 7374 616d 7020 666f 7220 6561 6368  mestamp for each
-00005d50: 2073 7562 2d73 7461 636b 206f 7220 6176   sub-stack or av
-00005d60: 6572 6167 6564 2066 756e 6374 696f 6e0a  eraged function.
-00005d70: 2020 2020 6e5f 636f 7272 3a20 6e75 6d62      n_corr: numb
-00005d80: 6572 206f 6620 696e 636c 7564 6564 2073  er of included s
-00005d90: 6567 6d65 6e74 7320 666f 7220 6561 6368  egments for each
-00005da0: 2073 7562 2d73 7461 636b 206f 7220 6176   sub-stack or av
-00005db0: 6572 6167 6564 2066 756e 6374 696f 6e0a  eraged function.
-00005dc0: 0a20 2020 204d 4f44 4946 4943 4154 494f  .    MODIFICATIO
-00005dd0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
-00005de0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-00005df0: 2020 6f75 7470 7574 2074 6865 206c 696e    output the lin
-00005e00: 6561 7220 7374 6163 6b20 6f66 2065 6163  ear stack of eac
-00005e10: 6820 7469 6d65 2063 6875 6e6b 2065 7665  h time chunk eve
-00005e20: 6e20 7768 656e 2073 7562 7374 6163 6b20  n when substack 
-00005e30: 6973 2073 656c 6563 7465 6420 2862 7920  is selected (by 
-00005e40: 4368 656e 6778 696e 2040 4175 6732 3032  Chengxin @Aug202
-00005e50: 3029 0a20 2020 2022 2222 0a20 2020 2023  0).    """.    #
-00005e60: 202d 2d2d 2d6c 6f61 6420 7061 7261 6d74   ----load paramt
-00005e70: 6572 732d 2d2d 2d0a 2020 2020 6474 203d  ers----.    dt =
-00005e80: 2044 5b22 6474 225d 0a20 2020 206d 6178   D["dt"].    max
-00005e90: 6c61 6720 3d20 445b 226d 6178 6c61 6722  lag = D["maxlag"
-00005ea0: 5d0a 2020 2020 6d65 7468 6f64 203d 2044  ].    method = D
-00005eb0: 5b22 6363 5f6d 6574 686f 6422 5d0a 2020  ["cc_method"].  
-00005ec0: 2020 6363 5f6c 656e 203d 2044 5b22 6363    cc_len = D["cc
-00005ed0: 5f6c 656e 225d 0a20 2020 2073 7562 7374  _len"].    subst
-00005ee0: 6163 6b20 3d20 445b 2273 7562 7374 6163  ack = D["substac
-00005ef0: 6b22 5d0a 2020 2020 7375 6273 7461 636b  k"].    substack
-00005f00: 5f6c 656e 203d 2044 5b22 7375 6273 7461  _len = D["substa
-00005f10: 636b 5f6c 656e 225d 0a20 2020 2073 6d6f  ck_len"].    smo
-00005f20: 6f74 6873 7065 6374 5f4e 203d 2044 5b22  othspect_N = D["
-00005f30: 736d 6f6f 7468 7370 6563 745f 4e22 5d0a  smoothspect_N"].
-00005f40: 0a20 2020 206e 7769 6e20 3d20 6666 7431  .    nwin = fft1
-00005f50: 5f73 6d6f 6f74 6865 645f 6162 732e 7368  _smoothed_abs.sh
-00005f60: 6170 655b 305d 0a20 2020 204e 6666 7432  ape[0].    Nfft2
-00005f70: 203d 2066 6674 315f 736d 6f6f 7468 6564   = fft1_smoothed
-00005f80: 5f61 6273 2e73 6861 7065 5b31 5d0a 0a20  _abs.shape[1].. 
-00005f90: 2020 2023 202d 2d2d 2d2d 2d63 6f6e 7665     # ------conve
-00005fa0: 7274 2061 6c6c 2032 4420 6172 7261 7973  rt all 2D arrays
-00005fb0: 2069 6e74 6f20 3144 2074 6f20 7370 6565   into 1D to spee
-00005fc0: 6420 7570 2d2d 2d2d 2d2d 2d2d 0a20 2020  d up--------.   
-00005fd0: 2063 6f72 7220 3d20 6e70 2e7a 6572 6f73   corr = np.zeros
-00005fe0: 286e 7769 6e20 2a20 4e66 6674 322c 2064  (nwin * Nfft2, d
-00005ff0: 7479 7065 3d6e 702e 636f 6d70 6c65 7836  type=np.complex6
-00006000: 3429 0a20 2020 2063 6f72 7220 3d20 6666  4).    corr = ff
-00006010: 7431 5f73 6d6f 6f74 6865 645f 6162 732e  t1_smoothed_abs.
-00006020: 7265 7368 6170 6528 0a20 2020 2020 2020  reshape(.       
-00006030: 2066 6674 315f 736d 6f6f 7468 6564 5f61   fft1_smoothed_a
-00006040: 6273 2e73 697a 652c 0a20 2020 2029 202a  bs.size,.    ) *
-00006050: 2066 6674 322e 7265 7368 6170 6528 0a20   fft2.reshape(. 
-00006060: 2020 2020 2020 2066 6674 322e 7369 7a65         fft2.size
-00006070: 2c0a 2020 2020 290a 0a20 2020 2069 6620  ,.    )..    if 
-00006080: 6d65 7468 6f64 203d 3d20 2263 6f68 6572  method == "coher
-00006090: 656e 6379 223a 0a20 2020 2020 2020 2074  ency":.        t
-000060a0: 656d 7020 3d20 6d6f 7669 6e67 5f61 7665  emp = moving_ave
-000060b0: 280a 2020 2020 2020 2020 2020 2020 6e70  (.            np
-000060c0: 2e61 6273 280a 2020 2020 2020 2020 2020  .abs(.          
-000060d0: 2020 2020 2020 6666 7432 2e72 6573 6861        fft2.resha
-000060e0: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
-000060f0: 2020 2020 2020 2020 6666 7432 2e73 697a          fft2.siz
-00006100: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00006110: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00006120: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00006130: 736d 6f6f 7468 7370 6563 745f 4e2c 0a20  smoothspect_N,. 
-00006140: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00006150: 2063 6f72 7220 2f3d 2074 656d 700a 2020   corr /= temp.  
-00006160: 2020 636f 7272 203d 2063 6f72 722e 7265    corr = corr.re
-00006170: 7368 6170 6528 6e77 696e 2c20 4e66 6674  shape(nwin, Nfft
-00006180: 3229 0a0a 2020 2020 6966 2073 7562 7374  2)..    if subst
-00006190: 6163 6b3a 0a20 2020 2020 2020 2069 6620  ack:.        if 
-000061a0: 7375 6273 7461 636b 5f6c 656e 203d 3d20  substack_len == 
-000061b0: 6363 5f6c 656e 3a0a 2020 2020 2020 2020  cc_len:.        
-000061c0: 2020 2020 2320 6368 6f6f 7365 2074 6f20      # choose to 
-000061d0: 6b65 6570 2061 6c6c 2066 6674 2064 6174  keep all fft dat
-000061e0: 6120 666f 7220 6120 6461 790a 2020 2020  a for a day.    
-000061f0: 2020 2020 2020 2020 735f 636f 7272 203d          s_corr =
-00006200: 206e 702e 7a65 726f 7328 7368 6170 653d   np.zeros(shape=
-00006210: 286e 7769 6e2c 204e 6666 7429 2c20 6474  (nwin, Nfft), dt
-00006220: 7970 653d 6e70 2e66 6c6f 6174 3332 2920  ype=np.float32) 
-00006230: 2023 2073 7461 636b 6564 2063 6f72 7265   # stacked corre
-00006240: 6c61 7469 6f6e 0a20 2020 2020 2020 2020  lation.         
-00006250: 2020 2061 6d70 6d61 7820 3d20 6e70 2e7a     ampmax = np.z
-00006260: 6572 6f73 286e 7769 6e2c 2064 7479 7065  eros(nwin, dtype
-00006270: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
-00006280: 2020 2020 2020 2020 206e 5f63 6f72 7220           n_corr 
-00006290: 3d20 6e70 2e7a 6572 6f73 286e 7769 6e2c  = np.zeros(nwin,
-000062a0: 2064 7479 7065 3d6e 702e 696e 7431 3629   dtype=np.int16)
-000062b0: 2020 2320 6e75 6d62 6572 206f 6620 636f    # number of co
-000062c0: 7272 656c 6174 696f 6e73 2066 6f72 2065  rrelations for e
-000062d0: 6163 6820 7375 6273 7461 636b 0a20 2020  ach substack.   
-000062e0: 2020 2020 2020 2020 2074 5f63 6f72 7220           t_corr 
-000062f0: 3d20 6461 7461 535f 7420 2023 2074 696d  = dataS_t  # tim
-00006300: 6573 7461 6d70 0a20 2020 2020 2020 2020  estamp.         
-00006310: 2020 2063 7261 7020 3d20 6e70 2e7a 6572     crap = np.zer
-00006320: 6f73 284e 6666 742c 2064 7479 7065 3d6e  os(Nfft, dtype=n
-00006330: 702e 636f 6d70 6c65 7836 3429 0a20 2020  p.complex64).   
-00006340: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
-00006350: 6e20 7261 6e67 6528 6e77 696e 293a 0a20  n range(nwin):. 
-00006360: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00006370: 5f63 6f72 725b 695d 203d 2031 0a20 2020  _corr[i] = 1.   
-00006380: 2020 2020 2020 2020 2020 2020 2063 7261               cra
-00006390: 705b 3a4e 6666 7432 5d20 3d20 636f 7272  p[:Nfft2] = corr
-000063a0: 5b69 2c20 3a5d 0a20 2020 2020 2020 2020  [i, :].         
-000063b0: 2020 2020 2020 2063 7261 705b 3a4e 6666         crap[:Nff
-000063c0: 7432 5d20 3d20 6372 6170 5b3a 4e66 6674  t2] = crap[:Nfft
-000063d0: 325d 202d 206e 702e 6d65 616e 2863 7261  2] - np.mean(cra
-000063e0: 705b 3a4e 6666 7432 5d29 2020 2320 7265  p[:Nfft2])  # re
-000063f0: 6d6f 7665 2074 6865 206d 6561 6e20 696e  move the mean in
-00006400: 2066 7265 7120 646f 6d61 696e 2028 7370   freq domain (sp
-00006410: 696b 6520 6174 2074 3d30 290a 2020 2020  ike at t=0).    
-00006420: 2020 2020 2020 2020 2020 2020 6372 6170              crap
-00006430: 5b2d 284e 6666 7432 2920 2b20 3120 3a5d  [-(Nfft2) + 1 :]
-00006440: 203d 206e 702e 666c 6970 286e 702e 636f   = np.flip(np.co
-00006450: 6e6a 2863 7261 705b 313a 284e 6666 7432  nj(crap[1:(Nfft2
-00006460: 295d 292c 2061 7869 733d 3029 0a20 2020  )]), axis=0).   
-00006470: 2020 2020 2020 2020 2020 2020 2063 7261               cra
-00006480: 705b 305d 203d 2063 6f6d 706c 6578 2830  p[0] = complex(0
-00006490: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
-000064a0: 2020 2020 2073 5f63 6f72 725b 692c 203a       s_corr[i, :
-000064b0: 5d20 3d20 6e70 2e72 6561 6c28 6e70 2e66  ] = np.real(np.f
-000064c0: 6674 2e69 6666 7473 6869 6674 2873 6369  ft.ifftshift(sci
-000064d0: 7079 2e66 6674 7061 636b 2e69 6666 7428  py.fftpack.ifft(
-000064e0: 6372 6170 2c20 4e66 6674 2c20 6178 6973  crap, Nfft, axis
-000064f0: 3d30 2929 290a 0a20 2020 2020 2020 2020  =0)))..         
-00006500: 2020 2023 2072 656d 6f76 6520 6162 6e6f     # remove abno
-00006510: 726d 616c 2064 6174 610a 2020 2020 2020  rmal data.      
-00006520: 2020 2020 2020 616d 706d 6178 203d 206e        ampmax = n
-00006530: 702e 6d61 7828 735f 636f 7272 2c20 6178  p.max(s_corr, ax
-00006540: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
-00006550: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
-00006560: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
-00006570: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
-00006580: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
-00006590: 2030 2929 5b30 5d0a 2020 2020 2020 2020   0))[0].        
-000065a0: 2020 2020 735f 636f 7272 203d 2073 5f63      s_corr = s_c
-000065b0: 6f72 725b 7469 6e64 782c 203a 5d0a 2020  orr[tindx, :].  
-000065c0: 2020 2020 2020 2020 2020 745f 636f 7272            t_corr
-000065d0: 203d 2074 5f63 6f72 725b 7469 6e64 785d   = t_corr[tindx]
-000065e0: 0a20 2020 2020 2020 2020 2020 206e 5f63  .            n_c
-000065f0: 6f72 7220 3d20 6e5f 636f 7272 5b74 696e  orr = n_corr[tin
-00006600: 6478 5d0a 0a20 2020 2020 2020 2065 6c73  dx]..        els
-00006610: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00006620: 2067 6574 2074 696d 6520 696e 666f 726d   get time inform
-00006630: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
-00006640: 2020 5474 6f74 616c 203d 2064 6174 6153    Ttotal = dataS
-00006650: 5f74 5b2d 315d 202d 2064 6174 6153 5f74  _t[-1] - dataS_t
-00006660: 5b30 5d20 2023 2074 6f74 616c 2064 7572  [0]  # total dur
-00006670: 6174 696f 6e20 6f66 2077 6861 7420 7765  ation of what we
-00006680: 2068 6176 6520 6e6f 770a 2020 2020 2020   have now.      
-00006690: 2020 2020 2020 7473 7461 7274 203d 2064        tstart = d
-000066a0: 6174 6153 5f74 5b30 5d0a 0a20 2020 2020  ataS_t[0]..     
-000066b0: 2020 2020 2020 206e 7374 6163 6b20 3d20         nstack = 
-000066c0: 696e 7428 6e70 2e72 6f75 6e64 2854 746f  int(np.round(Tto
-000066d0: 7461 6c20 2f20 7375 6273 7461 636b 5f6c  tal / substack_l
-000066e0: 656e 2929 0a20 2020 2020 2020 2020 2020  en)).           
-000066f0: 2061 6d70 6d61 7820 3d20 6e70 2e7a 6572   ampmax = np.zer
-00006700: 6f73 286e 7374 6163 6b2c 2064 7479 7065  os(nstack, dtype
-00006710: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
-00006720: 2020 2020 2020 2020 2073 5f63 6f72 7220           s_corr 
-00006730: 3d20 6e70 2e7a 6572 6f73 2873 6861 7065  = np.zeros(shape
-00006740: 3d28 6e73 7461 636b 2c20 4e66 6674 292c  =(nstack, Nfft),
-00006750: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
-00006760: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
-00006770: 5f63 6f72 7220 3d20 6e70 2e7a 6572 6f73  _corr = np.zeros
-00006780: 286e 7374 6163 6b2c 2064 7479 7065 3d6e  (nstack, dtype=n
-00006790: 702e 696e 7431 3629 0a20 2020 2020 2020  p.int16).       
-000067a0: 2020 2020 2074 5f63 6f72 7220 3d20 6e70       t_corr = np
-000067b0: 2e7a 6572 6f73 286e 7374 6163 6b2c 2064  .zeros(nstack, d
-000067c0: 7479 7065 3d6e 702e 666c 6f61 7433 3229  type=np.float32)
-000067d0: 0a20 2020 2020 2020 2020 2020 2063 7261  .            cra
-000067e0: 7020 3d20 6e70 2e7a 6572 6f73 284e 6666  p = np.zeros(Nff
-000067f0: 742c 2064 7479 7065 3d6e 702e 636f 6d70  t, dtype=np.comp
-00006800: 6c65 7836 3429 0a0a 2020 2020 2020 2020  lex64)..        
-00006810: 2020 2020 666f 7220 6973 7461 636b 2069      for istack i
-00006820: 6e20 7261 6e67 6528 6e73 7461 636b 293a  n range(nstack):
-00006830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006840: 2023 2066 696e 6420 7468 6520 696e 6465   # find the inde
-00006850: 7865 7320 6f66 2061 6c6c 206f 6620 7468  xes of all of th
-00006860: 6520 7769 6e64 6f77 7320 7468 6174 2073  e windows that s
-00006870: 7461 7274 206f 7220 656e 6420 7769 7468  tart or end with
-00006880: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
-00006890: 2020 2069 7469 6d65 203d 206e 702e 7768     itime = np.wh
-000068a0: 6572 6528 2864 6174 6153 5f74 203e 3d20  ere((dataS_t >= 
-000068b0: 7473 7461 7274 2920 2620 2864 6174 6153  tstart) & (dataS
-000068c0: 5f74 203c 2074 7374 6172 7420 2b20 7375  _t < tstart + su
-000068d0: 6273 7461 636b 5f6c 656e 2929 5b30 5d0a  bstack_len))[0].
-000068e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068f0: 6966 206c 656e 2869 7469 6d65 2920 3d3d  if len(itime) ==
-00006900: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00006910: 2020 2020 2020 2020 7473 7461 7274 202b          tstart +
-00006920: 3d20 7375 6273 7461 636b 5f6c 656e 0a20  = substack_len. 
-00006930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006940: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-00006950: 2020 2020 2020 2020 2020 2020 2063 7261               cra
-00006960: 705b 3a4e 6666 7432 5d20 3d20 6e70 2e6d  p[:Nfft2] = np.m
-00006970: 6561 6e28 636f 7272 5b69 7469 6d65 2c20  ean(corr[itime, 
-00006980: 3a5d 2c20 6178 6973 3d30 2920 2023 206c  :], axis=0)  # l
-00006990: 696e 6561 7220 6176 6572 6167 6520 6f66  inear average of
-000069a0: 2074 6865 2063 6f72 7265 6c61 7469 6f6e   the correlation
-000069b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000069c0: 2063 7261 705b 3a4e 6666 7432 5d20 3d20   crap[:Nfft2] = 
-000069d0: 6372 6170 5b3a 4e66 6674 325d 202d 206e  crap[:Nfft2] - n
-000069e0: 702e 6d65 616e 2863 7261 705b 3a4e 6666  p.mean(crap[:Nff
-000069f0: 7432 5d29 2020 2320 7265 6d6f 7665 2074  t2])  # remove t
-00006a00: 6865 206d 6561 6e20 696e 2066 7265 7120  he mean in freq 
-00006a10: 646f 6d61 696e 2028 7370 696b 6520 6174  domain (spike at
-00006a20: 2074 3d30 290a 2020 2020 2020 2020 2020   t=0).          
-00006a30: 2020 2020 2020 6372 6170 5b2d 284e 6666        crap[-(Nff
-00006a40: 7432 2920 2b20 3120 3a5d 203d 206e 702e  t2) + 1 :] = np.
-00006a50: 666c 6970 286e 702e 636f 6e6a 2863 7261  flip(np.conj(cra
-00006a60: 705b 313a 284e 6666 7432 295d 292c 2061  p[1:(Nfft2)]), a
-00006a70: 7869 733d 3029 0a20 2020 2020 2020 2020  xis=0).         
-00006a80: 2020 2020 2020 2063 7261 705b 305d 203d         crap[0] =
-00006a90: 2063 6f6d 706c 6578 2830 2c20 3029 0a20   complex(0, 0). 
-00006aa0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00006ab0: 5f63 6f72 725b 6973 7461 636b 2c20 3a5d  _corr[istack, :]
-00006ac0: 203d 206e 702e 7265 616c 286e 702e 6666   = np.real(np.ff
-00006ad0: 742e 6966 6674 7368 6966 7428 7363 6970  t.ifftshift(scip
-00006ae0: 792e 6666 7470 6163 6b2e 6966 6674 2863  y.fftpack.ifft(c
-00006af0: 7261 702c 204e 6666 742c 2061 7869 733d  rap, Nfft, axis=
-00006b00: 3029 2929 0a20 2020 2020 2020 2020 2020  0))).           
-00006b10: 2020 2020 206e 5f63 6f72 725b 6973 7461       n_corr[ista
-00006b20: 636b 5d20 3d20 6c65 6e28 6974 696d 6529  ck] = len(itime)
-00006b30: 2020 2320 6e75 6d62 6572 206f 6620 7769    # number of wi
-00006b40: 6e64 6f77 7320 7374 6163 6b73 0a20 2020  ndows stacks.   
-00006b50: 2020 2020 2020 2020 2020 2020 2074 5f63               t_c
-00006b60: 6f72 725b 6973 7461 636b 5d20 3d20 7473  orr[istack] = ts
-00006b70: 7461 7274 2020 2320 7361 7665 2074 6865  tart  # save the
-00006b80: 2074 696d 6520 7374 616d 7073 0a20 2020   time stamps.   
-00006b90: 2020 2020 2020 2020 2020 2020 2074 7374               tst
-00006ba0: 6172 7420 2b3d 2073 7562 7374 6163 6b5f  art += substack_
-00006bb0: 6c65 6e0a 2020 2020 2020 2020 2020 2020  len.            
-00006bc0: 2020 2020 2320 7072 696e 7428 2763 6f72      # print('cor
-00006bd0: 7265 6c61 7469 6f6e 2064 6f6e 6520 616e  relation done an
-00006be0: 6420 7374 6163 6b65 6420 6174 2074 696d  d stacked at tim
-00006bf0: 6520 2573 2720 2520 7374 7228 745f 636f  e %s' % str(t_co
-00006c00: 7272 5b69 7374 6163 6b5d 2929 0a0a 2020  rr[istack]))..  
-00006c10: 2020 2020 2020 2020 2020 2320 7265 6d6f            # remo
-00006c20: 7665 2061 626e 6f72 6d61 6c20 6461 7461  ve abnormal data
-00006c30: 0a20 2020 2020 2020 2020 2020 2061 6d70  .            amp
-00006c40: 6d61 7820 3d20 6e70 2e6d 6178 2873 5f63  max = np.max(s_c
-00006c50: 6f72 722c 2061 7869 733d 3129 0a20 2020  orr, axis=1).   
-00006c60: 2020 2020 2020 2020 2074 696e 6478 203d           tindx =
-00006c70: 206e 702e 7768 6572 6528 2861 6d70 6d61   np.where((ampma
-00006c80: 7820 3c20 3230 202a 206e 702e 6d65 6469  x < 20 * np.medi
-00006c90: 616e 2861 6d70 6d61 7829 2920 2620 2861  an(ampmax)) & (a
-00006ca0: 6d70 6d61 7820 3e20 3029 295b 305d 0a20  mpmax > 0))[0]. 
-00006cb0: 2020 2020 2020 2020 2020 2073 5f63 6f72             s_cor
-00006cc0: 7220 3d20 735f 636f 7272 5b74 696e 6478  r = s_corr[tindx
-00006cd0: 2c20 3a5d 0a20 2020 2020 2020 2020 2020  , :].           
-00006ce0: 2074 5f63 6f72 7220 3d20 745f 636f 7272   t_corr = t_corr
-00006cf0: 5b74 696e 6478 5d0a 2020 2020 2020 2020  [tindx].        
-00006d00: 2020 2020 6e5f 636f 7272 203d 206e 5f63      n_corr = n_c
-00006d10: 6f72 725b 7469 6e64 785d 0a0a 2020 2020  orr[tindx]..    
-00006d20: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00006d30: 6176 6572 6167 6520 6461 696c 7920 6372  average daily cr
-00006d40: 6f73 7320 636f 7272 656c 6174 696f 6e20  oss correlation 
-00006d50: 6675 6e63 7469 6f6e 730a 2020 2020 2020  functions.      
-00006d60: 2020 616d 706d 6178 203d 206e 702e 6d61    ampmax = np.ma
-00006d70: 7828 636f 7272 2c20 6178 6973 3d31 290a  x(corr, axis=1).
-00006d80: 2020 2020 2020 2020 7469 6e64 7820 3d20          tindx = 
-00006d90: 6e70 2e77 6865 7265 2828 616d 706d 6178  np.where((ampmax
-00006da0: 203c 2032 3020 2a20 6e70 2e6d 6564 6961   < 20 * np.media
-00006db0: 6e28 616d 706d 6178 2929 2026 2028 616d  n(ampmax)) & (am
-00006dc0: 706d 6178 203e 2030 2929 5b30 5d0a 2020  pmax > 0))[0].  
-00006dd0: 2020 2020 2020 6e5f 636f 7272 203d 206e        n_corr = n
-00006de0: 7769 6e0a 2020 2020 2020 2020 735f 636f  win.        s_co
-00006df0: 7272 203d 206e 702e 7a65 726f 7328 4e66  rr = np.zeros(Nf
-00006e00: 6674 2c20 6474 7970 653d 6e70 2e66 6c6f  ft, dtype=np.flo
-00006e10: 6174 3332 290a 2020 2020 2020 2020 745f  at32).        t_
-00006e20: 636f 7272 203d 2064 6174 6153 5f74 5b30  corr = dataS_t[0
-00006e30: 5d0a 2020 2020 2020 2020 6372 6170 203d  ].        crap =
-00006e40: 206e 702e 7a65 726f 7328 4e66 6674 2c20   np.zeros(Nfft, 
-00006e50: 6474 7970 653d 6e70 2e63 6f6d 706c 6578  dtype=np.complex
-00006e60: 3634 290a 2020 2020 2020 2020 6372 6170  64).        crap
-00006e70: 5b3a 4e66 6674 325d 203d 206e 702e 6d65  [:Nfft2] = np.me
-00006e80: 616e 2863 6f72 725b 7469 6e64 785d 2c20  an(corr[tindx], 
-00006e90: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00006ea0: 6372 6170 5b3a 4e66 6674 325d 203d 2063  crap[:Nfft2] = c
-00006eb0: 7261 705b 3a4e 6666 7432 5d20 2d20 6e70  rap[:Nfft2] - np
-00006ec0: 2e6d 6561 6e28 6372 6170 5b3a 4e66 6674  .mean(crap[:Nfft
-00006ed0: 325d 2c20 6178 6973 3d30 290a 2020 2020  2], axis=0).    
-00006ee0: 2020 2020 6372 6170 5b2d 284e 6666 7432      crap[-(Nfft2
-00006ef0: 2920 2b20 3120 3a5d 203d 206e 702e 666c  ) + 1 :] = np.fl
-00006f00: 6970 286e 702e 636f 6e6a 2863 7261 705b  ip(np.conj(crap[
-00006f10: 313a 284e 6666 7432 295d 292c 2061 7869  1:(Nfft2)]), axi
-00006f20: 733d 3029 0a20 2020 2020 2020 2073 5f63  s=0).        s_c
-00006f30: 6f72 7220 3d20 6e70 2e72 6561 6c28 6e70  orr = np.real(np
-00006f40: 2e66 6674 2e69 6666 7473 6869 6674 2873  .fft.ifftshift(s
-00006f50: 6369 7079 2e66 6674 7061 636b 2e69 6666  cipy.fftpack.iff
-00006f60: 7428 6372 6170 2c20 4e66 6674 2c20 6178  t(crap, Nfft, ax
-00006f70: 6973 3d30 2929 290a 0a20 2020 2023 2074  is=0)))..    # t
-00006f80: 7269 6d20 7468 6520 4343 4673 2069 6e20  rim the CCFs in 
-00006f90: 5b2d 6d61 786c 6167 206d 6178 6c61 675d  [-maxlag maxlag]
-00006fa0: 0a20 2020 2074 203d 206e 702e 6172 616e  .    t = np.aran
-00006fb0: 6765 282d 4e66 6674 3220 2b20 312c 204e  ge(-Nfft2 + 1, N
-00006fc0: 6666 7432 2920 2a20 6474 0a20 2020 2069  fft2) * dt.    i
-00006fd0: 6e64 203d 206e 702e 7768 6572 6528 6e70  nd = np.where(np
-00006fe0: 2e61 6273 2874 2920 3c3d 206d 6178 6c61  .abs(t) <= maxla
-00006ff0: 6729 5b30 5d0a 2020 2020 6966 2073 5f63  g)[0].    if s_c
-00007000: 6f72 722e 6e64 696d 203d 3d20 313a 0a20  orr.ndim == 1:. 
-00007010: 2020 2020 2020 2073 5f63 6f72 7220 3d20         s_corr = 
-00007020: 735f 636f 7272 5b69 6e64 5d0a 2020 2020  s_corr[ind].    
-00007030: 656c 6966 2073 5f63 6f72 722e 6e64 696d  elif s_corr.ndim
-00007040: 203d 3d20 323a 0a20 2020 2020 2020 2073   == 2:.        s
-00007050: 5f63 6f72 7220 3d20 735f 636f 7272 5b3a  _corr = s_corr[:
-00007060: 2c20 696e 645d 0a20 2020 2072 6574 7572  , ind].    retur
-00007070: 6e20 735f 636f 7272 2c20 745f 636f 7272  n s_corr, t_corr
-00007080: 2c20 6e5f 636f 7272 0a0a 0a64 6566 2063  , n_corr...def c
-00007090: 6f72 7265 6c61 7465 5f6e 6f6e 6c69 6e65  orrelate_nonline
-000070a0: 6172 5f73 7461 636b 2866 6674 315f 736d  ar_stack(fft1_sm
-000070b0: 6f6f 7468 6564 5f61 6273 2c20 6666 7432  oothed_abs, fft2
-000070c0: 2c20 442c 204e 6666 742c 2064 6174 6153  , D, Nfft, dataS
-000070d0: 5f74 293a 0a20 2020 2022 2222 0a20 2020  _t):.    """.   
-000070e0: 2074 6869 7320 6675 6e63 7469 6f6e 2064   this function d
-000070f0: 6f65 7320 7468 6520 6372 6f73 732d 636f  oes the cross-co
-00007100: 7272 656c 6174 696f 6e20 696e 2066 7265  rrelation in fre
-00007110: 7120 646f 6d61 696e 2061 6e64 2068 6173  q domain and has
-00007120: 2074 6865 206f 7074 696f 6e20 746f 206b   the option to k
-00007130: 6565 7020 7375 622d 7374 6163 6b73 206f  eep sub-stacks o
-00007140: 660a 2020 2020 7468 6520 6372 6f73 732d  f.    the cross-
-00007150: 636f 7272 656c 6174 696f 6e20 6966 206e  correlation if n
-00007160: 6565 6465 642e 2069 7420 7461 6b65 7320  eeded. it takes 
-00007170: 6164 7661 6e74 6167 6520 6f66 2074 6865  advantage of the
-00007180: 206c 696e 6561 7220 7265 6c61 7469 6f6e   linear relation
-00007190: 7368 6970 206f 6620 6966 6674 2c20 736f  ship of ifft, so
-000071a0: 2074 6861 740a 2020 2020 7374 6163 6b69   that.    stacki
-000071b0: 6e67 2069 7320 7065 7266 6f72 6d65 6420  ng is performed 
-000071c0: 696e 2073 7065 6374 7275 6d20 646f 6d61  in spectrum doma
-000071d0: 696e 2066 6972 7374 2074 6f20 7265 6475  in first to redu
-000071e0: 6365 2074 6865 2074 6f74 616c 206e 756d  ce the total num
-000071f0: 6265 7220 6f66 2069 6666 742e 2028 7573  ber of ifft. (us
-00007200: 6564 2069 6e20 5331 290a 2020 2020 5041  ed in S1).    PA
-00007210: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
-00007220: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00007230: 2d2d 2d0a 2020 2020 6666 7431 5f73 6d6f  ---.    fft1_smo
-00007240: 6f74 6865 645f 6162 733a 2073 6d6f 6f74  othed_abs: smoot
-00007250: 6865 6420 706f 7765 7220 7370 6563 7472  hed power spectr
-00007260: 616c 2064 656e 7369 7479 206f 6620 7468  al density of th
-00007270: 6520 4646 5420 666f 7220 7468 6520 736f  e FFT for the so
-00007280: 7572 6365 2073 7461 7469 6f6e 0a20 2020  urce station.   
-00007290: 2066 6674 323a 2072 6177 2046 4654 2073   fft2: raw FFT s
-000072a0: 7065 6374 7275 6d20 6f66 2074 6865 2072  pectrum of the r
-000072b0: 6563 6569 7665 7220 7374 6174 696f 6e0a  eceiver station.
-000072c0: 2020 2020 443a 2064 6963 7469 6f6e 6172      D: dictionar
-000072d0: 7920 636f 6e74 6169 6e69 6e67 2066 6f6c  y containing fol
-000072e0: 6c6f 7769 6e67 2070 6172 616d 6574 6572  lowing parameter
-000072f0: 733a 0a20 2020 2020 2020 206d 6178 6c61  s:.        maxla
-00007300: 673a 2020 6d61 7869 6d75 6d20 6c61 6773  g:  maximum lags
-00007310: 2074 6f20 6b65 6570 2069 6e20 7468 6520   to keep in the 
-00007320: 6372 6f73 7320 636f 7272 656c 6174 696f  cross correlatio
-00007330: 6e0a 2020 2020 2020 2020 6474 3a20 2020  n.        dt:   
-00007340: 2020 2073 616d 706c 696e 6720 7261 7465     sampling rate
-00007350: 2028 696e 2073 290a 2020 2020 2020 2020   (in s).        
-00007360: 6e77 696e 3a20 2020 206e 756d 6265 7220  nwin:    number 
-00007370: 6f66 2073 6567 6d65 6e74 7320 696e 2074  of segments in t
-00007380: 6865 2032 4420 6d61 7472 6978 0a20 2020  he 2D matrix.   
-00007390: 2020 2020 206d 6574 686f 643a 2020 6372       method:  cr
-000073a0: 6f73 732d 636f 7272 656c 6174 696f 6e20  oss-correlation 
-000073b0: 6d65 7468 6f64 7320 7365 6c65 6374 6564  methods selected
-000073c0: 2062 7920 7468 6520 7573 6572 0a20 2020   by the user.   
-000073d0: 2020 2020 2066 7265 716d 696e 3a20 6d69       freqmin: mi
-000073e0: 6e69 6d75 6d20 6672 6571 7565 6e63 7920  nimum frequency 
-000073f0: 2848 7a29 0a20 2020 2020 2020 2066 7265  (Hz).        fre
-00007400: 716d 6178 3a20 6d61 7869 6d75 6d20 6672  qmax: maximum fr
-00007410: 6571 7565 6e63 7920 2848 7a29 0a20 2020  equency (Hz).   
-00007420: 204e 6666 743a 2020 2020 6e75 6d62 6572   Nfft:    number
-00007430: 206f 6620 6672 6571 7565 6e63 7920 706f   of frequency po
-00007440: 696e 7473 2066 6f72 2069 6666 740a 2020  ints for ifft.  
-00007450: 2020 6461 7461 535f 743a 206d 6174 7269    dataS_t: matri
-00007460: 7820 6f66 2064 6174 6574 696d 6520 6f62  x of datetime ob
-00007470: 6a65 6374 2e0a 2020 2020 5245 5455 524e  ject..    RETURN
-00007480: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-00007490: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-000074a0: 2073 5f63 6f72 723a 2031 4420 6f72 2032   s_corr: 1D or 2
-000074b0: 4420 6d61 7472 6978 206f 6620 7468 6520  D matrix of the 
-000074c0: 6176 6572 6167 6564 206f 7220 7375 622d  averaged or sub-
-000074d0: 7374 6163 6b73 206f 6620 6372 6f73 732d  stacks of cross-
-000074e0: 636f 7272 656c 6174 696f 6e20 6675 6e63  correlation func
-000074f0: 7469 6f6e 7320 696e 2074 696d 6520 646f  tions in time do
-00007500: 6d61 696e 0a20 2020 2074 5f63 6f72 723a  main.    t_corr:
-00007510: 2074 696d 6573 7461 6d70 2066 6f72 2065   timestamp for e
-00007520: 6163 6820 7375 622d 7374 6163 6b20 6f72  ach sub-stack or
-00007530: 2061 7665 7261 6765 6420 6675 6e63 7469   averaged functi
-00007540: 6f6e 0a20 2020 206e 5f63 6f72 723a 206e  on.    n_corr: n
-00007550: 756d 6265 7220 6f66 2069 6e63 6c75 6465  umber of include
-00007560: 6420 7365 676d 656e 7473 2066 6f72 2065  d segments for e
-00007570: 6163 6820 7375 622d 7374 6163 6b20 6f72  ach sub-stack or
-00007580: 2061 7665 7261 6765 6420 6675 6e63 7469   averaged functi
-00007590: 6f6e 0a20 2020 2022 2222 0a20 2020 2023  on.    """.    #
-000075a0: 202d 2d2d 2d6c 6f61 6420 7061 7261 6d74   ----load paramt
-000075b0: 6572 732d 2d2d 2d0a 2020 2020 6474 203d  ers----.    dt =
-000075c0: 2044 5b22 6474 225d 0a20 2020 206d 6178   D["dt"].    max
-000075d0: 6c61 6720 3d20 445b 226d 6178 6c61 6722  lag = D["maxlag"
-000075e0: 5d0a 2020 2020 6d65 7468 6f64 203d 2044  ].    method = D
-000075f0: 5b22 6363 5f6d 6574 686f 6422 5d0a 2020  ["cc_method"].  
-00007600: 2020 6363 5f6c 656e 203d 2044 5b22 6363    cc_len = D["cc
-00007610: 5f6c 656e 225d 0a20 2020 2073 7562 7374  _len"].    subst
-00007620: 6163 6b20 3d20 445b 2273 7562 7374 6163  ack = D["substac
-00007630: 6b22 5d0a 2020 2020 7374 6163 6b5f 6d65  k"].    stack_me
-00007640: 7468 6f64 203d 2044 5b22 7374 6163 6b5f  thod = D["stack_
-00007650: 6d65 7468 6f64 225d 0a20 2020 2073 7562  method"].    sub
-00007660: 7374 6163 6b5f 6c65 6e20 3d20 445b 2273  stack_len = D["s
-00007670: 7562 7374 6163 6b5f 6c65 6e22 5d0a 2020  ubstack_len"].  
-00007680: 2020 736d 6f6f 7468 7370 6563 745f 4e20    smoothspect_N 
-00007690: 3d20 445b 2273 6d6f 6f74 6873 7065 6374  = D["smoothspect
-000076a0: 5f4e 225d 0a0a 2020 2020 6e77 696e 203d  _N"]..    nwin =
-000076b0: 2066 6674 315f 736d 6f6f 7468 6564 5f61   fft1_smoothed_a
-000076c0: 6273 2e73 6861 7065 5b30 5d0a 2020 2020  bs.shape[0].    
-000076d0: 4e66 6674 3220 3d20 6666 7431 5f73 6d6f  Nfft2 = fft1_smo
-000076e0: 6f74 6865 645f 6162 732e 7368 6170 655b  othed_abs.shape[
-000076f0: 315d 0a0a 2020 2020 2320 2d2d 2d2d 2d2d  1]..    # ------
-00007700: 636f 6e76 6572 7420 616c 6c20 3244 2061  convert all 2D a
-00007710: 7272 6179 7320 696e 746f 2031 4420 746f  rrays into 1D to
-00007720: 2073 7065 6564 2075 702d 2d2d 2d2d 2d2d   speed up-------
-00007730: 2d0a 2020 2020 636f 7272 203d 206e 702e  -.    corr = np.
-00007740: 7a65 726f 7328 6e77 696e 202a 204e 6666  zeros(nwin * Nff
-00007750: 7432 2c20 6474 7970 653d 6e70 2e63 6f6d  t2, dtype=np.com
-00007760: 706c 6578 3634 290a 2020 2020 636f 7272  plex64).    corr
-00007770: 203d 2066 6674 315f 736d 6f6f 7468 6564   = fft1_smoothed
-00007780: 5f61 6273 2e72 6573 6861 7065 280a 2020  _abs.reshape(.  
-00007790: 2020 2020 2020 6666 7431 5f73 6d6f 6f74        fft1_smoot
-000077a0: 6865 645f 6162 732e 7369 7a65 2c0a 2020  hed_abs.size,.  
-000077b0: 2020 2920 2a20 6666 7432 2e72 6573 6861    ) * fft2.resha
-000077c0: 7065 280a 2020 2020 2020 2020 6666 7432  pe(.        fft2
-000077d0: 2e73 697a 652c 0a20 2020 2029 0a0a 2020  .size,.    )..  
-000077e0: 2020 2320 6e6f 726d 616c 697a 6520 6279    # normalize by
-000077f0: 2072 6563 6569 7665 7220 7370 6563 7472   receiver spectr
-00007800: 616c 2066 6f72 2063 6f68 6572 656e 6379  al for coherency
-00007810: 0a20 2020 2069 6620 6d65 7468 6f64 203d  .    if method =
-00007820: 3d20 2263 6f68 6572 656e 6379 223a 0a20  = "coherency":. 
-00007830: 2020 2020 2020 2074 656d 7020 3d20 6d6f         temp = mo
-00007840: 7669 6e67 5f61 7665 280a 2020 2020 2020  ving_ave(.      
-00007850: 2020 2020 2020 6e70 2e61 6273 280a 2020        np.abs(.  
-00007860: 2020 2020 2020 2020 2020 2020 2020 6666                ff
-00007870: 7432 2e72 6573 6861 7065 280a 2020 2020  t2.reshape(.    
-00007880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007890: 6666 7432 2e73 697a 652c 0a20 2020 2020  fft2.size,.     
-000078a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000078b0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-000078c0: 2020 2020 2020 2020 736d 6f6f 7468 7370          smoothsp
-000078d0: 6563 745f 4e2c 0a20 2020 2020 2020 2029  ect_N,.        )
-000078e0: 0a20 2020 2020 2020 2063 6f72 7220 2f3d  .        corr /=
-000078f0: 2074 656d 700a 2020 2020 636f 7272 203d   temp.    corr =
-00007900: 2063 6f72 722e 7265 7368 6170 6528 6e77   corr.reshape(nw
-00007910: 696e 2c20 4e66 6674 3229 0a0a 2020 2020  in, Nfft2)..    
-00007920: 2320 7472 616e 7366 6f72 6d20 6261 636b  # transform back
-00007930: 2074 6f20 7469 6d65 2064 6f6d 6169 6e20   to time domain 
-00007940: 7761 7665 666f 726d 730a 2020 2020 735f  waveforms.    s_
-00007950: 636f 7272 203d 206e 702e 7a65 726f 7328  corr = np.zeros(
-00007960: 7368 6170 653d 286e 7769 6e2c 204e 6666  shape=(nwin, Nff
-00007970: 7429 2c20 6474 7970 653d 6e70 2e66 6c6f  t), dtype=np.flo
-00007980: 6174 3332 2920 2023 2073 7461 636b 6564  at32)  # stacked
-00007990: 2063 6f72 7265 6c61 7469 6f6e 0a20 2020   correlation.   
-000079a0: 2061 6d70 6d61 7820 3d20 6e70 2e7a 6572   ampmax = np.zer
-000079b0: 6f73 286e 7769 6e2c 2064 7479 7065 3d6e  os(nwin, dtype=n
-000079c0: 702e 666c 6f61 7433 3229 0a20 2020 206e  p.float32).    n
-000079d0: 5f63 6f72 7220 3d20 6e70 2e7a 6572 6f73  _corr = np.zeros
-000079e0: 286e 7769 6e2c 2064 7479 7065 3d6e 702e  (nwin, dtype=np.
-000079f0: 696e 7431 3629 2020 2320 6e75 6d62 6572  int16)  # number
-00007a00: 206f 6620 636f 7272 656c 6174 696f 6e73   of correlations
-00007a10: 2066 6f72 2065 6163 6820 7375 6273 7461   for each substa
-00007a20: 636b 0a20 2020 2074 5f63 6f72 7220 3d20  ck.    t_corr = 
-00007a30: 6461 7461 535f 7420 2023 2074 696d 6573  dataS_t  # times
-00007a40: 7461 6d70 0a20 2020 2063 7261 7020 3d20  tamp.    crap = 
-00007a50: 6e70 2e7a 6572 6f73 284e 6666 742c 2064  np.zeros(Nfft, d
-00007a60: 7479 7065 3d6e 702e 636f 6d70 6c65 7836  type=np.complex6
-00007a70: 3429 0a20 2020 2066 6f72 2069 2069 6e20  4).    for i in 
-00007a80: 7261 6e67 6528 6e77 696e 293a 0a20 2020  range(nwin):.   
-00007a90: 2020 2020 206e 5f63 6f72 725b 695d 203d       n_corr[i] =
-00007aa0: 2031 0a20 2020 2020 2020 2063 7261 705b   1.        crap[
-00007ab0: 3a4e 6666 7432 5d20 3d20 636f 7272 5b69  :Nfft2] = corr[i
-00007ac0: 2c20 3a5d 0a20 2020 2020 2020 2063 7261  , :].        cra
-00007ad0: 705b 3a4e 6666 7432 5d20 3d20 6372 6170  p[:Nfft2] = crap
-00007ae0: 5b3a 4e66 6674 325d 202d 206e 702e 6d65  [:Nfft2] - np.me
-00007af0: 616e 2863 7261 705b 3a4e 6666 7432 5d29  an(crap[:Nfft2])
-00007b00: 2020 2320 7265 6d6f 7665 2074 6865 206d    # remove the m
-00007b10: 6561 6e20 696e 2066 7265 7120 646f 6d61  ean in freq doma
-00007b20: 696e 2028 7370 696b 6520 6174 2074 3d30  in (spike at t=0
-00007b30: 290a 2020 2020 2020 2020 6372 6170 5b2d  ).        crap[-
-00007b40: 284e 6666 7432 2920 2b20 3120 3a5d 203d  (Nfft2) + 1 :] =
-00007b50: 206e 702e 666c 6970 286e 702e 636f 6e6a   np.flip(np.conj
-00007b60: 2863 7261 705b 313a 284e 6666 7432 295d  (crap[1:(Nfft2)]
-00007b70: 292c 2061 7869 733d 3029 0a20 2020 2020  ), axis=0).     
-00007b80: 2020 2063 7261 705b 305d 203d 2063 6f6d     crap[0] = com
-00007b90: 706c 6578 2830 2c20 3029 0a20 2020 2020  plex(0, 0).     
-00007ba0: 2020 2073 5f63 6f72 725b 692c 203a 5d20     s_corr[i, :] 
-00007bb0: 3d20 6e70 2e72 6561 6c28 6e70 2e66 6674  = np.real(np.fft
-00007bc0: 2e69 6666 7473 6869 6674 2873 6369 7079  .ifftshift(scipy
-00007bd0: 2e66 6674 7061 636b 2e69 6666 7428 6372  .fftpack.ifft(cr
-00007be0: 6170 2c20 4e66 6674 2c20 6178 6973 3d30  ap, Nfft, axis=0
-00007bf0: 2929 290a 0a20 2020 206e 735f 636f 7272  )))..    ns_corr
-00007c00: 203d 2073 5f63 6f72 720a 2020 2020 666f   = s_corr.    fo
-00007c10: 7220 6969 6920 696e 2072 616e 6765 286e  r iii in range(n
-00007c20: 735f 636f 7272 2e73 6861 7065 5b30 5d29  s_corr.shape[0])
-00007c30: 3a0a 2020 2020 2020 2020 6e73 5f63 6f72  :.        ns_cor
-00007c40: 725b 6969 695d 202f 3d20 6e70 2e6d 6178  r[iii] /= np.max
-00007c50: 286e 702e 6162 7328 6e73 5f63 6f72 725b  (np.abs(ns_corr[
-00007c60: 6969 695d 2929 0a0a 2020 2020 6966 2073  iii]))..    if s
-00007c70: 7562 7374 6163 6b3a 0a20 2020 2020 2020  ubstack:.       
-00007c80: 2069 6620 7375 6273 7461 636b 5f6c 656e   if substack_len
-00007c90: 203d 3d20 6363 5f6c 656e 3a0a 2020 2020   == cc_len:.    
-00007ca0: 2020 2020 2020 2020 2320 7265 6d6f 7665          # remove
-00007cb0: 2061 626e 6f72 6d61 6c20 6461 7461 0a20   abnormal data. 
-00007cc0: 2020 2020 2020 2020 2020 2061 6d70 6d61             ampma
-00007cd0: 7820 3d20 6e70 2e6d 6178 2873 5f63 6f72  x = np.max(s_cor
-00007ce0: 722c 2061 7869 733d 3129 0a20 2020 2020  r, axis=1).     
-00007cf0: 2020 2020 2020 2074 696e 6478 203d 206e         tindx = n
-00007d00: 702e 7768 6572 6528 2861 6d70 6d61 7820  p.where((ampmax 
-00007d10: 3c20 3230 202a 206e 702e 6d65 6469 616e  < 20 * np.median
-00007d20: 2861 6d70 6d61 7829 2920 2620 2861 6d70  (ampmax)) & (amp
-00007d30: 6d61 7820 3e20 3029 295b 305d 0a20 2020  max > 0))[0].   
-00007d40: 2020 2020 2020 2020 2073 5f63 6f72 7220           s_corr 
-00007d50: 3d20 735f 636f 7272 5b74 696e 6478 2c20  = s_corr[tindx, 
-00007d60: 3a5d 0a20 2020 2020 2020 2020 2020 2074  :].            t
-00007d70: 5f63 6f72 7220 3d20 745f 636f 7272 5b74  _corr = t_corr[t
-00007d80: 696e 6478 5d0a 2020 2020 2020 2020 2020  indx].          
-00007d90: 2020 6e5f 636f 7272 203d 206e 5f63 6f72    n_corr = n_cor
-00007da0: 725b 7469 6e64 785d 0a0a 2020 2020 2020  r[tindx]..      
-00007db0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00007dc0: 2020 2020 2320 6765 7420 7469 6d65 2069      # get time i
-00007dd0: 6e66 6f72 6d61 7469 6f6e 0a20 2020 2020  nformation.     
-00007de0: 2020 2020 2020 2054 746f 7461 6c20 3d20         Ttotal = 
-00007df0: 6461 7461 535f 745b 2d31 5d20 2d20 6461  dataS_t[-1] - da
-00007e00: 7461 535f 745b 305d 2020 2320 746f 7461  taS_t[0]  # tota
-00007e10: 6c20 6475 7261 7469 6f6e 206f 6620 7768  l duration of wh
-00007e20: 6174 2077 6520 6861 7665 206e 6f77 0a20  at we have now. 
-00007e30: 2020 2020 2020 2020 2020 2074 7374 6172             tstar
-00007e40: 7420 3d20 6461 7461 535f 745b 305d 0a0a  t = dataS_t[0]..
-00007e50: 2020 2020 2020 2020 2020 2020 6e73 7461              nsta
-00007e60: 636b 203d 2069 6e74 286e 702e 726f 756e  ck = int(np.roun
-00007e70: 6428 5474 6f74 616c 202f 2073 7562 7374  d(Ttotal / subst
-00007e80: 6163 6b5f 6c65 6e29 290a 2020 2020 2020  ack_len)).      
-00007e90: 2020 2020 2020 616d 706d 6178 203d 206e        ampmax = n
-00007ea0: 702e 7a65 726f 7328 6e73 7461 636b 2c20  p.zeros(nstack, 
-00007eb0: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
-00007ec0: 290a 2020 2020 2020 2020 2020 2020 735f  ).            s_
-00007ed0: 636f 7272 203d 206e 702e 7a65 726f 7328  corr = np.zeros(
-00007ee0: 7368 6170 653d 286e 7374 6163 6b2c 204e  shape=(nstack, N
-00007ef0: 6666 7429 2c20 6474 7970 653d 6e70 2e66  fft), dtype=np.f
-00007f00: 6c6f 6174 3332 290a 2020 2020 2020 2020  loat32).        
-00007f10: 2020 2020 6e5f 636f 7272 203d 206e 702e      n_corr = np.
-00007f20: 7a65 726f 7328 6e73 7461 636b 2c20 6474  zeros(nstack, dt
-00007f30: 7970 653d 6e70 2e69 6e74 290a 2020 2020  ype=np.int).    
-00007f40: 2020 2020 2020 2020 745f 636f 7272 203d          t_corr =
-00007f50: 206e 702e 7a65 726f 7328 6e73 7461 636b   np.zeros(nstack
-00007f60: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
-00007f70: 290a 2020 2020 2020 2020 2020 2020 6372  ).            cr
-00007f80: 6170 203d 206e 702e 7a65 726f 7328 4e66  ap = np.zeros(Nf
-00007f90: 6674 2c20 6474 7970 653d 6e70 2e63 6f6d  ft, dtype=np.com
-00007fa0: 706c 6578 3634 290a 0a20 2020 2020 2020  plex64)..       
-00007fb0: 2020 2020 2066 6f72 2069 7374 6163 6b20       for istack 
-00007fc0: 696e 2072 616e 6765 286e 7374 6163 6b29  in range(nstack)
-00007fd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007fe0: 2020 2320 6669 6e64 2074 6865 2069 6e64    # find the ind
-00007ff0: 6578 6573 206f 6620 616c 6c20 6f66 2074  exes of all of t
-00008000: 6865 2077 696e 646f 7773 2074 6861 7420  he windows that 
-00008010: 7374 6172 7420 6f72 2065 6e64 2077 6974  start or end wit
-00008020: 6869 6e0a 2020 2020 2020 2020 2020 2020  hin.            
-00008030: 2020 2020 6974 696d 6520 3d20 6e70 2e77      itime = np.w
-00008040: 6865 7265 2828 6461 7461 535f 7420 3e3d  here((dataS_t >=
-00008050: 2074 7374 6172 7429 2026 2028 6461 7461   tstart) & (data
-00008060: 535f 7420 3c20 7473 7461 7274 202b 2073  S_t < tstart + s
-00008070: 7562 7374 6163 6b5f 6c65 6e29 295b 305d  ubstack_len))[0]
-00008080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008090: 2069 6620 6c65 6e28 6974 696d 6529 203d   if len(itime) =
-000080a0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000080b0: 2020 2020 2020 2020 2074 7374 6172 7420           tstart 
-000080c0: 2b3d 2073 7562 7374 6163 6b5f 6c65 6e0a  += substack_len.
-000080d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000080e0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
-000080f0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
-00008100: 6170 5b3a 4e66 6674 325d 203d 206e 702e  ap[:Nfft2] = np.
-00008110: 6d65 616e 2863 6f72 725b 6974 696d 652c  mean(corr[itime,
-00008120: 203a 5d2c 2061 7869 733d 3029 2020 2320   :], axis=0)  # 
-00008130: 6c69 6e65 6172 2061 7665 7261 6765 206f  linear average o
-00008140: 6620 7468 6520 636f 7272 656c 6174 696f  f the correlatio
-00008150: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00008160: 2020 6372 6170 5b3a 4e66 6674 325d 203d    crap[:Nfft2] =
-00008170: 2063 7261 705b 3a4e 6666 7432 5d20 2d20   crap[:Nfft2] - 
-00008180: 6e70 2e6d 6561 6e28 6372 6170 5b3a 4e66  np.mean(crap[:Nf
-00008190: 6674 325d 2920 2023 2072 656d 6f76 6520  ft2])  # remove 
-000081a0: 7468 6520 6d65 616e 2069 6e20 6672 6571  the mean in freq
-000081b0: 2064 6f6d 6169 6e20 2873 7069 6b65 2061   domain (spike a
-000081c0: 7420 743d 3029 0a20 2020 2020 2020 2020  t t=0).         
-000081d0: 2020 2020 2020 2063 7261 705b 2d28 4e66         crap[-(Nf
-000081e0: 6674 3229 202b 2031 203a 5d20 3d20 6e70  ft2) + 1 :] = np
-000081f0: 2e66 6c69 7028 6e70 2e63 6f6e 6a28 6372  .flip(np.conj(cr
-00008200: 6170 5b31 3a28 4e66 6674 3229 5d29 2c20  ap[1:(Nfft2)]), 
-00008210: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-00008220: 2020 2020 2020 2020 6372 6170 5b30 5d20          crap[0] 
-00008230: 3d20 636f 6d70 6c65 7828 302c 2030 290a  = complex(0, 0).
-00008240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008250: 735f 636f 7272 5b69 7374 6163 6b2c 203a  s_corr[istack, :
-00008260: 5d20 3d20 6e70 2e72 6561 6c28 6e70 2e66  ] = np.real(np.f
-00008270: 6674 2e69 6666 7473 6869 6674 2873 6369  ft.ifftshift(sci
-00008280: 7079 2e66 6674 7061 636b 2e69 6666 7428  py.fftpack.ifft(
-00008290: 6372 6170 2c20 4e66 6674 2c20 6178 6973  crap, Nfft, axis
-000082a0: 3d30 2929 290a 2020 2020 2020 2020 2020  =0))).          
-000082b0: 2020 2020 2020 6e5f 636f 7272 5b69 7374        n_corr[ist
-000082c0: 6163 6b5d 203d 206c 656e 2869 7469 6d65  ack] = len(itime
-000082d0: 2920 2023 206e 756d 6265 7220 6f66 2077  )  # number of w
-000082e0: 696e 646f 7773 2073 7461 636b 730a 2020  indows stacks.  
-000082f0: 2020 2020 2020 2020 2020 2020 2020 745f                t_
-00008300: 636f 7272 5b69 7374 6163 6b5d 203d 2074  corr[istack] = t
-00008310: 7374 6172 7420 2023 2073 6176 6520 7468  start  # save th
-00008320: 6520 7469 6d65 2073 7461 6d70 730a 2020  e time stamps.  
-00008330: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00008340: 7461 7274 202b 3d20 7375 6273 7461 636b  tart += substack
-00008350: 5f6c 656e 0a20 2020 2020 2020 2020 2020  _len.           
-00008360: 2020 2020 2023 2070 7269 6e74 2827 636f       # print('co
-00008370: 7272 656c 6174 696f 6e20 646f 6e65 2061  rrelation done a
-00008380: 6e64 2073 7461 636b 6564 2061 7420 7469  nd stacked at ti
-00008390: 6d65 2025 7327 2025 2073 7472 2874 5f63  me %s' % str(t_c
-000083a0: 6f72 725b 6973 7461 636b 5d29 290a 0a20  orr[istack])).. 
-000083b0: 2020 2020 2020 2020 2020 2023 2072 656d             # rem
-000083c0: 6f76 6520 6162 6e6f 726d 616c 2064 6174  ove abnormal dat
-000083d0: 610a 2020 2020 2020 2020 2020 2020 616d  a.            am
-000083e0: 706d 6178 203d 206e 702e 6d61 7828 735f  pmax = np.max(s_
-000083f0: 636f 7272 2c20 6178 6973 3d31 290a 2020  corr, axis=1).  
-00008400: 2020 2020 2020 2020 2020 7469 6e64 7820            tindx 
-00008410: 3d20 6e70 2e77 6865 7265 2828 616d 706d  = np.where((ampm
-00008420: 6178 203c 2032 3020 2a20 6e70 2e6d 6564  ax < 20 * np.med
-00008430: 6961 6e28 616d 706d 6178 2929 2026 2028  ian(ampmax)) & (
-00008440: 616d 706d 6178 203e 2030 2929 5b30 5d0a  ampmax > 0))[0].
-00008450: 2020 2020 2020 2020 2020 2020 735f 636f              s_co
-00008460: 7272 203d 2073 5f63 6f72 725b 7469 6e64  rr = s_corr[tind
-00008470: 782c 203a 5d0a 2020 2020 2020 2020 2020  x, :].          
-00008480: 2020 745f 636f 7272 203d 2074 5f63 6f72    t_corr = t_cor
-00008490: 725b 7469 6e64 785d 0a20 2020 2020 2020  r[tindx].       
-000084a0: 2020 2020 206e 5f63 6f72 7220 3d20 6e5f       n_corr = n_
-000084b0: 636f 7272 5b74 696e 6478 5d0a 0a20 2020  corr[tindx]..   
-000084c0: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
-000084d0: 2061 7665 7261 6765 2064 6169 6c79 2063   average daily c
-000084e0: 726f 7373 2063 6f72 7265 6c61 7469 6f6e  ross correlation
-000084f0: 2066 756e 6374 696f 6e73 0a20 2020 2020   functions.     
-00008500: 2020 2069 6620 7374 6163 6b5f 6d65 7468     if stack_meth
-00008510: 6f64 203d 3d20 226c 696e 6561 7222 3a0a  od == "linear":.
-00008520: 2020 2020 2020 2020 2020 2020 616d 706d              ampm
-00008530: 6178 203d 206e 702e 6d61 7828 735f 636f  ax = np.max(s_co
-00008540: 7272 2c20 6178 6973 3d31 290a 2020 2020  rr, axis=1).    
-00008550: 2020 2020 2020 2020 7469 6e64 7820 3d20          tindx = 
-00008560: 6e70 2e77 6865 7265 2828 616d 706d 6178  np.where((ampmax
-00008570: 203c 2032 3020 2a20 6e70 2e6d 6564 6961   < 20 * np.media
-00008580: 6e28 616d 706d 6178 2929 2026 2028 616d  n(ampmax)) & (am
-00008590: 706d 6178 203e 2030 2929 5b30 5d0a 2020  pmax > 0))[0].  
-000085a0: 2020 2020 2020 2020 2020 735f 636f 7272            s_corr
-000085b0: 203d 206e 702e 6d65 616e 2873 5f63 6f72   = np.mean(s_cor
-000085c0: 725b 7469 6e64 785d 2c20 6178 6973 3d30  r[tindx], axis=0
-000085d0: 290a 2020 2020 2020 2020 2020 2020 745f  ).            t_
-000085e0: 636f 7272 203d 2064 6174 6153 5f74 5b30  corr = dataS_t[0
-000085f0: 5d0a 2020 2020 2020 2020 2020 2020 6e5f  ].            n_
-00008600: 636f 7272 203d 206c 656e 2874 696e 6478  corr = len(tindx
-00008610: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-00008620: 7461 636b 5f6d 6574 686f 6420 3d3d 2022  tack_method == "
-00008630: 726f 6275 7374 223a 0a20 2020 2020 2020  robust":.       
-00008640: 2020 2020 2070 7269 6e74 2822 646f 2072       print("do r
-00008650: 6f62 7573 7420 7375 6273 7461 636b 696e  obust substackin
-00008660: 6722 290a 2020 2020 2020 2020 2020 2020  g").            
-00008670: 735f 636f 7272 203d 2072 6f62 7573 745f  s_corr = robust_
-00008680: 7374 6163 6b28 735f 636f 7272 2c20 302e  stack(s_corr, 0.
-00008690: 3030 3129 0a20 2020 2020 2020 2020 2020  001).           
-000086a0: 2074 5f63 6f72 7220 3d20 6461 7461 535f   t_corr = dataS_
-000086b0: 745b 305d 0a20 2020 2020 2020 2020 2020  t[0].           
-000086c0: 206e 5f63 6f72 7220 3d20 6e77 696e 0a20   n_corr = nwin. 
-000086d0: 2020 2023 2020 656c 6966 2073 7461 636b     #  elif stack
-000086e0: 5f6d 6574 686f 6420 3d3d 2027 7365 6c65  _method == 'sele
-000086f0: 6374 6976 6527 3a0a 2020 2020 2320 2020  ctive':.    #   
-00008700: 2020 2070 7269 6e74 2827 646f 2073 656c     print('do sel
-00008710: 6563 7469 7665 2073 7562 7374 6163 6b69  ective substacki
-00008720: 6e67 2729 0a20 2020 2023 2020 2020 2020  ng').    #      
-00008730: 735f 636f 7272 203d 2073 656c 6563 7469  s_corr = selecti
-00008740: 7665 5f73 7461 636b 2873 5f63 6f72 722c  ve_stack(s_corr,
-00008750: 302e 3030 3129 0a20 2020 2023 2020 2020  0.001).    #    
-00008760: 2020 745f 636f 7272 203d 2064 6174 6153    t_corr = dataS
-00008770: 5f74 5b30 5d0a 2020 2020 2320 2020 2020  _t[0].    #     
-00008780: 206e 5f63 6f72 7220 3d20 6e77 696e 0a0a   n_corr = nwin..
-00008790: 2020 2020 2320 7472 696d 2074 6865 2043      # trim the C
-000087a0: 4346 7320 696e 205b 2d6d 6178 6c61 6720  CFs in [-maxlag 
-000087b0: 6d61 786c 6167 5d0a 2020 2020 7420 3d20  maxlag].    t = 
-000087c0: 6e70 2e61 7261 6e67 6528 2d4e 6666 7432  np.arange(-Nfft2
-000087d0: 202b 2031 2c20 4e66 6674 3229 202a 2064   + 1, Nfft2) * d
-000087e0: 740a 2020 2020 696e 6420 3d20 6e70 2e77  t.    ind = np.w
-000087f0: 6865 7265 286e 702e 6162 7328 7429 203c  here(np.abs(t) <
-00008800: 3d20 6d61 786c 6167 295b 305d 0a20 2020  = maxlag)[0].   
-00008810: 2069 6620 735f 636f 7272 2e6e 6469 6d20   if s_corr.ndim 
-00008820: 3d3d 2031 3a0a 2020 2020 2020 2020 735f  == 1:.        s_
-00008830: 636f 7272 203d 2073 5f63 6f72 725b 696e  corr = s_corr[in
-00008840: 645d 0a20 2020 2065 6c69 6620 735f 636f  d].    elif s_co
-00008850: 7272 2e6e 6469 6d20 3d3d 2032 3a0a 2020  rr.ndim == 2:.  
-00008860: 2020 2020 2020 735f 636f 7272 203d 2073        s_corr = s
-00008870: 5f63 6f72 725b 3a2c 2069 6e64 5d0a 2020  _corr[:, ind].  
-00008880: 2020 7265 7475 726e 2073 5f63 6f72 722c    return s_corr,
-00008890: 2074 5f63 6f72 722c 206e 5f63 6f72 722c   t_corr, n_corr,
-000088a0: 206e 735f 636f 7272 5b3a 2c20 696e 645d   ns_corr[:, ind]
-000088b0: 0a0a 0a64 6566 2063 635f 7061 7261 6d65  ...def cc_parame
-000088c0: 7465 7273 2863 635f 7061 7261 2c20 636f  ters(cc_para, co
-000088d0: 6f72 2c20 7463 6f72 722c 206e 636f 7272  or, tcorr, ncorr
-000088e0: 2c20 636f 6d70 293a 0a20 2020 2022 2222  , comp):.    """
-000088f0: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-00008900: 6f6e 2061 7373 656d 626c 6573 2074 6865  on assembles the
-00008910: 2070 6172 616d 6574 6572 7320 666f 7220   parameters for 
-00008920: 7468 6520 6363 2066 756e 6374 696f 6e2c  the cc function,
-00008930: 2077 6869 6368 2069 7320 7573 6564 0a20   which is used. 
-00008940: 2020 2077 6865 6e20 7772 6974 696e 6720     when writing 
-00008950: 7468 656d 2069 6e74 6f20 4153 4446 2066  them into ASDF f
-00008960: 696c 6573 0a20 2020 2050 4152 414d 4554  iles.    PARAMET
-00008970: 4552 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ERS:.    -------
-00008980: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00008990: 2020 2063 635f 7061 7261 3a20 6469 6374     cc_para: dict
-000089a0: 2063 6f6e 7461 696e 696e 6720 7061 7261   containing para
-000089b0: 6d65 7465 7273 2075 7365 6420 696e 2074  meters used in t
-000089c0: 6865 2066 6674 5f63 6320 7374 6570 0a20  he fft_cc step. 
-000089d0: 2020 2063 6f6f 723a 2020 2020 6469 6374     coor:    dict
-000089e0: 2063 6f6e 7461 696e 696e 6720 636f 6f72   containing coor
-000089f0: 6469 6e61 7465 7320 696e 666f 206f 6620  dinates info of 
-00008a00: 7468 6520 736f 7572 6365 2061 6e64 2072  the source and r
-00008a10: 6563 6569 7665 7220 7374 6174 696f 6e73  eceiver stations
-00008a20: 0a20 2020 2074 636f 7272 3a20 2020 7469  .    tcorr:   ti
-00008a30: 6d65 7374 616d 7020 6d61 7472 6978 0a20  mestamp matrix. 
-00008a40: 2020 206e 636f 7272 3a20 2020 6d61 7472     ncorr:   matr
-00008a50: 6978 206f 6620 6e75 6d62 6572 206f 6620  ix of number of 
-00008a60: 676f 6f64 2073 6567 6d65 6e74 7320 666f  good segments fo
-00008a70: 7220 6561 6368 2073 7562 2d73 7461 636b  r each sub-stack
-00008a80: 2f66 696e 616c 2073 7461 636b 0a20 2020  /final stack.   
-00008a90: 2063 6f6d 703a 2020 2020 3220 6368 6172   comp:    2 char
-00008aa0: 6163 7465 7220 7374 7269 6e67 7320 666f  acter strings fo
-00008ab0: 7220 7468 6520 6372 6f73 7320 636f 7272  r the cross corr
-00008ac0: 656c 6174 696f 6e20 636f 6d70 6f6e 656e  elation componen
-00008ad0: 740a 2020 2020 5245 5455 524e 533a 0a20  t.    RETURNS:. 
-00008ae0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00008af0: 2d2d 2d2d 2d0a 2020 2020 7061 7261 6d65  -----.    parame
-00008b00: 7465 7273 3a20 6469 6374 2063 6f6e 7461  ters: dict conta
-00008b10: 696e 696e 6720 6162 6f76 6520 696e 666f  ining above info
-00008b20: 2075 7365 6420 666f 7220 6c61 7465 7220   used for later 
-00008b30: 7374 6163 6b69 6e67 2f70 6c6f 7474 696e  stacking/plottin
-00008b40: 670a 2020 2020 2222 220a 2020 2020 6c61  g.    """.    la
-00008b50: 7453 203d 2063 6f6f 725b 226c 6174 5322  tS = coor["latS"
-00008b60: 5d0a 2020 2020 6c6f 6e53 203d 2063 6f6f  ].    lonS = coo
-00008b70: 725b 226c 6f6e 5322 5d0a 2020 2020 6c61  r["lonS"].    la
-00008b80: 7452 203d 2063 6f6f 725b 226c 6174 5222  tR = coor["latR"
-00008b90: 5d0a 2020 2020 6c6f 6e52 203d 2063 6f6f  ].    lonR = coo
-00008ba0: 725b 226c 6f6e 5222 5d0a 2020 2020 6474  r["lonR"].    dt
-00008bb0: 203d 2063 635f 7061 7261 5b22 6474 225d   = cc_para["dt"]
-00008bc0: 0a20 2020 206d 6178 6c61 6720 3d20 6363  .    maxlag = cc
-00008bd0: 5f70 6172 615b 226d 6178 6c61 6722 5d0a  _para["maxlag"].
-00008be0: 2020 2020 7375 6273 7461 636b 203d 2063      substack = c
-00008bf0: 635f 7061 7261 5b22 7375 6273 7461 636b  c_para["substack
-00008c00: 225d 0a20 2020 2063 635f 6d65 7468 6f64  "].    cc_method
-00008c10: 203d 2063 635f 7061 7261 5b22 6363 5f6d   = cc_para["cc_m
-00008c20: 6574 686f 6422 5d0a 0a20 2020 2064 6973  ethod"]..    dis
-00008c30: 742c 2061 7a69 2c20 6261 7a20 3d20 6f62  t, azi, baz = ob
-00008c40: 7370 792e 6765 6f64 6574 6963 732e 6261  spy.geodetics.ba
-00008c50: 7365 2e67 7073 3264 6973 745f 617a 696d  se.gps2dist_azim
-00008c60: 7574 6828 6c61 7453 2c20 6c6f 6e53 2c20  uth(latS, lonS, 
-00008c70: 6c61 7452 2c20 6c6f 6e52 290a 2020 2020  latR, lonR).    
-00008c80: 7061 7261 6d65 7465 7273 203d 207b 0a20  parameters = {. 
-00008c90: 2020 2020 2020 2022 6474 223a 2064 742c         "dt": dt,
-00008ca0: 0a20 2020 2020 2020 2022 6d61 786c 6167  .        "maxlag
-00008cb0: 223a 2069 6e74 286d 6178 6c61 6729 2c0a  ": int(maxlag),.
-00008cc0: 2020 2020 2020 2020 2264 6973 7422 3a20          "dist": 
-00008cd0: 6e70 2e66 6c6f 6174 3332 2864 6973 7420  np.float32(dist 
-00008ce0: 2f20 3130 3030 292c 0a20 2020 2020 2020  / 1000),.       
-00008cf0: 2022 617a 6922 3a20 6e70 2e66 6c6f 6174   "azi": np.float
-00008d00: 3332 2861 7a69 292c 0a20 2020 2020 2020  32(azi),.       
-00008d10: 2022 6261 7a22 3a20 6e70 2e66 6c6f 6174   "baz": np.float
-00008d20: 3332 2862 617a 292c 0a20 2020 2020 2020  32(baz),.       
-00008d30: 2022 6c6f 6e53 223a 206e 702e 666c 6f61   "lonS": np.floa
-00008d40: 7433 3228 6c6f 6e53 292c 0a20 2020 2020  t32(lonS),.     
-00008d50: 2020 2022 6c61 7453 223a 206e 702e 666c     "latS": np.fl
-00008d60: 6f61 7433 3228 6c61 7453 292c 0a20 2020  oat32(latS),.   
-00008d70: 2020 2020 2022 6c6f 6e52 223a 206e 702e       "lonR": np.
-00008d80: 666c 6f61 7433 3228 6c6f 6e52 292c 0a20  float32(lonR),. 
-00008d90: 2020 2020 2020 2022 6c61 7452 223a 206e         "latR": n
-00008da0: 702e 666c 6f61 7433 3228 6c61 7452 292c  p.float32(latR),
-00008db0: 0a20 2020 2020 2020 2022 6e67 6f6f 6422  .        "ngood"
-00008dc0: 3a20 6e63 6f72 722c 0a20 2020 2020 2020  : ncorr,.       
-00008dd0: 2022 6363 5f6d 6574 686f 6422 3a20 6363   "cc_method": cc
-00008de0: 5f6d 6574 686f 642c 0a20 2020 2020 2020  _method,.       
-00008df0: 2022 7469 6d65 223a 2074 636f 7272 2c0a   "time": tcorr,.
-00008e00: 2020 2020 2020 2020 2273 7562 7374 6163          "substac
-00008e10: 6b22 3a20 7375 6273 7461 636b 2c0a 2020  k": substack,.  
-00008e20: 2020 2020 2020 2263 6f6d 7022 3a20 636f        "comp": co
-00008e30: 6d70 2c0a 2020 2020 7d0a 2020 2020 7265  mp,.    }.    re
-00008e40: 7475 726e 2070 6172 616d 6574 6572 730a  turn parameters.
-00008e50: 0a0a 6465 6620 7374 6163 6b69 6e67 2863  ..def stacking(c
-00008e60: 635f 6172 7261 792c 2063 635f 7469 6d65  c_array, cc_time
-00008e70: 2c20 6363 5f6e 676f 6f64 2c20 7374 6163  , cc_ngood, stac
-00008e80: 6b5f 7061 7261 293a 0a20 2020 2022 2222  k_para):.    """
-00008e90: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-00008ea0: 6f6e 2073 7461 636b 7320 7468 6520 6372  on stacks the cr
-00008eb0: 6f73 7320 636f 7272 656c 6174 696f 6e20  oss correlation 
-00008ec0: 6461 7461 2061 6363 6f72 6469 6e67 2074  data according t
-00008ed0: 6f20 7468 6520 7573 6572 2d64 6566 696e  o the user-defin
-00008ee0: 6564 2073 7562 7374 6163 6b5f 6c65 6e20  ed substack_len 
-00008ef0: 7061 7261 6d65 7465 720a 0a20 2020 2050  parameter..    P
-00008f00: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
-00008f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00008f20: 2d2d 2d2d 2d0a 2020 2020 6363 5f61 7272  -----.    cc_arr
-00008f30: 6179 3a20 3244 206e 756d 7079 2066 6c6f  ay: 2D numpy flo
-00008f40: 6174 3332 206d 6174 7269 7820 636f 6e74  at32 matrix cont
-00008f50: 6169 6e69 6e67 2061 6c6c 2073 6567 6d65  aining all segme
-00008f60: 6e74 6564 2063 726f 7373 2d63 6f72 7265  nted cross-corre
-00008f70: 6c61 7469 6f6e 2064 6174 610a 2020 2020  lation data.    
-00008f80: 6363 5f74 696d 653a 2020 3144 206e 756d  cc_time:  1D num
-00008f90: 7079 2061 7272 6179 206f 6620 7469 6d65  py array of time
-00008fa0: 7374 616d 7073 2066 6f72 2065 6163 6820  stamps for each 
-00008fb0: 7365 676d 656e 7420 6f66 2063 635f 6172  segment of cc_ar
-00008fc0: 7261 790a 2020 2020 6363 5f6e 676f 6f64  ray.    cc_ngood
-00008fd0: 3a20 3144 206e 756d 7079 2069 6e74 3136  : 1D numpy int16
-00008fe0: 206d 6174 7269 7820 7368 6f77 696e 6720   matrix showing 
-00008ff0: 7468 6520 6e75 6d62 6572 206f 6620 7365  the number of se
-00009000: 676d 656e 7473 2066 6f72 2065 6163 6820  gments for each 
-00009010: 7375 622d 7374 6163 6b20 616e 642f 6f72  sub-stack and/or
-00009020: 2066 756c 6c20 7374 6163 6b0a 2020 2020   full stack.    
-00009030: 7374 6163 6b5f 7061 7261 3a20 6120 6469  stack_para: a di
-00009040: 6374 2063 6f6e 7461 696e 696e 6720 616c  ct containing al
-00009050: 6c20 7374 6163 6b69 6e67 2070 6172 616d  l stacking param
-00009060: 6574 6572 730a 0a20 2020 2052 4554 5552  eters..    RETUR
-00009070: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
-00009080: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00009090: 2020 2063 635f 6172 7261 792c 2063 635f     cc_array, cc_
-000090a0: 6e67 6f6f 642c 2063 635f 7469 6d65 3a20  ngood, cc_time: 
-000090b0: 7361 6d65 2074 6f20 7468 6520 696e 7075  same to the inpu
-000090c0: 7420 7061 7261 6d65 7465 7273 2062 7574  t parameters but
-000090d0: 2077 6974 6820 6162 6e6f 726d 616c 2063   with abnormal c
-000090e0: 726f 7373 2d63 6f72 7265 616c 7469 6f6e  ross-correaltion
-000090f0: 7320 7265 6d6f 7665 640a 2020 2020 616c  s removed.    al
-00009100: 6c73 7461 636b 7331 3a20 3144 206d 6174  lstacks1: 1D mat
-00009110: 7269 7820 6f66 2073 7461 636b 6564 2063  rix of stacked c
-00009120: 726f 7373 2d63 6f72 7265 6c61 7469 6f6e  ross-correlation
-00009130: 2066 756e 6374 696f 6e73 206f 7665 7220   functions over 
-00009140: 616c 6c20 7468 6520 7365 676d 656e 7473  all the segments
-00009150: 0a20 2020 206e 7374 6163 6b73 3a20 2020  .    nstacks:   
-00009160: 206e 756d 6265 7220 6f66 206f 7665 7261   number of overa
-00009170: 6c6c 2073 6567 6d65 6e74 7320 666f 7220  ll segments for 
-00009180: 7468 6520 6669 6e61 6c20 7374 6163 6b73  the final stacks
-00009190: 0a20 2020 2022 2222 0a20 2020 2023 206c  .    """.    # l
-000091a0: 6f61 6420 7573 6566 756c 2070 6172 616d  oad useful param
-000091b0: 6574 6572 7320 6672 6f6d 2064 6963 740a  eters from dict.
-000091c0: 2020 2020 7361 6d70 5f66 7265 7120 3d20      samp_freq = 
-000091d0: 7374 6163 6b5f 7061 7261 5b22 7361 6d70  stack_para["samp
-000091e0: 5f66 7265 7122 5d0a 2020 2020 736d 6574  _freq"].    smet
-000091f0: 686f 6420 3d20 7374 6163 6b5f 7061 7261  hod = stack_para
-00009200: 5b22 7374 6163 6b5f 6d65 7468 6f64 225d  ["stack_method"]
-00009210: 0a20 2020 206e 7074 7320 3d20 6363 5f61  .    npts = cc_a
-00009220: 7272 6179 2e73 6861 7065 5b31 5d0a 0a20  rray.shape[1].. 
-00009230: 2020 2023 2072 656d 6f76 6520 6162 6e6f     # remove abno
-00009240: 726d 616c 2064 6174 610a 2020 2020 616d  rmal data.    am
-00009250: 706d 6178 203d 206e 702e 6d61 7828 6363  pmax = np.max(cc
-00009260: 5f61 7272 6179 2c20 6178 6973 3d31 290a  _array, axis=1).
-00009270: 2020 2020 7469 6e64 7820 3d20 6e70 2e77      tindx = np.w
-00009280: 6865 7265 2828 616d 706d 6178 203c 2032  here((ampmax < 2
-00009290: 3020 2a20 6e70 2e6d 6564 6961 6e28 616d  0 * np.median(am
-000092a0: 706d 6178 2929 2026 2028 616d 706d 6178  pmax)) & (ampmax
-000092b0: 203e 2030 2929 5b30 5d0a 2020 2020 6966   > 0))[0].    if
-000092c0: 206e 6f74 206c 656e 2874 696e 6478 293a   not len(tindx):
-000092d0: 0a20 2020 2020 2020 2061 6c6c 7374 6163  .        allstac
-000092e0: 6b73 3120 3d20 5b5d 0a20 2020 2020 2020  ks1 = [].       
-000092f0: 2061 6c6c 7374 6163 6b73 3220 3d20 5b5d   allstacks2 = []
-00009300: 0a20 2020 2020 2020 2061 6c6c 7374 6163  .        allstac
-00009310: 6b73 3320 3d20 5b5d 0a20 2020 2020 2020  ks3 = [].       
-00009320: 206e 7374 6163 6b73 203d 2030 0a20 2020   nstacks = 0.   
-00009330: 2020 2020 2063 635f 6172 7261 7920 3d20       cc_array = 
-00009340: 5b5d 0a20 2020 2020 2020 2063 635f 6e67  [].        cc_ng
-00009350: 6f6f 6420 3d20 5b5d 0a20 2020 2020 2020  ood = [].       
-00009360: 2063 635f 7469 6d65 203d 205b 5d0a 2020   cc_time = [].  
-00009370: 2020 2020 2020 7265 7475 726e 2063 635f        return cc_
-00009380: 6172 7261 792c 2063 635f 6e67 6f6f 642c  array, cc_ngood,
-00009390: 2063 635f 7469 6d65 2c20 616c 6c73 7461   cc_time, allsta
-000093a0: 636b 7331 2c20 616c 6c73 7461 636b 7332  cks1, allstacks2
-000093b0: 2c20 616c 6c73 7461 636b 7333 2c20 6e73  , allstacks3, ns
-000093c0: 7461 636b 730a 2020 2020 656c 7365 3a0a  tacks.    else:.
-000093d0: 2020 2020 2020 2020 2320 7265 6d6f 7665          # remove
-000093e0: 206f 6e65 7320 7769 7468 2062 6164 2061   ones with bad a
-000093f0: 6d70 6c69 7475 6465 0a20 2020 2020 2020  mplitude.       
-00009400: 2063 635f 6172 7261 7920 3d20 6363 5f61   cc_array = cc_a
-00009410: 7272 6179 5b74 696e 6478 2c20 3a5d 0a20  rray[tindx, :]. 
-00009420: 2020 2020 2020 2063 635f 7469 6d65 203d         cc_time =
-00009430: 2063 635f 7469 6d65 5b74 696e 6478 5d0a   cc_time[tindx].
-00009440: 2020 2020 2020 2020 6363 5f6e 676f 6f64          cc_ngood
-00009450: 203d 2063 635f 6e67 6f6f 645b 7469 6e64   = cc_ngood[tind
-00009460: 785d 0a0a 2020 2020 2020 2020 2320 646f  x]..        # do
-00009470: 2073 7461 636b 696e 670a 2020 2020 2020   stacking.      
-00009480: 2020 616c 6c73 7461 636b 7331 203d 206e    allstacks1 = n
-00009490: 702e 7a65 726f 7328 6e70 7473 2c20 6474  p.zeros(npts, dt
-000094a0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
-000094b0: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
-000094c0: 7332 203d 206e 702e 7a65 726f 7328 6e70  s2 = np.zeros(np
-000094d0: 7473 2c20 6474 7970 653d 6e70 2e66 6c6f  ts, dtype=np.flo
-000094e0: 6174 3332 290a 2020 2020 2020 2020 616c  at32).        al
-000094f0: 6c73 7461 636b 7333 203d 206e 702e 7a65  lstacks3 = np.ze
-00009500: 726f 7328 6e70 7473 2c20 6474 7970 653d  ros(npts, dtype=
-00009510: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-00009520: 2020 2020 2069 6620 736d 6574 686f 6420       if smethod 
-00009530: 3d3d 2022 6c69 6e65 6172 223a 0a20 2020  == "linear":.   
-00009540: 2020 2020 2020 2020 2061 6c6c 7374 6163           allstac
-00009550: 6b73 3120 3d20 6e70 2e6d 6561 6e28 6363  ks1 = np.mean(cc
-00009560: 5f61 7272 6179 2c20 6178 6973 3d30 290a  _array, axis=0).
-00009570: 2020 2020 2020 2020 656c 6966 2073 6d65          elif sme
-00009580: 7468 6f64 203d 3d20 2270 7773 223a 0a20  thod == "pws":. 
-00009590: 2020 2020 2020 2020 2020 2061 6c6c 7374             allst
-000095a0: 6163 6b73 3120 3d20 7077 7328 6363 5f61  acks1 = pws(cc_a
-000095b0: 7272 6179 2c20 7361 6d70 5f66 7265 7129  rray, samp_freq)
-000095c0: 0a20 2020 2020 2020 2065 6c69 6620 736d  .        elif sm
-000095d0: 6574 686f 6420 3d3d 2022 726f 6275 7374  ethod == "robust
-000095e0: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
-000095f0: 6c6c 7374 6163 6b73 312c 2077 2c20 6e73  llstacks1, w, ns
-00009600: 7465 7020 3d20 726f 6275 7374 5f73 7461  tep = robust_sta
-00009610: 636b 2863 635f 6172 7261 792c 2030 2e30  ck(cc_array, 0.0
-00009620: 3031 290a 2020 2020 2020 2020 656c 6966  01).        elif
-00009630: 2073 6d65 7468 6f64 203d 3d20 2261 7574   smethod == "aut
-00009640: 6f5f 636f 7661 7269 616e 6365 223a 0a20  o_covariance":. 
-00009650: 2020 2020 2020 2020 2020 2061 6c6c 7374             allst
-00009660: 6163 6b73 3120 3d20 6164 6170 7469 7665  acks1 = adaptive
-00009670: 5f66 696c 7465 7228 6363 5f61 7272 6179  _filter(cc_array
-00009680: 2c20 3129 0a20 2020 2020 2020 2065 6c69  , 1).        eli
-00009690: 6620 736d 6574 686f 6420 3d3d 2022 6e72  f smethod == "nr
-000096a0: 6f6f 7422 3a0a 2020 2020 2020 2020 2020  oot":.          
-000096b0: 2020 616c 6c73 7461 636b 7331 203d 206e    allstacks1 = n
-000096c0: 726f 6f74 5f73 7461 636b 2863 635f 6172  root_stack(cc_ar
-000096d0: 7261 792c 2032 290a 2020 2020 2020 2020  ray, 2).        
-000096e0: 656c 6966 2073 6d65 7468 6f64 203d 3d20  elif smethod == 
-000096f0: 2261 6c6c 223a 0a20 2020 2020 2020 2020  "all":.         
-00009700: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
-00009710: 6e70 2e6d 6561 6e28 6363 5f61 7272 6179  np.mean(cc_array
-00009720: 2c20 6178 6973 3d30 290a 2020 2020 2020  , axis=0).      
-00009730: 2020 2020 2020 616c 6c73 7461 636b 7332        allstacks2
-00009740: 203d 2070 7773 2863 635f 6172 7261 792c   = pws(cc_array,
-00009750: 2073 616d 705f 6672 6571 290a 2020 2020   samp_freq).    
-00009760: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
-00009770: 7333 2c20 772c 206e 7374 6570 203d 2072  s3, w, nstep = r
-00009780: 6f62 7573 745f 7374 6163 6b28 6363 5f61  obust_stack(cc_a
-00009790: 7272 6179 2c20 302e 3030 3129 0a20 2020  rray, 0.001).   
-000097a0: 2020 2020 206e 7374 6163 6b73 203d 206e       nstacks = n
-000097b0: 702e 7375 6d28 6363 5f6e 676f 6f64 290a  p.sum(cc_ngood).
-000097c0: 0a20 2020 2023 2067 6f6f 6420 746f 2072  .    # good to r
-000097d0: 6574 7572 6e0a 2020 2020 7265 7475 726e  eturn.    return
-000097e0: 2063 635f 6172 7261 792c 2063 635f 6e67   cc_array, cc_ng
-000097f0: 6f6f 642c 2063 635f 7469 6d65 2c20 616c  ood, cc_time, al
-00009800: 6c73 7461 636b 7331 2c20 616c 6c73 7461  lstacks1, allsta
-00009810: 636b 7332 2c20 616c 6c73 7461 636b 7333  cks2, allstacks3
-00009820: 2c20 6e73 7461 636b 730a 0a0a 6465 6620  , nstacks...def 
-00009830: 7374 6163 6b69 6e67 5f72 6d61 2863 635f  stacking_rma(cc_
-00009840: 6172 7261 792c 2063 635f 7469 6d65 2c20  array, cc_time, 
-00009850: 6363 5f6e 676f 6f64 2c20 7374 6163 6b5f  cc_ngood, stack_
-00009860: 7061 7261 293a 0a20 2020 2022 2222 0a20  para):.    """. 
-00009870: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
-00009880: 2073 7461 636b 7320 7468 6520 6372 6f73   stacks the cros
-00009890: 7320 636f 7272 656c 6174 696f 6e20 6461  s correlation da
-000098a0: 7461 2061 6363 6f72 6469 6e67 2074 6f20  ta according to 
-000098b0: 7468 6520 7573 6572 2d64 6566 696e 6564  the user-defined
-000098c0: 2073 7562 7374 6163 6b5f 6c65 6e20 7061   substack_len pa
-000098d0: 7261 6d65 7465 720a 2020 2020 5041 5241  rameter.    PARA
-000098e0: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
-000098f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00009900: 2d2d 0a20 2020 2063 635f 6172 7261 793a  --.    cc_array:
-00009910: 2032 4420 6e75 6d70 7920 666c 6f61 7433   2D numpy float3
-00009920: 3220 6d61 7472 6978 2063 6f6e 7461 696e  2 matrix contain
-00009930: 696e 6720 616c 6c20 7365 676d 656e 7465  ing all segmente
-00009940: 6420 6372 6f73 732d 636f 7272 656c 6174  d cross-correlat
-00009950: 696f 6e20 6461 7461 0a20 2020 2063 635f  ion data.    cc_
-00009960: 7469 6d65 3a20 2031 4420 6e75 6d70 7920  time:  1D numpy 
-00009970: 6172 7261 7920 6f66 2074 696d 6573 7461  array of timesta
-00009980: 6d70 7320 666f 7220 6561 6368 2073 6567  mps for each seg
-00009990: 6d65 6e74 206f 6620 6363 5f61 7272 6179  ment of cc_array
-000099a0: 0a20 2020 2063 635f 6e67 6f6f 643a 2031  .    cc_ngood: 1
-000099b0: 4420 6e75 6d70 7920 696e 7431 3620 6d61  D numpy int16 ma
-000099c0: 7472 6978 2073 686f 7769 6e67 2074 6865  trix showing the
-000099d0: 206e 756d 6265 7220 6f66 2073 6567 6d65   number of segme
-000099e0: 6e74 7320 666f 7220 6561 6368 2073 7562  nts for each sub
-000099f0: 2d73 7461 636b 2061 6e64 2f6f 7220 6675  -stack and/or fu
-00009a00: 6c6c 2073 7461 636b 0a20 2020 2073 7461  ll stack.    sta
-00009a10: 636b 5f70 6172 613a 2061 2064 6963 7420  ck_para: a dict 
-00009a20: 636f 6e74 6169 6e69 6e67 2061 6c6c 2073  containing all s
-00009a30: 7461 636b 696e 6720 7061 7261 6d65 7465  tacking paramete
-00009a40: 7273 0a20 2020 2052 4554 5552 4e53 3a0a  rs.    RETURNS:.
-00009a50: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-00009a60: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-00009a70: 635f 6172 7261 792c 2063 635f 6e67 6f6f  c_array, cc_ngoo
-00009a80: 642c 2063 635f 7469 6d65 3a20 7361 6d65  d, cc_time: same
-00009a90: 2074 6f20 7468 6520 696e 7075 7420 7061   to the input pa
-00009aa0: 7261 6d65 7465 7273 2062 7574 2077 6974  rameters but wit
-00009ab0: 6820 6162 6e6f 726d 616c 2063 726f 7373  h abnormal cross
-00009ac0: 2d63 6f72 7265 616c 7469 6f6e 7320 7265  -correaltions re
-00009ad0: 6d6f 7665 640a 2020 2020 616c 6c73 7461  moved.    allsta
-00009ae0: 636b 7331 3a20 3144 206d 6174 7269 7820  cks1: 1D matrix 
-00009af0: 6f66 2073 7461 636b 6564 2063 726f 7373  of stacked cross
-00009b00: 2d63 6f72 7265 6c61 7469 6f6e 2066 756e  -correlation fun
-00009b10: 6374 696f 6e73 206f 7665 7220 616c 6c20  ctions over all 
-00009b20: 7468 6520 7365 676d 656e 7473 0a20 2020  the segments.   
-00009b30: 206e 7374 6163 6b73 3a20 2020 206e 756d   nstacks:    num
-00009b40: 6265 7220 6f66 206f 7665 7261 6c6c 2073  ber of overall s
-00009b50: 6567 6d65 6e74 7320 666f 7220 7468 6520  egments for the 
-00009b60: 6669 6e61 6c20 7374 6163 6b73 0a20 2020  final stacks.   
-00009b70: 2022 2222 0a20 2020 2023 206c 6f61 6420   """.    # load 
-00009b80: 7573 6566 756c 2070 6172 616d 6574 6572  useful parameter
-00009b90: 7320 6672 6f6d 2064 6963 740a 2020 2020  s from dict.    
-00009ba0: 7361 6d70 5f66 7265 7120 3d20 7374 6163  samp_freq = stac
-00009bb0: 6b5f 7061 7261 5b22 7361 6d70 5f66 7265  k_para["samp_fre
-00009bc0: 7122 5d0a 2020 2020 736d 6574 686f 6420  q"].    smethod 
-00009bd0: 3d20 7374 6163 6b5f 7061 7261 5b22 7374  = stack_para["st
-00009be0: 6163 6b5f 6d65 7468 6f64 225d 0a20 2020  ack_method"].   
-00009bf0: 2072 6d61 5f73 7562 7374 6163 6b20 3d20   rma_substack = 
-00009c00: 7374 6163 6b5f 7061 7261 5b22 726d 615f  stack_para["rma_
-00009c10: 7375 6273 7461 636b 225d 0a20 2020 2072  substack"].    r
-00009c20: 6d61 5f73 7465 7020 3d20 7374 6163 6b5f  ma_step = stack_
-00009c30: 7061 7261 5b22 726d 615f 7374 6570 225d  para["rma_step"]
-00009c40: 0a20 2020 2073 7461 7274 5f64 6174 6520  .    start_date 
-00009c50: 3d20 7374 6163 6b5f 7061 7261 5b22 7374  = stack_para["st
-00009c60: 6172 745f 6461 7465 225d 0a20 2020 2065  art_date"].    e
-00009c70: 6e64 5f64 6174 6520 3d20 7374 6163 6b5f  nd_date = stack_
-00009c80: 7061 7261 5b22 656e 645f 6461 7465 225d  para["end_date"]
-00009c90: 0a20 2020 206e 7074 7320 3d20 6363 5f61  .    npts = cc_a
-00009ca0: 7272 6179 2e73 6861 7065 5b31 5d0a 0a20  rray.shape[1].. 
-00009cb0: 2020 2023 2072 656d 6f76 6520 6162 6e6f     # remove abno
-00009cc0: 726d 616c 2064 6174 610a 2020 2020 616d  rmal data.    am
-00009cd0: 706d 6178 203d 206e 702e 6d61 7828 6363  pmax = np.max(cc
-00009ce0: 5f61 7272 6179 2c20 6178 6973 3d31 290a  _array, axis=1).
-00009cf0: 2020 2020 7469 6e64 7820 3d20 6e70 2e77      tindx = np.w
-00009d00: 6865 7265 2828 616d 706d 6178 203c 2032  here((ampmax < 2
-00009d10: 3020 2a20 6e70 2e6d 6564 6961 6e28 616d  0 * np.median(am
-00009d20: 706d 6178 2929 2026 2028 616d 706d 6178  pmax)) & (ampmax
-00009d30: 203e 2030 2929 5b30 5d0a 2020 2020 6966   > 0))[0].    if
-00009d40: 206e 6f74 206c 656e 2874 696e 6478 293a   not len(tindx):
-00009d50: 0a20 2020 2020 2020 2061 6c6c 7374 6163  .        allstac
-00009d60: 6b73 3120 3d20 5b5d 0a20 2020 2020 2020  ks1 = [].       
-00009d70: 2061 6c6c 7374 6163 6b73 3220 3d20 5b5d   allstacks2 = []
-00009d80: 0a20 2020 2020 2020 206e 7374 6163 6b73  .        nstacks
-00009d90: 203d 2030 0a20 2020 2020 2020 2063 635f   = 0.        cc_
-00009da0: 6172 7261 7920 3d20 5b5d 0a20 2020 2020  array = [].     
-00009db0: 2020 2063 635f 6e67 6f6f 6420 3d20 5b5d     cc_ngood = []
-00009dc0: 0a20 2020 2020 2020 2063 635f 7469 6d65  .        cc_time
-00009dd0: 203d 205b 5d0a 2020 2020 2020 2020 7265   = [].        re
-00009de0: 7475 726e 2063 635f 6172 7261 792c 2063  turn cc_array, c
-00009df0: 635f 6e67 6f6f 642c 2063 635f 7469 6d65  c_ngood, cc_time
-00009e00: 2c20 616c 6c73 7461 636b 7331 2c20 616c  , allstacks1, al
-00009e10: 6c73 7461 636b 7332 2c20 6e73 7461 636b  lstacks2, nstack
-00009e20: 730a 2020 2020 656c 7365 3a0a 2020 2020  s.    else:.    
-00009e30: 2020 2020 2320 7265 6d6f 7665 206f 6e65      # remove one
-00009e40: 7320 7769 7468 2062 6164 2061 6d70 6c69  s with bad ampli
-00009e50: 7475 6465 0a20 2020 2020 2020 2063 635f  tude.        cc_
-00009e60: 6172 7261 7920 3d20 6363 5f61 7272 6179  array = cc_array
-00009e70: 5b74 696e 6478 2c20 3a5d 0a20 2020 2020  [tindx, :].     
-00009e80: 2020 2063 635f 7469 6d65 203d 2063 635f     cc_time = cc_
-00009e90: 7469 6d65 5b74 696e 6478 5d0a 2020 2020  time[tindx].    
-00009ea0: 2020 2020 6363 5f6e 676f 6f64 203d 2063      cc_ngood = c
-00009eb0: 635f 6e67 6f6f 645b 7469 6e64 785d 0a0a  c_ngood[tindx]..
-00009ec0: 2020 2020 2020 2020 2320 646f 2073 7562          # do sub
-00009ed0: 7374 6163 6b73 0a20 2020 2020 2020 2069  stacks.        i
-00009ee0: 6620 726d 615f 7375 6273 7461 636b 3a0a  f rma_substack:.
-00009ef0: 2020 2020 2020 2020 2020 2020 7473 7461              tsta
-00009f00: 7274 203d 206f 6273 7079 2e55 5443 4461  rt = obspy.UTCDa
-00009f10: 7465 5469 6d65 2873 7461 7274 5f64 6174  teTime(start_dat
-00009f20: 6529 202d 206f 6273 7079 2e55 5443 4461  e) - obspy.UTCDa
-00009f30: 7465 5469 6d65 2831 3937 302c 2031 2c20  teTime(1970, 1, 
-00009f40: 3129 0a20 2020 2020 2020 2020 2020 2074  1).            t
-00009f50: 656e 6420 3d20 6f62 7370 792e 5554 4344  end = obspy.UTCD
-00009f60: 6174 6554 696d 6528 656e 645f 6461 7465  ateTime(end_date
-00009f70: 2920 2d20 6f62 7370 792e 5554 4344 6174  ) - obspy.UTCDat
-00009f80: 6554 696d 6528 3139 3730 2c20 312c 2031  eTime(1970, 1, 1
-00009f90: 290a 2020 2020 2020 2020 2020 2020 7474  ).            tt
-00009fa0: 696d 6520 3d20 7473 7461 7274 0a20 2020  ime = tstart.   
-00009fb0: 2020 2020 2020 2020 206e 7374 6163 6b20           nstack 
-00009fc0: 3d20 696e 7428 6e70 2e72 6f75 6e64 2828  = int(np.round((
-00009fd0: 7465 6e64 202d 2074 7374 6172 7429 202f  tend - tstart) /
-00009fe0: 2028 726d 615f 7374 6570 202a 2033 3630   (rma_step * 360
-00009ff0: 3029 2929 0a20 2020 2020 2020 2020 2020  0))).           
-0000a000: 206e 6363 5f61 7272 6179 203d 206e 702e   ncc_array = np.
-0000a010: 7a65 726f 7328 7368 6170 653d 286e 7374  zeros(shape=(nst
-0000a020: 6163 6b2c 206e 7074 7329 2c20 6474 7970  ack, npts), dtyp
-0000a030: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
-0000a040: 2020 2020 2020 2020 2020 6e63 635f 7469            ncc_ti
-0000a050: 6d65 203d 206e 702e 7a65 726f 7328 6e73  me = np.zeros(ns
-0000a060: 7461 636b 2c20 6474 7970 653d 6e70 2e66  tack, dtype=np.f
-0000a070: 6c6f 6174 290a 2020 2020 2020 2020 2020  loat).          
-0000a080: 2020 6e63 635f 6e67 6f6f 6420 3d20 6e70    ncc_ngood = np
-0000a090: 2e7a 6572 6f73 286e 7374 6163 6b2c 2064  .zeros(nstack, d
-0000a0a0: 7479 7065 3d6e 702e 696e 7429 0a0a 2020  type=np.int)..  
-0000a0b0: 2020 2020 2020 2020 2020 2320 6c6f 6f70            # loop
-0000a0c0: 2074 6872 6f75 6768 2065 6163 6820 7469   through each ti
-0000a0d0: 6d65 0a20 2020 2020 2020 2020 2020 2066  me.            f
-0000a0e0: 6f72 2069 6920 696e 2072 616e 6765 286e  or ii in range(n
-0000a0f0: 7374 6163 6b29 3a0a 2020 2020 2020 2020  stack):.        
-0000a100: 2020 2020 2020 2020 7369 6e64 7820 3d20          sindx = 
-0000a110: 6e70 2e77 6865 7265 2828 6363 5f74 696d  np.where((cc_tim
-0000a120: 6520 3e3d 2074 7469 6d65 2920 2620 2863  e >= ttime) & (c
-0000a130: 635f 7469 6d65 203c 2074 7469 6d65 202b  c_time < ttime +
-0000a140: 2072 6d61 5f73 7562 7374 6163 6b20 2a20   rma_substack * 
-0000a150: 3336 3030 2929 5b30 5d0a 0a20 2020 2020  3600))[0]..     
-0000a160: 2020 2020 2020 2020 2020 2023 2077 6865             # whe
-0000a170: 6e20 7468 6572 6520 6172 6520 6461 7461  n there are data
-0000a180: 2069 6e20 7468 6520 7469 6d65 2077 696e   in the time win
-0000a190: 646f 770a 2020 2020 2020 2020 2020 2020  dow.            
-0000a1a0: 2020 2020 6966 206c 656e 2873 696e 6478      if len(sindx
-0000a1b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000a1c0: 2020 2020 2020 206e 6363 5f61 7272 6179         ncc_array
-0000a1d0: 5b69 695d 203d 206e 702e 6d65 616e 2863  [ii] = np.mean(c
-0000a1e0: 635f 6172 7261 795b 7369 6e64 785d 2c20  c_array[sindx], 
-0000a1f0: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-0000a200: 2020 2020 2020 2020 2020 2020 6e63 635f              ncc_
-0000a210: 7469 6d65 5b69 695d 203d 2074 7469 6d65  time[ii] = ttime
-0000a220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a230: 2020 2020 206e 6363 5f6e 676f 6f64 5b69       ncc_ngood[i
-0000a240: 695d 203d 206e 702e 7375 6d28 6363 5f6e  i] = np.sum(cc_n
-0000a250: 676f 6f64 5b73 696e 6478 5d2c 2061 7869  good[sindx], axi
-0000a260: 733d 3029 0a20 2020 2020 2020 2020 2020  s=0).           
-0000a270: 2020 2020 2074 7469 6d65 202b 3d20 726d       ttime += rm
-0000a280: 615f 7374 6570 202a 2033 3630 300a 0a20  a_step * 3600.. 
-0000a290: 2020 2020 2020 2020 2020 2023 2072 656d             # rem
-0000a2a0: 6f76 6520 6261 6420 6f6e 6573 0a20 2020  ove bad ones.   
-0000a2b0: 2020 2020 2020 2020 2074 696e 6478 203d           tindx =
-0000a2c0: 206e 702e 7768 6572 6528 6e63 635f 6e67   np.where(ncc_ng
-0000a2d0: 6f6f 6420 3e20 3029 5b30 5d0a 2020 2020  ood > 0)[0].    
-0000a2e0: 2020 2020 2020 2020 6e63 635f 6172 7261          ncc_arra
-0000a2f0: 7920 3d20 6e63 635f 6172 7261 795b 7469  y = ncc_array[ti
-0000a300: 6e64 785d 0a20 2020 2020 2020 2020 2020  ndx].           
-0000a310: 206e 6363 5f74 696d 6520 3d20 6e63 635f   ncc_time = ncc_
-0000a320: 7469 6d65 5b74 696e 6478 5d0a 2020 2020  time[tindx].    
-0000a330: 2020 2020 2020 2020 6e63 635f 6e67 6f6f          ncc_ngoo
-0000a340: 6420 3d20 6e63 635f 6e67 6f6f 645b 7469  d = ncc_ngood[ti
-0000a350: 6e64 785d 0a0a 2020 2020 2020 2020 2320  ndx]..        # 
-0000a360: 646f 2073 7461 636b 696e 670a 2020 2020  do stacking.    
-0000a370: 2020 2020 616c 6c73 7461 636b 7331 203d      allstacks1 =
-0000a380: 206e 702e 7a65 726f 7328 6e70 7473 2c20   np.zeros(npts, 
-0000a390: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
-0000a3a0: 290a 2020 2020 2020 2020 616c 6c73 7461  ).        allsta
-0000a3b0: 636b 7332 203d 206e 702e 7a65 726f 7328  cks2 = np.zeros(
-0000a3c0: 6e70 7473 2c20 6474 7970 653d 6e70 2e66  npts, dtype=np.f
-0000a3d0: 6c6f 6174 3332 290a 2020 2020 2020 2020  loat32).        
-0000a3e0: 616c 6c73 7461 636b 7333 203d 206e 702e  allstacks3 = np.
-0000a3f0: 7a65 726f 7328 6e70 7473 2c20 6474 7970  zeros(npts, dtyp
-0000a400: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
-0000a410: 2020 2020 2020 616c 6c73 7461 636b 7334        allstacks4
-0000a420: 203d 206e 702e 7a65 726f 7328 6e70 7473   = np.zeros(npts
-0000a430: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
-0000a440: 3332 290a 0a20 2020 2020 2020 2069 6620  32)..        if 
-0000a450: 736d 6574 686f 6420 3d3d 2022 6c69 6e65  smethod == "line
-0000a460: 6172 223a 0a20 2020 2020 2020 2020 2020  ar":.           
-0000a470: 2061 6c6c 7374 6163 6b73 3120 3d20 6e70   allstacks1 = np
-0000a480: 2e6d 6561 6e28 6363 5f61 7272 6179 2c20  .mean(cc_array, 
-0000a490: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
-0000a4a0: 656c 6966 2073 6d65 7468 6f64 203d 3d20  elif smethod == 
-0000a4b0: 2270 7773 223a 0a20 2020 2020 2020 2020  "pws":.         
-0000a4c0: 2020 2061 6c6c 7374 6163 6b73 3120 3d20     allstacks1 = 
-0000a4d0: 7077 7328 6363 5f61 7272 6179 2c20 7361  pws(cc_array, sa
-0000a4e0: 6d70 5f66 7265 7129 0a20 2020 2020 2020  mp_freq).       
-0000a4f0: 2065 6c69 6620 736d 6574 686f 6420 3d3d   elif smethod ==
-0000a500: 2022 726f 6275 7374 223a 0a20 2020 2020   "robust":.     
-0000a510: 2020 2020 2020 2028 0a20 2020 2020 2020         (.       
-0000a520: 2020 2020 2020 2020 2061 6c6c 7374 6163           allstac
-0000a530: 6b73 312c 0a20 2020 2020 2020 2020 2020  ks1,.           
-0000a540: 2020 2020 2077 2c0a 2020 2020 2020 2020       w,.        
-0000a550: 2020 2020 2920 3d20 726f 6275 7374 5f73      ) = robust_s
-0000a560: 7461 636b 2863 635f 6172 7261 792c 2030  tack(cc_array, 0
-0000a570: 2e30 3031 290a 2020 2020 2020 2020 656c  .001).        el
-0000a580: 6966 2073 6d65 7468 6f64 203d 3d20 2273  if smethod == "s
-0000a590: 656c 6563 7469 7665 223a 0a20 2020 2020  elective":.     
-0000a5a0: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
-0000a5b0: 3120 3d20 7365 6c65 6374 6976 655f 7374  1 = selective_st
-0000a5c0: 6163 6b28 6363 5f61 7272 6179 2c20 302e  ack(cc_array, 0.
-0000a5d0: 3030 3129 0a20 2020 2020 2020 2065 6c69  001).        eli
-0000a5e0: 6620 736d 6574 686f 6420 3d3d 2022 616c  f smethod == "al
-0000a5f0: 6c22 3a0a 2020 2020 2020 2020 2020 2020  l":.            
-0000a600: 616c 6c73 7461 636b 7331 203d 206e 702e  allstacks1 = np.
-0000a610: 6d65 616e 2863 635f 6172 7261 792c 2061  mean(cc_array, a
-0000a620: 7869 733d 3029 0a20 2020 2020 2020 2020  xis=0).         
-0000a630: 2020 2061 6c6c 7374 6163 6b73 3220 3d20     allstacks2 = 
-0000a640: 7077 7328 6363 5f61 7272 6179 2c20 7361  pws(cc_array, sa
-0000a650: 6d70 5f66 7265 7129 0a20 2020 2020 2020  mp_freq).       
-0000a660: 2020 2020 2061 6c6c 7374 6163 6b73 3320       allstacks3 
-0000a670: 3d20 726f 6275 7374 5f73 7461 636b 2863  = robust_stack(c
-0000a680: 635f 6172 7261 792c 2030 2e30 3031 290a  c_array, 0.001).
-0000a690: 2020 2020 2020 2020 2020 2020 616c 6c73              alls
-0000a6a0: 7461 636b 7334 203d 2073 656c 6563 7469  tacks4 = selecti
-0000a6b0: 7665 5f73 7461 636b 2863 635f 6172 7261  ve_stack(cc_arra
-0000a6c0: 792c 2030 2e30 3031 290a 2020 2020 2020  y, 0.001).      
-0000a6d0: 2020 6e73 7461 636b 7320 3d20 6e70 2e73    nstacks = np.s
-0000a6e0: 756d 2863 635f 6e67 6f6f 6429 0a0a 2020  um(cc_ngood)..  
-0000a6f0: 2020 2320 7265 706c 6163 6520 7468 6520    # replace the 
-0000a700: 6172 7261 7920 666f 7220 7375 6273 7461  array for substa
-0000a710: 636b 730a 2020 2020 6966 2072 6d61 5f73  cks.    if rma_s
-0000a720: 7562 7374 6163 6b3a 0a20 2020 2020 2020  ubstack:.       
-0000a730: 2063 635f 6172 7261 7920 3d20 6e63 635f   cc_array = ncc_
-0000a740: 6172 7261 790a 2020 2020 2020 2020 6363  array.        cc
-0000a750: 5f74 696d 6520 3d20 6e63 635f 7469 6d65  _time = ncc_time
-0000a760: 0a20 2020 2020 2020 2063 635f 6e67 6f6f  .        cc_ngoo
-0000a770: 6420 3d20 6e63 635f 6e67 6f6f 640a 0a20  d = ncc_ngood.. 
-0000a780: 2020 2023 2067 6f6f 6420 746f 2072 6574     # good to ret
-0000a790: 7572 6e0a 2020 2020 7265 7475 726e 2028  urn.    return (
-0000a7a0: 0a20 2020 2020 2020 2063 635f 6172 7261  .        cc_arra
-0000a7b0: 792c 0a20 2020 2020 2020 2063 635f 6e67  y,.        cc_ng
-0000a7c0: 6f6f 642c 0a20 2020 2020 2020 2063 635f  ood,.        cc_
-0000a7d0: 7469 6d65 2c0a 2020 2020 2020 2020 616c  time,.        al
-0000a7e0: 6c73 7461 636b 7331 2c0a 2020 2020 2020  lstacks1,.      
-0000a7f0: 2020 616c 6c73 7461 636b 7332 2c0a 2020    allstacks2,.  
-0000a800: 2020 2020 2020 616c 6c73 7461 636b 7333        allstacks3
-0000a810: 2c0a 2020 2020 2020 2020 616c 6c73 7461  ,.        allsta
-0000a820: 636b 7334 2c0a 2020 2020 2020 2020 6e73  cks4,.        ns
-0000a830: 7461 636b 732c 0a20 2020 2029 0a0a 0a64  tacks,.    )...d
-0000a840: 6566 2072 6f74 6174 696f 6e28 6269 6773  ef rotation(bigs
-0000a850: 7461 636b 2c20 7061 7261 6d65 7465 7273  tack, parameters
-0000a860: 2c20 6c6f 6373 293a 0a20 2020 2022 2222  , locs):.    """
-0000a870: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-0000a880: 6f6e 2074 7261 6e73 6665 7273 2074 6865  on transfers the
-0000a890: 2047 7265 656e 2773 2074 656e 736f 7220   Green's tensor 
-0000a8a0: 6672 6f6d 2061 2045 2d4e 2d5a 2073 7973  from a E-N-Z sys
-0000a8b0: 7465 6d20 696e 746f 2061 2052 2d54 2d5a  tem into a R-T-Z
-0000a8c0: 206f 6e65 0a0a 2020 2020 5041 5241 4d45   one..    PARAME
-0000a8d0: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
-0000a8e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0000a8f0: 2020 6269 6773 7461 636b 3a20 2020 3920    bigstack:   9 
-0000a900: 636f 6d70 6f6e 656e 7420 4772 6565 6e27  component Green'
-0000a910: 7320 7465 6e73 6f72 2069 6e20 452d 4e2d  s tensor in E-N-
-0000a920: 5a20 7379 7374 656d 0a20 2020 2070 6172  Z system.    par
-0000a930: 616d 6574 6572 733a 2064 6963 7420 636f  ameters: dict co
-0000a940: 6e74 6169 6e69 6e67 2061 6c6c 2070 6172  ntaining all par
-0000a950: 616d 6574 6572 7320 7361 7665 6420 696e  ameters saved in
-0000a960: 2041 5344 4620 6669 6c65 0a20 2020 206c   ASDF file.    l
-0000a970: 6f63 733a 2020 2020 2020 2064 6963 7420  ocs:       dict 
-0000a980: 636f 6e74 6169 6e69 6e67 2073 7461 7469  containing stati
-0000a990: 6f6e 2061 6e67 6c65 2069 6e66 6f20 666f  on angle info fo
-0000a9a0: 7220 636f 7272 6563 7469 6f6e 2070 7572  r correction pur
-0000a9b0: 706f 7365 0a20 2020 2052 4554 5552 4e53  pose.    RETURNS
-0000a9c0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
-0000a9d0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7463  ---------.    tc
-0000a9e0: 6f72 723a 2039 2063 6f6d 706f 6e65 6e74  orr: 9 component
-0000a9f0: 2047 7265 656e 2773 2074 656e 736f 7220   Green's tensor 
-0000aa00: 696e 2052 2d54 2d5a 2073 7973 7465 6d0a  in R-T-Z system.
-0000aa10: 2020 2020 2222 220a 2020 2020 2320 6c6f      """.    # lo
-0000aa20: 6164 2070 6172 616d 6574 6572 2064 6963  ad parameter dic
-0000aa30: 0a20 2020 2070 6920 3d20 6e70 2e70 690a  .    pi = np.pi.
-0000aa40: 2020 2020 617a 6920 3d20 7061 7261 6d65      azi = parame
-0000aa50: 7465 7273 5b22 617a 6922 5d0a 2020 2020  ters["azi"].    
-0000aa60: 6261 7a20 3d20 7061 7261 6d65 7465 7273  baz = parameters
-0000aa70: 5b22 6261 7a22 5d0a 2020 2020 6e63 6f6d  ["baz"].    ncom
-0000aa80: 702c 206e 7074 7320 3d20 6269 6773 7461  p, npts = bigsta
-0000aa90: 636b 2e73 6861 7065 0a20 2020 2069 6620  ck.shape.    if 
-0000aaa0: 6e63 6f6d 7020 3c20 393a 0a20 2020 2020  ncomp < 9:.     
-0000aab0: 2020 2070 7269 6e74 2822 6372 6170 2064     print("crap d
-0000aac0: 6964 206e 6f74 2067 6574 2065 6e6f 7567  id not get enoug
-0000aad0: 6820 636f 6d70 6f6e 656e 7473 2229 0a20  h components"). 
-0000aae0: 2020 2020 2020 2074 636f 7272 203d 205b         tcorr = [
-0000aaf0: 5d0a 2020 2020 2020 2020 7265 7475 726e  ].        return
-0000ab00: 2074 636f 7272 0a20 2020 2073 7461 5320   tcorr.    staS 
-0000ab10: 3d20 7061 7261 6d65 7465 7273 5b22 7374  = parameters["st
-0000ab20: 6174 696f 6e5f 736f 7572 6365 225d 0a20  ation_source"]. 
-0000ab30: 2020 2073 7461 5220 3d20 7061 7261 6d65     staR = parame
-0000ab40: 7465 7273 5b22 7374 6174 696f 6e5f 7265  ters["station_re
-0000ab50: 6365 6976 6572 225d 0a0a 2020 2020 6966  ceiver"]..    if
-0000ab60: 206c 656e 286c 6f63 7329 3a0a 2020 2020   len(locs):.    
-0000ab70: 2020 2020 7374 615f 6c69 7374 203d 206c      sta_list = l
-0000ab80: 6973 7428 6c6f 6373 5b22 7374 6174 696f  ist(locs["statio
-0000ab90: 6e22 5d29 0a20 2020 2020 2020 2061 6e67  n"]).        ang
-0000aba0: 6c65 7320 3d20 6c69 7374 286c 6f63 735b  les = list(locs[
-0000abb0: 2261 6e67 6c65 225d 290a 2020 2020 2020  "angle"]).      
-0000abc0: 2020 2320 6765 7420 7374 6174 696f 6e20    # get station 
-0000abd0: 696e 666f 2066 726f 6d20 7468 6520 6e61  info from the na
-0000abe0: 6d65 206f 6620 4153 4446 2066 696c 650a  me of ASDF file.
-0000abf0: 2020 2020 2020 2020 696e 6420 3d20 7374          ind = st
-0000ac00: 615f 6c69 7374 2e69 6e64 6578 2873 7461  a_list.index(sta
-0000ac10: 5329 0a20 2020 2020 2020 2061 636f 7272  S).        acorr
-0000ac20: 203d 2061 6e67 6c65 735b 696e 645d 0a20   = angles[ind]. 
-0000ac30: 2020 2020 2020 2069 6e64 203d 2073 7461         ind = sta
-0000ac40: 5f6c 6973 742e 696e 6465 7828 7374 6152  _list.index(staR
-0000ac50: 290a 2020 2020 2020 2020 6263 6f72 7220  ).        bcorr 
-0000ac60: 3d20 616e 676c 6573 5b69 6e64 5d0a 0a20  = angles[ind].. 
-0000ac70: 2020 2023 202d 2d2d 616e 676c 6573 2074     # ---angles t
-0000ac80: 6f20 6265 2063 6f72 7265 6374 6564 2d2d  o be corrected--
-0000ac90: 2d2d 0a20 2020 2069 6620 6c65 6e28 6c6f  --.    if len(lo
-0000aca0: 6373 293a 0a20 2020 2020 2020 2063 6f73  cs):.        cos
-0000acb0: 6120 3d20 6e70 2e63 6f73 2828 617a 6920  a = np.cos((azi 
-0000acc0: 2b20 6163 6f72 7229 202a 2070 6920 2f20  + acorr) * pi / 
-0000acd0: 3138 3029 0a20 2020 2020 2020 2073 696e  180).        sin
-0000ace0: 6120 3d20 6e70 2e73 696e 2828 617a 6920  a = np.sin((azi 
-0000acf0: 2b20 6163 6f72 7229 202a 2070 6920 2f20  + acorr) * pi / 
-0000ad00: 3138 3029 0a20 2020 2020 2020 2063 6f73  180).        cos
-0000ad10: 6220 3d20 6e70 2e63 6f73 2828 6261 7a20  b = np.cos((baz 
-0000ad20: 2b20 6263 6f72 7229 202a 2070 6920 2f20  + bcorr) * pi / 
-0000ad30: 3138 3029 0a20 2020 2020 2020 2073 696e  180).        sin
-0000ad40: 6220 3d20 6e70 2e73 696e 2828 6261 7a20  b = np.sin((baz 
-0000ad50: 2b20 6263 6f72 7229 202a 2070 6920 2f20  + bcorr) * pi / 
-0000ad60: 3138 3029 0a20 2020 2065 6c73 653a 0a20  180).    else:. 
-0000ad70: 2020 2020 2020 2063 6f73 6120 3d20 6e70         cosa = np
-0000ad80: 2e63 6f73 2861 7a69 202a 2070 6920 2f20  .cos(azi * pi / 
-0000ad90: 3138 3029 0a20 2020 2020 2020 2073 696e  180).        sin
-0000ada0: 6120 3d20 6e70 2e73 696e 2861 7a69 202a  a = np.sin(azi *
-0000adb0: 2070 6920 2f20 3138 3029 0a20 2020 2020   pi / 180).     
-0000adc0: 2020 2063 6f73 6220 3d20 6e70 2e63 6f73     cosb = np.cos
-0000add0: 2862 617a 202a 2070 6920 2f20 3138 3029  (baz * pi / 180)
-0000ade0: 0a20 2020 2020 2020 2073 696e 6220 3d20  .        sinb = 
-0000adf0: 6e70 2e73 696e 2862 617a 202a 2070 6920  np.sin(baz * pi 
-0000ae00: 2f20 3138 3029 0a0a 2020 2020 2320 7274  / 180)..    # rt
-0000ae10: 7a5f 636f 6d70 6f6e 656e 7473 203d 205b  z_components = [
-0000ae20: 275a 5227 2c27 5a54 272c 275a 5a27 2c27  'ZR','ZT','ZZ','
-0000ae30: 5252 272c 2752 5427 2c27 525a 272c 2754  RR','RT','RZ','T
-0000ae40: 5227 2c27 5454 272c 2754 5a27 5d0a 2020  R','TT','TZ'].  
-0000ae50: 2020 7463 6f72 7220 3d20 6e70 2e7a 6572    tcorr = np.zer
-0000ae60: 6f73 2873 6861 7065 3d28 392c 206e 7074  os(shape=(9, npt
-0000ae70: 7329 2c20 6474 7970 653d 6e70 2e66 6c6f  s), dtype=np.flo
-0000ae80: 6174 3332 290a 2020 2020 7463 6f72 725b  at32).    tcorr[
-0000ae90: 305d 203d 202d 636f 7362 202a 2062 6967  0] = -cosb * big
-0000aea0: 7374 6163 6b5b 375d 202d 2073 696e 6220  stack[7] - sinb 
-0000aeb0: 2a20 6269 6773 7461 636b 5b36 5d0a 2020  * bigstack[6].  
-0000aec0: 2020 7463 6f72 725b 315d 203d 2073 696e    tcorr[1] = sin
-0000aed0: 6220 2a20 6269 6773 7461 636b 5b37 5d20  b * bigstack[7] 
-0000aee0: 2d20 636f 7362 202a 2062 6967 7374 6163  - cosb * bigstac
-0000aef0: 6b5b 365d 0a20 2020 2074 636f 7272 5b32  k[6].    tcorr[2
-0000af00: 5d20 3d20 6269 6773 7461 636b 5b38 5d0a  ] = bigstack[8].
-0000af10: 2020 2020 7463 6f72 725b 335d 203d 2028      tcorr[3] = (
-0000af20: 0a20 2020 2020 2020 202d 636f 7361 202a  .        -cosa *
-0000af30: 2063 6f73 6220 2a20 6269 6773 7461 636b   cosb * bigstack
-0000af40: 5b34 5d20 2d20 636f 7361 202a 2073 696e  [4] - cosa * sin
-0000af50: 6220 2a20 6269 6773 7461 636b 5b33 5d20  b * bigstack[3] 
-0000af60: 2d20 7369 6e61 202a 2063 6f73 6220 2a20  - sina * cosb * 
-0000af70: 6269 6773 7461 636b 5b31 5d20 2d20 7369  bigstack[1] - si
-0000af80: 6e61 202a 2073 696e 6220 2a20 6269 6773  na * sinb * bigs
-0000af90: 7461 636b 5b30 5d0a 2020 2020 290a 2020  tack[0].    ).  
-0000afa0: 2020 7463 6f72 725b 345d 203d 2028 0a20    tcorr[4] = (. 
-0000afb0: 2020 2020 2020 2063 6f73 6120 2a20 7369         cosa * si
-0000afc0: 6e62 202a 2062 6967 7374 6163 6b5b 345d  nb * bigstack[4]
-0000afd0: 202d 2063 6f73 6120 2a20 636f 7362 202a   - cosa * cosb *
-0000afe0: 2062 6967 7374 6163 6b5b 335d 202b 2073   bigstack[3] + s
-0000aff0: 696e 6120 2a20 7369 6e62 202a 2062 6967  ina * sinb * big
-0000b000: 7374 6163 6b5b 315d 202d 2073 696e 6120  stack[1] - sina 
-0000b010: 2a20 636f 7362 202a 2062 6967 7374 6163  * cosb * bigstac
-0000b020: 6b5b 305d 0a20 2020 2029 0a20 2020 2074  k[0].    ).    t
-0000b030: 636f 7272 5b35 5d20 3d20 636f 7361 202a  corr[5] = cosa *
-0000b040: 2062 6967 7374 6163 6b5b 355d 202b 2073   bigstack[5] + s
-0000b050: 696e 6120 2a20 6269 6773 7461 636b 5b32  ina * bigstack[2
-0000b060: 5d0a 2020 2020 7463 6f72 725b 365d 203d  ].    tcorr[6] =
-0000b070: 2028 0a20 2020 2020 2020 2073 696e 6120   (.        sina 
-0000b080: 2a20 636f 7362 202a 2062 6967 7374 6163  * cosb * bigstac
-0000b090: 6b5b 345d 202b 2073 696e 6120 2a20 7369  k[4] + sina * si
-0000b0a0: 6e62 202a 2062 6967 7374 6163 6b5b 335d  nb * bigstack[3]
-0000b0b0: 202d 2063 6f73 6120 2a20 636f 7362 202a   - cosa * cosb *
-0000b0c0: 2062 6967 7374 6163 6b5b 315d 202d 2063   bigstack[1] - c
-0000b0d0: 6f73 6120 2a20 7369 6e62 202a 2062 6967  osa * sinb * big
-0000b0e0: 7374 6163 6b5b 305d 0a20 2020 2029 0a20  stack[0].    ). 
-0000b0f0: 2020 2074 636f 7272 5b37 5d20 3d20 280a     tcorr[7] = (.
-0000b100: 2020 2020 2020 2020 2d73 696e 6120 2a20          -sina * 
-0000b110: 7369 6e62 202a 2062 6967 7374 6163 6b5b  sinb * bigstack[
-0000b120: 345d 202b 2073 696e 6120 2a20 636f 7362  4] + sina * cosb
-0000b130: 202a 2062 6967 7374 6163 6b5b 335d 202b   * bigstack[3] +
-0000b140: 2063 6f73 6120 2a20 7369 6e62 202a 2062   cosa * sinb * b
-0000b150: 6967 7374 6163 6b5b 315d 202d 2063 6f73  igstack[1] - cos
-0000b160: 6120 2a20 636f 7362 202a 2062 6967 7374  a * cosb * bigst
-0000b170: 6163 6b5b 305d 0a20 2020 2029 0a20 2020  ack[0].    ).   
-0000b180: 2074 636f 7272 5b38 5d20 3d20 2d73 696e   tcorr[8] = -sin
-0000b190: 6120 2a20 6269 6773 7461 636b 5b35 5d20  a * bigstack[5] 
-0000b1a0: 2b20 636f 7361 202a 2062 6967 7374 6163  + cosa * bigstac
-0000b1b0: 6b5b 325d 0a0a 2020 2020 7265 7475 726e  k[2]..    return
-0000b1c0: 2074 636f 7272 0a0a 0a23 2323 2323 2323   tcorr...#######
-0000b1d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b1e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b1f0: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
-0000b200: 2323 2323 2323 2323 2323 2323 2055 5449  ############ UTI
-0000b210: 4c49 5459 2046 554e 4354 494f 4e53 2023  LITY FUNCTIONS #
-0000b220: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b230: 2323 0a23 2323 2323 2323 2323 2323 2323  ##.#############
-0000b240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000b260: 2323 2323 2323 230a 0a0a 6465 6620 6368  #######...def ch
-0000b270: 6563 6b5f 7361 6d70 6c65 5f67 6170 7328  eck_sample_gaps(
-0000b280: 7374 7265 616d 3a20 6f62 7370 792e 5374  stream: obspy.St
-0000b290: 7265 616d 2c20 7374 6172 7474 696d 653a  ream, starttime:
-0000b2a0: 206f 6273 7079 2e55 5443 4461 7465 5469   obspy.UTCDateTi
-0000b2b0: 6d65 2c20 656e 6474 696d 653a 206f 6273  me, endtime: obs
-0000b2c0: 7079 2e55 5443 4461 7465 5469 6d65 293a  py.UTCDateTime):
-0000b2d0: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
-0000b2e0: 7320 6675 6e63 7469 6f6e 2063 6865 636b  s function check
-0000b2f0: 7320 7361 6d70 6c69 6e67 2072 6174 6520  s sampling rate 
-0000b300: 616e 6420 6669 6e64 2067 6170 7320 6f66  and find gaps of
-0000b310: 2061 6c6c 2074 7261 6365 7320 696e 2073   all traces in s
-0000b320: 7472 6561 6d2e 0a20 2020 2050 4152 414d  tream..    PARAM
-0000b330: 4554 4552 533a 0a20 2020 202d 2d2d 2d2d  ETERS:.    -----
-0000b340: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0000b350: 2073 7472 6561 6d3a 206f 6273 7079 2073   stream: obspy s
-0000b360: 7472 6561 6d20 6f62 6a65 6374 2e0a 2020  tream object..  
-0000b370: 2020 6461 7465 5f69 6e66 6f3a 2064 6963    date_info: dic
-0000b380: 7420 6f66 2073 7461 7274 696e 6720 616e  t of starting an
-0000b390: 6420 656e 6469 6e67 2074 696d 6520 6f66  d ending time of
-0000b3a0: 2074 6865 2073 7472 6561 6d0a 0a20 2020   the stream..   
-0000b3b0: 2052 4554 5552 454e 533a 0a20 2020 202d   RETURENS:.    -
-0000b3c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000b3d0: 0a20 2020 2073 7472 6561 6d3a 204c 6973  .    stream: Lis
-0000b3e0: 7420 6f66 2067 6f6f 6420 7472 6163 6573  t of good traces
-0000b3f0: 2069 6e20 7468 6520 7374 7265 616d 0a20   in the stream. 
-0000b400: 2020 2022 2222 0a20 2020 2023 2072 656d     """.    # rem
-0000b410: 6f76 6520 656d 7074 792f 6269 6720 7472  ove empty/big tr
-0000b420: 6163 6573 0a20 2020 2069 6620 6c65 6e28  aces.    if len(
-0000b430: 7374 7265 616d 2920 3d3d 2030 206f 7220  stream) == 0 or 
-0000b440: 6c65 6e28 7374 7265 616d 2920 3e20 3130  len(stream) > 10
-0000b450: 303a 0a20 2020 2020 2020 2073 7472 6561  0:.        strea
-0000b460: 6d20 3d20 5b5d 0a20 2020 2020 2020 2072  m = [].        r
-0000b470: 6574 7572 6e20 7374 7265 616d 0a0a 2020  eturn stream..  
-0000b480: 2020 2320 7265 6d6f 7665 2074 7261 6365    # remove trace
-0000b490: 7320 7769 7468 2062 6967 2067 6170 730a  s with big gaps.
-0000b4a0: 2020 2020 6966 2070 6f72 7469 6f6e 5f67      if portion_g
-0000b4b0: 6170 7328 7374 7265 616d 2c20 7374 6172  aps(stream, star
-0000b4c0: 7474 696d 652c 2065 6e64 7469 6d65 2920  ttime, endtime) 
-0000b4d0: 3e20 302e 333a 0a20 2020 2020 2020 2073  > 0.3:.        s
-0000b4e0: 7472 6561 6d20 3d20 5b5d 0a20 2020 2020  tream = [].     
-0000b4f0: 2020 2072 6574 7572 6e20 7374 7265 616d     return stream
-0000b500: 0a0a 2020 2020 6672 6571 7320 3d20 5b5d  ..    freqs = []
-0000b510: 0a20 2020 2066 6f72 2074 7220 696e 2073  .    for tr in s
-0000b520: 7472 6561 6d3a 0a20 2020 2020 2020 2066  tream:.        f
-0000b530: 7265 7173 2e61 7070 656e 6428 696e 7428  reqs.append(int(
-0000b540: 7472 2e73 7461 7473 2e73 616d 706c 696e  tr.stats.samplin
-0000b550: 675f 7261 7465 2929 0a20 2020 2066 7265  g_rate)).    fre
-0000b560: 7120 3d20 6d61 7828 6672 6571 7329 0a20  q = max(freqs). 
-0000b570: 2020 2066 6f72 2074 7220 696e 2073 7472     for tr in str
-0000b580: 6561 6d3a 0a20 2020 2020 2020 2069 6620  eam:.        if 
-0000b590: 696e 7428 7472 2e73 7461 7473 2e73 616d  int(tr.stats.sam
-0000b5a0: 706c 696e 675f 7261 7465 2920 213d 2066  pling_rate) != f
-0000b5b0: 7265 713a 0a20 2020 2020 2020 2020 2020  req:.           
-0000b5c0: 2073 7472 6561 6d2e 7265 6d6f 7665 2874   stream.remove(t
-0000b5d0: 7229 0a20 2020 2020 2020 2069 6620 7472  r).        if tr
-0000b5e0: 2e73 7461 7473 2e6e 7074 7320 3c20 3130  .stats.npts < 10
-0000b5f0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0000b600: 7265 616d 2e72 656d 6f76 6528 7472 290a  ream.remove(tr).
-0000b610: 0a20 2020 2072 6574 7572 6e20 7374 7265  .    return stre
-0000b620: 616d 0a0a 0a64 6566 2070 6f72 7469 6f6e  am...def portion
-0000b630: 5f67 6170 7328 7374 7265 616d 2c20 7374  _gaps(stream, st
-0000b640: 6172 7474 696d 653a 206f 6273 7079 2e55  arttime: obspy.U
-0000b650: 5443 4461 7465 5469 6d65 2c20 656e 6474  TCDateTime, endt
-0000b660: 696d 653a 206f 6273 7079 2e55 5443 4461  ime: obspy.UTCDa
-0000b670: 7465 5469 6d65 293a 0a20 2020 2022 2222  teTime):.    """
-0000b680: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-0000b690: 6f6e 2074 7261 636b 7320 7468 6520 6761  on tracks the ga
-0000b6a0: 7073 2028 6e70 7473 2920 6672 6f6d 2074  ps (npts) from t
-0000b6b0: 6865 2061 6363 756d 756c 6174 6564 2064  he accumulated d
-0000b6c0: 6966 6665 7265 6e63 6520 6265 7477 6565  ifference betwee
-0000b6d0: 6e20 7374 6172 7474 696d 6520 616e 6420  n starttime and 
-0000b6e0: 656e 6474 696d 650a 2020 2020 6f66 2065  endtime.    of e
-0000b6f0: 6163 6820 7374 7265 616d 2074 7261 6365  ach stream trace
-0000b700: 2e20 6974 2072 656d 6f76 6573 2074 7261  . it removes tra
-0000b710: 6365 2077 6974 6820 6761 7020 6c65 6e67  ce with gap leng
-0000b720: 7468 203e 2033 3025 206f 6620 7472 6163  th > 30% of trac
-0000b730: 6520 7369 7a65 2e0a 2020 2020 5041 5241  e size..    PARA
-0000b740: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
-0000b750: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-0000b760: 2020 2020 7374 7265 616d 3a20 6f62 7370      stream: obsp
-0000b770: 7920 7374 7265 616d 206f 626a 6563 740a  y stream object.
-0000b780: 2020 2020 6461 7465 5f69 6e66 6f3a 2064      date_info: d
-0000b790: 6963 7420 6f66 2073 7461 7274 696e 6720  ict of starting 
-0000b7a0: 616e 6420 656e 6469 6e67 2074 696d 6520  and ending time 
-0000b7b0: 6f66 2074 6865 2073 7472 6561 6d0a 0a20  of the stream.. 
-0000b7c0: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
-0000b7d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000b7e0: 2d0a 2020 2020 7067 6170 733a 2070 726f  -.    pgaps: pro
-0000b7f0: 706f 7274 696f 6e20 6f66 2067 6170 732f  portion of gaps/
-0000b800: 616c 6c5f 7074 7320 696e 2073 7472 6561  all_pts in strea
-0000b810: 6d0a 2020 2020 2222 220a 2020 2020 2320  m.    """.    # 
-0000b820: 6964 6561 6c20 6475 7261 7469 6f6e 206f  ideal duration o
-0000b830: 6620 6461 7461 0a20 2020 206e 7074 7320  f data.    npts 
-0000b840: 3d20 2865 6e64 7469 6d65 202d 2073 7461  = (endtime - sta
-0000b850: 7274 7469 6d65 2920 2a20 7374 7265 616d  rttime) * stream
-0000b860: 5b30 5d2e 7374 6174 732e 7361 6d70 6c69  [0].stats.sampli
-0000b870: 6e67 5f72 6174 650a 0a20 2020 2070 6761  ng_rate..    pga
-0000b880: 7073 203d 2030 0a20 2020 2023 206c 6f6f  ps = 0.    # loo
-0000b890: 7020 7468 726f 7567 6820 616c 6c20 7472  p through all tr
-0000b8a0: 6163 6520 746f 2061 6363 756d 756c 6174  ace to accumulat
-0000b8b0: 6520 6761 7073 0a20 2020 2066 6f72 2069  e gaps.    for i
-0000b8c0: 6920 696e 2072 616e 6765 286c 656e 2873  i in range(len(s
-0000b8d0: 7472 6561 6d29 202d 2031 293a 0a20 2020  tream) - 1):.   
-0000b8e0: 2020 2020 2070 6761 7073 202b 3d20 2873       pgaps += (s
-0000b8f0: 7472 6561 6d5b 6969 202b 2031 5d2e 7374  tream[ii + 1].st
-0000b900: 6174 732e 7374 6172 7474 696d 6520 2d20  ats.starttime - 
-0000b910: 7374 7265 616d 5b69 695d 2e73 7461 7473  stream[ii].stats
-0000b920: 2e65 6e64 7469 6d65 2920 2a20 7374 7265  .endtime) * stre
-0000b930: 616d 5b69 695d 2e73 7461 7473 2e73 616d  am[ii].stats.sam
-0000b940: 706c 696e 675f 7261 7465 0a20 2020 2069  pling_rate.    i
-0000b950: 6620 6e70 7473 2021 3d20 303a 0a20 2020  f npts != 0:.   
-0000b960: 2020 2020 2070 6761 7073 203d 2070 6761       pgaps = pga
-0000b970: 7073 202f 206e 7074 730a 2020 2020 6966  ps / npts.    if
-0000b980: 206e 7074 7320 3d3d 2030 3a0a 2020 2020   npts == 0:.    
-0000b990: 2020 2020 7067 6170 7320 3d20 310a 2020      pgaps = 1.  
-0000b9a0: 2020 7265 7475 726e 2070 6761 7073 0a0a    return pgaps..
-0000b9b0: 0a40 6a69 7428 2266 6c6f 6174 3332 5b3a  .@jit("float32[:
-0000b9c0: 5d28 666c 6f61 7433 325b 3a5d 2c66 6c6f  ](float32[:],flo
-0000b9d0: 6174 3332 2922 290a 6465 6620 7365 676d  at32)").def segm
-0000b9e0: 656e 745f 696e 7465 7270 6f6c 6174 6528  ent_interpolate(
-0000b9f0: 7369 6731 2c20 6e66 7269 6329 3a0a 2020  sig1, nfric):.  
-0000ba00: 2020 2222 220a 2020 2020 7468 6973 2066    """.    this f
-0000ba10: 756e 6374 696f 6e20 696e 7465 7270 6f6c  unction interpol
-0000ba20: 6174 6573 2074 6865 2064 6174 6120 746f  ates the data to
-0000ba30: 2065 6e73 7572 6520 616c 6c20 706f 696e   ensure all poin
-0000ba40: 7473 206c 6f63 6174 6564 206f 6e20 696e  ts located on in
-0000ba50: 7465 7267 6572 2074 696d 6573 206f 6620  terger times of 
-0000ba60: 7468 650a 2020 2020 7361 6d70 6c69 6e67  the.    sampling
-0000ba70: 2072 6174 6520 2865 2e67 2e2c 2073 7461   rate (e.g., sta
-0000ba80: 7274 7469 6d65 203d 2030 303a 3030 3a30  rttime = 00:00:0
-0000ba90: 302e 3031 352c 2064 656c 7461 203d 2030  0.015, delta = 0
-0000baa0: 2e30 352e 290a 2020 2020 5041 5241 4d45  .05.).    PARAME
-0000bab0: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+00000630: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
+00000640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000660: 2323 2323 230a 0a0a 6465 6620 6765 745f  #####...def get_
+00000670: 6576 656e 745f 6c69 7374 2864 313a 2064  event_list(d1: d
+00000680: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
+00000690: 2c20 6432 3a20 6461 7465 7469 6d65 2e64  , d2: datetime.d
+000006a0: 6174 6574 696d 652c 2069 6e63 5f68 6f75  atetime, inc_hou
+000006b0: 7273 3a20 696e 7429 3a0a 2020 2020 2222  rs: int):.    ""
+000006c0: 220a 2020 2020 7468 6973 2066 756e 6374  ".    this funct
+000006d0: 696f 6e20 6361 6c63 756c 6174 6573 2074  ion calculates t
+000006e0: 6865 2065 7665 6e74 206c 6973 7420 6265  he event list be
+000006f0: 7477 6565 6e20 7469 6d65 7320 6431 2061  tween times d1 a
+00000700: 6e64 2064 3220 6279 2069 6e63 7265 6d65  nd d2 by increme
+00000710: 6e74 206f 6620 696e 635f 686f 7572 730a  nt of inc_hours.
+00000720: 2020 2020 5041 5241 4d45 5445 5253 3a0a      PARAMETERS:.
+00000730: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+00000740: 2d2d 2d2d 0a20 2020 2073 7472 313a 2073  ----.    str1: s
+00000750: 7472 696e 6720 6f66 2074 6865 2073 7461  tring of the sta
+00000760: 7274 696e 6720 7469 6d65 202d 3e20 3230  rting time -> 20
+00000770: 3130 5f30 315f 3031 5f30 5f30 0a20 2020  10_01_01_0_0.   
+00000780: 2073 7472 323a 2073 7472 696e 6720 6f66   str2: string of
+00000790: 2074 6865 2065 6e64 696e 6720 7469 6d65   the ending time
+000007a0: 202d 3e20 3230 3130 5f31 305f 3131 5f30   -> 2010_10_11_0
+000007b0: 5f30 0a20 2020 2069 6e63 5f68 6f75 7273  _0.    inc_hours
+000007c0: 3a20 696e 7465 6765 7220 6f66 2069 6e63  : integer of inc
+000007d0: 7265 6d65 6e74 616c 2068 6f75 7273 0a20  remental hours. 
+000007e0: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
+000007f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000800: 0a20 2020 2065 7665 6e74 3a20 6120 6e75  .    event: a nu
+00000810: 6d70 7920 6368 6172 6163 7465 7220 6c69  mpy character li
+00000820: 7374 0a20 2020 2022 2222 0a20 2020 2064  st.    """.    d
+00000830: 7420 3d20 6461 7465 7469 6d65 2e74 696d  t = datetime.tim
+00000840: 6564 656c 7461 2868 6f75 7273 3d69 6e63  edelta(hours=inc
+00000850: 5f68 6f75 7273 290a 0a20 2020 2065 7665  _hours)..    eve
+00000860: 6e74 203d 205b 5d0a 2020 2020 7768 696c  nt = [].    whil
+00000870: 6520 6431 203c 2064 323a 0a20 2020 2020  e d1 < d2:.     
+00000880: 2020 2065 7665 6e74 2e61 7070 656e 6428     event.append(
+00000890: 6431 2e73 7472 6674 696d 6528 2225 595f  d1.strftime("%Y_
+000008a0: 256d 5f25 645f 2548 5f25 4d5f 2553 2229  %m_%d_%H_%M_%S")
+000008b0: 290a 2020 2020 2020 2020 6431 202b 3d20  ).        d1 += 
+000008c0: 6474 0a20 2020 2065 7665 6e74 2e61 7070  dt.    event.app
+000008d0: 656e 6428 6432 2e73 7472 6674 696d 6528  end(d2.strftime(
+000008e0: 2225 595f 256d 5f25 645f 2548 5f25 4d5f  "%Y_%m_%d_%H_%M_
+000008f0: 2553 2229 290a 0a20 2020 2072 6574 7572  %S"))..    retur
+00000900: 6e20 6576 656e 740a 0a0a 6465 6620 6d61  n event...def ma
+00000910: 6b65 5f74 696d 6573 7461 6d70 7328 7072  ke_timestamps(pr
+00000920: 6570 726f 5f70 6172 6129 3a0a 2020 2020  epro_para):.    
+00000930: 2222 220a 2020 2020 7468 6973 2066 756e  """.    this fun
+00000940: 6374 696f 6e20 7072 6570 6172 6573 2074  ction prepares t
+00000950: 6865 2074 696d 6573 7461 6d70 7320 6f66  he timestamps of
+00000960: 2062 6f74 6820 7468 6520 7374 6172 7469   both the starti
+00000970: 6e67 2061 6e64 2065 6e64 696e 6720 7469  ng and ending ti
+00000980: 6d65 206f 6620 6561 6368 206d 7365 6564  me of each mseed
+00000990: 2f73 6163 2066 696c 6520 7468 6174 0a20  /sac file that. 
+000009a0: 2020 2069 7320 7374 6f72 6564 206f 6e20     is stored on 
+000009b0: 6c6f 6361 6c20 6d61 6368 696e 652e 2074  local machine. t
+000009c0: 6869 7320 7469 6d65 2069 6e66 6f20 6973  his time info is
+000009d0: 2075 7365 6420 746f 2073 6561 7263 6820   used to search 
+000009e0: 616c 6c20 7374 6174 696f 6e73 2069 6e20  all stations in 
+000009f0: 7370 6563 6966 6963 2074 696d 6520 6368  specific time ch
+00000a00: 756e 636b 0a20 2020 2077 6865 6e20 7072  unck.    when pr
+00000a10: 6570 6172 696e 6720 6e6f 6973 6520 6461  eparing noise da
+00000a20: 7461 2069 6e20 4153 4446 2066 6f72 6d61  ta in ASDF forma
+00000a30: 742e 2069 7420 6372 6561 7465 7320 6120  t. it creates a 
+00000a40: 6373 7620 6669 6c65 2063 6f6e 7461 696e  csv file contain
+00000a50: 696e 6720 616c 6c20 7469 6d65 7374 616d  ing all timestam
+00000a60: 7020 696e 666f 2069 6620 7468 650a 2020  p info if the.  
+00000a70: 2020 6669 6c65 2064 6f65 7320 6e6f 7420    file does not 
+00000a80: 6578 6973 7420 2875 7365 6420 696e 2053  exist (used in S
+00000a90: 3042 2966 0a20 2020 2050 4152 414d 4554  0B)f.    PARAMET
+00000aa0: 4552 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ERS:.    -------
+00000ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000ac0: 0a20 2020 2070 7265 7072 6f5f 7061 7261  .    prepro_para
+00000ad0: 3a20 6120 6469 6320 636f 6e74 6169 6e69  : a dic containi
+00000ae0: 6e67 2061 6c6c 2070 7265 2d70 726f 6365  ng all pre-proce
+00000af0: 7373 696e 6720 7061 7261 6d65 7465 7273  ssing parameters
+00000b00: 2075 7365 6420 696e 2053 3042 0a20 2020   used in S0B.   
+00000b10: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
+00000b20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000b30: 2d2d 2d2d 2d0a 2020 2020 616c 6c5f 7374  -----.    all_st
+00000b40: 696d 6573 3a20 6e75 6d70 7920 666c 6f61  imes: numpy floa
+00000b50: 7420 6172 7261 7920 636f 6e74 6169 6e69  t array containi
+00000b60: 6e67 2073 7461 7274 7469 6e67 2061 6e64  ng startting and
+00000b70: 2065 6e64 696e 6720 7469 6d65 2066 6f72   ending time for
+00000b80: 2061 6c6c 2053 4143 2f6d 7365 6564 2066   all SAC/mseed f
+00000b90: 696c 6573 0a20 2020 2022 2222 0a20 2020  iles.    """.   
+00000ba0: 2023 206c 6f61 6420 7061 7261 6d65 7465   # load paramete
+00000bb0: 7273 2066 726f 6d20 7061 7261 2064 6963  rs from para dic
+00000bc0: 0a20 2020 2077 696b 695f 6669 6c65 203d  .    wiki_file =
+00000bd0: 2070 7265 7072 6f5f 7061 7261 5b22 7769   prepro_para["wi
+00000be0: 6b69 5f66 696c 6522 5d0a 2020 2020 6d65  ki_file"].    me
+00000bf0: 7373 7964 6174 6120 3d20 7072 6570 726f  ssydata = prepro
+00000c00: 5f70 6172 615b 226d 6573 7379 6461 7461  _para["messydata
+00000c10: 225d 0a20 2020 2052 4157 4441 5441 203d  "].    RAWDATA =
+00000c20: 2070 7265 7072 6f5f 7061 7261 5b22 5241   prepro_para["RA
+00000c30: 5744 4154 4122 5d0a 2020 2020 616c 6c66  WDATA"].    allf
+00000c40: 696c 6573 5f70 6174 6820 3d20 7072 6570  iles_path = prep
+00000c50: 726f 5f70 6172 615b 2261 6c6c 6669 6c65  ro_para["allfile
+00000c60: 735f 7061 7468 225d 0a0a 2020 2020 6966  s_path"]..    if
+00000c70: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+00000c80: 7769 6b69 5f66 696c 6529 3a0a 2020 2020  wiki_file):.    
+00000c90: 2020 2020 746d 7020 3d20 7064 2e72 6561      tmp = pd.rea
+00000ca0: 645f 6373 7628 7769 6b69 5f66 696c 6529  d_csv(wiki_file)
+00000cb0: 0a20 2020 2020 2020 2061 6c6c 6669 6c65  .        allfile
+00000cc0: 7320 3d20 746d 705b 226e 616d 6573 225d  s = tmp["names"]
+00000cd0: 0a20 2020 2020 2020 2061 6c6c 5f73 7469  .        all_sti
+00000ce0: 6d65 7320 3d20 6e70 2e7a 6572 6f73 2873  mes = np.zeros(s
+00000cf0: 6861 7065 3d28 6c65 6e28 616c 6c66 696c  hape=(len(allfil
+00000d00: 6573 292c 2032 292c 2064 7479 7065 3d6e  es), 2), dtype=n
+00000d10: 702e 666c 6f61 7429 0a20 2020 2020 2020  p.float).       
+00000d20: 2061 6c6c 5f73 7469 6d65 735b 3a2c 2030   all_stimes[:, 0
+00000d30: 5d20 3d20 746d 705b 2273 7461 7274 7469  ] = tmp["startti
+00000d40: 6d65 225d 0a20 2020 2020 2020 2061 6c6c  me"].        all
+00000d50: 5f73 7469 6d65 735b 3a2c 2031 5d20 3d20  _stimes[:, 1] = 
+00000d60: 746d 705b 2265 6e64 7469 6d65 225d 0a0a  tmp["endtime"]..
+00000d70: 2020 2020 2320 6861 7665 2074 6f20 7265      # have to re
+00000d80: 6164 2065 6163 6820 7361 632f 6d73 6565  ad each sac/msee
+00000d90: 6420 6461 7461 206f 6e65 2062 7920 6f6e  d data one by on
+00000da0: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
+00000db0: 2020 2020 616c 6c66 696c 6573 203d 2067      allfiles = g
+00000dc0: 6c6f 622e 676c 6f62 2861 6c6c 6669 6c65  lob.glob(allfile
+00000dd0: 735f 7061 7468 290a 2020 2020 2020 2020  s_path).        
+00000de0: 6e66 696c 6573 203d 206c 656e 2861 6c6c  nfiles = len(all
+00000df0: 6669 6c65 7329 0a20 2020 2020 2020 2069  files).        i
+00000e00: 6620 6e6f 7420 6e66 696c 6573 3a0a 2020  f not nfiles:.  
+00000e10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00000e20: 5661 6c75 6545 7272 6f72 2822 4162 6f72  ValueError("Abor
+00000e30: 7421 206e 6f20 6461 7461 2066 6f75 6e64  t! no data found
+00000e40: 2069 6e20 7375 6264 6972 6563 746f 7279   in subdirectory
+00000e50: 206f 6620 2573 2220 2520 5241 5744 4154   of %s" % RAWDAT
+00000e60: 4129 0a20 2020 2020 2020 2061 6c6c 5f73  A).        all_s
+00000e70: 7469 6d65 7320 3d20 6e70 2e7a 6572 6f73  times = np.zeros
+00000e80: 2873 6861 7065 3d28 6e66 696c 6573 2c20  (shape=(nfiles, 
+00000e90: 3229 2c20 6474 7970 653d 6e70 2e66 6c6f  2), dtype=np.flo
+00000ea0: 6174 290a 0a20 2020 2020 2020 2069 6620  at)..        if 
+00000eb0: 6d65 7373 7964 6174 613a 0a20 2020 2020  messydata:.     
+00000ec0: 2020 2020 2020 2023 2067 6574 2056 4552         # get VER
+00000ed0: 5920 7072 6563 6973 6520 7472 6163 652d  Y precise trace-
+00000ee0: 7469 6d65 2066 726f 6d20 7468 6520 6865  time from the he
+00000ef0: 6164 6572 0a20 2020 2020 2020 2020 2020  ader.           
+00000f00: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+00000f10: 286e 6669 6c65 7329 3a0a 2020 2020 2020  (nfiles):.      
+00000f20: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00000f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f40: 2020 2074 7220 3d20 6f62 7370 792e 7265     tr = obspy.re
+00000f50: 6164 2861 6c6c 6669 6c65 735b 6969 5d29  ad(allfiles[ii])
+00000f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000f70: 2020 2020 2061 6c6c 5f73 7469 6d65 735b       all_stimes[
+00000f80: 6969 2c20 305d 203d 2074 725b 305d 2e73  ii, 0] = tr[0].s
+00000f90: 7461 7473 2e73 7461 7274 7469 6d65 202d  tats.starttime -
+00000fa0: 206f 6273 7079 2e55 5443 4461 7465 5469   obspy.UTCDateTi
+00000fb0: 6d65 2831 3937 302c 2031 2c20 3129 0a20  me(1970, 1, 1). 
+00000fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000fd0: 2020 2061 6c6c 5f73 7469 6d65 735b 6969     all_stimes[ii
+00000fe0: 2c20 315d 203d 2074 725b 305d 2e73 7461  , 1] = tr[0].sta
+00000ff0: 7473 2e65 6e64 7469 6d65 202d 206f 6273  ts.endtime - obs
+00001000: 7079 2e55 5443 4461 7465 5469 6d65 2831  py.UTCDateTime(1
+00001010: 3937 302c 2031 2c20 3129 0a20 2020 2020  970, 1, 1).     
+00001020: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00001030: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00001040: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001050: 2020 2020 2020 6c6f 6767 6572 2e65 7272        logger.err
+00001060: 6f72 2865 290a 2020 2020 2020 2020 2020  or(e).          
+00001070: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00001080: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
+00001090: 0a20 2020 2020 2020 2020 2020 2023 2067  .            # g
+000010a0: 6574 2072 6f75 6768 2065 7374 696d 6174  et rough estimat
+000010b0: 6573 206f 6620 7468 6520 7469 6d65 2062  es of the time b
+000010c0: 6173 6564 206f 6e20 7468 6520 666f 6c64  ased on the fold
+000010d0: 6572 3a20 6e65 6564 206d 6f64 6966 6965  er: need modifie
+000010e0: 6420 746f 2061 6363 6f6d 6d6f 6461 7465  d to accommodate
+000010f0: 2079 6f75 7220 6461 7461 0a20 2020 2020   your data.     
+00001100: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
+00001110: 2072 616e 6765 286e 6669 6c65 7329 3a0a   range(nfiles):.
+00001120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001130: 7965 6172 203d 2069 6e74 2861 6c6c 6669  year = int(allfi
+00001140: 6c65 735b 6969 5d2e 7370 6c69 7428 222f  les[ii].split("/
+00001150: 2229 5b2d 325d 2e73 706c 6974 2822 5f22  ")[-2].split("_"
+00001160: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+00001170: 2020 2020 2020 2320 6a75 6c69 6120 3d20        # julia = 
+00001180: 696e 7428 616c 6c66 696c 6573 5b69 695d  int(allfiles[ii]
+00001190: 2e73 706c 6974 2827 2f27 295b 2d32 5d2e  .split('/')[-2].
+000011a0: 7370 6c69 7428 275f 2729 5b32 5d29 0a20  split('_')[2]). 
+000011b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000011c0: 2061 6c6c 5f73 7469 6d65 735b 6969 2c30   all_stimes[ii,0
+000011d0: 5d20 3d20 6f62 7370 792e 5554 4344 6174  ] = obspy.UTCDat
+000011e0: 6554 696d 6528 7965 6172 3d79 6561 722c  eTime(year=year,
+000011f0: 6a75 6c64 6179 3d6a 756c 6961 290a 2020  julday=julia).  
+00001200: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00001210: 2d6f 6273 7079 2e55 5443 4461 7465 5469  -obspy.UTCDateTi
+00001220: 6d65 2879 6561 723d 3139 3730 2c6d 6f6e  me(year=1970,mon
+00001230: 7468 3d31 2c64 6179 3d31 290a 2020 2020  th=1,day=1).    
+00001240: 2020 2020 2020 2020 2020 2020 6d6f 6e74              mont
+00001250: 6820 3d20 696e 7428 616c 6c66 696c 6573  h = int(allfiles
+00001260: 5b69 695d 2e73 706c 6974 2822 2f22 295b  [ii].split("/")[
+00001270: 2d32 5d2e 7370 6c69 7428 225f 2229 5b32  -2].split("_")[2
+00001280: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00001290: 2020 2064 6179 203d 2069 6e74 2861 6c6c     day = int(all
+000012a0: 6669 6c65 735b 6969 5d2e 7370 6c69 7428  files[ii].split(
+000012b0: 222f 2229 5b2d 325d 2e73 706c 6974 2822  "/")[-2].split("
+000012c0: 5f22 295b 335d 290a 2020 2020 2020 2020  _")[3]).        
+000012d0: 2020 2020 2020 2020 616c 6c5f 7374 696d          all_stim
+000012e0: 6573 5b69 692c 2030 5d20 3d20 6f62 7370  es[ii, 0] = obsp
+000012f0: 792e 5554 4344 6174 6554 696d 6528 7965  y.UTCDateTime(ye
+00001300: 6172 3d79 6561 722c 206d 6f6e 7468 3d6d  ar=year, month=m
+00001310: 6f6e 7468 2c20 6461 793d 6461 7929 202d  onth, day=day) -
+00001320: 206f 6273 7079 2e55 5443 4461 7465 5469   obspy.UTCDateTi
+00001330: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
+00001340: 2020 2020 2020 2020 7965 6172 3d31 3937          year=197
+00001350: 302c 206d 6f6e 7468 3d31 2c20 6461 793d  0, month=1, day=
+00001360: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00001370: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00001380: 2020 2020 616c 6c5f 7374 696d 6573 5b69      all_stimes[i
+00001390: 692c 2031 5d20 3d20 616c 6c5f 7374 696d  i, 1] = all_stim
+000013a0: 6573 5b69 692c 2030 5d20 2b20 3836 3430  es[ii, 0] + 8640
+000013b0: 300a 0a20 2020 2020 2020 2023 2073 6176  0..        # sav
+000013c0: 6520 6e61 6d65 2061 6e64 2074 696d 6520  e name and time 
+000013d0: 696e 666f 2066 6f72 206c 6174 6572 2075  info for later u
+000013e0: 7365 2069 6620 7468 6520 6669 6c65 206e  se if the file n
+000013f0: 6f74 2065 7869 7374 0a20 2020 2020 2020  ot exist.       
+00001400: 2069 6620 6e6f 7420 6f73 2e70 6174 682e   if not os.path.
+00001410: 6973 6669 6c65 2877 696b 695f 6669 6c65  isfile(wiki_file
+00001420: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
+00001430: 696b 695f 696e 666f 203d 207b 0a20 2020  iki_info = {.   
+00001440: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
+00001450: 6d65 7322 3a20 616c 6c66 696c 6573 2c0a  mes": allfiles,.
+00001460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001470: 2273 7461 7274 7469 6d65 223a 2061 6c6c  "starttime": all
+00001480: 5f73 7469 6d65 735b 3a2c 2030 5d2c 0a20  _stimes[:, 0],. 
+00001490: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000014a0: 656e 6474 696d 6522 3a20 616c 6c5f 7374  endtime": all_st
+000014b0: 696d 6573 5b3a 2c20 315d 2c0a 2020 2020  imes[:, 1],.    
+000014c0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000014d0: 2020 2020 2020 6466 203d 2070 642e 4461        df = pd.Da
+000014e0: 7461 4672 616d 6528 7769 6b69 5f69 6e66  taFrame(wiki_inf
+000014f0: 6f2c 2063 6f6c 756d 6e73 3d5b 226e 616d  o, columns=["nam
+00001500: 6573 222c 2022 7374 6172 7474 696d 6522  es", "starttime"
+00001510: 2c20 2265 6e64 7469 6d65 225d 290a 2020  , "endtime"]).  
+00001520: 2020 2020 2020 2020 2020 6466 2e74 6f5f            df.to_
+00001530: 6373 7628 7769 6b69 5f66 696c 6529 0a20  csv(wiki_file). 
+00001540: 2020 2072 6574 7572 6e20 616c 6c5f 7374     return all_st
+00001550: 696d 6573 0a0a 0a64 6566 2070 7265 7072  imes...def prepr
+00001560: 6f63 6573 735f 7261 7728 0a20 2020 2073  ocess_raw(.    s
+00001570: 743a 206f 6273 7079 2e53 7472 6561 6d2c  t: obspy.Stream,
+00001580: 0a20 2020 2069 6e76 3a20 6f62 7370 792e  .    inv: obspy.
+00001590: 496e 7665 6e74 6f72 792c 0a20 2020 2070  Inventory,.    p
+000015a0: 7265 7072 6f5f 7061 7261 3a20 436f 6e66  repro_para: Conf
+000015b0: 6967 5061 7261 6d65 7465 7273 2c0a 2020  igParameters,.  
+000015c0: 2020 7374 6172 7474 696d 653a 206f 6273    starttime: obs
+000015d0: 7079 2e55 5443 4461 7465 5469 6d65 2c0a  py.UTCDateTime,.
+000015e0: 2020 2020 656e 6474 696d 653a 206f 6273      endtime: obs
+000015f0: 7079 2e55 5443 4461 7465 5469 6d65 2c0a  py.UTCDateTime,.
+00001600: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+00001610: 6869 7320 6675 6e63 7469 6f6e 2070 7265  his function pre
+00001620: 2d70 726f 6365 7373 6573 2074 6865 2072  -processes the r
+00001630: 6177 2064 6174 6120 7374 7265 616d 2062  aw data stream b
+00001640: 793a 0a20 2020 2020 2020 2031 2920 6368  y:.        1) ch
+00001650: 6563 6b20 7361 6d70 696e 6720 7261 7465  eck samping rate
+00001660: 2061 6e64 2067 6170 7320 696e 2074 6865   and gaps in the
+00001670: 2064 6174 613b 0a20 2020 2020 2020 2032   data;.        2
+00001680: 2920 7265 6d6f 7665 2073 6967 756c 6172  ) remove sigular
+00001690: 6974 792c 2074 7265 6e64 2061 6e64 206d  ity, trend and m
+000016a0: 6561 6e20 6f66 2065 6163 6820 7472 6163  ean of each trac
+000016b0: 650a 2020 2020 2020 2020 3329 2066 696c  e.        3) fil
+000016c0: 7465 7220 616e 6420 636f 7272 6563 7420  ter and correct 
+000016d0: 7468 6520 7469 6d65 2069 6620 696e 7465  the time if inte
+000016e0: 6765 7220 7469 6d65 2061 7265 2062 6574  ger time are bet
+000016f0: 7765 656e 2073 616d 706c 696e 6720 706f  ween sampling po
+00001700: 696e 7473 0a20 2020 2020 2020 2034 2920  ints.        4) 
+00001710: 7265 6d6f 7665 2069 6e73 7472 756d 656e  remove instrumen
+00001720: 7420 7265 7370 6f6e 7365 7320 7769 7468  t responses with
+00001730: 2073 656c 6563 7465 6420 6d65 7468 6f64   selected method
+00001740: 7320 696e 636c 7564 696e 673a 0a20 2020  s including:.   
+00001750: 2020 2020 2020 2020 2022 696e 7622 2020           "inv"  
+00001760: 202d 3e20 7573 696e 6720 696e 7665 6e74   -> using invent
+00001770: 6f72 7920 696e 666f 726d 6174 696f 6e20  ory information 
+00001780: 746f 2072 656d 6f76 655f 7265 7370 6f6e  to remove_respon
+00001790: 7365 3b0a 2020 2020 2020 2020 2020 2020  se;.            
+000017a0: 2273 7065 6374 7275 6d22 2020 202d 3e20  "spectrum"   -> 
+000017b0: 7573 6520 7468 6520 696e 7665 7273 6520  use the inverse 
+000017c0: 6f66 2072 6573 706f 6e73 6520 7370 6563  of response spec
+000017d0: 7472 756d 2e0a 2020 2020 2020 2020 2020  trum..          
+000017e0: 2020 2861 2073 6372 6970 7420 6973 2070    (a script is p
+000017f0: 726f 7669 6465 6420 696e 2061 6464 6974  rovided in addit
+00001800: 696f 6e61 6c5f 6d6f 6475 6c65 2074 6f20  ional_module to 
+00001810: 6573 7469 6d61 7465 2072 6573 706f 6e73  estimate respons
+00001820: 6520 7370 6563 7472 756d 2066 726f 6d20  e spectrum from 
+00001830: 5245 5350 2066 696c 6573 290a 2020 2020  RESP files).    
+00001840: 2020 2020 2020 2020 2252 4553 505f 6669          "RESP_fi
+00001850: 6c65 7322 202d 3e20 7573 6520 7468 6520  les" -> use the 
+00001860: 7261 7720 646f 776e 6c6f 6164 2052 4553  raw download RES
+00001870: 5020 6669 6c65 730a 2020 2020 2020 2020  P files.        
+00001880: 2020 2020 2270 6f6c 657a 6572 6f73 2220      "polezeros" 
+00001890: 202d 3e20 7573 6520 706f 6c65 2f7a 6572   -> use pole/zer
+000018a0: 6f20 696e 666f 2066 6f72 2061 2063 7275  o info for a cru
+000018b0: 6465 2063 6f72 7265 6374 696f 6e20 6f66  de correction of
+000018c0: 2072 6573 706f 6e73 650a 2020 2020 2020   response.      
+000018d0: 2020 3529 2074 7269 6d20 6461 7461 2074    5) trim data t
+000018e0: 6f20 6120 6461 792d 6c6f 6e67 2073 6571  o a day-long seq
+000018f0: 7565 6e63 6520 616e 6420 696e 7465 7270  uence and interp
+00001900: 6f6c 6174 6520 6974 2074 6f20 656e 7375  olate it to ensu
+00001910: 7265 2073 7461 7274 696e 6720 6174 2030  re starting at 0
+00001920: 303a 3030 3a30 302e 3030 300a 2020 2020  0:00:00.000.    
+00001930: 2875 7365 6420 696e 2053 3041 2026 2053  (used in S0A & S
+00001940: 3042 290a 2020 2020 5041 5241 4d45 5445  0B).    PARAMETE
+00001950: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+00001960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00001970: 2020 2020 7374 3a20 206f 6273 7079 2073      st:  obspy s
+00001980: 7472 6561 6d20 6f62 6a65 6374 2c20 636f  tream object, co
+00001990: 6e74 6169 6e69 6e67 206e 6f69 7365 2064  ntaining noise d
+000019a0: 6174 6120 746f 2062 6520 7072 6f63 6573  ata to be proces
+000019b0: 7365 640a 2020 2020 696e 763a 206f 6273  sed.    inv: obs
+000019c0: 7079 2069 6e76 656e 746f 7279 206f 626a  py inventory obj
+000019d0: 6563 742c 2063 6f6e 7461 696e 696e 6720  ect, containing 
+000019e0: 7374 6174 696f 6e73 2069 6e66 6f0a 2020  stations info.  
+000019f0: 2020 7072 6570 726f 5f70 6172 613a 2064    prepro_para: d
+00001a00: 6963 7420 636f 6e74 6169 6e69 6e67 2066  ict containing f
+00001a10: 6674 2070 6172 616d 6574 6572 732c 2073  ft parameters, s
+00001a20: 7563 6820 6173 2066 7265 7175 656e 6379  uch as frequency
+00001a30: 2062 616e 6473 2061 6e64 0a20 2020 2073   bands and.    s
+00001a40: 656c 6563 7469 6f6e 2066 6f72 2069 6e73  election for ins
+00001a50: 7472 756d 656e 7420 7265 7370 6f6e 7365  trument response
+00001a60: 2072 656d 6f76 616c 2065 7463 2e0a 2020   removal etc..  
+00001a70: 2020 6461 7465 5f69 6e66 6f3a 2020 2064    date_info:   d
+00001a80: 6963 7420 6f66 2073 7461 7274 2061 6e64  ict of start and
+00001a90: 2065 6e64 2074 696d 6520 6f66 2074 6865   end time of the
+00001aa0: 2073 7472 6561 6d20 6461 7461 0a20 2020   stream data.   
+00001ab0: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
+00001ac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00001ad0: 2d2d 2d2d 2d0a 2020 2020 6e74 723a 206f  -----.    ntr: o
+00001ae0: 6273 7079 2073 7472 6561 6d20 6f62 6a65  bspy stream obje
+00001af0: 6374 206f 6620 636c 6561 6e65 642c 206d  ct of cleaned, m
+00001b00: 6572 6765 6420 616e 6420 6669 6c74 6572  erged and filter
+00001b10: 6564 206e 6f69 7365 2064 6174 610a 2020  ed noise data.  
+00001b20: 2020 2222 220a 2020 2020 2320 6c6f 6164    """.    # load
+00001b30: 2070 6172 616d 7465 7273 2066 726f 6d20   paramters from 
+00001b40: 6666 7420 6469 6374 0a20 2020 2072 6d5f  fft dict.    rm_
+00001b50: 7265 7370 203d 2070 7265 7072 6f5f 7061  resp = prepro_pa
+00001b60: 7261 5b22 726d 5f72 6573 7022 5d0a 2020  ra["rm_resp"].  
+00001b70: 2020 726d 5f72 6573 705f 6f75 7420 3d20    rm_resp_out = 
+00001b80: 7072 6570 726f 5f70 6172 615b 2272 6d5f  prepro_para["rm_
+00001b90: 7265 7370 5f6f 7574 225d 0a20 2020 2072  resp_out"].    r
+00001ba0: 6573 7064 6972 203d 2070 7265 7072 6f5f  espdir = prepro_
+00001bb0: 7061 7261 5b22 7265 7370 6469 7222 5d0a  para["respdir"].
+00001bc0: 2020 2020 6672 6571 6d69 6e20 3d20 7072      freqmin = pr
+00001bd0: 6570 726f 5f70 6172 615b 2266 7265 716d  epro_para["freqm
+00001be0: 696e 225d 0a20 2020 2066 7265 716d 6178  in"].    freqmax
+00001bf0: 203d 2070 7265 7072 6f5f 7061 7261 5b22   = prepro_para["
+00001c00: 6672 6571 6d61 7822 5d0a 2020 2020 7361  freqmax"].    sa
+00001c10: 6d70 5f66 7265 7120 3d20 7072 6570 726f  mp_freq = prepro
+00001c20: 5f70 6172 615b 2273 616d 705f 6672 6571  _para["samp_freq
+00001c30: 225d 0a0a 2020 2020 2320 7061 7261 6d65  "]..    # parame
+00001c40: 7465 7273 2066 6f72 2062 7574 7465 7277  ters for butterw
+00001c50: 6f72 7468 2066 696c 7465 720a 2020 2020  orth filter.    
+00001c60: 6631 203d 2030 2e39 202a 2066 7265 716d  f1 = 0.9 * freqm
+00001c70: 696e 0a20 2020 2066 3220 3d20 6672 6571  in.    f2 = freq
+00001c80: 6d69 6e0a 2020 2020 6966 2031 2e31 202a  min.    if 1.1 *
+00001c90: 2066 7265 716d 6178 203e 2030 2e34 3520   freqmax > 0.45 
+00001ca0: 2a20 7361 6d70 5f66 7265 713a 0a20 2020  * samp_freq:.   
+00001cb0: 2020 2020 2066 3320 3d20 302e 3420 2a20       f3 = 0.4 * 
+00001cc0: 7361 6d70 5f66 7265 710a 2020 2020 2020  samp_freq.      
+00001cd0: 2020 6634 203d 2030 2e34 3520 2a20 7361    f4 = 0.45 * sa
+00001ce0: 6d70 5f66 7265 710a 2020 2020 656c 7365  mp_freq.    else
+00001cf0: 3a0a 2020 2020 2020 2020 6633 203d 2066  :.        f3 = f
+00001d00: 7265 716d 6178 0a20 2020 2020 2020 2066  reqmax.        f
+00001d10: 3420 3d20 312e 3120 2a20 6672 6571 6d61  4 = 1.1 * freqma
+00001d20: 780a 2020 2020 7072 655f 6669 6c74 203d  x.    pre_filt =
+00001d30: 205b 6631 2c20 6632 2c20 6633 2c20 6634   [f1, f2, f3, f4
+00001d40: 5d0a 0a20 2020 2023 2063 6865 636b 2073  ]..    # check s
+00001d50: 616d 706c 696e 6720 7261 7465 2061 6e64  ampling rate and
+00001d60: 2074 7261 6365 206c 656e 6774 680a 2020   trace length.  
+00001d70: 2020 7374 203d 2063 6865 636b 5f73 616d    st = check_sam
+00001d80: 706c 655f 6761 7073 2873 742c 2073 7461  ple_gaps(st, sta
+00001d90: 7274 7469 6d65 2c20 656e 6474 696d 6529  rttime, endtime)
+00001da0: 0a20 2020 2069 6620 6c65 6e28 7374 2920  .    if len(st) 
+00001db0: 3d3d 2030 3a0a 2020 2020 2020 2020 6c6f  == 0:.        lo
+00001dc0: 6767 6572 2e77 6172 6e69 6e67 2822 4e6f  gger.warning("No
+00001dd0: 2074 7261 6365 7320 696e 2053 7472 6561   traces in Strea
+00001de0: 6d3a 2043 6f6e 7469 6e75 6521 2229 0a20  m: Continue!"). 
+00001df0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
+00001e00: 0a20 2020 2073 7073 203d 2069 6e74 2873  .    sps = int(s
+00001e10: 745b 305d 2e73 7461 7473 2e73 616d 706c  t[0].stats.sampl
+00001e20: 696e 675f 7261 7465 290a 2020 2020 7374  ing_rate).    st
+00001e30: 6174 696f 6e20 3d20 7374 5b30 5d2e 7374  ation = st[0].st
+00001e40: 6174 732e 7374 6174 696f 6e0a 0a20 2020  ats.station..   
+00001e50: 2023 2072 656d 6f76 6520 6e61 6e2f 696e   # remove nan/in
+00001e60: 662c 206d 6561 6e20 616e 6420 7472 656e  f, mean and tren
+00001e70: 6420 6f66 2065 6163 6820 7472 6163 6520  d of each trace 
+00001e80: 6265 666f 7265 206d 6572 6769 6e67 0a20  before merging. 
+00001e90: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00001ea0: 6765 286c 656e 2873 7429 293a 0a20 2020  ge(len(st)):.   
+00001eb0: 2020 2020 2023 202d 2d2d 2d2d 7365 7420       # -----set 
+00001ec0: 6e61 6e2f 696e 6620 7661 6c75 6573 2074  nan/inf values t
+00001ed0: 6f20 7a65 726f 7320 2869 7420 646f 6573  o zeros (it does
+00001ee0: 2068 6170 7065 6e73 2129 2d2d 2d2d 2d0a   happens!)-----.
+00001ef0: 2020 2020 2020 2020 7474 7469 6e64 7820          tttindx 
+00001f00: 3d20 6e70 2e77 6865 7265 286e 702e 6973  = np.where(np.is
+00001f10: 6e61 6e28 7374 5b69 695d 2e64 6174 6129  nan(st[ii].data)
+00001f20: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
+00001f30: 2874 7474 696e 6478 2920 3e20 303a 0a20  (tttindx) > 0:. 
+00001f40: 2020 2020 2020 2020 2020 2073 745b 6969             st[ii
+00001f50: 5d2e 6461 7461 5b74 7474 696e 6478 5d20  ].data[tttindx] 
+00001f60: 3d20 300a 2020 2020 2020 2020 7474 7469  = 0.        ttti
+00001f70: 6e64 7820 3d20 6e70 2e77 6865 7265 286e  ndx = np.where(n
+00001f80: 702e 6973 696e 6628 7374 5b69 695d 2e64  p.isinf(st[ii].d
+00001f90: 6174 6129 290a 2020 2020 2020 2020 6966  ata)).        if
+00001fa0: 206c 656e 2874 7474 696e 6478 2920 3e20   len(tttindx) > 
+00001fb0: 303a 0a20 2020 2020 2020 2020 2020 2073  0:.            s
+00001fc0: 745b 6969 5d2e 6461 7461 5b74 7474 696e  t[ii].data[tttin
+00001fd0: 6478 5d20 3d20 300a 0a20 2020 2020 2020  dx] = 0..       
+00001fe0: 2073 745b 6969 5d2e 6461 7461 203d 206e   st[ii].data = n
+00001ff0: 702e 666c 6f61 7433 3228 7374 5b69 695d  p.float32(st[ii]
+00002000: 2e64 6174 6129 0a20 2020 2020 2020 2073  .data).        s
+00002010: 745b 6969 5d2e 6461 7461 203d 2073 6369  t[ii].data = sci
+00002020: 7079 2e73 6967 6e61 6c2e 6465 7472 656e  py.signal.detren
+00002030: 6428 7374 5b69 695d 2e64 6174 612c 2074  d(st[ii].data, t
+00002040: 7970 653d 2263 6f6e 7374 616e 7422 290a  ype="constant").
+00002050: 2020 2020 2020 2020 7374 5b69 695d 2e64          st[ii].d
+00002060: 6174 6120 3d20 7363 6970 792e 7369 676e  ata = scipy.sign
+00002070: 616c 2e64 6574 7265 6e64 2873 745b 6969  al.detrend(st[ii
+00002080: 5d2e 6461 7461 2c20 7479 7065 3d22 6c69  ].data, type="li
+00002090: 6e65 6172 2229 0a0a 2020 2020 2320 6d65  near")..    # me
+000020a0: 7267 652c 2074 6170 6572 2061 6e64 2066  rge, taper and f
+000020b0: 696c 7465 7220 7468 6520 6461 7461 0a20  ilter the data. 
+000020c0: 2020 2069 6620 6c65 6e28 7374 2920 3e20     if len(st) > 
+000020d0: 313a 0a20 2020 2020 2020 2073 742e 6d65  1:.        st.me
+000020e0: 7267 6528 6d65 7468 6f64 3d31 2c20 6669  rge(method=1, fi
+000020f0: 6c6c 5f76 616c 7565 3d30 290a 2020 2020  ll_value=0).    
+00002100: 7374 5b30 5d2e 7461 7065 7228 6d61 785f  st[0].taper(max_
+00002110: 7065 7263 656e 7461 6765 3d30 2e30 352c  percentage=0.05,
+00002120: 206d 6178 5f6c 656e 6774 683d 3530 2920   max_length=50) 
+00002130: 2023 2074 6170 6572 2077 696e 646f 770a   # taper window.
+00002140: 2020 2020 7374 5b30 5d2e 6461 7461 203d      st[0].data =
+00002150: 206e 702e 666c 6f61 7433 3228 6261 6e64   np.float32(band
+00002160: 7061 7373 2873 745b 305d 2e64 6174 612c  pass(st[0].data,
+00002170: 2070 7265 5f66 696c 745b 305d 2c20 7072   pre_filt[0], pr
+00002180: 655f 6669 6c74 5b2d 315d 2c20 6466 3d73  e_filt[-1], df=s
+00002190: 7073 2c20 636f 726e 6572 733d 342c 207a  ps, corners=4, z
+000021a0: 6572 6f70 6861 7365 3d54 7275 6529 290a  erophase=True)).
+000021b0: 0a20 2020 2023 206d 616b 6520 646f 776e  .    # make down
+000021c0: 7361 6d70 6c69 6e67 2069 6620 6e65 6564  sampling if need
+000021d0: 6564 0a20 2020 2069 6620 6162 7328 7361  ed.    if abs(sa
+000021e0: 6d70 5f66 7265 7120 2d20 7370 7329 203e  mp_freq - sps) >
+000021f0: 2031 652d 343a 0a20 2020 2020 2020 2023   1e-4:.        #
+00002200: 2064 6f77 6e73 616d 706c 696e 6720 6865   downsampling he
+00002210: 7265 0a20 2020 2020 2020 2073 742e 696e  re.        st.in
+00002220: 7465 7270 6f6c 6174 6528 7361 6d70 5f66  terpolate(samp_f
+00002230: 7265 712c 206d 6574 686f 643d 2277 6569  req, method="wei
+00002240: 6768 7465 645f 6176 6572 6167 655f 736c  ghted_average_sl
+00002250: 6f70 6573 2229 0a20 2020 2020 2020 2064  opes").        d
+00002260: 656c 7461 203d 2073 745b 305d 2e73 7461  elta = st[0].sta
+00002270: 7473 2e64 656c 7461 0a0a 2020 2020 2020  ts.delta..      
+00002280: 2020 2320 7768 656e 2073 7461 7274 7469    # when startti
+00002290: 6d65 7320 6172 6520 6265 7477 6565 6e20  mes are between 
+000022a0: 7361 6d70 6c69 6e67 2070 6f69 6e74 730a  sampling points.
+000022b0: 2020 2020 2020 2020 6672 6963 203d 2073          fric = s
+000022c0: 745b 305d 2e73 7461 7473 2e73 7461 7274  t[0].stats.start
+000022d0: 7469 6d65 2e6d 6963 726f 7365 636f 6e64  time.microsecond
+000022e0: 2025 2028 6465 6c74 6120 2a20 3165 3629   % (delta * 1e6)
+000022f0: 0a20 2020 2020 2020 2069 6620 6672 6963  .        if fric
+00002300: 203e 2031 652d 343a 0a20 2020 2020 2020   > 1e-4:.       
+00002310: 2020 2020 2073 745b 305d 2e64 6174 6120       st[0].data 
+00002320: 3d20 7365 676d 656e 745f 696e 7465 7270  = segment_interp
+00002330: 6f6c 6174 6528 6e70 2e66 6c6f 6174 3332  olate(np.float32
+00002340: 2873 745b 305d 2e64 6174 6129 2c20 666c  (st[0].data), fl
+00002350: 6f61 7428 6672 6963 202f 2028 6465 6c74  oat(fric / (delt
+00002360: 6120 2a20 3165 3629 2929 0a20 2020 2020  a * 1e6))).     
+00002370: 2020 2020 2020 2023 202d 2d72 6573 6574         # --reset
+00002380: 2074 6865 2074 696d 6520 746f 2072 656d   the time to rem
+00002390: 6f76 6520 7468 6520 6469 7363 7265 7061  ove the discrepa
+000023a0: 6e63 792d 2d2d 0a20 2020 2020 2020 2020  ncy---.         
+000023b0: 2020 2073 745b 305d 2e73 7461 7473 2e73     st[0].stats.s
+000023c0: 7461 7274 7469 6d65 202d 3d20 6672 6963  tarttime -= fric
+000023d0: 202a 2031 652d 360a 0a20 2020 2023 2072   * 1e-6..    # r
+000023e0: 656d 6f76 6520 7472 6163 6573 206f 6620  emove traces of 
+000023f0: 746f 6f20 736d 616c 6c20 6c65 6e67 7468  too small length
+00002400: 0a0a 2020 2020 2320 6f70 7469 6f6e 7320  ..    # options 
+00002410: 746f 2072 656d 6f76 6520 696e 7374 7275  to remove instru
+00002420: 6d65 6e74 2072 6573 706f 6e73 650a 2020  ment response.  
+00002430: 2020 6966 2072 6d5f 7265 7370 2021 3d20    if rm_resp != 
+00002440: 226e 6f22 3a0a 2020 2020 2020 2020 6966  "no":.        if
+00002450: 2072 6d5f 7265 7370 2021 3d20 2269 6e76   rm_resp != "inv
+00002460: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
+00002470: 6620 2872 6573 7064 6972 2069 7320 4e6f  f (respdir is No
+00002480: 6e65 2920 6f72 2028 6e6f 7420 6f73 2e70  ne) or (not os.p
+00002490: 6174 682e 6973 6469 7228 7265 7370 6469  ath.isdir(respdi
+000024a0: 7229 293a 0a20 2020 2020 2020 2020 2020  r)):.           
+000024b0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000024c0: 4572 726f 7228 2272 6573 706f 6e73 6520  Error("response 
+000024d0: 6669 6c65 2066 6f6c 6465 7220 6e6f 7420  file folder not 
+000024e0: 666f 756e 6421 2061 626f 7274 2122 290a  found! abort!").
+000024f0: 0a20 2020 2020 2020 2069 6620 726d 5f72  .        if rm_r
+00002500: 6573 7020 3d3d 2022 696e 7622 3a0a 2020  esp == "inv":.  
+00002510: 2020 2020 2020 2020 2020 2320 2d2d 2d2d            # ----
+00002520: 6368 6563 6b20 7768 6574 6865 7220 696e  check whether in
+00002530: 7665 6e74 6f72 7920 6973 2061 7474 6163  ventory is attac
+00002540: 6865 642d 2d2d 2d0a 2020 2020 2020 2020  hed----.        
+00002550: 2020 2020 6966 206e 6f74 2069 6e76 5b30      if not inv[0
+00002560: 5d5b 305d 5b30 5d2e 7265 7370 6f6e 7365  ][0][0].response
+00002570: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002580: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00002590: 6f72 2822 6e6f 2072 6573 706f 6e73 6520  or("no response 
+000025a0: 666f 756e 6420 696e 2074 6865 2069 6e76  found in the inv
+000025b0: 656e 746f 7279 2120 6162 6f72 7421 2229  entory! abort!")
+000025c0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000025d0: 6620 696e 765b 305d 5b30 5d5b 305d 2e72  f inv[0][0][0].r
+000025e0: 6573 706f 6e73 6520 3d3d 206f 6273 7079  esponse == obspy
+000025f0: 2e63 6f72 652e 696e 7665 6e74 6f72 792e  .core.inventory.
+00002600: 7265 7370 6f6e 7365 2e52 6573 706f 6e73  response.Respons
+00002610: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+00002620: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00002630: 4572 726f 7228 2254 6865 2072 6573 706f  Error("The respo
+00002640: 6e73 6520 666f 756e 6420 696e 2074 6865  nse found in the
+00002650: 2069 6e76 656e 746f 7279 2069 7320 656d   inventory is em
+00002660: 7074 7920 286e 6f20 7374 6167 6573 2921  pty (no stages)!
+00002670: 2061 626f 7274 2122 290a 2020 2020 2020   abort!").      
+00002680: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00002690: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+000026a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000026b0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+000026c0: 2822 7265 6d6f 7669 6e67 2072 6573 706f  ("removing respo
+000026d0: 6e73 6520 666f 7220 2573 2075 7369 6e67  nse for %s using
+000026e0: 2069 6e76 2220 2520 7374 5b30 5d29 0a20   inv" % st[0]). 
+000026f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002700: 2020 2073 745b 305d 2e61 7474 6163 685f     st[0].attach_
+00002710: 7265 7370 6f6e 7365 2869 6e76 290a 2020  response(inv).  
+00002720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002730: 2020 7374 5b30 5d2e 7265 6d6f 7665 5f72    st[0].remove_r
+00002740: 6573 706f 6e73 6528 6f75 7470 7574 3d72  esponse(output=r
+00002750: 6d5f 7265 7370 5f6f 7574 2c20 7072 655f  m_resp_out, pre_
+00002760: 6669 6c74 3d70 7265 5f66 696c 742c 2077  filt=pre_filt, w
+00002770: 6174 6572 5f6c 6576 656c 3d36 3029 0a20  ater_level=60). 
+00002780: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00002790: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+000027a0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+000027b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000027c0: 2e77 6172 6e69 6e67 2822 4661 696c 6564  .warning("Failed
+000027d0: 2074 6f20 7265 6d6f 7665 2072 6573 706f   to remove respo
+000027e0: 6e73 6520 6672 6f6d 2025 732e 2052 6574  nse from %s. Ret
+000027f0: 7572 6e69 6e67 2065 6d70 7479 2073 7472  urning empty str
+00002800: 6561 6d2e 2025 7322 2025 2028 7374 5b30  eam. %s" % (st[0
+00002810: 5d2c 2065 2929 0a20 2020 2020 2020 2020  ], e)).         
+00002820: 2020 2020 2020 2020 2020 2073 7420 3d20             st = 
+00002830: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+00002840: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
+00002850: 0a0a 2020 2020 2020 2020 656c 6966 2072  ..        elif r
+00002860: 6d5f 7265 7370 203d 3d20 2273 7065 6374  m_resp == "spect
+00002870: 7275 6d22 3a0a 2020 2020 2020 2020 2020  rum":.          
+00002880: 2020 6c6f 6767 6572 2e69 6e66 6f28 2272    logger.info("r
+00002890: 656d 6f76 6520 7265 7370 6f6e 7365 2075  emove response u
+000028a0: 7369 6e67 2073 7065 6374 7275 6d22 290a  sing spectrum").
+000028b0: 2020 2020 2020 2020 2020 2020 7370 6563              spec
+000028c0: 6669 6c65 203d 2067 6c6f 622e 676c 6f62  file = glob.glob
+000028d0: 286f 732e 7061 7468 2e6a 6f69 6e28 7265  (os.path.join(re
+000028e0: 7370 6469 722c 2022 2a22 202b 2073 7461  spdir, "*" + sta
+000028f0: 7469 6f6e 202b 2022 2a22 2929 0a20 2020  tion + "*")).   
+00002900: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+00002910: 7370 6563 6669 6c65 2920 3d3d 2030 3a0a  specfile) == 0:.
+00002920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002930: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00002940: 2822 6e6f 2072 6573 706f 6e73 6520 7365  ("no response se
+00002950: 7063 7472 756d 2066 6f75 6e64 2066 6f72  pctrum found for
+00002960: 2025 7322 2025 2073 7461 7469 6f6e 290a   %s" % station).
+00002970: 2020 2020 2020 2020 2020 2020 7374 203d              st =
+00002980: 2072 6573 705f 7370 6563 7472 756d 2873   resp_spectrum(s
+00002990: 742c 2073 7065 6366 696c 655b 305d 2c20  t, specfile[0], 
+000029a0: 7361 6d70 5f66 7265 712c 2070 7265 5f66  samp_freq, pre_f
+000029b0: 696c 7429 0a0a 2020 2020 2020 2020 656c  ilt)..        el
+000029c0: 6966 2072 6d5f 7265 7370 203d 3d20 2252  if rm_resp == "R
+000029d0: 4553 5022 3a0a 2020 2020 2020 2020 2020  ESP":.          
+000029e0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2272    logger.info("r
+000029f0: 656d 6f76 6520 7265 7370 6f6e 7365 2075  emove response u
+00002a00: 7369 6e67 2052 4553 5020 6669 6c65 7322  sing RESP files"
+00002a10: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00002a20: 7370 203d 2067 6c6f 622e 676c 6f62 286f  sp = glob.glob(o
+00002a30: 732e 7061 7468 2e6a 6f69 6e28 7265 7370  s.path.join(resp
+00002a40: 6469 722c 2022 5245 5350 2e22 202b 2073  dir, "RESP." + s
+00002a50: 7461 7469 6f6e 202b 2022 2a22 2929 0a20  tation + "*")). 
+00002a60: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00002a70: 6e28 7265 7370 2920 3d3d 2030 3a0a 2020  n(resp) == 0:.  
+00002a80: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00002a90: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00002aa0: 6e6f 2052 4553 5020 6669 6c65 7320 666f  no RESP files fo
+00002ab0: 756e 6420 666f 7220 2573 2220 2520 7374  und for %s" % st
+00002ac0: 6174 696f 6e29 0a20 2020 2020 2020 2020  ation).         
+00002ad0: 2020 2073 6565 6472 6573 7020 3d20 7b0a     seedresp = {.
+00002ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002af0: 2266 696c 656e 616d 6522 3a20 7265 7370  "filename": resp
+00002b00: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+00002b10: 2020 2020 2022 6461 7465 223a 2073 7461       "date": sta
+00002b20: 7274 7469 6d65 2c0a 2020 2020 2020 2020  rttime,.        
+00002b30: 2020 2020 2020 2020 2275 6e69 7473 223a          "units":
+00002b40: 2022 4449 5322 2c0a 2020 2020 2020 2020   "DIS",.        
+00002b50: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00002b60: 2020 7374 2e73 696d 756c 6174 6528 7061    st.simulate(pa
+00002b70: 7a5f 7265 6d6f 7665 3d4e 6f6e 652c 2070  z_remove=None, p
+00002b80: 7265 5f66 696c 743d 7072 655f 6669 6c74  re_filt=pre_filt
+00002b90: 2c20 7365 6564 7265 7370 3d73 6565 6472  , seedresp=seedr
+00002ba0: 6573 7029 0a0a 2020 2020 2020 2020 656c  esp)..        el
+00002bb0: 6966 2072 6d5f 7265 7370 203d 3d20 2270  if rm_resp == "p
+00002bc0: 6f6c 6573 7a65 726f 7322 3a0a 2020 2020  oleszeros":.    
+00002bd0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00002be0: 6e66 6f28 2272 656d 6f76 6520 7265 7370  nfo("remove resp
+00002bf0: 6f6e 7365 2075 7369 6e67 2070 6f6c 6573  onse using poles
+00002c00: 2061 6e64 207a 6572 6f73 2229 0a20 2020   and zeros").   
+00002c10: 2020 2020 2020 2020 2070 617a 5f73 7473           paz_sts
+00002c20: 203d 2067 6c6f 622e 676c 6f62 286f 732e   = glob.glob(os.
+00002c30: 7061 7468 2e6a 6f69 6e28 7265 7370 6469  path.join(respdi
+00002c40: 722c 2022 2a22 202b 2073 7461 7469 6f6e  r, "*" + station
+00002c50: 202b 2022 2a22 2929 0a20 2020 2020 2020   + "*")).       
+00002c60: 2020 2020 2069 6620 6c65 6e28 7061 7a5f       if len(paz_
+00002c70: 7374 7329 203d 3d20 303a 0a20 2020 2020  sts) == 0:.     
+00002c80: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00002c90: 2056 616c 7565 4572 726f 7228 226e 6f20   ValueError("no 
+00002ca0: 706f 6c65 737a 6572 6f73 2066 6f75 6e64  poleszeros found
+00002cb0: 2066 6f72 2025 7322 2025 2073 7461 7469   for %s" % stati
+00002cc0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00002cd0: 7374 2e73 696d 756c 6174 6528 7061 7a5f  st.simulate(paz_
+00002ce0: 7265 6d6f 7665 3d70 617a 5f73 7473 5b30  remove=paz_sts[0
+00002cf0: 5d2c 2070 7265 5f66 696c 743d 7072 655f  ], pre_filt=pre_
+00002d00: 6669 6c74 290a 0a20 2020 2020 2020 2065  filt)..        e
+00002d10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00002d20: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00002d30: 7228 226e 6f20 7375 6368 206f 7074 696f  r("no such optio
+00002d40: 6e20 666f 7220 726d 5f72 6573 7021 2070  n for rm_resp! p
+00002d50: 6c65 6173 6520 646f 7562 6c65 2063 6865  lease double che
+00002d60: 636b 2122 290a 0a20 2020 206e 7472 203d  ck!")..    ntr =
+00002d70: 206f 6273 7079 2e53 7472 6561 6d28 290a   obspy.Stream().
+00002d80: 2020 2020 2320 7472 696d 2061 2063 6f6e      # trim a con
+00002d90: 7469 6e6f 7573 2073 6567 6d65 6e74 2069  tinous segment i
+00002da0: 6e74 6f20 7573 6572 2d64 6566 696e 6564  nto user-defined
+00002db0: 2073 6571 7565 6e63 6573 0a20 2020 2073   sequences.    s
+00002dc0: 745b 305d 2e74 7269 6d28 0a20 2020 2020  t[0].trim(.     
+00002dd0: 2020 2073 7461 7274 7469 6d65 3d73 7461     starttime=sta
+00002de0: 7274 7469 6d65 2c0a 2020 2020 2020 2020  rttime,.        
+00002df0: 656e 6474 696d 653d 656e 6474 696d 652c  endtime=endtime,
+00002e00: 0a20 2020 2020 2020 2070 6164 3d54 7275  .        pad=Tru
+00002e10: 652c 0a20 2020 2020 2020 2066 696c 6c5f  e,.        fill_
+00002e20: 7661 6c75 653d 302c 0a20 2020 2029 0a20  value=0,.    ). 
+00002e30: 2020 206e 7472 2e61 7070 656e 6428 7374     ntr.append(st
+00002e40: 5b30 5d29 0a0a 2020 2020 7265 7475 726e  [0])..    return
+00002e50: 206e 7472 0a0a 0a64 6566 2073 7461 7473   ntr...def stats
+00002e60: 3269 6e76 2873 7461 7473 2c20 7072 6570  2inv(stats, prep
+00002e70: 726f 5f70 6172 612c 206c 6f63 733d 4e6f  ro_para, locs=No
+00002e80: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
+00002e90: 2074 6869 7320 6675 6e63 7469 6f6e 2063   this function c
+00002ea0: 7265 6174 6573 2069 6e76 656e 746f 7279  reates inventory
+00002eb0: 2067 6976 656e 2074 6865 2073 7461 7473   given the stats
+00002ec0: 2070 6172 616d 6574 6572 7320 696e 2061   parameters in a
+00002ed0: 6e20 6f62 7370 7920 7374 7265 616d 206f  n obspy stream o
+00002ee0: 7220 6120 7374 6174 696f 6e20 6c69 7374  r a station list
+00002ef0: 2e0a 2020 2020 2875 7365 6420 696e 2053  ..    (used in S
+00002f00: 3042 290a 2020 2020 5041 5241 4d45 5445  0B).    PARAMETE
+00002f10: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+00002f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00002f30: 0a20 2020 2073 7461 7473 3a20 6f62 7370  .    stats: obsp
+00002f40: 7920 7472 6163 6520 7374 6174 7320 6f62  y trace stats ob
+00002f50: 6a65 6374 2063 6f6e 7461 696e 696e 6720  ject containing 
+00002f60: 616c 6c20 7374 6174 696f 6e20 6865 6164  all station head
+00002f70: 6572 2069 6e66 6f0a 2020 2020 7072 6570  er info.    prep
+00002f80: 726f 5f70 6172 613a 2064 6963 7420 636f  ro_para: dict co
+00002f90: 6e74 6169 6e69 6e67 2066 6674 2070 6172  ntaining fft par
+00002fa0: 616d 6574 6572 732c 2073 7563 6820 6173  ameters, such as
+00002fb0: 2066 7265 7175 656e 6379 2062 616e 6473   frequency bands
+00002fc0: 2061 6e64 2073 656c 6563 7469 6f6e 2066   and selection f
+00002fd0: 6f72 2069 6e73 7472 756d 656e 740a 2020  or instrument.  
+00002fe0: 2020 7265 7370 6f6e 7365 2072 656d 6f76    response remov
+00002ff0: 616c 2065 7463 2e0a 2020 2020 6c6f 6373  al etc..    locs
+00003000: 3a20 2070 616e 6461 2064 6174 6120 6672  :  panda data fr
+00003010: 616d 6520 6f66 2074 6865 2073 7461 7469  ame of the stati
+00003020: 6f6e 206c 6973 742e 2069 7420 6973 206e  on list. it is n
+00003030: 6565 6465 6420 666f 7220 636f 6e76 6572  eeded for conver
+00003040: 696e 6720 6d69 6e69 7365 6564 2066 696c  ing miniseed fil
+00003050: 6573 2069 6e74 6f20 4153 4446 0a20 2020  es into ASDF.   
+00003060: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
+00003070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00003080: 2d2d 2d2d 2d2d 0a20 2020 2069 6e76 3a20  ------.    inv: 
+00003090: 6f62 7370 7920 696e 7665 6e74 6f72 7920  obspy inventory 
+000030a0: 6f62 6a65 6374 206f 6620 616c 6c20 7374  object of all st
+000030b0: 6174 696f 6e20 696e 666f 2074 6f20 6265  ation info to be
+000030c0: 2075 7365 6420 6c61 7465 720a 2020 2020   used later.    
+000030d0: 2222 220a 2020 2020 7374 6178 6d6c 203d  """.    staxml =
+000030e0: 2070 7265 7072 6f5f 7061 7261 5b22 7374   prepro_para["st
+000030f0: 6174 696f 6e78 6d6c 225d 0a20 2020 2072  ationxml"].    r
+00003100: 6573 7064 6972 203d 2070 7265 7072 6f5f  espdir = prepro_
+00003110: 7061 7261 5b22 7265 7370 6469 7222 5d0a  para["respdir"].
+00003120: 2020 2020 696e 7075 745f 666d 7420 3d20      input_fmt = 
+00003130: 7072 6570 726f 5f70 6172 615b 2269 6e70  prepro_para["inp
+00003140: 7574 5f66 6d74 225d 0a20 2020 2069 6620  ut_fmt"].    if 
+00003150: 7374 6178 6d6c 3a0a 2020 2020 2020 2020  staxml:.        
+00003160: 7265 7475 726e 2073 7461 7473 3249 6e76  return stats2Inv
+00003170: 5f73 7461 786d 6c28 7374 6174 732c 2072  _staxml(stats, r
+00003180: 6573 7064 6972 290a 2020 2020 6966 2069  espdir).    if i
+00003190: 6e70 7574 5f66 6d74 203d 3d20 2273 6163  nput_fmt == "sac
+000031a0: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
+000031b0: 6e20 7374 6174 7332 696e 765f 7361 6328  n stats2inv_sac(
+000031c0: 7374 6174 7329 0a20 2020 2065 6c69 6620  stats).    elif 
+000031d0: 696e 7075 745f 666d 7420 3d3d 2022 6d73  input_fmt == "ms
+000031e0: 6565 6422 3a0a 2020 2020 2020 2020 7265  eed":.        re
+000031f0: 7475 726e 2073 7461 7473 3269 6e76 5f6d  turn stats2inv_m
+00003200: 7365 6564 2873 7461 7473 2c20 6c6f 6373  seed(stats, locs
+00003210: 290a 0a0a 6465 6620 7374 6174 7332 496e  )...def stats2In
+00003220: 765f 7374 6178 6d6c 2873 7461 7473 2c20  v_staxml(stats, 
+00003230: 7265 7370 6469 7229 202d 3e20 496e 7665  respdir) -> Inve
+00003240: 6e74 6f72 793a 0a20 2020 2069 6620 6e6f  ntory:.    if no
+00003250: 7420 7265 7370 6469 723a 0a20 2020 2020  t respdir:.     
+00003260: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00003270: 726f 7228 2241 626f 7274 2120 7374 6178  ror("Abort! stax
+00003280: 6d6c 2069 7320 7365 6c65 6374 6564 2062  ml is selected b
+00003290: 7574 206e 6f20 6469 7265 6374 6f72 7920  ut no directory 
+000032a0: 6973 2067 6976 656e 2074 6f20 6163 6365  is given to acce
+000032b0: 7373 2074 6865 2066 696c 6573 2229 0a20  ss the files"). 
+000032c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000032d0: 2069 6e76 6669 6c65 6c69 7374 203d 2067   invfilelist = g
+000032e0: 6c6f 622e 676c 6f62 286f 732e 7061 7468  lob.glob(os.path
+000032f0: 2e6a 6f69 6e28 7265 7370 6469 722c 2022  .join(respdir, "
+00003300: 2a22 202b 2073 7461 7473 2e73 7461 7469  *" + stats.stati
+00003310: 6f6e 202b 2022 2a22 2929 0a20 2020 2020  on + "*")).     
+00003320: 2020 2069 6620 6c65 6e28 696e 7666 696c     if len(invfil
+00003330: 656c 6973 7429 203e 2030 3a0a 2020 2020  elist) > 0:.    
+00003340: 2020 2020 2020 2020 696e 7666 696c 6520          invfile 
+00003350: 3d20 696e 7666 696c 656c 6973 745b 305d  = invfilelist[0]
+00003360: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00003370: 6c65 6e28 696e 7666 696c 656c 6973 7429  len(invfilelist)
+00003380: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
+00003390: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+000033a0: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+000033b0: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
+000033c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000033d0: 2020 2020 2257 6172 6e69 6e67 2120 4d6f      "Warning! Mo
+000033e0: 7265 2074 6861 6e20 6f6e 6520 5374 6174  re than one Stat
+000033f0: 696f 6e58 4d4c 2066 696c 6520 7761 7320  ionXML file was 
+00003400: 666f 756e 6420 666f 7220 7374 6174 696f  found for statio
+00003410: 6e20 2573 2e22 0a20 2020 2020 2020 2020  n %s.".         
+00003420: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00003430: 2022 4b65 6570 696e 6720 7468 6520 6669   "Keeping the fi
+00003440: 7273 7420 6669 6c65 2069 6e20 6c69 7374  rst file in list
+00003450: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+00003460: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00003470: 2020 2020 2020 2020 2020 2020 2025 2073               % s
+00003480: 7461 7473 2e73 7461 7469 6f6e 0a20 2020  tats.station.   
+00003490: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000034a0: 2020 2020 2020 2020 2020 2069 6620 6f73             if os
+000034b0: 2e70 6174 682e 6973 6669 6c65 2873 7472  .path.isfile(str
+000034c0: 2869 6e76 6669 6c65 2929 3a0a 2020 2020  (invfile)):.    
+000034d0: 2020 2020 2020 2020 2020 2020 696e 7620              inv 
+000034e0: 3d20 6f62 7370 792e 7265 6164 5f69 6e76  = obspy.read_inv
+000034f0: 656e 746f 7279 2869 6e76 6669 6c65 290a  entory(invfile).
+00003500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003510: 7265 7475 726e 2069 6e76 0a20 2020 2020  return inv.     
+00003520: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003530: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00003540: 4572 726f 7228 2243 6f75 6c64 206e 6f74  Error("Could not
+00003550: 2066 696e 6420 6120 5374 6174 696f 6e58   find a StationX
+00003560: 4d4c 2066 696c 6520 666f 7220 7374 6174  ML file for stat
+00003570: 696f 6e3a 2025 732e 2220 2520 7374 6174  ion: %s." % stat
+00003580: 732e 7374 6174 696f 6e29 0a0a 0a64 6566  s.station)...def
+00003590: 2073 7461 7473 3269 6e76 5f73 6163 2873   stats2inv_sac(s
+000035a0: 7461 7473 293a 0a20 2020 2069 6e76 203d  tats):.    inv =
+000035b0: 2049 6e76 656e 746f 7279 286e 6574 776f   Inventory(netwo
+000035c0: 726b 733d 5b5d 2c20 736f 7572 6365 3d22  rks=[], source="
+000035d0: 686f 6d65 6772 6f77 6e22 290a 2020 2020  homegrown").    
+000035e0: 6e65 7420 3d20 4e65 7477 6f72 6b28 0a20  net = Network(. 
+000035f0: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
+00003600: 2074 6865 206e 6574 776f 726b 2063 6f64   the network cod
+00003610: 6520 6163 636f 7264 696e 6720 746f 2074  e according to t
+00003620: 6865 2053 4545 4420 7374 616e 6461 7264  he SEED standard
+00003630: 2e0a 2020 2020 2020 2020 636f 6465 3d73  ..        code=s
+00003640: 7461 7473 2e6e 6574 776f 726b 2c0a 2020  tats.network,.  
+00003650: 2020 2020 2020 7374 6174 696f 6e73 3d5b        stations=[
+00003660: 5d2c 0a20 2020 2020 2020 2064 6573 6372  ],.        descr
+00003670: 6970 7469 6f6e 3d22 6372 6561 7465 6420  iption="created 
+00003680: 6672 6f6d 2053 4143 2061 6e64 2072 6573  from SAC and res
+00003690: 7020 6669 6c65 7322 2c0a 2020 2020 2020  p files",.      
+000036a0: 2020 7374 6172 745f 6461 7465 3d73 7461    start_date=sta
+000036b0: 7473 2e73 7461 7274 7469 6d65 2c0a 2020  ts.starttime,.  
+000036c0: 2020 290a 0a20 2020 2073 7461 203d 2053    )..    sta = S
+000036d0: 7461 7469 6f6e 280a 2020 2020 2020 2020  tation(.        
+000036e0: 2320 5468 6973 2069 7320 7468 6520 7374  # This is the st
+000036f0: 6174 696f 6e20 636f 6465 2061 6363 6f72  ation code accor
+00003700: 6469 6e67 2074 6f20 7468 6520 5345 4544  ding to the SEED
+00003710: 2073 7461 6e64 6172 642e 0a20 2020 2020   standard..     
+00003720: 2020 2063 6f64 653d 7374 6174 732e 7374     code=stats.st
+00003730: 6174 696f 6e2c 0a20 2020 2020 2020 206c  ation,.        l
+00003740: 6174 6974 7564 653d 7374 6174 732e 7361  atitude=stats.sa
+00003750: 635b 2273 746c 6122 5d2c 0a20 2020 2020  c["stla"],.     
+00003760: 2020 206c 6f6e 6769 7475 6465 3d73 7461     longitude=sta
+00003770: 7473 2e73 6163 5b22 7374 6c6f 225d 2c0a  ts.sac["stlo"],.
+00003780: 2020 2020 2020 2020 656c 6576 6174 696f          elevatio
+00003790: 6e3d 7374 6174 732e 7361 635b 2273 7465  n=stats.sac["ste
+000037a0: 6c22 5d2c 0a20 2020 2020 2020 2063 7265  l"],.        cre
+000037b0: 6174 696f 6e5f 6461 7465 3d73 7461 7473  ation_date=stats
+000037c0: 2e73 7461 7274 7469 6d65 2c0a 2020 2020  .starttime,.    
+000037d0: 2020 2020 7369 7465 3d53 6974 6528 6e61      site=Site(na
+000037e0: 6d65 3d22 4669 7273 7420 7374 6174 696f  me="First statio
+000037f0: 6e22 292c 0a20 2020 2029 0a0a 2020 2020  n"),.    )..    
+00003800: 6368 6120 3d20 4368 616e 6e65 6c28 0a20  cha = Channel(. 
+00003810: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
+00003820: 2074 6865 2063 6861 6e6e 656c 2063 6f64   the channel cod
+00003830: 6520 6163 636f 7264 696e 6720 746f 2074  e according to t
+00003840: 6865 2053 4545 4420 7374 616e 6461 7264  he SEED standard
+00003850: 2e0a 2020 2020 2020 2020 636f 6465 3d73  ..        code=s
+00003860: 7461 7473 2e63 6861 6e6e 656c 2c0a 2020  tats.channel,.  
+00003870: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
+00003880: 7468 6520 6c6f 6361 7469 6f6e 2063 6f64  the location cod
+00003890: 6520 6163 636f 7264 696e 6720 746f 2074  e according to t
+000038a0: 6865 2053 4545 4420 7374 616e 6461 7264  he SEED standard
+000038b0: 2e0a 2020 2020 2020 2020 6c6f 6361 7469  ..        locati
+000038c0: 6f6e 5f63 6f64 653d 7374 6174 732e 6c6f  on_code=stats.lo
+000038d0: 6361 7469 6f6e 2c0a 2020 2020 2020 2020  cation,.        
+000038e0: 2320 4e6f 7465 2074 6861 7420 7468 6573  # Note that thes
+000038f0: 6520 636f 6f72 6469 6e61 7465 7320 6361  e coordinates ca
+00003900: 6e20 6469 6666 6572 2066 726f 6d20 7468  n differ from th
+00003910: 6520 7374 6174 696f 6e20 636f 6f72 6469  e station coordi
+00003920: 6e61 7465 732e 0a20 2020 2020 2020 206c  nates..        l
+00003930: 6174 6974 7564 653d 7374 6174 732e 7361  atitude=stats.sa
+00003940: 635b 2273 746c 6122 5d2c 0a20 2020 2020  c["stla"],.     
+00003950: 2020 206c 6f6e 6769 7475 6465 3d73 7461     longitude=sta
+00003960: 7473 2e73 6163 5b22 7374 6c6f 225d 2c0a  ts.sac["stlo"],.
+00003970: 2020 2020 2020 2020 656c 6576 6174 696f          elevatio
+00003980: 6e3d 7374 6174 732e 7361 635b 2273 7465  n=stats.sac["ste
+00003990: 6c22 5d2c 0a20 2020 2020 2020 2064 6570  l"],.        dep
+000039a0: 7468 3d2d 7374 6174 732e 7361 635b 2273  th=-stats.sac["s
+000039b0: 7465 6c22 5d2c 0a20 2020 2020 2020 2061  tel"],.        a
+000039c0: 7a69 6d75 7468 3d73 7461 7473 2e73 6163  zimuth=stats.sac
+000039d0: 5b22 636d 7061 7a22 5d2c 0a20 2020 2020  ["cmpaz"],.     
+000039e0: 2020 2064 6970 3d73 7461 7473 2e73 6163     dip=stats.sac
+000039f0: 5b22 636d 7069 6e63 225d 2c0a 2020 2020  ["cmpinc"],.    
+00003a00: 2020 2020 7361 6d70 6c65 5f72 6174 653d      sample_rate=
+00003a10: 7374 6174 732e 7361 6d70 6c69 6e67 5f72  stats.sampling_r
+00003a20: 6174 652c 0a20 2020 2029 0a20 2020 2072  ate,.    ).    r
+00003a30: 6573 706f 6e73 6520 3d20 6f62 7370 792e  esponse = obspy.
+00003a40: 636f 7265 2e69 6e76 656e 746f 7279 2e72  core.inventory.r
+00003a50: 6573 706f 6e73 652e 5265 7370 6f6e 7365  esponse.Response
+00003a60: 2829 0a0a 2020 2020 2320 4e6f 7720 7469  ()..    # Now ti
+00003a70: 6520 6974 2061 6c6c 2074 6f67 6574 6865  e it all togethe
+00003a80: 722e 0a20 2020 2063 6861 2e72 6573 706f  r..    cha.respo
+00003a90: 6e73 6520 3d20 7265 7370 6f6e 7365 0a20  nse = response. 
+00003aa0: 2020 2073 7461 2e63 6861 6e6e 656c 732e     sta.channels.
+00003ab0: 6170 7065 6e64 2863 6861 290a 2020 2020  append(cha).    
+00003ac0: 6e65 742e 7374 6174 696f 6e73 2e61 7070  net.stations.app
+00003ad0: 656e 6428 7374 6129 0a20 2020 2069 6e76  end(sta).    inv
+00003ae0: 2e6e 6574 776f 726b 732e 6170 7065 6e64  .networks.append
+00003af0: 286e 6574 290a 0a20 2020 2072 6574 7572  (net)..    retur
+00003b00: 6e20 696e 760a 0a0a 6465 6620 7374 6174  n inv...def stat
+00003b10: 7332 696e 765f 6d73 6565 6428 7374 6174  s2inv_mseed(stat
+00003b20: 732c 206c 6f63 733a 2070 642e 4461 7461  s, locs: pd.Data
+00003b30: 4672 616d 6529 202d 3e20 496e 7665 6e74  Frame) -> Invent
+00003b40: 6f72 793a 0a20 2020 2069 6e76 203d 2049  ory:.    inv = I
+00003b50: 6e76 656e 746f 7279 286e 6574 776f 726b  nventory(network
+00003b60: 733d 5b5d 2c20 736f 7572 6365 3d22 686f  s=[], source="ho
+00003b70: 6d65 6772 6f77 6e22 290a 2020 2020 6973  megrown").    is
+00003b80: 7461 203d 206c 6f63 735b 6c6f 6373 5b22  ta = locs[locs["
+00003b90: 7374 6174 696f 6e22 5d20 3d3d 2073 7461  station"] == sta
+00003ba0: 7473 2e73 7461 7469 6f6e 5d2e 696e 6465  ts.station].inde
+00003bb0: 782e 7661 6c75 6573 2e61 7374 7970 6528  x.values.astype(
+00003bc0: 2269 6e74 3634 2229 5b30 5d0a 0a20 2020  "int64")[0]..   
+00003bd0: 206e 6574 203d 204e 6574 776f 726b 280a   net = Network(.
+00003be0: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+00003bf0: 7320 7468 6520 6e65 7477 6f72 6b20 636f  s the network co
+00003c00: 6465 2061 6363 6f72 6469 6e67 2074 6f20  de according to 
+00003c10: 7468 6520 5345 4544 2073 7461 6e64 6172  the SEED standar
+00003c20: 642e 0a20 2020 2020 2020 2063 6f64 653d  d..        code=
+00003c30: 6c6f 6373 2e69 6c6f 635b 6973 7461 5d5b  locs.iloc[ista][
+00003c40: 226e 6574 776f 726b 225d 2c0a 2020 2020  "network"],.    
+00003c50: 2020 2020 7374 6174 696f 6e73 3d5b 5d2c      stations=[],
+00003c60: 0a20 2020 2020 2020 2064 6573 6372 6970  .        descrip
+00003c70: 7469 6f6e 3d22 6372 6561 7465 6420 6672  tion="created fr
+00003c80: 6f6d 2053 4143 2061 6e64 2072 6573 7020  om SAC and resp 
+00003c90: 6669 6c65 7322 2c0a 2020 2020 2020 2020  files",.        
+00003ca0: 7374 6172 745f 6461 7465 3d73 7461 7473  start_date=stats
+00003cb0: 2e73 7461 7274 7469 6d65 2c0a 2020 2020  .starttime,.    
+00003cc0: 290a 0a20 2020 2073 7461 203d 2053 7461  )..    sta = Sta
+00003cd0: 7469 6f6e 280a 2020 2020 2020 2020 2320  tion(.        # 
+00003ce0: 5468 6973 2069 7320 7468 6520 7374 6174  This is the stat
+00003cf0: 696f 6e20 636f 6465 2061 6363 6f72 6469  ion code accordi
+00003d00: 6e67 2074 6f20 7468 6520 5345 4544 2073  ng to the SEED s
+00003d10: 7461 6e64 6172 642e 0a20 2020 2020 2020  tandard..       
+00003d20: 2063 6f64 653d 6c6f 6373 2e69 6c6f 635b   code=locs.iloc[
+00003d30: 6973 7461 5d5b 2273 7461 7469 6f6e 225d  ista]["station"]
+00003d40: 2c0a 2020 2020 2020 2020 6c61 7469 7475  ,.        latitu
+00003d50: 6465 3d6c 6f63 732e 696c 6f63 5b69 7374  de=locs.iloc[ist
+00003d60: 615d 5b22 6c61 7469 7475 6465 225d 2c0a  a]["latitude"],.
+00003d70: 2020 2020 2020 2020 6c6f 6e67 6974 7564          longitud
+00003d80: 653d 6c6f 6373 2e69 6c6f 635b 6973 7461  e=locs.iloc[ista
+00003d90: 5d5b 226c 6f6e 6769 7475 6465 225d 2c0a  ]["longitude"],.
+00003da0: 2020 2020 2020 2020 656c 6576 6174 696f          elevatio
+00003db0: 6e3d 6c6f 6373 2e69 6c6f 635b 6973 7461  n=locs.iloc[ista
+00003dc0: 5d5b 2265 6c65 7661 7469 6f6e 225d 2c0a  ]["elevation"],.
+00003dd0: 2020 2020 2020 2020 6372 6561 7469 6f6e          creation
+00003de0: 5f64 6174 653d 7374 6174 732e 7374 6172  _date=stats.star
+00003df0: 7474 696d 652c 0a20 2020 2020 2020 2073  ttime,.        s
+00003e00: 6974 653d 5369 7465 286e 616d 653d 2246  ite=Site(name="F
+00003e10: 6972 7374 2073 7461 7469 6f6e 2229 2c0a  irst station"),.
+00003e20: 2020 2020 290a 0a20 2020 2063 6861 203d      )..    cha =
+00003e30: 2043 6861 6e6e 656c 280a 2020 2020 2020   Channel(.      
+00003e40: 2020 636f 6465 3d73 7461 7473 2e63 6861    code=stats.cha
+00003e50: 6e6e 656c 2c0a 2020 2020 2020 2020 6c6f  nnel,.        lo
+00003e60: 6361 7469 6f6e 5f63 6f64 653d 7374 6174  cation_code=stat
+00003e70: 732e 6c6f 6361 7469 6f6e 2c0a 2020 2020  s.location,.    
+00003e80: 2020 2020 6c61 7469 7475 6465 3d6c 6f63      latitude=loc
+00003e90: 732e 696c 6f63 5b69 7374 615d 5b22 6c61  s.iloc[ista]["la
+00003ea0: 7469 7475 6465 225d 2c0a 2020 2020 2020  titude"],.      
+00003eb0: 2020 6c6f 6e67 6974 7564 653d 6c6f 6373    longitude=locs
+00003ec0: 2e69 6c6f 635b 6973 7461 5d5b 226c 6f6e  .iloc[ista]["lon
+00003ed0: 6769 7475 6465 225d 2c0a 2020 2020 2020  gitude"],.      
+00003ee0: 2020 656c 6576 6174 696f 6e3d 6c6f 6373    elevation=locs
+00003ef0: 2e69 6c6f 635b 6973 7461 5d5b 2265 6c65  .iloc[ista]["ele
+00003f00: 7661 7469 6f6e 225d 2c0a 2020 2020 2020  vation"],.      
+00003f10: 2020 6465 7074 683d 2d6c 6f63 732e 696c    depth=-locs.il
+00003f20: 6f63 5b69 7374 615d 5b22 656c 6576 6174  oc[ista]["elevat
+00003f30: 696f 6e22 5d2c 0a20 2020 2020 2020 2061  ion"],.        a
+00003f40: 7a69 6d75 7468 3d30 2c0a 2020 2020 2020  zimuth=0,.      
+00003f50: 2020 6469 703d 302c 0a20 2020 2020 2020    dip=0,.       
+00003f60: 2073 616d 706c 655f 7261 7465 3d73 7461   sample_rate=sta
+00003f70: 7473 2e73 616d 706c 696e 675f 7261 7465  ts.sampling_rate
+00003f80: 2c0a 2020 2020 290a 0a20 2020 2072 6573  ,.    )..    res
+00003f90: 706f 6e73 6520 3d20 6f62 7370 792e 636f  ponse = obspy.co
+00003fa0: 7265 2e69 6e76 656e 746f 7279 2e72 6573  re.inventory.res
+00003fb0: 706f 6e73 652e 5265 7370 6f6e 7365 2829  ponse.Response()
+00003fc0: 0a0a 2020 2020 2320 4e6f 7720 7469 6520  ..    # Now tie 
+00003fd0: 6974 2061 6c6c 2074 6f67 6574 6865 722e  it all together.
+00003fe0: 0a20 2020 2063 6861 2e72 6573 706f 6e73  .    cha.respons
+00003ff0: 6520 3d20 7265 7370 6f6e 7365 0a20 2020  e = response.   
+00004000: 2073 7461 2e63 6861 6e6e 656c 732e 6170   sta.channels.ap
+00004010: 7065 6e64 2863 6861 290a 2020 2020 6e65  pend(cha).    ne
+00004020: 742e 7374 6174 696f 6e73 2e61 7070 656e  t.stations.appen
+00004030: 6428 7374 6129 0a20 2020 2069 6e76 2e6e  d(sta).    inv.n
+00004040: 6574 776f 726b 732e 6170 7065 6e64 286e  etworks.append(n
+00004050: 6574 290a 0a20 2020 2072 6574 7572 6e20  et)..    return 
+00004060: 696e 760a 0a0a 6465 6620 7374 615f 696e  inv...def sta_in
+00004070: 666f 5f66 726f 6d5f 696e 7628 696e 763a  fo_from_inv(inv:
+00004080: 206f 6273 7079 2e63 6f72 652e 696e 7665   obspy.core.inve
+00004090: 6e74 6f72 792e 696e 7665 6e74 6f72 792e  ntory.inventory.
+000040a0: 496e 7665 6e74 6f72 7929 3a0a 2020 2020  Inventory):.    
+000040b0: 2222 220a 2020 2020 7468 6973 2066 756e  """.    this fun
+000040c0: 6374 696f 6e20 6f75 7470 7574 7320 7374  ction outputs st
+000040d0: 6174 696f 6e20 696e 666f 2066 726f 6d20  ation info from 
+000040e0: 7468 6520 6f62 7370 7920 696e 7665 6e74  the obspy invent
+000040f0: 6f72 7920 6f62 6a65 6374 0a20 2020 2028  ory object.    (
+00004100: 7573 6564 2069 6e20 5330 4229 0a20 2020  used in S0B).   
+00004110: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
+00004120: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00004130: 2d2d 2d2d 2d2d 2d0a 2020 2020 696e 763a  -------.    inv:
+00004140: 206f 6273 7079 2069 6e76 656e 746f 7279   obspy inventory
+00004150: 206f 626a 6563 740a 2020 2020 5245 5455   object.    RETU
+00004160: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
+00004170: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00004180: 2020 2020 7374 613a 2073 7461 7469 6f6e      sta: station
+00004190: 206e 616d 650a 2020 2020 6e65 743a 206e   name.    net: n
+000041a0: 6574 6f77 726b 206e 616d 650a 2020 2020  etowrk name.    
+000041b0: 6c6f 6e3a 206c 6f6e 6769 7475 6465 206f  lon: longitude o
+000041c0: 6620 7468 6520 7374 6174 696f 6e0a 2020  f the station.  
+000041d0: 2020 6c61 743a 206c 6174 6974 7564 6520    lat: latitude 
+000041e0: 6f66 2074 6865 2073 7461 7469 6f6e 0a20  of the station. 
+000041f0: 2020 2065 6c76 3a20 656c 6576 6174 696f     elv: elevatio
+00004200: 6e20 6f66 2074 6865 2073 7461 7469 6f6e  n of the station
+00004210: 0a20 2020 206c 6f63 6174 696f 6e3a 206c  .    location: l
+00004220: 6f63 6174 696f 6e20 636f 6465 206f 6620  ocation code of 
+00004230: 7468 6520 7374 6174 696f 6e0a 2020 2020  the station.    
+00004240: 2222 220a 2020 2020 2320 6c6f 6164 2066  """.    # load f
+00004250: 726f 6d20 7374 6174 696f 6e20 696e 7665  rom station inve
+00004260: 6e74 6f72 790a 2020 2020 7374 6120 3d20  ntory.    sta = 
+00004270: 696e 765b 305d 5b30 5d2e 636f 6465 0a20  inv[0][0].code. 
+00004280: 2020 206e 6574 203d 2069 6e76 5b30 5d2e     net = inv[0].
+00004290: 636f 6465 0a20 2020 206c 6f6e 203d 2069  code.    lon = i
+000042a0: 6e76 5b30 5d5b 305d 2e6c 6f6e 6769 7475  nv[0][0].longitu
+000042b0: 6465 0a20 2020 206c 6174 203d 2069 6e76  de.    lat = inv
+000042c0: 5b30 5d5b 305d 2e6c 6174 6974 7564 650a  [0][0].latitude.
+000042d0: 2020 2020 6966 2069 6e76 5b30 5d5b 305d      if inv[0][0]
+000042e0: 2e65 6c65 7661 7469 6f6e 3a0a 2020 2020  .elevation:.    
+000042f0: 2020 2020 656c 7620 3d20 696e 765b 305d      elv = inv[0]
+00004300: 5b30 5d2e 656c 6576 6174 696f 6e0a 2020  [0].elevation.  
+00004310: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00004320: 656c 7620 3d20 302e 300a 0a20 2020 2069  elv = 0.0..    i
+00004330: 6620 696e 765b 305d 5b30 5d5b 305d 2e6c  f inv[0][0][0].l
+00004340: 6f63 6174 696f 6e5f 636f 6465 3a0a 2020  ocation_code:.  
+00004350: 2020 2020 2020 6c6f 6361 7469 6f6e 203d        location =
+00004360: 2069 6e76 5b30 5d5b 305d 5b30 5d2e 6c6f   inv[0][0][0].lo
+00004370: 6361 7469 6f6e 5f63 6f64 650a 2020 2020  cation_code.    
+00004380: 656c 7365 3a0a 2020 2020 2020 2020 6c6f  else:.        lo
+00004390: 6361 7469 6f6e 203d 2022 3030 220a 0a20  cation = "00".. 
+000043a0: 2020 2072 6574 7572 6e20 7374 612c 206e     return sta, n
+000043b0: 6574 2c20 6c6f 6e2c 206c 6174 2c20 656c  et, lon, lat, el
+000043c0: 762c 206c 6f63 6174 696f 6e0a 0a0a 6465  v, location...de
+000043d0: 6620 6375 745f 7472 6163 655f 6d61 6b65  f cut_trace_make
+000043e0: 5f73 7461 7428 6663 5f70 6172 613a 2043  _stat(fc_para: C
+000043f0: 6f6e 6669 6750 6172 616d 6574 6572 732c  onfigParameters,
+00004400: 2063 685f 6461 7461 3a20 4368 616e 6e65   ch_data: Channe
+00004410: 6c44 6174 6129 3a0a 2020 2020 2222 220a  lData):.    """.
+00004420: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
+00004430: 6e20 6375 7473 2063 6f6e 7469 6e6f 7573  n cuts continous
+00004440: 206e 6f69 7365 2064 6174 6120 696e 746f   noise data into
+00004450: 2075 7365 722d 6465 6669 6e65 6420 7365   user-defined se
+00004460: 676d 656e 7473 2c20 6573 7469 6d61 7465  gments, estimate
+00004470: 2074 6865 2073 7461 7469 7374 6963 7320   the statistics 
+00004480: 6f66 0a20 2020 2065 6163 6820 7365 676d  of.    each segm
+00004490: 656e 7420 616e 6420 6b65 6570 2074 696d  ent and keep tim
+000044a0: 6573 7461 6d70 206f 6620 6561 6368 2073  estamp of each s
+000044b0: 6567 6d65 6e74 2066 6f72 206c 6174 6572  egment for later
+000044c0: 2075 7365 2e20 2875 7365 6420 696e 2053   use. (used in S
+000044d0: 3129 0a20 2020 2050 4152 414d 4554 4552  1).    PARAMETER
+000044e0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+000044f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00004500: 2020 6666 745f 7061 7261 3a20 4120 6469    fft_para: A di
+00004510: 6374 696f 6e61 7279 2063 6f6e 7461 696e  ctionary contain
+00004520: 696e 6720 616c 6c20 6666 7420 616e 6420  ing all fft and 
+00004530: 6363 2070 6172 616d 6574 6572 732e 0a20  cc parameters.. 
+00004540: 2020 2073 6f75 7263 653a 206f 6273 7079     source: obspy
+00004550: 2073 7472 6561 6d20 6f62 6a65 6374 0a20   stream object. 
+00004560: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
+00004570: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004580: 2d2d 2d2d 2d2d 0a20 2020 2074 7261 6365  ------.    trace
+00004590: 5f73 7464 533a 2073 7461 6e64 6172 6420  _stdS: standard 
+000045a0: 6465 7669 6174 696f 6e20 6f66 2074 6865  deviation of the
+000045b0: 206e 6f69 7365 2061 6d70 6c69 7475 6465   noise amplitude
+000045c0: 206f 6620 6561 6368 2073 6567 6d65 6e74   of each segment
+000045d0: 0a20 2020 2064 6174 6153 5f74 3a20 2020  .    dataS_t:   
+000045e0: 2074 696d 6573 7461 6d70 7320 6f66 2065   timestamps of e
+000045f0: 6163 6820 7365 676d 656e 740a 2020 2020  ach segment.    
+00004600: 6461 7461 533a 2020 2020 2020 3244 206d  dataS:      2D m
+00004610: 6174 7269 7820 6f66 2074 6865 2073 6567  atrix of the seg
+00004620: 6d65 6e74 6564 2064 6174 610a 2020 2020  mented data.    
+00004630: 2222 220a 2020 2020 2320 6465 6669 6e65  """.    # define
+00004640: 2072 6574 7572 6e20 7661 7269 6162 6c65   return variable
+00004650: 7320 6669 7273 740a 2020 2020 736f 7572  s first.    sour
+00004660: 6365 5f70 6172 616d 7320 3d20 5b5d 0a20  ce_params = []. 
+00004670: 2020 2064 6174 6153 5f74 203d 205b 5d0a     dataS_t = [].
+00004680: 2020 2020 6461 7461 5320 3d20 5b5d 0a0a      dataS = []..
+00004690: 2020 2020 2320 7573 6566 756c 2070 6172      # useful par
+000046a0: 616d 6574 6572 7320 666f 7220 7472 6163  ameters for trac
+000046b0: 6520 736c 6964 696e 670a 2020 2020 6e73  e sliding.    ns
+000046c0: 6567 203d 2069 6e74 286e 702e 666c 6f6f  eg = int(np.floo
+000046d0: 7228 2866 635f 7061 7261 2e69 6e63 5f68  r((fc_para.inc_h
+000046e0: 6f75 7273 202f 2032 3420 2a20 3836 3430  ours / 24 * 8640
+000046f0: 3020 2d20 6663 5f70 6172 612e 6363 5f6c  0 - fc_para.cc_l
+00004700: 656e 2920 2f20 6663 5f70 6172 612e 7374  en) / fc_para.st
+00004710: 6570 2929 0a20 2020 2073 7073 203d 2069  ep)).    sps = i
+00004720: 6e74 2863 685f 6461 7461 2e73 616d 706c  nt(ch_data.sampl
+00004730: 696e 675f 7261 7465 290a 2020 2020 7374  ing_rate).    st
+00004740: 6172 7474 696d 6520 3d20 6368 5f64 6174  arttime = ch_dat
+00004750: 612e 7374 6172 745f 7469 6d65 7374 616d  a.start_timestam
+00004760: 700a 2020 2020 2320 636f 7079 2064 6174  p.    # copy dat
+00004770: 6120 696e 746f 2061 7272 6179 0a20 2020  a into array.   
+00004780: 2064 6174 6120 3d20 6368 5f64 6174 612e   data = ch_data.
+00004790: 6461 7461 0a0a 2020 2020 2320 6966 2074  data..    # if t
+000047a0: 6865 2064 6174 6120 6973 2073 686f 7274  he data is short
+000047b0: 6572 2074 6861 6e20 7468 6520 7469 6d20  er than the tim 
+000047c0: 6368 756e 636b 2c20 7265 7475 726e 207a  chunck, return z
+000047d0: 6572 6f20 7661 6c75 6573 0a20 2020 2069  ero values.    i
+000047e0: 6620 6461 7461 2e73 697a 6520 3c20 7370  f data.size < sp
+000047f0: 7320 2a20 6663 5f70 6172 612e 696e 635f  s * fc_para.inc_
+00004800: 686f 7572 7320 2a20 3336 3030 3a0a 2020  hours * 3600:.  
+00004810: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00004820: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+00004830: 2020 6622 5468 6520 6461 7461 2028 7b64    f"The data ({d
+00004840: 6174 612e 7369 7a65 7d29 2069 7320 7368  ata.size}) is sh
+00004850: 6f72 7465 7220 7468 616e 2074 6865 2074  orter than the t
+00004860: 696d 6520 6368 756e 6b20 287b 7370 732a  ime chunk ({sps*
+00004870: 6663 5f70 6172 612e 696e 635f 686f 7572  fc_para.inc_hour
+00004880: 732a 3336 3030 7d29 220a 2020 2020 2020  s*3600})".      
+00004890: 2020 2020 2020 222c 2072 6574 7572 6e69        ", returni
+000048a0: 6e67 207a 6572 6f20 7661 6c75 6573 2e22  ng zero values."
+000048b0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000048c0: 2020 2072 6574 7572 6e20 736f 7572 6365     return source
+000048d0: 5f70 6172 616d 732c 2064 6174 6153 5f74  _params, dataS_t
+000048e0: 2c20 6461 7461 530a 0a20 2020 2023 2073  , dataS..    # s
+000048f0: 7461 7469 7374 6963 2074 6f20 6465 7465  tatistic to dete
+00004900: 6374 2073 6567 6d65 6e74 7320 7468 6174  ct segments that
+00004910: 206d 6179 2062 6520 6173 736f 6369 6174   may be associat
+00004920: 6564 2077 6974 6820 6561 7274 6871 7561  ed with earthqua
+00004930: 6b65 730a 2020 2020 616c 6c5f 6d61 6453  kes.    all_madS
+00004940: 203d 206d 6164 2864 6174 6129 2020 2320   = mad(data)  # 
+00004950: 6d65 6469 616e 2061 6273 6f6c 7574 6520  median absolute 
+00004960: 6465 7669 6174 696f 6e20 6f76 6572 2061  deviation over a
+00004970: 6c6c 206e 6f69 7365 2077 696e 646f 770a  ll noise window.
+00004980: 2020 2020 616c 6c5f 7374 6453 203d 206e      all_stdS = n
+00004990: 702e 7374 6428 6461 7461 2920 2023 2073  p.std(data)  # s
+000049a0: 7461 6e64 6172 6420 6465 7669 6174 696f  tandard deviatio
+000049b0: 6e20 6f76 6572 2061 6c6c 206e 6f69 7365  n over all noise
+000049c0: 2077 696e 646f 770a 2020 2020 6966 2061   window.    if a
+000049d0: 6c6c 5f6d 6164 5320 3d3d 2030 206f 7220  ll_madS == 0 or 
+000049e0: 616c 6c5f 7374 6453 203d 3d20 3020 6f72  all_stdS == 0 or
+000049f0: 206e 702e 6973 6e61 6e28 616c 6c5f 6d61   np.isnan(all_ma
+00004a00: 6453 2920 6f72 206e 702e 6973 6e61 6e28  dS) or np.isnan(
+00004a10: 616c 6c5f 7374 6453 293a 0a20 2020 2020  all_stdS):.     
+00004a20: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00004a30: 2263 6f6e 7469 6e75 6521 206d 6164 5320  "continue! madS 
+00004a40: 6f72 2073 7464 5320 6571 7561 6c73 2074  or stdS equals t
+00004a50: 6f20 3020 666f 7220 2573 2229 0a20 2020  o 0 for %s").   
+00004a60: 2020 2020 2072 6574 7572 6e20 736f 7572       return sour
+00004a70: 6365 5f70 6172 616d 732c 2064 6174 6153  ce_params, dataS
+00004a80: 5f74 2c20 6461 7461 530a 0a20 2020 2023  _t, dataS..    #
+00004a90: 2069 6e69 7469 616c 697a 6520 7661 7269   initialize vari
+00004aa0: 6162 6c65 730a 2020 2020 6e70 7473 203d  ables.    npts =
+00004ab0: 2069 6e74 2866 635f 7061 7261 2e63 635f   int(fc_para.cc_
+00004ac0: 6c65 6e20 2a20 7370 7329 0a20 2020 2023  len * sps).    #
+00004ad0: 2074 7261 6365 5f6d 6164 5320 3d20 6e70   trace_madS = np
+00004ae0: 2e7a 6572 6f73 286e 7365 672c 6474 7970  .zeros(nseg,dtyp
+00004af0: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
+00004b00: 2020 7472 6163 655f 7374 6453 203d 206e    trace_stdS = n
+00004b10: 702e 7a65 726f 7328 6e73 6567 2c20 6474  p.zeros(nseg, dt
+00004b20: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+00004b30: 2020 2020 6461 7461 5320 3d20 6e70 2e7a      dataS = np.z
+00004b40: 6572 6f73 2873 6861 7065 3d28 696e 7428  eros(shape=(int(
+00004b50: 6e73 6567 292c 2069 6e74 286e 7074 7329  nseg), int(npts)
+00004b60: 292c 2064 7479 7065 3d6e 702e 666c 6f61  ), dtype=np.floa
+00004b70: 7433 3229 0a20 2020 2064 6174 6153 5f74  t32).    dataS_t
+00004b80: 203d 206e 702e 7a65 726f 7328 6e73 6567   = np.zeros(nseg
+00004b90: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
+00004ba0: 3332 290a 0a20 2020 2069 6e64 7831 203d  32)..    indx1 =
+00004bb0: 2030 0a20 2020 2066 6f72 2069 7365 6720   0.    for iseg 
+00004bc0: 696e 2072 616e 6765 286e 7365 6729 3a0a  in range(nseg):.
+00004bd0: 2020 2020 2020 2020 696e 6478 3220 3d20          indx2 = 
+00004be0: 696e 6478 3120 2b20 6e70 7473 0a20 2020  indx1 + npts.   
+00004bf0: 2020 2020 2064 6174 6153 5b69 7365 675d       dataS[iseg]
+00004c00: 203d 2064 6174 615b 696e 6478 313a 696e   = data[indx1:in
+00004c10: 6478 325d 0a20 2020 2020 2020 2023 2074  dx2].        # t
+00004c20: 7261 6365 5f6d 6164 535b 6973 6567 5d20  race_madS[iseg] 
+00004c30: 3d20 286e 702e 6d61 7828 6e70 2e61 6273  = (np.max(np.abs
+00004c40: 2864 6174 6153 5b69 7365 675d 2929 2f61  (dataS[iseg]))/a
+00004c50: 6c6c 5f6d 6164 5329 0a20 2020 2020 2020  ll_madS).       
+00004c60: 2074 7261 6365 5f73 7464 535b 6973 6567   trace_stdS[iseg
+00004c70: 5d20 3d20 6e70 2e6d 6178 286e 702e 6162  ] = np.max(np.ab
+00004c80: 7328 6461 7461 535b 6973 6567 5d29 2920  s(dataS[iseg])) 
+00004c90: 2f20 616c 6c5f 7374 6453 0a20 2020 2020  / all_stdS.     
+00004ca0: 2020 2064 6174 6153 5f74 5b69 7365 675d     dataS_t[iseg]
+00004cb0: 203d 2073 7461 7274 7469 6d65 202b 2066   = starttime + f
+00004cc0: 635f 7061 7261 2e73 7465 7020 2a20 6973  c_para.step * is
+00004cd0: 6567 0a20 2020 2020 2020 2069 6e64 7831  eg.        indx1
+00004ce0: 203d 2069 6e64 7831 202b 2069 6e74 2866   = indx1 + int(f
+00004cf0: 635f 7061 7261 2e73 7465 7029 202a 2073  c_para.step) * s
+00004d00: 7073 0a0a 2020 2020 2320 3244 2061 7272  ps..    # 2D arr
+00004d10: 6179 2070 726f 6365 7373 696e 670a 2020  ay processing.  
+00004d20: 2020 6461 7461 5320 3d20 6465 6d65 616e    dataS = demean
+00004d30: 2864 6174 6153 290a 2020 2020 6461 7461  (dataS).    data
+00004d40: 5320 3d20 6465 7472 656e 6428 6461 7461  S = detrend(data
+00004d50: 5329 0a20 2020 2064 6174 6153 203d 2074  S).    dataS = t
+00004d60: 6170 6572 2864 6174 6153 290a 0a20 2020  aper(dataS)..   
+00004d70: 2072 6574 7572 6e20 7472 6163 655f 7374   return trace_st
+00004d80: 6453 2c20 6461 7461 535f 742c 2064 6174  dS, dataS_t, dat
+00004d90: 6153 0a0a 0a64 6566 206e 6f69 7365 5f70  aS...def noise_p
+00004da0: 726f 6365 7373 696e 6728 6666 745f 7061  rocessing(fft_pa
+00004db0: 7261 2c20 6461 7461 5329 3a0a 2020 2020  ra, dataS):.    
+00004dc0: 2222 220a 2020 2020 7468 6973 2066 756e  """.    this fun
+00004dd0: 6374 696f 6e20 7065 7266 6f72 6d73 2074  ction performs t
+00004de0: 696d 6520 646f 6d61 696e 2061 6e64 2066  ime domain and f
+00004df0: 7265 7175 656e 6379 2064 6f6d 6169 6e20  requency domain 
+00004e00: 6e6f 726d 616c 697a 6174 696f 6e20 6966  normalization if
+00004e10: 206e 6565 6465 642e 2069 6e20 7265 616c   needed. in real
+00004e20: 2063 6173 652c 2077 6520 7072 6566 6572   case, we prefer
+00004e30: 2075 7365 2069 6e63 6c75 6465 0a20 2020   use include.   
+00004e40: 2074 6865 206e 6f72 6d61 6c69 7a61 7469   the normalizati
+00004e50: 6f6e 2069 6e20 7468 6520 6372 6f73 732d  on in the cross-
+00004e60: 636f 7272 6561 6c74 696f 6e20 7374 6570  correaltion step
+00004e70: 7320 6279 2073 656c 6563 7469 6e67 2063  s by selecting c
+00004e80: 6f68 6572 656e 6379 206f 7220 6465 636f  oherency or deco
+00004e90: 6e0a 2020 2020 2850 7269 6574 6f20 6574  n.    (Prieto et
+00004ea0: 2061 6c2c 2032 3030 382c 2032 3030 393b   al, 2008, 2009;
+00004eb0: 2044 656e 6f6c 6c65 2065 7420 616c 2c20   Denolle et al, 
+00004ec0: 3230 3133 290a 2020 2020 5041 524d 4145  2013).    PARMAE
+00004ed0: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+00004ee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004ef0: 2d2d 0a20 2020 2066 6674 5f70 6172 613a  --.    fft_para:
+00004f00: 2064 6963 7469 6f6e 6172 7920 636f 6e74   dictionary cont
+00004f10: 6169 6e69 6e67 2061 6c6c 2075 7365 6675  aining all usefu
+00004f20: 6c20 7661 7269 6162 6c65 7320 7573 6564  l variables used
+00004f30: 2066 6f72 2066 6674 2061 6e64 2063 630a   for fft and cc.
+00004f40: 2020 2020 6461 7461 533a 2032 4420 6d61      dataS: 2D ma
+00004f50: 7472 6978 206f 6620 616c 6c20 7365 676d  trix of all segm
+00004f60: 656e 7465 6420 6e6f 6973 6520 6461 7461  ented noise data
+00004f70: 0a20 2020 2023 204f 5554 5055 5420 5641  .    # OUTPUT VA
+00004f80: 5249 4142 4c45 533a 0a20 2020 2073 6f75  RIABLES:.    sou
+00004f90: 7263 655f 7768 6974 653a 2032 4420 6d61  rce_white: 2D ma
+00004fa0: 7472 6978 206f 6620 6461 7461 2073 7065  trix of data spe
+00004fb0: 6374 7261 0a20 2020 2022 2222 0a20 2020  ctra.    """.   
+00004fc0: 2023 206c 6f61 6420 7061 7261 6d65 7465   # load paramete
+00004fd0: 7273 2066 6972 7374 0a20 2020 2074 696d  rs first.    tim
+00004fe0: 655f 6e6f 726d 203d 2066 6674 5f70 6172  e_norm = fft_par
+00004ff0: 615b 2274 696d 655f 6e6f 726d 225d 0a20  a["time_norm"]. 
+00005000: 2020 2066 7265 715f 6e6f 726d 203d 2066     freq_norm = f
+00005010: 6674 5f70 6172 615b 2266 7265 715f 6e6f  ft_para["freq_no
+00005020: 726d 225d 0a20 2020 2073 6d6f 6f74 685f  rm"].    smooth_
+00005030: 4e20 3d20 6666 745f 7061 7261 5b22 736d  N = fft_para["sm
+00005040: 6f6f 7468 5f4e 225d 0a20 2020 204e 203d  ooth_N"].    N =
+00005050: 2064 6174 6153 2e73 6861 7065 5b30 5d0a   dataS.shape[0].
+00005060: 0a20 2020 2023 202d 2d2d 2d2d 2d74 6f20  .    # ------to 
+00005070: 6e6f 726d 616c 697a 6520 696e 2074 696d  normalize in tim
+00005080: 6520 6f72 206e 6f74 2d2d 2d2d 2d2d 0a20  e or not------. 
+00005090: 2020 2069 6620 7469 6d65 5f6e 6f72 6d20     if time_norm 
+000050a0: 213d 2022 6e6f 223a 0a20 2020 2020 2020  != "no":.       
+000050b0: 2069 6620 7469 6d65 5f6e 6f72 6d20 3d3d   if time_norm ==
+000050c0: 2022 6f6e 655f 6269 7422 3a20 2023 2073   "one_bit":  # s
+000050d0: 6967 6e20 6e6f 726d 616c 697a 6174 696f  ign normalizatio
+000050e0: 6e0a 2020 2020 2020 2020 2020 2020 7768  n.            wh
+000050f0: 6974 6520 3d20 6e70 2e73 6967 6e28 6461  ite = np.sign(da
+00005100: 7461 5329 0a20 2020 2020 2020 2065 6c69  taS).        eli
+00005110: 6620 7469 6d65 5f6e 6f72 6d20 3d3d 2022  f time_norm == "
+00005120: 726d 6122 3a20 2023 2072 756e 6e69 6e67  rma":  # running
+00005130: 206d 6561 6e3a 206e 6f72 6d61 6c69 7a61   mean: normaliza
+00005140: 7469 6f6e 206f 7665 7220 736d 6f6f 7468  tion over smooth
+00005150: 6564 2061 6273 6f6c 7574 6520 6176 6572  ed absolute aver
+00005160: 6167 650a 2020 2020 2020 2020 2020 2020  age.            
+00005170: 7768 6974 6520 3d20 6e70 2e7a 6572 6f73  white = np.zeros
+00005180: 2873 6861 7065 3d64 6174 6153 2e73 6861  (shape=dataS.sha
+00005190: 7065 2c20 6474 7970 653d 6461 7461 532e  pe, dtype=dataS.
+000051a0: 6474 7970 6529 0a20 2020 2020 2020 2020  dtype).         
+000051b0: 2020 2066 6f72 206b 6b6b 2069 6e20 7261     for kkk in ra
+000051c0: 6e67 6528 4e29 3a0a 2020 2020 2020 2020  nge(N):.        
+000051d0: 2020 2020 2020 2020 7768 6974 655b 6b6b          white[kk
+000051e0: 6b2c 203a 5d20 3d20 6461 7461 535b 6b6b  k, :] = dataS[kk
+000051f0: 6b2c 203a 5d20 2f20 6d6f 7669 6e67 5f61  k, :] / moving_a
+00005200: 7665 286e 702e 6162 7328 6461 7461 535b  ve(np.abs(dataS[
+00005210: 6b6b 6b2c 203a 5d29 2c20 736d 6f6f 7468  kkk, :]), smooth
+00005220: 5f4e 290a 0a20 2020 2065 6c73 653a 2020  _N)..    else:  
+00005230: 2320 646f 6e27 7420 6e6f 726d 616c 697a  # don't normaliz
+00005240: 650a 2020 2020 2020 2020 7768 6974 6520  e.        white 
+00005250: 3d20 6461 7461 530a 0a20 2020 2023 202d  = dataS..    # -
+00005260: 2d2d 2d2d 746f 2077 6869 7465 6e20 6f72  ----to whiten or
+00005270: 206e 6f74 2d2d 2d2d 2d2d 0a20 2020 2069   not------.    i
+00005280: 6620 6672 6571 5f6e 6f72 6d20 213d 2022  f freq_norm != "
+00005290: 6e6f 223a 0a20 2020 2020 2020 2073 6f75  no":.        sou
+000052a0: 7263 655f 7768 6974 6520 3d20 7768 6974  rce_white = whit
+000052b0: 656e 2877 6869 7465 2c20 6666 745f 7061  en(white, fft_pa
+000052c0: 7261 2920 2023 2077 6869 7465 6e20 616e  ra)  # whiten an
+000052d0: 6420 7265 7475 726e 2046 4654 0a20 2020  d return FFT.   
+000052e0: 2065 6c73 653a 0a20 2020 2020 2020 204e   else:.        N
+000052f0: 6666 7420 3d20 696e 7428 6e65 7874 5f66  fft = int(next_f
+00005300: 6173 745f 6c65 6e28 696e 7428 6461 7461  ast_len(int(data
+00005310: 532e 7368 6170 655b 315d 2929 290a 2020  S.shape[1]))).  
+00005320: 2020 2020 2020 736f 7572 6365 5f77 6869        source_whi
+00005330: 7465 203d 2073 6369 7079 2e66 6674 7061  te = scipy.fftpa
+00005340: 636b 2e66 6674 2877 6869 7465 2c20 4e66  ck.fft(white, Nf
+00005350: 6674 2c20 6178 6973 3d31 2920 2023 2072  ft, axis=1)  # r
+00005360: 6574 7572 6e20 4646 540a 0a20 2020 2072  eturn FFT..    r
+00005370: 6574 7572 6e20 736f 7572 6365 5f77 6869  eturn source_whi
+00005380: 7465 0a0a 0a64 6566 2073 6d6f 6f74 685f  te...def smooth_
+00005390: 736f 7572 6365 5f73 7065 6374 2863 635f  source_spect(cc_
+000053a0: 7061 7261 2c20 6666 7431 293a 0a20 2020  para, fft1):.   
+000053b0: 2022 2222 0a20 2020 2074 6869 7320 6675   """.    this fu
+000053c0: 6e63 7469 6f6e 2073 6d6f 6f74 6865 7320  nction smoothes 
+000053d0: 616d 706c 6974 7564 6520 7370 6563 7472  amplitude spectr
+000053e0: 756d 206f 6620 7468 6520 3244 2073 7065  um of the 2D spe
+000053f0: 6374 7261 6c20 6d61 7472 6978 2e20 2875  ctral matrix. (u
+00005400: 7365 6420 696e 2053 3129 0a20 2020 2050  sed in S1).    P
+00005410: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
+00005420: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00005430: 2d2d 2d2d 0a20 2020 2063 635f 7061 7261  ----.    cc_para
+00005440: 3a20 6469 6374 696f 6e61 7279 2063 6f6e  : dictionary con
+00005450: 7461 696e 696e 6720 7573 6566 756c 2063  taining useful c
+00005460: 6320 7061 7261 6d65 7465 7273 0a20 2020  c parameters.   
+00005470: 2066 6674 313a 2020 2020 736f 7572 6365   fft1:    source
+00005480: 2073 7065 6374 7275 6d20 6d61 7472 6978   spectrum matrix
+00005490: 0a0a 2020 2020 5245 5455 524e 533a 0a20  ..    RETURNS:. 
+000054a0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+000054b0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073 6666  --------.    sff
+000054c0: 7431 3a20 636f 6d70 6c65 7820 6e75 6d70  t1: complex nump
+000054d0: 7920 6172 7261 7920 7769 7468 206e 6f72  y array with nor
+000054e0: 6d61 6c69 7a65 6420 7370 6563 7472 756d  malized spectrum
+000054f0: 0a20 2020 2022 2222 0a20 2020 2063 635f  .    """.    cc_
+00005500: 6d65 7468 6f64 203d 2063 635f 7061 7261  method = cc_para
+00005510: 5b22 6363 5f6d 6574 686f 6422 5d0a 2020  ["cc_method"].  
+00005520: 2020 736d 6f6f 7468 7370 6563 745f 4e20    smoothspect_N 
+00005530: 3d20 6363 5f70 6172 615b 2273 6d6f 6f74  = cc_para["smoot
+00005540: 6873 7065 6374 5f4e 225d 0a0a 2020 2020  hspect_N"]..    
+00005550: 6966 2063 635f 6d65 7468 6f64 203d 3d20  if cc_method == 
+00005560: 2264 6563 6f6e 7622 3a0a 2020 2020 2020  "deconv":.      
+00005570: 2020 2320 2d2d 2d2d 2d6e 6f72 6d61 6c69    # -----normali
+00005580: 7a65 2073 696e 676c 652d 7374 6174 696f  ze single-statio
+00005590: 6e20 6363 2074 6f20 7a20 636f 6d70 6f6e  n cc to z compon
+000055a0: 656e 742d 2d2d 2d2d 0a20 2020 2020 2020  ent-----.       
+000055b0: 2074 656d 7020 3d20 6d6f 7669 6e67 5f61   temp = moving_a
+000055c0: 7665 286e 702e 6162 7328 6666 7431 292c  ve(np.abs(fft1),
+000055d0: 2073 6d6f 6f74 6873 7065 6374 5f4e 290a   smoothspect_N).
+000055e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000055f0: 2020 2020 2020 2020 2073 6666 7431 203d           sfft1 =
+00005600: 206e 702e 636f 6e6a 2866 6674 3129 202f   np.conj(fft1) /
+00005610: 2074 656d 702a 2a32 0a20 2020 2020 2020   temp**2.       
+00005620: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00005630: 6e3a 0a20 2020 2020 2020 2020 2020 2072  n:.            r
+00005640: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00005650: 2273 6d6f 6f74 6865 6420 7370 6563 7472  "smoothed spectr
+00005660: 756d 2068 6173 207a 6572 6f20 7661 6c75  um has zero valu
+00005670: 6573 2229 0a0a 2020 2020 656c 6966 2063  es")..    elif c
+00005680: 635f 6d65 7468 6f64 203d 3d20 2263 6f68  c_method == "coh
+00005690: 6572 656e 6379 223a 0a20 2020 2020 2020  erency":.       
+000056a0: 2074 656d 7020 3d20 6d6f 7669 6e67 5f61   temp = moving_a
+000056b0: 7665 286e 702e 6162 7328 6666 7431 292c  ve(np.abs(fft1),
+000056c0: 2073 6d6f 6f74 6873 7065 6374 5f4e 290a   smoothspect_N).
+000056d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000056e0: 2020 2020 2020 2020 2073 6666 7431 203d           sfft1 =
+000056f0: 206e 702e 636f 6e6a 2866 6674 3129 202f   np.conj(fft1) /
+00005700: 2074 656d 700a 2020 2020 2020 2020 6578   temp.        ex
+00005710: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
+00005720: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00005730: 6520 5661 6c75 6545 7272 6f72 2822 736d  e ValueError("sm
+00005740: 6f6f 7468 6564 2073 7065 6374 7275 6d20  oothed spectrum 
+00005750: 6861 7320 7a65 726f 2076 616c 7565 7322  has zero values"
+00005760: 290a 0a20 2020 2065 6c69 6620 6363 5f6d  )..    elif cc_m
+00005770: 6574 686f 6420 3d3d 2022 7863 6f72 7222  ethod == "xcorr"
+00005780: 3a0a 2020 2020 2020 2020 7366 6674 3120  :.        sfft1 
+00005790: 3d20 6e70 2e63 6f6e 6a28 6666 7431 290a  = np.conj(fft1).
+000057a0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000057b0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000057c0: 726f 7228 226e 6f20 636f 7272 6563 7469  ror("no correcti
+000057d0: 6f6e 2063 6f72 7265 6c61 7469 6f6e 206d  on correlation m
+000057e0: 6574 686f 6420 6973 2073 656c 6563 7465  ethod is selecte
+000057f0: 6420 6174 204c 3539 2229 0a0a 2020 2020  d at L59")..    
+00005800: 7265 7475 726e 2073 6666 7431 0a0a 0a64  return sfft1...d
+00005810: 6566 2063 6f72 7265 6c61 7465 2866 6674  ef correlate(fft
+00005820: 315f 736d 6f6f 7468 6564 5f61 6273 2c20  1_smoothed_abs, 
+00005830: 6666 7432 2c20 442c 204e 6666 742c 2064  fft2, D, Nfft, d
+00005840: 6174 6153 5f74 293a 0a20 2020 2022 2222  ataS_t):.    """
+00005850: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
+00005860: 6f6e 2064 6f65 7320 7468 6520 6372 6f73  on does the cros
+00005870: 732d 636f 7272 656c 6174 696f 6e20 696e  s-correlation in
+00005880: 2066 7265 7120 646f 6d61 696e 2061 6e64   freq domain and
+00005890: 2068 6173 2074 6865 206f 7074 696f 6e20   has the option 
+000058a0: 746f 206b 6565 7020 7375 622d 7374 6163  to keep sub-stac
+000058b0: 6b73 206f 660a 2020 2020 7468 6520 6372  ks of.    the cr
+000058c0: 6f73 732d 636f 7272 656c 6174 696f 6e20  oss-correlation 
+000058d0: 6966 206e 6565 6465 642e 2069 7420 7461  if needed. it ta
+000058e0: 6b65 7320 6164 7661 6e74 6167 6520 6f66  kes advantage of
+000058f0: 2074 6865 206c 696e 6561 7220 7265 6c61   the linear rela
+00005900: 7469 6f6e 7368 6970 206f 6620 6966 6674  tionship of ifft
+00005910: 2c20 736f 2074 6861 740a 2020 2020 7374  , so that.    st
+00005920: 6163 6b69 6e67 2069 7320 7065 7266 6f72  acking is perfor
+00005930: 6d65 6420 696e 2073 7065 6374 7275 6d20  med in spectrum 
+00005940: 646f 6d61 696e 2066 6972 7374 2074 6f20  domain first to 
+00005950: 7265 6475 6365 2074 6865 2074 6f74 616c  reduce the total
+00005960: 206e 756d 6265 7220 6f66 2069 6666 742e   number of ifft.
+00005970: 2028 7573 6564 2069 6e20 5331 290a 2020   (used in S1).  
+00005980: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
+00005990: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+000059a0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6666 7431  -------.    fft1
+000059b0: 5f73 6d6f 6f74 6865 645f 6162 733a 2073  _smoothed_abs: s
+000059c0: 6d6f 6f74 6865 6420 706f 7765 7220 7370  moothed power sp
+000059d0: 6563 7472 616c 2064 656e 7369 7479 206f  ectral density o
+000059e0: 6620 7468 6520 4646 5420 666f 7220 7468  f the FFT for th
+000059f0: 6520 736f 7572 6365 2073 7461 7469 6f6e  e source station
+00005a00: 0a20 2020 2066 6674 323a 2072 6177 2046  .    fft2: raw F
+00005a10: 4654 2073 7065 6374 7275 6d20 6f66 2074  FT spectrum of t
+00005a20: 6865 2072 6563 6569 7665 7220 7374 6174  he receiver stat
+00005a30: 696f 6e0a 2020 2020 443a 2064 6963 7469  ion.    D: dicti
+00005a40: 6f6e 6172 7920 636f 6e74 6169 6e69 6e67  onary containing
+00005a50: 2066 6f6c 6c6f 7769 6e67 2070 6172 616d   following param
+00005a60: 6574 6572 733a 0a20 2020 2020 2020 206d  eters:.        m
+00005a70: 6178 6c61 673a 2020 6d61 7869 6d75 6d20  axlag:  maximum 
+00005a80: 6c61 6773 2074 6f20 6b65 6570 2069 6e20  lags to keep in 
+00005a90: 7468 6520 6372 6f73 7320 636f 7272 656c  the cross correl
+00005aa0: 6174 696f 6e0a 2020 2020 2020 2020 6474  ation.        dt
+00005ab0: 3a20 2020 2020 2073 616d 706c 696e 6720  :      sampling 
+00005ac0: 7261 7465 2028 696e 2073 290a 2020 2020  rate (in s).    
+00005ad0: 2020 2020 6e77 696e 3a20 2020 206e 756d      nwin:    num
+00005ae0: 6265 7220 6f66 2073 6567 6d65 6e74 7320  ber of segments 
+00005af0: 696e 2074 6865 2032 4420 6d61 7472 6978  in the 2D matrix
+00005b00: 0a20 2020 2020 2020 206d 6574 686f 643a  .        method:
+00005b10: 2020 6372 6f73 732d 636f 7272 656c 6174    cross-correlat
+00005b20: 696f 6e20 6d65 7468 6f64 7320 7365 6c65  ion methods sele
+00005b30: 6374 6564 2062 7920 7468 6520 7573 6572  cted by the user
+00005b40: 0a20 2020 2020 2020 2066 7265 716d 696e  .        freqmin
+00005b50: 3a20 6d69 6e69 6d75 6d20 6672 6571 7565  : minimum freque
+00005b60: 6e63 7920 2848 7a29 0a20 2020 2020 2020  ncy (Hz).       
+00005b70: 2066 7265 716d 6178 3a20 6d61 7869 6d75   freqmax: maximu
+00005b80: 6d20 6672 6571 7565 6e63 7920 2848 7a29  m frequency (Hz)
+00005b90: 0a20 2020 204e 6666 743a 2020 2020 6e75  .    Nfft:    nu
+00005ba0: 6d62 6572 206f 6620 6672 6571 7565 6e63  mber of frequenc
+00005bb0: 7920 706f 696e 7473 2066 6f72 2069 6666  y points for iff
+00005bc0: 740a 2020 2020 6461 7461 535f 743a 206d  t.    dataS_t: m
+00005bd0: 6174 7269 7820 6f66 2064 6174 6574 696d  atrix of datetim
+00005be0: 6520 6f62 6a65 6374 2e0a 0a20 2020 2052  e object...    R
+00005bf0: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
+00005c00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00005c10: 2d0a 2020 2020 735f 636f 7272 3a20 3144  -.    s_corr: 1D
+00005c20: 206f 7220 3244 206d 6174 7269 7820 6f66   or 2D matrix of
+00005c30: 2074 6865 2061 7665 7261 6765 6420 6f72   the averaged or
+00005c40: 2073 7562 2d73 7461 636b 7320 6f66 2063   sub-stacks of c
+00005c50: 726f 7373 2d63 6f72 7265 6c61 7469 6f6e  ross-correlation
+00005c60: 2066 756e 6374 696f 6e73 2069 6e20 7469   functions in ti
+00005c70: 6d65 2064 6f6d 6169 6e0a 2020 2020 745f  me domain.    t_
+00005c80: 636f 7272 3a20 7469 6d65 7374 616d 7020  corr: timestamp 
+00005c90: 666f 7220 6561 6368 2073 7562 2d73 7461  for each sub-sta
+00005ca0: 636b 206f 7220 6176 6572 6167 6564 2066  ck or averaged f
+00005cb0: 756e 6374 696f 6e0a 2020 2020 6e5f 636f  unction.    n_co
+00005cc0: 7272 3a20 6e75 6d62 6572 206f 6620 696e  rr: number of in
+00005cd0: 636c 7564 6564 2073 6567 6d65 6e74 7320  cluded segments 
+00005ce0: 666f 7220 6561 6368 2073 7562 2d73 7461  for each sub-sta
+00005cf0: 636b 206f 7220 6176 6572 6167 6564 2066  ck or averaged f
+00005d00: 756e 6374 696f 6e0a 0a20 2020 204d 4f44  unction..    MOD
+00005d10: 4946 4943 4154 494f 4e53 3a0a 2020 2020  IFICATIONS:.    
+00005d20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00005d30: 2d2d 2d2d 2d0a 2020 2020 6f75 7470 7574  -----.    output
+00005d40: 2074 6865 206c 696e 6561 7220 7374 6163   the linear stac
+00005d50: 6b20 6f66 2065 6163 6820 7469 6d65 2063  k of each time c
+00005d60: 6875 6e6b 2065 7665 6e20 7768 656e 2073  hunk even when s
+00005d70: 7562 7374 6163 6b20 6973 2073 656c 6563  ubstack is selec
+00005d80: 7465 6420 2862 7920 4368 656e 6778 696e  ted (by Chengxin
+00005d90: 2040 4175 6732 3032 3029 0a20 2020 2022   @Aug2020).    "
+00005da0: 2222 0a20 2020 2023 202d 2d2d 2d6c 6f61  "".    # ----loa
+00005db0: 6420 7061 7261 6d74 6572 732d 2d2d 2d0a  d paramters----.
+00005dc0: 2020 2020 6474 203d 2044 5b22 6474 225d      dt = D["dt"]
+00005dd0: 0a20 2020 206d 6178 6c61 6720 3d20 445b  .    maxlag = D[
+00005de0: 226d 6178 6c61 6722 5d0a 2020 2020 6d65  "maxlag"].    me
+00005df0: 7468 6f64 203d 2044 5b22 6363 5f6d 6574  thod = D["cc_met
+00005e00: 686f 6422 5d0a 2020 2020 6363 5f6c 656e  hod"].    cc_len
+00005e10: 203d 2044 5b22 6363 5f6c 656e 225d 0a20   = D["cc_len"]. 
+00005e20: 2020 2073 7562 7374 6163 6b20 3d20 445b     substack = D[
+00005e30: 2273 7562 7374 6163 6b22 5d0a 2020 2020  "substack"].    
+00005e40: 7375 6273 7461 636b 5f6c 656e 203d 2044  substack_len = D
+00005e50: 5b22 7375 6273 7461 636b 5f6c 656e 225d  ["substack_len"]
+00005e60: 0a20 2020 2073 6d6f 6f74 6873 7065 6374  .    smoothspect
+00005e70: 5f4e 203d 2044 5b22 736d 6f6f 7468 7370  _N = D["smoothsp
+00005e80: 6563 745f 4e22 5d0a 0a20 2020 206e 7769  ect_N"]..    nwi
+00005e90: 6e20 3d20 6666 7431 5f73 6d6f 6f74 6865  n = fft1_smoothe
+00005ea0: 645f 6162 732e 7368 6170 655b 305d 0a20  d_abs.shape[0]. 
+00005eb0: 2020 204e 6666 7432 203d 2066 6674 315f     Nfft2 = fft1_
+00005ec0: 736d 6f6f 7468 6564 5f61 6273 2e73 6861  smoothed_abs.sha
+00005ed0: 7065 5b31 5d0a 0a20 2020 2023 202d 2d2d  pe[1]..    # ---
+00005ee0: 2d2d 2d63 6f6e 7665 7274 2061 6c6c 2032  ---convert all 2
+00005ef0: 4420 6172 7261 7973 2069 6e74 6f20 3144  D arrays into 1D
+00005f00: 2074 6f20 7370 6565 6420 7570 2d2d 2d2d   to speed up----
+00005f10: 2d2d 2d2d 0a20 2020 2063 6f72 7220 3d20  ----.    corr = 
+00005f20: 6e70 2e7a 6572 6f73 286e 7769 6e20 2a20  np.zeros(nwin * 
+00005f30: 4e66 6674 322c 2064 7479 7065 3d6e 702e  Nfft2, dtype=np.
+00005f40: 636f 6d70 6c65 7836 3429 0a20 2020 2063  complex64).    c
+00005f50: 6f72 7220 3d20 6666 7431 5f73 6d6f 6f74  orr = fft1_smoot
+00005f60: 6865 645f 6162 732e 7265 7368 6170 6528  hed_abs.reshape(
+00005f70: 0a20 2020 2020 2020 2066 6674 315f 736d  .        fft1_sm
+00005f80: 6f6f 7468 6564 5f61 6273 2e73 697a 652c  oothed_abs.size,
+00005f90: 0a20 2020 2029 202a 2066 6674 322e 7265  .    ) * fft2.re
+00005fa0: 7368 6170 6528 0a20 2020 2020 2020 2066  shape(.        f
+00005fb0: 6674 322e 7369 7a65 2c0a 2020 2020 290a  ft2.size,.    ).
+00005fc0: 0a20 2020 2069 6620 6d65 7468 6f64 203d  .    if method =
+00005fd0: 3d20 2263 6f68 6572 656e 6379 223a 0a20  = "coherency":. 
+00005fe0: 2020 2020 2020 2074 656d 7020 3d20 6d6f         temp = mo
+00005ff0: 7669 6e67 5f61 7665 280a 2020 2020 2020  ving_ave(.      
+00006000: 2020 2020 2020 6e70 2e61 6273 280a 2020        np.abs(.  
+00006010: 2020 2020 2020 2020 2020 2020 2020 6666                ff
+00006020: 7432 2e72 6573 6861 7065 280a 2020 2020  t2.reshape(.    
+00006030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006040: 6666 7432 2e73 697a 652c 0a20 2020 2020  fft2.size,.     
+00006050: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00006060: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00006070: 2020 2020 2020 2020 736d 6f6f 7468 7370          smoothsp
+00006080: 6563 745f 4e2c 0a20 2020 2020 2020 2029  ect_N,.        )
+00006090: 0a20 2020 2020 2020 2063 6f72 7220 2f3d  .        corr /=
+000060a0: 2074 656d 700a 2020 2020 636f 7272 203d   temp.    corr =
+000060b0: 2063 6f72 722e 7265 7368 6170 6528 6e77   corr.reshape(nw
+000060c0: 696e 2c20 4e66 6674 3229 0a0a 2020 2020  in, Nfft2)..    
+000060d0: 6966 2073 7562 7374 6163 6b3a 0a20 2020  if substack:.   
+000060e0: 2020 2020 2069 6620 7375 6273 7461 636b       if substack
+000060f0: 5f6c 656e 203d 3d20 6363 5f6c 656e 3a0a  _len == cc_len:.
+00006100: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
+00006110: 6f6f 7365 2074 6f20 6b65 6570 2061 6c6c  oose to keep all
+00006120: 2066 6674 2064 6174 6120 666f 7220 6120   fft data for a 
+00006130: 6461 790a 2020 2020 2020 2020 2020 2020  day.            
+00006140: 735f 636f 7272 203d 206e 702e 7a65 726f  s_corr = np.zero
+00006150: 7328 7368 6170 653d 286e 7769 6e2c 204e  s(shape=(nwin, N
+00006160: 6666 7429 2c20 6474 7970 653d 6e70 2e66  fft), dtype=np.f
+00006170: 6c6f 6174 3332 2920 2023 2073 7461 636b  loat32)  # stack
+00006180: 6564 2063 6f72 7265 6c61 7469 6f6e 0a20  ed correlation. 
+00006190: 2020 2020 2020 2020 2020 2061 6d70 6d61             ampma
+000061a0: 7820 3d20 6e70 2e7a 6572 6f73 286e 7769  x = np.zeros(nwi
+000061b0: 6e2c 2064 7479 7065 3d6e 702e 666c 6f61  n, dtype=np.floa
+000061c0: 7433 3229 0a20 2020 2020 2020 2020 2020  t32).           
+000061d0: 206e 5f63 6f72 7220 3d20 6e70 2e7a 6572   n_corr = np.zer
+000061e0: 6f73 286e 7769 6e2c 2064 7479 7065 3d6e  os(nwin, dtype=n
+000061f0: 702e 696e 7431 3629 2020 2320 6e75 6d62  p.int16)  # numb
+00006200: 6572 206f 6620 636f 7272 656c 6174 696f  er of correlatio
+00006210: 6e73 2066 6f72 2065 6163 6820 7375 6273  ns for each subs
+00006220: 7461 636b 0a20 2020 2020 2020 2020 2020  tack.           
+00006230: 2074 5f63 6f72 7220 3d20 6461 7461 535f   t_corr = dataS_
+00006240: 7420 2023 2074 696d 6573 7461 6d70 0a20  t  # timestamp. 
+00006250: 2020 2020 2020 2020 2020 2063 7261 7020             crap 
+00006260: 3d20 6e70 2e7a 6572 6f73 284e 6666 742c  = np.zeros(Nfft,
+00006270: 2064 7479 7065 3d6e 702e 636f 6d70 6c65   dtype=np.comple
+00006280: 7836 3429 0a20 2020 2020 2020 2020 2020  x64).           
+00006290: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+000062a0: 6e77 696e 293a 0a20 2020 2020 2020 2020  nwin):.         
+000062b0: 2020 2020 2020 206e 5f63 6f72 725b 695d         n_corr[i]
+000062c0: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+000062d0: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
+000062e0: 5d20 3d20 636f 7272 5b69 2c20 3a5d 0a20  ] = corr[i, :]. 
+000062f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00006300: 7261 705b 3a4e 6666 7432 5d20 3d20 6372  rap[:Nfft2] = cr
+00006310: 6170 5b3a 4e66 6674 325d 202d 206e 702e  ap[:Nfft2] - np.
+00006320: 6d65 616e 2863 7261 705b 3a4e 6666 7432  mean(crap[:Nfft2
+00006330: 5d29 2020 2320 7265 6d6f 7665 2074 6865  ])  # remove the
+00006340: 206d 6561 6e20 696e 2066 7265 7120 646f   mean in freq do
+00006350: 6d61 696e 2028 7370 696b 6520 6174 2074  main (spike at t
+00006360: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+00006370: 2020 2020 6372 6170 5b2d 284e 6666 7432      crap[-(Nfft2
+00006380: 2920 2b20 3120 3a5d 203d 206e 702e 666c  ) + 1 :] = np.fl
+00006390: 6970 286e 702e 636f 6e6a 2863 7261 705b  ip(np.conj(crap[
+000063a0: 313a 284e 6666 7432 295d 292c 2061 7869  1:(Nfft2)]), axi
+000063b0: 733d 3029 0a20 2020 2020 2020 2020 2020  s=0).           
+000063c0: 2020 2020 2063 7261 705b 305d 203d 2063       crap[0] = c
+000063d0: 6f6d 706c 6578 2830 2c20 3029 0a20 2020  omplex(0, 0).   
+000063e0: 2020 2020 2020 2020 2020 2020 2073 5f63               s_c
+000063f0: 6f72 725b 692c 203a 5d20 3d20 6e70 2e72  orr[i, :] = np.r
+00006400: 6561 6c28 6e70 2e66 6674 2e69 6666 7473  eal(np.fft.iffts
+00006410: 6869 6674 2873 6369 7079 2e66 6674 7061  hift(scipy.fftpa
+00006420: 636b 2e69 6666 7428 6372 6170 2c20 4e66  ck.ifft(crap, Nf
+00006430: 6674 2c20 6178 6973 3d30 2929 290a 0a20  ft, axis=0))).. 
+00006440: 2020 2020 2020 2020 2020 2023 2072 656d             # rem
+00006450: 6f76 6520 6162 6e6f 726d 616c 2064 6174  ove abnormal dat
+00006460: 610a 2020 2020 2020 2020 2020 2020 616d  a.            am
+00006470: 706d 6178 203d 206e 702e 6d61 7828 735f  pmax = np.max(s_
+00006480: 636f 7272 2c20 6178 6973 3d31 290a 2020  corr, axis=1).  
+00006490: 2020 2020 2020 2020 2020 7469 6e64 7820            tindx 
+000064a0: 3d20 6e70 2e77 6865 7265 2828 616d 706d  = np.where((ampm
+000064b0: 6178 203c 2032 3020 2a20 6e70 2e6d 6564  ax < 20 * np.med
+000064c0: 6961 6e28 616d 706d 6178 2929 2026 2028  ian(ampmax)) & (
+000064d0: 616d 706d 6178 203e 2030 2929 5b30 5d0a  ampmax > 0))[0].
+000064e0: 2020 2020 2020 2020 2020 2020 735f 636f              s_co
+000064f0: 7272 203d 2073 5f63 6f72 725b 7469 6e64  rr = s_corr[tind
+00006500: 782c 203a 5d0a 2020 2020 2020 2020 2020  x, :].          
+00006510: 2020 745f 636f 7272 203d 2074 5f63 6f72    t_corr = t_cor
+00006520: 725b 7469 6e64 785d 0a20 2020 2020 2020  r[tindx].       
+00006530: 2020 2020 206e 5f63 6f72 7220 3d20 6e5f       n_corr = n_
+00006540: 636f 7272 5b74 696e 6478 5d0a 0a20 2020  corr[tindx]..   
+00006550: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00006560: 2020 2020 2020 2023 2067 6574 2074 696d         # get tim
+00006570: 6520 696e 666f 726d 6174 696f 6e0a 2020  e information.  
+00006580: 2020 2020 2020 2020 2020 5474 6f74 616c            Ttotal
+00006590: 203d 2064 6174 6153 5f74 5b2d 315d 202d   = dataS_t[-1] -
+000065a0: 2064 6174 6153 5f74 5b30 5d20 2023 2074   dataS_t[0]  # t
+000065b0: 6f74 616c 2064 7572 6174 696f 6e20 6f66  otal duration of
+000065c0: 2077 6861 7420 7765 2068 6176 6520 6e6f   what we have no
+000065d0: 770a 2020 2020 2020 2020 2020 2020 7473  w.            ts
+000065e0: 7461 7274 203d 2064 6174 6153 5f74 5b30  tart = dataS_t[0
+000065f0: 5d0a 0a20 2020 2020 2020 2020 2020 206e  ]..            n
+00006600: 7374 6163 6b20 3d20 696e 7428 6e70 2e72  stack = int(np.r
+00006610: 6f75 6e64 2854 746f 7461 6c20 2f20 7375  ound(Ttotal / su
+00006620: 6273 7461 636b 5f6c 656e 2929 0a20 2020  bstack_len)).   
+00006630: 2020 2020 2020 2020 2061 6d70 6d61 7820           ampmax 
+00006640: 3d20 6e70 2e7a 6572 6f73 286e 7374 6163  = np.zeros(nstac
+00006650: 6b2c 2064 7479 7065 3d6e 702e 666c 6f61  k, dtype=np.floa
+00006660: 7433 3229 0a20 2020 2020 2020 2020 2020  t32).           
+00006670: 2073 5f63 6f72 7220 3d20 6e70 2e7a 6572   s_corr = np.zer
+00006680: 6f73 2873 6861 7065 3d28 6e73 7461 636b  os(shape=(nstack
+00006690: 2c20 4e66 6674 292c 2064 7479 7065 3d6e  , Nfft), dtype=n
+000066a0: 702e 666c 6f61 7433 3229 0a20 2020 2020  p.float32).     
+000066b0: 2020 2020 2020 206e 5f63 6f72 7220 3d20         n_corr = 
+000066c0: 6e70 2e7a 6572 6f73 286e 7374 6163 6b2c  np.zeros(nstack,
+000066d0: 2064 7479 7065 3d6e 702e 696e 7431 3629   dtype=np.int16)
+000066e0: 0a20 2020 2020 2020 2020 2020 2074 5f63  .            t_c
+000066f0: 6f72 7220 3d20 6e70 2e7a 6572 6f73 286e  orr = np.zeros(n
+00006700: 7374 6163 6b2c 2064 7479 7065 3d6e 702e  stack, dtype=np.
+00006710: 666c 6f61 7433 3229 0a20 2020 2020 2020  float32).       
+00006720: 2020 2020 2063 7261 7020 3d20 6e70 2e7a       crap = np.z
+00006730: 6572 6f73 284e 6666 742c 2064 7479 7065  eros(Nfft, dtype
+00006740: 3d6e 702e 636f 6d70 6c65 7836 3429 0a0a  =np.complex64)..
+00006750: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00006760: 6973 7461 636b 2069 6e20 7261 6e67 6528  istack in range(
+00006770: 6e73 7461 636b 293a 0a20 2020 2020 2020  nstack):.       
+00006780: 2020 2020 2020 2020 2023 2066 696e 6420           # find 
+00006790: 7468 6520 696e 6465 7865 7320 6f66 2061  the indexes of a
+000067a0: 6c6c 206f 6620 7468 6520 7769 6e64 6f77  ll of the window
+000067b0: 7320 7468 6174 2073 7461 7274 206f 7220  s that start or 
+000067c0: 656e 6420 7769 7468 696e 0a20 2020 2020  end within.     
+000067d0: 2020 2020 2020 2020 2020 2069 7469 6d65             itime
+000067e0: 203d 206e 702e 7768 6572 6528 2864 6174   = np.where((dat
+000067f0: 6153 5f74 203e 3d20 7473 7461 7274 2920  aS_t >= tstart) 
+00006800: 2620 2864 6174 6153 5f74 203c 2074 7374  & (dataS_t < tst
+00006810: 6172 7420 2b20 7375 6273 7461 636b 5f6c  art + substack_l
+00006820: 656e 2929 5b30 5d0a 2020 2020 2020 2020  en))[0].        
+00006830: 2020 2020 2020 2020 6966 206c 656e 2869          if len(i
+00006840: 7469 6d65 2920 3d3d 2030 3a0a 2020 2020  time) == 0:.    
+00006850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006860: 7473 7461 7274 202b 3d20 7375 6273 7461  tstart += substa
+00006870: 636b 5f6c 656e 0a20 2020 2020 2020 2020  ck_len.         
+00006880: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00006890: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+000068a0: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
+000068b0: 5d20 3d20 6e70 2e6d 6561 6e28 636f 7272  ] = np.mean(corr
+000068c0: 5b69 7469 6d65 2c20 3a5d 2c20 6178 6973  [itime, :], axis
+000068d0: 3d30 2920 2023 206c 696e 6561 7220 6176  =0)  # linear av
+000068e0: 6572 6167 6520 6f66 2074 6865 2063 6f72  erage of the cor
+000068f0: 7265 6c61 7469 6f6e 0a20 2020 2020 2020  relation.       
+00006900: 2020 2020 2020 2020 2063 7261 705b 3a4e           crap[:N
+00006910: 6666 7432 5d20 3d20 6372 6170 5b3a 4e66  fft2] = crap[:Nf
+00006920: 6674 325d 202d 206e 702e 6d65 616e 2863  ft2] - np.mean(c
+00006930: 7261 705b 3a4e 6666 7432 5d29 2020 2320  rap[:Nfft2])  # 
+00006940: 7265 6d6f 7665 2074 6865 206d 6561 6e20  remove the mean 
+00006950: 696e 2066 7265 7120 646f 6d61 696e 2028  in freq domain (
+00006960: 7370 696b 6520 6174 2074 3d30 290a 2020  spike at t=0).  
+00006970: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+00006980: 6170 5b2d 284e 6666 7432 2920 2b20 3120  ap[-(Nfft2) + 1 
+00006990: 3a5d 203d 206e 702e 666c 6970 286e 702e  :] = np.flip(np.
+000069a0: 636f 6e6a 2863 7261 705b 313a 284e 6666  conj(crap[1:(Nff
+000069b0: 7432 295d 292c 2061 7869 733d 3029 0a20  t2)]), axis=0). 
+000069c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000069d0: 7261 705b 305d 203d 2063 6f6d 706c 6578  rap[0] = complex
+000069e0: 2830 2c20 3029 0a20 2020 2020 2020 2020  (0, 0).         
+000069f0: 2020 2020 2020 2073 5f63 6f72 725b 6973         s_corr[is
+00006a00: 7461 636b 2c20 3a5d 203d 206e 702e 7265  tack, :] = np.re
+00006a10: 616c 286e 702e 6666 742e 6966 6674 7368  al(np.fft.ifftsh
+00006a20: 6966 7428 7363 6970 792e 6666 7470 6163  ift(scipy.fftpac
+00006a30: 6b2e 6966 6674 2863 7261 702c 204e 6666  k.ifft(crap, Nff
+00006a40: 742c 2061 7869 733d 3029 2929 0a20 2020  t, axis=0))).   
+00006a50: 2020 2020 2020 2020 2020 2020 206e 5f63               n_c
+00006a60: 6f72 725b 6973 7461 636b 5d20 3d20 6c65  orr[istack] = le
+00006a70: 6e28 6974 696d 6529 2020 2320 6e75 6d62  n(itime)  # numb
+00006a80: 6572 206f 6620 7769 6e64 6f77 7320 7374  er of windows st
+00006a90: 6163 6b73 0a20 2020 2020 2020 2020 2020  acks.           
+00006aa0: 2020 2020 2074 5f63 6f72 725b 6973 7461       t_corr[ista
+00006ab0: 636b 5d20 3d20 7473 7461 7274 2020 2320  ck] = tstart  # 
+00006ac0: 7361 7665 2074 6865 2074 696d 6520 7374  save the time st
+00006ad0: 616d 7073 0a20 2020 2020 2020 2020 2020  amps.           
+00006ae0: 2020 2020 2074 7374 6172 7420 2b3d 2073       tstart += s
+00006af0: 7562 7374 6163 6b5f 6c65 6e0a 2020 2020  ubstack_len.    
+00006b00: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+00006b10: 696e 7428 2763 6f72 7265 6c61 7469 6f6e  int('correlation
+00006b20: 2064 6f6e 6520 616e 6420 7374 6163 6b65   done and stacke
+00006b30: 6420 6174 2074 696d 6520 2573 2720 2520  d at time %s' % 
+00006b40: 7374 7228 745f 636f 7272 5b69 7374 6163  str(t_corr[istac
+00006b50: 6b5d 2929 0a0a 2020 2020 2020 2020 2020  k]))..          
+00006b60: 2020 2320 7265 6d6f 7665 2061 626e 6f72    # remove abnor
+00006b70: 6d61 6c20 6461 7461 0a20 2020 2020 2020  mal data.       
+00006b80: 2020 2020 2061 6d70 6d61 7820 3d20 6e70       ampmax = np
+00006b90: 2e6d 6178 2873 5f63 6f72 722c 2061 7869  .max(s_corr, axi
+00006ba0: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
+00006bb0: 2074 696e 6478 203d 206e 702e 7768 6572   tindx = np.wher
+00006bc0: 6528 2861 6d70 6d61 7820 3c20 3230 202a  e((ampmax < 20 *
+00006bd0: 206e 702e 6d65 6469 616e 2861 6d70 6d61   np.median(ampma
+00006be0: 7829 2920 2620 2861 6d70 6d61 7820 3e20  x)) & (ampmax > 
+00006bf0: 3029 295b 305d 0a20 2020 2020 2020 2020  0))[0].         
+00006c00: 2020 2073 5f63 6f72 7220 3d20 735f 636f     s_corr = s_co
+00006c10: 7272 5b74 696e 6478 2c20 3a5d 0a20 2020  rr[tindx, :].   
+00006c20: 2020 2020 2020 2020 2074 5f63 6f72 7220           t_corr 
+00006c30: 3d20 745f 636f 7272 5b74 696e 6478 5d0a  = t_corr[tindx].
+00006c40: 2020 2020 2020 2020 2020 2020 6e5f 636f              n_co
+00006c50: 7272 203d 206e 5f63 6f72 725b 7469 6e64  rr = n_corr[tind
+00006c60: 785d 0a0a 2020 2020 656c 7365 3a0a 2020  x]..    else:.  
+00006c70: 2020 2020 2020 2320 6176 6572 6167 6520        # average 
+00006c80: 6461 696c 7920 6372 6f73 7320 636f 7272  daily cross corr
+00006c90: 656c 6174 696f 6e20 6675 6e63 7469 6f6e  elation function
+00006ca0: 730a 2020 2020 2020 2020 616d 706d 6178  s.        ampmax
+00006cb0: 203d 206e 702e 6d61 7828 636f 7272 2c20   = np.max(corr, 
+00006cc0: 6178 6973 3d31 290a 2020 2020 2020 2020  axis=1).        
+00006cd0: 7469 6e64 7820 3d20 6e70 2e77 6865 7265  tindx = np.where
+00006ce0: 2828 616d 706d 6178 203c 2032 3020 2a20  ((ampmax < 20 * 
+00006cf0: 6e70 2e6d 6564 6961 6e28 616d 706d 6178  np.median(ampmax
+00006d00: 2929 2026 2028 616d 706d 6178 203e 2030  )) & (ampmax > 0
+00006d10: 2929 5b30 5d0a 2020 2020 2020 2020 6e5f  ))[0].        n_
+00006d20: 636f 7272 203d 206e 7769 6e0a 2020 2020  corr = nwin.    
+00006d30: 2020 2020 735f 636f 7272 203d 206e 702e      s_corr = np.
+00006d40: 7a65 726f 7328 4e66 6674 2c20 6474 7970  zeros(Nfft, dtyp
+00006d50: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
+00006d60: 2020 2020 2020 745f 636f 7272 203d 2064        t_corr = d
+00006d70: 6174 6153 5f74 5b30 5d0a 2020 2020 2020  ataS_t[0].      
+00006d80: 2020 6372 6170 203d 206e 702e 7a65 726f    crap = np.zero
+00006d90: 7328 4e66 6674 2c20 6474 7970 653d 6e70  s(Nfft, dtype=np
+00006da0: 2e63 6f6d 706c 6578 3634 290a 2020 2020  .complex64).    
+00006db0: 2020 2020 6372 6170 5b3a 4e66 6674 325d      crap[:Nfft2]
+00006dc0: 203d 206e 702e 6d65 616e 2863 6f72 725b   = np.mean(corr[
+00006dd0: 7469 6e64 785d 2c20 6178 6973 3d30 290a  tindx], axis=0).
+00006de0: 2020 2020 2020 2020 6372 6170 5b3a 4e66          crap[:Nf
+00006df0: 6674 325d 203d 2063 7261 705b 3a4e 6666  ft2] = crap[:Nff
+00006e00: 7432 5d20 2d20 6e70 2e6d 6561 6e28 6372  t2] - np.mean(cr
+00006e10: 6170 5b3a 4e66 6674 325d 2c20 6178 6973  ap[:Nfft2], axis
+00006e20: 3d30 290a 2020 2020 2020 2020 6372 6170  =0).        crap
+00006e30: 5b2d 284e 6666 7432 2920 2b20 3120 3a5d  [-(Nfft2) + 1 :]
+00006e40: 203d 206e 702e 666c 6970 286e 702e 636f   = np.flip(np.co
+00006e50: 6e6a 2863 7261 705b 313a 284e 6666 7432  nj(crap[1:(Nfft2
+00006e60: 295d 292c 2061 7869 733d 3029 0a20 2020  )]), axis=0).   
+00006e70: 2020 2020 2073 5f63 6f72 7220 3d20 6e70       s_corr = np
+00006e80: 2e72 6561 6c28 6e70 2e66 6674 2e69 6666  .real(np.fft.iff
+00006e90: 7473 6869 6674 2873 6369 7079 2e66 6674  tshift(scipy.fft
+00006ea0: 7061 636b 2e69 6666 7428 6372 6170 2c20  pack.ifft(crap, 
+00006eb0: 4e66 6674 2c20 6178 6973 3d30 2929 290a  Nfft, axis=0))).
+00006ec0: 0a20 2020 2023 2074 7269 6d20 7468 6520  .    # trim the 
+00006ed0: 4343 4673 2069 6e20 5b2d 6d61 786c 6167  CCFs in [-maxlag
+00006ee0: 206d 6178 6c61 675d 0a20 2020 2074 203d   maxlag].    t =
+00006ef0: 206e 702e 6172 616e 6765 282d 4e66 6674   np.arange(-Nfft
+00006f00: 3220 2b20 312c 204e 6666 7432 2920 2a20  2 + 1, Nfft2) * 
+00006f10: 6474 0a20 2020 2069 6e64 203d 206e 702e  dt.    ind = np.
+00006f20: 7768 6572 6528 6e70 2e61 6273 2874 2920  where(np.abs(t) 
+00006f30: 3c3d 206d 6178 6c61 6729 5b30 5d0a 2020  <= maxlag)[0].  
+00006f40: 2020 6966 2073 5f63 6f72 722e 6e64 696d    if s_corr.ndim
+00006f50: 203d 3d20 313a 0a20 2020 2020 2020 2073   == 1:.        s
+00006f60: 5f63 6f72 7220 3d20 735f 636f 7272 5b69  _corr = s_corr[i
+00006f70: 6e64 5d0a 2020 2020 656c 6966 2073 5f63  nd].    elif s_c
+00006f80: 6f72 722e 6e64 696d 203d 3d20 323a 0a20  orr.ndim == 2:. 
+00006f90: 2020 2020 2020 2073 5f63 6f72 7220 3d20         s_corr = 
+00006fa0: 735f 636f 7272 5b3a 2c20 696e 645d 0a20  s_corr[:, ind]. 
+00006fb0: 2020 2072 6574 7572 6e20 735f 636f 7272     return s_corr
+00006fc0: 2c20 745f 636f 7272 2c20 6e5f 636f 7272  , t_corr, n_corr
+00006fd0: 0a0a 0a64 6566 2063 6f72 7265 6c61 7465  ...def correlate
+00006fe0: 5f6e 6f6e 6c69 6e65 6172 5f73 7461 636b  _nonlinear_stack
+00006ff0: 2866 6674 315f 736d 6f6f 7468 6564 5f61  (fft1_smoothed_a
+00007000: 6273 2c20 6666 7432 2c20 442c 204e 6666  bs, fft2, D, Nff
+00007010: 742c 2064 6174 6153 5f74 293a 0a20 2020  t, dataS_t):.   
+00007020: 2022 2222 0a20 2020 2074 6869 7320 6675   """.    this fu
+00007030: 6e63 7469 6f6e 2064 6f65 7320 7468 6520  nction does the 
+00007040: 6372 6f73 732d 636f 7272 656c 6174 696f  cross-correlatio
+00007050: 6e20 696e 2066 7265 7120 646f 6d61 696e  n in freq domain
+00007060: 2061 6e64 2068 6173 2074 6865 206f 7074   and has the opt
+00007070: 696f 6e20 746f 206b 6565 7020 7375 622d  ion to keep sub-
+00007080: 7374 6163 6b73 206f 660a 2020 2020 7468  stacks of.    th
+00007090: 6520 6372 6f73 732d 636f 7272 656c 6174  e cross-correlat
+000070a0: 696f 6e20 6966 206e 6565 6465 642e 2069  ion if needed. i
+000070b0: 7420 7461 6b65 7320 6164 7661 6e74 6167  t takes advantag
+000070c0: 6520 6f66 2074 6865 206c 696e 6561 7220  e of the linear 
+000070d0: 7265 6c61 7469 6f6e 7368 6970 206f 6620  relationship of 
+000070e0: 6966 6674 2c20 736f 2074 6861 740a 2020  ifft, so that.  
+000070f0: 2020 7374 6163 6b69 6e67 2069 7320 7065    stacking is pe
+00007100: 7266 6f72 6d65 6420 696e 2073 7065 6374  rformed in spect
+00007110: 7275 6d20 646f 6d61 696e 2066 6972 7374  rum domain first
+00007120: 2074 6f20 7265 6475 6365 2074 6865 2074   to reduce the t
+00007130: 6f74 616c 206e 756d 6265 7220 6f66 2069  otal number of i
+00007140: 6666 742e 2028 7573 6564 2069 6e20 5331  fft. (used in S1
+00007150: 290a 2020 2020 5041 5241 4d45 5445 5253  ).    PARAMETERS
+00007160: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00007170: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+00007180: 6666 7431 5f73 6d6f 6f74 6865 645f 6162  fft1_smoothed_ab
+00007190: 733a 2073 6d6f 6f74 6865 6420 706f 7765  s: smoothed powe
+000071a0: 7220 7370 6563 7472 616c 2064 656e 7369  r spectral densi
+000071b0: 7479 206f 6620 7468 6520 4646 5420 666f  ty of the FFT fo
+000071c0: 7220 7468 6520 736f 7572 6365 2073 7461  r the source sta
+000071d0: 7469 6f6e 0a20 2020 2066 6674 323a 2072  tion.    fft2: r
+000071e0: 6177 2046 4654 2073 7065 6374 7275 6d20  aw FFT spectrum 
+000071f0: 6f66 2074 6865 2072 6563 6569 7665 7220  of the receiver 
+00007200: 7374 6174 696f 6e0a 2020 2020 443a 2064  station.    D: d
+00007210: 6963 7469 6f6e 6172 7920 636f 6e74 6169  ictionary contai
+00007220: 6e69 6e67 2066 6f6c 6c6f 7769 6e67 2070  ning following p
+00007230: 6172 616d 6574 6572 733a 0a20 2020 2020  arameters:.     
+00007240: 2020 206d 6178 6c61 673a 2020 6d61 7869     maxlag:  maxi
+00007250: 6d75 6d20 6c61 6773 2074 6f20 6b65 6570  mum lags to keep
+00007260: 2069 6e20 7468 6520 6372 6f73 7320 636f   in the cross co
+00007270: 7272 656c 6174 696f 6e0a 2020 2020 2020  rrelation.      
+00007280: 2020 6474 3a20 2020 2020 2073 616d 706c    dt:      sampl
+00007290: 696e 6720 7261 7465 2028 696e 2073 290a  ing rate (in s).
+000072a0: 2020 2020 2020 2020 6e77 696e 3a20 2020          nwin:   
+000072b0: 206e 756d 6265 7220 6f66 2073 6567 6d65   number of segme
+000072c0: 6e74 7320 696e 2074 6865 2032 4420 6d61  nts in the 2D ma
+000072d0: 7472 6978 0a20 2020 2020 2020 206d 6574  trix.        met
+000072e0: 686f 643a 2020 6372 6f73 732d 636f 7272  hod:  cross-corr
+000072f0: 656c 6174 696f 6e20 6d65 7468 6f64 7320  elation methods 
+00007300: 7365 6c65 6374 6564 2062 7920 7468 6520  selected by the 
+00007310: 7573 6572 0a20 2020 2020 2020 2066 7265  user.        fre
+00007320: 716d 696e 3a20 6d69 6e69 6d75 6d20 6672  qmin: minimum fr
+00007330: 6571 7565 6e63 7920 2848 7a29 0a20 2020  equency (Hz).   
+00007340: 2020 2020 2066 7265 716d 6178 3a20 6d61       freqmax: ma
+00007350: 7869 6d75 6d20 6672 6571 7565 6e63 7920  ximum frequency 
+00007360: 2848 7a29 0a20 2020 204e 6666 743a 2020  (Hz).    Nfft:  
+00007370: 2020 6e75 6d62 6572 206f 6620 6672 6571    number of freq
+00007380: 7565 6e63 7920 706f 696e 7473 2066 6f72  uency points for
+00007390: 2069 6666 740a 2020 2020 6461 7461 535f   ifft.    dataS_
+000073a0: 743a 206d 6174 7269 7820 6f66 2064 6174  t: matrix of dat
+000073b0: 6574 696d 6520 6f62 6a65 6374 2e0a 2020  etime object..  
+000073c0: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
+000073d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000073e0: 2d2d 2d2d 0a20 2020 2073 5f63 6f72 723a  ----.    s_corr:
+000073f0: 2031 4420 6f72 2032 4420 6d61 7472 6978   1D or 2D matrix
+00007400: 206f 6620 7468 6520 6176 6572 6167 6564   of the averaged
+00007410: 206f 7220 7375 622d 7374 6163 6b73 206f   or sub-stacks o
+00007420: 6620 6372 6f73 732d 636f 7272 656c 6174  f cross-correlat
+00007430: 696f 6e20 6675 6e63 7469 6f6e 7320 696e  ion functions in
+00007440: 2074 696d 6520 646f 6d61 696e 0a20 2020   time domain.   
+00007450: 2074 5f63 6f72 723a 2074 696d 6573 7461   t_corr: timesta
+00007460: 6d70 2066 6f72 2065 6163 6820 7375 622d  mp for each sub-
+00007470: 7374 6163 6b20 6f72 2061 7665 7261 6765  stack or average
+00007480: 6420 6675 6e63 7469 6f6e 0a20 2020 206e  d function.    n
+00007490: 5f63 6f72 723a 206e 756d 6265 7220 6f66  _corr: number of
+000074a0: 2069 6e63 6c75 6465 6420 7365 676d 656e   included segmen
+000074b0: 7473 2066 6f72 2065 6163 6820 7375 622d  ts for each sub-
+000074c0: 7374 6163 6b20 6f72 2061 7665 7261 6765  stack or average
+000074d0: 6420 6675 6e63 7469 6f6e 0a20 2020 2022  d function.    "
+000074e0: 2222 0a20 2020 2023 202d 2d2d 2d6c 6f61  "".    # ----loa
+000074f0: 6420 7061 7261 6d74 6572 732d 2d2d 2d0a  d paramters----.
+00007500: 2020 2020 6474 203d 2044 5b22 6474 225d      dt = D["dt"]
+00007510: 0a20 2020 206d 6178 6c61 6720 3d20 445b  .    maxlag = D[
+00007520: 226d 6178 6c61 6722 5d0a 2020 2020 6d65  "maxlag"].    me
+00007530: 7468 6f64 203d 2044 5b22 6363 5f6d 6574  thod = D["cc_met
+00007540: 686f 6422 5d0a 2020 2020 6363 5f6c 656e  hod"].    cc_len
+00007550: 203d 2044 5b22 6363 5f6c 656e 225d 0a20   = D["cc_len"]. 
+00007560: 2020 2073 7562 7374 6163 6b20 3d20 445b     substack = D[
+00007570: 2273 7562 7374 6163 6b22 5d0a 2020 2020  "substack"].    
+00007580: 7374 6163 6b5f 6d65 7468 6f64 203d 2044  stack_method = D
+00007590: 5b22 7374 6163 6b5f 6d65 7468 6f64 225d  ["stack_method"]
+000075a0: 0a20 2020 2073 7562 7374 6163 6b5f 6c65  .    substack_le
+000075b0: 6e20 3d20 445b 2273 7562 7374 6163 6b5f  n = D["substack_
+000075c0: 6c65 6e22 5d0a 2020 2020 736d 6f6f 7468  len"].    smooth
+000075d0: 7370 6563 745f 4e20 3d20 445b 2273 6d6f  spect_N = D["smo
+000075e0: 6f74 6873 7065 6374 5f4e 225d 0a0a 2020  othspect_N"]..  
+000075f0: 2020 6e77 696e 203d 2066 6674 315f 736d    nwin = fft1_sm
+00007600: 6f6f 7468 6564 5f61 6273 2e73 6861 7065  oothed_abs.shape
+00007610: 5b30 5d0a 2020 2020 4e66 6674 3220 3d20  [0].    Nfft2 = 
+00007620: 6666 7431 5f73 6d6f 6f74 6865 645f 6162  fft1_smoothed_ab
+00007630: 732e 7368 6170 655b 315d 0a0a 2020 2020  s.shape[1]..    
+00007640: 2320 2d2d 2d2d 2d2d 636f 6e76 6572 7420  # ------convert 
+00007650: 616c 6c20 3244 2061 7272 6179 7320 696e  all 2D arrays in
+00007660: 746f 2031 4420 746f 2073 7065 6564 2075  to 1D to speed u
+00007670: 702d 2d2d 2d2d 2d2d 2d0a 2020 2020 636f  p--------.    co
+00007680: 7272 203d 206e 702e 7a65 726f 7328 6e77  rr = np.zeros(nw
+00007690: 696e 202a 204e 6666 7432 2c20 6474 7970  in * Nfft2, dtyp
+000076a0: 653d 6e70 2e63 6f6d 706c 6578 3634 290a  e=np.complex64).
+000076b0: 2020 2020 636f 7272 203d 2066 6674 315f      corr = fft1_
+000076c0: 736d 6f6f 7468 6564 5f61 6273 2e72 6573  smoothed_abs.res
+000076d0: 6861 7065 280a 2020 2020 2020 2020 6666  hape(.        ff
+000076e0: 7431 5f73 6d6f 6f74 6865 645f 6162 732e  t1_smoothed_abs.
+000076f0: 7369 7a65 2c0a 2020 2020 2920 2a20 6666  size,.    ) * ff
+00007700: 7432 2e72 6573 6861 7065 280a 2020 2020  t2.reshape(.    
+00007710: 2020 2020 6666 7432 2e73 697a 652c 0a20      fft2.size,. 
+00007720: 2020 2029 0a0a 2020 2020 2320 6e6f 726d     )..    # norm
+00007730: 616c 697a 6520 6279 2072 6563 6569 7665  alize by receive
+00007740: 7220 7370 6563 7472 616c 2066 6f72 2063  r spectral for c
+00007750: 6f68 6572 656e 6379 0a20 2020 2069 6620  oherency.    if 
+00007760: 6d65 7468 6f64 203d 3d20 2263 6f68 6572  method == "coher
+00007770: 656e 6379 223a 0a20 2020 2020 2020 2074  ency":.        t
+00007780: 656d 7020 3d20 6d6f 7669 6e67 5f61 7665  emp = moving_ave
+00007790: 280a 2020 2020 2020 2020 2020 2020 6e70  (.            np
+000077a0: 2e61 6273 280a 2020 2020 2020 2020 2020  .abs(.          
+000077b0: 2020 2020 2020 6666 7432 2e72 6573 6861        fft2.resha
+000077c0: 7065 280a 2020 2020 2020 2020 2020 2020  pe(.            
+000077d0: 2020 2020 2020 2020 6666 7432 2e73 697a          fft2.siz
+000077e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000077f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007800: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00007810: 736d 6f6f 7468 7370 6563 745f 4e2c 0a20  smoothspect_N,. 
+00007820: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00007830: 2063 6f72 7220 2f3d 2074 656d 700a 2020   corr /= temp.  
+00007840: 2020 636f 7272 203d 2063 6f72 722e 7265    corr = corr.re
+00007850: 7368 6170 6528 6e77 696e 2c20 4e66 6674  shape(nwin, Nfft
+00007860: 3229 0a0a 2020 2020 2320 7472 616e 7366  2)..    # transf
+00007870: 6f72 6d20 6261 636b 2074 6f20 7469 6d65  orm back to time
+00007880: 2064 6f6d 6169 6e20 7761 7665 666f 726d   domain waveform
+00007890: 730a 2020 2020 735f 636f 7272 203d 206e  s.    s_corr = n
+000078a0: 702e 7a65 726f 7328 7368 6170 653d 286e  p.zeros(shape=(n
+000078b0: 7769 6e2c 204e 6666 7429 2c20 6474 7970  win, Nfft), dtyp
+000078c0: 653d 6e70 2e66 6c6f 6174 3332 2920 2023  e=np.float32)  #
+000078d0: 2073 7461 636b 6564 2063 6f72 7265 6c61   stacked correla
+000078e0: 7469 6f6e 0a20 2020 2061 6d70 6d61 7820  tion.    ampmax 
+000078f0: 3d20 6e70 2e7a 6572 6f73 286e 7769 6e2c  = np.zeros(nwin,
+00007900: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
+00007910: 3229 0a20 2020 206e 5f63 6f72 7220 3d20  2).    n_corr = 
+00007920: 6e70 2e7a 6572 6f73 286e 7769 6e2c 2064  np.zeros(nwin, d
+00007930: 7479 7065 3d6e 702e 696e 7431 3629 2020  type=np.int16)  
+00007940: 2320 6e75 6d62 6572 206f 6620 636f 7272  # number of corr
+00007950: 656c 6174 696f 6e73 2066 6f72 2065 6163  elations for eac
+00007960: 6820 7375 6273 7461 636b 0a20 2020 2074  h substack.    t
+00007970: 5f63 6f72 7220 3d20 6461 7461 535f 7420  _corr = dataS_t 
+00007980: 2023 2074 696d 6573 7461 6d70 0a20 2020   # timestamp.   
+00007990: 2063 7261 7020 3d20 6e70 2e7a 6572 6f73   crap = np.zeros
+000079a0: 284e 6666 742c 2064 7479 7065 3d6e 702e  (Nfft, dtype=np.
+000079b0: 636f 6d70 6c65 7836 3429 0a20 2020 2066  complex64).    f
+000079c0: 6f72 2069 2069 6e20 7261 6e67 6528 6e77  or i in range(nw
+000079d0: 696e 293a 0a20 2020 2020 2020 206e 5f63  in):.        n_c
+000079e0: 6f72 725b 695d 203d 2031 0a20 2020 2020  orr[i] = 1.     
+000079f0: 2020 2063 7261 705b 3a4e 6666 7432 5d20     crap[:Nfft2] 
+00007a00: 3d20 636f 7272 5b69 2c20 3a5d 0a20 2020  = corr[i, :].   
+00007a10: 2020 2020 2063 7261 705b 3a4e 6666 7432       crap[:Nfft2
+00007a20: 5d20 3d20 6372 6170 5b3a 4e66 6674 325d  ] = crap[:Nfft2]
+00007a30: 202d 206e 702e 6d65 616e 2863 7261 705b   - np.mean(crap[
+00007a40: 3a4e 6666 7432 5d29 2020 2320 7265 6d6f  :Nfft2])  # remo
+00007a50: 7665 2074 6865 206d 6561 6e20 696e 2066  ve the mean in f
+00007a60: 7265 7120 646f 6d61 696e 2028 7370 696b  req domain (spik
+00007a70: 6520 6174 2074 3d30 290a 2020 2020 2020  e at t=0).      
+00007a80: 2020 6372 6170 5b2d 284e 6666 7432 2920    crap[-(Nfft2) 
+00007a90: 2b20 3120 3a5d 203d 206e 702e 666c 6970  + 1 :] = np.flip
+00007aa0: 286e 702e 636f 6e6a 2863 7261 705b 313a  (np.conj(crap[1:
+00007ab0: 284e 6666 7432 295d 292c 2061 7869 733d  (Nfft2)]), axis=
+00007ac0: 3029 0a20 2020 2020 2020 2063 7261 705b  0).        crap[
+00007ad0: 305d 203d 2063 6f6d 706c 6578 2830 2c20  0] = complex(0, 
+00007ae0: 3029 0a20 2020 2020 2020 2073 5f63 6f72  0).        s_cor
+00007af0: 725b 692c 203a 5d20 3d20 6e70 2e72 6561  r[i, :] = np.rea
+00007b00: 6c28 6e70 2e66 6674 2e69 6666 7473 6869  l(np.fft.ifftshi
+00007b10: 6674 2873 6369 7079 2e66 6674 7061 636b  ft(scipy.fftpack
+00007b20: 2e69 6666 7428 6372 6170 2c20 4e66 6674  .ifft(crap, Nfft
+00007b30: 2c20 6178 6973 3d30 2929 290a 0a20 2020  , axis=0)))..   
+00007b40: 206e 735f 636f 7272 203d 2073 5f63 6f72   ns_corr = s_cor
+00007b50: 720a 2020 2020 666f 7220 6969 6920 696e  r.    for iii in
+00007b60: 2072 616e 6765 286e 735f 636f 7272 2e73   range(ns_corr.s
+00007b70: 6861 7065 5b30 5d29 3a0a 2020 2020 2020  hape[0]):.      
+00007b80: 2020 6e73 5f63 6f72 725b 6969 695d 202f    ns_corr[iii] /
+00007b90: 3d20 6e70 2e6d 6178 286e 702e 6162 7328  = np.max(np.abs(
+00007ba0: 6e73 5f63 6f72 725b 6969 695d 2929 0a0a  ns_corr[iii]))..
+00007bb0: 2020 2020 6966 2073 7562 7374 6163 6b3a      if substack:
+00007bc0: 0a20 2020 2020 2020 2069 6620 7375 6273  .        if subs
+00007bd0: 7461 636b 5f6c 656e 203d 3d20 6363 5f6c  tack_len == cc_l
+00007be0: 656e 3a0a 2020 2020 2020 2020 2020 2020  en:.            
+00007bf0: 2320 7265 6d6f 7665 2061 626e 6f72 6d61  # remove abnorma
+00007c00: 6c20 6461 7461 0a20 2020 2020 2020 2020  l data.         
+00007c10: 2020 2061 6d70 6d61 7820 3d20 6e70 2e6d     ampmax = np.m
+00007c20: 6178 2873 5f63 6f72 722c 2061 7869 733d  ax(s_corr, axis=
+00007c30: 3129 0a20 2020 2020 2020 2020 2020 2074  1).            t
+00007c40: 696e 6478 203d 206e 702e 7768 6572 6528  indx = np.where(
+00007c50: 2861 6d70 6d61 7820 3c20 3230 202a 206e  (ampmax < 20 * n
+00007c60: 702e 6d65 6469 616e 2861 6d70 6d61 7829  p.median(ampmax)
+00007c70: 2920 2620 2861 6d70 6d61 7820 3e20 3029  ) & (ampmax > 0)
+00007c80: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+00007c90: 2073 5f63 6f72 7220 3d20 735f 636f 7272   s_corr = s_corr
+00007ca0: 5b74 696e 6478 2c20 3a5d 0a20 2020 2020  [tindx, :].     
+00007cb0: 2020 2020 2020 2074 5f63 6f72 7220 3d20         t_corr = 
+00007cc0: 745f 636f 7272 5b74 696e 6478 5d0a 2020  t_corr[tindx].  
+00007cd0: 2020 2020 2020 2020 2020 6e5f 636f 7272            n_corr
+00007ce0: 203d 206e 5f63 6f72 725b 7469 6e64 785d   = n_corr[tindx]
+00007cf0: 0a0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
+00007d00: 2020 2020 2020 2020 2020 2020 2320 6765              # ge
+00007d10: 7420 7469 6d65 2069 6e66 6f72 6d61 7469  t time informati
+00007d20: 6f6e 0a20 2020 2020 2020 2020 2020 2054  on.            T
+00007d30: 746f 7461 6c20 3d20 6461 7461 535f 745b  total = dataS_t[
+00007d40: 2d31 5d20 2d20 6461 7461 535f 745b 305d  -1] - dataS_t[0]
+00007d50: 2020 2320 746f 7461 6c20 6475 7261 7469    # total durati
+00007d60: 6f6e 206f 6620 7768 6174 2077 6520 6861  on of what we ha
+00007d70: 7665 206e 6f77 0a20 2020 2020 2020 2020  ve now.         
+00007d80: 2020 2074 7374 6172 7420 3d20 6461 7461     tstart = data
+00007d90: 535f 745b 305d 0a0a 2020 2020 2020 2020  S_t[0]..        
+00007da0: 2020 2020 6e73 7461 636b 203d 2069 6e74      nstack = int
+00007db0: 286e 702e 726f 756e 6428 5474 6f74 616c  (np.round(Ttotal
+00007dc0: 202f 2073 7562 7374 6163 6b5f 6c65 6e29   / substack_len)
+00007dd0: 290a 2020 2020 2020 2020 2020 2020 616d  ).            am
+00007de0: 706d 6178 203d 206e 702e 7a65 726f 7328  pmax = np.zeros(
+00007df0: 6e73 7461 636b 2c20 6474 7970 653d 6e70  nstack, dtype=np
+00007e00: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
+00007e10: 2020 2020 2020 735f 636f 7272 203d 206e        s_corr = n
+00007e20: 702e 7a65 726f 7328 7368 6170 653d 286e  p.zeros(shape=(n
+00007e30: 7374 6163 6b2c 204e 6666 7429 2c20 6474  stack, Nfft), dt
+00007e40: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+00007e50: 2020 2020 2020 2020 2020 2020 6e5f 636f              n_co
+00007e60: 7272 203d 206e 702e 7a65 726f 7328 6e73  rr = np.zeros(ns
+00007e70: 7461 636b 2c20 6474 7970 653d 6e70 2e69  tack, dtype=np.i
+00007e80: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+00007e90: 745f 636f 7272 203d 206e 702e 7a65 726f  t_corr = np.zero
+00007ea0: 7328 6e73 7461 636b 2c20 6474 7970 653d  s(nstack, dtype=
+00007eb0: 6e70 2e66 6c6f 6174 290a 2020 2020 2020  np.float).      
+00007ec0: 2020 2020 2020 6372 6170 203d 206e 702e        crap = np.
+00007ed0: 7a65 726f 7328 4e66 6674 2c20 6474 7970  zeros(Nfft, dtyp
+00007ee0: 653d 6e70 2e63 6f6d 706c 6578 3634 290a  e=np.complex64).
+00007ef0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00007f00: 2069 7374 6163 6b20 696e 2072 616e 6765   istack in range
+00007f10: 286e 7374 6163 6b29 3a0a 2020 2020 2020  (nstack):.      
+00007f20: 2020 2020 2020 2020 2020 2320 6669 6e64            # find
+00007f30: 2074 6865 2069 6e64 6578 6573 206f 6620   the indexes of 
+00007f40: 616c 6c20 6f66 2074 6865 2077 696e 646f  all of the windo
+00007f50: 7773 2074 6861 7420 7374 6172 7420 6f72  ws that start or
+00007f60: 2065 6e64 2077 6974 6869 6e0a 2020 2020   end within.    
+00007f70: 2020 2020 2020 2020 2020 2020 6974 696d              itim
+00007f80: 6520 3d20 6e70 2e77 6865 7265 2828 6461  e = np.where((da
+00007f90: 7461 535f 7420 3e3d 2074 7374 6172 7429  taS_t >= tstart)
+00007fa0: 2026 2028 6461 7461 535f 7420 3c20 7473   & (dataS_t < ts
+00007fb0: 7461 7274 202b 2073 7562 7374 6163 6b5f  tart + substack_
+00007fc0: 6c65 6e29 295b 305d 0a20 2020 2020 2020  len))[0].       
+00007fd0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+00007fe0: 6974 696d 6529 203d 3d20 303a 0a20 2020  itime) == 0:.   
+00007ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008000: 2074 7374 6172 7420 2b3d 2073 7562 7374   tstart += subst
+00008010: 6163 6b5f 6c65 6e0a 2020 2020 2020 2020  ack_len.        
+00008020: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00008030: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+00008040: 2020 2020 2020 6372 6170 5b3a 4e66 6674        crap[:Nfft
+00008050: 325d 203d 206e 702e 6d65 616e 2863 6f72  2] = np.mean(cor
+00008060: 725b 6974 696d 652c 203a 5d2c 2061 7869  r[itime, :], axi
+00008070: 733d 3029 2020 2320 6c69 6e65 6172 2061  s=0)  # linear a
+00008080: 7665 7261 6765 206f 6620 7468 6520 636f  verage of the co
+00008090: 7272 656c 6174 696f 6e0a 2020 2020 2020  rrelation.      
+000080a0: 2020 2020 2020 2020 2020 6372 6170 5b3a            crap[:
+000080b0: 4e66 6674 325d 203d 2063 7261 705b 3a4e  Nfft2] = crap[:N
+000080c0: 6666 7432 5d20 2d20 6e70 2e6d 6561 6e28  fft2] - np.mean(
+000080d0: 6372 6170 5b3a 4e66 6674 325d 2920 2023  crap[:Nfft2])  #
+000080e0: 2072 656d 6f76 6520 7468 6520 6d65 616e   remove the mean
+000080f0: 2069 6e20 6672 6571 2064 6f6d 6169 6e20   in freq domain 
+00008100: 2873 7069 6b65 2061 7420 743d 3029 0a20  (spike at t=0). 
+00008110: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00008120: 7261 705b 2d28 4e66 6674 3229 202b 2031  rap[-(Nfft2) + 1
+00008130: 203a 5d20 3d20 6e70 2e66 6c69 7028 6e70   :] = np.flip(np
+00008140: 2e63 6f6e 6a28 6372 6170 5b31 3a28 4e66  .conj(crap[1:(Nf
+00008150: 6674 3229 5d29 2c20 6178 6973 3d30 290a  ft2)]), axis=0).
+00008160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008170: 6372 6170 5b30 5d20 3d20 636f 6d70 6c65  crap[0] = comple
+00008180: 7828 302c 2030 290a 2020 2020 2020 2020  x(0, 0).        
+00008190: 2020 2020 2020 2020 735f 636f 7272 5b69          s_corr[i
+000081a0: 7374 6163 6b2c 203a 5d20 3d20 6e70 2e72  stack, :] = np.r
+000081b0: 6561 6c28 6e70 2e66 6674 2e69 6666 7473  eal(np.fft.iffts
+000081c0: 6869 6674 2873 6369 7079 2e66 6674 7061  hift(scipy.fftpa
+000081d0: 636b 2e69 6666 7428 6372 6170 2c20 4e66  ck.ifft(crap, Nf
+000081e0: 6674 2c20 6178 6973 3d30 2929 290a 2020  ft, axis=0))).  
+000081f0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+00008200: 636f 7272 5b69 7374 6163 6b5d 203d 206c  corr[istack] = l
+00008210: 656e 2869 7469 6d65 2920 2023 206e 756d  en(itime)  # num
+00008220: 6265 7220 6f66 2077 696e 646f 7773 2073  ber of windows s
+00008230: 7461 636b 730a 2020 2020 2020 2020 2020  tacks.          
+00008240: 2020 2020 2020 745f 636f 7272 5b69 7374        t_corr[ist
+00008250: 6163 6b5d 203d 2074 7374 6172 7420 2023  ack] = tstart  #
+00008260: 2073 6176 6520 7468 6520 7469 6d65 2073   save the time s
+00008270: 7461 6d70 730a 2020 2020 2020 2020 2020  tamps.          
+00008280: 2020 2020 2020 7473 7461 7274 202b 3d20        tstart += 
+00008290: 7375 6273 7461 636b 5f6c 656e 0a20 2020  substack_len.   
+000082a0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+000082b0: 7269 6e74 2827 636f 7272 656c 6174 696f  rint('correlatio
+000082c0: 6e20 646f 6e65 2061 6e64 2073 7461 636b  n done and stack
+000082d0: 6564 2061 7420 7469 6d65 2025 7327 2025  ed at time %s' %
+000082e0: 2073 7472 2874 5f63 6f72 725b 6973 7461   str(t_corr[ista
+000082f0: 636b 5d29 290a 0a20 2020 2020 2020 2020  ck]))..         
+00008300: 2020 2023 2072 656d 6f76 6520 6162 6e6f     # remove abno
+00008310: 726d 616c 2064 6174 610a 2020 2020 2020  rmal data.      
+00008320: 2020 2020 2020 616d 706d 6178 203d 206e        ampmax = n
+00008330: 702e 6d61 7828 735f 636f 7272 2c20 6178  p.max(s_corr, ax
+00008340: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
+00008350: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
+00008360: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
+00008370: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
+00008380: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
+00008390: 2030 2929 5b30 5d0a 2020 2020 2020 2020   0))[0].        
+000083a0: 2020 2020 735f 636f 7272 203d 2073 5f63      s_corr = s_c
+000083b0: 6f72 725b 7469 6e64 782c 203a 5d0a 2020  orr[tindx, :].  
+000083c0: 2020 2020 2020 2020 2020 745f 636f 7272            t_corr
+000083d0: 203d 2074 5f63 6f72 725b 7469 6e64 785d   = t_corr[tindx]
+000083e0: 0a20 2020 2020 2020 2020 2020 206e 5f63  .            n_c
+000083f0: 6f72 7220 3d20 6e5f 636f 7272 5b74 696e  orr = n_corr[tin
+00008400: 6478 5d0a 0a20 2020 2065 6c73 653a 0a20  dx]..    else:. 
+00008410: 2020 2020 2020 2023 2061 7665 7261 6765         # average
+00008420: 2064 6169 6c79 2063 726f 7373 2063 6f72   daily cross cor
+00008430: 7265 6c61 7469 6f6e 2066 756e 6374 696f  relation functio
+00008440: 6e73 0a20 2020 2020 2020 2069 6620 7374  ns.        if st
+00008450: 6163 6b5f 6d65 7468 6f64 203d 3d20 226c  ack_method == "l
+00008460: 696e 6561 7222 3a0a 2020 2020 2020 2020  inear":.        
+00008470: 2020 2020 616d 706d 6178 203d 206e 702e      ampmax = np.
+00008480: 6d61 7828 735f 636f 7272 2c20 6178 6973  max(s_corr, axis
+00008490: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
+000084a0: 7469 6e64 7820 3d20 6e70 2e77 6865 7265  tindx = np.where
+000084b0: 2828 616d 706d 6178 203c 2032 3020 2a20  ((ampmax < 20 * 
+000084c0: 6e70 2e6d 6564 6961 6e28 616d 706d 6178  np.median(ampmax
+000084d0: 2929 2026 2028 616d 706d 6178 203e 2030  )) & (ampmax > 0
+000084e0: 2929 5b30 5d0a 2020 2020 2020 2020 2020  ))[0].          
+000084f0: 2020 735f 636f 7272 203d 206e 702e 6d65    s_corr = np.me
+00008500: 616e 2873 5f63 6f72 725b 7469 6e64 785d  an(s_corr[tindx]
+00008510: 2c20 6178 6973 3d30 290a 2020 2020 2020  , axis=0).      
+00008520: 2020 2020 2020 745f 636f 7272 203d 2064        t_corr = d
+00008530: 6174 6153 5f74 5b30 5d0a 2020 2020 2020  ataS_t[0].      
+00008540: 2020 2020 2020 6e5f 636f 7272 203d 206c        n_corr = l
+00008550: 656e 2874 696e 6478 290a 2020 2020 2020  en(tindx).      
+00008560: 2020 656c 6966 2073 7461 636b 5f6d 6574    elif stack_met
+00008570: 686f 6420 3d3d 2022 726f 6275 7374 223a  hod == "robust":
+00008580: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00008590: 6765 722e 696e 666f 2822 646f 2072 6f62  ger.info("do rob
+000085a0: 7573 7420 7375 6273 7461 636b 696e 6722  ust substacking"
+000085b0: 290a 2020 2020 2020 2020 2020 2020 735f  ).            s_
+000085c0: 636f 7272 203d 2072 6f62 7573 745f 7374  corr = robust_st
+000085d0: 6163 6b28 735f 636f 7272 2c20 302e 3030  ack(s_corr, 0.00
+000085e0: 3129 0a20 2020 2020 2020 2020 2020 2074  1).            t
+000085f0: 5f63 6f72 7220 3d20 6461 7461 535f 745b  _corr = dataS_t[
+00008600: 305d 0a20 2020 2020 2020 2020 2020 206e  0].            n
+00008610: 5f63 6f72 7220 3d20 6e77 696e 0a20 2020  _corr = nwin.   
+00008620: 2023 2020 656c 6966 2073 7461 636b 5f6d   #  elif stack_m
+00008630: 6574 686f 6420 3d3d 2027 7365 6c65 6374  ethod == 'select
+00008640: 6976 6527 3a0a 2020 2020 2320 2020 2020  ive':.    #     
+00008650: 2070 7269 6e74 2827 646f 2073 656c 6563   print('do selec
+00008660: 7469 7665 2073 7562 7374 6163 6b69 6e67  tive substacking
+00008670: 2729 0a20 2020 2023 2020 2020 2020 735f  ').    #      s_
+00008680: 636f 7272 203d 2073 656c 6563 7469 7665  corr = selective
+00008690: 5f73 7461 636b 2873 5f63 6f72 722c 302e  _stack(s_corr,0.
+000086a0: 3030 3129 0a20 2020 2023 2020 2020 2020  001).    #      
+000086b0: 745f 636f 7272 203d 2064 6174 6153 5f74  t_corr = dataS_t
+000086c0: 5b30 5d0a 2020 2020 2320 2020 2020 206e  [0].    #      n
+000086d0: 5f63 6f72 7220 3d20 6e77 696e 0a0a 2020  _corr = nwin..  
+000086e0: 2020 2320 7472 696d 2074 6865 2043 4346    # trim the CCF
+000086f0: 7320 696e 205b 2d6d 6178 6c61 6720 6d61  s in [-maxlag ma
+00008700: 786c 6167 5d0a 2020 2020 7420 3d20 6e70  xlag].    t = np
+00008710: 2e61 7261 6e67 6528 2d4e 6666 7432 202b  .arange(-Nfft2 +
+00008720: 2031 2c20 4e66 6674 3229 202a 2064 740a   1, Nfft2) * dt.
+00008730: 2020 2020 696e 6420 3d20 6e70 2e77 6865      ind = np.whe
+00008740: 7265 286e 702e 6162 7328 7429 203c 3d20  re(np.abs(t) <= 
+00008750: 6d61 786c 6167 295b 305d 0a20 2020 2069  maxlag)[0].    i
+00008760: 6620 735f 636f 7272 2e6e 6469 6d20 3d3d  f s_corr.ndim ==
+00008770: 2031 3a0a 2020 2020 2020 2020 735f 636f   1:.        s_co
+00008780: 7272 203d 2073 5f63 6f72 725b 696e 645d  rr = s_corr[ind]
+00008790: 0a20 2020 2065 6c69 6620 735f 636f 7272  .    elif s_corr
+000087a0: 2e6e 6469 6d20 3d3d 2032 3a0a 2020 2020  .ndim == 2:.    
+000087b0: 2020 2020 735f 636f 7272 203d 2073 5f63      s_corr = s_c
+000087c0: 6f72 725b 3a2c 2069 6e64 5d0a 2020 2020  orr[:, ind].    
+000087d0: 7265 7475 726e 2073 5f63 6f72 722c 2074  return s_corr, t
+000087e0: 5f63 6f72 722c 206e 5f63 6f72 722c 206e  _corr, n_corr, n
+000087f0: 735f 636f 7272 5b3a 2c20 696e 645d 0a0a  s_corr[:, ind]..
+00008800: 0a64 6566 2063 635f 7061 7261 6d65 7465  .def cc_paramete
+00008810: 7273 2863 635f 7061 7261 2c20 636f 6f72  rs(cc_para, coor
+00008820: 2c20 7463 6f72 722c 206e 636f 7272 2c20  , tcorr, ncorr, 
+00008830: 636f 6d70 293a 0a20 2020 2022 2222 0a20  comp):.    """. 
+00008840: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
+00008850: 2061 7373 656d 626c 6573 2074 6865 2070   assembles the p
+00008860: 6172 616d 6574 6572 7320 666f 7220 7468  arameters for th
+00008870: 6520 6363 2066 756e 6374 696f 6e2c 2077  e cc function, w
+00008880: 6869 6368 2069 7320 7573 6564 0a20 2020  hich is used.   
+00008890: 2077 6865 6e20 7772 6974 696e 6720 7468   when writing th
+000088a0: 656d 2069 6e74 6f20 4153 4446 2066 696c  em into ASDF fil
+000088b0: 6573 0a20 2020 2050 4152 414d 4554 4552  es.    PARAMETER
+000088c0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+000088d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+000088e0: 2063 635f 7061 7261 3a20 6469 6374 2063   cc_para: dict c
+000088f0: 6f6e 7461 696e 696e 6720 7061 7261 6d65  ontaining parame
+00008900: 7465 7273 2075 7365 6420 696e 2074 6865  ters used in the
+00008910: 2066 6674 5f63 6320 7374 6570 0a20 2020   fft_cc step.   
+00008920: 2063 6f6f 723a 2020 2020 6469 6374 2063   coor:    dict c
+00008930: 6f6e 7461 696e 696e 6720 636f 6f72 6469  ontaining coordi
+00008940: 6e61 7465 7320 696e 666f 206f 6620 7468  nates info of th
+00008950: 6520 736f 7572 6365 2061 6e64 2072 6563  e source and rec
+00008960: 6569 7665 7220 7374 6174 696f 6e73 0a20  eiver stations. 
+00008970: 2020 2074 636f 7272 3a20 2020 7469 6d65     tcorr:   time
+00008980: 7374 616d 7020 6d61 7472 6978 0a20 2020  stamp matrix.   
+00008990: 206e 636f 7272 3a20 2020 6d61 7472 6978   ncorr:   matrix
+000089a0: 206f 6620 6e75 6d62 6572 206f 6620 676f   of number of go
+000089b0: 6f64 2073 6567 6d65 6e74 7320 666f 7220  od segments for 
+000089c0: 6561 6368 2073 7562 2d73 7461 636b 2f66  each sub-stack/f
+000089d0: 696e 616c 2073 7461 636b 0a20 2020 2063  inal stack.    c
+000089e0: 6f6d 703a 2020 2020 3220 6368 6172 6163  omp:    2 charac
+000089f0: 7465 7220 7374 7269 6e67 7320 666f 7220  ter strings for 
+00008a00: 7468 6520 6372 6f73 7320 636f 7272 656c  the cross correl
+00008a10: 6174 696f 6e20 636f 6d70 6f6e 656e 740a  ation component.
+00008a20: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+00008a30: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00008a40: 2d2d 2d0a 2020 2020 7061 7261 6d65 7465  ---.    paramete
+00008a50: 7273 3a20 6469 6374 2063 6f6e 7461 696e  rs: dict contain
+00008a60: 696e 6720 6162 6f76 6520 696e 666f 2075  ing above info u
+00008a70: 7365 6420 666f 7220 6c61 7465 7220 7374  sed for later st
+00008a80: 6163 6b69 6e67 2f70 6c6f 7474 696e 670a  acking/plotting.
+00008a90: 2020 2020 2222 220a 2020 2020 6c61 7453      """.    latS
+00008aa0: 203d 2063 6f6f 725b 226c 6174 5322 5d0a   = coor["latS"].
+00008ab0: 2020 2020 6c6f 6e53 203d 2063 6f6f 725b      lonS = coor[
+00008ac0: 226c 6f6e 5322 5d0a 2020 2020 6c61 7452  "lonS"].    latR
+00008ad0: 203d 2063 6f6f 725b 226c 6174 5222 5d0a   = coor["latR"].
+00008ae0: 2020 2020 6c6f 6e52 203d 2063 6f6f 725b      lonR = coor[
+00008af0: 226c 6f6e 5222 5d0a 2020 2020 6474 203d  "lonR"].    dt =
+00008b00: 2063 635f 7061 7261 5b22 6474 225d 0a20   cc_para["dt"]. 
+00008b10: 2020 206d 6178 6c61 6720 3d20 6363 5f70     maxlag = cc_p
+00008b20: 6172 615b 226d 6178 6c61 6722 5d0a 2020  ara["maxlag"].  
+00008b30: 2020 7375 6273 7461 636b 203d 2063 635f    substack = cc_
+00008b40: 7061 7261 5b22 7375 6273 7461 636b 225d  para["substack"]
+00008b50: 0a20 2020 2063 635f 6d65 7468 6f64 203d  .    cc_method =
+00008b60: 2063 635f 7061 7261 5b22 6363 5f6d 6574   cc_para["cc_met
+00008b70: 686f 6422 5d0a 0a20 2020 2064 6973 742c  hod"]..    dist,
+00008b80: 2061 7a69 2c20 6261 7a20 3d20 6f62 7370   azi, baz = obsp
+00008b90: 792e 6765 6f64 6574 6963 732e 6261 7365  y.geodetics.base
+00008ba0: 2e67 7073 3264 6973 745f 617a 696d 7574  .gps2dist_azimut
+00008bb0: 6828 6c61 7453 2c20 6c6f 6e53 2c20 6c61  h(latS, lonS, la
+00008bc0: 7452 2c20 6c6f 6e52 290a 2020 2020 7061  tR, lonR).    pa
+00008bd0: 7261 6d65 7465 7273 203d 207b 0a20 2020  rameters = {.   
+00008be0: 2020 2020 2022 6474 223a 2064 742c 0a20       "dt": dt,. 
+00008bf0: 2020 2020 2020 2022 6d61 786c 6167 223a         "maxlag":
+00008c00: 2069 6e74 286d 6178 6c61 6729 2c0a 2020   int(maxlag),.  
+00008c10: 2020 2020 2020 2264 6973 7422 3a20 6e70        "dist": np
+00008c20: 2e66 6c6f 6174 3332 2864 6973 7420 2f20  .float32(dist / 
+00008c30: 3130 3030 292c 0a20 2020 2020 2020 2022  1000),.        "
+00008c40: 617a 6922 3a20 6e70 2e66 6c6f 6174 3332  azi": np.float32
+00008c50: 2861 7a69 292c 0a20 2020 2020 2020 2022  (azi),.        "
+00008c60: 6261 7a22 3a20 6e70 2e66 6c6f 6174 3332  baz": np.float32
+00008c70: 2862 617a 292c 0a20 2020 2020 2020 2022  (baz),.        "
+00008c80: 6c6f 6e53 223a 206e 702e 666c 6f61 7433  lonS": np.float3
+00008c90: 3228 6c6f 6e53 292c 0a20 2020 2020 2020  2(lonS),.       
+00008ca0: 2022 6c61 7453 223a 206e 702e 666c 6f61   "latS": np.floa
+00008cb0: 7433 3228 6c61 7453 292c 0a20 2020 2020  t32(latS),.     
+00008cc0: 2020 2022 6c6f 6e52 223a 206e 702e 666c     "lonR": np.fl
+00008cd0: 6f61 7433 3228 6c6f 6e52 292c 0a20 2020  oat32(lonR),.   
+00008ce0: 2020 2020 2022 6c61 7452 223a 206e 702e       "latR": np.
+00008cf0: 666c 6f61 7433 3228 6c61 7452 292c 0a20  float32(latR),. 
+00008d00: 2020 2020 2020 2022 6e67 6f6f 6422 3a20         "ngood": 
+00008d10: 6e63 6f72 722c 0a20 2020 2020 2020 2022  ncorr,.        "
+00008d20: 6363 5f6d 6574 686f 6422 3a20 6363 5f6d  cc_method": cc_m
+00008d30: 6574 686f 642c 0a20 2020 2020 2020 2022  ethod,.        "
+00008d40: 7469 6d65 223a 2074 636f 7272 2c0a 2020  time": tcorr,.  
+00008d50: 2020 2020 2020 2273 7562 7374 6163 6b22        "substack"
+00008d60: 3a20 7375 6273 7461 636b 2c0a 2020 2020  : substack,.    
+00008d70: 2020 2020 2263 6f6d 7022 3a20 636f 6d70      "comp": comp
+00008d80: 2c0a 2020 2020 7d0a 2020 2020 7265 7475  ,.    }.    retu
+00008d90: 726e 2070 6172 616d 6574 6572 730a 0a0a  rn parameters...
+00008da0: 6465 6620 7374 6163 6b69 6e67 2863 635f  def stacking(cc_
+00008db0: 6172 7261 792c 2063 635f 7469 6d65 2c20  array, cc_time, 
+00008dc0: 6363 5f6e 676f 6f64 2c20 7374 6163 6b5f  cc_ngood, stack_
+00008dd0: 7061 7261 293a 0a20 2020 2022 2222 0a20  para):.    """. 
+00008de0: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
+00008df0: 2073 7461 636b 7320 7468 6520 6372 6f73   stacks the cros
+00008e00: 7320 636f 7272 656c 6174 696f 6e20 6461  s correlation da
+00008e10: 7461 2061 6363 6f72 6469 6e67 2074 6f20  ta according to 
+00008e20: 7468 6520 7573 6572 2d64 6566 696e 6564  the user-defined
+00008e30: 2073 7562 7374 6163 6b5f 6c65 6e20 7061   substack_len pa
+00008e40: 7261 6d65 7465 720a 0a20 2020 2050 4152  rameter..    PAR
+00008e50: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
+00008e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008e70: 2d2d 2d0a 2020 2020 6363 5f61 7272 6179  ---.    cc_array
+00008e80: 3a20 3244 206e 756d 7079 2066 6c6f 6174  : 2D numpy float
+00008e90: 3332 206d 6174 7269 7820 636f 6e74 6169  32 matrix contai
+00008ea0: 6e69 6e67 2061 6c6c 2073 6567 6d65 6e74  ning all segment
+00008eb0: 6564 2063 726f 7373 2d63 6f72 7265 6c61  ed cross-correla
+00008ec0: 7469 6f6e 2064 6174 610a 2020 2020 6363  tion data.    cc
+00008ed0: 5f74 696d 653a 2020 3144 206e 756d 7079  _time:  1D numpy
+00008ee0: 2061 7272 6179 206f 6620 7469 6d65 7374   array of timest
+00008ef0: 616d 7073 2066 6f72 2065 6163 6820 7365  amps for each se
+00008f00: 676d 656e 7420 6f66 2063 635f 6172 7261  gment of cc_arra
+00008f10: 790a 2020 2020 6363 5f6e 676f 6f64 3a20  y.    cc_ngood: 
+00008f20: 3144 206e 756d 7079 2069 6e74 3136 206d  1D numpy int16 m
+00008f30: 6174 7269 7820 7368 6f77 696e 6720 7468  atrix showing th
+00008f40: 6520 6e75 6d62 6572 206f 6620 7365 676d  e number of segm
+00008f50: 656e 7473 2066 6f72 2065 6163 6820 7375  ents for each su
+00008f60: 622d 7374 6163 6b20 616e 642f 6f72 2066  b-stack and/or f
+00008f70: 756c 6c20 7374 6163 6b0a 2020 2020 7374  ull stack.    st
+00008f80: 6163 6b5f 7061 7261 3a20 6120 6469 6374  ack_para: a dict
+00008f90: 2063 6f6e 7461 696e 696e 6720 616c 6c20   containing all 
+00008fa0: 7374 6163 6b69 6e67 2070 6172 616d 6574  stacking paramet
+00008fb0: 6572 730a 0a20 2020 2052 4554 5552 4e53  ers..    RETURNS
+00008fc0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00008fd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00008fe0: 2063 635f 6172 7261 792c 2063 635f 6e67   cc_array, cc_ng
+00008ff0: 6f6f 642c 2063 635f 7469 6d65 3a20 7361  ood, cc_time: sa
+00009000: 6d65 2074 6f20 7468 6520 696e 7075 7420  me to the input 
+00009010: 7061 7261 6d65 7465 7273 2062 7574 2077  parameters but w
+00009020: 6974 6820 6162 6e6f 726d 616c 2063 726f  ith abnormal cro
+00009030: 7373 2d63 6f72 7265 616c 7469 6f6e 7320  ss-correaltions 
+00009040: 7265 6d6f 7665 640a 2020 2020 616c 6c73  removed.    alls
+00009050: 7461 636b 7331 3a20 3144 206d 6174 7269  tacks1: 1D matri
+00009060: 7820 6f66 2073 7461 636b 6564 2063 726f  x of stacked cro
+00009070: 7373 2d63 6f72 7265 6c61 7469 6f6e 2066  ss-correlation f
+00009080: 756e 6374 696f 6e73 206f 7665 7220 616c  unctions over al
+00009090: 6c20 7468 6520 7365 676d 656e 7473 0a20  l the segments. 
+000090a0: 2020 206e 7374 6163 6b73 3a20 2020 206e     nstacks:    n
+000090b0: 756d 6265 7220 6f66 206f 7665 7261 6c6c  umber of overall
+000090c0: 2073 6567 6d65 6e74 7320 666f 7220 7468   segments for th
+000090d0: 6520 6669 6e61 6c20 7374 6163 6b73 0a20  e final stacks. 
+000090e0: 2020 2022 2222 0a20 2020 2023 206c 6f61     """.    # loa
+000090f0: 6420 7573 6566 756c 2070 6172 616d 6574  d useful paramet
+00009100: 6572 7320 6672 6f6d 2064 6963 740a 2020  ers from dict.  
+00009110: 2020 7361 6d70 5f66 7265 7120 3d20 7374    samp_freq = st
+00009120: 6163 6b5f 7061 7261 5b22 7361 6d70 5f66  ack_para["samp_f
+00009130: 7265 7122 5d0a 2020 2020 736d 6574 686f  req"].    smetho
+00009140: 6420 3d20 7374 6163 6b5f 7061 7261 5b22  d = stack_para["
+00009150: 7374 6163 6b5f 6d65 7468 6f64 225d 0a20  stack_method"]. 
+00009160: 2020 206e 7074 7320 3d20 6363 5f61 7272     npts = cc_arr
+00009170: 6179 2e73 6861 7065 5b31 5d0a 0a20 2020  ay.shape[1]..   
+00009180: 2023 2072 656d 6f76 6520 6162 6e6f 726d   # remove abnorm
+00009190: 616c 2064 6174 610a 2020 2020 616d 706d  al data.    ampm
+000091a0: 6178 203d 206e 702e 6d61 7828 6363 5f61  ax = np.max(cc_a
+000091b0: 7272 6179 2c20 6178 6973 3d31 290a 2020  rray, axis=1).  
+000091c0: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
+000091d0: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
+000091e0: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
+000091f0: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
+00009200: 2030 2929 5b30 5d0a 2020 2020 6966 206e   0))[0].    if n
+00009210: 6f74 206c 656e 2874 696e 6478 293a 0a20  ot len(tindx):. 
+00009220: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
+00009230: 3120 3d20 5b5d 0a20 2020 2020 2020 2061  1 = [].        a
+00009240: 6c6c 7374 6163 6b73 3220 3d20 5b5d 0a20  llstacks2 = []. 
+00009250: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
+00009260: 3320 3d20 5b5d 0a20 2020 2020 2020 206e  3 = [].        n
+00009270: 7374 6163 6b73 203d 2030 0a20 2020 2020  stacks = 0.     
+00009280: 2020 2063 635f 6172 7261 7920 3d20 5b5d     cc_array = []
+00009290: 0a20 2020 2020 2020 2063 635f 6e67 6f6f  .        cc_ngoo
+000092a0: 6420 3d20 5b5d 0a20 2020 2020 2020 2063  d = [].        c
+000092b0: 635f 7469 6d65 203d 205b 5d0a 2020 2020  c_time = [].    
+000092c0: 2020 2020 7265 7475 726e 2063 635f 6172      return cc_ar
+000092d0: 7261 792c 2063 635f 6e67 6f6f 642c 2063  ray, cc_ngood, c
+000092e0: 635f 7469 6d65 2c20 616c 6c73 7461 636b  c_time, allstack
+000092f0: 7331 2c20 616c 6c73 7461 636b 7332 2c20  s1, allstacks2, 
+00009300: 616c 6c73 7461 636b 7333 2c20 6e73 7461  allstacks3, nsta
+00009310: 636b 730a 2020 2020 656c 7365 3a0a 2020  cks.    else:.  
+00009320: 2020 2020 2020 2320 7265 6d6f 7665 206f        # remove o
+00009330: 6e65 7320 7769 7468 2062 6164 2061 6d70  nes with bad amp
+00009340: 6c69 7475 6465 0a20 2020 2020 2020 2063  litude.        c
+00009350: 635f 6172 7261 7920 3d20 6363 5f61 7272  c_array = cc_arr
+00009360: 6179 5b74 696e 6478 2c20 3a5d 0a20 2020  ay[tindx, :].   
+00009370: 2020 2020 2063 635f 7469 6d65 203d 2063       cc_time = c
+00009380: 635f 7469 6d65 5b74 696e 6478 5d0a 2020  c_time[tindx].  
+00009390: 2020 2020 2020 6363 5f6e 676f 6f64 203d        cc_ngood =
+000093a0: 2063 635f 6e67 6f6f 645b 7469 6e64 785d   cc_ngood[tindx]
+000093b0: 0a0a 2020 2020 2020 2020 2320 646f 2073  ..        # do s
+000093c0: 7461 636b 696e 670a 2020 2020 2020 2020  tacking.        
+000093d0: 616c 6c73 7461 636b 7331 203d 206e 702e  allstacks1 = np.
+000093e0: 7a65 726f 7328 6e70 7473 2c20 6474 7970  zeros(npts, dtyp
+000093f0: 653d 6e70 2e66 6c6f 6174 3332 290a 2020  e=np.float32).  
+00009400: 2020 2020 2020 616c 6c73 7461 636b 7332        allstacks2
+00009410: 203d 206e 702e 7a65 726f 7328 6e70 7473   = np.zeros(npts
+00009420: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
+00009430: 3332 290a 2020 2020 2020 2020 616c 6c73  32).        alls
+00009440: 7461 636b 7333 203d 206e 702e 7a65 726f  tacks3 = np.zero
+00009450: 7328 6e70 7473 2c20 6474 7970 653d 6e70  s(npts, dtype=np
+00009460: 2e66 6c6f 6174 3332 290a 0a20 2020 2020  .float32)..     
+00009470: 2020 2069 6620 736d 6574 686f 6420 3d3d     if smethod ==
+00009480: 2022 6c69 6e65 6172 223a 0a20 2020 2020   "linear":.     
+00009490: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
+000094a0: 3120 3d20 6e70 2e6d 6561 6e28 6363 5f61  1 = np.mean(cc_a
+000094b0: 7272 6179 2c20 6178 6973 3d30 290a 2020  rray, axis=0).  
+000094c0: 2020 2020 2020 656c 6966 2073 6d65 7468        elif smeth
+000094d0: 6f64 203d 3d20 2270 7773 223a 0a20 2020  od == "pws":.   
+000094e0: 2020 2020 2020 2020 2061 6c6c 7374 6163           allstac
+000094f0: 6b73 3120 3d20 7077 7328 6363 5f61 7272  ks1 = pws(cc_arr
+00009500: 6179 2c20 7361 6d70 5f66 7265 7129 0a20  ay, samp_freq). 
+00009510: 2020 2020 2020 2065 6c69 6620 736d 6574         elif smet
+00009520: 686f 6420 3d3d 2022 726f 6275 7374 223a  hod == "robust":
+00009530: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+00009540: 7374 6163 6b73 312c 2077 2c20 6e73 7465  stacks1, w, nste
+00009550: 7020 3d20 726f 6275 7374 5f73 7461 636b  p = robust_stack
+00009560: 2863 635f 6172 7261 792c 2030 2e30 3031  (cc_array, 0.001
+00009570: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
+00009580: 6d65 7468 6f64 203d 3d20 2261 7574 6f5f  method == "auto_
+00009590: 636f 7661 7269 616e 6365 223a 0a20 2020  covariance":.   
+000095a0: 2020 2020 2020 2020 2061 6c6c 7374 6163           allstac
+000095b0: 6b73 3120 3d20 6164 6170 7469 7665 5f66  ks1 = adaptive_f
+000095c0: 696c 7465 7228 6363 5f61 7272 6179 2c20  ilter(cc_array, 
+000095d0: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
+000095e0: 736d 6574 686f 6420 3d3d 2022 6e72 6f6f  smethod == "nroo
+000095f0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+00009600: 616c 6c73 7461 636b 7331 203d 206e 726f  allstacks1 = nro
+00009610: 6f74 5f73 7461 636b 2863 635f 6172 7261  ot_stack(cc_arra
+00009620: 792c 2032 290a 2020 2020 2020 2020 656c  y, 2).        el
+00009630: 6966 2073 6d65 7468 6f64 203d 3d20 2261  if smethod == "a
+00009640: 6c6c 223a 0a20 2020 2020 2020 2020 2020  ll":.           
+00009650: 2061 6c6c 7374 6163 6b73 3120 3d20 6e70   allstacks1 = np
+00009660: 2e6d 6561 6e28 6363 5f61 7272 6179 2c20  .mean(cc_array, 
+00009670: 6178 6973 3d30 290a 2020 2020 2020 2020  axis=0).        
+00009680: 2020 2020 616c 6c73 7461 636b 7332 203d      allstacks2 =
+00009690: 2070 7773 2863 635f 6172 7261 792c 2073   pws(cc_array, s
+000096a0: 616d 705f 6672 6571 290a 2020 2020 2020  amp_freq).      
+000096b0: 2020 2020 2020 616c 6c73 7461 636b 7333        allstacks3
+000096c0: 2c20 772c 206e 7374 6570 203d 2072 6f62  , w, nstep = rob
+000096d0: 7573 745f 7374 6163 6b28 6363 5f61 7272  ust_stack(cc_arr
+000096e0: 6179 2c20 302e 3030 3129 0a20 2020 2020  ay, 0.001).     
+000096f0: 2020 206e 7374 6163 6b73 203d 206e 702e     nstacks = np.
+00009700: 7375 6d28 6363 5f6e 676f 6f64 290a 0a20  sum(cc_ngood).. 
+00009710: 2020 2023 2067 6f6f 6420 746f 2072 6574     # good to ret
+00009720: 7572 6e0a 2020 2020 7265 7475 726e 2063  urn.    return c
+00009730: 635f 6172 7261 792c 2063 635f 6e67 6f6f  c_array, cc_ngoo
+00009740: 642c 2063 635f 7469 6d65 2c20 616c 6c73  d, cc_time, alls
+00009750: 7461 636b 7331 2c20 616c 6c73 7461 636b  tacks1, allstack
+00009760: 7332 2c20 616c 6c73 7461 636b 7333 2c20  s2, allstacks3, 
+00009770: 6e73 7461 636b 730a 0a0a 6465 6620 7374  nstacks...def st
+00009780: 6163 6b69 6e67 5f72 6d61 2863 635f 6172  acking_rma(cc_ar
+00009790: 7261 792c 2063 635f 7469 6d65 2c20 6363  ray, cc_time, cc
+000097a0: 5f6e 676f 6f64 2c20 7374 6163 6b5f 7061  _ngood, stack_pa
+000097b0: 7261 293a 0a20 2020 2022 2222 0a20 2020  ra):.    """.   
+000097c0: 2074 6869 7320 6675 6e63 7469 6f6e 2073   this function s
+000097d0: 7461 636b 7320 7468 6520 6372 6f73 7320  tacks the cross 
+000097e0: 636f 7272 656c 6174 696f 6e20 6461 7461  correlation data
+000097f0: 2061 6363 6f72 6469 6e67 2074 6f20 7468   according to th
+00009800: 6520 7573 6572 2d64 6566 696e 6564 2073  e user-defined s
+00009810: 7562 7374 6163 6b5f 6c65 6e20 7061 7261  ubstack_len para
+00009820: 6d65 7465 720a 2020 2020 5041 5241 4d45  meter.    PARAME
+00009830: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+00009840: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009850: 0a20 2020 2063 635f 6172 7261 793a 2032  .    cc_array: 2
+00009860: 4420 6e75 6d70 7920 666c 6f61 7433 3220  D numpy float32 
+00009870: 6d61 7472 6978 2063 6f6e 7461 696e 696e  matrix containin
+00009880: 6720 616c 6c20 7365 676d 656e 7465 6420  g all segmented 
+00009890: 6372 6f73 732d 636f 7272 656c 6174 696f  cross-correlatio
+000098a0: 6e20 6461 7461 0a20 2020 2063 635f 7469  n data.    cc_ti
+000098b0: 6d65 3a20 2031 4420 6e75 6d70 7920 6172  me:  1D numpy ar
+000098c0: 7261 7920 6f66 2074 696d 6573 7461 6d70  ray of timestamp
+000098d0: 7320 666f 7220 6561 6368 2073 6567 6d65  s for each segme
+000098e0: 6e74 206f 6620 6363 5f61 7272 6179 0a20  nt of cc_array. 
+000098f0: 2020 2063 635f 6e67 6f6f 643a 2031 4420     cc_ngood: 1D 
+00009900: 6e75 6d70 7920 696e 7431 3620 6d61 7472  numpy int16 matr
+00009910: 6978 2073 686f 7769 6e67 2074 6865 206e  ix showing the n
+00009920: 756d 6265 7220 6f66 2073 6567 6d65 6e74  umber of segment
+00009930: 7320 666f 7220 6561 6368 2073 7562 2d73  s for each sub-s
+00009940: 7461 636b 2061 6e64 2f6f 7220 6675 6c6c  tack and/or full
+00009950: 2073 7461 636b 0a20 2020 2073 7461 636b   stack.    stack
+00009960: 5f70 6172 613a 2061 2064 6963 7420 636f  _para: a dict co
+00009970: 6e74 6169 6e69 6e67 2061 6c6c 2073 7461  ntaining all sta
+00009980: 636b 696e 6720 7061 7261 6d65 7465 7273  cking parameters
+00009990: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
+000099a0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+000099b0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 635f  --------.    cc_
+000099c0: 6172 7261 792c 2063 635f 6e67 6f6f 642c  array, cc_ngood,
+000099d0: 2063 635f 7469 6d65 3a20 7361 6d65 2074   cc_time: same t
+000099e0: 6f20 7468 6520 696e 7075 7420 7061 7261  o the input para
+000099f0: 6d65 7465 7273 2062 7574 2077 6974 6820  meters but with 
+00009a00: 6162 6e6f 726d 616c 2063 726f 7373 2d63  abnormal cross-c
+00009a10: 6f72 7265 616c 7469 6f6e 7320 7265 6d6f  orrealtions remo
+00009a20: 7665 640a 2020 2020 616c 6c73 7461 636b  ved.    allstack
+00009a30: 7331 3a20 3144 206d 6174 7269 7820 6f66  s1: 1D matrix of
+00009a40: 2073 7461 636b 6564 2063 726f 7373 2d63   stacked cross-c
+00009a50: 6f72 7265 6c61 7469 6f6e 2066 756e 6374  orrelation funct
+00009a60: 696f 6e73 206f 7665 7220 616c 6c20 7468  ions over all th
+00009a70: 6520 7365 676d 656e 7473 0a20 2020 206e  e segments.    n
+00009a80: 7374 6163 6b73 3a20 2020 206e 756d 6265  stacks:    numbe
+00009a90: 7220 6f66 206f 7665 7261 6c6c 2073 6567  r of overall seg
+00009aa0: 6d65 6e74 7320 666f 7220 7468 6520 6669  ments for the fi
+00009ab0: 6e61 6c20 7374 6163 6b73 0a20 2020 2022  nal stacks.    "
+00009ac0: 2222 0a20 2020 2023 206c 6f61 6420 7573  "".    # load us
+00009ad0: 6566 756c 2070 6172 616d 6574 6572 7320  eful parameters 
+00009ae0: 6672 6f6d 2064 6963 740a 2020 2020 7361  from dict.    sa
+00009af0: 6d70 5f66 7265 7120 3d20 7374 6163 6b5f  mp_freq = stack_
+00009b00: 7061 7261 5b22 7361 6d70 5f66 7265 7122  para["samp_freq"
+00009b10: 5d0a 2020 2020 736d 6574 686f 6420 3d20  ].    smethod = 
+00009b20: 7374 6163 6b5f 7061 7261 5b22 7374 6163  stack_para["stac
+00009b30: 6b5f 6d65 7468 6f64 225d 0a20 2020 2072  k_method"].    r
+00009b40: 6d61 5f73 7562 7374 6163 6b20 3d20 7374  ma_substack = st
+00009b50: 6163 6b5f 7061 7261 5b22 726d 615f 7375  ack_para["rma_su
+00009b60: 6273 7461 636b 225d 0a20 2020 2072 6d61  bstack"].    rma
+00009b70: 5f73 7465 7020 3d20 7374 6163 6b5f 7061  _step = stack_pa
+00009b80: 7261 5b22 726d 615f 7374 6570 225d 0a20  ra["rma_step"]. 
+00009b90: 2020 2073 7461 7274 5f64 6174 6520 3d20     start_date = 
+00009ba0: 7374 6163 6b5f 7061 7261 5b22 7374 6172  stack_para["star
+00009bb0: 745f 6461 7465 225d 0a20 2020 2065 6e64  t_date"].    end
+00009bc0: 5f64 6174 6520 3d20 7374 6163 6b5f 7061  _date = stack_pa
+00009bd0: 7261 5b22 656e 645f 6461 7465 225d 0a20  ra["end_date"]. 
+00009be0: 2020 206e 7074 7320 3d20 6363 5f61 7272     npts = cc_arr
+00009bf0: 6179 2e73 6861 7065 5b31 5d0a 0a20 2020  ay.shape[1]..   
+00009c00: 2023 2072 656d 6f76 6520 6162 6e6f 726d   # remove abnorm
+00009c10: 616c 2064 6174 610a 2020 2020 616d 706d  al data.    ampm
+00009c20: 6178 203d 206e 702e 6d61 7828 6363 5f61  ax = np.max(cc_a
+00009c30: 7272 6179 2c20 6178 6973 3d31 290a 2020  rray, axis=1).  
+00009c40: 2020 7469 6e64 7820 3d20 6e70 2e77 6865    tindx = np.whe
+00009c50: 7265 2828 616d 706d 6178 203c 2032 3020  re((ampmax < 20 
+00009c60: 2a20 6e70 2e6d 6564 6961 6e28 616d 706d  * np.median(ampm
+00009c70: 6178 2929 2026 2028 616d 706d 6178 203e  ax)) & (ampmax >
+00009c80: 2030 2929 5b30 5d0a 2020 2020 6966 206e   0))[0].    if n
+00009c90: 6f74 206c 656e 2874 696e 6478 293a 0a20  ot len(tindx):. 
+00009ca0: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
+00009cb0: 3120 3d20 5b5d 0a20 2020 2020 2020 2061  1 = [].        a
+00009cc0: 6c6c 7374 6163 6b73 3220 3d20 5b5d 0a20  llstacks2 = []. 
+00009cd0: 2020 2020 2020 206e 7374 6163 6b73 203d         nstacks =
+00009ce0: 2030 0a20 2020 2020 2020 2063 635f 6172   0.        cc_ar
+00009cf0: 7261 7920 3d20 5b5d 0a20 2020 2020 2020  ray = [].       
+00009d00: 2063 635f 6e67 6f6f 6420 3d20 5b5d 0a20   cc_ngood = []. 
+00009d10: 2020 2020 2020 2063 635f 7469 6d65 203d         cc_time =
+00009d20: 205b 5d0a 2020 2020 2020 2020 7265 7475   [].        retu
+00009d30: 726e 2063 635f 6172 7261 792c 2063 635f  rn cc_array, cc_
+00009d40: 6e67 6f6f 642c 2063 635f 7469 6d65 2c20  ngood, cc_time, 
+00009d50: 616c 6c73 7461 636b 7331 2c20 616c 6c73  allstacks1, alls
+00009d60: 7461 636b 7332 2c20 6e73 7461 636b 730a  tacks2, nstacks.
+00009d70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00009d80: 2020 2320 7265 6d6f 7665 206f 6e65 7320    # remove ones 
+00009d90: 7769 7468 2062 6164 2061 6d70 6c69 7475  with bad amplitu
+00009da0: 6465 0a20 2020 2020 2020 2063 635f 6172  de.        cc_ar
+00009db0: 7261 7920 3d20 6363 5f61 7272 6179 5b74  ray = cc_array[t
+00009dc0: 696e 6478 2c20 3a5d 0a20 2020 2020 2020  indx, :].       
+00009dd0: 2063 635f 7469 6d65 203d 2063 635f 7469   cc_time = cc_ti
+00009de0: 6d65 5b74 696e 6478 5d0a 2020 2020 2020  me[tindx].      
+00009df0: 2020 6363 5f6e 676f 6f64 203d 2063 635f    cc_ngood = cc_
+00009e00: 6e67 6f6f 645b 7469 6e64 785d 0a0a 2020  ngood[tindx]..  
+00009e10: 2020 2020 2020 2320 646f 2073 7562 7374        # do subst
+00009e20: 6163 6b73 0a20 2020 2020 2020 2069 6620  acks.        if 
+00009e30: 726d 615f 7375 6273 7461 636b 3a0a 2020  rma_substack:.  
+00009e40: 2020 2020 2020 2020 2020 7473 7461 7274            tstart
+00009e50: 203d 206f 6273 7079 2e55 5443 4461 7465   = obspy.UTCDate
+00009e60: 5469 6d65 2873 7461 7274 5f64 6174 6529  Time(start_date)
+00009e70: 202d 206f 6273 7079 2e55 5443 4461 7465   - obspy.UTCDate
+00009e80: 5469 6d65 2831 3937 302c 2031 2c20 3129  Time(1970, 1, 1)
+00009e90: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
+00009ea0: 6420 3d20 6f62 7370 792e 5554 4344 6174  d = obspy.UTCDat
+00009eb0: 6554 696d 6528 656e 645f 6461 7465 2920  eTime(end_date) 
+00009ec0: 2d20 6f62 7370 792e 5554 4344 6174 6554  - obspy.UTCDateT
+00009ed0: 696d 6528 3139 3730 2c20 312c 2031 290a  ime(1970, 1, 1).
+00009ee0: 2020 2020 2020 2020 2020 2020 7474 696d              ttim
+00009ef0: 6520 3d20 7473 7461 7274 0a20 2020 2020  e = tstart.     
+00009f00: 2020 2020 2020 206e 7374 6163 6b20 3d20         nstack = 
+00009f10: 696e 7428 6e70 2e72 6f75 6e64 2828 7465  int(np.round((te
+00009f20: 6e64 202d 2074 7374 6172 7429 202f 2028  nd - tstart) / (
+00009f30: 726d 615f 7374 6570 202a 2033 3630 3029  rma_step * 3600)
+00009f40: 2929 0a20 2020 2020 2020 2020 2020 206e  )).            n
+00009f50: 6363 5f61 7272 6179 203d 206e 702e 7a65  cc_array = np.ze
+00009f60: 726f 7328 7368 6170 653d 286e 7374 6163  ros(shape=(nstac
+00009f70: 6b2c 206e 7074 7329 2c20 6474 7970 653d  k, npts), dtype=
+00009f80: 6e70 2e66 6c6f 6174 3332 290a 2020 2020  np.float32).    
+00009f90: 2020 2020 2020 2020 6e63 635f 7469 6d65          ncc_time
+00009fa0: 203d 206e 702e 7a65 726f 7328 6e73 7461   = np.zeros(nsta
+00009fb0: 636b 2c20 6474 7970 653d 6e70 2e66 6c6f  ck, dtype=np.flo
+00009fc0: 6174 290a 2020 2020 2020 2020 2020 2020  at).            
+00009fd0: 6e63 635f 6e67 6f6f 6420 3d20 6e70 2e7a  ncc_ngood = np.z
+00009fe0: 6572 6f73 286e 7374 6163 6b2c 2064 7479  eros(nstack, dty
+00009ff0: 7065 3d6e 702e 696e 7429 0a0a 2020 2020  pe=np.int)..    
+0000a000: 2020 2020 2020 2020 2320 6c6f 6f70 2074          # loop t
+0000a010: 6872 6f75 6768 2065 6163 6820 7469 6d65  hrough each time
+0000a020: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0000a030: 2069 6920 696e 2072 616e 6765 286e 7374   ii in range(nst
+0000a040: 6163 6b29 3a0a 2020 2020 2020 2020 2020  ack):.          
+0000a050: 2020 2020 2020 7369 6e64 7820 3d20 6e70        sindx = np
+0000a060: 2e77 6865 7265 2828 6363 5f74 696d 6520  .where((cc_time 
+0000a070: 3e3d 2074 7469 6d65 2920 2620 2863 635f  >= ttime) & (cc_
+0000a080: 7469 6d65 203c 2074 7469 6d65 202b 2072  time < ttime + r
+0000a090: 6d61 5f73 7562 7374 6163 6b20 2a20 3336  ma_substack * 36
+0000a0a0: 3030 2929 5b30 5d0a 0a20 2020 2020 2020  00))[0]..       
+0000a0b0: 2020 2020 2020 2020 2023 2077 6865 6e20           # when 
+0000a0c0: 7468 6572 6520 6172 6520 6461 7461 2069  there are data i
+0000a0d0: 6e20 7468 6520 7469 6d65 2077 696e 646f  n the time windo
+0000a0e0: 770a 2020 2020 2020 2020 2020 2020 2020  w.              
+0000a0f0: 2020 6966 206c 656e 2873 696e 6478 293a    if len(sindx):
+0000a100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a110: 2020 2020 206e 6363 5f61 7272 6179 5b69       ncc_array[i
+0000a120: 695d 203d 206e 702e 6d65 616e 2863 635f  i] = np.mean(cc_
+0000a130: 6172 7261 795b 7369 6e64 785d 2c20 6178  array[sindx], ax
+0000a140: 6973 3d30 290a 2020 2020 2020 2020 2020  is=0).          
+0000a150: 2020 2020 2020 2020 2020 6e63 635f 7469            ncc_ti
+0000a160: 6d65 5b69 695d 203d 2074 7469 6d65 0a20  me[ii] = ttime. 
+0000a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a180: 2020 206e 6363 5f6e 676f 6f64 5b69 695d     ncc_ngood[ii]
+0000a190: 203d 206e 702e 7375 6d28 6363 5f6e 676f   = np.sum(cc_ngo
+0000a1a0: 6f64 5b73 696e 6478 5d2c 2061 7869 733d  od[sindx], axis=
+0000a1b0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0000a1c0: 2020 2074 7469 6d65 202b 3d20 726d 615f     ttime += rma_
+0000a1d0: 7374 6570 202a 2033 3630 300a 0a20 2020  step * 3600..   
+0000a1e0: 2020 2020 2020 2020 2023 2072 656d 6f76           # remov
+0000a1f0: 6520 6261 6420 6f6e 6573 0a20 2020 2020  e bad ones.     
+0000a200: 2020 2020 2020 2074 696e 6478 203d 206e         tindx = n
+0000a210: 702e 7768 6572 6528 6e63 635f 6e67 6f6f  p.where(ncc_ngoo
+0000a220: 6420 3e20 3029 5b30 5d0a 2020 2020 2020  d > 0)[0].      
+0000a230: 2020 2020 2020 6e63 635f 6172 7261 7920        ncc_array 
+0000a240: 3d20 6e63 635f 6172 7261 795b 7469 6e64  = ncc_array[tind
+0000a250: 785d 0a20 2020 2020 2020 2020 2020 206e  x].            n
+0000a260: 6363 5f74 696d 6520 3d20 6e63 635f 7469  cc_time = ncc_ti
+0000a270: 6d65 5b74 696e 6478 5d0a 2020 2020 2020  me[tindx].      
+0000a280: 2020 2020 2020 6e63 635f 6e67 6f6f 6420        ncc_ngood 
+0000a290: 3d20 6e63 635f 6e67 6f6f 645b 7469 6e64  = ncc_ngood[tind
+0000a2a0: 785d 0a0a 2020 2020 2020 2020 2320 646f  x]..        # do
+0000a2b0: 2073 7461 636b 696e 670a 2020 2020 2020   stacking.      
+0000a2c0: 2020 616c 6c73 7461 636b 7331 203d 206e    allstacks1 = n
+0000a2d0: 702e 7a65 726f 7328 6e70 7473 2c20 6474  p.zeros(npts, dt
+0000a2e0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+0000a2f0: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
+0000a300: 7332 203d 206e 702e 7a65 726f 7328 6e70  s2 = np.zeros(np
+0000a310: 7473 2c20 6474 7970 653d 6e70 2e66 6c6f  ts, dtype=np.flo
+0000a320: 6174 3332 290a 2020 2020 2020 2020 616c  at32).        al
+0000a330: 6c73 7461 636b 7333 203d 206e 702e 7a65  lstacks3 = np.ze
+0000a340: 726f 7328 6e70 7473 2c20 6474 7970 653d  ros(npts, dtype=
+0000a350: 6e70 2e66 6c6f 6174 3332 290a 2020 2020  np.float32).    
+0000a360: 2020 2020 616c 6c73 7461 636b 7334 203d      allstacks4 =
+0000a370: 206e 702e 7a65 726f 7328 6e70 7473 2c20   np.zeros(npts, 
+0000a380: 6474 7970 653d 6e70 2e66 6c6f 6174 3332  dtype=np.float32
+0000a390: 290a 0a20 2020 2020 2020 2069 6620 736d  )..        if sm
+0000a3a0: 6574 686f 6420 3d3d 2022 6c69 6e65 6172  ethod == "linear
+0000a3b0: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
+0000a3c0: 6c6c 7374 6163 6b73 3120 3d20 6e70 2e6d  llstacks1 = np.m
+0000a3d0: 6561 6e28 6363 5f61 7272 6179 2c20 6178  ean(cc_array, ax
+0000a3e0: 6973 3d30 290a 2020 2020 2020 2020 656c  is=0).        el
+0000a3f0: 6966 2073 6d65 7468 6f64 203d 3d20 2270  if smethod == "p
+0000a400: 7773 223a 0a20 2020 2020 2020 2020 2020  ws":.           
+0000a410: 2061 6c6c 7374 6163 6b73 3120 3d20 7077   allstacks1 = pw
+0000a420: 7328 6363 5f61 7272 6179 2c20 7361 6d70  s(cc_array, samp
+0000a430: 5f66 7265 7129 0a20 2020 2020 2020 2065  _freq).        e
+0000a440: 6c69 6620 736d 6574 686f 6420 3d3d 2022  lif smethod == "
+0000a450: 726f 6275 7374 223a 0a20 2020 2020 2020  robust":.       
+0000a460: 2020 2020 2028 0a20 2020 2020 2020 2020       (.         
+0000a470: 2020 2020 2020 2061 6c6c 7374 6163 6b73         allstacks
+0000a480: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+0000a490: 2020 2077 2c0a 2020 2020 2020 2020 2020     w,.          
+0000a4a0: 2020 2920 3d20 726f 6275 7374 5f73 7461    ) = robust_sta
+0000a4b0: 636b 2863 635f 6172 7261 792c 2030 2e30  ck(cc_array, 0.0
+0000a4c0: 3031 290a 2020 2020 2020 2020 656c 6966  01).        elif
+0000a4d0: 2073 6d65 7468 6f64 203d 3d20 2273 656c   smethod == "sel
+0000a4e0: 6563 7469 7665 223a 0a20 2020 2020 2020  ective":.       
+0000a4f0: 2020 2020 2061 6c6c 7374 6163 6b73 3120       allstacks1 
+0000a500: 3d20 7365 6c65 6374 6976 655f 7374 6163  = selective_stac
+0000a510: 6b28 6363 5f61 7272 6179 2c20 302e 3030  k(cc_array, 0.00
+0000a520: 3129 0a20 2020 2020 2020 2065 6c69 6620  1).        elif 
+0000a530: 736d 6574 686f 6420 3d3d 2022 616c 6c22  smethod == "all"
+0000a540: 3a0a 2020 2020 2020 2020 2020 2020 616c  :.            al
+0000a550: 6c73 7461 636b 7331 203d 206e 702e 6d65  lstacks1 = np.me
+0000a560: 616e 2863 635f 6172 7261 792c 2061 7869  an(cc_array, axi
+0000a570: 733d 3029 0a20 2020 2020 2020 2020 2020  s=0).           
+0000a580: 2061 6c6c 7374 6163 6b73 3220 3d20 7077   allstacks2 = pw
+0000a590: 7328 6363 5f61 7272 6179 2c20 7361 6d70  s(cc_array, samp
+0000a5a0: 5f66 7265 7129 0a20 2020 2020 2020 2020  _freq).         
+0000a5b0: 2020 2061 6c6c 7374 6163 6b73 3320 3d20     allstacks3 = 
+0000a5c0: 726f 6275 7374 5f73 7461 636b 2863 635f  robust_stack(cc_
+0000a5d0: 6172 7261 792c 2030 2e30 3031 290a 2020  array, 0.001).  
+0000a5e0: 2020 2020 2020 2020 2020 616c 6c73 7461            allsta
+0000a5f0: 636b 7334 203d 2073 656c 6563 7469 7665  cks4 = selective
+0000a600: 5f73 7461 636b 2863 635f 6172 7261 792c  _stack(cc_array,
+0000a610: 2030 2e30 3031 290a 2020 2020 2020 2020   0.001).        
+0000a620: 6e73 7461 636b 7320 3d20 6e70 2e73 756d  nstacks = np.sum
+0000a630: 2863 635f 6e67 6f6f 6429 0a0a 2020 2020  (cc_ngood)..    
+0000a640: 2320 7265 706c 6163 6520 7468 6520 6172  # replace the ar
+0000a650: 7261 7920 666f 7220 7375 6273 7461 636b  ray for substack
+0000a660: 730a 2020 2020 6966 2072 6d61 5f73 7562  s.    if rma_sub
+0000a670: 7374 6163 6b3a 0a20 2020 2020 2020 2063  stack:.        c
+0000a680: 635f 6172 7261 7920 3d20 6e63 635f 6172  c_array = ncc_ar
+0000a690: 7261 790a 2020 2020 2020 2020 6363 5f74  ray.        cc_t
+0000a6a0: 696d 6520 3d20 6e63 635f 7469 6d65 0a20  ime = ncc_time. 
+0000a6b0: 2020 2020 2020 2063 635f 6e67 6f6f 6420         cc_ngood 
+0000a6c0: 3d20 6e63 635f 6e67 6f6f 640a 0a20 2020  = ncc_ngood..   
+0000a6d0: 2023 2067 6f6f 6420 746f 2072 6574 7572   # good to retur
+0000a6e0: 6e0a 2020 2020 7265 7475 726e 2028 0a20  n.    return (. 
+0000a6f0: 2020 2020 2020 2063 635f 6172 7261 792c         cc_array,
+0000a700: 0a20 2020 2020 2020 2063 635f 6e67 6f6f  .        cc_ngoo
+0000a710: 642c 0a20 2020 2020 2020 2063 635f 7469  d,.        cc_ti
+0000a720: 6d65 2c0a 2020 2020 2020 2020 616c 6c73  me,.        alls
+0000a730: 7461 636b 7331 2c0a 2020 2020 2020 2020  tacks1,.        
+0000a740: 616c 6c73 7461 636b 7332 2c0a 2020 2020  allstacks2,.    
+0000a750: 2020 2020 616c 6c73 7461 636b 7333 2c0a      allstacks3,.
+0000a760: 2020 2020 2020 2020 616c 6c73 7461 636b          allstack
+0000a770: 7334 2c0a 2020 2020 2020 2020 6e73 7461  s4,.        nsta
+0000a780: 636b 732c 0a20 2020 2029 0a0a 0a64 6566  cks,.    )...def
+0000a790: 2072 6f74 6174 696f 6e28 6269 6773 7461   rotation(bigsta
+0000a7a0: 636b 2c20 7061 7261 6d65 7465 7273 2c20  ck, parameters, 
+0000a7b0: 6c6f 6373 293a 0a20 2020 2022 2222 0a20  locs):.    """. 
+0000a7c0: 2020 2074 6869 7320 6675 6e63 7469 6f6e     this function
+0000a7d0: 2074 7261 6e73 6665 7273 2074 6865 2047   transfers the G
+0000a7e0: 7265 656e 2773 2074 656e 736f 7220 6672  reen's tensor fr
+0000a7f0: 6f6d 2061 2045 2d4e 2d5a 2073 7973 7465  om a E-N-Z syste
+0000a800: 6d20 696e 746f 2061 2052 2d54 2d5a 206f  m into a R-T-Z o
+0000a810: 6e65 0a0a 2020 2020 5041 5241 4d45 5445  ne..    PARAMETE
+0000a820: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+0000a830: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+0000a840: 6269 6773 7461 636b 3a20 2020 3920 636f  bigstack:   9 co
+0000a850: 6d70 6f6e 656e 7420 4772 6565 6e27 7320  mponent Green's 
+0000a860: 7465 6e73 6f72 2069 6e20 452d 4e2d 5a20  tensor in E-N-Z 
+0000a870: 7379 7374 656d 0a20 2020 2070 6172 616d  system.    param
+0000a880: 6574 6572 733a 2064 6963 7420 636f 6e74  eters: dict cont
+0000a890: 6169 6e69 6e67 2061 6c6c 2070 6172 616d  aining all param
+0000a8a0: 6574 6572 7320 7361 7665 6420 696e 2041  eters saved in A
+0000a8b0: 5344 4620 6669 6c65 0a20 2020 206c 6f63  SDF file.    loc
+0000a8c0: 733a 2020 2020 2020 2064 6963 7420 636f  s:       dict co
+0000a8d0: 6e74 6169 6e69 6e67 2073 7461 7469 6f6e  ntaining station
+0000a8e0: 2061 6e67 6c65 2069 6e66 6f20 666f 7220   angle info for 
+0000a8f0: 636f 7272 6563 7469 6f6e 2070 7572 706f  correction purpo
+0000a900: 7365 0a20 2020 2052 4554 5552 4e53 3a0a  se.    RETURNS:.
+0000a910: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0000a920: 2d2d 2d2d 2d2d 2d0a 2020 2020 7463 6f72  -------.    tcor
+0000a930: 723a 2039 2063 6f6d 706f 6e65 6e74 2047  r: 9 component G
+0000a940: 7265 656e 2773 2074 656e 736f 7220 696e  reen's tensor in
+0000a950: 2052 2d54 2d5a 2073 7973 7465 6d0a 2020   R-T-Z system.  
+0000a960: 2020 2222 220a 2020 2020 2320 6c6f 6164    """.    # load
+0000a970: 2070 6172 616d 6574 6572 2064 6963 0a20   parameter dic. 
+0000a980: 2020 2070 6920 3d20 6e70 2e70 690a 2020     pi = np.pi.  
+0000a990: 2020 617a 6920 3d20 7061 7261 6d65 7465    azi = paramete
+0000a9a0: 7273 5b22 617a 6922 5d0a 2020 2020 6261  rs["azi"].    ba
+0000a9b0: 7a20 3d20 7061 7261 6d65 7465 7273 5b22  z = parameters["
+0000a9c0: 6261 7a22 5d0a 2020 2020 6e63 6f6d 702c  baz"].    ncomp,
+0000a9d0: 206e 7074 7320 3d20 6269 6773 7461 636b   npts = bigstack
+0000a9e0: 2e73 6861 7065 0a20 2020 2069 6620 6e63  .shape.    if nc
+0000a9f0: 6f6d 7020 3c20 393a 0a20 2020 2020 2020  omp < 9:.       
+0000aa00: 206c 6f67 6765 722e 6465 6275 6728 2263   logger.debug("c
+0000aa10: 7261 7020 6469 6420 6e6f 7420 6765 7420  rap did not get 
+0000aa20: 656e 6f75 6768 2063 6f6d 706f 6e65 6e74  enough component
+0000aa30: 7322 290a 2020 2020 2020 2020 7463 6f72  s").        tcor
+0000aa40: 7220 3d20 5b5d 0a20 2020 2020 2020 2072  r = [].        r
+0000aa50: 6574 7572 6e20 7463 6f72 720a 2020 2020  eturn tcorr.    
+0000aa60: 7374 6153 203d 2070 6172 616d 6574 6572  staS = parameter
+0000aa70: 735b 2273 7461 7469 6f6e 5f73 6f75 7263  s["station_sourc
+0000aa80: 6522 5d0a 2020 2020 7374 6152 203d 2070  e"].    staR = p
+0000aa90: 6172 616d 6574 6572 735b 2273 7461 7469  arameters["stati
+0000aaa0: 6f6e 5f72 6563 6569 7665 7222 5d0a 0a20  on_receiver"].. 
+0000aab0: 2020 2069 6620 6c65 6e28 6c6f 6373 293a     if len(locs):
+0000aac0: 0a20 2020 2020 2020 2073 7461 5f6c 6973  .        sta_lis
+0000aad0: 7420 3d20 6c69 7374 286c 6f63 735b 2273  t = list(locs["s
+0000aae0: 7461 7469 6f6e 225d 290a 2020 2020 2020  tation"]).      
+0000aaf0: 2020 616e 676c 6573 203d 206c 6973 7428    angles = list(
+0000ab00: 6c6f 6373 5b22 616e 676c 6522 5d29 0a20  locs["angle"]). 
+0000ab10: 2020 2020 2020 2023 2067 6574 2073 7461         # get sta
+0000ab20: 7469 6f6e 2069 6e66 6f20 6672 6f6d 2074  tion info from t
+0000ab30: 6865 206e 616d 6520 6f66 2041 5344 4620  he name of ASDF 
+0000ab40: 6669 6c65 0a20 2020 2020 2020 2069 6e64  file.        ind
+0000ab50: 203d 2073 7461 5f6c 6973 742e 696e 6465   = sta_list.inde
+0000ab60: 7828 7374 6153 290a 2020 2020 2020 2020  x(staS).        
+0000ab70: 6163 6f72 7220 3d20 616e 676c 6573 5b69  acorr = angles[i
+0000ab80: 6e64 5d0a 2020 2020 2020 2020 696e 6420  nd].        ind 
+0000ab90: 3d20 7374 615f 6c69 7374 2e69 6e64 6578  = sta_list.index
+0000aba0: 2873 7461 5229 0a20 2020 2020 2020 2062  (staR).        b
+0000abb0: 636f 7272 203d 2061 6e67 6c65 735b 696e  corr = angles[in
+0000abc0: 645d 0a0a 2020 2020 2320 2d2d 2d61 6e67  d]..    # ---ang
+0000abd0: 6c65 7320 746f 2062 6520 636f 7272 6563  les to be correc
+0000abe0: 7465 642d 2d2d 2d0a 2020 2020 6966 206c  ted----.    if l
+0000abf0: 656e 286c 6f63 7329 3a0a 2020 2020 2020  en(locs):.      
+0000ac00: 2020 636f 7361 203d 206e 702e 636f 7328    cosa = np.cos(
+0000ac10: 2861 7a69 202b 2061 636f 7272 2920 2a20  (azi + acorr) * 
+0000ac20: 7069 202f 2031 3830 290a 2020 2020 2020  pi / 180).      
+0000ac30: 2020 7369 6e61 203d 206e 702e 7369 6e28    sina = np.sin(
+0000ac40: 2861 7a69 202b 2061 636f 7272 2920 2a20  (azi + acorr) * 
+0000ac50: 7069 202f 2031 3830 290a 2020 2020 2020  pi / 180).      
+0000ac60: 2020 636f 7362 203d 206e 702e 636f 7328    cosb = np.cos(
+0000ac70: 2862 617a 202b 2062 636f 7272 2920 2a20  (baz + bcorr) * 
+0000ac80: 7069 202f 2031 3830 290a 2020 2020 2020  pi / 180).      
+0000ac90: 2020 7369 6e62 203d 206e 702e 7369 6e28    sinb = np.sin(
+0000aca0: 2862 617a 202b 2062 636f 7272 2920 2a20  (baz + bcorr) * 
+0000acb0: 7069 202f 2031 3830 290a 2020 2020 656c  pi / 180).    el
+0000acc0: 7365 3a0a 2020 2020 2020 2020 636f 7361  se:.        cosa
+0000acd0: 203d 206e 702e 636f 7328 617a 6920 2a20   = np.cos(azi * 
+0000ace0: 7069 202f 2031 3830 290a 2020 2020 2020  pi / 180).      
+0000acf0: 2020 7369 6e61 203d 206e 702e 7369 6e28    sina = np.sin(
+0000ad00: 617a 6920 2a20 7069 202f 2031 3830 290a  azi * pi / 180).
+0000ad10: 2020 2020 2020 2020 636f 7362 203d 206e          cosb = n
+0000ad20: 702e 636f 7328 6261 7a20 2a20 7069 202f  p.cos(baz * pi /
+0000ad30: 2031 3830 290a 2020 2020 2020 2020 7369   180).        si
+0000ad40: 6e62 203d 206e 702e 7369 6e28 6261 7a20  nb = np.sin(baz 
+0000ad50: 2a20 7069 202f 2031 3830 290a 0a20 2020  * pi / 180)..   
+0000ad60: 2023 2072 747a 5f63 6f6d 706f 6e65 6e74   # rtz_component
+0000ad70: 7320 3d20 5b27 5a52 272c 275a 5427 2c27  s = ['ZR','ZT','
+0000ad80: 5a5a 272c 2752 5227 2c27 5254 272c 2752  ZZ','RR','RT','R
+0000ad90: 5a27 2c27 5452 272c 2754 5427 2c27 545a  Z','TR','TT','TZ
+0000ada0: 275d 0a20 2020 2074 636f 7272 203d 206e  '].    tcorr = n
+0000adb0: 702e 7a65 726f 7328 7368 6170 653d 2839  p.zeros(shape=(9
+0000adc0: 2c20 6e70 7473 292c 2064 7479 7065 3d6e  , npts), dtype=n
+0000add0: 702e 666c 6f61 7433 3229 0a20 2020 2074  p.float32).    t
+0000ade0: 636f 7272 5b30 5d20 3d20 2d63 6f73 6220  corr[0] = -cosb 
+0000adf0: 2a20 6269 6773 7461 636b 5b37 5d20 2d20  * bigstack[7] - 
+0000ae00: 7369 6e62 202a 2062 6967 7374 6163 6b5b  sinb * bigstack[
+0000ae10: 365d 0a20 2020 2074 636f 7272 5b31 5d20  6].    tcorr[1] 
+0000ae20: 3d20 7369 6e62 202a 2062 6967 7374 6163  = sinb * bigstac
+0000ae30: 6b5b 375d 202d 2063 6f73 6220 2a20 6269  k[7] - cosb * bi
+0000ae40: 6773 7461 636b 5b36 5d0a 2020 2020 7463  gstack[6].    tc
+0000ae50: 6f72 725b 325d 203d 2062 6967 7374 6163  orr[2] = bigstac
+0000ae60: 6b5b 385d 0a20 2020 2074 636f 7272 5b33  k[8].    tcorr[3
+0000ae70: 5d20 3d20 280a 2020 2020 2020 2020 2d63  ] = (.        -c
+0000ae80: 6f73 6120 2a20 636f 7362 202a 2062 6967  osa * cosb * big
+0000ae90: 7374 6163 6b5b 345d 202d 2063 6f73 6120  stack[4] - cosa 
+0000aea0: 2a20 7369 6e62 202a 2062 6967 7374 6163  * sinb * bigstac
+0000aeb0: 6b5b 335d 202d 2073 696e 6120 2a20 636f  k[3] - sina * co
+0000aec0: 7362 202a 2062 6967 7374 6163 6b5b 315d  sb * bigstack[1]
+0000aed0: 202d 2073 696e 6120 2a20 7369 6e62 202a   - sina * sinb *
+0000aee0: 2062 6967 7374 6163 6b5b 305d 0a20 2020   bigstack[0].   
+0000aef0: 2029 0a20 2020 2074 636f 7272 5b34 5d20   ).    tcorr[4] 
+0000af00: 3d20 280a 2020 2020 2020 2020 636f 7361  = (.        cosa
+0000af10: 202a 2073 696e 6220 2a20 6269 6773 7461   * sinb * bigsta
+0000af20: 636b 5b34 5d20 2d20 636f 7361 202a 2063  ck[4] - cosa * c
+0000af30: 6f73 6220 2a20 6269 6773 7461 636b 5b33  osb * bigstack[3
+0000af40: 5d20 2b20 7369 6e61 202a 2073 696e 6220  ] + sina * sinb 
+0000af50: 2a20 6269 6773 7461 636b 5b31 5d20 2d20  * bigstack[1] - 
+0000af60: 7369 6e61 202a 2063 6f73 6220 2a20 6269  sina * cosb * bi
+0000af70: 6773 7461 636b 5b30 5d0a 2020 2020 290a  gstack[0].    ).
+0000af80: 2020 2020 7463 6f72 725b 355d 203d 2063      tcorr[5] = c
+0000af90: 6f73 6120 2a20 6269 6773 7461 636b 5b35  osa * bigstack[5
+0000afa0: 5d20 2b20 7369 6e61 202a 2062 6967 7374  ] + sina * bigst
+0000afb0: 6163 6b5b 325d 0a20 2020 2074 636f 7272  ack[2].    tcorr
+0000afc0: 5b36 5d20 3d20 280a 2020 2020 2020 2020  [6] = (.        
+0000afd0: 7369 6e61 202a 2063 6f73 6220 2a20 6269  sina * cosb * bi
+0000afe0: 6773 7461 636b 5b34 5d20 2b20 7369 6e61  gstack[4] + sina
+0000aff0: 202a 2073 696e 6220 2a20 6269 6773 7461   * sinb * bigsta
+0000b000: 636b 5b33 5d20 2d20 636f 7361 202a 2063  ck[3] - cosa * c
+0000b010: 6f73 6220 2a20 6269 6773 7461 636b 5b31  osb * bigstack[1
+0000b020: 5d20 2d20 636f 7361 202a 2073 696e 6220  ] - cosa * sinb 
+0000b030: 2a20 6269 6773 7461 636b 5b30 5d0a 2020  * bigstack[0].  
+0000b040: 2020 290a 2020 2020 7463 6f72 725b 375d    ).    tcorr[7]
+0000b050: 203d 2028 0a20 2020 2020 2020 202d 7369   = (.        -si
+0000b060: 6e61 202a 2073 696e 6220 2a20 6269 6773  na * sinb * bigs
+0000b070: 7461 636b 5b34 5d20 2b20 7369 6e61 202a  tack[4] + sina *
+0000b080: 2063 6f73 6220 2a20 6269 6773 7461 636b   cosb * bigstack
+0000b090: 5b33 5d20 2b20 636f 7361 202a 2073 696e  [3] + cosa * sin
+0000b0a0: 6220 2a20 6269 6773 7461 636b 5b31 5d20  b * bigstack[1] 
+0000b0b0: 2d20 636f 7361 202a 2063 6f73 6220 2a20  - cosa * cosb * 
+0000b0c0: 6269 6773 7461 636b 5b30 5d0a 2020 2020  bigstack[0].    
+0000b0d0: 290a 2020 2020 7463 6f72 725b 385d 203d  ).    tcorr[8] =
+0000b0e0: 202d 7369 6e61 202a 2062 6967 7374 6163   -sina * bigstac
+0000b0f0: 6b5b 355d 202b 2063 6f73 6120 2a20 6269  k[5] + cosa * bi
+0000b100: 6773 7461 636b 5b32 5d0a 0a20 2020 2072  gstack[2]..    r
+0000b110: 6574 7572 6e20 7463 6f72 720a 0a0a 2323  eturn tcorr...##
+0000b120: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b130: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b140: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b150: 2323 0a23 2323 2323 2323 2323 2323 2323  ##.#############
+0000b160: 2320 5554 494c 4954 5920 4655 4e43 5449  # UTILITY FUNCTI
+0000b170: 4f4e 5320 2323 2323 2323 2323 2323 2323  ONS ############
+0000b180: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
+0000b190: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b1a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000b1b0: 2323 2323 2323 2323 2323 2323 0a0a 0a64  ############...d
+0000b1c0: 6566 2063 6865 636b 5f73 616d 706c 655f  ef check_sample_
+0000b1d0: 6761 7073 2873 7472 6561 6d3a 206f 6273  gaps(stream: obs
+0000b1e0: 7079 2e53 7472 6561 6d2c 2073 7461 7274  py.Stream, start
+0000b1f0: 7469 6d65 3a20 6f62 7370 792e 5554 4344  time: obspy.UTCD
+0000b200: 6174 6554 696d 652c 2065 6e64 7469 6d65  ateTime, endtime
+0000b210: 3a20 6f62 7370 792e 5554 4344 6174 6554  : obspy.UTCDateT
+0000b220: 696d 6529 3a0a 2020 2020 2222 220a 2020  ime):.    """.  
+0000b230: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
+0000b240: 6368 6563 6b73 2073 616d 706c 696e 6720  checks sampling 
+0000b250: 7261 7465 2061 6e64 2066 696e 6420 6761  rate and find ga
+0000b260: 7073 206f 6620 616c 6c20 7472 6163 6573  ps of all traces
+0000b270: 2069 6e20 7374 7265 616d 2e0a 2020 2020   in stream..    
+0000b280: 5041 5241 4d45 5445 5253 3a0a 2020 2020  PARAMETERS:.    
+0000b290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000b2a0: 2d0a 2020 2020 7374 7265 616d 3a20 6f62  -.    stream: ob
+0000b2b0: 7370 7920 7374 7265 616d 206f 626a 6563  spy stream objec
+0000b2c0: 742e 0a20 2020 2064 6174 655f 696e 666f  t..    date_info
+0000b2d0: 3a20 6469 6374 206f 6620 7374 6172 7469  : dict of starti
+0000b2e0: 6e67 2061 6e64 2065 6e64 696e 6720 7469  ng and ending ti
+0000b2f0: 6d65 206f 6620 7468 6520 7374 7265 616d  me of the stream
+0000b300: 0a0a 2020 2020 5245 5455 5245 4e53 3a0a  ..    RETURENS:.
+0000b310: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+0000b320: 2d2d 2d2d 2d0a 2020 2020 7374 7265 616d  -----.    stream
+0000b330: 3a20 4c69 7374 206f 6620 676f 6f64 2074  : List of good t
+0000b340: 7261 6365 7320 696e 2074 6865 2073 7472  races in the str
+0000b350: 6561 6d0a 2020 2020 2222 220a 2020 2020  eam.    """.    
+0000b360: 2320 7265 6d6f 7665 2065 6d70 7479 2f62  # remove empty/b
+0000b370: 6967 2074 7261 6365 730a 2020 2020 6966  ig traces.    if
+0000b380: 206c 656e 2873 7472 6561 6d29 203d 3d20   len(stream) == 
+0000b390: 3020 6f72 206c 656e 2873 7472 6561 6d29  0 or len(stream)
+0000b3a0: 203e 2031 3030 3a0a 2020 2020 2020 2020   > 100:.        
+0000b3b0: 7374 7265 616d 203d 205b 5d0a 2020 2020  stream = [].    
+0000b3c0: 2020 2020 7265 7475 726e 2073 7472 6561      return strea
+0000b3d0: 6d0a 0a20 2020 2023 2072 656d 6f76 6520  m..    # remove 
+0000b3e0: 7472 6163 6573 2077 6974 6820 6269 6720  traces with big 
+0000b3f0: 6761 7073 0a20 2020 2069 6620 706f 7274  gaps.    if port
+0000b400: 696f 6e5f 6761 7073 2873 7472 6561 6d2c  ion_gaps(stream,
+0000b410: 2073 7461 7274 7469 6d65 2c20 656e 6474   starttime, endt
+0000b420: 696d 6529 203e 2030 2e33 3a0a 2020 2020  ime) > 0.3:.    
+0000b430: 2020 2020 7374 7265 616d 203d 205b 5d0a      stream = [].
+0000b440: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000b450: 7472 6561 6d0a 0a20 2020 2066 7265 7173  tream..    freqs
+0000b460: 203d 205b 5d0a 2020 2020 666f 7220 7472   = [].    for tr
+0000b470: 2069 6e20 7374 7265 616d 3a0a 2020 2020   in stream:.    
+0000b480: 2020 2020 6672 6571 732e 6170 7065 6e64      freqs.append
+0000b490: 2869 6e74 2874 722e 7374 6174 732e 7361  (int(tr.stats.sa
+0000b4a0: 6d70 6c69 6e67 5f72 6174 6529 290a 2020  mpling_rate)).  
+0000b4b0: 2020 6672 6571 203d 206d 6178 2866 7265    freq = max(fre
+0000b4c0: 7173 290a 2020 2020 666f 7220 7472 2069  qs).    for tr i
+0000b4d0: 6e20 7374 7265 616d 3a0a 2020 2020 2020  n stream:.      
+0000b4e0: 2020 6966 2069 6e74 2874 722e 7374 6174    if int(tr.stat
+0000b4f0: 732e 7361 6d70 6c69 6e67 5f72 6174 6529  s.sampling_rate)
+0000b500: 2021 3d20 6672 6571 3a0a 2020 2020 2020   != freq:.      
+0000b510: 2020 2020 2020 7374 7265 616d 2e72 656d        stream.rem
+0000b520: 6f76 6528 7472 290a 2020 2020 2020 2020  ove(tr).        
+0000b530: 6966 2074 722e 7374 6174 732e 6e70 7473  if tr.stats.npts
+0000b540: 203c 2031 303a 0a20 2020 2020 2020 2020   < 10:.         
+0000b550: 2020 2073 7472 6561 6d2e 7265 6d6f 7665     stream.remove
+0000b560: 2874 7229 0a0a 2020 2020 7265 7475 726e  (tr)..    return
+0000b570: 2073 7472 6561 6d0a 0a0a 6465 6620 706f   stream...def po
+0000b580: 7274 696f 6e5f 6761 7073 2873 7472 6561  rtion_gaps(strea
+0000b590: 6d2c 2073 7461 7274 7469 6d65 3a20 6f62  m, starttime: ob
+0000b5a0: 7370 792e 5554 4344 6174 6554 696d 652c  spy.UTCDateTime,
+0000b5b0: 2065 6e64 7469 6d65 3a20 6f62 7370 792e   endtime: obspy.
+0000b5c0: 5554 4344 6174 6554 696d 6529 3a0a 2020  UTCDateTime):.  
+0000b5d0: 2020 2222 220a 2020 2020 7468 6973 2066    """.    this f
+0000b5e0: 756e 6374 696f 6e20 7472 6163 6b73 2074  unction tracks t
+0000b5f0: 6865 2067 6170 7320 286e 7074 7329 2066  he gaps (npts) f
+0000b600: 726f 6d20 7468 6520 6163 6375 6d75 6c61  rom the accumula
+0000b610: 7465 6420 6469 6666 6572 656e 6365 2062  ted difference b
+0000b620: 6574 7765 656e 2073 7461 7274 7469 6d65  etween starttime
+0000b630: 2061 6e64 2065 6e64 7469 6d65 0a20 2020   and endtime.   
+0000b640: 206f 6620 6561 6368 2073 7472 6561 6d20   of each stream 
+0000b650: 7472 6163 652e 2069 7420 7265 6d6f 7665  trace. it remove
+0000b660: 7320 7472 6163 6520 7769 7468 2067 6170  s trace with gap
+0000b670: 206c 656e 6774 6820 3e20 3330 2520 6f66   length > 30% of
+0000b680: 2074 7261 6365 2073 697a 652e 0a20 2020   trace size..   
+0000b690: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
+0000b6a0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+0000b6b0: 2d2d 2d2d 0a20 2020 2073 7472 6561 6d3a  ----.    stream:
+0000b6c0: 206f 6273 7079 2073 7472 6561 6d20 6f62   obspy stream ob
+0000b6d0: 6a65 6374 0a20 2020 2064 6174 655f 696e  ject.    date_in
+0000b6e0: 666f 3a20 6469 6374 206f 6620 7374 6172  fo: dict of star
+0000b6f0: 7469 6e67 2061 6e64 2065 6e64 696e 6720  ting and ending 
+0000b700: 7469 6d65 206f 6620 7468 6520 7374 7265  time of the stre
+0000b710: 616d 0a0a 2020 2020 5245 5455 524e 533a  am..    RETURNS:
+0000b720: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+0000b730: 2d2d 2d2d 2d2d 0a20 2020 2070 6761 7073  ------.    pgaps
+0000b740: 3a20 7072 6f70 6f72 7469 6f6e 206f 6620  : proportion of 
+0000b750: 6761 7073 2f61 6c6c 5f70 7473 2069 6e20  gaps/all_pts in 
+0000b760: 7374 7265 616d 0a20 2020 2022 2222 0a20  stream.    """. 
+0000b770: 2020 2023 2069 6465 616c 2064 7572 6174     # ideal durat
+0000b780: 696f 6e20 6f66 2064 6174 610a 2020 2020  ion of data.    
+0000b790: 6e70 7473 203d 2028 656e 6474 696d 6520  npts = (endtime 
+0000b7a0: 2d20 7374 6172 7474 696d 6529 202a 2073  - starttime) * s
+0000b7b0: 7472 6561 6d5b 305d 2e73 7461 7473 2e73  tream[0].stats.s
+0000b7c0: 616d 706c 696e 675f 7261 7465 0a0a 2020  ampling_rate..  
+0000b7d0: 2020 7067 6170 7320 3d20 300a 2020 2020    pgaps = 0.    
+0000b7e0: 2320 6c6f 6f70 2074 6872 6f75 6768 2061  # loop through a
+0000b7f0: 6c6c 2074 7261 6365 2074 6f20 6163 6375  ll trace to accu
+0000b800: 6d75 6c61 7465 2067 6170 730a 2020 2020  mulate gaps.    
+0000b810: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+0000b820: 6c65 6e28 7374 7265 616d 2920 2d20 3129  len(stream) - 1)
+0000b830: 3a0a 2020 2020 2020 2020 7067 6170 7320  :.        pgaps 
+0000b840: 2b3d 2028 7374 7265 616d 5b69 6920 2b20  += (stream[ii + 
+0000b850: 315d 2e73 7461 7473 2e73 7461 7274 7469  1].stats.startti
+0000b860: 6d65 202d 2073 7472 6561 6d5b 6969 5d2e  me - stream[ii].
+0000b870: 7374 6174 732e 656e 6474 696d 6529 202a  stats.endtime) *
+0000b880: 2073 7472 6561 6d5b 6969 5d2e 7374 6174   stream[ii].stat
+0000b890: 732e 7361 6d70 6c69 6e67 5f72 6174 650a  s.sampling_rate.
+0000b8a0: 2020 2020 6966 206e 7074 7320 213d 2030      if npts != 0
+0000b8b0: 3a0a 2020 2020 2020 2020 7067 6170 7320  :.        pgaps 
+0000b8c0: 3d20 7067 6170 7320 2f20 6e70 7473 0a20  = pgaps / npts. 
+0000b8d0: 2020 2069 6620 6e70 7473 203d 3d20 303a     if npts == 0:
+0000b8e0: 0a20 2020 2020 2020 2070 6761 7073 203d  .        pgaps =
+0000b8f0: 2031 0a20 2020 2072 6574 7572 6e20 7067   1.    return pg
+0000b900: 6170 730a 0a0a 406a 6974 2822 666c 6f61  aps...@jit("floa
+0000b910: 7433 325b 3a5d 2866 6c6f 6174 3332 5b3a  t32[:](float32[:
+0000b920: 5d2c 666c 6f61 7433 3229 2229 0a64 6566  ],float32)").def
+0000b930: 2073 6567 6d65 6e74 5f69 6e74 6572 706f   segment_interpo
+0000b940: 6c61 7465 2873 6967 312c 206e 6672 6963  late(sig1, nfric
+0000b950: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+0000b960: 6869 7320 6675 6e63 7469 6f6e 2069 6e74  his function int
+0000b970: 6572 706f 6c61 7465 7320 7468 6520 6461  erpolates the da
+0000b980: 7461 2074 6f20 656e 7375 7265 2061 6c6c  ta to ensure all
+0000b990: 2070 6f69 6e74 7320 6c6f 6361 7465 6420   points located 
+0000b9a0: 6f6e 2069 6e74 6572 6765 7220 7469 6d65  on interger time
+0000b9b0: 7320 6f66 2074 6865 0a20 2020 2073 616d  s of the.    sam
+0000b9c0: 706c 696e 6720 7261 7465 2028 652e 672e  pling rate (e.g.
+0000b9d0: 2c20 7374 6172 7474 696d 6520 3d20 3030  , starttime = 00
+0000b9e0: 3a30 303a 3030 2e30 3135 2c20 6465 6c74  :00:00.015, delt
+0000b9f0: 6120 3d20 302e 3035 2e29 0a20 2020 2050  a = 0.05.).    P
+0000ba00: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
+0000ba10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000ba20: 2d2d 2d2d 2d0a 2020 2020 7369 6731 3a20  -----.    sig1: 
+0000ba30: 2073 6569 736d 6963 2072 6563 6f72 6469   seismic recordi
+0000ba40: 6e67 7320 696e 2061 2031 4420 6172 7261  ngs in a 1D arra
+0000ba50: 790a 2020 2020 6e66 7269 633a 2074 6865  y.    nfric: the
+0000ba60: 2061 6d6f 756e 7420 6f66 2074 696d 6520   amount of time 
+0000ba70: 6469 6666 6572 656e 6365 2062 6574 7765  difference betwe
+0000ba80: 656e 2074 6865 2070 6f69 6e74 2061 6e64  en the point and
+0000ba90: 2074 6865 2061 646a 6163 656e 7420 6173   the adjacent as
+0000baa0: 7375 6d65 6420 7361 6d70 6c65 730a 2020  sumed samples.  
+0000bab0: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
 0000bac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000bad0: 0a20 2020 2073 6967 313a 2020 7365 6973  .    sig1:  seis
-0000bae0: 6d69 6320 7265 636f 7264 696e 6773 2069  mic recordings i
-0000baf0: 6e20 6120 3144 2061 7272 6179 0a20 2020  n a 1D array.   
-0000bb00: 206e 6672 6963 3a20 7468 6520 616d 6f75   nfric: the amou
-0000bb10: 6e74 206f 6620 7469 6d65 2064 6966 6665  nt of time diffe
-0000bb20: 7265 6e63 6520 6265 7477 6565 6e20 7468  rence between th
-0000bb30: 6520 706f 696e 7420 616e 6420 7468 6520  e point and the 
-0000bb40: 6164 6a61 6365 6e74 2061 7373 756d 6564  adjacent assumed
-0000bb50: 2073 616d 706c 6573 0a20 2020 2052 4554   samples.    RET
-0000bb60: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
-0000bb70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000bb80: 0a20 2020 2073 6967 323a 2020 696e 7465  .    sig2:  inte
-0000bb90: 7270 6f6c 6174 6564 2073 6569 736d 6963  rpolated seismic
-0000bba0: 2072 6563 6f72 6469 6e67 7320 6f6e 2074   recordings on t
-0000bbb0: 6865 2073 616d 706c 696e 6720 706f 696e  he sampling poin
-0000bbc0: 7473 0a20 2020 2022 2222 0a20 2020 206e  ts.    """.    n
-0000bbd0: 7074 7320 3d20 6c65 6e28 7369 6731 290a  pts = len(sig1).
-0000bbe0: 2020 2020 7369 6732 203d 206e 702e 7a65      sig2 = np.ze
-0000bbf0: 726f 7328 6e70 7473 2c20 6474 7970 653d  ros(npts, dtype=
-0000bc00: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
-0000bc10: 2023 202d 2d2d 2d69 6e73 7465 6164 206f   # ----instead o
-0000bc20: 6620 7368 6966 7469 6e67 2c20 646f 2061  f shifting, do a
-0000bc30: 2069 6e74 6572 706f 6c61 7469 6f6e 2d2d   interpolation--
-0000bc40: 2d2d 2d2d 0a20 2020 2066 6f72 2069 6920  ----.    for ii 
-0000bc50: 696e 2072 616e 6765 286e 7074 7329 3a0a  in range(npts):.
-0000bc60: 2020 2020 2020 2020 2320 2d2d 2d2d 6465          # ----de
-0000bc70: 616c 2077 6974 6820 6564 6765 732d 2d2d  al with edges---
-0000bc80: 2d2d 0a20 2020 2020 2020 2069 6620 6969  --.        if ii
-0000bc90: 203d 3d20 3020 6f72 2069 6920 3d3d 206e   == 0 or ii == n
-0000bca0: 7074 7320 2d20 313a 0a20 2020 2020 2020  pts - 1:.       
-0000bcb0: 2020 2020 2073 6967 325b 6969 5d20 3d20       sig2[ii] = 
-0000bcc0: 7369 6731 5b69 695d 0a20 2020 2020 2020  sig1[ii].       
-0000bcd0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000bce0: 2020 2023 202d 2d2d 2d2d 2d69 6e74 6572     # ------inter
-0000bcf0: 706f 6c61 7465 2075 7369 6e67 2061 2068  polate using a h
-0000bd00: 6174 2066 756e 6374 696f 6e2d 2d2d 2d2d  at function-----
-0000bd10: 2d0a 2020 2020 2020 2020 2020 2020 7369  -.            si
-0000bd20: 6732 5b69 695d 203d 2028 3120 2d20 6e66  g2[ii] = (1 - nf
-0000bd30: 7269 6329 202a 2073 6967 315b 6969 202b  ric) * sig1[ii +
-0000bd40: 2031 5d20 2b20 6e66 7269 6320 2a20 7369   1] + nfric * si
-0000bd50: 6731 5b69 695d 0a0a 2020 2020 7265 7475  g1[ii]..    retu
-0000bd60: 726e 2073 6967 320a 0a0a 6465 6620 7265  rn sig2...def re
-0000bd70: 7370 5f73 7065 6374 7275 6d28 736f 7572  sp_spectrum(sour
-0000bd80: 6365 2c20 7265 7370 5f66 696c 652c 2064  ce, resp_file, d
-0000bd90: 6f77 6e73 616d 705f 6672 6571 2c20 7072  ownsamp_freq, pr
-0000bda0: 655f 6669 6c74 3d4e 6f6e 6529 3a0a 2020  e_filt=None):.  
-0000bdb0: 2020 2222 220a 2020 2020 7468 6973 2066    """.    this f
-0000bdc0: 756e 6374 696f 6e20 7265 6d6f 7665 7320  unction removes 
-0000bdd0: 7468 6520 696e 7374 7275 6d65 6e74 2072  the instrument r
-0000bde0: 6573 706f 6e73 6520 7573 696e 6720 7265  esponse using re
-0000bdf0: 7370 6f6e 7365 2073 7065 6374 7275 6d20  sponse spectrum 
-0000be00: 6672 6f6d 2065 7661 6c72 6573 702e 0a20  from evalresp.. 
-0000be10: 2020 2074 6865 2072 6573 706f 6e73 6520     the response 
-0000be20: 7370 6563 7472 756d 2069 7320 6576 616c  spectrum is eval
-0000be30: 7561 7465 6420 6261 7365 6420 6f6e 2052  uated based on R
-0000be40: 4553 502f 505a 2066 696c 6573 2062 6566  ESP/PZ files bef
-0000be50: 6f72 6520 696e 7665 7274 6564 2075 7369  ore inverted usi
-0000be60: 6e67 2074 6865 206f 6273 7079 0a20 2020  ng the obspy.   
-0000be70: 2066 756e 6374 696f 6e20 6f66 2069 6e76   function of inv
-0000be80: 6572 745f 7370 6563 7472 756d 2e20 6120  ert_spectrum. a 
-0000be90: 6d6f 6475 6c65 206f 6620 6372 6561 7465  module of create
-0000bea0: 5f72 6573 702e 7079 2069 7320 7072 6f76  _resp.py is prov
-0000beb0: 6964 6564 2069 6e20 6469 7265 6374 6f72  ided in director
-0000bec0: 7920 6f66 2027 6164 6469 7469 6f6e 616c  y of 'additional
-0000bed0: 5f6d 6f64 756c 6573 270a 2020 2020 746f  _modules'.    to
-0000bee0: 2063 7265 6174 6520 7468 6520 7265 7370   create the resp
-0000bef0: 6f6e 7365 2073 7065 6374 7275 6d0a 2020  onse spectrum.  
-0000bf00: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
-0000bf10: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-0000bf20: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073 6f75  --------.    sou
-0000bf30: 7263 653a 206f 6273 7079 2073 7472 6561  rce: obspy strea
-0000bf40: 6d20 6f62 6a65 6374 206f 6620 7461 7267  m object of targ
-0000bf50: 6574 6564 206e 6f69 7365 2064 6174 610a  eted noise data.
-0000bf60: 2020 2020 7265 7370 5f66 696c 653a 206e      resp_file: n
-0000bf70: 756d 7079 2064 6174 6120 6669 6c65 206f  umpy data file o
-0000bf80: 6620 7265 7370 6f6e 7365 2073 7065 6374  f response spect
-0000bf90: 7275 6d0a 2020 2020 646f 776e 7361 6d70  rum.    downsamp
-0000bfa0: 5f66 7265 713a 2073 616d 706c 696e 6720  _freq: sampling 
-0000bfb0: 7261 7465 206f 6620 7468 6520 736f 7572  rate of the sour
-0000bfc0: 6365 2064 6174 610a 2020 2020 7072 655f  ce data.    pre_
-0000bfd0: 6669 6c74 3a20 7072 652d 6465 6669 6e65  filt: pre-define
-0000bfe0: 6420 6669 6c74 6572 2070 6172 616d 6574  d filter paramet
-0000bff0: 6572 730a 2020 2020 5245 5455 524e 533a  ers.    RETURNS:
-0000c000: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000c010: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000c020: 736f 7572 6365 3a20 6f62 7370 7920 7374  source: obspy st
-0000c030: 7265 616d 206f 626a 6563 7420 6f66 206e  ream object of n
-0000c040: 6f69 7365 2064 6174 6120 7769 7468 2069  oise data with i
-0000c050: 6e73 7472 756d 656e 7420 7265 7370 6f6e  nstrument respon
-0000c060: 7365 2072 656d 6f76 6564 0a20 2020 2022  se removed.    "
-0000c070: 2222 0a20 2020 2023 202d 2d2d 2d2d 2d2d  "".    # -------
-0000c080: 2d72 6573 705f 6669 6c65 2069 7320 7468  -resp_file is th
-0000c090: 6520 696e 7665 7274 6564 2073 7065 6374  e inverted spect
-0000c0a0: 7275 6d20 7265 7370 6f6e 7365 2d2d 2d2d  rum response----
-0000c0b0: 2d2d 2d2d 2d0a 2020 2020 7265 7370 7a20  -----.    respz 
-0000c0c0: 3d20 6e70 2e6c 6f61 6428 7265 7370 5f66  = np.load(resp_f
-0000c0d0: 696c 6529 0a20 2020 206e 7265 7370 7a20  ile).    nrespz 
-0000c0e0: 3d20 7265 7370 7a5b 315d 5b3a 5d0a 2020  = respz[1][:].  
-0000c0f0: 2020 7370 6563 5f66 7265 7120 3d20 6d61    spec_freq = ma
-0000c100: 7828 7265 7370 7a5b 305d 290a 0a20 2020  x(respz[0])..   
-0000c110: 2023 202d 2d2d 2d2d 2d2d 6f6e 2063 7572   # -------on cur
-0000c120: 7265 6e74 2074 7261 6365 2d2d 2d2d 2d2d  rent trace------
-0000c130: 2d2d 2d2d 0a20 2020 206e 6666 7420 3d20  ----.    nfft = 
-0000c140: 5f6e 7074 7332 6e66 6674 2873 6f75 7263  _npts2nfft(sourc
-0000c150: 655b 305d 2e73 7461 7473 2e6e 7074 7329  e[0].stats.npts)
-0000c160: 0a20 2020 2073 7073 203d 2069 6e74 2873  .    sps = int(s
-0000c170: 6f75 7263 655b 305d 2e73 7461 7473 2e73  ource[0].stats.s
-0000c180: 616d 706c 696e 675f 7261 7465 290a 0a20  ampling_rate).. 
-0000c190: 2020 2023 202d 2d2d 2d2d 2d2d 2d2d 646f     # ---------do
-0000c1a0: 2074 6865 2069 6e74 6572 706f 6c61 7469   the interpolati
-0000c1b0: 6f6e 2069 6620 6e65 6564 6564 2d2d 2d2d  on if needed----
-0000c1c0: 2d2d 2d2d 0a20 2020 2069 6620 7370 6563  ----.    if spec
-0000c1d0: 5f66 7265 7120 3c20 302e 3520 2a20 7370  _freq < 0.5 * sp
-0000c1e0: 733a 0a20 2020 2020 2020 2072 6169 7365  s:.        raise
-0000c1f0: 2056 616c 7565 4572 726f 7228 2273 7065   ValueError("spe
-0000c200: 6374 7275 6d20 6669 6c65 2068 6173 2070  ctrum file has p
-0000c210: 6561 6b20 6672 6571 2073 6d61 6c6c 6572  eak freq smaller
-0000c220: 2074 6861 6e20 7468 6520 6461 7461 2c20   than the data, 
-0000c230: 6162 6f72 7421 2229 0a20 2020 2065 6c73  abort!").    els
-0000c240: 653a 0a20 2020 2020 2020 2069 6e64 7820  e:.        indx 
-0000c250: 3d20 6e70 2e77 6865 7265 2872 6573 707a  = np.where(respz
-0000c260: 5b30 5d20 3c3d 2030 2e35 202a 2073 7073  [0] <= 0.5 * sps
-0000c270: 290a 2020 2020 2020 2020 6e66 7265 7120  ).        nfreq 
-0000c280: 3d20 6e70 2e6c 696e 7370 6163 6528 302c  = np.linspace(0,
-0000c290: 2030 2e35 202a 2073 7073 2c20 6e66 6674   0.5 * sps, nfft
-0000c2a0: 202f 2f20 3220 2b20 3129 0a20 2020 2020   // 2 + 1).     
-0000c2b0: 2020 206e 7265 7370 7a20 3d20 6e70 2e69     nrespz = np.i
-0000c2c0: 6e74 6572 7028 6e66 7265 712c 206e 702e  nterp(nfreq, np.
-0000c2d0: 7265 616c 2872 6573 707a 5b30 5d5b 696e  real(respz[0][in
-0000c2e0: 6478 5d29 2c20 7265 7370 7a5b 315d 5b69  dx]), respz[1][i
-0000c2f0: 6e64 785d 290a 0a20 2020 2023 202d 2d2d  ndx])..    # ---
-0000c300: 2d64 6f20 696e 7465 7270 6f6c 6174 696f  -do interpolatio
-0000c310: 6e20 6966 206e 6563 6573 7361 7279 2d2d  n if necessary--
-0000c320: 2d2d 2d0a 2020 2020 736f 7572 6365 5f73  ---.    source_s
-0000c330: 7065 6374 203d 206e 702e 6666 742e 7266  pect = np.fft.rf
-0000c340: 6674 2873 6f75 7263 655b 305d 2e64 6174  ft(source[0].dat
-0000c350: 612c 206e 3d6e 6666 7429 0a0a 2020 2020  a, n=nfft)..    
-0000c360: 2320 2d2d 2d2d 2d6e 7265 7370 7a20 6973  # -----nrespz is
-0000c370: 2069 6e76 6572 7365 6420 2877 6174 6572   inversed (water
-0000c380: 2d6c 6576 656c 6564 2920 7370 6563 7472  -leveled) spectr
-0000c390: 756d 2d2d 2d2d 2d0a 2020 2020 736f 7572  um-----.    sour
-0000c3a0: 6365 5f73 7065 6374 202a 3d20 6e72 6573  ce_spect *= nres
-0000c3b0: 707a 0a20 2020 2073 6f75 7263 655b 305d  pz.    source[0]
-0000c3c0: 2e64 6174 6120 3d20 6e70 2e66 6674 2e69  .data = np.fft.i
-0000c3d0: 7266 6674 2873 6f75 7263 655f 7370 6563  rfft(source_spec
-0000c3e0: 7429 5b30 203a 2073 6f75 7263 655b 305d  t)[0 : source[0]
-0000c3f0: 2e73 7461 7473 2e6e 7074 735d 0a0a 2020  .stats.npts]..  
-0000c400: 2020 6966 2070 7265 5f66 696c 7420 6973    if pre_filt is
-0000c410: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000c420: 2020 2073 6f75 7263 655b 305d 2e64 6174     source[0].dat
-0000c430: 6120 3d20 6e70 2e66 6c6f 6174 3332 280a  a = np.float32(.
-0000c440: 2020 2020 2020 2020 2020 2020 6261 6e64              band
-0000c450: 7061 7373 280a 2020 2020 2020 2020 2020  pass(.          
-0000c460: 2020 2020 2020 736f 7572 6365 5b30 5d2e        source[0].
-0000c470: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
-0000c480: 2020 2020 2020 7072 655f 6669 6c74 5b30        pre_filt[0
-0000c490: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000c4a0: 2020 2070 7265 5f66 696c 745b 2d31 5d2c     pre_filt[-1],
-0000c4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c4c0: 2064 663d 7370 732c 0a20 2020 2020 2020   df=sps,.       
-0000c4d0: 2020 2020 2020 2020 2063 6f72 6e65 7273           corners
-0000c4e0: 3d34 2c0a 2020 2020 2020 2020 2020 2020  =4,.            
-0000c4f0: 2020 2020 7a65 726f 7068 6173 653d 5472      zerophase=Tr
-0000c500: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0000c510: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
-0000c520: 2072 6574 7572 6e20 736f 7572 6365 0a0a   return source..
-0000c530: 0a64 6566 206d 6164 2861 7272 293a 0a20  .def mad(arr):. 
-0000c540: 2020 2022 2222 0a20 2020 204d 6564 6961     """.    Media
-0000c550: 6e20 4162 736f 6c75 7465 2044 6576 6961  n Absolute Devia
-0000c560: 7469 6f6e 3a20 4d41 4420 3d20 6d65 6469  tion: MAD = medi
-0000c570: 616e 287c 5869 2d20 6d65 6469 616e 2858  an(|Xi- median(X
-0000c580: 297c 290a 2020 2020 5041 5241 4d45 5445  )|).    PARAMETE
-0000c590: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
-0000c5a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000c5b0: 6172 723a 206e 756d 7079 2e6e 6461 7272  arr: numpy.ndarr
-0000c5c0: 6179 2c20 7365 6973 6d69 6320 7472 6163  ay, seismic trac
-0000c5d0: 6520 6461 7461 2061 7272 6179 0a20 2020  e data array.   
-0000c5e0: 2052 4554 5552 4e53 3a0a 2020 2020 6461   RETURNS:.    da
-0000c5f0: 7461 3a20 4d65 6469 616e 2041 6273 6f6c  ta: Median Absol
-0000c600: 7574 6520 4465 7669 6174 696f 6e20 6f66  ute Deviation of
-0000c610: 2064 6174 610a 2020 2020 2222 220a 2020   data.    """.  
-0000c620: 2020 6966 206e 6f74 206e 702e 6d61 2e69    if not np.ma.i
-0000c630: 735f 6d61 736b 6564 2861 7272 293a 0a20  s_masked(arr):. 
-0000c640: 2020 2020 2020 206d 6564 203d 206e 702e         med = np.
-0000c650: 6d65 6469 616e 2861 7272 290a 2020 2020  median(arr).    
-0000c660: 2020 2020 6461 7461 203d 206e 702e 6d65      data = np.me
-0000c670: 6469 616e 286e 702e 6162 7328 6172 7220  dian(np.abs(arr 
-0000c680: 2d20 6d65 6429 290a 2020 2020 656c 7365  - med)).    else
-0000c690: 3a0a 2020 2020 2020 2020 6d65 6420 3d20  :.        med = 
-0000c6a0: 6e70 2e6d 612e 6d65 6469 616e 2861 7272  np.ma.median(arr
-0000c6b0: 290a 2020 2020 2020 2020 6461 7461 203d  ).        data =
-0000c6c0: 206e 702e 6d61 2e6d 6564 6961 6e28 6e70   np.ma.median(np
-0000c6d0: 2e6d 612e 6162 7328 6172 7220 2d20 6d65  .ma.abs(arr - me
-0000c6e0: 6429 290a 2020 2020 7265 7475 726e 2064  d)).    return d
-0000c6f0: 6174 610a 0a0a 6465 6620 6465 7472 656e  ata...def detren
-0000c700: 6428 6461 7461 293a 0a20 2020 2022 2222  d(data):.    """
-0000c710: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
-0000c720: 6f6e 2072 656d 6f76 6573 2074 6865 2073  on removes the s
-0000c730: 6967 6e61 6c20 7472 656e 6420 6261 7365  ignal trend base
-0000c740: 6420 6f6e 2051 5220 6465 636f 6d70 6f73  d on QR decompos
-0000c750: 696f 6e0a 2020 2020 4e4f 5445 3a20 5152  ion.    NOTE: QR
-0000c760: 2069 7320 6120 6c6f 7420 6661 7374 6572   is a lot faster
-0000c770: 2074 6861 6e20 7468 6520 6c65 6173 7420   than the least 
-0000c780: 7371 7561 7265 2069 6e76 6572 7369 6f6e  square inversion
-0000c790: 2075 7365 6420 6279 0a20 2020 2073 6369   used by.    sci
-0000c7a0: 7079 2028 616c 736f 2069 6e20 6f62 7370  py (also in obsp
-0000c7b0: 7929 2e0a 2020 2020 5041 5241 4d45 5445  y)..    PARAMETE
-0000c7c0: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
-0000c7d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0000c7e0: 2020 6461 7461 3a20 696e 7075 7420 6461    data: input da
-0000c7f0: 7461 206d 6174 7269 780a 2020 2020 5245  ta matrix.    RE
-0000c800: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
-0000c810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000c820: 0a20 2020 2064 6174 613a 2064 6174 6120  .    data: data 
-0000c830: 6d61 7472 6978 2077 6974 6820 7472 656e  matrix with tren
-0000c840: 6420 7265 6d6f 7665 640a 2020 2020 2222  d removed.    ""
-0000c850: 220a 2020 2020 2320 6e64 6174 6120 3d20  ".    # ndata = 
-0000c860: 6e70 2e7a 6572 6f73 2873 6861 7065 3d64  np.zeros(shape=d
-0000c870: 6174 612e 7368 6170 652c 6474 7970 653d  ata.shape,dtype=
-0000c880: 6461 7461 2e64 7479 7065 290a 2020 2020  data.dtype).    
-0000c890: 6966 2064 6174 612e 6e64 696d 203d 3d20  if data.ndim == 
-0000c8a0: 313a 0a20 2020 2020 2020 206e 7074 7320  1:.        npts 
-0000c8b0: 3d20 6461 7461 2e73 6861 7065 5b30 5d0a  = data.shape[0].
-0000c8c0: 2020 2020 2020 2020 5820 3d20 6e70 2e6f          X = np.o
-0000c8d0: 6e65 7328 286e 7074 732c 2032 2929 0a20  nes((npts, 2)). 
-0000c8e0: 2020 2020 2020 2058 5b3a 2c20 305d 203d         X[:, 0] =
-0000c8f0: 206e 702e 6172 616e 6765 2830 2c20 6e70   np.arange(0, np
-0000c900: 7473 2920 2f20 6e70 7473 0a20 2020 2020  ts) / npts.     
-0000c910: 2020 2051 2c20 5220 3d20 6e70 2e6c 696e     Q, R = np.lin
-0000c920: 616c 672e 7172 2858 290a 2020 2020 2020  alg.qr(X).      
-0000c930: 2020 7271 203d 206e 702e 646f 7428 6e70    rq = np.dot(np
-0000c940: 2e6c 696e 616c 672e 696e 7628 5229 2c20  .linalg.inv(R), 
-0000c950: 512e 7472 616e 7370 6f73 6528 2929 0a20  Q.transpose()). 
-0000c960: 2020 2020 2020 2063 6f65 6666 203d 206e         coeff = n
-0000c970: 702e 646f 7428 7271 2c20 6461 7461 290a  p.dot(rq, data).
-0000c980: 2020 2020 2020 2020 6461 7461 203d 2064          data = d
-0000c990: 6174 6120 2d20 6e70 2e64 6f74 2858 2c20  ata - np.dot(X, 
-0000c9a0: 636f 6566 6629 0a20 2020 2065 6c69 6620  coeff).    elif 
-0000c9b0: 6461 7461 2e6e 6469 6d20 3d3d 2032 3a0a  data.ndim == 2:.
-0000c9c0: 2020 2020 2020 2020 6e70 7473 203d 2064          npts = d
-0000c9d0: 6174 612e 7368 6170 655b 315d 0a20 2020  ata.shape[1].   
-0000c9e0: 2020 2020 2058 203d 206e 702e 6f6e 6573       X = np.ones
-0000c9f0: 2828 6e70 7473 2c20 3229 290a 2020 2020  ((npts, 2)).    
-0000ca00: 2020 2020 585b 3a2c 2030 5d20 3d20 6e70      X[:, 0] = np
-0000ca10: 2e61 7261 6e67 6528 302c 206e 7074 7329  .arange(0, npts)
-0000ca20: 202f 206e 7074 730a 2020 2020 2020 2020   / npts.        
-0000ca30: 512c 2052 203d 206e 702e 6c69 6e61 6c67  Q, R = np.linalg
-0000ca40: 2e71 7228 5829 0a20 2020 2020 2020 2072  .qr(X).        r
-0000ca50: 7120 3d20 6e70 2e64 6f74 286e 702e 6c69  q = np.dot(np.li
-0000ca60: 6e61 6c67 2e69 6e76 2852 292c 2051 2e74  nalg.inv(R), Q.t
-0000ca70: 7261 6e73 706f 7365 2829 290a 2020 2020  ranspose()).    
-0000ca80: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-0000ca90: 6e67 6528 6461 7461 2e73 6861 7065 5b30  nge(data.shape[0
-0000caa0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0000cab0: 636f 6566 6620 3d20 6e70 2e64 6f74 2872  coeff = np.dot(r
-0000cac0: 712c 2064 6174 615b 6969 5d29 0a20 2020  q, data[ii]).   
-0000cad0: 2020 2020 2020 2020 2064 6174 615b 6969           data[ii
-0000cae0: 5d20 3d20 6461 7461 5b69 695d 202d 206e  ] = data[ii] - n
-0000caf0: 702e 646f 7428 582c 2063 6f65 6666 290a  p.dot(X, coeff).
-0000cb00: 2020 2020 7265 7475 726e 2064 6174 610a      return data.
-0000cb10: 0a0a 6465 6620 6465 6d65 616e 2864 6174  ..def demean(dat
-0000cb20: 6129 3a0a 2020 2020 2222 220a 2020 2020  a):.    """.    
-0000cb30: 7468 6973 2066 756e 6374 696f 6e20 7265  this function re
-0000cb40: 6d6f 7665 2074 6865 206d 6561 6e20 6f66  move the mean of
-0000cb50: 2074 6865 2073 6967 6e61 6c0a 2020 2020   the signal.    
-0000cb60: 5041 5241 4d45 5445 5253 3a0a 2020 2020  PARAMETERS:.    
-0000cb70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000cb80: 2d2d 2d2d 2d0a 2020 2020 6461 7461 3a20  -----.    data: 
-0000cb90: 696e 7075 7420 6461 7461 206d 6174 7269  input data matri
-0000cba0: 780a 2020 2020 5245 5455 524e 533a 0a20  x.    RETURNS:. 
-0000cbb0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-0000cbc0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064 6174  --------.    dat
-0000cbd0: 613a 2064 6174 6120 6d61 7472 6978 2077  a: data matrix w
-0000cbe0: 6974 6820 6d65 616e 2072 656d 6f76 6564  ith mean removed
-0000cbf0: 0a20 2020 2022 2222 0a20 2020 2023 206e  .    """.    # n
-0000cc00: 6461 7461 203d 206e 702e 7a65 726f 7328  data = np.zeros(
-0000cc10: 7368 6170 653d 6461 7461 2e73 6861 7065  shape=data.shape
-0000cc20: 2c64 7479 7065 3d64 6174 612e 6474 7970  ,dtype=data.dtyp
-0000cc30: 6529 0a20 2020 2069 6620 6461 7461 2e6e  e).    if data.n
-0000cc40: 6469 6d20 3d3d 2031 3a0a 2020 2020 2020  dim == 1:.      
-0000cc50: 2020 6461 7461 203d 2064 6174 6120 2d20    data = data - 
-0000cc60: 6e70 2e6d 6561 6e28 6461 7461 290a 2020  np.mean(data).  
-0000cc70: 2020 656c 6966 2064 6174 612e 6e64 696d    elif data.ndim
-0000cc80: 203d 3d20 323a 0a20 2020 2020 2020 2066   == 2:.        f
-0000cc90: 6f72 2069 6920 696e 2072 616e 6765 2864  or ii in range(d
-0000cca0: 6174 612e 7368 6170 655b 305d 293a 0a20  ata.shape[0]):. 
-0000ccb0: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-0000ccc0: 6969 5d20 3d20 6461 7461 5b69 695d 202d  ii] = data[ii] -
-0000ccd0: 206e 702e 6d65 616e 2864 6174 615b 6969   np.mean(data[ii
-0000cce0: 5d29 0a20 2020 2072 6574 7572 6e20 6461  ]).    return da
-0000ccf0: 7461 0a0a 0a64 6566 2074 6170 6572 2864  ta...def taper(d
-0000cd00: 6174 6129 3a0a 2020 2020 2222 220a 2020  ata):.    """.  
-0000cd10: 2020 7468 6973 2066 756e 6374 696f 6e20    this function 
-0000cd20: 6170 706c 6965 7320 6120 636f 7369 6e65  applies a cosine
-0000cd30: 2074 6170 6572 2075 7369 6e67 206f 6273   taper using obs
-0000cd40: 7079 2066 756e 6374 696f 6e73 0a20 2020  py functions.   
-0000cd50: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
-0000cd60: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000cd70: 2d2d 2d2d 2d2d 0a20 2020 2064 6174 613a  ------.    data:
-0000cd80: 2069 6e70 7574 2064 6174 6120 6d61 7472   input data matr
-0000cd90: 6978 0a20 2020 2052 4554 5552 4e53 3a0a  ix.    RETURNS:.
-0000cda0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-0000cdb0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6461  ---------.    da
-0000cdc0: 7461 3a20 6461 7461 206d 6174 7269 7820  ta: data matrix 
-0000cdd0: 7769 7468 2074 6170 6572 2061 7070 6c69  with taper appli
-0000cde0: 6564 0a20 2020 2022 2222 0a20 2020 2023  ed.    """.    #
-0000cdf0: 206e 6461 7461 203d 206e 702e 7a65 726f   ndata = np.zero
-0000ce00: 7328 7368 6170 653d 6461 7461 2e73 6861  s(shape=data.sha
-0000ce10: 7065 2c64 7479 7065 3d64 6174 612e 6474  pe,dtype=data.dt
-0000ce20: 7970 6529 0a20 2020 2069 6620 6461 7461  ype).    if data
-0000ce30: 2e6e 6469 6d20 3d3d 2031 3a0a 2020 2020  .ndim == 1:.    
-0000ce40: 2020 2020 6e70 7473 203d 2064 6174 612e      npts = data.
-0000ce50: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-0000ce60: 2023 2077 696e 646f 7720 6c65 6e67 7468   # window length
-0000ce70: 0a20 2020 2020 2020 2069 6620 6e70 7473  .        if npts
-0000ce80: 202a 2030 2e30 3520 3e20 3230 3a0a 2020   * 0.05 > 20:.  
-0000ce90: 2020 2020 2020 2020 2020 776c 656e 203d            wlen =
-0000cea0: 2032 300a 2020 2020 2020 2020 656c 7365   20.        else
-0000ceb0: 3a0a 2020 2020 2020 2020 2020 2020 776c  :.            wl
-0000cec0: 656e 203d 206e 7074 7320 2a20 302e 3035  en = npts * 0.05
-0000ced0: 0a20 2020 2020 2020 2023 2074 6170 6572  .        # taper
-0000cee0: 2076 616c 7565 730a 2020 2020 2020 2020   values.        
-0000cef0: 6675 6e63 203d 205f 6765 745f 6675 6e63  func = _get_func
-0000cf00: 7469 6f6e 5f66 726f 6d5f 656e 7472 795f  tion_from_entry_
-0000cf10: 706f 696e 7428 2274 6170 6572 222c 2022  point("taper", "
-0000cf20: 6861 6e6e 2229 0a20 2020 2020 2020 2069  hann").        i
-0000cf30: 6620 3220 2a20 776c 656e 203d 3d20 6e70  f 2 * wlen == np
-0000cf40: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0000cf50: 7461 7065 725f 7369 6465 7320 3d20 6675  taper_sides = fu
-0000cf60: 6e63 2832 202a 2077 6c65 6e29 0a20 2020  nc(2 * wlen).   
-0000cf70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000cf80: 2020 2020 2020 2074 6170 6572 5f73 6964         taper_sid
-0000cf90: 6573 203d 2066 756e 6328 3220 2a20 776c  es = func(2 * wl
-0000cfa0: 656e 202b 2031 290a 2020 2020 2020 2020  en + 1).        
-0000cfb0: 2320 7461 7065 7220 7769 6e64 6f77 0a20  # taper window. 
-0000cfc0: 2020 2020 2020 2077 696e 203d 206e 702e         win = np.
-0000cfd0: 6873 7461 636b 280a 2020 2020 2020 2020  hstack(.        
-0000cfe0: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
-0000cff0: 2020 2020 2020 7461 7065 725f 7369 6465        taper_side
-0000d000: 735b 3a77 6c65 6e5d 2c0a 2020 2020 2020  s[:wlen],.      
-0000d010: 2020 2020 2020 2020 2020 6e70 2e6f 6e65            np.one
-0000d020: 7328 6e70 7473 202d 2032 202a 2077 6c65  s(npts - 2 * wle
-0000d030: 6e29 2c0a 2020 2020 2020 2020 2020 2020  n),.            
-0000d040: 2020 2020 7461 7065 725f 7369 6465 735b      taper_sides[
-0000d050: 6c65 6e28 7461 7065 725f 7369 6465 7329  len(taper_sides)
-0000d060: 202d 2077 6c65 6e20 3a5d 2c0a 2020 2020   - wlen :],.    
-0000d070: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0000d080: 2020 290a 2020 2020 2020 2020 6461 7461    ).        data
-0000d090: 202a 3d20 7769 6e0a 2020 2020 656c 6966   *= win.    elif
-0000d0a0: 2064 6174 612e 6e64 696d 203d 3d20 323a   data.ndim == 2:
-0000d0b0: 0a20 2020 2020 2020 206e 7074 7320 3d20  .        npts = 
-0000d0c0: 6461 7461 2e73 6861 7065 5b31 5d0a 2020  data.shape[1].  
-0000d0d0: 2020 2020 2020 2320 7769 6e64 6f77 206c        # window l
-0000d0e0: 656e 6774 680a 2020 2020 2020 2020 6966  ength.        if
-0000d0f0: 206e 7074 7320 2a20 302e 3035 203e 2032   npts * 0.05 > 2
-0000d100: 303a 0a20 2020 2020 2020 2020 2020 2077  0:.            w
-0000d110: 6c65 6e20 3d20 3230 0a20 2020 2020 2020  len = 20.       
-0000d120: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000d130: 2020 2077 6c65 6e20 3d20 6e70 7473 202a     wlen = npts *
-0000d140: 2030 2e30 350a 2020 2020 2020 2020 2320   0.05.        # 
-0000d150: 7461 7065 7220 7661 6c75 6573 0a20 2020  taper values.   
-0000d160: 2020 2020 2066 756e 6320 3d20 5f67 6574       func = _get
-0000d170: 5f66 756e 6374 696f 6e5f 6672 6f6d 5f65  _function_from_e
-0000d180: 6e74 7279 5f70 6f69 6e74 2822 7461 7065  ntry_point("tape
-0000d190: 7222 2c20 2268 616e 6e22 290a 2020 2020  r", "hann").    
-0000d1a0: 2020 2020 6966 2032 202a 2077 6c65 6e20      if 2 * wlen 
-0000d1b0: 3d3d 206e 7074 733a 0a20 2020 2020 2020  == npts:.       
-0000d1c0: 2020 2020 2074 6170 6572 5f73 6964 6573       taper_sides
-0000d1d0: 203d 2066 756e 6328 3220 2a20 776c 656e   = func(2 * wlen
-0000d1e0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0000d1f0: 2020 2020 2020 2020 2020 2020 7461 7065              tape
-0000d200: 725f 7369 6465 7320 3d20 6675 6e63 2832  r_sides = func(2
-0000d210: 202a 2077 6c65 6e20 2b20 3129 0a20 2020   * wlen + 1).   
-0000d220: 2020 2020 2023 2074 6170 6572 2077 696e       # taper win
-0000d230: 646f 770a 2020 2020 2020 2020 7769 6e20  dow.        win 
-0000d240: 3d20 6e70 2e68 7374 6163 6b28 0a20 2020  = np.hstack(.   
-0000d250: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-0000d260: 2020 2020 2020 2020 2020 2074 6170 6572             taper
-0000d270: 5f73 6964 6573 5b3a 776c 656e 5d2c 0a20  _sides[:wlen],. 
-0000d280: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000d290: 702e 6f6e 6573 286e 7074 7320 2d20 3220  p.ones(npts - 2 
-0000d2a0: 2a20 776c 656e 292c 0a20 2020 2020 2020  * wlen),.       
-0000d2b0: 2020 2020 2020 2020 2074 6170 6572 5f73           taper_s
-0000d2c0: 6964 6573 5b6c 656e 2874 6170 6572 5f73  ides[len(taper_s
-0000d2d0: 6964 6573 2920 2d20 776c 656e 203a 5d2c  ides) - wlen :],
-0000d2e0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0000d2f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000d300: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
-0000d310: 2864 6174 612e 7368 6170 655b 305d 293a  (data.shape[0]):
-0000d320: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0000d330: 615b 6969 5d20 2a3d 2077 696e 0a20 2020  a[ii] *= win.   
-0000d340: 2072 6574 7572 6e20 6461 7461 0a0a 0a23   return data...#
-0000d350: 2040 6a69 7428 6e6f 7079 7468 6f6e 203d   @jit(nopython =
-0000d360: 2054 7275 6529 0a0a 0a23 2063 6861 6e67   True)...# chang
-0000d370: 6520 7468 6520 6d6f 7669 6e67 2061 7665  e the moving ave
-0000d380: 7261 6765 2063 616c 6375 6c61 7469 6f6e  rage calculation
-0000d390: 2074 6f20 7461 6b65 2061 7320 696e 7075   to take as inpu
-0000d3a0: 7420 4e20 7468 6520 6675 6c6c 2077 696e  t N the full win
-0000d3b0: 646f 7720 6c65 6e67 7468 2074 6f20 736d  dow length to sm
-0000d3c0: 6f6f 7468 0a64 6566 206d 6f76 696e 675f  ooth.def moving_
-0000d3d0: 6176 6528 412c 204e 293a 0a20 2020 2022  ave(A, N):.    "
-0000d3e0: 2222 0a20 2020 2041 6c74 6572 6e61 7469  "".    Alternati
-0000d3f0: 7665 2066 756e 6374 696f 6e20 666f 7220  ve function for 
-0000d400: 6d6f 7669 6e67 2061 7665 7261 6765 2066  moving average f
-0000d410: 6f72 2061 6e20 6172 7261 792e 0a20 2020  or an array..   
-0000d420: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
-0000d430: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000d440: 2d2d 2d2d 2d2d 0a20 2020 2041 3a20 312d  ------.    A: 1-
-0000d450: 4420 6172 7261 7920 6f66 2064 6174 6120  D array of data 
-0000d460: 746f 2062 6520 736d 6f6f 7468 6564 0a20  to be smoothed. 
-0000d470: 2020 204e 3a20 696e 7465 6765 722c 2069     N: integer, i
-0000d480: 7420 6465 6669 6e65 7320 7468 6520 6675  t defines the fu
-0000d490: 6c6c 2121 2077 696e 646f 7720 6c65 6e67  ll!! window leng
-0000d4a0: 7468 2074 6f20 736d 6f6f 7468 0a20 2020  th to smooth.   
-0000d4b0: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
-0000d4c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d4d0: 2d2d 2d0a 2020 2020 423a 2031 2d44 2061  ---.    B: 1-D a
-0000d4e0: 7272 6179 2077 6974 6820 736d 6f6f 7468  rray with smooth
-0000d4f0: 6564 2064 6174 610a 2020 2020 2222 220a  ed data.    """.
-0000d500: 2020 2020 2320 6465 6669 6e65 7320 616e      # defines an
-0000d510: 2061 7272 6179 2077 6974 6820 4e20 6578   array with N ex
-0000d520: 7472 6120 7361 6d70 6c65 7320 6174 2065  tra samples at e
-0000d530: 6974 6865 7220 7369 6465 0a20 2020 2074  ither side.    t
-0000d540: 656d 7020 3d20 6e70 2e7a 6572 6f73 286c  emp = np.zeros(l
-0000d550: 656e 2841 2920 2b20 3220 2a20 4e29 0a20  en(A) + 2 * N). 
-0000d560: 2020 2023 2073 6574 2074 6865 2063 656e     # set the cen
-0000d570: 7472 616c 2070 6f72 7469 6f6e 206f 6620  tral portion of 
-0000d580: 7468 6520 6172 7261 7920 746f 2041 0a20  the array to A. 
-0000d590: 2020 2074 656d 705b 4e3a 2d4e 5d20 3d20     temp[N:-N] = 
-0000d5a0: 410a 2020 2020 2320 6c65 6164 696e 6720  A.    # leading 
-0000d5b0: 7361 6d70 6c65 733a 2065 7175 616c 2074  samples: equal t
-0000d5c0: 6f20 6669 7273 7420 7361 6d70 6c65 206f  o first sample o
-0000d5d0: 6620 6163 7475 616c 2061 7272 6179 0a20  f actual array. 
-0000d5e0: 2020 2074 656d 705b 303a 4e5d 203d 2074     temp[0:N] = t
-0000d5f0: 656d 705b 4e5d 0a20 2020 2023 2074 7261  emp[N].    # tra
-0000d600: 696c 696e 6720 7361 6d70 6c65 733a 2045  iling samples: E
-0000d610: 7175 616c 2074 6f20 6c61 7374 2073 616d  qual to last sam
-0000d620: 706c 6520 6f66 2061 6374 7561 6c20 6172  ple of actual ar
-0000d630: 7261 790a 2020 2020 7465 6d70 5b2d 4e3a  ray.    temp[-N:
-0000d640: 5d20 3d20 7465 6d70 5b2d 4e20 2d20 315d  ] = temp[-N - 1]
-0000d650: 0a20 2020 2023 2063 6f6e 766f 6c76 6520  .    # convolve 
-0000d660: 7769 7468 2061 2062 6f78 6361 7220 616e  with a boxcar an
-0000d670: 6420 6e6f 726d 616c 697a 652c 2061 6e64  d normalize, and
-0000d680: 2075 7365 206f 6e6c 7920 6365 6e74 7261   use only centra
-0000d690: 6c20 706f 7274 696f 6e20 6f66 2074 6865  l portion of the
-0000d6a0: 2072 6573 756c 740a 2020 2020 2320 7769   result.    # wi
-0000d6b0: 7468 206c 656e 6774 6820 6571 7561 6c20  th length equal 
-0000d6c0: 746f 2074 6865 206f 7269 6769 6e61 6c20  to the original 
-0000d6d0: 6172 7261 792c 2064 6973 6361 7264 696e  array, discardin
-0000d6e0: 6720 7468 6520 6164 6465 6420 6c65 6164  g the added lead
-0000d6f0: 696e 6720 616e 6420 7472 6169 6c69 6e67  ing and trailing
-0000d700: 2073 616d 706c 6573 0a20 2020 2042 203d   samples.    B =
-0000d710: 206e 702e 636f 6e76 6f6c 7665 2874 656d   np.convolve(tem
-0000d720: 702c 206e 702e 6f6e 6573 284e 2920 2f20  p, np.ones(N) / 
-0000d730: 4e2c 206d 6f64 653d 2273 616d 6522 295b  N, mode="same")[
-0000d740: 4e3a 2d4e 5d0a 2020 2020 7265 7475 726e  N:-N].    return
-0000d750: 2042 0a0a 0a23 2063 6861 6e67 6520 7468   B...# change th
-0000d760: 6520 6d6f 7669 6e67 2061 7665 7261 6765  e moving average
-0000d770: 2063 616c 6375 6c61 7469 6f6e 2074 6f20   calculation to 
-0000d780: 7461 6b65 2061 7320 696e 7075 7420 4e20  take as input N 
-0000d790: 7468 6520 6675 6c6c 2077 696e 646f 7720  the full window 
-0000d7a0: 6c65 6e67 7468 2074 6f20 736d 6f6f 7468  length to smooth
-0000d7b0: 0a64 6566 206d 6f76 696e 675f 6176 655f  .def moving_ave_
-0000d7c0: 3244 2841 2c20 4e29 3a0a 2020 2020 2222  2D(A, N):.    ""
-0000d7d0: 220a 2020 2020 416c 7465 726e 6174 6976  ".    Alternativ
-0000d7e0: 6520 6675 6e63 7469 6f6e 2066 6f72 206d  e function for m
-0000d7f0: 6f76 696e 6720 6176 6572 6167 6520 666f  oving average fo
-0000d800: 7220 616e 2061 7272 6179 2e0a 2020 2020  r an array..    
-0000d810: 5041 5241 4d45 5445 5253 3a0a 2020 2020  PARAMETERS:.    
-0000d820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d830: 2d2d 2d2d 2d0a 2020 2020 413a 2032 2d44  -----.    A: 2-D
-0000d840: 2061 7272 6179 206f 6620 6461 7461 2074   array of data t
-0000d850: 6f20 6265 2073 6d6f 6f74 6865 640a 2020  o be smoothed.  
-0000d860: 2020 4e3a 2069 6e74 6567 6572 2c20 6974    N: integer, it
-0000d870: 2064 6566 696e 6573 2074 6865 2066 756c   defines the ful
-0000d880: 6c21 2120 7769 6e64 6f77 206c 656e 6774  l!! window lengt
-0000d890: 6820 746f 2073 6d6f 6f74 680a 2020 2020  h to smooth.    
-0000d8a0: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
-0000d8b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000d8c0: 2d2d 0a20 2020 2042 3a20 322d 4420 6172  --.    B: 2-D ar
-0000d8d0: 7261 7920 7769 7468 2073 6d6f 6f74 6865  ray with smoothe
-0000d8e0: 6420 6461 7461 0a20 2020 2022 2222 0a20  d data.    """. 
-0000d8f0: 2020 206e 7463 2c20 6e73 7074 203d 2041     ntc, nspt = A
-0000d900: 2e73 6861 7065 0a20 2020 2023 2064 6566  .shape.    # def
-0000d910: 696e 6573 2061 6e20 6172 7261 7920 7769  ines an array wi
-0000d920: 7468 204e 2065 7874 7261 2073 616d 706c  th N extra sampl
-0000d930: 6573 2061 7420 6569 7468 6572 2073 6964  es at either sid
-0000d940: 650a 2020 2020 7465 6d70 203d 206e 702e  e.    temp = np.
-0000d950: 7a65 726f 7328 5b6e 7463 2c20 6e73 7074  zeros([ntc, nspt
-0000d960: 202b 2032 202a 204e 5d29 0a20 2020 2023   + 2 * N]).    #
-0000d970: 2073 6574 2074 6865 2063 656e 7472 616c   set the central
-0000d980: 2070 6f72 7469 6f6e 206f 6620 7468 6520   portion of the 
-0000d990: 6172 7261 7920 746f 2041 0a20 2020 2074  array to A.    t
-0000d9a0: 656d 705b 3a2c 204e 3a2d 4e5d 203d 2041  emp[:, N:-N] = A
-0000d9b0: 0a20 2020 2023 206c 6561 6469 6e67 2073  .    # leading s
-0000d9c0: 616d 706c 6573 3a20 6571 7561 6c20 746f  amples: equal to
-0000d9d0: 2066 6972 7374 2073 616d 706c 6520 6f66   first sample of
-0000d9e0: 2061 6374 7561 6c20 6172 7261 790a 2020   actual array.  
-0000d9f0: 2020 7465 6d70 5b3a 2c20 303a 4e5d 203d    temp[:, 0:N] =
-0000da00: 206e 702e 7265 7065 6174 286e 702e 6578   np.repeat(np.ex
-0000da10: 7061 6e64 5f64 696d 7328 7465 6d70 5b3a  pand_dims(temp[:
-0000da20: 2c20 4e5d 2c20 6178 6973 3d2d 3129 2c20  , N], axis=-1), 
-0000da30: 4e2c 2061 7869 733d 2d31 290a 2020 2020  N, axis=-1).    
-0000da40: 2320 7472 6169 6c69 6e67 2073 616d 706c  # trailing sampl
-0000da50: 6573 3a20 4571 7561 6c20 746f 206c 6173  es: Equal to las
-0000da60: 7420 7361 6d70 6c65 206f 6620 6163 7475  t sample of actu
-0000da70: 616c 2061 7272 6179 0a20 2020 2074 656d  al array.    tem
-0000da80: 705b 3a2c 202d 4e3a 5d20 3d20 6e70 2e72  p[:, -N:] = np.r
-0000da90: 6570 6561 7428 6e70 2e65 7870 616e 645f  epeat(np.expand_
-0000daa0: 6469 6d73 2874 656d 705b 3a2c 202d 4e20  dims(temp[:, -N 
-0000dab0: 2d20 315d 2c20 6178 6973 3d2d 3129 2c20  - 1], axis=-1), 
-0000dac0: 4e2c 2061 7869 733d 2d31 290a 2020 2020  N, axis=-1).    
-0000dad0: 2320 636f 6e76 6f6c 7665 2077 6974 6820  # convolve with 
-0000dae0: 6120 626f 7863 6172 2061 6e64 206e 6f72  a boxcar and nor
-0000daf0: 6d61 6c69 7a65 2c20 616e 6420 7573 6520  malize, and use 
-0000db00: 6f6e 6c79 2063 656e 7472 616c 2070 6f72  only central por
-0000db10: 7469 6f6e 206f 6620 7468 6520 7265 7375  tion of the resu
-0000db20: 6c74 0a20 2020 2023 2077 6974 6820 6c65  lt.    # with le
-0000db30: 6e67 7468 2065 7175 616c 2074 6f20 7468  ngth equal to th
-0000db40: 6520 6f72 6967 696e 616c 2061 7272 6179  e original array
-0000db50: 2c20 6469 7363 6172 6469 6e67 2074 6865  , discarding the
-0000db60: 2061 6464 6564 206c 6561 6469 6e67 2061   added leading a
-0000db70: 6e64 2074 7261 696c 696e 6720 7361 6d70  nd trailing samp
-0000db80: 6c65 730a 2020 2020 4220 3d20 7363 6970  les.    B = scip
-0000db90: 792e 7369 676e 616c 2e63 6f6e 766f 6c76  y.signal.convolv
-0000dba0: 6532 6428 7465 6d70 2c20 6e70 2e65 7870  e2d(temp, np.exp
-0000dbb0: 616e 645f 6469 6d73 286e 702e 6f6e 6573  and_dims(np.ones
-0000dbc0: 284e 2920 2f20 4e2c 2061 7869 733d 3029  (N) / N, axis=0)
-0000dbd0: 2c20 6d6f 6465 3d22 7361 6d65 2229 5b3a  , mode="same")[:
-0000dbe0: 2c20 4e3a 2d4e 5d0a 2020 2020 7265 7475  , N:-N].    retu
-0000dbf0: 726e 2042 0a0a 0a64 6566 2072 6f62 7573  rn B...def robus
-0000dc00: 745f 7374 6163 6b28 6363 5f61 7272 6179  t_stack(cc_array
-0000dc10: 2c20 6570 7369 6c6f 6e29 3a0a 2020 2020  , epsilon):.    
-0000dc20: 2222 220a 2020 2020 7468 6973 2069 7320  """.    this is 
-0000dc30: 6120 726f 6275 7374 2073 7461 636b 696e  a robust stackin
-0000dc40: 6720 616c 676f 7269 7468 6d20 6465 7363  g algorithm desc
-0000dc50: 7269 6265 6420 696e 2050 616c 7669 7320  ribed in Palvis 
-0000dc60: 616e 6420 5665 726e 6f6e 2032 3031 300a  and Vernon 2010.
-0000dc70: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-0000dc80: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000dc90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000dca0: 6363 5f61 7272 6179 3a20 6e75 6d70 792e  cc_array: numpy.
-0000dcb0: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
-0000dcc0: 2074 6865 2032 4420 6372 6f73 7320 636f   the 2D cross co
-0000dcd0: 7272 656c 6174 696f 6e20 6d61 7472 6978  rrelation matrix
-0000dce0: 0a20 2020 2065 7073 696c 6f6e 3a20 7265  .    epsilon: re
-0000dcf0: 7369 6475 616c 2074 6872 6568 6f6c 6420  sidual threhold 
-0000dd00: 746f 2071 7569 7420 7468 6520 6974 6572  to quit the iter
-0000dd10: 6174 696f 6e0a 2020 2020 5245 5455 524e  ation.    RETURN
-0000dd20: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-0000dd30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0000dd40: 2020 6e65 7773 7461 636b 3a20 6e75 6d70    newstack: nump
-0000dd50: 7920 7665 6374 6f72 2063 6f6e 7461 696e  y vector contain
-0000dd60: 7320 7468 6520 7374 6163 6b65 6420 6372  s the stacked cr
-0000dd70: 6f73 7320 636f 7272 656c 6174 696f 6e0a  oss correlation.
-0000dd80: 0a20 2020 2057 7269 7474 656e 2062 7920  .    Written by 
-0000dd90: 4d61 7269 6e65 2044 656e 6f6c 6c65 0a20  Marine Denolle. 
-0000dda0: 2020 2022 2222 0a20 2020 2072 6573 203d     """.    res =
-0000ddb0: 2039 6539 2020 2320 7265 7369 6475 616c   9e9  # residual
-0000ddc0: 730a 2020 2020 7720 3d20 6e70 2e6f 6e65  s.    w = np.one
-0000ddd0: 7328 6363 5f61 7272 6179 2e73 6861 7065  s(cc_array.shape
-0000dde0: 5b30 5d29 0a20 2020 206e 7374 6570 203d  [0]).    nstep =
-0000ddf0: 2030 0a20 2020 206e 6577 7374 6163 6b20   0.    newstack 
-0000de00: 3d20 6e70 2e6d 6564 6961 6e28 6363 5f61  = np.median(cc_a
-0000de10: 7272 6179 2c20 6178 6973 3d30 290a 2020  rray, axis=0).  
-0000de20: 2020 7768 696c 6520 7265 7320 3e20 6570    while res > ep
-0000de30: 7369 6c6f 6e3a 0a20 2020 2020 2020 2073  silon:.        s
-0000de40: 7461 636b 203d 206e 6577 7374 6163 6b0a  tack = newstack.
-0000de50: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-0000de60: 2072 616e 6765 2863 635f 6172 7261 792e   range(cc_array.
-0000de70: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
-0000de80: 2020 2020 2020 2063 7261 7020 3d20 6e70         crap = np
-0000de90: 2e6d 756c 7469 706c 7928 7374 6163 6b2c  .multiply(stack,
-0000dea0: 2063 635f 6172 7261 795b 692c 203a 5d2e   cc_array[i, :].
-0000deb0: 5429 0a20 2020 2020 2020 2020 2020 2063  T).            c
-0000dec0: 7261 705f 646f 7420 3d20 6e70 2e73 756d  rap_dot = np.sum
-0000ded0: 2863 7261 7029 0a20 2020 2020 2020 2020  (crap).         
-0000dee0: 2020 2064 695f 6e6f 726d 203d 206e 702e     di_norm = np.
-0000def0: 6c69 6e61 6c67 2e6e 6f72 6d28 6363 5f61  linalg.norm(cc_a
-0000df00: 7272 6179 5b69 2c20 3a5d 290a 2020 2020  rray[i, :]).    
-0000df10: 2020 2020 2020 2020 7269 203d 2063 635f          ri = cc_
-0000df20: 6172 7261 795b 692c 203a 5d20 2d20 6372  array[i, :] - cr
-0000df30: 6170 5f64 6f74 202a 2073 7461 636b 0a20  ap_dot * stack. 
-0000df40: 2020 2020 2020 2020 2020 2072 695f 6e6f             ri_no
-0000df50: 726d 203d 206e 702e 6c69 6e61 6c67 2e6e  rm = np.linalg.n
-0000df60: 6f72 6d28 7269 290a 2020 2020 2020 2020  orm(ri).        
-0000df70: 2020 2020 775b 695d 203d 206e 702e 6162      w[i] = np.ab
-0000df80: 7328 6372 6170 5f64 6f74 2920 2f20 6469  s(crap_dot) / di
-0000df90: 5f6e 6f72 6d20 2f20 7269 5f6e 6f72 6d20  _norm / ri_norm 
-0000dfa0: 2023 202f 6c65 6e28 6363 5f61 7272 6179   # /len(cc_array
-0000dfb0: 5b3a 2c31 5d29 0a20 2020 2020 2020 2023  [:,1]).        #
-0000dfc0: 2070 7269 6e74 2877 290a 2020 2020 2020   print(w).      
-0000dfd0: 2020 7720 3d20 7720 2f20 6e70 2e73 756d    w = w / np.sum
-0000dfe0: 2877 290a 2020 2020 2020 2020 6e65 7773  (w).        news
-0000dff0: 7461 636b 203d 206e 702e 7375 6d28 2877  tack = np.sum((w
-0000e000: 202a 2063 635f 6172 7261 792e 5429 2e54   * cc_array.T).T
-0000e010: 2c20 6178 6973 3d30 2920 2023 202f 6c65  , axis=0)  # /le
-0000e020: 6e28 6363 5f61 7272 6179 5b3a 2c31 5d29  n(cc_array[:,1])
-0000e030: 0a20 2020 2020 2020 2072 6573 203d 206e  .        res = n
-0000e040: 702e 6c69 6e61 6c67 2e6e 6f72 6d28 6e65  p.linalg.norm(ne
-0000e050: 7773 7461 636b 202d 2073 7461 636b 2c20  wstack - stack, 
-0000e060: 6f72 643d 3129 202f 206e 702e 6c69 6e61  ord=1) / np.lina
-0000e070: 6c67 2e6e 6f72 6d28 6e65 7773 7461 636b  lg.norm(newstack
-0000e080: 2920 2f20 6c65 6e28 6363 5f61 7272 6179  ) / len(cc_array
-0000e090: 5b3a 2c20 315d 290a 2020 2020 2020 2020  [:, 1]).        
-0000e0a0: 6e73 7465 7020 2b3d 2031 0a20 2020 2020  nstep += 1.     
-0000e0b0: 2020 2069 6620 6e73 7465 7020 3e20 3130     if nstep > 10
-0000e0c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000e0d0: 7475 726e 206e 6577 7374 6163 6b2c 2077  turn newstack, w
-0000e0e0: 2c20 6e73 7465 700a 2020 2020 7265 7475  , nstep.    retu
-0000e0f0: 726e 206e 6577 7374 6163 6b2c 2077 2c20  rn newstack, w, 
-0000e100: 6e73 7465 700a 0a0a 6465 6620 7365 6c65  nstep...def sele
-0000e110: 6374 6976 655f 7374 6163 6b28 6363 5f61  ctive_stack(cc_a
-0000e120: 7272 6179 2c20 6570 7369 6c6f 6e29 3a0a  rray, epsilon):.
-0000e130: 2020 2020 2222 220a 2020 2020 7468 6973      """.    this
-0000e140: 2069 7320 6120 7365 6c65 6374 6976 6520   is a selective 
-0000e150: 7374 6163 6b69 6e67 2061 6c67 6f72 6974  stacking algorit
-0000e160: 686d 2064 6576 656c 6f70 6564 2062 7920  hm developed by 
-0000e170: 4a61 7265 6420 4272 7961 6e2e 0a0a 2020  Jared Bryan...  
-0000e180: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
-0000e190: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-0000e1a0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 635f  --------.    cc_
-0000e1b0: 6172 7261 793a 206e 756d 7079 2e6e 6461  array: numpy.nda
-0000e1c0: 7272 6179 2063 6f6e 7461 696e 7320 7468  rray contains th
-0000e1d0: 6520 3244 2063 726f 7373 2063 6f72 7265  e 2D cross corre
-0000e1e0: 6c61 7469 6f6e 206d 6174 7269 780a 2020  lation matrix.  
-0000e1f0: 2020 6570 7369 6c6f 6e3a 2072 6573 6964    epsilon: resid
-0000e200: 7561 6c20 7468 7265 686f 6c64 2074 6f20  ual threhold to 
-0000e210: 7175 6974 2074 6865 2069 7465 7261 7469  quit the iterati
-0000e220: 6f6e 0a20 2020 2052 4554 5552 4e53 3a0a  on.    RETURNS:.
-0000e230: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
-0000e240: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 206e  ----------.    n
-0000e250: 6577 7374 6163 6b3a 206e 756d 7079 2076  ewstack: numpy v
-0000e260: 6563 746f 7220 636f 6e74 6169 6e73 2074  ector contains t
-0000e270: 6865 2073 7461 636b 6564 2063 726f 7373  he stacked cross
-0000e280: 2063 6f72 7265 6c61 7469 6f6e 0a0a 2020   correlation..  
-0000e290: 2020 5772 6974 7465 6e20 6279 204d 6172    Written by Mar
-0000e2a0: 696e 6520 4465 6e6f 6c6c 650a 2020 2020  ine Denolle.    
-0000e2b0: 2222 220a 2020 2020 6363 203d 206e 702e  """.    cc = np.
-0000e2c0: 6f6e 6573 2863 635f 6172 7261 792e 7368  ones(cc_array.sh
-0000e2d0: 6170 655b 305d 290a 2020 2020 6e65 7773  ape[0]).    news
-0000e2e0: 7461 636b 203d 206e 702e 6d65 616e 2863  tack = np.mean(c
-0000e2f0: 635f 6172 7261 792c 2061 7869 733d 3029  c_array, axis=0)
-0000e300: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
-0000e310: 6e67 6528 6363 5f61 7272 6179 2e73 6861  nge(cc_array.sha
-0000e320: 7065 5b30 5d29 3a0a 2020 2020 2020 2020  pe[0]):.        
-0000e330: 6363 5b69 5d20 3d20 6e70 2e73 756d 286e  cc[i] = np.sum(n
-0000e340: 702e 6d75 6c74 6970 6c79 286e 6577 7374  p.multiply(newst
-0000e350: 6163 6b2c 2063 635f 6172 7261 795b 692c  ack, cc_array[i,
-0000e360: 203a 5d2e 5429 290a 2020 2020 696b 203d   :].T)).    ik =
-0000e370: 206e 702e 7768 6572 6528 6363 203e 3d20   np.where(cc >= 
-0000e380: 6570 7369 6c6f 6e29 5b30 5d0a 2020 2020  epsilon)[0].    
-0000e390: 6e65 7773 7461 636b 203d 206e 702e 6d65  newstack = np.me
-0000e3a0: 616e 2863 635f 6172 7261 795b 696b 2c20  an(cc_array[ik, 
-0000e3b0: 3a5d 2c20 6178 6973 3d30 290a 0a20 2020  :], axis=0)..   
-0000e3c0: 2072 6574 7572 6e20 6e65 7773 7461 636b   return newstack
-0000e3d0: 2c20 6363 0a0a 0a64 6566 2077 6869 7465  , cc...def white
-0000e3e0: 6e5f 3144 2874 696d 6573 6572 6965 732c  n_1D(timeseries,
-0000e3f0: 2066 6674 5f70 6172 612c 206e 5f74 6170   fft_para, n_tap
-0000e400: 6572 293a 0a20 2020 2022 2222 0a20 2020  er):.    """.   
-0000e410: 2054 6869 7320 6675 6e63 7469 6f6e 2074   This function t
-0000e420: 616b 6573 2061 2031 2d64 696d 656e 7369  akes a 1-dimensi
-0000e430: 6f6e 616c 2074 696d 6573 6572 6965 7320  onal timeseries 
-0000e440: 6172 7261 792c 2074 7261 6e73 666f 726d  array, transform
-0000e450: 7320 746f 2066 7265 7175 656e 6379 2064  s to frequency d
-0000e460: 6f6d 6169 6e20 7573 696e 6720 6666 742c  omain using fft,
-0000e470: 0a20 2020 2077 6869 7465 6e73 2074 6865  .    whitens the
-0000e480: 2061 6d70 6c69 7475 6465 206f 6620 7468   amplitude of th
-0000e490: 6520 7370 6563 7472 756d 2069 6e20 6672  e spectrum in fr
-0000e4a0: 6571 7565 6e63 7920 646f 6d61 696e 2062  equency domain b
-0000e4b0: 6574 7765 656e 202a 6672 6571 6d69 6e2a  etween *freqmin*
-0000e4c0: 2061 6e64 202a 6672 6571 6d61 782a 0a20   and *freqmax*. 
-0000e4d0: 2020 2061 6e64 2072 6574 7572 6e73 2074     and returns t
-0000e4e0: 6865 2077 6869 7465 6e65 6420 6666 742e  he whitened fft.
-0000e4f0: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
-0000e500: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-0000e510: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0000e520: 6461 7461 3a20 6e75 6d70 792e 6e64 6172  data: numpy.ndar
-0000e530: 7261 7920 636f 6e74 6169 6e73 2074 6865  ray contains the
-0000e540: 2031 4420 7469 6d65 2073 6572 6965 7320   1D time series 
-0000e550: 746f 2077 6869 7465 6e0a 2020 2020 6666  to whiten.    ff
-0000e560: 745f 7061 7261 3a20 6469 6374 2063 6f6e  t_para: dict con
-0000e570: 7461 696e 696e 6720 616c 6c20 6666 745f  taining all fft_
-0000e580: 6363 2070 6172 616d 6574 6572 7320 7375  cc parameters su
-0000e590: 6368 2061 730a 2020 2020 2020 2020 6474  ch as.        dt
-0000e5a0: 3a20 5468 6520 7361 6d70 6c69 6e67 2073  : The sampling s
-0000e5b0: 7061 6365 206f 6620 7468 6520 6064 6174  pace of the `dat
-0000e5c0: 6160 0a20 2020 2020 2020 2066 7265 716d  a`.        freqm
-0000e5d0: 696e 3a20 5468 6520 6c6f 7765 7220 6672  in: The lower fr
-0000e5e0: 6571 7565 6e63 7920 626f 756e 640a 2020  equency bound.  
-0000e5f0: 2020 2020 2020 6672 6571 6d61 783a 2054        freqmax: T
-0000e600: 6865 2075 7070 6572 2066 7265 7175 656e  he upper frequen
-0000e610: 6379 2062 6f75 6e64 0a20 2020 2020 2020  cy bound.       
-0000e620: 2073 6d6f 6f74 685f 4e3a 2069 6e74 6567   smooth_N: integ
-0000e630: 6572 2c20 6974 2064 6566 696e 6573 2074  er, it defines t
-0000e640: 6865 2068 616c 6620 7769 6e64 6f77 206c  he half window l
-0000e650: 656e 6774 6820 746f 2073 6d6f 6f74 680a  ength to smooth.
-0000e660: 2020 2020 2020 2020 6e5f 7461 7065 722c          n_taper,
-0000e670: 206f 7074 696f 6e61 6c3a 2069 6e74 6567   optional: integ
-0000e680: 6572 2c20 6465 6669 6e65 2074 6865 2077  er, define the w
-0000e690: 6964 7468 206f 6620 7468 6520 7461 7065  idth of the tape
-0000e6a0: 7220 696e 2073 616d 706c 6573 0a20 2020  r in samples.   
-0000e6b0: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
-0000e6c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000e6d0: 2d2d 2d2d 0a20 2020 2046 4654 5261 7753  ----.    FFTRawS
-0000e6e0: 6967 6e3a 206e 756d 7079 2e6e 6461 7272  ign: numpy.ndarr
-0000e6f0: 6179 2063 6f6e 7461 696e 7320 7468 6520  ay contains the 
-0000e700: 4646 5420 6f66 2074 6865 2077 6869 7465  FFT of the white
-0000e710: 6e65 6420 696e 7075 7420 7472 6163 6520  ned input trace 
-0000e720: 6265 7477 6565 6e20 7468 6520 6672 6571  between the freq
-0000e730: 7565 6e63 7920 626f 756e 6473 0a20 2020  uency bounds.   
-0000e740: 2022 2222 0a20 2020 2023 206c 6f61 6420   """.    # load 
-0000e750: 7061 7261 6d65 7465 7273 0a20 2020 2064  parameters.    d
-0000e760: 656c 7461 203d 2066 6674 5f70 6172 615b  elta = fft_para[
-0000e770: 2264 7422 5d0a 2020 2020 6672 6571 6d69  "dt"].    freqmi
-0000e780: 6e20 3d20 6666 745f 7061 7261 5b22 6672  n = fft_para["fr
-0000e790: 6571 6d69 6e22 5d0a 2020 2020 6672 6571  eqmin"].    freq
-0000e7a0: 6d61 7820 3d20 6666 745f 7061 7261 5b22  max = fft_para["
-0000e7b0: 6672 6571 6d61 7822 5d0a 2020 2020 736d  freqmax"].    sm
-0000e7c0: 6f6f 7468 5f4e 203d 2066 6674 5f70 6172  ooth_N = fft_par
-0000e7d0: 615b 2273 6d6f 6f74 685f 4e22 5d0a 0a20  a["smooth_N"].. 
-0000e7e0: 2020 206e 6666 7420 3d20 6e65 7874 5f66     nfft = next_f
-0000e7f0: 6173 745f 6c65 6e28 6c65 6e28 7469 6d65  ast_len(len(time
-0000e800: 7365 7269 6573 2929 0a20 2020 2073 7065  series)).    spe
-0000e810: 6320 3d20 6e70 2e66 6674 2e66 6674 2874  c = np.fft.fft(t
-0000e820: 696d 6573 6572 6965 732c 206e 6666 7429  imeseries, nfft)
-0000e830: 0a20 2020 2066 7265 7120 3d20 6e70 2e66  .    freq = np.f
-0000e840: 6674 2e66 6674 6672 6571 286e 6666 742c  ft.fftfreq(nfft,
-0000e850: 2064 3d64 656c 7461 290a 0a20 2020 2069   d=delta)..    i
-0000e860: 7830 203d 206e 702e 6172 676d 696e 286e  x0 = np.argmin(n
-0000e870: 702e 6162 7328 6672 6571 202d 2066 7265  p.abs(freq - fre
-0000e880: 716d 696e 2929 0a20 2020 2069 7831 203d  qmin)).    ix1 =
-0000e890: 206e 702e 6172 676d 696e 286e 702e 6162   np.argmin(np.ab
-0000e8a0: 7328 6672 6571 202d 2066 7265 716d 6178  s(freq - freqmax
-0000e8b0: 2929 0a0a 2020 2020 6966 2069 7831 202b  ))..    if ix1 +
-0000e8c0: 206e 5f74 6170 6572 203e 206e 6666 743a   n_taper > nfft:
-0000e8d0: 0a20 2020 2020 2020 2069 7831 3120 3d20  .        ix11 = 
-0000e8e0: 6e66 6674 0a20 2020 2065 6c73 653a 0a20  nfft.    else:. 
-0000e8f0: 2020 2020 2020 2069 7831 3120 3d20 6978         ix11 = ix
-0000e900: 3120 2b20 6e5f 7461 7065 720a 0a20 2020  1 + n_taper..   
-0000e910: 2069 6620 6978 3020 2d20 6e5f 7461 7065   if ix0 - n_tape
-0000e920: 7220 3c20 303a 0a20 2020 2020 2020 2069  r < 0:.        i
-0000e930: 7830 3020 3d20 300a 2020 2020 656c 7365  x00 = 0.    else
-0000e940: 3a0a 2020 2020 2020 2020 6978 3030 203d  :.        ix00 =
-0000e950: 2069 7830 202d 206e 5f74 6170 6572 0a0a   ix0 - n_taper..
-0000e960: 2020 2020 7370 6563 5f6f 7574 203d 2073      spec_out = s
-0000e970: 7065 632e 636f 7079 2829 0a20 2020 2073  pec.copy().    s
-0000e980: 7065 635f 6f75 745b 303a 6978 3030 5d20  pec_out[0:ix00] 
-0000e990: 3d20 302e 3020 2b20 302e 306a 0a20 2020  = 0.0 + 0.0j.   
-0000e9a0: 2073 7065 635f 6f75 745b 6978 3131 3a5d   spec_out[ix11:]
-0000e9b0: 203d 2030 2e30 202b 2030 2e30 6a0a 0a20   = 0.0 + 0.0j.. 
-0000e9c0: 2020 2069 6620 736d 6f6f 7468 5f4e 203c     if smooth_N <
-0000e9d0: 3d20 313a 0a20 2020 2020 2020 2073 7065  = 1:.        spe
-0000e9e0: 635f 6f75 745b 6978 3030 3a69 7831 315d  c_out[ix00:ix11]
-0000e9f0: 203d 206e 702e 6578 7028 312e 306a 202a   = np.exp(1.0j *
-0000ea00: 206e 702e 616e 676c 6528 7370 6563 5f6f   np.angle(spec_o
-0000ea10: 7574 5b69 7830 303a 6978 3131 5d29 290a  ut[ix00:ix11])).
-0000ea20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ea30: 2020 7370 6563 5f6f 7574 5b69 7830 303a    spec_out[ix00:
-0000ea40: 6978 3131 5d20 2f3d 206d 6f76 696e 675f  ix11] /= moving_
-0000ea50: 6176 6528 6e70 2e61 6273 2873 7065 635f  ave(np.abs(spec_
-0000ea60: 6f75 745b 6978 3030 3a69 7831 315d 292c  out[ix00:ix11]),
-0000ea70: 2073 6d6f 6f74 685f 4e29 0a0a 2020 2020   smooth_N)..    
-0000ea80: 7820 3d20 6e70 2e6c 696e 7370 6163 6528  x = np.linspace(
-0000ea90: 6e70 2e70 6920 2f20 322e 302c 206e 702e  np.pi / 2.0, np.
-0000eaa0: 7069 2c20 6978 3020 2d20 6978 3030 290a  pi, ix0 - ix00).
-0000eab0: 2020 2020 7370 6563 5f6f 7574 5b69 7830      spec_out[ix0
-0000eac0: 303a 6978 305d 202a 3d20 6e70 2e63 6f73  0:ix0] *= np.cos
-0000ead0: 2878 2920 2a2a 2032 0a0a 2020 2020 7820  (x) ** 2..    x 
-0000eae0: 3d20 6e70 2e6c 696e 7370 6163 6528 302e  = np.linspace(0.
-0000eaf0: 302c 206e 702e 7069 202f 2032 2e30 2c20  0, np.pi / 2.0, 
-0000eb00: 6978 3131 202d 2069 7831 290a 2020 2020  ix11 - ix1).    
-0000eb10: 7370 6563 5f6f 7574 5b69 7831 3a69 7831  spec_out[ix1:ix1
-0000eb20: 315d 202a 3d20 6e70 2e63 6f73 2878 2920  1] *= np.cos(x) 
-0000eb30: 2a2a 2032 0a0a 2020 2020 7265 7475 726e  ** 2..    return
-0000eb40: 2073 7065 635f 6f75 740a 0a0a 6465 6620   spec_out...def 
-0000eb50: 7768 6974 656e 5f32 4428 7469 6d65 7365  whiten_2D(timese
-0000eb60: 7269 6573 2c20 6666 745f 7061 7261 2c20  ries, fft_para, 
-0000eb70: 6e5f 7461 7065 7229 3a0a 2020 2020 2222  n_taper):.    ""
-0000eb80: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
-0000eb90: 696f 6e20 7461 6b65 7320 6120 322d 6469  ion takes a 2-di
-0000eba0: 6d65 6e73 696f 6e61 6c20 7469 6d65 7365  mensional timese
-0000ebb0: 7269 6573 2061 7272 6179 2c20 7472 616e  ries array, tran
-0000ebc0: 7366 6f72 6d73 2074 6f20 6672 6571 7565  sforms to freque
-0000ebd0: 6e63 7920 646f 6d61 696e 2075 7369 6e67  ncy domain using
-0000ebe0: 2066 6674 2c0a 2020 2020 7768 6974 656e   fft,.    whiten
-0000ebf0: 7320 7468 6520 616d 706c 6974 7564 6520  s the amplitude 
-0000ec00: 6f66 2074 6865 2073 7065 6374 7275 6d20  of the spectrum 
-0000ec10: 696e 2066 7265 7175 656e 6379 2064 6f6d  in frequency dom
-0000ec20: 6169 6e20 6265 7477 6565 6e20 2a66 7265  ain between *fre
-0000ec30: 716d 696e 2a20 616e 6420 2a66 7265 716d  qmin* and *freqm
-0000ec40: 6178 2a0a 2020 2020 616e 6420 7265 7475  ax*.    and retu
-0000ec50: 726e 7320 7468 6520 7768 6974 656e 6564  rns the whitened
-0000ec60: 2066 6674 2e0a 2020 2020 5041 5241 4d45   fft..    PARAME
-0000ec70: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
-0000ec80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000ec90: 0a20 2020 2064 6174 613a 206e 756d 7079  .    data: numpy
-0000eca0: 2e6e 6461 7272 6179 2063 6f6e 7461 696e  .ndarray contain
-0000ecb0: 7320 7468 6520 3144 2074 696d 6520 7365  s the 1D time se
-0000ecc0: 7269 6573 2074 6f20 7768 6974 656e 0a20  ries to whiten. 
-0000ecd0: 2020 2066 6674 5f70 6172 613a 2064 6963     fft_para: dic
-0000ece0: 7420 636f 6e74 6169 6e69 6e67 2061 6c6c  t containing all
-0000ecf0: 2066 6674 5f63 6320 7061 7261 6d65 7465   fft_cc paramete
-0000ed00: 7273 2073 7563 6820 6173 0a20 2020 2020  rs such as.     
-0000ed10: 2020 2064 743a 2054 6865 2073 616d 706c     dt: The sampl
-0000ed20: 696e 6720 7370 6163 6520 6f66 2074 6865  ing space of the
-0000ed30: 2060 6461 7461 600a 2020 2020 2020 2020   `data`.        
-0000ed40: 6672 6571 6d69 6e3a 2054 6865 206c 6f77  freqmin: The low
-0000ed50: 6572 2066 7265 7175 656e 6379 2062 6f75  er frequency bou
-0000ed60: 6e64 0a20 2020 2020 2020 2066 7265 716d  nd.        freqm
-0000ed70: 6178 3a20 5468 6520 7570 7065 7220 6672  ax: The upper fr
-0000ed80: 6571 7565 6e63 7920 626f 756e 640a 2020  equency bound.  
-0000ed90: 2020 2020 2020 736d 6f6f 7468 5f4e 3a20        smooth_N: 
-0000eda0: 696e 7465 6765 722c 2069 7420 6465 6669  integer, it defi
-0000edb0: 6e65 7320 7468 6520 6861 6c66 2077 696e  nes the half win
-0000edc0: 646f 7720 6c65 6e67 7468 2074 6f20 736d  dow length to sm
-0000edd0: 6f6f 7468 0a20 2020 2020 2020 206e 5f74  ooth.        n_t
-0000ede0: 6170 6572 2c20 6f70 7469 6f6e 616c 3a20  aper, optional: 
-0000edf0: 696e 7465 6765 722c 2064 6566 696e 6520  integer, define 
-0000ee00: 7468 6520 7769 6474 6820 6f66 2074 6865  the width of the
-0000ee10: 2074 6170 6572 2069 6e20 7361 6d70 6c65   taper in sample
-0000ee20: 730a 2020 2020 5245 5455 524e 533a 0a20  s.    RETURNS:. 
-0000ee30: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-0000ee40: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 4646  ---------.    FF
-0000ee50: 5452 6177 5369 676e 3a20 6e75 6d70 792e  TRawSign: numpy.
-0000ee60: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
-0000ee70: 2074 6865 2046 4654 206f 6620 7468 6520   the FFT of the 
-0000ee80: 7768 6974 656e 6564 2069 6e70 7574 2074  whitened input t
-0000ee90: 7261 6365 2062 6574 7765 656e 2074 6865  race between the
-0000eea0: 2066 7265 7175 656e 6379 2062 6f75 6e64   frequency bound
-0000eeb0: 730a 2020 2020 2222 220a 2020 2020 2320  s.    """.    # 
-0000eec0: 6c6f 6164 2070 6172 616d 6574 6572 730a  load parameters.
-0000eed0: 2020 2020 6465 6c74 6120 3d20 6666 745f      delta = fft_
-0000eee0: 7061 7261 5b22 6474 225d 0a20 2020 2066  para["dt"].    f
-0000eef0: 7265 716d 696e 203d 2066 6674 5f70 6172  reqmin = fft_par
-0000ef00: 615b 2266 7265 716d 696e 225d 0a20 2020  a["freqmin"].   
-0000ef10: 2066 7265 716d 6178 203d 2066 6674 5f70   freqmax = fft_p
-0000ef20: 6172 615b 2266 7265 716d 6178 225d 0a20  ara["freqmax"]. 
-0000ef30: 2020 2073 6d6f 6f74 685f 4e20 3d20 6666     smooth_N = ff
-0000ef40: 745f 7061 7261 5b22 736d 6f6f 7468 5f4e  t_para["smooth_N
-0000ef50: 225d 0a0a 2020 2020 6e66 6674 203d 206e  "]..    nfft = n
-0000ef60: 6578 745f 6661 7374 5f6c 656e 2874 696d  ext_fast_len(tim
-0000ef70: 6573 6572 6965 732e 7368 6170 655b 315d  eseries.shape[1]
-0000ef80: 290a 2020 2020 7370 6563 203d 206e 702e  ).    spec = np.
-0000ef90: 6666 742e 6666 746e 2874 696d 6573 6572  fft.fftn(timeser
-0000efa0: 6965 732c 2073 3d5b 6e66 6674 5d29 0a20  ies, s=[nfft]). 
-0000efb0: 2020 2066 7265 7120 3d20 6e70 2e66 6674     freq = np.fft
-0000efc0: 2e66 6674 6672 6571 286e 6666 742c 2064  .fftfreq(nfft, d
-0000efd0: 3d64 656c 7461 290a 0a20 2020 2069 7830  =delta)..    ix0
-0000efe0: 203d 206e 702e 6172 676d 696e 286e 702e   = np.argmin(np.
-0000eff0: 6162 7328 6672 6571 202d 2066 7265 716d  abs(freq - freqm
-0000f000: 696e 2929 0a20 2020 2069 7831 203d 206e  in)).    ix1 = n
-0000f010: 702e 6172 676d 696e 286e 702e 6162 7328  p.argmin(np.abs(
-0000f020: 6672 6571 202d 2066 7265 716d 6178 2929  freq - freqmax))
-0000f030: 0a0a 2020 2020 6966 2069 7831 202b 206e  ..    if ix1 + n
-0000f040: 5f74 6170 6572 203e 206e 6666 743a 0a20  _taper > nfft:. 
-0000f050: 2020 2020 2020 2069 7831 3120 3d20 6e66         ix11 = nf
-0000f060: 6674 0a20 2020 2065 6c73 653a 0a20 2020  ft.    else:.   
-0000f070: 2020 2020 2069 7831 3120 3d20 6978 3120       ix11 = ix1 
-0000f080: 2b20 6e5f 7461 7065 720a 0a20 2020 2069  + n_taper..    i
-0000f090: 6620 6978 3020 2d20 6e5f 7461 7065 7220  f ix0 - n_taper 
-0000f0a0: 3c20 303a 0a20 2020 2020 2020 2069 7830  < 0:.        ix0
-0000f0b0: 3020 3d20 300a 2020 2020 656c 7365 3a0a  0 = 0.    else:.
-0000f0c0: 2020 2020 2020 2020 6978 3030 203d 2069          ix00 = i
-0000f0d0: 7830 202d 206e 5f74 6170 6572 0a0a 2020  x0 - n_taper..  
-0000f0e0: 2020 7370 6563 5f6f 7574 203d 2073 7065    spec_out = spe
-0000f0f0: 632e 636f 7079 2829 2020 2320 6d61 7920  c.copy()  # may 
-0000f100: 6265 2069 6e63 6f6e 7665 6e69 656e 7420  be inconvenient 
-0000f110: 6475 6520 746f 2068 6967 6865 7220 6d65  due to higher me
-0000f120: 6d6f 7279 2075 7361 6765 0a20 2020 2073  mory usage.    s
-0000f130: 7065 635f 6f75 745b 3a2c 2030 3a69 7830  pec_out[:, 0:ix0
-0000f140: 305d 203d 2030 2e30 202b 2030 2e30 6a0a  0] = 0.0 + 0.0j.
-0000f150: 2020 2020 7370 6563 5f6f 7574 5b3a 2c20      spec_out[:, 
-0000f160: 6978 3131 3a5d 203d 2030 2e30 202b 2030  ix11:] = 0.0 + 0
-0000f170: 2e30 6a0a 0a20 2020 2069 6620 736d 6f6f  .0j..    if smoo
-0000f180: 7468 5f4e 203c 3d20 313a 0a20 2020 2020  th_N <= 1:.     
-0000f190: 2020 2073 7065 635f 6f75 745b 3a2c 2069     spec_out[:, i
-0000f1a0: 7830 303a 6978 3131 5d20 3d20 6e70 2e65  x00:ix11] = np.e
-0000f1b0: 7870 2831 2e30 6a20 2a20 6e70 2e61 6e67  xp(1.0j * np.ang
-0000f1c0: 6c65 2873 7065 635f 6f75 745b 3a2c 2069  le(spec_out[:, i
-0000f1d0: 7830 303a 6978 3131 5d29 290a 2020 2020  x00:ix11])).    
-0000f1e0: 656c 7365 3a0a 2020 2020 2020 2020 7370  else:.        sp
-0000f1f0: 6563 5f6f 7574 5b3a 2c20 6978 3030 3a69  ec_out[:, ix00:i
-0000f200: 7831 315d 202f 3d20 6d6f 7669 6e67 5f61  x11] /= moving_a
-0000f210: 7665 5f32 4428 6e70 2e61 6273 2873 7065  ve_2D(np.abs(spe
-0000f220: 635f 6f75 745b 3a2c 2069 7830 303a 6978  c_out[:, ix00:ix
-0000f230: 3131 5d29 2c20 736d 6f6f 7468 5f4e 290a  11]), smooth_N).
-0000f240: 0a20 2020 2078 203d 206e 702e 6c69 6e73  .    x = np.lins
-0000f250: 7061 6365 286e 702e 7069 202f 2032 2e30  pace(np.pi / 2.0
-0000f260: 2c20 6e70 2e70 692c 2069 7830 202d 2069  , np.pi, ix0 - i
-0000f270: 7830 3029 0a20 2020 2073 7065 635f 6f75  x00).    spec_ou
-0000f280: 745b 3a2c 2069 7830 303a 6978 305d 202a  t[:, ix00:ix0] *
-0000f290: 3d20 6e70 2e63 6f73 2878 2920 2a2a 2032  = np.cos(x) ** 2
-0000f2a0: 0a0a 2020 2020 7820 3d20 6e70 2e6c 696e  ..    x = np.lin
-0000f2b0: 7370 6163 6528 302e 302c 206e 702e 7069  space(0.0, np.pi
-0000f2c0: 202f 2032 2e30 2c20 6978 3131 202d 2069   / 2.0, ix11 - i
-0000f2d0: 7831 290a 2020 2020 7370 6563 5f6f 7574  x1).    spec_out
-0000f2e0: 5b3a 2c20 6978 313a 6978 3131 5d20 2a3d  [:, ix1:ix11] *=
-0000f2f0: 206e 702e 636f 7328 7829 202a 2a20 320a   np.cos(x) ** 2.
-0000f300: 0a20 2020 2072 6574 7572 6e20 7370 6563  .    return spec
-0000f310: 5f6f 7574 0a0a 0a64 6566 2077 6869 7465  _out...def white
-0000f320: 6e28 6461 7461 2c20 6666 745f 7061 7261  n(data, fft_para
-0000f330: 2c20 6e5f 7461 7065 723d 3130 3029 3a0a  , n_taper=100):.
-0000f340: 2020 2020 2222 220a 2020 2020 5468 6973      """.    This
-0000f350: 2066 756e 6374 696f 6e20 7461 6b65 7320   function takes 
-0000f360: 6120 7469 6d65 7365 7269 6573 2061 7272  a timeseries arr
-0000f370: 6179 2c20 7472 616e 7366 6f72 6d73 2074  ay, transforms t
-0000f380: 6f20 6672 6571 7565 6e63 7920 646f 6d61  o frequency doma
-0000f390: 696e 2075 7369 6e67 2066 6674 2c0a 2020  in using fft,.  
-0000f3a0: 2020 7768 6974 656e 7320 7468 6520 616d    whitens the am
-0000f3b0: 706c 6974 7564 6520 6f66 2074 6865 2073  plitude of the s
-0000f3c0: 7065 6374 7275 6d20 696e 2066 7265 7175  pectrum in frequ
-0000f3d0: 656e 6379 2064 6f6d 6169 6e20 6265 7477  ency domain betw
-0000f3e0: 6565 6e20 2a66 7265 716d 696e 2a20 616e  een *freqmin* an
-0000f3f0: 6420 2a66 7265 716d 6178 2a0a 2020 2020  d *freqmax*.    
-0000f400: 616e 6420 7265 7475 726e 7320 7468 6520  and returns the 
-0000f410: 7768 6974 656e 6564 2066 6674 2e0a 2020  whitened fft..  
-0000f420: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
-0000f430: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-0000f440: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064 6174  --------.    dat
-0000f450: 613a 206e 756d 7079 2e6e 6461 7272 6179  a: numpy.ndarray
-0000f460: 2063 6f6e 7461 696e 7320 7468 6520 3144   contains the 1D
-0000f470: 2074 696d 6520 7365 7269 6573 2074 6f20   time series to 
-0000f480: 7768 6974 656e 0a20 2020 2066 6674 5f70  whiten.    fft_p
-0000f490: 6172 613a 2064 6963 7420 636f 6e74 6169  ara: dict contai
-0000f4a0: 6e69 6e67 2061 6c6c 2066 6674 5f63 6320  ning all fft_cc 
-0000f4b0: 7061 7261 6d65 7465 7273 2073 7563 6820  parameters such 
-0000f4c0: 6173 0a20 2020 2020 2020 2064 743a 2054  as.        dt: T
-0000f4d0: 6865 2073 616d 706c 696e 6720 7370 6163  he sampling spac
-0000f4e0: 6520 6f66 2074 6865 2060 6461 7461 600a  e of the `data`.
-0000f4f0: 2020 2020 2020 2020 6672 6571 6d69 6e3a          freqmin:
-0000f500: 2054 6865 206c 6f77 6572 2066 7265 7175   The lower frequ
-0000f510: 656e 6379 2062 6f75 6e64 0a20 2020 2020  ency bound.     
-0000f520: 2020 2066 7265 716d 6178 3a20 5468 6520     freqmax: The 
-0000f530: 7570 7065 7220 6672 6571 7565 6e63 7920  upper frequency 
-0000f540: 626f 756e 640a 2020 2020 2020 2020 736d  bound.        sm
-0000f550: 6f6f 7468 5f4e 3a20 696e 7465 6765 722c  ooth_N: integer,
-0000f560: 2069 7420 6465 6669 6e65 7320 7468 6520   it defines the 
-0000f570: 6861 6c66 2077 696e 646f 7720 6c65 6e67  half window leng
-0000f580: 7468 2074 6f20 736d 6f6f 7468 0a20 2020  th to smooth.   
-0000f590: 2020 2020 2066 7265 715f 6e6f 726d 3a20       freq_norm: 
-0000f5a0: 7768 6974 656e 696e 6720 6d65 7468 6f64  whitening method
-0000f5b0: 2062 6574 7765 656e 2027 6f6e 652d 6269   between 'one-bi
-0000f5c0: 7427 2061 6e64 2027 524d 4127 0a20 2020  t' and 'RMA'.   
-0000f5d0: 2052 4554 5552 4e53 3a0a 2020 2020 2d2d   RETURNS:.    --
-0000f5e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000f5f0: 2d2d 2d2d 0a20 2020 2046 4654 5261 7753  ----.    FFTRawS
-0000f600: 6967 6e3a 206e 756d 7079 2e6e 6461 7272  ign: numpy.ndarr
-0000f610: 6179 2063 6f6e 7461 696e 7320 7468 6520  ay contains the 
-0000f620: 4646 5420 6f66 2074 6865 2077 6869 7465  FFT of the white
-0000f630: 6e65 6420 696e 7075 7420 7472 6163 6520  ned input trace 
-0000f640: 6265 7477 6565 6e20 7468 6520 6672 6571  between the freq
-0000f650: 7565 6e63 7920 626f 756e 6473 0a20 2020  uency bounds.   
-0000f660: 2022 2222 0a0a 2020 2020 2320 5370 6565   """..    # Spee
-0000f670: 6420 7570 2046 4654 2062 7920 7061 6464  d up FFT by padd
-0000f680: 696e 6720 746f 206f 7074 696d 616c 2073  ing to optimal s
-0000f690: 697a 6520 666f 7220 4646 5450 4143 4b0a  ize for FFTPACK.
-0000f6a0: 2020 2020 6966 2064 6174 612e 6e64 696d      if data.ndim
-0000f6b0: 203d 3d20 313a 0a20 2020 2020 2020 2046   == 1:.        F
-0000f6c0: 4654 5261 7753 6967 6e20 3d20 7768 6974  FTRawSign = whit
-0000f6d0: 656e 5f31 4428 6461 7461 2c20 6666 745f  en_1D(data, fft_
-0000f6e0: 7061 7261 2c20 6e5f 7461 7065 7229 0a20  para, n_taper). 
-0000f6f0: 2020 2020 2020 2023 2041 5252 5f4f 5554         # ARR_OUT
-0000f700: 3a20 4f6e 6c79 2066 6f72 2063 6f6e 7369  : Only for consi
-0000f710: 7374 656e 6379 2077 6974 6820 6e6f 6973  stency with nois
-0000f720: 6570 7920 6170 7072 6f61 6368 206f 6620  epy approach of 
-0000f730: 686f 6c64 696e 6720 7468 6520 6675 6c6c  holding the full
-0000f740: 0a20 2020 2020 2020 2023 2073 7065 6374  .        # spect
-0000f750: 7275 6d20 286e 6f74 206a 7573 7420 3020  rum (not just 0 
-0000f760: 616e 6420 706f 7369 7469 7665 2066 7265  and positive fre
-0000f770: 712e 2070 6172 7429 0a20 2020 2020 2020  q. part).       
-0000f780: 2061 7272 5f6f 7574 203d 206e 702e 7a65   arr_out = np.ze
-0000f790: 726f 7328 2846 4654 5261 7753 6967 6e2e  ros((FFTRawSign.
-0000f7a0: 7368 6170 655b 305d 202d 2031 2920 2a20  shape[0] - 1) * 
-0000f7b0: 3220 2b20 312c 2064 7479 7065 3d63 6f6d  2 + 1, dtype=com
-0000f7c0: 706c 6578 290a 2020 2020 2020 2020 6172  plex).        ar
-0000f7d0: 725f 6f75 745b 3020 3a20 4646 5452 6177  r_out[0 : FFTRaw
-0000f7e0: 5369 676e 2e73 6861 7065 5b30 5d5d 203d  Sign.shape[0]] =
-0000f7f0: 2046 4654 5261 7753 6967 6e0a 2020 2020   FFTRawSign.    
-0000f800: 2020 2020 6172 725f 6f75 745b 4646 5452      arr_out[FFTR
-0000f810: 6177 5369 676e 2e73 6861 7065 5b30 5d20  awSign.shape[0] 
-0000f820: 3a5d 203d 2046 4654 5261 7753 6967 6e5b  :] = FFTRawSign[
-0000f830: 313a 5d2e 636f 6e6a 7567 6174 6528 295b  1:].conjugate()[
-0000f840: 3a3a 2d31 5d0a 0a20 2020 2065 6c69 6620  ::-1]..    elif 
-0000f850: 6461 7461 2e6e 6469 6d20 3d3d 2032 3a0a  data.ndim == 2:.
-0000f860: 2020 2020 2020 2020 4646 5452 6177 5369          FFTRawSi
-0000f870: 676e 203d 2077 6869 7465 6e5f 3244 2864  gn = whiten_2D(d
-0000f880: 6174 612c 2066 6674 5f70 6172 612c 206e  ata, fft_para, n
-0000f890: 5f74 6170 6572 290a 2020 2020 2020 2020  _taper).        
-0000f8a0: 6172 725f 6f75 7420 3d20 6e70 2e7a 6572  arr_out = np.zer
-0000f8b0: 6f73 2828 4646 5452 6177 5369 676e 2e73  os((FFTRawSign.s
-0000f8c0: 6861 7065 5b30 5d2c 2028 4646 5452 6177  hape[0], (FFTRaw
-0000f8d0: 5369 676e 2e73 6861 7065 5b31 5d20 2d20  Sign.shape[1] - 
-0000f8e0: 3129 202a 2032 202b 2031 292c 2064 7479  1) * 2 + 1), dty
-0000f8f0: 7065 3d63 6f6d 706c 6578 290a 2020 2020  pe=complex).    
-0000f900: 2020 2020 6172 725f 6f75 745b 3a2c 2046      arr_out[:, F
-0000f910: 4654 5261 7753 6967 6e2e 7368 6170 655b  FTRawSign.shape[
-0000f920: 315d 203a 5d20 3d20 4646 5452 6177 5369  1] :] = FFTRawSi
-0000f930: 676e 5b3a 2c20 313a 5d2e 636f 6e6a 7567  gn[:, 1:].conjug
-0000f940: 6174 6528 295b 3a3a 2d31 5d0a 2020 2020  ate()[::-1].    
-0000f950: 7265 7475 726e 2046 4654 5261 7753 6967  return FFTRawSig
-0000f960: 6e0a 0a0a 6465 6620 6164 6170 7469 7665  n...def adaptive
-0000f970: 5f66 696c 7465 7228 6172 722c 2067 293a  _filter(arr, g):
-0000f980: 0a20 2020 2022 2222 0a20 2020 2074 6865  .    """.    the
-0000f990: 2061 6461 7074 6976 6520 636f 7661 7269   adaptive covari
-0000f9a0: 616e 6365 2066 696c 7465 7220 746f 2065  ance filter to e
-0000f9b0: 6e68 616e 6365 2063 6f68 6572 656e 7420  nhance coherent 
-0000f9c0: 7369 676e 616c 732e 2046 656c 6c6f 7773  signals. Fellows
-0000f9d0: 2074 6865 206d 6574 686f 6420 6f66 0a20   the method of. 
-0000f9e0: 2020 204e 616b 6174 6120 6574 2061 6c2e     Nakata et al.
-0000f9f0: 2c20 3230 3135 2028 4170 7065 6e64 6978  , 2015 (Appendix
-0000fa00: 2042 290a 0a20 2020 2074 6865 2066 696c   B)..    the fil
-0000fa10: 7465 7265 6420 7369 676e 616c 205b 7831  tered signal [x1
-0000fa20: 5d20 6973 2067 6976 656e 2062 7920 7831  ] is given by x1
-0000fa30: 203d 2069 6666 7428 502a 7831 2877 2929   = ifft(P*x1(w))
-0000fa40: 2077 6865 7265 2078 3120 6973 2074 6865   where x1 is the
-0000fa50: 2066 6674 6564 2073 7065 6374 7261 0a20   ffted spectra. 
-0000fa60: 2020 2061 6e64 2050 2069 7320 7468 6520     and P is the 
-0000fa70: 6669 6c74 6572 2e20 5020 6973 2063 6f6e  filter. P is con
-0000fa80: 7374 7275 6374 6564 2062 7920 7573 696e  structed by usin
-0000fa90: 6720 7468 6520 7465 6d70 6f72 616c 2063  g the temporal c
-0000faa0: 6f76 6172 6961 6e63 6520 6d61 7472 6978  ovariance matrix
-0000fab0: 2e0a 0a20 2020 2050 4152 414d 4554 4552  ...    PARAMETER
-0000fac0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-0000fad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0000fae0: 2020 6172 723a 206e 756d 7079 2e6e 6461    arr: numpy.nda
-0000faf0: 7272 6179 2063 6f6e 7461 696e 7320 7468  rray contains th
-0000fb00: 6520 3244 2074 7261 6365 7320 6f66 2064  e 2D traces of d
-0000fb10: 6169 6c79 2f68 6f75 726c 7920 6372 6f73  aily/hourly cros
-0000fb20: 732d 636f 7272 656c 6174 696f 6e20 6675  s-correlation fu
-0000fb30: 6e63 7469 6f6e 730a 2020 2020 673a 2061  nctions.    g: a
-0000fb40: 2070 6f73 6974 6976 6520 6e75 6d62 6572   positive number
-0000fb50: 2074 6f20 6164 6a75 7374 2074 6865 2066   to adjust the f
-0000fb60: 696c 7465 7220 6861 7273 686e 6573 730a  ilter harshness.
-0000fb70: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-0000fb80: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-0000fb90: 2d2d 2d2d 2d2d 2d0a 2020 2020 6e61 7272  -------.    narr
-0000fba0: 3a20 6e75 6d70 7920 7665 6374 6f72 2063  : numpy vector c
-0000fbb0: 6f6e 7461 696e 7320 7468 6520 7374 6163  ontains the stac
-0000fbc0: 6b65 6420 6372 6f73 7320 636f 7272 656c  ked cross correl
-0000fbd0: 6174 696f 6e20 6675 6e63 7469 6f6e 0a20  ation function. 
-0000fbe0: 2020 2022 2222 0a20 2020 2069 6620 6172     """.    if ar
-0000fbf0: 722e 6e64 696d 203d 3d20 313a 0a20 2020  r.ndim == 1:.   
-0000fc00: 2020 2020 2072 6574 7572 6e20 6172 720a       return arr.
-0000fc10: 2020 2020 4e2c 204d 203d 2061 7272 2e73      N, M = arr.s
-0000fc20: 6861 7065 0a20 2020 204e 6666 7420 3d20  hape.    Nfft = 
-0000fc30: 6e65 7874 5f66 6173 745f 6c65 6e28 4d29  next_fast_len(M)
-0000fc40: 0a0a 2020 2020 2320 6666 7420 7468 6520  ..    # fft the 
-0000fc50: 3244 2061 7272 6179 0a20 2020 2073 7065  2D array.    spe
-0000fc60: 6320 3d20 7363 6970 792e 6666 7470 6163  c = scipy.fftpac
-0000fc70: 6b2e 6666 7428 6172 722c 2061 7869 733d  k.fft(arr, axis=
-0000fc80: 312c 206e 3d4e 6666 7429 5b3a 2c20 3a4d  1, n=Nfft)[:, :M
-0000fc90: 5d0a 0a20 2020 2023 206d 616b 6520 6372  ]..    # make cr
-0000fca0: 6f73 732d 7370 6563 7472 6d20 6d61 7472  oss-spectrm matr
-0000fcb0: 6978 0a20 2020 2063 7370 6563 203d 206e  ix.    cspec = n
-0000fcc0: 702e 7a65 726f 7328 7368 6170 653d 284e  p.zeros(shape=(N
-0000fcd0: 202a 204e 2c20 4d29 2c20 6474 7970 653d   * N, M), dtype=
-0000fce0: 6e70 2e63 6f6d 706c 6578 3634 290a 2020  np.complex64).  
-0000fcf0: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-0000fd00: 6528 4e29 3a0a 2020 2020 2020 2020 666f  e(N):.        fo
-0000fd10: 7220 6a6a 2069 6e20 7261 6e67 6528 4e29  r jj in range(N)
-0000fd20: 3a0a 2020 2020 2020 2020 2020 2020 6b6b  :.            kk
-0000fd30: 203d 2069 6920 2a20 4e20 2b20 6a6a 0a20   = ii * N + jj. 
-0000fd40: 2020 2020 2020 2020 2020 2063 7370 6563             cspec
-0000fd50: 5b6b 6b5d 203d 2073 7065 635b 6969 5d20  [kk] = spec[ii] 
-0000fd60: 2a20 6e70 2e63 6f6e 6a75 6761 7465 2873  * np.conjugate(s
-0000fd70: 7065 635b 6a6a 5d29 0a0a 2020 2020 5331  pec[jj])..    S1
-0000fd80: 203d 206e 702e 7a65 726f 7328 4d2c 2064   = np.zeros(M, d
-0000fd90: 7479 7065 3d6e 702e 636f 6d70 6c65 7836  type=np.complex6
-0000fda0: 3429 0a20 2020 2053 3220 3d20 6e70 2e7a  4).    S2 = np.z
-0000fdb0: 6572 6f73 284d 2c20 6474 7970 653d 6e70  eros(M, dtype=np
-0000fdc0: 2e63 6f6d 706c 6578 3634 290a 2020 2020  .complex64).    
-0000fdd0: 2320 636f 6e73 7472 7563 7420 7468 6520  # construct the 
-0000fde0: 6669 6c74 6572 2050 0a20 2020 2066 6f72  filter P.    for
-0000fdf0: 2069 6920 696e 2072 616e 6765 284e 293a   ii in range(N):
-0000fe00: 0a20 2020 2020 2020 206d 6d20 3d20 6969  .        mm = ii
-0000fe10: 202a 204e 202b 2069 690a 2020 2020 2020   * N + ii.      
-0000fe20: 2020 5332 202b 3d20 6373 7065 635b 6d6d    S2 += cspec[mm
-0000fe30: 5d0a 2020 2020 2020 2020 666f 7220 6a6a  ].        for jj
-0000fe40: 2069 6e20 7261 6e67 6528 4e29 3a0a 2020   in range(N):.  
-0000fe50: 2020 2020 2020 2020 2020 6b6b 203d 2069            kk = i
-0000fe60: 6920 2a20 4e20 2b20 6a6a 0a20 2020 2020  i * N + jj.     
-0000fe70: 2020 2020 2020 2053 3120 2b3d 2063 7370         S1 += csp
-0000fe80: 6563 5b6b 6b5d 0a0a 2020 2020 7020 3d20  ec[kk]..    p = 
-0000fe90: 6e70 2e70 6f77 6572 2828 5331 202d 2053  np.power((S1 - S
-0000fea0: 3229 202f 2028 5332 202a 2028 4e20 2d20  2) / (S2 * (N - 
-0000feb0: 3129 292c 2067 290a 0a20 2020 2023 206d  1)), g)..    # m
-0000fec0: 616b 6520 6966 6674 0a20 2020 206e 6172  ake ifft.    nar
-0000fed0: 7220 3d20 6e70 2e72 6561 6c28 7363 6970  r = np.real(scip
-0000fee0: 792e 6666 7470 6163 6b2e 6966 6674 286e  y.fftpack.ifft(n
-0000fef0: 702e 6d75 6c74 6970 6c79 2870 2c20 7370  p.multiply(p, sp
-0000ff00: 6563 292c 204e 6666 742c 2061 7869 733d  ec), Nfft, axis=
-0000ff10: 3129 5b3a 2c20 3a4d 5d29 0a20 2020 2072  1)[:, :M]).    r
-0000ff20: 6574 7572 6e20 6e70 2e6d 6561 6e28 6e61  eturn np.mean(na
-0000ff30: 7272 2c20 6178 6973 3d30 290a 0a0a 6465  rr, axis=0)...de
-0000ff40: 6620 7077 7328 6172 722c 2073 616d 706c  f pws(arr, sampl
-0000ff50: 696e 675f 7261 7465 2c20 706f 7765 723d  ing_rate, power=
-0000ff60: 322c 2070 7773 5f74 696d 6567 6174 653d  2, pws_timegate=
-0000ff70: 352e 3029 3a0a 2020 2020 2222 220a 2020  5.0):.    """.  
-0000ff80: 2020 5065 7266 6f72 6d73 2070 6861 7365    Performs phase
-0000ff90: 2d77 6569 6768 7465 6420 7374 6163 6b20  -weighted stack 
-0000ffa0: 6f6e 2061 7272 6179 206f 6620 7469 6d65  on array of time
-0000ffb0: 2073 6572 6965 732e 204d 6f64 6966 6965   series. Modifie
-0000ffc0: 6420 6f6e 2074 6865 206e 6f69 7365 2066  d on the noise f
-0000ffd0: 756e 6374 696f 6e20 6279 2054 696d 2043  unction by Tim C
-0000ffe0: 6c69 6d65 6e74 732e 0a20 2020 2046 6f6c  liments..    Fol
-0000fff0: 6c6f 7773 206d 6574 686f 6473 206f 6620  lows methods of 
-00010000: 5363 6869 6d6d 656c 2061 6e64 2050 6175  Schimmel and Pau
-00010010: 6c73 7365 6e2c 2031 3939 372e 0a20 2020  lssen, 1997..   
-00010020: 2049 6620 7328 7429 2069 7320 7469 6d65   If s(t) is time
-00010030: 2073 6572 6965 7320 6461 7461 2028 7365   series data (se
-00010040: 6973 6d6f 6772 616d 2c20 6f72 2063 726f  ismogram, or cro
-00010050: 7373 2d63 6f72 7265 6c61 7469 6f6e 292c  ss-correlation),
-00010060: 0a20 2020 2053 2874 2920 3d20 7328 7429  .    S(t) = s(t)
-00010070: 202b 2069 2a48 2873 2874 2929 2c20 7768   + i*H(s(t)), wh
-00010080: 6572 6520 4828 7328 7429 2920 6973 2048  ere H(s(t)) is H
-00010090: 696c 6265 7274 2074 7261 6e73 666f 726d  ilbert transform
-000100a0: 206f 6620 7328 7429 0a20 2020 2053 2874   of s(t).    S(t
-000100b0: 2920 3d20 7328 7429 202b 2069 2a48 2873  ) = s(t) + i*H(s
-000100c0: 2874 2929 203d 2041 2874 292a 6578 7028  (t)) = A(t)*exp(
-000100d0: 692a 7068 6928 7429 292c 2077 6865 7265  i*phi(t)), where
-000100e0: 0a20 2020 2041 2874 2920 6973 2065 6e76  .    A(t) is env
-000100f0: 656c 6f70 6520 6f66 2073 2874 2920 616e  elope of s(t) an
-00010100: 6420 7068 6928 7429 2069 7320 7068 6173  d phi(t) is phas
-00010110: 6520 6f66 2073 2874 290a 2020 2020 5068  e of s(t).    Ph
-00010120: 6173 652d 7765 6967 6874 6564 2073 7461  ase-weighted sta
-00010130: 636b 2c20 6728 7429 2c20 6973 2074 6865  ck, g(t), is the
-00010140: 6e3a 0a20 2020 2067 2874 2920 3d20 312f  n:.    g(t) = 1/
-00010150: 4e20 7375 6d20 6a20 3d20 313a 4e20 735f  N sum j = 1:N s_
-00010160: 6a28 7429 202a 207c 2031 2f4e 2073 756d  j(t) * | 1/N sum
-00010170: 206b 203d 2031 3a4e 2065 7870 5b69 202a   k = 1:N exp[i *
-00010180: 2070 6869 5f6b 2874 295d 7c5e 760a 2020   phi_k(t)]|^v.  
-00010190: 2020 7768 6572 6520 4e20 6973 206e 756d    where N is num
-000101a0: 6265 7220 6f66 2074 7261 6365 7320 7573  ber of traces us
-000101b0: 6564 2c20 7620 6973 2073 6861 7270 6e65  ed, v is sharpne
-000101c0: 7373 206f 6620 7068 6173 652d 7765 6967  ss of phase-weig
-000101d0: 6874 6564 2073 7461 636b 0a0a 2020 2020  hted stack..    
-000101e0: 5041 5241 4d45 5445 5253 3a0a 2020 2020  PARAMETERS:.    
-000101f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00010200: 2d2d 2d2d 2d0a 2020 2020 6172 723a 204e  -----.    arr: N
-00010210: 206c 656e 6774 6820 6172 7261 7920 6f66   length array of
-00010220: 2074 696d 6520 7365 7269 6573 2064 6174   time series dat
-00010230: 6120 286e 756d 7079 2e6e 6461 7272 6179  a (numpy.ndarray
-00010240: 290a 2020 2020 7361 6d70 6c69 6e67 5f72  ).    sampling_r
-00010250: 6174 653a 2073 616d 706c 696e 6720 7261  ate: sampling ra
-00010260: 7465 206f 6620 7469 6d65 2073 6572 6965  te of time serie
-00010270: 7320 6172 7220 2869 6e74 290a 2020 2020  s arr (int).    
-00010280: 706f 7765 723a 2065 7870 6f6e 656e 7420  power: exponent 
-00010290: 666f 7220 7068 6173 6520 7374 6163 6b20  for phase stack 
-000102a0: 2869 6e74 290a 2020 2020 7077 735f 7469  (int).    pws_ti
-000102b0: 6d65 6761 7465 3a20 6e75 6d62 6572 206f  megate: number o
-000102c0: 6620 7365 636f 6e64 7320 746f 2073 6d6f  f seconds to smo
-000102d0: 6f74 6820 7068 6173 6520 7374 6163 6b20  oth phase stack 
-000102e0: 2866 6c6f 6174 290a 0a20 2020 2052 4554  (float)..    RET
-000102f0: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
-00010300: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-00010310: 2020 2020 7765 6967 6874 6564 3a20 5068      weighted: Ph
-00010320: 6173 6520 7765 6967 6874 6564 2073 7461  ase weighted sta
-00010330: 636b 206f 6620 7469 6d65 2073 6572 6965  ck of time serie
-00010340: 7320 6461 7461 2028 6e75 6d70 792e 6e64  s data (numpy.nd
-00010350: 6172 7261 7929 0a20 2020 2022 2222 0a0a  array).    """..
-00010360: 2020 2020 6966 2061 7272 2e6e 6469 6d20      if arr.ndim 
-00010370: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
-00010380: 7475 726e 2061 7272 0a20 2020 204e 2c20  turn arr.    N, 
-00010390: 4d20 3d20 6172 722e 7368 6170 650a 2020  M = arr.shape.  
-000103a0: 2020 616e 616c 7974 6963 203d 2068 696c    analytic = hil
-000103b0: 6265 7274 2861 7272 2c20 6178 6973 3d31  bert(arr, axis=1
-000103c0: 2c20 4e3d 6e65 7874 5f66 6173 745f 6c65  , N=next_fast_le
-000103d0: 6e28 4d29 295b 3a2c 203a 4d5d 0a20 2020  n(M))[:, :M].   
-000103e0: 2070 6861 7365 203d 206e 702e 616e 676c   phase = np.angl
-000103f0: 6528 616e 616c 7974 6963 290a 2020 2020  e(analytic).    
-00010400: 7068 6173 655f 7374 6163 6b20 3d20 6e70  phase_stack = np
-00010410: 2e6d 6561 6e28 6e70 2e65 7870 2831 6a20  .mean(np.exp(1j 
-00010420: 2a20 7068 6173 6529 2c20 6178 6973 3d30  * phase), axis=0
-00010430: 290a 2020 2020 7068 6173 655f 7374 6163  ).    phase_stac
-00010440: 6b20 3d20 6e70 2e61 6273 2870 6861 7365  k = np.abs(phase
-00010450: 5f73 7461 636b 2920 2a2a 2028 706f 7765  _stack) ** (powe
-00010460: 7229 0a0a 2020 2020 2320 736d 6f6f 7468  r)..    # smooth
-00010470: 696e 670a 2020 2020 2320 7469 6d65 6761  ing.    # timega
-00010480: 7465 5f73 616d 706c 6573 203d 2069 6e74  te_samples = int
-00010490: 2870 7773 5f74 696d 6567 6174 6520 2a20  (pws_timegate * 
-000104a0: 7361 6d70 6c69 6e67 5f72 6174 6529 0a20  sampling_rate). 
-000104b0: 2020 2023 2070 6861 7365 5f73 7461 636b     # phase_stack
-000104c0: 203d 206d 6f76 696e 675f 6176 6528 7068   = moving_ave(ph
-000104d0: 6173 655f 7374 6163 6b2c 7469 6d65 6761  ase_stack,timega
-000104e0: 7465 5f73 616d 706c 6573 290a 2020 2020  te_samples).    
-000104f0: 7765 6967 6874 6564 203d 206e 702e 6d75  weighted = np.mu
-00010500: 6c74 6970 6c79 2861 7272 2c20 7068 6173  ltiply(arr, phas
-00010510: 655f 7374 6163 6b29 0a20 2020 2072 6574  e_stack).    ret
-00010520: 7572 6e20 6e70 2e6d 6561 6e28 7765 6967  urn np.mean(weig
-00010530: 6874 6564 2c20 6178 6973 3d30 290a 0a0a  hted, axis=0)...
-00010540: 6465 6620 6e72 6f6f 745f 7374 6163 6b28  def nroot_stack(
-00010550: 6363 5f61 7272 6179 2c20 706f 7765 7229  cc_array, power)
-00010560: 3a0a 2020 2020 2222 220a 2020 2020 7468  :.    """.    th
-00010570: 6973 2069 7320 6e74 682d 726f 6f74 2073  is is nth-root s
-00010580: 7461 636b 696e 6720 616c 676f 7269 7468  tacking algorith
-00010590: 6d20 7472 616e 736c 6174 6564 2062 6173  m translated bas
-000105a0: 6564 206f 6e20 7468 6520 6d61 746c 6162  ed on the matlab
-000105b0: 2066 756e 6374 696f 6e0a 2020 2020 6672   function.    fr
-000105c0: 6f6d 2068 7474 7073 3a2f 2f67 6974 6875  om https://githu
-000105d0: 622e 636f 6d2f 7874 7961 6e67 7073 702f  b.com/xtyangpsp/
-000105e0: 5365 6973 5374 6163 6b20 2862 7920 5869  SeisStack (by Xi
-000105f0: 616f 7461 6f20 5961 6e67 3b20 666f 6c6c  aotao Yang; foll
-00010600: 6f77 7320 7468 650a 2020 2020 7265 6665  ows the.    refe
-00010610: 7265 6e63 6520 6f66 204d 696c 6c65 742c  rence of Millet,
-00010620: 2046 2065 7420 616c 2e2c 2032 3031 3920   F et al., 2019 
-00010630: 4a47 5229 0a0a 2020 2020 5061 7261 6d65  JGR)..    Parame
-00010640: 7465 7273 3a0a 2020 2020 2d2d 2d2d 2d2d  ters:.    ------
-00010650: 2d2d 2d2d 2d2d 0a20 2020 2063 635f 6172  ------.    cc_ar
-00010660: 7261 793a 206e 756d 7079 2e6e 6461 7272  ray: numpy.ndarr
-00010670: 6179 2063 6f6e 7461 696e 7320 7468 6520  ay contains the 
-00010680: 3244 2063 726f 7373 2063 6f72 7265 6c61  2D cross correla
-00010690: 7469 6f6e 206d 6174 7269 780a 2020 2020  tion matrix.    
-000106a0: 706f 7765 723a 206e 702e 696e 742c 206e  power: np.int, n
-000106b0: 7468 2072 6f6f 7420 666f 7220 7468 6520  th root for the 
-000106c0: 7374 6163 6b69 6e67 0a0a 2020 2020 5265  stacking..    Re
-000106d0: 7475 726e 733a 0a20 2020 202d 2d2d 2d2d  turns:.    -----
-000106e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6e73 7461  -------.    nsta
-000106f0: 636b 3a20 6e70 2e6e 6461 7272 6179 2c20  ck: np.ndarray, 
-00010700: 6669 6e61 6c20 7374 6163 6b65 6420 7761  final stacked wa
-00010710: 7665 666f 726d 730a 0a20 2020 2057 7269  veforms..    Wri
-00010720: 7474 656e 2062 7920 4368 656e 6778 696e  tten by Chengxin
-00010730: 204a 6961 6e67 2040 414e 5520 284d 6179   Jiang @ANU (May
-00010740: 3230 3230 290a 2020 2020 2222 220a 2020  2020).    """.  
-00010750: 2020 6966 2063 635f 6172 7261 792e 6e64    if cc_array.nd
-00010760: 696d 203d 3d20 313a 0a20 2020 2020 2020  im == 1:.       
-00010770: 2070 7269 6e74 2822 3244 206d 6174 7269   print("2D matri
-00010780: 7820 6973 206e 6565 6465 6420 666f 7220  x is needed for 
-00010790: 6e72 6f6f 745f 7374 6163 6b22 290a 2020  nroot_stack").  
-000107a0: 2020 2020 2020 7265 7475 726e 2063 635f        return cc_
-000107b0: 6172 7261 790a 2020 2020 4e2c 204d 203d  array.    N, M =
-000107c0: 2063 635f 6172 7261 792e 7368 6170 650a   cc_array.shape.
-000107d0: 2020 2020 646f 7574 203d 206e 702e 7a65      dout = np.ze
-000107e0: 726f 7328 4d2c 2064 7479 7065 3d6e 702e  ros(M, dtype=np.
-000107f0: 666c 6f61 7433 3229 0a0a 2020 2020 2320  float32)..    # 
-00010800: 636f 6e73 7472 7563 7420 790a 2020 2020  construct y.    
-00010810: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-00010820: 4e29 3a0a 2020 2020 2020 2020 6461 7420  N):.        dat 
-00010830: 3d20 6363 5f61 7272 6179 5b69 692c 203a  = cc_array[ii, :
-00010840: 5d0a 2020 2020 2020 2020 646f 7574 202b  ].        dout +
-00010850: 3d20 6e70 2e73 6967 6e28 6461 7429 202a  = np.sign(dat) *
-00010860: 206e 702e 6162 7328 6461 7429 202a 2a20   np.abs(dat) ** 
-00010870: 2831 202f 2070 6f77 6572 290a 2020 2020  (1 / power).    
-00010880: 646f 7574 202f 3d20 4e0a 0a20 2020 2023  dout /= N..    #
-00010890: 2074 6865 2066 696e 616c 2073 7461 636b   the final stack
-000108a0: 6564 2077 6176 6566 6f72 6d0a 2020 2020  ed waveform.    
-000108b0: 6e73 7461 636b 203d 2064 6f75 7420 2a20  nstack = dout * 
-000108c0: 6e70 2e61 6273 2864 6f75 7429 202a 2a20  np.abs(dout) ** 
-000108d0: 2870 6f77 6572 202d 2031 290a 0a20 2020  (power - 1)..   
-000108e0: 2072 6574 7572 6e20 6e73 7461 636b 0a0a   return nstack..
-000108f0: 0a64 6566 2073 656c 6563 7469 7665 5f73  .def selective_s
-00010900: 7461 636b 2863 635f 6172 7261 792c 2065  tack(cc_array, e
-00010910: 7073 696c 6f6e 2c20 6363 5f74 6829 3a20  psilon, cc_th): 
-00010920: 2023 206e 6f71 613a 2046 3831 310a 2020   # noqa: F811.  
-00010930: 2020 2222 220a 2020 2020 7468 6973 2069    """.    this i
-00010940: 7320 6120 7365 6c65 6374 6976 6520 7374  s a selective st
-00010950: 6163 6b69 6e67 2061 6c67 6f72 6974 686d  acking algorithm
-00010960: 2064 6576 656c 6f70 6564 2062 7920 4a61   developed by Ja
-00010970: 7265 6420 4272 7961 6e2f 4b75 7261 6d61  red Bryan/Kurama
-00010980: 204f 6b75 626f 2e0a 0a20 2020 2050 4152   Okubo...    PAR
-00010990: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
-000109a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000109b0: 2d2d 2d0a 2020 2020 6363 5f61 7272 6179  ---.    cc_array
-000109c0: 3a20 6e75 6d70 792e 6e64 6172 7261 7920  : numpy.ndarray 
-000109d0: 636f 6e74 6169 6e73 2074 6865 2032 4420  contains the 2D 
-000109e0: 6372 6f73 7320 636f 7272 656c 6174 696f  cross correlatio
-000109f0: 6e20 6d61 7472 6978 0a20 2020 2065 7073  n matrix.    eps
-00010a00: 696c 6f6e 3a20 7265 7369 6475 616c 2074  ilon: residual t
-00010a10: 6872 6568 6f6c 6420 746f 2071 7569 7420  hrehold to quit 
-00010a20: 7468 6520 6974 6572 6174 696f 6e0a 2020  the iteration.  
-00010a30: 2020 6363 5f74 683a 206e 756d 7079 2e66    cc_th: numpy.f
-00010a40: 6c6f 6174 2c20 7468 7265 7368 6f6c 6420  loat, threshold 
-00010a50: 6f66 2063 6f72 7265 6c61 7469 6f6e 2063  of correlation c
-00010a60: 6f65 6666 6963 6965 6e74 2074 6f20 6265  oefficient to be
-00010a70: 2073 656c 6563 7465 640a 0a20 2020 2052   selected..    R
-00010a80: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
-00010a90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00010aa0: 2d2d 0a20 2020 206e 6577 7374 6163 6b3a  --.    newstack:
-00010ab0: 206e 756d 7079 2076 6563 746f 7220 636f   numpy vector co
-00010ac0: 6e74 6169 6e73 2074 6865 2073 7461 636b  ntains the stack
-00010ad0: 6564 2063 726f 7373 2063 6f72 7265 6c61  ed cross correla
-00010ae0: 7469 6f6e 0a20 2020 206e 7374 6570 3a20  tion.    nstep: 
-00010af0: 6e70 2e69 6e74 2c20 746f 7461 6c20 6e75  np.int, total nu
-00010b00: 6d62 6572 206f 6620 6974 6572 6174 696f  mber of iteratio
-00010b10: 6e73 2066 6f72 2074 6865 2073 7461 636b  ns for the stack
-00010b20: 696e 670a 0a20 2020 204f 7269 6769 6e61  ing..    Origina
-00010b30: 6c6c 7920 7269 7474 656e 2062 7920 4d61  lly ritten by Ma
-00010b40: 7269 6e65 2044 656e 6f6c 6c65 0a20 2020  rine Denolle.   
-00010b50: 204d 6f64 6966 6965 6420 6279 2043 6865   Modified by Che
-00010b60: 6e67 7869 6e20 4a69 616e 6720 4048 6172  ngxin Jiang @Har
-00010b70: 7661 7264 2028 4f63 7432 3032 3029 0a20  vard (Oct2020). 
-00010b80: 2020 2022 2222 0a20 2020 2069 6620 6363     """.    if cc
-00010b90: 5f61 7272 6179 2e6e 6469 6d20 3d3d 2031  _array.ndim == 1
-00010ba0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-00010bb0: 2232 4420 6d61 7472 6978 2069 7320 6e65  "2D matrix is ne
-00010bc0: 6564 6564 2066 6f72 206e 726f 6f74 5f73  eded for nroot_s
-00010bd0: 7461 636b 2229 0a20 2020 2020 2020 2072  tack").        r
-00010be0: 6574 7572 6e20 6363 5f61 7272 6179 0a20  eturn cc_array. 
-00010bf0: 2020 204e 2c20 4d20 3d20 6363 5f61 7272     N, M = cc_arr
-00010c00: 6179 2e73 6861 7065 0a0a 2020 2020 7265  ay.shape..    re
-00010c10: 7320 3d20 3965 3920 2023 2072 6573 6964  s = 9e9  # resid
-00010c20: 7561 6c73 0a20 2020 2063 6f66 203d 206e  uals.    cof = n
-00010c30: 702e 7a65 726f 7328 4e2c 2064 7479 7065  p.zeros(N, dtype
-00010c40: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
-00010c50: 206e 6577 7374 6163 6b20 3d20 6e70 2e6d   newstack = np.m
-00010c60: 6561 6e28 6363 5f61 7272 6179 2c20 6178  ean(cc_array, ax
-00010c70: 6973 3d30 290a 0a20 2020 206e 7374 6570  is=0)..    nstep
-00010c80: 203d 2030 0a20 2020 2023 2073 7461 7274   = 0.    # start
-00010c90: 2069 7465 7261 7469 6f6e 0a20 2020 2077   iteration.    w
-00010ca0: 6869 6c65 2072 6573 203e 2065 7073 696c  hile res > epsil
-00010cb0: 6f6e 3a0a 2020 2020 2020 2020 666f 7220  on:.        for 
-00010cc0: 6969 2069 6e20 7261 6e67 6528 4e29 3a0a  ii in range(N):.
-00010cd0: 2020 2020 2020 2020 2020 2020 636f 665b              cof[
-00010ce0: 6969 5d20 3d20 6e70 2e63 6f72 7263 6f65  ii] = np.corrcoe
-00010cf0: 6628 6e65 7773 7461 636b 2c20 6363 5f61  f(newstack, cc_a
-00010d00: 7272 6179 5b69 692c 203a 5d29 5b30 2c20  rray[ii, :])[0, 
-00010d10: 315d 0a0a 2020 2020 2020 2020 2320 6669  1]..        # fi
-00010d20: 6e64 2067 6f6f 6420 7761 7665 666f 726d  nd good waveform
-00010d30: 730a 2020 2020 2020 2020 696e 6478 203d  s.        indx =
-00010d40: 206e 702e 7768 6572 6528 636f 6620 3e3d   np.where(cof >=
-00010d50: 2063 635f 7468 295b 305d 0a20 2020 2020   cc_th)[0].     
-00010d60: 2020 2069 6620 6e6f 7420 6c65 6e28 696e     if not len(in
-00010d70: 6478 293a 0a20 2020 2020 2020 2020 2020  dx):.           
-00010d80: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00010d90: 7228 2263 616e 6e6f 7420 6669 6e64 2067  r("cannot find g
-00010da0: 6f6f 6420 7761 7665 666f 726d 7320 696e  ood waveforms in
-00010db0: 7369 6465 2073 656c 6563 7469 7665 2073  side selective s
-00010dc0: 7461 636b 696e 6722 290a 2020 2020 2020  tacking").      
-00010dd0: 2020 6f6c 6473 7461 636b 203d 206e 6577    oldstack = new
-00010de0: 7374 6163 6b0a 2020 2020 2020 2020 6e65  stack.        ne
-00010df0: 7773 7461 636b 203d 206e 702e 6d65 616e  wstack = np.mean
-00010e00: 2863 635f 6172 7261 795b 696e 6478 5d2c  (cc_array[indx],
-00010e10: 2061 7869 733d 3029 0a20 2020 2020 2020   axis=0).       
-00010e20: 2072 6573 203d 206e 702e 6c69 6e61 6c67   res = np.linalg
-00010e30: 2e6e 6f72 6d28 6e65 7773 7461 636b 202d  .norm(newstack -
-00010e40: 206f 6c64 7374 6163 6b29 202f 2028 6e70   oldstack) / (np
-00010e50: 2e6c 696e 616c 672e 6e6f 726d 286e 6577  .linalg.norm(new
-00010e60: 7374 6163 6b29 202a 204d 290a 2020 2020  stack) * M).    
-00010e70: 2020 2020 6e73 7465 7020 2b3d 2031 0a0a      nstep += 1..
-00010e80: 2020 2020 7265 7475 726e 206e 6577 7374      return newst
-00010e90: 6163 6b2c 206e 7374 6570 0a0a 0a64 6566  ack, nstep...def
-00010ea0: 2067 6574 5f63 6328 7331 2c20 735f 7265   get_cc(s1, s_re
-00010eb0: 6629 3a0a 2020 2020 2320 7265 7475 726e  f):.    # return
-00010ec0: 7320 7468 6520 636f 7272 656c 6174 696f  s the correlatio
-00010ed0: 6e20 636f 6566 6669 6369 656e 7420 6265  n coefficient be
-00010ee0: 7477 6565 6e20 7761 7665 666f 726d 7320  tween waveforms 
-00010ef0: 696e 2073 3120 6167 6169 6e73 7420 7265  in s1 against re
-00010f00: 6665 7265 6e63 650a 2020 2020 2320 7761  ference.    # wa
-00010f10: 7665 666f 726d 2073 5f72 6566 2e0a 2020  veform s_ref..  
-00010f20: 2020 230a 2020 2020 6363 203d 206e 702e    #.    cc = np.
-00010f30: 7a65 726f 7328 7331 2e73 6861 7065 5b30  zeros(s1.shape[0
-00010f40: 5d29 0a20 2020 2073 5f72 6566 5f6e 6f72  ]).    s_ref_nor
-00010f50: 6d20 3d20 6e70 2e6c 696e 616c 672e 6e6f  m = np.linalg.no
-00010f60: 726d 2873 5f72 6566 290a 2020 2020 666f  rm(s_ref).    fo
-00010f70: 7220 6920 696e 2072 616e 6765 2873 312e  r i in range(s1.
-00010f80: 7368 6170 655b 305d 293a 0a20 2020 2020  shape[0]):.     
-00010f90: 2020 2063 635b 695d 203d 206e 702e 7375     cc[i] = np.su
-00010fa0: 6d28 6e70 2e6d 756c 7469 706c 7928 7331  m(np.multiply(s1
-00010fb0: 5b69 2c20 3a5d 2c20 735f 7265 6629 2920  [i, :], s_ref)) 
-00010fc0: 2f20 6e70 2e6c 696e 616c 672e 6e6f 726d  / np.linalg.norm
-00010fd0: 2873 315b 692c 203a 5d29 202f 2073 5f72  (s1[i, :]) / s_r
-00010fe0: 6566 5f6e 6f72 6d0a 2020 2020 7265 7475  ef_norm.    retu
-00010ff0: 726e 2063 630a 0a0a 2323 2323 2323 2323  rn cc...########
-00011000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011010: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011020: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011030: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
-00011040: 2320 4d4f 4e49 544f 5249 4e47 2046 554e  # MONITORING FUN
-00011050: 4354 494f 4e53 2023 2323 2323 2323 2323  CTIONS #########
-00011060: 2323 2323 2323 2323 230a 2323 2323 2323  #########.######
-00011070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011090: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000110a0: 2323 0a0a 2222 220a 6120 636f 6d70 696c  ##..""".a compil
-000110b0: 6174 696f 6e20 6f66 2061 6c6c 2061 7661  ation of all ava
-000110c0: 696c 6162 6c65 2063 6f72 6520 6675 6e63  ilable core func
-000110d0: 7469 6f6e 7320 666f 7220 636f 6d70 7574  tions for comput
-000110e0: 696e 6720 7068 6173 6520 6465 6c61 7973  ing phase delays
-000110f0: 2062 6173 6564 206f 6e20 616d 6269 656e   based on ambien
-00011100: 7420 6e6f 6973 6520 696e 7465 7266 6572  t noise interfer
-00011110: 6f6d 6574 7279 0a0a 7175 6963 6b20 696e  ometry..quick in
-00011120: 6465 7820 6f66 2064 762f 7620 6d65 7468  dex of dv/v meth
-00011130: 6f64 733a 0a31 2920 7374 7265 7463 6869  ods:.1) stretchi
-00011140: 6e67 2028 7469 6d65 2073 7472 6574 6368  ng (time stretch
-00011150: 696e 673b 2057 6561 7665 7220 6574 2061  ing; Weaver et a
-00011160: 6c20 2832 3031 3129 290a 3229 2064 7477  l (2011)).2) dtw
-00011170: 5f64 7676 2028 4479 6e61 6d69 6320 5469  _dvv (Dynamic Ti
-00011180: 6d65 2057 6172 7069 6e67 3b20 4d69 6b65  me Warping; Mike
-00011190: 7365 6c6c 2065 7420 616c 2e20 3230 3135  sell et al. 2015
-000111a0: 290a 3329 206d 7763 735f 6476 7620 284d  ).3) mwcs_dvv (M
-000111b0: 6f76 696e 6720 5769 6e64 6f77 2043 726f  oving Window Cro
-000111c0: 7373 2053 7065 6374 7275 6d3b 2043 6c61  ss Spectrum; Cla
-000111d0: 726b 2065 7420 616c 2e2c 2032 3031 3129  rk et al., 2011)
-000111e0: 0a34 2920 6d77 6363 5f64 7676 2028 4d6f  .4) mwcc_dvv (Mo
-000111f0: 7669 6e67 2057 696e 646f 7720 4372 6f73  ving Window Cros
-00011200: 7320 436f 7272 656c 6174 696f 6e3b 2053  s Correlation; S
-00011210: 6e69 6564 6572 2065 7420 616c 2e2c 2032  nieder et al., 2
-00011220: 3031 3229 0a35 2920 7774 735f 6476 7620  012).5) wts_dvv 
-00011230: 2857 6176 656c 6574 2053 7472 6563 6869  (Wavelet Strechi
-00011240: 6e67 3b20 5975 616e 2065 7420 616c 2e2c  ng; Yuan et al.,
-00011250: 2069 6e20 7072 6570 290a 3629 2077 7873   in prep).6) wxs
-00011260: 5f64 7676 2028 5761 7665 6c65 7420 5872  _dvv (Wavelet Xr
-00011270: 6f73 7320 5370 6563 7472 756d 3b20 4d61  oss Spectrum; Ma
-00011280: 6f20 6574 2061 6c2e 2c20 3230 3139 290a  o et al., 2019).
-00011290: 3729 2077 6477 5f64 7676 2028 5761 7665  7) wdw_dvv (Wave
-000112a0: 6c65 7420 4479 6e61 6d69 6320 5761 7270  let Dynamic Warp
-000112b0: 696e 673b 2059 7561 6e20 6574 2061 6c2e  ing; Yuan et al.
-000112c0: 2c20 696e 2070 7265 7029 0a22 2222 0a0a  , in prep)."""..
-000112d0: 0a64 6566 2073 7472 6574 6368 696e 6728  .def stretching(
-000112e0: 7265 662c 2063 7572 2c20 6476 5f72 616e  ref, cur, dv_ran
-000112f0: 6765 2c20 6e62 7472 6961 6c2c 2070 6172  ge, nbtrial, par
-00011300: 6129 3a0a 2020 2020 2222 220a 2020 2020  a):.    """.    
-00011310: 5468 6973 2066 756e 6374 696f 6e20 636f  This function co
-00011320: 6d70 6172 6573 2074 6865 2052 6566 6572  mpares the Refer
-00011330: 656e 6365 2077 6176 6566 6f72 6d20 746f  ence waveform to
-00011340: 2073 7472 6574 6368 6564 2f63 6f6d 7072   stretched/compr
-00011350: 6573 7365 6420 6375 7272 656e 7420 7761  essed current wa
-00011360: 7665 666f 726d 7320 746f 2067 6574 2074  veforms to get t
-00011370: 6865 0a20 2020 2072 656c 6174 6976 6520  he.    relative 
-00011380: 7365 6973 6d69 6320 7665 6c6f 6369 7479  seismic velocity
-00011390: 2076 6172 6961 7469 6f6e 2028 616e 6420   variation (and 
-000113a0: 6173 736f 6369 6174 6564 2065 7272 6f72  associated error
-000113b0: 292e 0a20 2020 2049 7420 616c 736f 2063  )..    It also c
-000113c0: 6f6d 7075 7465 7320 7468 6520 636f 7272  omputes the corr
-000113d0: 656c 6174 696f 6e20 636f 6566 6669 6369  elation coeffici
-000113e0: 656e 7420 6265 7477 6565 6e20 7468 6520  ent between the 
-000113f0: 5265 6665 7265 6e63 6520 7761 7665 666f  Reference wavefo
-00011400: 726d 2061 6e64 2074 6865 2063 7572 7265  rm and the curre
-00011410: 6e74 2077 6176 6566 6f72 6d2e 0a0a 2020  nt waveform...  
-00011420: 2020 5041 5241 4d45 5445 5253 3a0a 2020    PARAMETERS:.  
-00011430: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-00011440: 2d2d 0a20 2020 2072 6566 3a20 5265 6665  --.    ref: Refe
-00011450: 7265 6e63 6520 7761 7665 666f 726d 2028  rence waveform (
-00011460: 6e70 2e6e 6461 7272 6179 2c20 7369 7a65  np.ndarray, size
-00011470: 204e 290a 2020 2020 6375 723a 2043 7572   N).    cur: Cur
-00011480: 7265 6e74 2077 6176 6566 6f72 6d20 286e  rent waveform (n
-00011490: 702e 6e64 6172 7261 792c 2073 697a 6520  p.ndarray, size 
-000114a0: 4e29 0a20 2020 2064 765f 7261 6e67 653a  N).    dv_range:
-000114b0: 2061 6273 6f6c 7574 6520 626f 756e 6420   absolute bound 
-000114c0: 666f 7220 7468 6520 7665 6c6f 6369 7479  for the velocity
-000114d0: 2076 6172 6961 7469 6f6e 3b20 6578 616d   variation; exam
-000114e0: 706c 653a 2064 763d 302e 3033 2066 6f72  ple: dv=0.03 for
-000114f0: 205b 2d33 2c33 5d25 0a20 2020 206f 6620   [-3,3]%.    of 
-00011500: 7265 6c61 7469 7665 2076 656c 6f63 6974  relative velocit
-00011510: 7920 6368 616e 6765 2028 2766 6c6f 6174  y change ('float
-00011520: 2729 0a20 2020 206e 6274 7269 616c 3a20  ').    nbtrial: 
-00011530: 6e75 6d62 6572 206f 6620 7374 7265 7463  number of stretc
-00011540: 6869 6e67 2063 6f65 6666 6963 6965 6e74  hing coefficient
-00011550: 2062 6574 7765 656e 2064 766d 696e 2061   between dvmin a
-00011560: 6e64 2064 766d 6178 2c20 6e6f 206e 6565  nd dvmax, no nee
-00011570: 6420 746f 2062 6520 6869 6768 6572 2074  d to be higher t
-00011580: 6861 6e20 3130 3020 2028 2766 6c6f 6174  han 100  ('float
-00011590: 2729 0a20 2020 2070 6172 613a 2076 6563  ').    para: vec
-000115a0: 746f 7220 6f66 2074 6865 2069 6e64 6963  tor of the indic
-000115b0: 6573 206f 6620 7468 6520 6375 7220 616e  es of the cur an
-000115c0: 6420 7265 6620 7769 6e64 6f77 7320 6f6e  d ref windows on
-000115d0: 2077 6963 6820 796f 7520 7761 6e74 2074   wich you want t
-000115e0: 6f20 646f 2074 6865 206d 6561 7375 7265  o do the measure
-000115f0: 6d65 6e74 730a 2020 2020 286e 702e 6e64  ments.    (np.nd
-00011600: 6172 7261 792c 2073 697a 6520 746d 696e  array, size tmin
-00011610: 2a64 656c 7461 3a74 6d61 782a 6465 6c74  *delta:tmax*delt
-00011620: 6129 0a20 2020 2046 6f72 2065 7272 6f72  a).    For error
-00011630: 2063 6f6d 7075 7461 7469 6f6e 2c20 7765   computation, we
-00011640: 206e 6565 6420 7061 7261 6d65 7465 7273   need parameters
-00011650: 3a0a 2020 2020 2020 2020 666d 696e 3a20  :.        fmin: 
-00011660: 6d69 6e69 6d75 6d20 6672 6571 7565 6e63  minimum frequenc
-00011670: 7920 6f66 2074 6865 2064 6174 610a 2020  y of the data.  
-00011680: 2020 2020 2020 666d 6178 3a20 6d61 7869        fmax: maxi
-00011690: 6d75 6d20 6672 6571 7565 6e63 7920 6f66  mum frequency of
-000116a0: 2074 6865 2064 6174 610a 2020 2020 2020   the data.      
-000116b0: 2020 746d 696e 3a20 6d69 6e69 6d75 6d20    tmin: minimum 
-000116c0: 7469 6d65 2077 696e 646f 7720 7768 6572  time window wher
-000116d0: 6520 7468 6520 6476 2f76 2069 7320 636f  e the dv/v is co
-000116e0: 6d70 7574 6564 0a20 2020 2020 2020 2074  mputed.        t
-000116f0: 6d61 783a 206d 6178 696d 756d 2074 696d  max: maximum tim
-00011700: 6520 7769 6e64 6f77 2077 6865 7265 2074  e window where t
-00011710: 6865 2064 762f 7620 6973 2063 6f6d 7075  he dv/v is compu
-00011720: 7465 640a 2020 2020 5245 5455 524e 533a  ted.    RETURNS:
-00011730: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
-00011740: 2d2d 2d2d 2d0a 2020 2020 6476 3a20 5265  -----.    dv: Re
-00011750: 6c61 7469 7665 2076 656c 6f63 6974 7920  lative velocity 
-00011760: 6368 616e 6765 2064 762f 7620 2869 6e20  change dv/v (in 
-00011770: 2529 0a20 2020 2063 633a 2063 6f72 7265  %).    cc: corre
-00011780: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
-00011790: 6e74 2062 6574 7765 656e 2074 6865 2072  nt between the r
-000117a0: 6566 6572 656e 6365 2077 6176 6566 6f72  eference wavefor
-000117b0: 6d20 616e 6420 7468 6520 6265 7374 2073  m and the best s
-000117c0: 7472 6574 6368 6564 2f63 6f6d 7072 6573  tretched/compres
-000117d0: 7365 6420 6375 7272 656e 7420 7761 7665  sed current wave
-000117e0: 666f 726d 0a20 2020 2063 6470 3a20 636f  form.    cdp: co
-000117f0: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
-00011800: 6369 656e 7420 6265 7477 6565 6e20 7468  cient between th
-00011810: 6520 7265 6665 7265 6e63 6520 7761 7665  e reference wave
-00011820: 666f 726d 2061 6e64 2074 6865 2069 6e69  form and the ini
-00011830: 7469 616c 2063 7572 7265 6e74 2077 6176  tial current wav
-00011840: 6566 6f72 6d0a 2020 2020 6572 726f 723a  eform.    error:
-00011850: 2045 7272 6f72 7320 696e 2074 6865 2064   Errors in the d
-00011860: 762f 7620 6d65 6173 7572 656d 656e 7473  v/v measurements
-00011870: 2062 6173 6564 206f 6e20 5765 6176 6572   based on Weaver
-00011880: 2065 7420 616c 2028 3230 3131 292c 0a20   et al (2011),. 
-00011890: 2020 204f 6e20 7468 6520 7072 6563 6973     On the precis
-000118a0: 696f 6e20 6f66 206e 6f69 7365 2d63 6f72  ion of noise-cor
-000118b0: 7265 6c61 7469 6f6e 2069 6e74 6572 6665  relation interfe
-000118c0: 726f 6d65 7472 792c 2047 656f 7068 7973  rometry, Geophys
-000118d0: 2e20 4a2e 2049 6e74 2e2c 2031 3835 2833  . J. Int., 185(3
-000118e0: 290a 0a20 2020 204e 6f74 653a 2054 6865  )..    Note: The
-000118f0: 2063 6f64 6520 6669 7273 7420 6669 6e64   code first find
-00011900: 7320 7468 6520 6265 7374 2063 6f72 7265  s the best corre
-00011910: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
-00011920: 6e74 2062 6574 7765 656e 2074 6865 2052  nt between the R
-00011930: 6566 6572 656e 6365 2077 6176 6566 6f72  eference wavefor
-00011940: 6d20 616e 640a 2020 2020 7468 6520 7374  m and.    the st
-00011950: 7265 7463 6865 642f 636f 6d70 7265 7373  retched/compress
-00011960: 6564 2063 7572 7265 6e74 2077 6176 6566  ed current wavef
-00011970: 6f72 6d20 616d 6f6e 6720 7468 6520 226e  orm among the "n
-00011980: 6274 7269 616c 2220 7661 6c75 6573 2e0a  btrial" values..
-00011990: 2020 2020 4120 7265 6669 6e65 6420 616e      A refined an
-000119a0: 616c 7973 6973 2069 7320 7468 656e 2070  alysis is then p
-000119b0: 6572 666f 726d 6564 2061 726f 756e 6420  erformed around 
-000119c0: 7468 6973 2076 616c 7565 2074 6f20 6f62  this value to ob
-000119d0: 7461 696e 2061 206d 6f72 6520 7072 6563  tain a more prec
-000119e0: 6973 6520 6476 2f76 206d 6561 7375 7265  ise dv/v measure
-000119f0: 6d65 6e74 202e 0a0a 2020 2020 4f72 6967  ment ...    Orig
-00011a00: 696e 616c 6c79 2062 7920 4c2e 2056 6965  inally by L. Vie
-00011a10: 6e73 2030 342f 3236 2f32 3031 3820 2856  ns 04/26/2018 (V
-00011a20: 6965 6e73 2065 7420 616c 2e2c 2032 3031  iens et al., 201
-00011a30: 3820 4a47 5229 0a20 2020 206d 6f64 6966  8 JGR).    modif
-00011a40: 6965 6420 6279 2043 6865 6e67 7869 6e20  ied by Chengxin 
-00011a50: 4a69 616e 670a 2020 2020 2222 220a 2020  Jiang.    """.  
-00011a60: 2020 2320 6c6f 6164 2063 6f6d 6d6f 6e20    # load common 
-00011a70: 7661 7269 6162 6c65 7320 6672 6f6d 2064  variables from d
-00011a80: 6963 7469 6f6e 6172 790a 2020 2020 7477  ictionary.    tw
-00011a90: 696e 203d 2070 6172 615b 2274 7769 6e22  in = para["twin"
-00011aa0: 5d0a 2020 2020 6672 6571 203d 2070 6172  ].    freq = par
-00011ab0: 615b 2266 7265 7122 5d0a 2020 2020 6474  a["freq"].    dt
-00011ac0: 203d 2070 6172 615b 2264 7422 5d0a 2020   = para["dt"].  
-00011ad0: 2020 746d 696e 203d 206e 702e 6d69 6e28    tmin = np.min(
-00011ae0: 7477 696e 290a 2020 2020 746d 6178 203d  twin).    tmax =
-00011af0: 206e 702e 6d61 7828 7477 696e 290a 2020   np.max(twin).  
-00011b00: 2020 666d 696e 203d 206e 702e 6d69 6e28    fmin = np.min(
-00011b10: 6672 6571 290a 2020 2020 666d 6178 203d  freq).    fmax =
-00011b20: 206e 702e 6d61 7828 6672 6571 290a 2020   np.max(freq).  
-00011b30: 2020 7476 6563 203d 206e 702e 6172 616e    tvec = np.aran
-00011b40: 6765 2874 6d69 6e2c 2074 6d61 782c 2064  ge(tmin, tmax, d
-00011b50: 7429 0a0a 2020 2020 2320 6d61 6b65 2075  t)..    # make u
-00011b60: 7365 6675 6c20 6f6e 6520 666f 7220 6d65  seful one for me
-00011b70: 6173 7572 656d 656e 7473 0a20 2020 2064  asurements.    d
-00011b80: 766d 696e 203d 202d 6e70 2e61 6273 2864  vmin = -np.abs(d
-00011b90: 765f 7261 6e67 6529 0a20 2020 2064 766d  v_range).    dvm
-00011ba0: 6178 203d 206e 702e 6162 7328 6476 5f72  ax = np.abs(dv_r
-00011bb0: 616e 6765 290a 2020 2020 4570 7320 3d20  ange).    Eps = 
-00011bc0: 3120 2b20 286e 702e 6c69 6e73 7061 6365  1 + (np.linspace
-00011bd0: 2864 766d 696e 2c20 6476 6d61 782c 206e  (dvmin, dvmax, n
-00011be0: 6274 7269 616c 2929 0a20 2020 2063 6f66  btrial)).    cof
-00011bf0: 203d 206e 702e 7a65 726f 7328 4570 732e   = np.zeros(Eps.
-00011c00: 7368 6170 652c 2064 7479 7065 3d6e 702e  shape, dtype=np.
-00011c10: 666c 6f61 7433 3229 0a0a 2020 2020 2320  float32)..    # 
-00011c20: 5365 7420 6f66 2073 7472 6574 6368 6564  Set of stretched
-00011c30: 2f63 6f6d 7072 6573 7365 6420 6375 7272  /compressed curr
-00011c40: 656e 7420 7761 7665 666f 726d 730a 2020  ent waveforms.  
-00011c50: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-00011c60: 6528 6c65 6e28 4570 7329 293a 0a20 2020  e(len(Eps)):.   
-00011c70: 2020 2020 206e 7420 3d20 7476 6563 202a       nt = tvec *
-00011c80: 2045 7073 5b69 695d 0a20 2020 2020 2020   Eps[ii].       
-00011c90: 2073 203d 206e 702e 696e 7465 7270 2878   s = np.interp(x
-00011ca0: 3d74 7665 632c 2078 703d 6e74 2c20 6670  =tvec, xp=nt, fp
-00011cb0: 3d63 7572 290a 2020 2020 2020 2020 7761  =cur).        wa
-00011cc0: 7665 666f 726d 5f72 6566 203d 2072 6566  veform_ref = ref
-00011cd0: 0a20 2020 2020 2020 2077 6176 6566 6f72  .        wavefor
-00011ce0: 6d5f 6375 7220 3d20 730a 2020 2020 2020  m_cur = s.      
-00011cf0: 2020 636f 665b 6969 5d20 3d20 6e70 2e63    cof[ii] = np.c
-00011d00: 6f72 7263 6f65 6628 7761 7665 666f 726d  orrcoef(waveform
-00011d10: 5f72 6566 2c20 7761 7665 666f 726d 5f63  _ref, waveform_c
-00011d20: 7572 295b 302c 2031 5d0a 0a20 2020 2063  ur)[0, 1]..    c
-00011d30: 6470 203d 206e 702e 636f 7272 636f 6566  dp = np.corrcoef
-00011d40: 2863 7572 2c20 7265 6629 5b30 2c20 315d  (cur, ref)[0, 1]
-00011d50: 2020 2320 636f 7272 656c 6174 696f 6e20    # correlation 
-00011d60: 636f 6566 6669 6369 656e 7420 6265 7477  coefficient betw
-00011d70: 6565 6e20 7468 6520 7265 6665 7265 6e63  een the referenc
-00011d80: 6520 616e 6420 696e 6974 6961 6c20 6375  e and initial cu
-00011d90: 7272 656e 7420 7761 7665 666f 726d 730a  rrent waveforms.
-00011da0: 0a20 2020 2023 2066 696e 6420 7468 6520  .    # find the 
-00011db0: 6d61 7869 6d75 6d20 636f 7272 656c 6174  maximum correlat
-00011dc0: 696f 6e20 636f 6566 6669 6369 656e 740a  ion coefficient.
-00011dd0: 2020 2020 696d 6178 203d 206e 702e 6e61      imax = np.na
-00011de0: 6e61 7267 6d61 7828 636f 6629 0a20 2020  nargmax(cof).   
-00011df0: 2069 6620 696d 6178 203e 3d20 6c65 6e28   if imax >= len(
-00011e00: 4570 7329 202d 2032 3a0a 2020 2020 2020  Eps) - 2:.      
-00011e10: 2020 696d 6178 203d 2069 6d61 7820 2d20    imax = imax - 
-00011e20: 320a 2020 2020 6966 2069 6d61 7820 3c3d  2.    if imax <=
-00011e30: 2032 3a0a 2020 2020 2020 2020 696d 6178   2:.        imax
-00011e40: 203d 2069 6d61 7820 2b20 320a 0a20 2020   = imax + 2..   
-00011e50: 2023 2050 726f 6365 6564 2074 6f20 7468   # Proceed to th
-00011e60: 6520 7365 636f 6e64 2073 7465 7020 746f  e second step to
-00011e70: 2067 6574 2061 206d 6f72 6520 7072 6563   get a more prec
-00011e80: 6973 6520 6476 2f76 206d 6561 7375 7265  ise dv/v measure
-00011e90: 6d65 6e74 0a20 2020 2064 7466 696e 6572  ment.    dtfiner
-00011ea0: 203d 206e 702e 6c69 6e73 7061 6365 2845   = np.linspace(E
-00011eb0: 7073 5b69 6d61 7820 2d20 325d 2c20 4570  ps[imax - 2], Ep
-00011ec0: 735b 696d 6178 202b 2032 5d2c 2031 3030  s[imax + 2], 100
-00011ed0: 290a 2020 2020 6e63 6f66 203d 206e 702e  ).    ncof = np.
-00011ee0: 7a65 726f 7328 6474 6669 6e65 722e 7368  zeros(dtfiner.sh
-00011ef0: 6170 652c 2064 7479 7065 3d6e 702e 666c  ape, dtype=np.fl
-00011f00: 6f61 7433 3229 0a20 2020 2066 6f72 2069  oat32).    for i
-00011f10: 6920 696e 2072 616e 6765 286c 656e 2864  i in range(len(d
-00011f20: 7466 696e 6572 2929 3a0a 2020 2020 2020  tfiner)):.      
-00011f30: 2020 6e74 203d 2074 7665 6320 2a20 6474    nt = tvec * dt
-00011f40: 6669 6e65 725b 6969 5d0a 2020 2020 2020  finer[ii].      
-00011f50: 2020 7320 3d20 6e70 2e69 6e74 6572 7028    s = np.interp(
-00011f60: 783d 7476 6563 2c20 7870 3d6e 742c 2066  x=tvec, xp=nt, f
-00011f70: 703d 6375 7229 0a20 2020 2020 2020 2077  p=cur).        w
-00011f80: 6176 6566 6f72 6d5f 7265 6620 3d20 7265  aveform_ref = re
-00011f90: 660a 2020 2020 2020 2020 7761 7665 666f  f.        wavefo
-00011fa0: 726d 5f63 7572 203d 2073 0a20 2020 2020  rm_cur = s.     
-00011fb0: 2020 206e 636f 665b 6969 5d20 3d20 6e70     ncof[ii] = np
-00011fc0: 2e63 6f72 7263 6f65 6628 7761 7665 666f  .corrcoef(wavefo
-00011fd0: 726d 5f72 6566 2c20 7761 7665 666f 726d  rm_ref, waveform
-00011fe0: 5f63 7572 295b 302c 2031 5d0a 0a20 2020  _cur)[0, 1]..   
-00011ff0: 2063 6320 3d20 6e70 2e6d 6178 286e 636f   cc = np.max(nco
-00012000: 6629 2020 2320 4669 6e64 206d 6178 696d  f)  # Find maxim
-00012010: 756d 2063 6f72 7265 6c61 7469 6f6e 2063  um correlation c
-00012020: 6f65 6666 6963 6965 6e74 206f 6620 7468  oefficient of th
-00012030: 6520 7265 6669 6e65 6420 2061 6e61 6c79  e refined  analy
-00012040: 7369 730a 2020 2020 6476 203d 2031 3030  sis.    dv = 100
-00012050: 2e30 202a 2064 7466 696e 6572 5b6e 702e  .0 * dtfiner[np.
-00012060: 6172 676d 6178 286e 636f 6629 5d20 2d20  argmax(ncof)] - 
-00012070: 3130 3020 2023 204d 756c 7469 706c 7920  100  # Multiply 
-00012080: 6279 2031 3030 2074 6f20 636f 6e76 6572  by 100 to conver
-00012090: 7420 746f 2070 6572 6365 6e74 6167 6520  t to percentage 
-000120a0: 2845 7073 696c 6f6e 203d 202d 6474 2f74  (Epsilon = -dt/t
-000120b0: 203d 2064 762f 7629 0a0a 2020 2020 2320   = dv/v)..    # 
-000120c0: 4572 726f 7220 636f 6d70 7574 6174 696f  Error computatio
-000120d0: 6e20 6261 7365 6420 6f6e 2057 6561 7665  n based on Weave
-000120e0: 7220 6574 2061 6c20 2832 3031 3129 2c20  r et al (2011), 
-000120f0: 4f6e 2074 6865 2070 7265 6369 7369 6f6e  On the precision
-00012100: 206f 6620 6e6f 6973 652d 636f 7272 656c   of noise-correl
-00012110: 6174 696f 6e0a 2020 2020 2320 696e 7465  ation.    # inte
-00012120: 7266 6572 6f6d 6574 7279 2c20 4765 6f70  rferometry, Geop
-00012130: 6879 732e 204a 2e20 496e 742e 2c20 3138  hys. J. Int., 18
-00012140: 3528 3329 0a20 2020 2054 203d 2031 202f  5(3).    T = 1 /
-00012150: 2028 666d 6178 202d 2066 6d69 6e29 0a20   (fmax - fmin). 
-00012160: 2020 2058 203d 2063 630a 2020 2020 7763     X = cc.    wc
-00012170: 203d 206e 702e 7069 202a 2028 666d 696e   = np.pi * (fmin
-00012180: 202b 2066 6d61 7829 0a20 2020 2074 3120   + fmax).    t1 
-00012190: 3d20 6e70 2e6d 696e 285b 746d 696e 2c20  = np.min([tmin, 
-000121a0: 746d 6178 5d29 0a20 2020 2074 3220 3d20  tmax]).    t2 = 
-000121b0: 6e70 2e6d 6178 285b 746d 696e 2c20 746d  np.max([tmin, tm
-000121c0: 6178 5d29 0a20 2020 2065 7272 6f72 203d  ax]).    error =
-000121d0: 2031 3030 202a 2028 0a20 2020 2020 2020   100 * (.       
-000121e0: 206e 702e 7371 7274 2831 202d 2058 2a2a   np.sqrt(1 - X**
-000121f0: 3229 202f 2028 3220 2a20 5829 202a 206e  2) / (2 * X) * n
-00012200: 702e 7371 7274 2828 3620 2a20 6e70 2e73  p.sqrt((6 * np.s
-00012210: 7172 7428 6e70 2e70 6920 2f20 3229 202a  qrt(np.pi / 2) *
-00012220: 2054 2920 2f20 2877 632a 2a32 202a 2028   T) / (wc**2 * (
-00012230: 7432 2a2a 3320 2d20 7431 2a2a 3329 2929  t2**3 - t1**3)))
-00012240: 0a20 2020 2029 0a0a 2020 2020 7265 7475  .    )..    retu
-00012250: 726e 2064 762c 2065 7272 6f72 2c20 6363  rn dv, error, cc
-00012260: 2c20 6364 700a 0a0a 6465 6620 7374 7265  , cdp...def stre
-00012270: 7463 6869 6e67 5f76 6563 7428 7265 662c  tching_vect(ref,
-00012280: 2063 7572 2c20 6476 5f72 616e 6765 2c20   cur, dv_range, 
-00012290: 6e62 7472 6961 6c2c 2070 6172 6129 3a0a  nbtrial, para):.
-000122a0: 2020 2020 2222 220a 2020 2020 5468 6973      """.    This
-000122b0: 2066 756e 6374 696f 6e20 636f 6d70 6172   function compar
-000122c0: 6573 2074 6865 2052 6566 6572 656e 6365  es the Reference
-000122d0: 2077 6176 6566 6f72 6d20 746f 2073 7472   waveform to str
-000122e0: 6574 6368 6564 2f63 6f6d 7072 6573 7365  etched/compresse
-000122f0: 6420 6375 7272 656e 7420 7761 7665 666f  d current wavefo
-00012300: 726d 730a 2020 2020 746f 2067 6574 2074  rms.    to get t
-00012310: 6865 2072 656c 6174 6976 6520 7365 6973  he relative seis
-00012320: 6d69 6320 7665 6c6f 6369 7479 2076 6172  mic velocity var
-00012330: 6961 7469 6f6e 2028 616e 6420 6173 736f  iation (and asso
-00012340: 6369 6174 6564 2065 7272 6f72 292e 0a20  ciated error).. 
-00012350: 2020 2049 7420 616c 736f 2063 6f6d 7075     It also compu
-00012360: 7465 7320 7468 6520 636f 7272 656c 6174  tes the correlat
-00012370: 696f 6e20 636f 6566 6669 6369 656e 7420  ion coefficient 
-00012380: 6265 7477 6565 6e20 7468 6520 5265 6665  between the Refe
-00012390: 7265 6e63 6520 7761 7665 666f 726d 2061  rence waveform a
-000123a0: 6e64 2074 6865 2063 7572 7265 6e74 2077  nd the current w
-000123b0: 6176 6566 6f72 6d2e 0a0a 2020 2020 5041  aveform...    PA
-000123c0: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
-000123d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-000123e0: 2020 2072 6566 3a20 5265 6665 7265 6e63     ref: Referenc
-000123f0: 6520 7761 7665 666f 726d 2028 6e70 2e6e  e waveform (np.n
-00012400: 6461 7272 6179 2c20 7369 7a65 204e 290a  darray, size N).
-00012410: 2020 2020 6375 723a 2043 7572 7265 6e74      cur: Current
-00012420: 2077 6176 6566 6f72 6d20 286e 702e 6e64   waveform (np.nd
-00012430: 6172 7261 792c 2073 697a 6520 4e29 0a20  array, size N). 
-00012440: 2020 2064 765f 7261 6e67 653a 2061 6273     dv_range: abs
-00012450: 6f6c 7574 6520 626f 756e 6420 666f 7220  olute bound for 
-00012460: 7468 6520 7665 6c6f 6369 7479 2076 6172  the velocity var
-00012470: 6961 7469 6f6e 3b20 6578 616d 706c 653a  iation; example:
-00012480: 2064 763d 302e 3033 2066 6f72 205b 2d33   dv=0.03 for [-3
-00012490: 2c33 5d25 0a20 2020 206f 6620 7265 6c61  ,3]%.    of rela
-000124a0: 7469 7665 2076 656c 6f63 6974 7920 6368  tive velocity ch
-000124b0: 616e 6765 2028 2766 6c6f 6174 2729 0a20  ange ('float'). 
-000124c0: 2020 206e 6274 7269 616c 3a20 6e75 6d62     nbtrial: numb
-000124d0: 6572 206f 6620 7374 7265 7463 6869 6e67  er of stretching
-000124e0: 2063 6f65 6666 6963 6965 6e74 2062 6574   coefficient bet
-000124f0: 7765 656e 2064 766d 696e 2061 6e64 2064  ween dvmin and d
-00012500: 766d 6178 2c20 6e6f 206e 6565 6420 746f  vmax, no need to
-00012510: 2062 6520 6869 6768 6572 2074 6861 6e20   be higher than 
-00012520: 3130 3020 2028 2766 6c6f 6174 2729 0a20  100  ('float'). 
-00012530: 2020 2070 6172 613a 2076 6563 746f 7220     para: vector 
-00012540: 6f66 2074 6865 2069 6e64 6963 6573 206f  of the indices o
-00012550: 6620 7468 6520 6375 7220 616e 6420 7265  f the cur and re
-00012560: 6620 7769 6e64 6f77 7320 6f6e 2077 6963  f windows on wic
-00012570: 6820 796f 7520 7761 6e74 2074 6f20 646f  h you want to do
-00012580: 2074 6865 0a20 2020 206d 6561 7375 7265   the.    measure
-00012590: 6d65 6e74 7320 286e 702e 6e64 6172 7261  ments (np.ndarra
-000125a0: 792c 2073 697a 6520 746d 696e 2a64 656c  y, size tmin*del
-000125b0: 7461 3a74 6d61 782a 6465 6c74 6129 0a20  ta:tmax*delta). 
-000125c0: 2020 2046 6f72 2065 7272 6f72 2063 6f6d     For error com
-000125d0: 7075 7461 7469 6f6e 2c20 7765 206e 6565  putation, we nee
-000125e0: 6420 7061 7261 6d65 7465 7273 3a0a 2020  d parameters:.  
-000125f0: 2020 2020 2020 666d 696e 3a20 6d69 6e69        fmin: mini
-00012600: 6d75 6d20 6672 6571 7565 6e63 7920 6f66  mum frequency of
-00012610: 2074 6865 2064 6174 610a 2020 2020 2020   the data.      
-00012620: 2020 666d 6178 3a20 6d61 7869 6d75 6d20    fmax: maximum 
-00012630: 6672 6571 7565 6e63 7920 6f66 2074 6865  frequency of the
-00012640: 2064 6174 610a 2020 2020 2020 2020 746d   data.        tm
-00012650: 696e 3a20 6d69 6e69 6d75 6d20 7469 6d65  in: minimum time
-00012660: 2077 696e 646f 7720 7768 6572 6520 7468   window where th
-00012670: 6520 6476 2f76 2069 7320 636f 6d70 7574  e dv/v is comput
-00012680: 6564 0a20 2020 2020 2020 2074 6d61 783a  ed.        tmax:
-00012690: 206d 6178 696d 756d 2074 696d 6520 7769   maximum time wi
-000126a0: 6e64 6f77 2077 6865 7265 2074 6865 2064  ndow where the d
-000126b0: 762f 7620 6973 2063 6f6d 7075 7465 640a  v/v is computed.
-000126c0: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-000126d0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-000126e0: 2d0a 2020 2020 6476 3a20 5265 6c61 7469  -.    dv: Relati
-000126f0: 7665 2076 656c 6f63 6974 7920 6368 616e  ve velocity chan
-00012700: 6765 2064 762f 7620 2869 6e20 2529 0a20  ge dv/v (in %). 
-00012710: 2020 2063 633a 2063 6f72 7265 6c61 7469     cc: correlati
-00012720: 6f6e 2063 6f65 6666 6963 6965 6e74 2062  on coefficient b
-00012730: 6574 7765 656e 2074 6865 2072 6566 6572  etween the refer
-00012740: 656e 6365 2077 6176 6566 6f72 6d20 616e  ence waveform an
-00012750: 6420 7468 6520 6265 7374 2073 7472 6574  d the best stret
-00012760: 6368 6564 2f63 6f6d 7072 6573 7365 6420  ched/compressed 
-00012770: 6375 7272 656e 7420 7761 7665 666f 726d  current waveform
-00012780: 0a20 2020 2063 6470 3a20 636f 7272 656c  .    cdp: correl
-00012790: 6174 696f 6e20 636f 6566 6669 6369 656e  ation coefficien
-000127a0: 7420 6265 7477 6565 6e20 7468 6520 7265  t between the re
-000127b0: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
-000127c0: 2061 6e64 2074 6865 2069 6e69 7469 616c   and the initial
-000127d0: 2063 7572 7265 6e74 2077 6176 6566 6f72   current wavefor
-000127e0: 6d0a 2020 2020 6572 726f 723a 2045 7272  m.    error: Err
-000127f0: 6f72 7320 696e 2074 6865 2064 762f 7620  ors in the dv/v 
-00012800: 6d65 6173 7572 656d 656e 7473 2062 6173  measurements bas
-00012810: 6564 206f 6e20 5765 6176 6572 2065 7420  ed on Weaver et 
-00012820: 616c 2028 3230 3131 292c 204f 6e20 7468  al (2011), On th
-00012830: 6520 7072 6563 6973 696f 6e0a 2020 2020  e precision.    
-00012840: 6f66 206e 6f69 7365 2d63 6f72 7265 6c61  of noise-correla
-00012850: 7469 6f6e 2069 6e74 6572 6665 726f 6d65  tion interferome
-00012860: 7472 792c 2047 656f 7068 7973 2e20 4a2e  try, Geophys. J.
-00012870: 2049 6e74 2e2c 2031 3835 2833 290a 0a20   Int., 185(3).. 
-00012880: 2020 204e 6f74 653a 2054 6865 2063 6f64     Note: The cod
-00012890: 6520 6669 7273 7420 6669 6e64 7320 7468  e first finds th
-000128a0: 6520 6265 7374 2063 6f72 7265 6c61 7469  e best correlati
-000128b0: 6f6e 2063 6f65 6666 6963 6965 6e74 2062  on coefficient b
-000128c0: 6574 7765 656e 2074 6865 2052 6566 6572  etween the Refer
-000128d0: 656e 6365 2077 6176 6566 6f72 6d20 616e  ence waveform an
-000128e0: 640a 2020 2020 7468 6520 7374 7265 7463  d.    the stretc
-000128f0: 6865 642f 636f 6d70 7265 7373 6564 2063  hed/compressed c
-00012900: 7572 7265 6e74 2077 6176 6566 6f72 6d20  urrent waveform 
-00012910: 616d 6f6e 6720 7468 6520 226e 6274 7269  among the "nbtri
-00012920: 616c 2220 7661 6c75 6573 2e0a 2020 2020  al" values..    
-00012930: 4120 7265 6669 6e65 6420 616e 616c 7973  A refined analys
-00012940: 6973 2069 7320 7468 656e 2070 6572 666f  is is then perfo
-00012950: 726d 6564 2061 726f 756e 6420 7468 6973  rmed around this
-00012960: 2076 616c 7565 2074 6f20 6f62 7461 696e   value to obtain
-00012970: 2061 206d 6f72 6520 7072 6563 6973 6520   a more precise 
-00012980: 6476 2f76 206d 6561 7375 7265 6d65 6e74  dv/v measurement
-00012990: 202e 0a0a 2020 2020 4f72 6967 696e 616c   ...    Original
-000129a0: 6c79 2062 7920 4c2e 2056 6965 6e73 2030  ly by L. Viens 0
-000129b0: 342f 3236 2f32 3031 3820 2856 6965 6e73  4/26/2018 (Viens
-000129c0: 2065 7420 616c 2e2c 2032 3031 3820 4a47   et al., 2018 JG
-000129d0: 5229 0a20 2020 206d 6f64 6966 6965 6420  R).    modified 
-000129e0: 6279 2043 6865 6e67 7869 6e20 4a69 616e  by Chengxin Jian
-000129f0: 670a 2020 2020 6d6f 6469 6669 6564 2062  g.    modified b
-00012a00: 7920 4c61 7572 6120 4572 6d65 7274 3a20  y Laura Ermert: 
-00012a10: 7665 6374 6f72 697a 6564 2076 6572 7369  vectorized versi
-00012a20: 6f6e 0a20 2020 2022 2222 0a20 2020 2023  on.    """.    #
-00012a30: 206c 6f61 6420 636f 6d6d 6f6e 2076 6172   load common var
-00012a40: 6961 626c 6573 2066 726f 6d20 6469 6374  iables from dict
-00012a50: 696f 6e61 7279 0a20 2020 2074 7769 6e20  ionary.    twin 
-00012a60: 3d20 7061 7261 5b22 7477 696e 225d 0a20  = para["twin"]. 
-00012a70: 2020 2066 7265 7120 3d20 7061 7261 5b22     freq = para["
-00012a80: 6672 6571 225d 0a20 2020 2064 7420 3d20  freq"].    dt = 
-00012a90: 7061 7261 5b22 6474 225d 0a20 2020 2074  para["dt"].    t
-00012aa0: 6d69 6e20 3d20 6e70 2e6d 696e 2874 7769  min = np.min(twi
-00012ab0: 6e29 0a20 2020 2074 6d61 7820 3d20 6e70  n).    tmax = np
-00012ac0: 2e6d 6178 2874 7769 6e29 0a20 2020 2066  .max(twin).    f
-00012ad0: 6d69 6e20 3d20 6e70 2e6d 696e 2866 7265  min = np.min(fre
-00012ae0: 7129 0a20 2020 2066 6d61 7820 3d20 6e70  q).    fmax = np
-00012af0: 2e6d 6178 2866 7265 7129 0a20 2020 2074  .max(freq).    t
-00012b00: 7665 6320 3d20 6e70 2e61 7261 6e67 6528  vec = np.arange(
-00012b10: 746d 696e 2c20 746d 6178 2c20 6474 290a  tmin, tmax, dt).
-00012b20: 0a20 2020 2023 206d 616b 6520 7573 6566  .    # make usef
-00012b30: 756c 206f 6e65 2066 6f72 206d 6561 7375  ul one for measu
-00012b40: 7265 6d65 6e74 730a 2020 2020 6476 6d69  rements.    dvmi
-00012b50: 6e20 3d20 2d6e 702e 6162 7328 6476 5f72  n = -np.abs(dv_r
-00012b60: 616e 6765 290a 2020 2020 6476 6d61 7820  ange).    dvmax 
-00012b70: 3d20 6e70 2e61 6273 2864 765f 7261 6e67  = np.abs(dv_rang
-00012b80: 6529 0a20 2020 2045 7073 203d 2031 202b  e).    Eps = 1 +
-00012b90: 2028 6e70 2e6c 696e 7370 6163 6528 6476   (np.linspace(dv
-00012ba0: 6d69 6e2c 2064 766d 6178 2c20 6e62 7472  min, dvmax, nbtr
-00012bb0: 6961 6c29 290a 2020 2020 6364 7020 3d20  ial)).    cdp = 
-00012bc0: 6e70 2e63 6f72 7263 6f65 6628 6375 722c  np.corrcoef(cur,
-00012bd0: 2072 6566 295b 302c 2031 5d20 2023 2063   ref)[0, 1]  # c
-00012be0: 6f72 7265 6c61 7469 6f6e 2063 6f65 6666  orrelation coeff
-00012bf0: 6963 6965 6e74 2062 6574 7765 656e 2074  icient between t
-00012c00: 6865 2072 6566 6572 656e 6365 2061 6e64  he reference and
-00012c10: 2069 6e69 7469 616c 2063 7572 7265 6e74   initial current
-00012c20: 2077 6176 6566 6f72 6d73 0a20 2020 2077   waveforms.    w
-00012c30: 6176 6566 6f72 6d73 203d 206e 702e 7a65  aveforms = np.ze
-00012c40: 726f 7328 286e 6274 7269 616c 202b 2031  ros((nbtrial + 1
-00012c50: 2c20 6c65 6e28 7265 6629 2929 0a20 2020  , len(ref))).   
-00012c60: 2077 6176 6566 6f72 6d73 5b30 2c20 3a5d   waveforms[0, :]
-00012c70: 203d 2072 6566 0a0a 2020 2020 2320 5365   = ref..    # Se
-00012c80: 7420 6f66 2073 7472 6574 6368 6564 2f63  t of stretched/c
-00012c90: 6f6d 7072 6573 7365 6420 6375 7272 656e  ompressed curren
-00012ca0: 7420 7761 7665 666f 726d 730a 2020 2020  t waveforms.    
-00012cb0: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-00012cc0: 6e62 7472 6961 6c29 3a0a 2020 2020 2020  nbtrial):.      
-00012cd0: 2020 6e74 203d 2074 7665 6320 2a20 4570    nt = tvec * Ep
-00012ce0: 735b 6969 5d0a 2020 2020 2020 2020 7320  s[ii].        s 
-00012cf0: 3d20 6e70 2e69 6e74 6572 7028 783d 7476  = np.interp(x=tv
-00012d00: 6563 2c20 7870 3d6e 742c 2066 703d 6375  ec, xp=nt, fp=cu
-00012d10: 7229 0a20 2020 2020 2020 2077 6176 6566  r).        wavef
-00012d20: 6f72 6d73 5b69 6920 2b20 312c 203a 5d20  orms[ii + 1, :] 
-00012d30: 3d20 730a 2020 2020 636f 6620 3d20 6e70  = s.    cof = np
-00012d40: 2e63 6f72 7263 6f65 6628 7761 7665 666f  .corrcoef(wavefo
-00012d50: 726d 7329 5b30 5d5b 313a 5d0a 0a20 2020  rms)[0][1:]..   
-00012d60: 2023 2066 696e 6420 7468 6520 6d61 7869   # find the maxi
-00012d70: 6d75 6d20 636f 7272 656c 6174 696f 6e20  mum correlation 
-00012d80: 636f 6566 6669 6369 656e 740a 2020 2020  coefficient.    
-00012d90: 696d 6178 203d 206e 702e 6e61 6e61 7267  imax = np.nanarg
-00012da0: 6d61 7828 636f 6629 0a20 2020 2069 6620  max(cof).    if 
-00012db0: 696d 6178 203e 3d20 6c65 6e28 4570 7329  imax >= len(Eps)
-00012dc0: 202d 2032 3a0a 2020 2020 2020 2020 696d   - 2:.        im
-00012dd0: 6178 203d 2069 6d61 7820 2d20 320a 2020  ax = imax - 2.  
-00012de0: 2020 6966 2069 6d61 7820 3c20 323a 0a20    if imax < 2:. 
-00012df0: 2020 2020 2020 2069 6d61 7820 3d20 696d         imax = im
-00012e00: 6178 202b 2032 0a0a 2020 2020 2320 5072  ax + 2..    # Pr
-00012e10: 6f63 6565 6420 746f 2074 6865 2073 6563  oceed to the sec
-00012e20: 6f6e 6420 7374 6570 2074 6f20 6765 7420  ond step to get 
-00012e30: 6120 6d6f 7265 2070 7265 6369 7365 2064  a more precise d
-00012e40: 762f 7620 6d65 6173 7572 656d 656e 740a  v/v measurement.
-00012e50: 2020 2020 6474 6669 6e65 7220 3d20 6e70      dtfiner = np
-00012e60: 2e6c 696e 7370 6163 6528 4570 735b 696d  .linspace(Eps[im
-00012e70: 6178 202d 2032 5d2c 2045 7073 5b69 6d61  ax - 2], Eps[ima
-00012e80: 7820 2b20 325d 2c20 6e62 7472 6961 6c29  x + 2], nbtrial)
-00012e90: 0a20 2020 2023 206e 636f 6620 2020 203d  .    # ncof    =
-00012ea0: 206e 702e 7a65 726f 7328 6474 6669 6e65   np.zeros(dtfine
-00012eb0: 722e 7368 6170 652c 6474 7970 653d 6e70  r.shape,dtype=np
-00012ec0: 2e66 6c6f 6174 3332 290a 2020 2020 7761  .float32).    wa
-00012ed0: 7665 666f 726d 7320 3d20 6e70 2e7a 6572  veforms = np.zer
-00012ee0: 6f73 2828 6e62 7472 6961 6c20 2b20 312c  os((nbtrial + 1,
-00012ef0: 206c 656e 2872 6566 2929 290a 2020 2020   len(ref))).    
-00012f00: 7761 7665 666f 726d 735b 302c 203a 5d20  waveforms[0, :] 
-00012f10: 3d20 7265 660a 2020 2020 666f 7220 6969  = ref.    for ii
-00012f20: 2069 6e20 7261 6e67 6528 6c65 6e28 6474   in range(len(dt
-00012f30: 6669 6e65 7229 293a 0a20 2020 2020 2020  finer)):.       
-00012f40: 206e 7420 3d20 7476 6563 202a 2064 7466   nt = tvec * dtf
-00012f50: 696e 6572 5b69 695d 0a20 2020 2020 2020  iner[ii].       
-00012f60: 2073 203d 206e 702e 696e 7465 7270 2878   s = np.interp(x
-00012f70: 3d74 7665 632c 2078 703d 6e74 2c20 6670  =tvec, xp=nt, fp
-00012f80: 3d63 7572 290a 2020 2020 2020 2020 7761  =cur).        wa
-00012f90: 7665 666f 726d 735b 6969 202b 2031 2c20  veforms[ii + 1, 
-00012fa0: 3a5d 203d 2073 0a20 2020 206e 636f 6620  :] = s.    ncof 
-00012fb0: 3d20 6e70 2e63 6f72 7263 6f65 6628 7761  = np.corrcoef(wa
-00012fc0: 7665 666f 726d 7329 5b30 5d5b 313a 5d0a  veforms)[0][1:].
-00012fd0: 2020 2020 6363 203d 206e 702e 6d61 7828      cc = np.max(
-00012fe0: 6e63 6f66 2920 2023 2046 696e 6420 6d61  ncof)  # Find ma
-00012ff0: 7869 6d75 6d20 636f 7272 656c 6174 696f  ximum correlatio
-00013000: 6e20 636f 6566 6669 6369 656e 7420 6f66  n coefficient of
-00013010: 2074 6865 2072 6566 696e 6564 2020 616e   the refined  an
-00013020: 616c 7973 6973 0a20 2020 2064 7620 3d20  alysis.    dv = 
-00013030: 3130 302e 3020 2a20 6474 6669 6e65 725b  100.0 * dtfiner[
-00013040: 6e70 2e61 7267 6d61 7828 6e63 6f66 295d  np.argmax(ncof)]
-00013050: 202d 2031 3030 2020 2320 4d75 6c74 6970   - 100  # Multip
-00013060: 6c79 2062 7920 3130 3020 746f 2063 6f6e  ly by 100 to con
-00013070: 7665 7274 2074 6f20 7065 7263 656e 7461  vert to percenta
-00013080: 6765 2028 4570 7369 6c6f 6e20 3d20 2d64  ge (Epsilon = -d
-00013090: 742f 7420 3d20 6476 2f76 290a 0a20 2020  t/t = dv/v)..   
-000130a0: 2023 2045 7272 6f72 2063 6f6d 7075 7461   # Error computa
-000130b0: 7469 6f6e 2062 6173 6564 206f 6e20 5765  tion based on We
-000130c0: 6176 6572 2065 7420 616c 2028 3230 3131  aver et al (2011
-000130d0: 292c 204f 6e20 7468 6520 7072 6563 6973  ), On the precis
-000130e0: 696f 6e20 6f66 206e 6f69 7365 2d63 6f72  ion of noise-cor
-000130f0: 7265 6c61 7469 6f6e 2069 6e74 6572 6665  relation interfe
-00013100: 726f 6d65 7472 792c 0a20 2020 2023 2047  rometry,.    # G
-00013110: 656f 7068 7973 2e20 4a2e 2049 6e74 2e2c  eophys. J. Int.,
-00013120: 2031 3835 2833 290a 2020 2020 5420 3d20   185(3).    T = 
-00013130: 3120 2f20 2866 6d61 7820 2d20 666d 696e  1 / (fmax - fmin
-00013140: 290a 2020 2020 5820 3d20 6363 0a20 2020  ).    X = cc.   
-00013150: 2077 6320 3d20 6e70 2e70 6920 2a20 2866   wc = np.pi * (f
-00013160: 6d69 6e20 2b20 666d 6178 290a 2020 2020  min + fmax).    
-00013170: 7431 203d 206e 702e 6d69 6e28 5b74 6d69  t1 = np.min([tmi
-00013180: 6e2c 2074 6d61 785d 290a 2020 2020 7432  n, tmax]).    t2
-00013190: 203d 206e 702e 6d61 7828 5b74 6d69 6e2c   = np.max([tmin,
-000131a0: 2074 6d61 785d 290a 2020 2020 6572 726f   tmax]).    erro
-000131b0: 7220 3d20 3130 3020 2a20 280a 2020 2020  r = 100 * (.    
-000131c0: 2020 2020 6e70 2e73 7172 7428 3120 2d20      np.sqrt(1 - 
-000131d0: 582a 2a32 2920 2f20 2832 202a 2058 2920  X**2) / (2 * X) 
-000131e0: 2a20 6e70 2e73 7172 7428 2836 202a 206e  * np.sqrt((6 * n
-000131f0: 702e 7371 7274 286e 702e 7069 202f 2032  p.sqrt(np.pi / 2
-00013200: 2920 2a20 5429 202f 2028 7763 2a2a 3220  ) * T) / (wc**2 
-00013210: 2a20 2874 322a 2a33 202d 2074 312a 2a33  * (t2**3 - t1**3
-00013220: 2929 290a 2020 2020 290a 0a20 2020 2072  ))).    )..    r
-00013230: 6574 7572 6e20 6476 2c20 6572 726f 722c  eturn dv, error,
-00013240: 2063 632c 2063 6470 0a0a 0a64 6566 2064   cc, cdp...def d
-00013250: 7477 5f64 7676 2872 6566 2c20 6375 722c  tw_dvv(ref, cur,
-00013260: 2070 6172 612c 206d 6178 4c61 672c 2062   para, maxLag, b
-00013270: 2c20 6469 7265 6374 696f 6e29 3a0a 2020  , direction):.  
-00013280: 2020 2222 220a 2020 2020 4479 6e61 6d69    """.    Dynami
-00013290: 6320 7469 6d65 2077 6172 7069 6e67 2066  c time warping f
-000132a0: 6f72 2064 762f 7620 6573 7469 6d61 7469  or dv/v estimati
-000132b0: 6f6e 2e0a 0a20 2020 2050 4152 414d 4554  on...    PARAMET
-000132c0: 4552 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ERS:.    -------
-000132d0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7265  ---------.    re
-000132e0: 6620 3a20 7265 6665 7265 6e63 6520 7369  f : reference si
-000132f0: 676e 616c 2028 6e70 2e61 7272 6179 2c20  gnal (np.array, 
-00013300: 7369 7a65 204e 290a 2020 2020 6375 7220  size N).    cur 
-00013310: 3a20 6375 7272 656e 7420 7369 676e 616c  : current signal
-00013320: 2028 6e70 2e61 7272 6179 2c20 7369 7a65   (np.array, size
-00013330: 204e 290a 2020 2020 7061 7261 3a20 6469   N).    para: di
-00013340: 6374 2063 6f6e 7461 696e 696e 6720 7573  ct containing us
-00013350: 6566 756c 2070 6172 616d 6574 6572 7320  eful parameters 
-00013360: 6162 6f75 7420 7468 6520 6461 7461 2077  about the data w
-00013370: 696e 646f 7720 616e 6420 7461 7267 6574  indow and target
-00013380: 6564 2066 7265 7175 656e 6379 0a20 2020  ed frequency.   
-00013390: 206d 6178 4c61 6720 3a20 6d61 7820 6e75   maxLag : max nu
-000133a0: 6d62 6572 206f 6620 706f 696e 7473 2074  mber of points t
-000133b0: 6f20 7365 6172 6368 2066 6f72 7761 7264  o search forward
-000133c0: 2061 6e64 2062 6163 6b77 6172 642e 0a20   and backward.. 
-000133d0: 2020 2020 2020 2020 2020 2053 7567 6765             Sugge
-000133e0: 7374 2073 6574 7469 6e67 2069 7420 6c61  st setting it la
-000133f0: 7267 6572 2069 6620 7769 6e64 6f77 2069  rger if window i
-00013400: 7320 7365 7420 6c61 7267 6572 2e0a 2020  s set larger..  
-00013410: 2020 6220 3a20 622d 7661 6c75 6520 746f    b : b-value to
-00013420: 206c 696d 6974 2073 7472 6169 6e2c 2077   limit strain, w
-00013430: 6869 6368 2069 7320 746f 206c 696d 6974  hich is to limit
-00013440: 2074 6865 206d 6178 696d 756d 2076 656c   the maximum vel
-00013450: 6f63 6974 7920 7065 7274 7572 6261 7469  ocity perturbati
-00013460: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-00013470: 5365 6520 6571 7561 7469 6f6e 2031 3120  See equation 11 
-00013480: 696e 2028 4d69 6b65 7365 6c6c 2065 7420  in (Mikesell et 
-00013490: 616c 2e20 3230 3135 290a 2020 2020 6469  al. 2015).    di
-000134a0: 7265 6374 696f 6e3a 2064 6972 6563 7469  rection: directi
-000134b0: 6f6e 2074 6f20 6163 6375 6d75 6c61 7465  on to accumulate
-000134c0: 2065 7272 6f72 7320 2831 3d66 6f72 7761   errors (1=forwa
-000134d0: 7264 2c20 2d31 3d62 6163 6b77 6172 6429  rd, -1=backward)
-000134e0: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
-000134f0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-00013500: 2d2d 2d2d 0a20 2020 202d 6d30 203a 2065  ----.    -m0 : e
-00013510: 7374 696d 6174 6564 2064 762f 760a 2020  stimated dv/v.  
-00013520: 2020 656d 3020 3a20 6572 726f 7220 6f66    em0 : error of
-00013530: 2064 762f 7620 6573 7469 6d61 7469 6f6e   dv/v estimation
-00013540: 0a0a 2020 2020 4f72 6967 696e 616c 2062  ..    Original b
-00013550: 7920 4469 2059 616e 670a 2020 2020 4c61  y Di Yang.    La
-00013560: 7374 206d 6f64 6966 6965 6420 6279 2044  st modified by D
-00013570: 796c 616e 204d 696b 6573 656c 6c20 2832  ylan Mikesell (2
-00013580: 3520 4665 622e 2032 3031 3529 0a20 2020  5 Feb. 2015).   
-00013590: 2054 7261 6e73 6c61 7465 6420 746f 2070   Translated to p
-000135a0: 7974 686f 6e20 6279 2054 696d 2043 6c65  ython by Tim Cle
-000135b0: 6d65 6e74 7320 2831 3720 4175 672e 2032  ments (17 Aug. 2
-000135c0: 3031 3829 0a20 2020 2022 2222 0a20 2020  018).    """.   
-000135d0: 2074 7769 6e20 3d20 7061 7261 5b22 7477   twin = para["tw
-000135e0: 696e 225d 0a20 2020 2064 7420 3d20 7061  in"].    dt = pa
-000135f0: 7261 5b22 6474 225d 0a20 2020 2074 6d69  ra["dt"].    tmi
-00013600: 6e20 3d20 6e70 2e6d 696e 2874 7769 6e29  n = np.min(twin)
-00013610: 0a20 2020 2074 6d61 7820 3d20 6e70 2e6d  .    tmax = np.m
-00013620: 6178 2874 7769 6e29 0a20 2020 2074 7665  ax(twin).    tve
-00013630: 6374 203d 206e 702e 6172 616e 6765 2874  ct = np.arange(t
-00013640: 6d69 6e2c 2074 6d61 782c 2064 7429 0a0a  min, tmax, dt)..
-00013650: 2020 2020 2320 7365 7475 7020 6f74 6865      # setup othe
-00013660: 7220 7061 7261 6d65 7465 7273 0a20 2020  r parameters.   
-00013670: 206e 7074 7320 3d20 6c65 6e28 7265 6629   npts = len(ref)
-00013680: 2020 2320 6e75 6d62 6572 206f 6620 7469    # number of ti
-00013690: 6d65 2073 616d 706c 6573 0a0a 2020 2020  me samples..    
-000136a0: 2320 636f 6d70 7574 6520 6572 726f 7220  # compute error 
-000136b0: 6675 6e63 7469 6f6e 206f 7665 7220 6c61  function over la
-000136c0: 6773 2c20 7768 6963 6820 6973 2069 6e64  gs, which is ind
-000136d0: 6570 656e 6465 6e74 206f 6620 7374 7261  ependent of stra
-000136e0: 696e 206c 696d 6974 2027 6227 2e0a 2020  in limit 'b'..  
-000136f0: 2020 6572 7220 3d20 636f 6d70 7574 6545    err = computeE
-00013700: 7272 6f72 4675 6e63 7469 6f6e 2863 7572  rrorFunction(cur
-00013710: 2c20 7265 662c 206e 7074 732c 206d 6178  , ref, npts, max
-00013720: 4c61 6729 0a0a 2020 2020 2320 6469 7265  Lag)..    # dire
-00013730: 6374 696f 6e20 746f 2061 6363 756d 756c  ction to accumul
-00013740: 6174 6520 6572 726f 7273 2028 313d 666f  ate errors (1=fo
-00013750: 7277 6172 642c 202d 313d 6261 636b 7761  rward, -1=backwa
-00013760: 7264 290a 2020 2020 6469 7374 203d 2061  rd).    dist = a
-00013770: 6363 756d 756c 6174 6545 7272 6f72 4675  ccumulateErrorFu
-00013780: 6e63 7469 6f6e 2864 6972 6563 7469 6f6e  nction(direction
-00013790: 2c20 6572 722c 206e 7074 732c 206d 6178  , err, npts, max
-000137a0: 4c61 672c 2062 290a 2020 2020 7374 6261  Lag, b).    stba
-000137b0: 7220 3d20 6261 636b 7472 6163 6b44 6973  r = backtrackDis
-000137c0: 7461 6e63 6546 756e 6374 696f 6e28 2d31  tanceFunction(-1
-000137d0: 202a 2064 6972 6563 7469 6f6e 2c20 6469   * direction, di
-000137e0: 7374 2c20 6572 722c 202d 6d61 784c 6167  st, err, -maxLag
-000137f0: 2c20 6229 0a20 2020 2073 7462 6172 5469  , b).    stbarTi
-00013800: 6d65 203d 2073 7462 6172 202a 2064 7420  me = stbar * dt 
-00013810: 2023 2063 6f6e 7665 7274 2066 726f 6d20   # convert from 
-00013820: 7361 6d70 6c65 7320 746f 2074 696d 650a  samples to time.
-00013830: 0a20 2020 2023 2063 7574 2074 6865 2066  .    # cut the f
-00013840: 6972 7374 2061 6e64 206c 6173 7420 3525  irst and last 5%
-00013850: 2066 6f72 2062 6574 7465 7220 7265 6772   for better regr
-00013860: 6573 7369 6f6e 0a20 2020 2069 6e64 7820  ession.    indx 
-00013870: 3d20 6e70 2e77 6865 7265 2828 7476 6563  = np.where((tvec
-00013880: 7420 3e3d 2030 2e30 3520 2a20 6e70 7473  t >= 0.05 * npts
-00013890: 202a 2064 7429 2026 2028 7476 6563 7420   * dt) & (tvect 
-000138a0: 3c3d 2030 2e39 3520 2a20 6e70 7473 202a  <= 0.95 * npts *
-000138b0: 2064 7429 295b 305d 0a0a 2020 2020 2320   dt))[0]..    # 
-000138c0: 6c69 6e65 6172 2072 6567 7265 7373 696f  linear regressio
-000138d0: 6e20 746f 2067 6574 2064 762f 760a 2020  n to get dv/v.  
-000138e0: 2020 6966 206e 7074 7320 3e20 323a 0a20    if npts > 2:. 
-000138f0: 2020 2020 2020 2023 2077 6569 6768 7473         # weights
-00013900: 0a20 2020 2020 2020 2077 203d 206e 702e  .        w = np.
-00013910: 6f6e 6573 286e 7074 7329 0a20 2020 2020  ones(npts).     
-00013920: 2020 2023 206d 2c20 612c 2065 6d2c 2065     # m, a, em, e
-00013930: 6120 3d20 6c69 6e65 6172 5f72 6567 7265  a = linear_regre
-00013940: 7373 696f 6e28 7469 6d65 5f61 7869 735b  ssion(time_axis[
-00013950: 696e 6478 5d2c 2064 656c 7461 5f74 5b69  indx], delta_t[i
-00013960: 6e64 785d 2c20 772c 2069 6e74 6572 6365  ndx], w, interce
-00013970: 7074 5f6f 7269 6769 6e3d 4661 6c73 6529  pt_origin=False)
-00013980: 0a20 2020 2020 2020 206d 302c 2065 6d30  .        m0, em0
-00013990: 203d 206c 696e 6561 725f 7265 6772 6573   = linear_regres
-000139a0: 7369 6f6e 280a 2020 2020 2020 2020 2020  sion(.          
-000139b0: 2020 7476 6563 742e 666c 6174 7465 6e28    tvect.flatten(
-000139c0: 295b 696e 6478 5d2c 0a20 2020 2020 2020  )[indx],.       
-000139d0: 2020 2020 2073 7462 6172 5469 6d65 2e66       stbarTime.f
-000139e0: 6c61 7474 656e 2829 5b69 6e64 785d 2c0a  latten()[indx],.
-000139f0: 2020 2020 2020 2020 2020 2020 772e 666c              w.fl
-00013a00: 6174 7465 6e28 295b 696e 6478 5d2c 0a20  atten()[indx],. 
-00013a10: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-00013a20: 6365 7074 5f6f 7269 6769 6e3d 5472 7565  cept_origin=True
-00013a30: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00013a40: 2065 6c73 653a 0a20 2020 2020 2020 2070   else:.        p
-00013a50: 7269 6e74 2822 6e6f 7420 656e 6f75 6768  rint("not enough
-00013a60: 2070 6f69 6e74 7320 746f 2065 7374 696d   points to estim
-00013a70: 6174 6520 6476 2f76 2066 6f72 2064 7477  ate dv/v for dtw
-00013a80: 2229 0a20 2020 2020 2020 206d 3020 3d20  ").        m0 = 
-00013a90: 300a 2020 2020 2020 2020 656d 3020 3d20  0.        em0 = 
-00013aa0: 300a 0a20 2020 2072 6574 7572 6e20 6d30  0..    return m0
-00013ab0: 202a 2031 3030 2c20 656d 3020 2a20 3130   * 100, em0 * 10
-00013ac0: 302c 2064 6973 740a 0a0a 6465 6620 6d77  0, dist...def mw
-00013ad0: 6373 5f64 7676 2872 6566 2c20 6375 722c  cs_dvv(ref, cur,
-00013ae0: 206d 6f76 696e 675f 7769 6e64 6f77 5f6c   moving_window_l
-00013af0: 656e 6774 682c 2073 6c69 6465 5f73 7465  ength, slide_ste
-00013b00: 702c 2070 6172 612c 2073 6d6f 6f74 6869  p, para, smoothi
-00013b10: 6e67 5f68 616c 665f 7769 6e3d 3529 3a0a  ng_half_win=5):.
-00013b20: 2020 2020 2222 220a 2020 2020 4d6f 7669      """.    Movi
-00013b30: 6e67 2057 696e 646f 7720 4372 6f73 7320  ng Window Cross 
-00013b40: 5370 6563 7472 756d 206d 6574 686f 6420  Spectrum method 
-00013b50: 746f 206d 6561 7375 7265 2064 762f 7620  to measure dv/v 
-00013b60: 2872 656c 7969 6e67 206f 6e20 7068 693d  (relying on phi=
-00013b70: 322a 7069 2a66 2a74 2069 6e20 6672 6571  2*pi*f*t in freq
-00013b80: 2064 6f6d 6169 6e29 0a0a 2020 2020 5041   domain)..    PA
-00013b90: 5241 4d45 5445 5253 3a0a 2020 2020 2d2d  RAMETERS:.    --
-00013ba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00013bb0: 2020 2072 6566 3a20 5265 6665 7265 6e63     ref: Referenc
-00013bc0: 6520 7761 7665 666f 726d 2028 6e70 2e6e  e waveform (np.n
-00013bd0: 6461 7272 6179 2c20 7369 7a65 204e 290a  darray, size N).
-00013be0: 2020 2020 6375 723a 2043 7572 7265 6e74      cur: Current
-00013bf0: 2077 6176 6566 6f72 6d20 286e 702e 6e64   waveform (np.nd
-00013c00: 6172 7261 792c 2073 697a 6520 4e29 0a20  array, size N). 
-00013c10: 2020 206d 6f76 696e 675f 7769 6e64 6f77     moving_window
-00013c20: 5f6c 656e 6774 683a 206d 6f76 696e 6720  _length: moving 
-00013c30: 7769 6e64 6f77 206c 656e 6774 6820 746f  window length to
-00013c40: 2063 616c 6375 6c61 7465 2063 726f 7373   calculate cross
-00013c50: 2d73 7065 6374 7275 6d20 286e 702e 666c  -spectrum (np.fl
-00013c60: 6f61 742c 2069 6e20 7365 6329 0a20 2020  oat, in sec).   
-00013c70: 2073 6c69 6465 5f73 7465 703a 2073 7465   slide_step: ste
-00013c80: 7073 2069 6e20 7469 6d65 2074 6f20 7368  ps in time to sh
-00013c90: 6966 7420 7468 6520 6d6f 7669 6e67 2077  ift the moving w
-00013ca0: 696e 646f 7720 286e 702e 666c 6f61 742c  indow (np.float,
-00013cb0: 2069 6e20 7365 636f 6e64 7329 0a20 2020   in seconds).   
-00013cc0: 2070 6172 613a 2061 2064 6963 7420 636f   para: a dict co
-00013cd0: 6e74 6169 6e69 6e67 2070 6172 616d 6574  ntaining paramet
-00013ce0: 6572 7320 6162 6f75 7420 696e 7075 7420  ers about input 
-00013cf0: 6461 7461 2077 696e 646f 7720 616e 6420  data window and 
-00013d00: 6672 6571 7565 6e63 7920 696e 666f 2c20  frequency info, 
-00013d10: 696e 636c 7564 696e 670a 2020 2020 2020  including.      
-00013d20: 2020 6465 6c74 612d 3e54 6865 2073 616d    delta->The sam
-00013d30: 706c 696e 6720 7261 7465 206f 6620 7468  pling rate of th
-00013d40: 6520 696e 7075 7420 7469 6d65 7365 7269  e input timeseri
-00013d50: 6573 2028 696e 2048 7a29 0a20 2020 2020  es (in Hz).     
-00013d60: 2020 2077 696e 646f 772d 3e20 5468 6520     window-> The 
-00013d70: 7461 7267 6574 2077 696e 646f 7720 666f  target window fo
-00013d80: 7220 6d65 6173 7572 696e 6720 6474 2f74  r measuring dt/t
-00013d90: 0a20 2020 2020 2020 2066 7265 712d 3e20  .        freq-> 
-00013da0: 5468 6520 6672 6571 7565 6e63 7920 626f  The frequency bo
-00013db0: 756e 6420 746f 2063 6f6d 7075 7465 2074  und to compute t
-00013dc0: 6865 2064 6570 6861 7369 6e67 2028 696e  he dephasing (in
-00013dd0: 2048 7a29 0a20 2020 2020 2020 2074 6d69   Hz).        tmi
-00013de0: 6e3a 2054 6865 206c 6566 746d 6f73 7420  n: The leftmost 
-00013df0: 7469 6d65 206c 6167 2028 7573 6564 2074  time lag (used t
-00013e00: 6f20 636f 6d70 7574 6520 7468 6520 2274  o compute the "t
-00013e10: 696d 6520 6c61 6773 2061 7272 6179 2229  ime lags array")
-00013e20: 0a20 2020 2073 6d6f 6f74 6869 6e67 5f68  .    smoothing_h
-00013e30: 616c 665f 7769 6e3a 2049 6620 6469 6666  alf_win: If diff
-00013e40: 6572 656e 7420 6672 6f6d 2030 2c20 6465  erent from 0, de
-00013e50: 6669 6e65 7320 7468 6520 6861 6c66 206c  fines the half l
-00013e60: 656e 6774 6820 6f66 2074 6865 2073 6d6f  ength of the smo
-00013e70: 6f74 6869 6e67 2068 616e 6e69 6e67 2077  othing hanning w
-00013e80: 696e 646f 772e 0a0a 2020 2020 5245 5455  indow...    RETU
-00013e90: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
-00013ea0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-00013eb0: 7469 6d65 5f61 7869 733a 2074 6865 2063  time_axis: the c
-00013ec0: 656e 7472 616c 2074 696d 6573 206f 6620  entral times of 
-00013ed0: 7468 6520 7769 6e64 6f77 732e 0a20 2020  the windows..   
-00013ee0: 2064 656c 7461 5f74 3a20 6474 0a20 2020   delta_t: dt.   
-00013ef0: 2064 656c 7461 5f65 7272 3a65 7272 6f72   delta_err:error
-00013f00: 0a20 2020 2064 656c 7461 5f6d 636f 683a  .    delta_mcoh:
-00013f10: 206d 6561 6e20 636f 6865 7265 6e63 650a   mean coherence.
-00013f20: 0a20 2020 2043 6f70 6965 6420 6672 6f6d  .    Copied from
-00013f30: 204d 534e 6f69 7365 2028 6874 7470 733a   MSNoise (https:
-00013f40: 2f2f 6769 7468 7562 2e63 6f6d 2f52 4f42  //github.com/ROB
-00013f50: 656c 6769 756d 2f4d 534e 6f69 7365 2f74  elgium/MSNoise/t
-00013f60: 7265 652f 6d61 7374 6572 2f6d 736e 6f69  ree/master/msnoi
-00013f70: 7365 290a 2020 2020 4d6f 6469 6669 6564  se).    Modified
-00013f80: 2062 7920 4368 656e 6778 696e 204a 6961   by Chengxin Jia
-00013f90: 6e67 0a20 2020 2022 2222 0a20 2020 2023  ng.    """.    #
-00013fa0: 2063 6f6d 6d6f 6e20 7661 7269 6162 6c65   common variable
-00013fb0: 730a 2020 2020 7477 696e 203d 2070 6172  s.    twin = par
-00013fc0: 615b 2274 7769 6e22 5d0a 2020 2020 6672  a["twin"].    fr
-00013fd0: 6571 203d 2070 6172 615b 2266 7265 7122  eq = para["freq"
-00013fe0: 5d0a 2020 2020 6474 203d 2070 6172 615b  ].    dt = para[
-00013ff0: 2264 7422 5d0a 2020 2020 746d 696e 203d  "dt"].    tmin =
-00014000: 206e 702e 6d69 6e28 7477 696e 290a 2020   np.min(twin).  
-00014010: 2020 666d 696e 203d 206e 702e 6d69 6e28    fmin = np.min(
-00014020: 6672 6571 290a 2020 2020 666d 6178 203d  freq).    fmax =
-00014030: 206e 702e 6d61 7828 6672 6571 290a 0a20   np.max(freq).. 
-00014040: 2020 2023 2070 6172 616d 6574 6572 2069     # parameter i
-00014050: 6e69 7469 616c 697a 650a 2020 2020 6465  nitialize.    de
-00014060: 6c74 615f 7420 3d20 5b5d 0a20 2020 2064  lta_t = [].    d
-00014070: 656c 7461 5f65 7272 203d 205b 5d0a 2020  elta_err = [].  
-00014080: 2020 6465 6c74 615f 6d63 6f68 203d 205b    delta_mcoh = [
-00014090: 5d0a 2020 2020 7469 6d65 5f61 7869 7320  ].    time_axis 
-000140a0: 3d20 5b5d 0a0a 2020 2020 2320 696e 666f  = []..    # info
-000140b0: 206f 6e20 7468 6520 6d6f 7669 6e67 2077   on the moving w
-000140c0: 696e 646f 770a 2020 2020 7769 6e64 6f77  indow.    window
-000140d0: 5f6c 656e 6774 685f 7361 6d70 6c65 7320  _length_samples 
-000140e0: 3d20 6e70 2e69 6e74 286d 6f76 696e 675f  = np.int(moving_
-000140f0: 7769 6e64 6f77 5f6c 656e 6774 6820 2f20  window_length / 
-00014100: 6474 290a 2020 2020 7061 6464 203d 2069  dt).    padd = i
-00014110: 6e74 2832 202a 2a20 286e 6578 7470 6f77  nt(2 ** (nextpow
-00014120: 3228 7769 6e64 6f77 5f6c 656e 6774 685f  2(window_length_
-00014130: 7361 6d70 6c65 7329 202b 2032 2929 0a20  samples) + 2)). 
-00014140: 2020 2063 6f75 6e74 203d 2030 0a20 2020     count = 0.   
-00014150: 2074 7020 3d20 636f 7369 6e65 5f74 6170   tp = cosine_tap
-00014160: 6572 2877 696e 646f 775f 6c65 6e67 7468  er(window_length
-00014170: 5f73 616d 706c 6573 2c20 302e 3135 290a  _samples, 0.15).
-00014180: 0a20 2020 206d 696e 696e 6420 3d20 300a  .    minind = 0.
-00014190: 2020 2020 6d61 7869 6e64 203d 2077 696e      maxind = win
-000141a0: 646f 775f 6c65 6e67 7468 5f73 616d 706c  dow_length_sampl
-000141b0: 6573 0a0a 2020 2020 2320 6c6f 6f70 2074  es..    # loop t
-000141c0: 6872 6f75 6768 2061 6c6c 2073 7562 2d77  hrough all sub-w
-000141d0: 696e 646f 7773 0a20 2020 2077 6869 6c65  indows.    while
-000141e0: 206d 6178 696e 6420 3c3d 206c 656e 2872   maxind <= len(r
-000141f0: 6566 293a 0a20 2020 2020 2020 2063 6369  ef):.        cci
-00014200: 203d 2063 7572 5b6d 696e 696e 643a 6d61   = cur[minind:ma
-00014210: 7869 6e64 5d0a 2020 2020 2020 2020 6363  xind].        cc
-00014220: 6920 3d20 7363 6970 792e 7369 676e 616c  i = scipy.signal
-00014230: 2e64 6574 7265 6e64 2863 6369 2c20 7479  .detrend(cci, ty
-00014240: 7065 3d22 6c69 6e65 6172 2229 0a20 2020  pe="linear").   
-00014250: 2020 2020 2063 6369 202a 3d20 7470 0a0a       cci *= tp..
-00014260: 2020 2020 2020 2020 6372 6920 3d20 7265          cri = re
-00014270: 665b 6d69 6e69 6e64 3a6d 6178 696e 645d  f[minind:maxind]
-00014280: 0a20 2020 2020 2020 2063 7269 203d 2073  .        cri = s
-00014290: 6369 7079 2e73 6967 6e61 6c2e 6465 7472  cipy.signal.detr
-000142a0: 656e 6428 6372 692c 2074 7970 653d 226c  end(cri, type="l
-000142b0: 696e 6561 7222 290a 2020 2020 2020 2020  inear").        
-000142c0: 6372 6920 2a3d 2074 700a 0a20 2020 2020  cri *= tp..     
-000142d0: 2020 206d 696e 696e 6420 2b3d 2069 6e74     minind += int
-000142e0: 2873 6c69 6465 5f73 7465 7020 2f20 6474  (slide_step / dt
-000142f0: 290a 2020 2020 2020 2020 6d61 7869 6e64  ).        maxind
-00014300: 202b 3d20 696e 7428 736c 6964 655f 7374   += int(slide_st
-00014310: 6570 202f 2064 7429 0a0a 2020 2020 2020  ep / dt)..      
-00014320: 2020 2320 646f 2066 6674 0a20 2020 2020    # do fft.     
-00014330: 2020 2066 6375 7220 3d20 7363 6970 792e     fcur = scipy.
-00014340: 6666 7470 6163 6b2e 6666 7428 6363 692c  fftpack.fft(cci,
-00014350: 206e 3d70 6164 6429 5b3a 2070 6164 6420   n=padd)[: padd 
-00014360: 2f2f 2032 5d0a 2020 2020 2020 2020 6672  // 2].        fr
-00014370: 6566 203d 2073 6369 7079 2e66 6674 7061  ef = scipy.fftpa
-00014380: 636b 2e66 6674 2863 7269 2c20 6e3d 7061  ck.fft(cri, n=pa
-00014390: 6464 295b 3a20 7061 6464 202f 2f20 325d  dd)[: padd // 2]
-000143a0: 0a0a 2020 2020 2020 2020 6663 7572 3220  ..        fcur2 
-000143b0: 3d20 6e70 2e72 6561 6c28 6663 7572 2920  = np.real(fcur) 
-000143c0: 2a2a 2032 202b 206e 702e 696d 6167 2866  ** 2 + np.imag(f
-000143d0: 6375 7229 202a 2a20 320a 2020 2020 2020  cur) ** 2.      
-000143e0: 2020 6672 6566 3220 3d20 6e70 2e72 6561    fref2 = np.rea
-000143f0: 6c28 6672 6566 2920 2a2a 2032 202b 206e  l(fref) ** 2 + n
-00014400: 702e 696d 6167 2866 7265 6629 202a 2a20  p.imag(fref) ** 
-00014410: 320a 0a20 2020 2020 2020 2023 2067 6574  2..        # get
-00014420: 2063 726f 7373 2d73 7065 6374 7275 6d20   cross-spectrum 
-00014430: 2620 646f 2066 696c 7465 7269 6e67 0a20  & do filtering. 
-00014440: 2020 2020 2020 2058 203d 2066 7265 6620         X = fref 
-00014450: 2a20 2866 6375 722e 636f 6e6a 2829 290a  * (fcur.conj()).
-00014460: 2020 2020 2020 2020 6966 2073 6d6f 6f74          if smoot
-00014470: 6869 6e67 5f68 616c 665f 7769 6e20 213d  hing_half_win !=
-00014480: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00014490: 6463 7572 203d 206e 702e 7371 7274 2873  dcur = np.sqrt(s
-000144a0: 6d6f 6f74 6828 6663 7572 322c 2077 696e  mooth(fcur2, win
-000144b0: 646f 773d 2268 616e 6e69 6e67 222c 2068  dow="hanning", h
-000144c0: 616c 665f 7769 6e3d 736d 6f6f 7468 696e  alf_win=smoothin
-000144d0: 675f 6861 6c66 5f77 696e 2929 0a20 2020  g_half_win)).   
-000144e0: 2020 2020 2020 2020 2064 7265 6620 3d20           dref = 
-000144f0: 6e70 2e73 7172 7428 736d 6f6f 7468 2866  np.sqrt(smooth(f
-00014500: 7265 6632 2c20 7769 6e64 6f77 3d22 6861  ref2, window="ha
-00014510: 6e6e 696e 6722 2c20 6861 6c66 5f77 696e  nning", half_win
-00014520: 3d73 6d6f 6f74 6869 6e67 5f68 616c 665f  =smoothing_half_
-00014530: 7769 6e29 290a 2020 2020 2020 2020 2020  win)).          
-00014540: 2020 5820 3d20 736d 6f6f 7468 2858 2c20    X = smooth(X, 
-00014550: 7769 6e64 6f77 3d22 6861 6e6e 696e 6722  window="hanning"
-00014560: 2c20 6861 6c66 5f77 696e 3d73 6d6f 6f74  , half_win=smoot
-00014570: 6869 6e67 5f68 616c 665f 7769 6e29 0a20  hing_half_win). 
-00014580: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00014590: 2020 2020 2020 2020 2064 6375 7220 3d20           dcur = 
-000145a0: 6e70 2e73 7172 7428 6663 7572 3229 0a20  np.sqrt(fcur2). 
-000145b0: 2020 2020 2020 2020 2020 2064 7265 6620             dref 
-000145c0: 3d20 6e70 2e73 7172 7428 6672 6566 3229  = np.sqrt(fref2)
-000145d0: 0a0a 2020 2020 2020 2020 6463 7320 3d20  ..        dcs = 
-000145e0: 6e70 2e61 6273 2858 290a 0a20 2020 2020  np.abs(X)..     
-000145f0: 2020 2023 2046 696e 6420 7468 6520 7661     # Find the va
-00014600: 6c75 6573 2074 6865 2066 7265 7175 656e  lues the frequen
-00014610: 6379 2072 616e 6765 206f 6620 696e 7465  cy range of inte
-00014620: 7265 7374 0a20 2020 2020 2020 2066 7265  rest.        fre
-00014630: 715f 7665 6320 3d20 7363 6970 792e 6666  q_vec = scipy.ff
-00014640: 7470 6163 6b2e 6666 7466 7265 7128 6c65  tpack.fftfreq(le
-00014650: 6e28 5829 202a 2032 2c20 6474 295b 3a20  n(X) * 2, dt)[: 
-00014660: 7061 6464 202f 2f20 325d 0a20 2020 2020  padd // 2].     
-00014670: 2020 2069 6e64 6578 5f72 616e 6765 203d     index_range =
-00014680: 206e 702e 6172 6777 6865 7265 286e 702e   np.argwhere(np.
-00014690: 6c6f 6769 6361 6c5f 616e 6428 6672 6571  logical_and(freq
-000146a0: 5f76 6563 203e 3d20 666d 696e 2c20 6672  _vec >= fmin, fr
-000146b0: 6571 5f76 6563 203c 3d20 666d 6178 2929  eq_vec <= fmax))
-000146c0: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
-000146d0: 436f 6865 7265 6e63 6520 616e 6420 6974  Coherence and it
-000146e0: 7320 6d65 616e 2076 616c 7565 0a20 2020  s mean value.   
-000146f0: 2020 2020 2063 6f68 203d 2067 6574 436f       coh = getCo
-00014700: 6865 7265 6e63 6528 6463 732c 2064 7265  herence(dcs, dre
-00014710: 662c 2064 6375 7229 0a20 2020 2020 2020  f, dcur).       
-00014720: 206d 636f 6820 3d20 6e70 2e6d 6561 6e28   mcoh = np.mean(
-00014730: 636f 685b 696e 6465 785f 7261 6e67 655d  coh[index_range]
-00014740: 290a 0a20 2020 2020 2020 2023 2047 6574  )..        # Get
-00014750: 2057 6569 6768 7473 0a20 2020 2020 2020   Weights.       
-00014760: 2077 203d 2031 2e30 202f 2028 312e 3020   w = 1.0 / (1.0 
-00014770: 2f20 2863 6f68 5b69 6e64 6578 5f72 616e  / (coh[index_ran
-00014780: 6765 5d20 2a2a 2032 2920 2d20 312e 3029  ge] ** 2) - 1.0)
-00014790: 0a20 2020 2020 2020 2077 5b63 6f68 5b69  .        w[coh[i
-000147a0: 6e64 6578 5f72 616e 6765 5d20 3e3d 2030  ndex_range] >= 0
-000147b0: 2e39 395d 203d 2031 2e30 202f 2028 312e  .99] = 1.0 / (1.
-000147c0: 3020 2f20 302e 3938 3031 202d 2031 2e30  0 / 0.9801 - 1.0
-000147d0: 290a 2020 2020 2020 2020 7720 3d20 6e70  ).        w = np
-000147e0: 2e73 7172 7428 7720 2a20 6e70 2e73 7172  .sqrt(w * np.sqr
-000147f0: 7428 6463 735b 696e 6465 785f 7261 6e67  t(dcs[index_rang
-00014800: 655d 2929 0a20 2020 2020 2020 2077 203d  e])).        w =
-00014810: 206e 702e 7265 616c 2877 290a 0a20 2020   np.real(w)..   
-00014820: 2020 2020 2023 2046 7265 7175 656e 6379       # Frequency
-00014830: 2061 7272 6179 3a0a 2020 2020 2020 2020   array:.        
-00014840: 7620 3d20 6e70 2e72 6561 6c28 6672 6571  v = np.real(freq
-00014850: 5f76 6563 5b69 6e64 6578 5f72 616e 6765  _vec[index_range
-00014860: 5d29 202a 2032 202a 206e 702e 7069 0a0a  ]) * 2 * np.pi..
-00014870: 2020 2020 2020 2020 2320 5068 6173 653a          # Phase:
-00014880: 0a20 2020 2020 2020 2070 6869 203d 206e  .        phi = n
-00014890: 702e 616e 676c 6528 5829 0a20 2020 2020  p.angle(X).     
-000148a0: 2020 2070 6869 5b30 5d20 3d20 302e 300a     phi[0] = 0.0.
-000148b0: 2020 2020 2020 2020 7068 6920 3d20 6e70          phi = np
-000148c0: 2e75 6e77 7261 7028 7068 6929 0a20 2020  .unwrap(phi).   
-000148d0: 2020 2020 2070 6869 203d 2070 6869 5b69       phi = phi[i
-000148e0: 6e64 6578 5f72 616e 6765 5d0a 0a20 2020  ndex_range]..   
-000148f0: 2020 2020 2023 2043 616c 6375 6c61 7465       # Calculate
-00014900: 2074 6865 2073 6c6f 7065 2077 6974 6820   the slope with 
-00014910: 6120 7765 6967 6874 6564 206c 6561 7374  a weighted least
-00014920: 2073 7175 6172 6520 6c69 6e65 6172 2072   square linear r
-00014930: 6567 7265 7373 696f 6e0a 2020 2020 2020  egression.      
-00014940: 2020 2320 666f 7263 6564 2074 6872 6f75    # forced throu
-00014950: 6768 2074 6865 206f 7269 6769 6e3b 2077  gh the origin; w
-00014960: 6569 6768 7473 2066 6f72 2074 6865 2057  eights for the W
-00014970: 4c53 206d 7573 7420 6265 2074 6865 2076  LS must be the v
-00014980: 6172 6961 6e63 6520 210a 2020 2020 2020  ariance !.      
-00014990: 2020 6d2c 2065 6d20 3d20 6c69 6e65 6172    m, em = linear
-000149a0: 5f72 6567 7265 7373 696f 6e28 762e 666c  _regression(v.fl
-000149b0: 6174 7465 6e28 292c 2070 6869 2e66 6c61  atten(), phi.fla
-000149c0: 7474 656e 2829 2c20 772e 666c 6174 7465  tten(), w.flatte
-000149d0: 6e28 2929 0a20 2020 2020 2020 2064 656c  n()).        del
-000149e0: 7461 5f74 2e61 7070 656e 6428 6d29 0a0a  ta_t.append(m)..
-000149f0: 2020 2020 2020 2020 2320 7072 696e 7420          # print 
-00014a00: 7068 692e 7368 6170 652c 2076 2e73 6861  phi.shape, v.sha
-00014a10: 7065 2c20 772e 7368 6170 650a 2020 2020  pe, w.shape.    
-00014a20: 2020 2020 6520 3d20 6e70 2e73 756d 2828      e = np.sum((
-00014a30: 7068 6920 2d20 6d20 2a20 7629 202a 2a20  phi - m * v) ** 
-00014a40: 3229 202f 2028 6e70 2e73 697a 6528 7629  2) / (np.size(v)
-00014a50: 202d 2031 290a 2020 2020 2020 2020 7332   - 1).        s2
-00014a60: 7832 203d 206e 702e 7375 6d28 762a 2a32  x2 = np.sum(v**2
-00014a70: 202a 2077 2a2a 3229 0a20 2020 2020 2020   * w**2).       
-00014a80: 2073 7832 203d 206e 702e 7375 6d28 7720   sx2 = np.sum(w 
-00014a90: 2a20 762a 2a32 290a 2020 2020 2020 2020  * v**2).        
-00014aa0: 6520 3d20 6e70 2e73 7172 7428 6520 2a20  e = np.sqrt(e * 
-00014ab0: 7332 7832 202f 2073 7832 2a2a 3229 0a0a  s2x2 / sx2**2)..
-00014ac0: 2020 2020 2020 2020 6465 6c74 615f 6572          delta_er
-00014ad0: 722e 6170 7065 6e64 2865 290a 2020 2020  r.append(e).    
-00014ae0: 2020 2020 6465 6c74 615f 6d63 6f68 2e61      delta_mcoh.a
-00014af0: 7070 656e 6428 6e70 2e72 6561 6c28 6d63  ppend(np.real(mc
-00014b00: 6f68 2929 0a20 2020 2020 2020 2074 696d  oh)).        tim
-00014b10: 655f 6178 6973 2e61 7070 656e 6428 746d  e_axis.append(tm
-00014b20: 696e 202b 206d 6f76 696e 675f 7769 6e64  in + moving_wind
-00014b30: 6f77 5f6c 656e 6774 6820 2f20 322e 3020  ow_length / 2.0 
-00014b40: 2b20 636f 756e 7420 2a20 736c 6964 655f  + count * slide_
-00014b50: 7374 6570 290a 2020 2020 2020 2020 636f  step).        co
-00014b60: 756e 7420 2b3d 2031 0a0a 2020 2020 2020  unt += 1..      
-00014b70: 2020 6465 6c20 6663 7572 2c20 6672 6566    del fcur, fref
-00014b80: 0a20 2020 2020 2020 2064 656c 2058 0a20  .        del X. 
-00014b90: 2020 2020 2020 2064 656c 2066 7265 715f         del freq_
-00014ba0: 7665 630a 2020 2020 2020 2020 6465 6c20  vec.        del 
-00014bb0: 696e 6465 785f 7261 6e67 650a 2020 2020  index_range.    
-00014bc0: 2020 2020 6465 6c20 772c 2076 2c20 652c      del w, v, e,
-00014bd0: 2073 3278 322c 2073 7832 2c20 6d2c 2065   s2x2, sx2, m, e
-00014be0: 6d0a 0a20 2020 2069 6620 6d61 7869 6e64  m..    if maxind
-00014bf0: 203e 206c 656e 2863 7572 2920 2b20 696e   > len(cur) + in
-00014c00: 7428 736c 6964 655f 7374 6570 202f 2064  t(slide_step / d
-00014c10: 7429 3a0a 2020 2020 2020 2020 7072 696e  t):.        prin
-00014c20: 7428 2254 6865 206c 6173 7420 7769 6e64  t("The last wind
-00014c30: 6f77 2077 6173 2074 6f6f 2073 6d61 6c6c  ow was too small
-00014c40: 2c20 6275 7420 7761 7320 636f 6d70 7574  , but was comput
-00014c50: 6564 2229 0a0a 2020 2020 2320 656e 7375  ed")..    # ensu
-00014c60: 7265 2061 6c6c 206d 6174 7269 7820 6172  re all matrix ar
-00014c70: 6520 6e70 2061 7272 6179 0a20 2020 2064  e np array.    d
-00014c80: 656c 7461 5f74 203d 206e 702e 6172 7261  elta_t = np.arra
-00014c90: 7928 6465 6c74 615f 7429 0a20 2020 2064  y(delta_t).    d
-00014ca0: 656c 7461 5f65 7272 203d 206e 702e 6172  elta_err = np.ar
-00014cb0: 7261 7928 6465 6c74 615f 6572 7229 0a20  ray(delta_err). 
-00014cc0: 2020 2064 656c 7461 5f6d 636f 6820 3d20     delta_mcoh = 
-00014cd0: 6e70 2e61 7272 6179 2864 656c 7461 5f6d  np.array(delta_m
-00014ce0: 636f 6829 0a20 2020 2074 696d 655f 6178  coh).    time_ax
-00014cf0: 6973 203d 206e 702e 6172 7261 7928 7469  is = np.array(ti
-00014d00: 6d65 5f61 7869 7329 0a0a 2020 2020 2320  me_axis)..    # 
-00014d10: 7265 6164 7920 666f 7220 6c69 6e65 6172  ready for linear
-00014d20: 2072 6567 7265 7373 696f 6e0a 2020 2020   regression.    
-00014d30: 6465 6c74 615f 6d69 6e63 686f 203d 2030  delta_mincho = 0
-00014d40: 2e36 350a 2020 2020 6465 6c74 615f 6d61  .65.    delta_ma
-00014d50: 7865 7272 203d 2030 2e31 0a20 2020 2064  xerr = 0.1.    d
-00014d60: 656c 7461 5f6d 6178 6474 203d 2030 2e31  elta_maxdt = 0.1
-00014d70: 0a20 2020 2069 6e64 7831 203d 206e 702e  .    indx1 = np.
-00014d80: 7768 6572 6528 6465 6c74 615f 6d63 6f68  where(delta_mcoh
-00014d90: 203e 2064 656c 7461 5f6d 696e 6368 6f29   > delta_mincho)
-00014da0: 0a20 2020 2069 6e64 7832 203d 206e 702e  .    indx2 = np.
-00014db0: 7768 6572 6528 6465 6c74 615f 6572 7220  where(delta_err 
-00014dc0: 3c20 6465 6c74 615f 6d61 7865 7272 290a  < delta_maxerr).
-00014dd0: 2020 2020 696e 6478 3320 3d20 6e70 2e77      indx3 = np.w
-00014de0: 6865 7265 2864 656c 7461 5f74 203c 2064  here(delta_t < d
-00014df0: 656c 7461 5f6d 6178 6474 290a 0a20 2020  elta_maxdt)..   
-00014e00: 2023 202d 2d2d 2d2d 6669 6e64 2067 6f6f   # -----find goo
-00014e10: 6420 6474 206d 6561 7375 7265 6d65 6e74  d dt measurement
-00014e20: 732d 2d2d 2d2d 0a20 2020 2069 6e64 7820  s-----.    indx 
-00014e30: 3d20 6e70 2e69 6e74 6572 7365 6374 3164  = np.intersect1d
-00014e40: 2869 6e64 7831 2c20 696e 6478 3229 0a20  (indx1, indx2). 
-00014e50: 2020 2069 6e64 7820 3d20 6e70 2e69 6e74     indx = np.int
-00014e60: 6572 7365 6374 3164 2869 6e64 782c 2069  ersect1d(indx, i
-00014e70: 6e64 7833 290a 0a20 2020 2069 6620 6c65  ndx3)..    if le
-00014e80: 6e28 696e 6478 2920 3e20 323a 0a20 2020  n(indx) > 2:.   
-00014e90: 2020 2020 2023 202d 2d2d 2d65 7374 696d       # ----estim
-00014ea0: 6174 6520 7765 6967 6874 2066 6f72 2072  ate weight for r
-00014eb0: 6567 7265 7373 696f 6e2d 2d2d 2d0a 2020  egression----.  
-00014ec0: 2020 2020 2020 7720 3d20 3120 2f20 6465        w = 1 / de
-00014ed0: 6c74 615f 6572 725b 696e 6478 5d0a 2020  lta_err[indx].  
-00014ee0: 2020 2020 2020 775b 7e6e 702e 6973 6669        w[~np.isfi
-00014ef0: 6e69 7465 2877 295d 203d 2031 2e30 0a0a  nite(w)] = 1.0..
-00014f00: 2020 2020 2020 2020 2320 2d2d 2d2d 2d2d          # ------
-00014f10: 2d2d 2d64 6f20 6c69 6e65 6172 2072 6567  ---do linear reg
-00014f20: 7265 7373 696f 6e2d 2d2d 2d2d 2d2d 2d2d  ression---------
-00014f30: 2d2d 0a20 2020 2020 2020 2023 206d 2c20  --.        # m, 
-00014f40: 612c 2065 6d2c 2065 6120 3d20 6c69 6e65  a, em, ea = line
-00014f50: 6172 5f72 6567 7265 7373 696f 6e28 7469  ar_regression(ti
-00014f60: 6d65 5f61 7869 735b 696e 6478 5d2c 2064  me_axis[indx], d
-00014f70: 656c 7461 5f74 5b69 6e64 785d 2c20 772c  elta_t[indx], w,
-00014f80: 2069 6e74 6572 6365 7074 5f6f 7269 6769   intercept_origi
-00014f90: 6e3d 4661 6c73 6529 0a20 2020 2020 2020  n=False).       
-00014fa0: 206d 302c 2065 6d30 203d 206c 696e 6561   m0, em0 = linea
-00014fb0: 725f 7265 6772 6573 7369 6f6e 2874 696d  r_regression(tim
-00014fc0: 655f 6178 6973 5b69 6e64 785d 2c20 6465  e_axis[indx], de
-00014fd0: 6c74 615f 745b 696e 6478 5d2c 2077 2c20  lta_t[indx], w, 
-00014fe0: 696e 7465 7263 6570 745f 6f72 6967 696e  intercept_origin
-00014ff0: 3d54 7275 6529 0a0a 2020 2020 656c 7365  =True)..    else
-00015000: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-00015010: 226e 6f74 2065 6e6f 7567 6820 706f 696e  "not enough poin
-00015020: 7473 2074 6f20 6573 7469 6d61 7465 2064  ts to estimate d
-00015030: 762f 7620 666f 7220 6d77 6373 2229 0a20  v/v for mwcs"). 
-00015040: 2020 2020 2020 206d 3020 3d20 300a 2020         m0 = 0.  
-00015050: 2020 2020 2020 656d 3020 3d20 300a 0a20        em0 = 0.. 
-00015060: 2020 2072 6574 7572 6e20 2d6d 3020 2a20     return -m0 * 
-00015070: 3130 302c 2065 6d30 202a 2031 3030 0a0a  100, em0 * 100..
-00015080: 0a64 6566 2057 4343 5f64 7676 2872 6566  .def WCC_dvv(ref
-00015090: 2c20 6375 722c 206d 6f76 696e 675f 7769  , cur, moving_wi
-000150a0: 6e64 6f77 5f6c 656e 6774 682c 2073 6c69  ndow_length, sli
-000150b0: 6465 5f73 7465 702c 2070 6172 6129 3a0a  de_step, para):.
-000150c0: 2020 2020 2222 220a 2020 2020 5769 6e64      """.    Wind
-000150d0: 6f77 6564 2063 726f 7373 2063 6f72 7265  owed cross corre
-000150e0: 6c61 7469 6f6e 2028 5743 4329 2066 6f72  lation (WCC) for
-000150f0: 2064 7420 6f72 2064 762f 7620 6d65 7375   dt or dv/v mesu
-00015100: 7265 6d65 6e74 2028 536e 6965 6465 7220  rement (Snieder 
-00015110: 6574 2061 6c2e 2032 3031 3229 0a0a 2020  et al. 2012)..  
-00015120: 2020 5061 7261 6d65 7465 7273 3a0a 2020    Parameters:.  
-00015130: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020    -----------.  
-00015140: 2020 7265 663a 2054 6865 2022 5265 6665    ref: The "Refe
-00015150: 7265 6e63 6522 2074 696d 6573 6572 6965  rence" timeserie
-00015160: 730a 2020 2020 6375 723a 2054 6865 2022  s.    cur: The "
-00015170: 4375 7272 656e 7422 2074 696d 6573 6572  Current" timeser
-00015180: 6965 730a 2020 2020 6d6f 7669 6e67 5f77  ies.    moving_w
-00015190: 696e 646f 775f 6c65 6e67 7468 3a20 5468  indow_length: Th
-000151a0: 6520 6d6f 7669 6e67 2077 696e 646f 7720  e moving window 
-000151b0: 6c65 6e67 7468 2028 696e 2073 6563 6f6e  length (in secon
-000151c0: 6473 290a 2020 2020 736c 6964 655f 7374  ds).    slide_st
-000151d0: 6570 3a20 5468 6520 7374 6570 2074 6f20  ep: The step to 
-000151e0: 6a75 6d70 2066 6f72 2074 6865 206d 6f76  jump for the mov
-000151f0: 696e 6720 7769 6e64 6f77 2028 696e 2073  ing window (in s
-00015200: 6563 6f6e 6473 290a 2020 2020 7061 7261  econds).    para
-00015210: 3a20 6120 6469 6374 2063 6f6e 7461 696e  : a dict contain
-00015220: 696e 6720 6672 6571 2f74 696d 6520 696e  ing freq/time in
-00015230: 666f 206f 6620 7468 6520 6461 7461 206d  fo of the data m
-00015240: 6174 7269 780a 0a20 2020 2052 6574 7572  atrix..    Retur
-00015250: 6e73 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  ns:.    --------
-00015260: 2d2d 2d2d 0a20 2020 2074 696d 655f 6178  ----.    time_ax
-00015270: 6973 3a20 6365 6e74 7261 6c20 7469 6d65  is: central time
-00015280: 7320 6f66 2074 6865 206d 6f76 696e 6720  s of the moving 
-00015290: 7769 6e64 6f77 0a20 2020 2064 656c 7461  window.    delta
-000152a0: 5f74 3a20 6474 0a20 2020 2064 656c 7461  _t: dt.    delta
-000152b0: 5f65 7272 3a20 6572 726f 720a 2020 2020  _err: error.    
-000152c0: 6465 6c74 615f 6d63 6f68 3a20 6d65 616e  delta_mcoh: mean
-000152d0: 2063 6f68 6572 656e 6365 2066 6f72 2065   coherence for e
-000152e0: 6163 6820 7769 6e64 6f77 0a0a 2020 2020  ach window..    
-000152f0: 5772 6974 7465 6e20 6279 2043 6f6e 6763  Written by Congc
-00015300: 6f6e 6720 5975 616e 2028 3120 4a75 6c79  ong Yuan (1 July
-00015310: 2c20 3230 3139 290a 2020 2020 2222 220a  , 2019).    """.
-00015320: 2020 2020 2320 636f 6d6d 6f6e 2076 6172      # common var
-00015330: 6961 626c 6573 0a20 2020 2074 7769 6e20  iables.    twin 
-00015340: 3d20 7061 7261 5b22 7477 696e 225d 0a20  = para["twin"]. 
-00015350: 2020 2064 7420 3d20 7061 7261 5b22 6474     dt = para["dt
-00015360: 225d 0a20 2020 2074 6d69 6e20 3d20 6e70  "].    tmin = np
-00015370: 2e6d 696e 2874 7769 6e29 0a0a 2020 2020  .min(twin)..    
-00015380: 2320 7061 7261 6d65 7465 7220 696e 6974  # parameter init
-00015390: 6961 6c69 7a65 0a20 2020 2064 656c 7461  ialize.    delta
-000153a0: 5f74 203d 205b 5d0a 2020 2020 6465 6c74  _t = [].    delt
-000153b0: 615f 745f 636f 6566 203d 205b 5d0a 2020  a_t_coef = [].  
-000153c0: 2020 7469 6d65 5f61 7869 7320 3d20 5b5d    time_axis = []
-000153d0: 0a0a 2020 2020 2320 696e 666f 206f 6e20  ..    # info on 
-000153e0: 7468 6520 6d6f 7669 6e67 2077 696e 646f  the moving windo
-000153f0: 770a 2020 2020 7769 6e64 6f77 5f6c 656e  w.    window_len
-00015400: 6774 685f 7361 6d70 6c65 7320 3d20 6e70  gth_samples = np
-00015410: 2e69 6e74 286d 6f76 696e 675f 7769 6e64  .int(moving_wind
-00015420: 6f77 5f6c 656e 6774 6820 2f20 6474 290a  ow_length / dt).
-00015430: 2020 2020 636f 756e 7420 3d20 300a 2020      count = 0.  
-00015440: 2020 7470 203d 2063 6f73 696e 655f 7461    tp = cosine_ta
-00015450: 7065 7228 7769 6e64 6f77 5f6c 656e 6774  per(window_lengt
-00015460: 685f 7361 6d70 6c65 732c 2030 2e31 3529  h_samples, 0.15)
-00015470: 0a0a 2020 2020 6d69 6e69 6e64 203d 2030  ..    minind = 0
-00015480: 0a20 2020 206d 6178 696e 6420 3d20 7769  .    maxind = wi
-00015490: 6e64 6f77 5f6c 656e 6774 685f 7361 6d70  ndow_length_samp
-000154a0: 6c65 730a 0a20 2020 2023 206c 6f6f 7020  les..    # loop 
-000154b0: 7468 726f 7567 6820 616c 6c20 7375 622d  through all sub-
-000154c0: 7769 6e64 6f77 730a 2020 2020 7768 696c  windows.    whil
-000154d0: 6520 6d61 7869 6e64 203c 3d20 6c65 6e28  e maxind <= len(
-000154e0: 7265 6629 3a0a 2020 2020 2020 2020 6363  ref):.        cc
-000154f0: 6920 3d20 6375 725b 6d69 6e69 6e64 3a6d  i = cur[minind:m
-00015500: 6178 696e 645d 0a20 2020 2020 2020 2063  axind].        c
-00015510: 6369 203d 2073 6369 7079 2e73 6967 6e61  ci = scipy.signa
-00015520: 6c2e 6465 7472 656e 6428 6363 692c 2074  l.detrend(cci, t
-00015530: 7970 653d 226c 696e 6561 7222 290a 2020  ype="linear").  
-00015540: 2020 2020 2020 6363 6920 2a3d 2074 700a        cci *= tp.
-00015550: 0a20 2020 2020 2020 2063 7269 203d 2072  .        cri = r
-00015560: 6566 5b6d 696e 696e 643a 6d61 7869 6e64  ef[minind:maxind
-00015570: 5d0a 2020 2020 2020 2020 6372 6920 3d20  ].        cri = 
-00015580: 7363 6970 792e 7369 676e 616c 2e64 6574  scipy.signal.det
-00015590: 7265 6e64 2863 7269 2c20 7479 7065 3d22  rend(cri, type="
-000155a0: 6c69 6e65 6172 2229 0a20 2020 2020 2020  linear").       
-000155b0: 2063 7269 202a 3d20 7470 0a0a 2020 2020   cri *= tp..    
-000155c0: 2020 2020 6d69 6e69 6e64 202b 3d20 696e      minind += in
-000155d0: 7428 736c 6964 655f 7374 6570 202f 2064  t(slide_step / d
-000155e0: 7429 0a20 2020 2020 2020 206d 6178 696e  t).        maxin
-000155f0: 6420 2b3d 2069 6e74 2873 6c69 6465 5f73  d += int(slide_s
-00015600: 7465 7020 2f20 6474 290a 0a20 2020 2020  tep / dt)..     
-00015610: 2020 2023 206e 6f72 6d61 6c69 7a65 2073     # normalize s
-00015620: 6967 6e61 6c73 2062 6566 6f72 6520 6372  ignals before cr
-00015630: 6f73 7320 636f 7272 656c 6174 696f 6e0a  oss correlation.
-00015640: 2020 2020 2020 2020 6363 6920 3d20 2863          cci = (c
-00015650: 6369 202d 2063 6369 2e6d 6561 6e28 2929  ci - cci.mean())
-00015660: 202f 2063 6369 2e73 7464 2829 0a20 2020   / cci.std().   
-00015670: 2020 2020 2063 7269 203d 2028 6372 6920       cri = (cri 
-00015680: 2d20 6372 692e 6d65 616e 2829 2920 2f20  - cri.mean()) / 
-00015690: 6372 692e 7374 6428 290a 0a20 2020 2020  cri.std()..     
-000156a0: 2020 2023 2067 6574 206d 6178 696d 756d     # get maximum
-000156b0: 2063 6f72 7265 6c61 7469 6f6e 2063 6f65   correlation coe
-000156c0: 6666 6963 6965 6e74 2061 6e64 2069 7473  fficient and its
-000156d0: 2069 6e64 6578 0a20 2020 2020 2020 2063   index.        c
-000156e0: 6332 203d 206e 702e 636f 7272 656c 6174  c2 = np.correlat
-000156f0: 6528 6363 692c 2063 7269 2c20 6d6f 6465  e(cci, cri, mode
-00015700: 3d22 7361 6d65 2229 0a20 2020 2020 2020  ="same").       
-00015710: 2063 6332 203d 2063 6332 202f 206e 702e   cc2 = cc2 / np.
-00015720: 7371 7274 2828 6363 692a 2a32 292e 7375  sqrt((cci**2).su
-00015730: 6d28 2920 2a20 2863 7269 2a2a 3229 2e73  m() * (cri**2).s
-00015740: 756d 2829 290a 0a20 2020 2020 2020 2069  um())..        i
-00015750: 6d61 7863 6332 203d 206e 702e 7768 6572  maxcc2 = np.wher
-00015760: 6528 6363 3220 3d3d 206e 702e 6d61 7828  e(cc2 == np.max(
-00015770: 6363 3229 295b 305d 0a20 2020 2020 2020  cc2))[0].       
-00015780: 206d 6178 6363 3220 3d20 6e70 2e6d 6178   maxcc2 = np.max
-00015790: 2863 6332 290a 0a20 2020 2020 2020 2023  (cc2)..        #
-000157a0: 2067 6574 2074 6865 2074 696d 6520 7368   get the time sh
-000157b0: 6966 740a 2020 2020 2020 2020 6d20 3d20  ift.        m = 
-000157c0: 2869 6d61 7863 6332 202d 2028 286d 6178  (imaxcc2 - ((max
-000157d0: 696e 6420 2d20 6d69 6e69 6e64 2920 2f2f  ind - minind) //
-000157e0: 2032 2929 202a 2064 740a 2020 2020 2020   2)) * dt.      
-000157f0: 2020 6465 6c74 615f 742e 6170 7065 6e64    delta_t.append
-00015800: 286d 290a 2020 2020 2020 2020 6465 6c74  (m).        delt
-00015810: 615f 745f 636f 6566 2e61 7070 656e 6428  a_t_coef.append(
-00015820: 6d61 7863 6332 290a 0a20 2020 2020 2020  maxcc2)..       
-00015830: 2074 696d 655f 6178 6973 2e61 7070 656e   time_axis.appen
-00015840: 6428 746d 696e 202b 206d 6f76 696e 675f  d(tmin + moving_
-00015850: 7769 6e64 6f77 5f6c 656e 6774 6820 2f20  window_length / 
-00015860: 322e 3020 2b20 636f 756e 7420 2a20 736c  2.0 + count * sl
-00015870: 6964 655f 7374 6570 290a 2020 2020 2020  ide_step).      
-00015880: 2020 636f 756e 7420 2b3d 2031 0a0a 2020    count += 1..  
-00015890: 2020 6465 6c20 6363 692c 2063 7269 2c20    del cci, cri, 
-000158a0: 6363 322c 2069 6d61 7863 6332 2c20 6d61  cc2, imaxcc2, ma
-000158b0: 7863 6332 0a20 2020 2064 656c 206d 0a0a  xcc2.    del m..
-000158c0: 2020 2020 6966 206d 6178 696e 6420 3e20      if maxind > 
-000158d0: 6c65 6e28 6375 7229 202b 2069 6e74 2873  len(cur) + int(s
-000158e0: 6c69 6465 5f73 7465 7020 2f20 6474 293a  lide_step / dt):
-000158f0: 0a20 2020 2020 2020 2070 7269 6e74 2822  .        print("
-00015900: 5468 6520 6c61 7374 2077 696e 646f 7720  The last window 
-00015910: 7761 7320 746f 6f20 736d 616c 6c2c 2062  was too small, b
-00015920: 7574 2077 6173 2063 6f6d 7075 7465 6422  ut was computed"
-00015930: 290a 0a20 2020 2064 656c 7461 5f74 203d  )..    delta_t =
-00015940: 206e 702e 6172 7261 7928 6465 6c74 615f   np.array(delta_
-00015950: 7429 0a20 2020 2064 656c 7461 5f74 5f63  t).    delta_t_c
-00015960: 6f65 6620 3d20 6e70 2e61 7272 6179 2864  oef = np.array(d
-00015970: 656c 7461 5f74 5f63 6f65 6629 0a20 2020  elta_t_coef).   
-00015980: 2074 696d 655f 6178 6973 203d 206e 702e   time_axis = np.
-00015990: 6172 7261 7928 7469 6d65 5f61 7869 7329  array(time_axis)
-000159a0: 0a0a 2020 2020 2320 6c69 6e65 6172 2072  ..    # linear r
-000159b0: 6567 7265 7373 696f 6e20 746f 2067 6574  egression to get
-000159c0: 2064 762f 760a 2020 2020 6966 2063 6f75   dv/v.    if cou
-000159d0: 6e74 203e 2032 3a0a 2020 2020 2020 2020  nt > 2:.        
-000159e0: 2320 7369 6d70 6c65 2077 6569 6768 740a  # simple weight.
-000159f0: 2020 2020 2020 2020 7720 3d20 6e70 2e6f          w = np.o
-00015a00: 6e65 7328 636f 756e 7429 0a20 2020 2020  nes(count).     
-00015a10: 2020 2023 206d 2c20 612c 2065 6d2c 2065     # m, a, em, e
-00015a20: 6120 3d20 6c69 6e65 6172 5f72 6567 7265  a = linear_regre
-00015a30: 7373 696f 6e28 7469 6d65 5f61 7869 735b  ssion(time_axis[
-00015a40: 696e 6478 5d2c 2064 656c 7461 5f74 5b69  indx], delta_t[i
-00015a50: 6e64 785d 2c20 772c 2069 6e74 6572 6365  ndx], w, interce
-00015a60: 7074 5f6f 7269 6769 6e3d 4661 6c73 6529  pt_origin=False)
-00015a70: 0a20 2020 2020 2020 206d 302c 2065 6d30  .        m0, em0
-00015a80: 203d 206c 696e 6561 725f 7265 6772 6573   = linear_regres
-00015a90: 7369 6f6e 2874 696d 655f 6178 6973 2e66  sion(time_axis.f
-00015aa0: 6c61 7474 656e 2829 2c20 6465 6c74 615f  latten(), delta_
-00015ab0: 742e 666c 6174 7465 6e28 292c 2077 2e66  t.flatten(), w.f
-00015ac0: 6c61 7474 656e 2829 2c20 696e 7465 7263  latten(), interc
-00015ad0: 6570 745f 6f72 6967 696e 3d54 7275 6529  ept_origin=True)
-00015ae0: 0a0a 2020 2020 656c 7365 3a0a 2020 2020  ..    else:.    
-00015af0: 2020 2020 7072 696e 7428 226e 6f74 2065      print("not e
-00015b00: 6e6f 7567 6820 706f 696e 7473 2074 6f20  nough points to 
-00015b10: 6573 7469 6d61 7465 2064 762f 7620 666f  estimate dv/v fo
-00015b20: 7220 7763 6322 290a 2020 2020 2020 2020  r wcc").        
-00015b30: 6d30 203d 2030 0a20 2020 2020 2020 2065  m0 = 0.        e
-00015b40: 6d30 203d 2030 0a0a 2020 2020 7265 7475  m0 = 0..    retu
-00015b50: 726e 202d 6d30 202a 2031 3030 2c20 656d  rn -m0 * 100, em
-00015b60: 3020 2a20 3130 300a 0a0a 6465 6620 7778  0 * 100...def wx
-00015b70: 735f 6476 7628 0a20 2020 2072 6566 2c0a  s_dvv(.    ref,.
-00015b80: 2020 2020 6375 722c 0a20 2020 2061 6c6c      cur,.    all
-00015b90: 6672 6571 2c0a 2020 2020 7061 7261 2c0a  freq,.    para,.
-00015ba0: 2020 2020 646a 3d31 202f 2031 322c 0a20      dj=1 / 12,. 
-00015bb0: 2020 2073 303d 2d31 2c0a 2020 2020 4a3d     s0=-1,.    J=
-00015bc0: 2d31 2c0a 2020 2020 7369 673d 4661 6c73  -1,.    sig=Fals
-00015bd0: 652c 0a20 2020 2077 766e 3d22 6d6f 726c  e,.    wvn="morl
-00015be0: 6574 222c 0a20 2020 2075 6e77 7261 7066  et",.    unwrapf
-00015bf0: 6c61 673d 4661 6c73 652c 0a29 3a0a 2020  lag=False,.):.  
-00015c00: 2020 2222 220a 2020 2020 436f 6d70 7574    """.    Comput
-00015c10: 6520 6474 206f 7220 6476 2f76 2069 6e20  e dt or dv/v in 
-00015c20: 7469 6d65 2061 6e64 2066 7265 7175 656e  time and frequen
-00015c30: 6379 2064 6f6d 6169 6e20 6672 6f6d 2077  cy domain from w
-00015c40: 6176 656c 6574 2063 726f 7373 2073 7065  avelet cross spe
-00015c50: 6374 7275 6d20 2877 7873 292e 0a20 2020  ctrum (wxs)..   
-00015c60: 2066 6f72 2061 6c6c 2066 7265 7175 6563   for all frequec
-00015c70: 6965 7320 696e 2061 6e20 696e 7465 7265  ies in an intere
-00015c80: 7374 2072 616e 6765 0a0a 2020 2020 5061  st range..    Pa
-00015c90: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00015ca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-00015cb0: 7265 663a 2054 6865 2022 5265 6665 7265  ref: The "Refere
-00015cc0: 6e63 6522 2074 696d 6573 6572 6965 7320  nce" timeseries 
-00015cd0: 286e 756d 7079 2e6e 6461 7272 6179 290a  (numpy.ndarray).
-00015ce0: 2020 2020 6375 723a 2054 6865 2022 4375      cur: The "Cu
-00015cf0: 7272 656e 7422 2074 696d 6573 6572 6965  rrent" timeserie
-00015d00: 7320 286e 756d 7079 2e6e 6461 7272 6179  s (numpy.ndarray
-00015d10: 290a 2020 2020 616c 6c66 7265 713a 2061  ).    allfreq: a
-00015d20: 2062 6f6f 6c65 6e20 7661 7269 6162 6c65   boolen variable
-00015d30: 2074 6f20 6d61 6b65 206d 6561 7375 7265   to make measure
-00015d40: 6d65 6e74 7320 6f6e 2061 6c6c 2066 7265  ments on all fre
-00015d50: 7175 656e 6379 2072 616e 6765 206f 7220  quency range or 
-00015d60: 6e6f 740a 2020 2020 7061 7261 3a20 6120  not.    para: a 
-00015d70: 6469 6374 2063 6f6e 7461 696e 696e 6720  dict containing 
-00015d80: 6672 6571 2f74 696d 6520 696e 666f 206f  freq/time info o
-00015d90: 6620 7468 6520 6461 7461 206d 6174 7269  f the data matri
-00015da0: 780a 2020 2020 646a 2c20 7330 2c20 4a2c  x.    dj, s0, J,
-00015db0: 2073 6967 2c20 7776 6e3a 2063 6f6d 6d6f   sig, wvn: commo
-00015dc0: 6e20 7061 7261 6d65 7465 7273 2075 7365  n parameters use
-00015dd0: 6420 696e 2027 7761 7665 6c65 742e 7763  d in 'wavelet.wc
-00015de0: 7427 0a20 2020 2075 6e77 7261 7066 6c61  t'.    unwrapfla
-00015df0: 673a 2054 7275 6520 2d20 756e 7772 6170  g: True - unwrap
-00015e00: 2070 6861 7365 2064 656c 6179 732e 2044   phase delays. D
-00015e10: 6566 6175 6c74 2069 7320 4661 6c73 650a  efault is False.
-00015e20: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
-00015e30: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-00015e40: 2d2d 2d2d 0a20 2020 2064 7676 2a31 3030  ----.    dvv*100
-00015e50: 203a 2065 7374 696d 6174 6564 2064 762f   : estimated dv/
-00015e60: 7620 696e 2025 0a20 2020 2065 7272 2a31  v in %.    err*1
-00015e70: 3030 203a 2065 7272 6f72 206f 6620 6476  00 : error of dv
-00015e80: 2f76 2065 7374 696d 6174 696f 6e20 696e  /v estimation in
-00015e90: 2025 0a0a 2020 2020 4f72 6967 696e 616c   %..    Original
-00015ea0: 6c79 2077 7269 7474 656e 2062 7920 5469  ly written by Ti
-00015eb0: 6d20 436c 656d 656e 7473 2028 3120 4d61  m Clements (1 Ma
-00015ec0: 7263 682c 2032 3031 3929 0a20 2020 204d  rch, 2019).    M
-00015ed0: 6f64 6966 6965 6420 6279 2043 6f6e 6763  odified by Congc
-00015ee0: 6f6e 6720 5975 616e 2028 3330 204a 756e  ong Yuan (30 Jun
-00015ef0: 652c 2032 3031 3929 2062 6173 6564 206f  e, 2019) based o
-00015f00: 6e20 284d 616f 2065 7420 616c 2e20 3230  n (Mao et al. 20
-00015f10: 3139 292e 0a20 2020 2055 7064 6174 6564  19)..    Updated
-00015f20: 2062 7920 4368 656e 6778 696e 204a 6961   by Chengxin Jia
-00015f30: 6e67 2028 3130 204f 6374 2c20 3230 3139  ng (10 Oct, 2019
-00015f40: 2920 746f 206d 6572 6765 2074 6865 2066  ) to merge the f
-00015f50: 756e 6374 696f 6e61 6c69 7479 2066 6f72  unctionality for
-00015f60: 206d 6573 7572 656d 656e 7473 0a20 2020   mesurements.   
-00015f70: 2061 6372 6f73 7320 616c 6c20 6672 6571   across all freq
-00015f80: 7565 6e63 7920 616e 6420 6f6e 6520 6672  uency and one fr
-00015f90: 6571 2072 616e 6765 0a20 2020 2022 2222  eq range.    """
-00015fa0: 0a20 2020 2023 2063 6f6d 6d6f 6e20 7661  .    # common va
-00015fb0: 7269 6162 6c65 730a 2020 2020 7477 696e  riables.    twin
-00015fc0: 203d 2070 6172 615b 2274 7769 6e22 5d0a   = para["twin"].
-00015fd0: 2020 2020 6672 6571 203d 2070 6172 615b      freq = para[
-00015fe0: 2266 7265 7122 5d0a 2020 2020 6474 203d  "freq"].    dt =
-00015ff0: 2070 6172 615b 2264 7422 5d0a 2020 2020   para["dt"].    
-00016000: 746d 696e 203d 206e 702e 6d69 6e28 7477  tmin = np.min(tw
-00016010: 696e 290a 2020 2020 746d 6178 203d 206e  in).    tmax = n
-00016020: 702e 6d61 7828 7477 696e 290a 2020 2020  p.max(twin).    
-00016030: 666d 696e 203d 206e 702e 6d69 6e28 6672  fmin = np.min(fr
-00016040: 6571 290a 2020 2020 666d 6178 203d 206e  eq).    fmax = n
-00016050: 702e 6d61 7828 6672 6571 290a 2020 2020  p.max(freq).    
-00016060: 7476 6563 203d 206e 702e 6172 616e 6765  tvec = np.arange
-00016070: 2874 6d69 6e2c 2074 6d61 782c 2064 7429  (tmin, tmax, dt)
-00016080: 0a20 2020 206e 7074 7320 3d20 6c65 6e28  .    npts = len(
-00016090: 7476 6563 290a 0a20 2020 2023 2070 6572  tvec)..    # per
-000160a0: 666f 726d 2063 726f 7373 2063 6f68 6572  form cross coher
-000160b0: 656e 7420 616e 616c 7973 6973 2c20 6d6f  ent analysis, mo
-000160c0: 6469 6669 6564 2066 726f 6d20 6675 6e63  dified from func
-000160d0: 7469 6f6e 2027 7761 7665 6c65 742e 6377  tion 'wavelet.cw
-000160e0: 7427 0a20 2020 2057 4354 2c20 6157 4354  t'.    WCT, aWCT
-000160f0: 2c20 636f 692c 2066 7265 712c 2073 6967  , coi, freq, sig
-00016100: 203d 2077 6374 5f6d 6f64 6966 6965 6428   = wct_modified(
-00016110: 7265 662c 2063 7572 2c20 6474 2c20 646a  ref, cur, dt, dj
-00016120: 3d64 6a2c 2073 303d 7330 2c20 4a3d 4a2c  =dj, s0=s0, J=J,
-00016130: 2073 6967 3d73 6967 2c20 7761 7665 6c65   sig=sig, wavele
-00016140: 743d 7776 6e2c 206e 6f72 6d61 6c69 7a65  t=wvn, normalize
-00016150: 3d54 7275 6529 0a0a 2020 2020 6966 2075  =True)..    if u
-00016160: 6e77 7261 7066 6c61 673a 0a20 2020 2020  nwrapflag:.     
-00016170: 2020 2070 6861 7365 203d 206e 702e 756e     phase = np.un
-00016180: 7772 6170 2861 5743 542c 2061 7869 733d  wrap(aWCT, axis=
-00016190: 2d31 2920 2023 2061 7869 733d 302c 2075  -1)  # axis=0, u
-000161a0: 7077 7261 7020 616c 6f6e 6720 7469 6d65  pwrap along time
-000161b0: 3b20 6178 6973 3d2d 312c 2075 6e77 7261  ; axis=-1, unwra
-000161c0: 7020 616c 6f6e 6720 6672 6571 7565 6e63  p along frequenc
-000161d0: 790a 2020 2020 656c 7365 3a0a 2020 2020  y.    else:.    
-000161e0: 2020 2020 7068 6173 6520 3d20 6157 4354      phase = aWCT
-000161f0: 0a0a 2020 2020 2320 7a65 726f 206f 7574  ..    # zero out
-00016200: 2064 6174 6120 6f75 7473 6964 6520 6672   data outside fr
-00016210: 6571 7565 6e63 7920 6261 6e64 0a20 2020  equency band.   
-00016220: 2069 6620 2866 6d61 7820 3e20 6e70 2e6d   if (fmax > np.m
-00016230: 6178 2866 7265 7129 2920 7c20 2866 6d61  ax(freq)) | (fma
-00016240: 7820 3c3d 2066 6d69 6e29 3a0a 2020 2020  x <= fmin):.    
-00016250: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00016260: 7272 6f72 2822 4162 6f72 743a 2069 6e70  rror("Abort: inp
-00016270: 7574 2066 7265 7175 656e 6379 206f 7574  ut frequency out
-00016280: 206f 6620 6c69 6d69 7473 2122 290a 2020   of limits!").  
-00016290: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000162a0: 6672 6571 5f69 6e64 696e 203d 206e 702e  freq_indin = np.
-000162b0: 7768 6572 6528 2866 7265 7120 3e3d 2066  where((freq >= f
-000162c0: 6d69 6e29 2026 2028 6672 6571 203c 3d20  min) & (freq <= 
-000162d0: 666d 6178 2929 5b30 5d0a 0a20 2020 2023  fmax))[0]..    #
-000162e0: 2066 6f6c 6c6f 7720 4d57 4353 2074 6f20   follow MWCS to 
-000162f0: 646f 2074 776f 2073 7465 7073 206f 6620  do two steps of 
-00016300: 6c69 6e65 6172 2072 6567 7265 7373 696f  linear regressio
-00016310: 6e0a 2020 2020 6966 206e 6f74 2061 6c6c  n.    if not all
-00016320: 6672 6571 3a0a 2020 2020 2020 2020 6465  freq:.        de
-00016330: 6c74 615f 745f 6d2c 2064 656c 7461 5f74  lta_t_m, delta_t
-00016340: 5f75 6e63 203d 206e 702e 7a65 726f 7328  _unc = np.zeros(
-00016350: 6e70 7473 2c20 6474 7970 653d 6e70 2e66  npts, dtype=np.f
-00016360: 6c6f 6174 3332 292c 206e 702e 7a65 726f  loat32), np.zero
-00016370: 7328 6e70 7473 2c20 6474 7970 653d 6e70  s(npts, dtype=np
-00016380: 2e66 6c6f 6174 3332 290a 2020 2020 2020  .float32).      
-00016390: 2020 2320 6173 7375 6d65 2074 6865 2074    # assume the t
-000163a0: 7665 6320 6973 2074 6865 2074 696d 6520  vec is the time 
-000163b0: 7769 6e64 6f77 2074 6f20 6d65 6173 7572  window to measur
-000163c0: 6520 6474 0a20 2020 2020 2020 2066 6f72  e dt.        for
-000163d0: 2069 7420 696e 2072 616e 6765 286e 7074   it in range(npt
-000163e0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-000163f0: 7720 3d20 3120 2f20 5743 545b 6672 6571  w = 1 / WCT[freq
-00016400: 5f69 6e64 696e 2c20 6974 5d0a 2020 2020  _indin, it].    
-00016410: 2020 2020 2020 2020 775b 7e6e 702e 6973          w[~np.is
-00016420: 6669 6e69 7465 2877 295d 203d 2031 2e30  finite(w)] = 1.0
-00016430: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-00016440: 7461 5f74 5f6d 5b69 745d 2c20 6465 6c74  ta_t_m[it], delt
-00016450: 615f 745f 756e 635b 6974 5d20 3d20 6c69  a_t_unc[it] = li
-00016460: 6e65 6172 5f72 6567 7265 7373 696f 6e28  near_regression(
-00016470: 6672 6571 5b66 7265 715f 696e 6469 6e5d  freq[freq_indin]
-00016480: 202a 2032 202a 206e 702e 7069 2c20 7068   * 2 * np.pi, ph
-00016490: 6173 655b 6672 6571 5f69 6e64 696e 2c20  ase[freq_indin, 
-000164a0: 6974 5d2c 2077 290a 0a20 2020 2020 2020  it], w)..       
-000164b0: 2023 206e 6577 2077 6569 6768 7473 2066   # new weights f
-000164c0: 6f72 2072 6567 7265 7373 696f 6e0a 2020  or regression.  
-000164d0: 2020 2020 2020 7732 203d 2031 202f 206e        w2 = 1 / n
-000164e0: 702e 6d65 616e 2857 4354 5b66 7265 715f  p.mean(WCT[freq_
-000164f0: 696e 6469 6e2c 203a 5d2c 2061 7869 733d  indin, :], axis=
-00016500: 3029 0a20 2020 2020 2020 2077 325b 7e6e  0).        w2[~n
-00016510: 702e 6973 6669 6e69 7465 2877 3229 5d20  p.isfinite(w2)] 
-00016520: 3d20 312e 300a 0a20 2020 2020 2020 2023  = 1.0..        #
-00016530: 206e 6f77 2075 7365 2064 7420 616e 6420   now use dt and 
-00016540: 7420 746f 2067 6574 2064 762f 760a 2020  t to get dv/v.  
-00016550: 2020 2020 2020 6966 206c 656e 2877 3229        if len(w2)
-00016560: 203e 2032 3a0a 2020 2020 2020 2020 2020   > 2:.          
-00016570: 2020 6966 206e 6f74 206e 702e 616e 7928    if not np.any(
-00016580: 6465 6c74 615f 745f 6d29 3a0a 2020 2020  delta_t_m):.    
-00016590: 2020 2020 2020 2020 2020 2020 6476 762c              dvv,
-000165a0: 2065 7272 203d 206e 702e 6e61 6e2c 206e   err = np.nan, n
-000165b0: 702e 6e61 6e0a 2020 2020 2020 2020 2020  p.nan.          
-000165c0: 2020 6d2c 2065 6d20 3d20 6c69 6e65 6172    m, em = linear
-000165d0: 5f72 6567 7265 7373 696f 6e28 7476 6563  _regression(tvec
-000165e0: 2c20 6465 6c74 615f 745f 6d2c 2077 322c  , delta_t_m, w2,
-000165f0: 2069 6e74 6572 6365 7074 5f6f 7269 6769   intercept_origi
-00016600: 6e3d 5472 7565 290a 2020 2020 2020 2020  n=True).        
-00016610: 2020 2020 6476 762c 2065 7272 203d 202d      dvv, err = -
-00016620: 6d2c 2065 6d0a 2020 2020 2020 2020 656c  m, em.        el
-00016630: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00016640: 7072 696e 7428 226e 6f74 2065 6e6f 7567  print("not enoug
-00016650: 6820 706f 696e 7473 2074 6f20 6573 7469  h points to esti
-00016660: 6d61 7465 2064 762f 7620 666f 7220 7774  mate dv/v for wt
-00016670: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
-00016680: 6476 762c 2065 7272 203d 206e 702e 6e61  dvv, err = np.na
-00016690: 6e2c 206e 702e 6e61 6e0a 0a20 2020 2020  n, np.nan..     
-000166a0: 2020 2072 6574 7572 6e20 6476 7620 2a20     return dvv * 
-000166b0: 3130 302c 2065 7272 202a 2031 3030 0a0a  100, err * 100..
-000166c0: 2020 2020 2320 636f 6e76 6572 7420 7068      # convert ph
-000166d0: 6173 6520 6469 7265 6374 6c79 2074 6f20  ase directly to 
-000166e0: 6465 6c74 615f 7420 666f 7220 616c 6c20  delta_t for all 
-000166f0: 6672 6571 7565 6e63 6965 730a 2020 2020  frequencies.    
-00016700: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00016710: 636f 6e76 6572 7420 7068 6173 6520 6465  convert phase de
-00016720: 6c61 7920 746f 2074 696d 6520 6465 6c61  lay to time dela
-00016730: 790a 2020 2020 2020 2020 6465 6c74 615f  y.        delta_
-00016740: 7420 3d20 7068 6173 6520 2f20 2832 202a  t = phase / (2 *
-00016750: 206e 702e 7069 202a 2066 7265 715b 3a2c   np.pi * freq[:,
-00016760: 204e 6f6e 655d 2920 2023 206e 6f72 6d61   None])  # norma
-00016770: 6c69 7a65 2070 6861 7365 2062 7920 2832  lize phase by (2
-00016780: 2a70 692a 6672 6571 7565 6e63 7929 0a20  *pi*frequency). 
-00016790: 2020 2020 2020 2064 7676 2c20 6572 7220         dvv, err 
-000167a0: 3d20 6e70 2e7a 6572 6f73 2866 7265 715f  = np.zeros(freq_
-000167b0: 696e 6469 6e2e 7368 6170 6529 2c20 6e70  indin.shape), np
-000167c0: 2e7a 6572 6f73 2866 7265 715f 696e 6469  .zeros(freq_indi
-000167d0: 6e2e 7368 6170 6529 0a0a 2020 2020 2020  n.shape)..      
-000167e0: 2020 2320 6c6f 6f70 2074 6872 6f75 6768    # loop through
-000167f0: 2066 7265 7120 666f 7220 6c69 6e65 6172   freq for linear
-00016800: 2072 6567 7265 7373 696f 6e0a 2020 2020   regression.    
-00016810: 2020 2020 666f 7220 6969 2c20 6966 7265      for ii, ifre
-00016820: 7120 696e 2065 6e75 6d65 7261 7465 2866  q in enumerate(f
-00016830: 7265 715f 696e 6469 6e29 3a0a 2020 2020  req_indin):.    
-00016840: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-00016850: 7665 6329 203e 2032 3a0a 2020 2020 2020  vec) > 2:.      
-00016860: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00016870: 206e 702e 616e 7928 6465 6c74 615f 745b   np.any(delta_t[
-00016880: 6966 7265 715d 293a 0a20 2020 2020 2020  ifreq]):.       
-00016890: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000168a0: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-000168b0: 2020 2020 2020 2023 2068 6f77 2074 6f20         # how to 
-000168c0: 6265 7474 6572 2061 7070 726f 6163 6820  better approach 
-000168d0: 7468 6520 756e 6365 7274 6169 6e74 7920  the uncertainty 
-000168e0: 6f66 2064 656c 7461 5f74 0a20 2020 2020  of delta_t.     
-000168f0: 2020 2020 2020 2020 2020 2077 203d 2031             w = 1
-00016900: 202f 2057 4354 5b69 6672 6571 5d0a 2020   / WCT[ifreq].  
-00016910: 2020 2020 2020 2020 2020 2020 2020 775b                w[
-00016920: 7e6e 702e 6973 6669 6e69 7465 2877 295d  ~np.isfinite(w)]
-00016930: 203d 2031 2e30 0a0a 2020 2020 2020 2020   = 1.0..        
-00016940: 2020 2020 2020 2020 2320 6d2c 2061 2c20          # m, a, 
-00016950: 656d 2c20 6561 203d 206c 696e 6561 725f  em, ea = linear_
-00016960: 7265 6772 6573 7369 6f6e 2874 696d 655f  regression(time_
-00016970: 6178 6973 5b69 6e64 785d 2c20 6465 6c74  axis[indx], delt
-00016980: 615f 745b 696e 6478 5d2c 2077 2c20 696e  a_t[indx], w, in
-00016990: 7465 7263 6570 745f 6f72 6967 696e 3d46  tercept_origin=F
-000169a0: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-000169b0: 2020 2020 2020 6d2c 2065 6d20 3d20 6c69        m, em = li
-000169c0: 6e65 6172 5f72 6567 7265 7373 696f 6e28  near_regression(
-000169d0: 7476 6563 2c20 6465 6c74 615f 745b 6966  tvec, delta_t[if
-000169e0: 7265 715d 2c20 772c 2069 6e74 6572 6365  req], w, interce
-000169f0: 7074 5f6f 7269 6769 6e3d 5472 7565 290a  pt_origin=True).
-00016a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a10: 6476 765b 6969 5d2c 2065 7272 5b69 695d  dvv[ii], err[ii]
-00016a20: 203d 202d 6d2c 2065 6d0a 2020 2020 2020   = -m, em.      
-00016a30: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00016a40: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00016a50: 7428 226e 6f74 2065 6e6f 7567 6820 706f  t("not enough po
-00016a60: 696e 7473 2074 6f20 6573 7469 6d61 7465  ints to estimate
-00016a70: 2064 762f 7620 666f 7220 7774 7322 290a   dv/v for wts").
-00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a90: 6476 765b 6969 5d2c 2065 7272 5b69 695d  dvv[ii], err[ii]
-00016aa0: 203d 206e 702e 6e61 6e2c 206e 702e 6e61   = np.nan, np.na
-00016ab0: 6e0a 0a20 2020 2020 2020 2072 6574 7572  n..        retur
-00016ac0: 6e20 6672 6571 5b66 7265 715f 696e 6469  n freq[freq_indi
-00016ad0: 6e5d 2c20 6476 7620 2a20 3130 302c 2065  n], dvv * 100, e
-00016ae0: 7272 202a 2031 3030 0a0a 0a64 6566 2077  rr * 100...def w
-00016af0: 7473 5f64 7676 280a 2020 2020 7265 662c  ts_dvv(.    ref,
-00016b00: 0a20 2020 2063 7572 2c0a 2020 2020 616c  .    cur,.    al
-00016b10: 6c66 7265 712c 0a20 2020 2070 6172 612c  lfreq,.    para,
-00016b20: 0a20 2020 2064 765f 7261 6e67 652c 0a20  .    dv_range,. 
-00016b30: 2020 206e 6274 7269 616c 2c0a 2020 2020     nbtrial,.    
-00016b40: 646a 3d31 202f 2031 322c 0a20 2020 2073  dj=1 / 12,.    s
-00016b50: 303d 2d31 2c0a 2020 2020 4a3d 2d31 2c0a  0=-1,.    J=-1,.
-00016b60: 2020 2020 7776 6e3d 226d 6f72 6c65 7422      wvn="morlet"
-00016b70: 2c0a 2020 2020 6e6f 726d 616c 697a 653d  ,.    normalize=
-00016b80: 5472 7565 2c0a 293a 0a20 2020 2022 2222  True,.):.    """
-00016b90: 0a20 2020 2041 7070 6c79 2073 7472 6574  .    Apply stret
-00016ba0: 6368 696e 6720 6d65 7468 6f64 2074 6f20  ching method to 
-00016bb0: 636f 6e74 696e 756f 7573 2077 6176 656c  continuous wavel
-00016bc0: 6574 2074 7261 6e73 666f 726d 6174 696f  et transformatio
-00016bd0: 6e20 2843 5754 2920 6f66 2073 6967 6e61  n (CWT) of signa
-00016be0: 6c73 0a20 2020 2066 6f72 2061 6c6c 2066  ls.    for all f
-00016bf0: 7265 7175 6563 6965 7320 696e 2061 6e20  requecies in an 
-00016c00: 696e 7465 7265 7374 2072 616e 6765 0a0a  interest range..
-00016c10: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00016c20: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00016c30: 2d0a 2020 2020 7265 663a 2054 6865 2022  -.    ref: The "
-00016c40: 5265 6665 7265 6e63 6522 2074 696d 6573  Reference" times
-00016c50: 6572 6965 7320 286e 756d 7079 2e6e 6461  eries (numpy.nda
-00016c60: 7272 6179 290a 2020 2020 6375 723a 2054  rray).    cur: T
-00016c70: 6865 2022 4375 7272 656e 7422 2074 696d  he "Current" tim
-00016c80: 6573 6572 6965 7320 286e 756d 7079 2e6e  eseries (numpy.n
-00016c90: 6461 7272 6179 290a 2020 2020 616c 6c66  darray).    allf
-00016ca0: 7265 713a 2061 2062 6f6f 6c65 6e20 7661  req: a boolen va
-00016cb0: 7269 6162 6c65 2074 6f20 6d61 6b65 206d  riable to make m
-00016cc0: 6561 7375 7265 6d65 6e74 7320 6f6e 2061  easurements on a
-00016cd0: 6c6c 2066 7265 7175 656e 6379 2072 616e  ll frequency ran
-00016ce0: 6765 206f 7220 6e6f 740a 2020 2020 7061  ge or not.    pa
-00016cf0: 7261 3a20 6120 6469 6374 2063 6f6e 7461  ra: a dict conta
-00016d00: 696e 696e 6720 6672 6571 2f74 696d 6520  ining freq/time 
-00016d10: 696e 666f 206f 6620 7468 6520 6461 7461  info of the data
-00016d20: 206d 6174 7269 780a 2020 2020 6476 5f72   matrix.    dv_r
-00016d30: 616e 6765 3a20 6162 736f 6c75 7465 2062  ange: absolute b
-00016d40: 6f75 6e64 2066 6f72 2074 6865 2076 656c  ound for the vel
-00016d50: 6f63 6974 7920 7661 7269 6174 696f 6e3b  ocity variation;
-00016d60: 2065 7861 6d70 6c65 3a20 6476 3d30 2e30   example: dv=0.0
-00016d70: 3320 666f 7220 5b2d 332c 335d 250a 2020  3 for [-3,3]%.  
-00016d80: 2020 6f66 2072 656c 6174 6976 6520 7665    of relative ve
-00016d90: 6c6f 6369 7479 2063 6861 6e67 6520 2866  locity change (f
-00016da0: 6c6f 6174 290a 2020 2020 6e62 7472 6961  loat).    nbtria
-00016db0: 6c3a 206e 756d 6265 7220 6f66 2073 7472  l: number of str
-00016dc0: 6574 6368 696e 6720 636f 6566 6669 6369  etching coeffici
-00016dd0: 656e 7420 6265 7477 6565 6e20 6476 6d69  ent between dvmi
-00016de0: 6e20 616e 6420 6476 6d61 782c 206e 6f20  n and dvmax, no 
-00016df0: 6e65 6564 2074 6f20 6265 2068 6967 6865  need to be highe
-00016e00: 7220 7468 616e 2031 3030 2020 2866 6c6f  r than 100  (flo
-00016e10: 6174 290a 2020 2020 646a 2c20 7330 2c20  at).    dj, s0, 
-00016e20: 4a2c 2073 6967 2c20 7776 6e3a 2063 6f6d  J, sig, wvn: com
-00016e30: 6d6f 6e20 7061 7261 6d65 7465 7273 2075  mon parameters u
-00016e40: 7365 6420 696e 2027 7761 7665 6c65 742e  sed in 'wavelet.
-00016e50: 7763 7427 0a20 2020 206e 6f72 6d61 6c69  wct'.    normali
-00016e60: 7a65 3a20 6e6f 726d 616c 697a 6520 7468  ze: normalize th
-00016e70: 6520 7761 7665 6c65 7420 7370 6563 7472  e wavelet spectr
-00016e80: 756d 206f 7220 6e6f 742e 2044 6566 6175  um or not. Defau
-00016e90: 6c74 2069 7320 5472 7565 0a0a 2020 2020  lt is True..    
-00016ea0: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
-00016eb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-00016ec0: 2020 2020 6476 763a 2065 7374 696d 6174      dvv: estimat
-00016ed0: 6564 2064 762f 760a 2020 2020 6572 723a  ed dv/v.    err:
-00016ee0: 2065 7272 6f72 206f 6620 6476 2f76 2065   error of dv/v e
-00016ef0: 7374 696d 6174 696f 6e0a 0a20 2020 2057  stimation..    W
-00016f00: 7269 7474 656e 2062 7920 436f 6e67 636f  ritten by Congco
-00016f10: 6e67 2059 7561 6e20 2833 3020 4a75 6e2c  ng Yuan (30 Jun,
-00016f20: 2032 3031 3929 0a20 2020 2022 2222 0a20   2019).    """. 
-00016f30: 2020 2023 2063 6f6d 6d6f 6e20 7661 7269     # common vari
-00016f40: 6162 6c65 730a 2020 2020 6672 6571 203d  ables.    freq =
-00016f50: 2070 6172 615b 2266 7265 7122 5d0a 2020   para["freq"].  
-00016f60: 2020 6474 203d 2070 6172 615b 2264 7422    dt = para["dt"
-00016f70: 5d0a 2020 2020 666d 696e 203d 206e 702e  ].    fmin = np.
-00016f80: 6d69 6e28 6672 6571 290a 2020 2020 666d  min(freq).    fm
-00016f90: 6178 203d 206e 702e 6d61 7828 6672 6571  ax = np.max(freq
-00016fa0: 290a 0a20 2020 2023 2061 7070 6c79 2063  )..    # apply c
-00016fb0: 7774 206f 6e20 7477 6f20 7472 6163 6573  wt on two traces
-00016fc0: 0a20 2020 2063 7774 312c 2073 6a2c 2066  .    cwt1, sj, f
-00016fd0: 7265 712c 2063 6f69 2c20 5f2c 205f 203d  req, coi, _, _ =
-00016fe0: 2070 7963 7774 2e63 7774 2863 7572 2c20   pycwt.cwt(cur, 
-00016ff0: 6474 2c20 646a 2c20 7330 2c20 4a2c 2077  dt, dj, s0, J, w
-00017000: 766e 290a 2020 2020 6377 7432 2c20 736a  vn).    cwt2, sj
-00017010: 2c20 6672 6571 2c20 636f 692c 205f 2c20  , freq, coi, _, 
-00017020: 5f20 3d20 7079 6377 742e 6377 7428 7265  _ = pycwt.cwt(re
-00017030: 662c 2064 742c 2064 6a2c 2073 302c 204a  f, dt, dj, s0, J
-00017040: 2c20 7776 6e29 0a0a 2020 2020 2320 6578  , wvn)..    # ex
-00017050: 7472 6163 7420 7265 616c 2076 616c 7565  tract real value
-00017060: 7320 6f66 2063 7774 0a20 2020 2072 6377  s of cwt.    rcw
-00017070: 7431 2c20 7263 7774 3220 3d20 6e70 2e72  t1, rcwt2 = np.r
-00017080: 6561 6c28 6377 7431 292c 206e 702e 7265  eal(cwt1), np.re
-00017090: 616c 2863 7774 3229 0a0a 2020 2020 2320  al(cwt2)..    # 
-000170a0: 7a65 726f 206f 7574 2064 6174 6120 6f75  zero out data ou
-000170b0: 7473 6964 6520 6672 6571 7565 6e63 7920  tside frequency 
-000170c0: 6261 6e64 0a20 2020 2069 6620 2866 6d61  band.    if (fma
-000170d0: 7820 3e20 6e70 2e6d 6178 2866 7265 7129  x > np.max(freq)
-000170e0: 2920 7c20 2866 6d61 7820 3c3d 2066 6d69  ) | (fmax <= fmi
-000170f0: 6e29 3a0a 2020 2020 2020 2020 7261 6973  n):.        rais
-00017100: 6520 5661 6c75 6545 7272 6f72 2822 4162  e ValueError("Ab
-00017110: 6f72 743a 2069 6e70 7574 2066 7265 7175  ort: input frequ
-00017120: 656e 6379 206f 7574 206f 6620 6c69 6d69  ency out of limi
-00017130: 7473 2122 290a 2020 2020 656c 7365 3a0a  ts!").    else:.
-00017140: 2020 2020 2020 2020 6672 6571 5f69 6e64          freq_ind
-00017150: 696e 203d 206e 702e 7768 6572 6528 2866  in = np.where((f
-00017160: 7265 7120 3e3d 2066 6d69 6e29 2026 2028  req >= fmin) & (
-00017170: 6672 6571 203c 3d20 666d 6178 2929 5b30  freq <= fmax))[0
-00017180: 5d0a 0a20 2020 2023 2063 6f6e 7665 7274  ]..    # convert
-00017190: 2077 6176 656c 6574 2064 6f6d 6169 6e20   wavelet domain 
-000171a0: 6261 636b 2074 6f20 7469 6d65 2064 6f6d  back to time dom
-000171b0: 6169 6e20 287e 6669 6c74 6572 696e 6729  ain (~filtering)
-000171c0: 0a20 2020 2069 6620 6e6f 7420 616c 6c66  .    if not allf
-000171d0: 7265 713a 0a20 2020 2020 2020 2023 2069  req:.        # i
-000171e0: 6e76 6572 7365 2063 7774 2074 6f20 7469  nverse cwt to ti
-000171f0: 6d65 2064 6f6d 6169 6e0a 2020 2020 2020  me domain.      
-00017200: 2020 6963 7774 3120 3d20 7079 6377 742e    icwt1 = pycwt.
-00017210: 6963 7774 2863 7774 315b 6672 6571 5f69  icwt(cwt1[freq_i
-00017220: 6e64 696e 5d2c 2073 6a5b 6672 6571 5f69  ndin], sj[freq_i
-00017230: 6e64 696e 5d2c 2064 742c 2064 6a2c 2077  ndin], dt, dj, w
-00017240: 766e 290a 2020 2020 2020 2020 6963 7774  vn).        icwt
-00017250: 3220 3d20 7079 6377 742e 6963 7774 2863  2 = pycwt.icwt(c
-00017260: 7774 325b 6672 6571 5f69 6e64 696e 5d2c  wt2[freq_indin],
-00017270: 2073 6a5b 6672 6571 5f69 6e64 696e 5d2c   sj[freq_indin],
-00017280: 2064 742c 2064 6a2c 2077 766e 290a 0a20   dt, dj, wvn).. 
-00017290: 2020 2020 2020 2023 2061 7373 756d 6520         # assume 
-000172a0: 616c 6c20 7469 6d65 2077 696e 646f 7720  all time window 
-000172b0: 6973 2075 7365 640a 2020 2020 2020 2020  is used.        
-000172c0: 7763 7774 312c 2077 6377 7432 203d 206e  wcwt1, wcwt2 = n
-000172d0: 702e 7265 616c 2869 6377 7431 292c 206e  p.real(icwt1), n
-000172e0: 702e 7265 616c 2869 6377 7432 290a 0a20  p.real(icwt2).. 
-000172f0: 2020 2020 2020 2023 204e 6f72 6d61 6c69         # Normali
-00017300: 7a65 7320 626f 7468 2073 6967 6e61 6c73  zes both signals
-00017310: 2c20 6966 2061 7070 726f 7072 6961 7465  , if appropriate
-00017320: 2e0a 2020 2020 2020 2020 6966 206e 6f72  ..        if nor
-00017330: 6d61 6c69 7a65 3a0a 2020 2020 2020 2020  malize:.        
-00017340: 2020 2020 6e63 7774 3120 3d20 2877 6377      ncwt1 = (wcw
-00017350: 7431 202d 2077 6377 7431 2e6d 6561 6e28  t1 - wcwt1.mean(
-00017360: 2929 202f 2077 6377 7431 2e73 7464 2829  )) / wcwt1.std()
-00017370: 0a20 2020 2020 2020 2020 2020 206e 6377  .            ncw
-00017380: 7432 203d 2028 7763 7774 3220 2d20 7763  t2 = (wcwt2 - wc
-00017390: 7774 322e 6d65 616e 2829 2920 2f20 7763  wt2.mean()) / wc
-000173a0: 7774 322e 7374 6428 290a 2020 2020 2020  wt2.std().      
-000173b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000173c0: 2020 2020 6e63 7774 3120 3d20 7763 7774      ncwt1 = wcwt
-000173d0: 310a 2020 2020 2020 2020 2020 2020 6e63  1.            nc
-000173e0: 7774 3220 3d20 7763 7774 320a 0a20 2020  wt2 = wcwt2..   
-000173f0: 2020 2020 2023 2072 756e 2073 7472 6574       # run stret
-00017400: 6368 696e 670a 2020 2020 2020 2020 6476  ching.        dv
-00017410: 762c 2065 7272 2c20 6363 2c20 6364 7020  v, err, cc, cdp 
-00017420: 3d20 7374 7265 7463 6869 6e67 286e 6377  = stretching(ncw
-00017430: 7432 2c20 6e63 7774 312c 2064 765f 7261  t2, ncwt1, dv_ra
-00017440: 6e67 652c 206e 6274 7269 616c 2c20 7061  nge, nbtrial, pa
-00017450: 7261 290a 2020 2020 2020 2020 7265 7475  ra).        retu
-00017460: 726e 2064 7676 2c20 6572 720a 0a20 2020  rn dvv, err..   
-00017470: 2023 2064 6972 6563 746c 7920 7461 6b65   # directly take
-00017480: 2061 6476 616e 7461 6765 206f 6620 7468   advantage of th
-00017490: 650a 2020 2020 656c 7365 3a0a 2020 2020  e.    else:.    
-000174a0: 2020 2020 2320 696e 6974 6961 6c69 7a65      # initialize
-000174b0: 2076 6172 6961 626c 650a 2020 2020 2020   variable.      
-000174c0: 2020 6e66 7265 7120 3d20 6c65 6e28 6672    nfreq = len(fr
-000174d0: 6571 5f69 6e64 696e 290a 2020 2020 2020  eq_indin).      
-000174e0: 2020 6476 762c 2063 632c 2063 6470 2c20    dvv, cc, cdp, 
-000174f0: 6572 7220 3d20 280a 2020 2020 2020 2020  err = (.        
-00017500: 2020 2020 6e70 2e7a 6572 6f73 286e 6672      np.zeros(nfr
-00017510: 6571 2c20 6474 7970 653d 6e70 2e66 6c6f  eq, dtype=np.flo
-00017520: 6174 3332 292c 0a20 2020 2020 2020 2020  at32),.         
-00017530: 2020 206e 702e 7a65 726f 7328 6e66 7265     np.zeros(nfre
-00017540: 712c 2064 7479 7065 3d6e 702e 666c 6f61  q, dtype=np.floa
-00017550: 7433 3229 2c0a 2020 2020 2020 2020 2020  t32),.          
-00017560: 2020 6e70 2e7a 6572 6f73 286e 6672 6571    np.zeros(nfreq
-00017570: 2c20 6474 7970 653d 6e70 2e66 6c6f 6174  , dtype=np.float
-00017580: 3332 292c 0a20 2020 2020 2020 2020 2020  32),.           
-00017590: 206e 702e 7a65 726f 7328 6e66 7265 712c   np.zeros(nfreq,
-000175a0: 2064 7479 7065 3d6e 702e 666c 6f61 7433   dtype=np.float3
-000175b0: 3229 2c0a 2020 2020 2020 2020 290a 0a20  2),.        ).. 
-000175c0: 2020 2020 2020 2023 206c 6f6f 7020 7468         # loop th
-000175d0: 726f 7567 6820 6561 6368 2066 7265 710a  rough each freq.
-000175e0: 2020 2020 2020 2020 666f 7220 6969 2c20          for ii, 
-000175f0: 6966 7265 7120 696e 2065 6e75 6d65 7261  ifreq in enumera
-00017600: 7465 2866 7265 715f 696e 6469 6e29 3a0a  te(freq_indin):.
-00017610: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-00017620: 6570 6172 6520 7769 6e64 6f77 6564 2064  epare windowed d
-00017630: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
-00017640: 7763 7774 312c 2077 6377 7432 203d 2072  wcwt1, wcwt2 = r
-00017650: 6377 7431 5b69 6672 6571 5d2c 2072 6377  cwt1[ifreq], rcw
-00017660: 7432 5b69 6672 6571 5d0a 0a20 2020 2020  t2[ifreq]..     
-00017670: 2020 2020 2020 2023 204e 6f72 6d61 6c69         # Normali
-00017680: 7a65 7320 626f 7468 2073 6967 6e61 6c73  zes both signals
-00017690: 2c20 6966 2061 7070 726f 7072 6961 7465  , if appropriate
-000176a0: 2e0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-000176b0: 206e 6f72 6d61 6c69 7a65 3a0a 2020 2020   normalize:.    
-000176c0: 2020 2020 2020 2020 2020 2020 6e63 7774              ncwt
-000176d0: 3120 3d20 2877 6377 7431 202d 2077 6377  1 = (wcwt1 - wcw
-000176e0: 7431 2e6d 6561 6e28 2929 202f 2077 6377  t1.mean()) / wcw
-000176f0: 7431 2e73 7464 2829 0a20 2020 2020 2020  t1.std().       
-00017700: 2020 2020 2020 2020 206e 6377 7432 203d           ncwt2 =
-00017710: 2028 7763 7774 3220 2d20 7763 7774 322e   (wcwt2 - wcwt2.
-00017720: 6d65 616e 2829 2920 2f20 7763 7774 322e  mean()) / wcwt2.
-00017730: 7374 6428 290a 2020 2020 2020 2020 2020  std().          
-00017740: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00017750: 2020 2020 2020 2020 6e63 7774 3120 3d20          ncwt1 = 
-00017760: 7763 7774 310a 2020 2020 2020 2020 2020  wcwt1.          
-00017770: 2020 2020 2020 6e63 7774 3220 3d20 7763        ncwt2 = wc
-00017780: 7774 320a 0a20 2020 2020 2020 2020 2020  wt2..           
-00017790: 2023 2072 756e 2073 7472 6574 6368 696e   # run stretchin
-000177a0: 670a 2020 2020 2020 2020 2020 2020 6476  g.            dv
-000177b0: 2c20 6572 726f 722c 2063 312c 2063 3220  , error, c1, c2 
-000177c0: 3d20 7374 7265 7463 6869 6e67 286e 6377  = stretching(ncw
-000177d0: 7432 2c20 6e63 7774 312c 2064 765f 7261  t2, ncwt1, dv_ra
-000177e0: 6e67 652c 206e 6274 7269 616c 2c20 7061  nge, nbtrial, pa
-000177f0: 7261 290a 2020 2020 2020 2020 2020 2020  ra).            
-00017800: 6476 765b 6969 5d2c 2063 635b 6969 5d2c  dvv[ii], cc[ii],
-00017810: 2063 6470 5b69 695d 2c20 6572 725b 6969   cdp[ii], err[ii
-00017820: 5d20 3d20 6476 2c20 6331 2c20 6332 2c20  ] = dv, c1, c2, 
-00017830: 6572 726f 720a 0a20 2020 2020 2020 2072  error..        r
-00017840: 6574 7572 6e20 6672 6571 5b66 7265 715f  eturn freq[freq_
-00017850: 696e 6469 6e5d 2c20 6476 762c 2065 7272  indin], dvv, err
-00017860: 0a0a 0a64 6566 2077 7464 7477 5f61 6c6c  ...def wtdtw_all
-00017870: 6672 6571 280a 2020 2020 7265 662c 0a20  freq(.    ref,. 
-00017880: 2020 2063 7572 2c0a 2020 2020 616c 6c66     cur,.    allf
-00017890: 7265 712c 0a20 2020 2070 6172 612c 0a20  req,.    para,. 
-000178a0: 2020 206d 6178 4c61 672c 0a20 2020 2062     maxLag,.    b
-000178b0: 2c0a 2020 2020 6469 7265 6374 696f 6e2c  ,.    direction,
-000178c0: 0a20 2020 2064 6a3d 3120 2f20 3132 2c0a  .    dj=1 / 12,.
-000178d0: 2020 2020 7330 3d2d 312c 0a20 2020 204a      s0=-1,.    J
-000178e0: 3d2d 312c 0a20 2020 2077 766e 3d22 6d6f  =-1,.    wvn="mo
-000178f0: 726c 6574 222c 0a20 2020 206e 6f72 6d61  rlet",.    norma
-00017900: 6c69 7a65 3d54 7275 652c 0a29 3a0a 2020  lize=True,.):.  
-00017910: 2020 2222 220a 2020 2020 4170 706c 7920    """.    Apply 
-00017920: 6479 6e61 6d69 6320 7469 6d65 2077 6172  dynamic time war
-00017930: 7069 6e67 206d 6574 686f 6420 746f 2063  ping method to c
-00017940: 6f6e 7469 6e75 6f75 7320 7761 7665 6c65  ontinuous wavele
-00017950: 7420 7472 616e 7366 6f72 6d61 7469 6f6e  t transformation
-00017960: 2028 4357 5429 206f 6620 7369 676e 616c   (CWT) of signal
-00017970: 730a 2020 2020 666f 7220 616c 6c20 6672  s.    for all fr
-00017980: 6571 7565 6369 6573 2069 6e20 616e 2069  equecies in an i
-00017990: 6e74 6572 6573 7420 7261 6e67 650a 0a20  nterest range.. 
-000179a0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-000179b0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-000179c0: 0a20 2020 2072 6566 3a20 5468 6520 2252  .    ref: The "R
-000179d0: 6566 6572 656e 6365 2220 7469 6d65 7365  eference" timese
-000179e0: 7269 6573 2028 6e75 6d70 792e 6e64 6172  ries (numpy.ndar
-000179f0: 7261 7929 0a20 2020 2063 7572 3a20 5468  ray).    cur: Th
-00017a00: 6520 2243 7572 7265 6e74 2220 7469 6d65  e "Current" time
-00017a10: 7365 7269 6573 2028 6e75 6d70 792e 6e64  series (numpy.nd
-00017a20: 6172 7261 7929 0a20 2020 2061 6c6c 6672  array).    allfr
-00017a30: 6571 3a20 6120 626f 6f6c 656e 2076 6172  eq: a boolen var
-00017a40: 6961 626c 6520 746f 206d 616b 6520 6d65  iable to make me
-00017a50: 6173 7572 656d 656e 7473 206f 6e20 616c  asurements on al
-00017a60: 6c20 6672 6571 7565 6e63 7920 7261 6e67  l frequency rang
-00017a70: 6520 6f72 206e 6f74 0a20 2020 206d 6178  e or not.    max
-00017a80: 4c61 673a 206d 6178 206e 756d 6265 7220  Lag: max number 
-00017a90: 6f66 2070 6f69 6e74 7320 746f 2073 6561  of points to sea
-00017aa0: 7263 6820 666f 7277 6172 6420 616e 6420  rch forward and 
-00017ab0: 6261 636b 7761 7264 2e0a 2020 2020 623a  backward..    b:
-00017ac0: 2062 2d76 616c 7565 2074 6f20 6c69 6d69   b-value to limi
-00017ad0: 7420 7374 7261 696e 2c20 7768 6963 6820  t strain, which 
-00017ae0: 6973 2074 6f20 6c69 6d69 7420 7468 6520  is to limit the 
-00017af0: 6d61 7869 6d75 6d20 7665 6c6f 6369 7479  maximum velocity
-00017b00: 2070 6572 7475 7262 6174 696f 6e2e 0a20   perturbation.. 
-00017b10: 2020 2053 6565 2065 7175 6174 696f 6e20     See equation 
-00017b20: 3131 2069 6e20 284d 696b 6573 656c 6c20  11 in (Mikesell 
-00017b30: 6574 2061 6c2e 2032 3031 3529 0a20 2020  et al. 2015).   
-00017b40: 2064 6972 6563 7469 6f6e 3a20 6469 7265   direction: dire
-00017b50: 6374 696f 6e20 746f 2061 6363 756d 756c  ction to accumul
-00017b60: 6174 6520 6572 726f 7273 2028 313d 666f  ate errors (1=fo
-00017b70: 7277 6172 642c 202d 313d 6261 636b 7761  rward, -1=backwa
-00017b80: 7264 290a 2020 2020 646a 2c20 7330 2c20  rd).    dj, s0, 
-00017b90: 4a2c 2073 6967 2c20 7776 6e3a 2063 6f6d  J, sig, wvn: com
-00017ba0: 6d6f 6e20 7061 7261 6d65 7465 7273 2075  mon parameters u
-00017bb0: 7365 6420 696e 2027 7761 7665 6c65 742e  sed in 'wavelet.
-00017bc0: 7763 7427 0a20 2020 206e 6f72 6d61 6c69  wct'.    normali
-00017bd0: 7a65 3a20 6e6f 726d 616c 697a 6520 7468  ze: normalize th
-00017be0: 6520 7761 7665 6c65 7420 7370 6563 7472  e wavelet spectr
-00017bf0: 756d 206f 7220 6e6f 742e 2044 6566 6175  um or not. Defau
-00017c00: 6c74 2069 7320 5472 7565 0a0a 2020 2020  lt is True..    
-00017c10: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
-00017c20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-00017c30: 2020 2020 6476 763a 2065 7374 696d 6174      dvv: estimat
-00017c40: 6564 2064 762f 760a 2020 2020 6572 723a  ed dv/v.    err:
-00017c50: 2065 7272 6f72 206f 6620 6476 2f76 2065   error of dv/v e
-00017c60: 7374 696d 6174 696f 6e0a 0a20 2020 2057  stimation..    W
-00017c70: 7269 7474 656e 2062 7920 436f 6e67 636f  ritten by Congco
-00017c80: 6e67 2059 7561 6e20 2833 3020 4a75 6e2c  ng Yuan (30 Jun,
-00017c90: 2032 3031 3929 0a20 2020 2022 2222 0a20   2019).    """. 
-00017ca0: 2020 2023 2063 6f6d 6d6f 6e20 7661 7269     # common vari
-00017cb0: 6162 6c65 730a 2020 2020 6672 6571 203d  ables.    freq =
-00017cc0: 2070 6172 615b 2266 7265 7122 5d0a 2020   para["freq"].  
-00017cd0: 2020 6474 203d 2070 6172 615b 2264 7422    dt = para["dt"
-00017ce0: 5d0a 2020 2020 666d 696e 203d 206e 702e  ].    fmin = np.
-00017cf0: 6d69 6e28 6672 6571 290a 2020 2020 666d  min(freq).    fm
-00017d00: 6178 203d 206e 702e 6d61 7828 6672 6571  ax = np.max(freq
-00017d10: 290a 0a20 2020 2023 2061 7070 6c79 2063  )..    # apply c
-00017d20: 7774 206f 6e20 7477 6f20 7472 6163 6573  wt on two traces
-00017d30: 0a20 2020 2063 7774 312c 2073 6a2c 2066  .    cwt1, sj, f
-00017d40: 7265 712c 2063 6f69 2c20 5f2c 205f 203d  req, coi, _, _ =
-00017d50: 2070 7963 7774 2e63 7774 2863 7572 2c20   pycwt.cwt(cur, 
-00017d60: 6474 2c20 646a 2c20 7330 2c20 4a2c 2077  dt, dj, s0, J, w
-00017d70: 766e 290a 2020 2020 6377 7432 2c20 736a  vn).    cwt2, sj
-00017d80: 2c20 6672 6571 2c20 636f 692c 205f 2c20  , freq, coi, _, 
-00017d90: 5f20 3d20 7079 6377 742e 6377 7428 7265  _ = pycwt.cwt(re
-00017da0: 662c 2064 742c 2064 6a2c 2073 302c 204a  f, dt, dj, s0, J
-00017db0: 2c20 7776 6e29 0a0a 2020 2020 2320 6578  , wvn)..    # ex
-00017dc0: 7472 6163 7420 7265 616c 2076 616c 7565  tract real value
-00017dd0: 7320 6f66 2063 7774 0a20 2020 2072 6377  s of cwt.    rcw
-00017de0: 7431 2c20 7263 7774 3220 3d20 6e70 2e72  t1, rcwt2 = np.r
-00017df0: 6561 6c28 6377 7431 292c 206e 702e 7265  eal(cwt1), np.re
-00017e00: 616c 2863 7774 3229 0a0a 2020 2020 2320  al(cwt2)..    # 
-00017e10: 7a65 726f 206f 7574 2063 6f6e 6520 6f66  zero out cone of
-00017e20: 2069 6e66 6c75 656e 6365 2061 6e64 2064   influence and d
-00017e30: 6174 6120 6f75 7473 6964 6520 6672 6571  ata outside freq
-00017e40: 7565 6e63 7920 6261 6e64 0a20 2020 2069  uency band.    i
-00017e50: 6620 2866 6d61 7820 3e20 6e70 2e6d 6178  f (fmax > np.max
-00017e60: 2866 7265 7129 2920 7c20 2866 6d61 7820  (freq)) | (fmax 
-00017e70: 3c3d 2066 6d69 6e29 3a0a 2020 2020 2020  <= fmin):.      
-00017e80: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00017e90: 6f72 2822 4162 6f72 743a 2069 6e70 7574  or("Abort: input
-00017ea0: 2066 7265 7175 656e 6379 206f 7574 206f   frequency out o
-00017eb0: 6620 6c69 6d69 7473 2122 290a 2020 2020  f limits!").    
-00017ec0: 656c 7365 3a0a 2020 2020 2020 2020 6672  else:.        fr
-00017ed0: 6571 5f69 6e64 696e 203d 206e 702e 7768  eq_indin = np.wh
-00017ee0: 6572 6528 2866 7265 7120 3e3d 2066 6d69  ere((freq >= fmi
-00017ef0: 6e29 2026 2028 6672 6571 203c 3d20 666d  n) & (freq <= fm
-00017f00: 6178 2929 5b30 5d0a 0a20 2020 2020 2020  ax))[0]..       
-00017f10: 2023 2055 7365 2044 5457 206d 6574 686f   # Use DTW metho
-00017f20: 6420 746f 2065 7874 7261 6374 2064 7676  d to extract dvv
-00017f30: 0a20 2020 2020 2020 206e 6672 6571 203d  .        nfreq =
-00017f40: 206c 656e 2866 7265 715f 696e 6469 6e29   len(freq_indin)
-00017f50: 0a20 2020 2020 2020 2064 7676 2c20 6572  .        dvv, er
-00017f60: 7220 3d20 6e70 2e7a 6572 6f73 286e 6672  r = np.zeros(nfr
-00017f70: 6571 2c20 6474 7970 653d 6e70 2e66 6c6f  eq, dtype=np.flo
-00017f80: 6174 3332 292c 206e 702e 7a65 726f 7328  at32), np.zeros(
-00017f90: 6e66 7265 712c 2064 7479 7065 3d6e 702e  nfreq, dtype=np.
-00017fa0: 666c 6f61 7433 3229 0a0a 2020 2020 2020  float32)..      
-00017fb0: 2020 666f 7220 6969 2c20 6966 7265 7120    for ii, ifreq 
-00017fc0: 696e 2065 6e75 6d65 7261 7465 2866 7265  in enumerate(fre
-00017fd0: 715f 696e 6469 6e29 3a0a 2020 2020 2020  q_indin):.      
-00017fe0: 2020 2020 2020 2320 7072 6570 6172 6520        # prepare 
-00017ff0: 7769 6e64 6f77 6564 2064 6174 610a 2020  windowed data.  
-00018000: 2020 2020 2020 2020 2020 7763 7774 312c            wcwt1,
-00018010: 2077 6377 7432 203d 2072 6377 7431 5b69   wcwt2 = rcwt1[i
-00018020: 6672 6571 5d2c 2072 6377 7432 5b69 6672  freq], rcwt2[ifr
-00018030: 6571 5d0a 2020 2020 2020 2020 2020 2020  eq].            
-00018040: 2320 4e6f 726d 616c 697a 6573 2062 6f74  # Normalizes bot
-00018050: 6820 7369 676e 616c 732c 2069 6620 6170  h signals, if ap
-00018060: 7072 6f70 7269 6174 652e 0a20 2020 2020  propriate..     
-00018070: 2020 2020 2020 2069 6620 6e6f 726d 616c         if normal
-00018080: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
-00018090: 2020 2020 206e 6377 7431 203d 2028 7763       ncwt1 = (wc
-000180a0: 7774 3120 2d20 7763 7774 312e 6d65 616e  wt1 - wcwt1.mean
-000180b0: 2829 2920 2f20 7763 7774 312e 7374 6428  ()) / wcwt1.std(
-000180c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000180d0: 2020 6e63 7774 3220 3d20 2877 6377 7432    ncwt2 = (wcwt2
-000180e0: 202d 2077 6377 7432 2e6d 6561 6e28 2929   - wcwt2.mean())
-000180f0: 202f 2077 6377 7432 2e73 7464 2829 0a20   / wcwt2.std(). 
-00018100: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00018110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018120: 206e 6377 7431 203d 2077 6377 7431 0a20   ncwt1 = wcwt1. 
-00018130: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00018140: 6377 7432 203d 2077 6377 7432 0a0a 2020  cwt2 = wcwt2..  
-00018150: 2020 2020 2020 2020 2020 2320 7275 6e20            # run 
-00018160: 6474 770a 2020 2020 2020 2020 2020 2020  dtw.            
-00018170: 6476 2c20 6572 726f 722c 2064 6973 7420  dv, error, dist 
-00018180: 3d20 6474 775f 6476 7628 6e63 7774 322c  = dtw_dvv(ncwt2,
-00018190: 206e 6377 7431 2c20 7061 7261 2c20 6d61   ncwt1, para, ma
-000181a0: 784c 6167 2c20 622c 2064 6972 6563 7469  xLag, b, directi
-000181b0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-000181c0: 6476 765b 6969 5d2c 2065 7272 5b69 695d  dvv[ii], err[ii]
-000181d0: 203d 2064 762c 2065 7272 6f72 0a0a 2020   = dv, error..  
-000181e0: 2020 6465 6c20 6377 7431 2c20 6377 7432    del cwt1, cwt2
-000181f0: 2c20 7263 7774 312c 2072 6377 7432 2c20  , rcwt1, rcwt2, 
-00018200: 6e63 7774 312c 206e 6377 7432 2c20 7763  ncwt1, ncwt2, wc
-00018210: 7774 312c 2077 6377 7432 2c20 636f 692c  wt1, wcwt2, coi,
-00018220: 2073 6a2c 2064 6973 740a 0a20 2020 2069   sj, dist..    i
-00018230: 6620 6e6f 7420 616c 6c66 7265 713a 0a20  f not allfreq:. 
-00018240: 2020 2020 2020 2072 6574 7572 6e20 6e70         return np
-00018250: 2e6d 6561 6e28 6476 7629 2c20 6e70 2e6d  .mean(dvv), np.m
-00018260: 6561 6e28 6572 7229 0a20 2020 2065 6c73  ean(err).    els
-00018270: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-00018280: 6e20 6672 6571 5b66 7265 715f 696e 6469  n freq[freq_indi
-00018290: 6e5d 2c20 6476 762c 2065 7272 0a0a 0a23  n], dvv, err...#
-000182a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000bad0: 2d2d 2d2d 2d0a 2020 2020 7369 6732 3a20  -----.    sig2: 
+0000bae0: 2069 6e74 6572 706f 6c61 7465 6420 7365   interpolated se
+0000baf0: 6973 6d69 6320 7265 636f 7264 696e 6773  ismic recordings
+0000bb00: 206f 6e20 7468 6520 7361 6d70 6c69 6e67   on the sampling
+0000bb10: 2070 6f69 6e74 730a 2020 2020 2222 220a   points.    """.
+0000bb20: 2020 2020 6e70 7473 203d 206c 656e 2873      npts = len(s
+0000bb30: 6967 3129 0a20 2020 2073 6967 3220 3d20  ig1).    sig2 = 
+0000bb40: 6e70 2e7a 6572 6f73 286e 7074 732c 2064  np.zeros(npts, d
+0000bb50: 7479 7065 3d6e 702e 666c 6f61 7433 3229  type=np.float32)
+0000bb60: 0a0a 2020 2020 2320 2d2d 2d2d 696e 7374  ..    # ----inst
+0000bb70: 6561 6420 6f66 2073 6869 6674 696e 672c  ead of shifting,
+0000bb80: 2064 6f20 6120 696e 7465 7270 6f6c 6174   do a interpolat
+0000bb90: 696f 6e2d 2d2d 2d2d 2d0a 2020 2020 666f  ion------.    fo
+0000bba0: 7220 6969 2069 6e20 7261 6e67 6528 6e70  r ii in range(np
+0000bbb0: 7473 293a 0a20 2020 2020 2020 2023 202d  ts):.        # -
+0000bbc0: 2d2d 2d64 6561 6c20 7769 7468 2065 6467  ---deal with edg
+0000bbd0: 6573 2d2d 2d2d 2d0a 2020 2020 2020 2020  es-----.        
+0000bbe0: 6966 2069 6920 3d3d 2030 206f 7220 6969  if ii == 0 or ii
+0000bbf0: 203d 3d20 6e70 7473 202d 2031 3a0a 2020   == npts - 1:.  
+0000bc00: 2020 2020 2020 2020 2020 7369 6732 5b69            sig2[i
+0000bc10: 695d 203d 2073 6967 315b 6969 5d0a 2020  i] = sig1[ii].  
+0000bc20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000bc30: 2020 2020 2020 2020 2320 2d2d 2d2d 2d2d          # ------
+0000bc40: 696e 7465 7270 6f6c 6174 6520 7573 696e  interpolate usin
+0000bc50: 6720 6120 6861 7420 6675 6e63 7469 6f6e  g a hat function
+0000bc60: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2020  ------.         
+0000bc70: 2020 2073 6967 325b 6969 5d20 3d20 2831     sig2[ii] = (1
+0000bc80: 202d 206e 6672 6963 2920 2a20 7369 6731   - nfric) * sig1
+0000bc90: 5b69 6920 2b20 315d 202b 206e 6672 6963  [ii + 1] + nfric
+0000bca0: 202a 2073 6967 315b 6969 5d0a 0a20 2020   * sig1[ii]..   
+0000bcb0: 2072 6574 7572 6e20 7369 6732 0a0a 0a64   return sig2...d
+0000bcc0: 6566 2072 6573 705f 7370 6563 7472 756d  ef resp_spectrum
+0000bcd0: 2873 6f75 7263 652c 2072 6573 705f 6669  (source, resp_fi
+0000bce0: 6c65 2c20 646f 776e 7361 6d70 5f66 7265  le, downsamp_fre
+0000bcf0: 712c 2070 7265 5f66 696c 743d 4e6f 6e65  q, pre_filt=None
+0000bd00: 293a 0a20 2020 2022 2222 0a20 2020 2074  ):.    """.    t
+0000bd10: 6869 7320 6675 6e63 7469 6f6e 2072 656d  his function rem
+0000bd20: 6f76 6573 2074 6865 2069 6e73 7472 756d  oves the instrum
+0000bd30: 656e 7420 7265 7370 6f6e 7365 2075 7369  ent response usi
+0000bd40: 6e67 2072 6573 706f 6e73 6520 7370 6563  ng response spec
+0000bd50: 7472 756d 2066 726f 6d20 6576 616c 7265  trum from evalre
+0000bd60: 7370 2e0a 2020 2020 7468 6520 7265 7370  sp..    the resp
+0000bd70: 6f6e 7365 2073 7065 6374 7275 6d20 6973  onse spectrum is
+0000bd80: 2065 7661 6c75 6174 6564 2062 6173 6564   evaluated based
+0000bd90: 206f 6e20 5245 5350 2f50 5a20 6669 6c65   on RESP/PZ file
+0000bda0: 7320 6265 666f 7265 2069 6e76 6572 7465  s before inverte
+0000bdb0: 6420 7573 696e 6720 7468 6520 6f62 7370  d using the obsp
+0000bdc0: 790a 2020 2020 6675 6e63 7469 6f6e 206f  y.    function o
+0000bdd0: 6620 696e 7665 7274 5f73 7065 6374 7275  f invert_spectru
+0000bde0: 6d2e 2061 206d 6f64 756c 6520 6f66 2063  m. a module of c
+0000bdf0: 7265 6174 655f 7265 7370 2e70 7920 6973  reate_resp.py is
+0000be00: 2070 726f 7669 6465 6420 696e 2064 6972   provided in dir
+0000be10: 6563 746f 7279 206f 6620 2761 6464 6974  ectory of 'addit
+0000be20: 696f 6e61 6c5f 6d6f 6475 6c65 7327 0a20  ional_modules'. 
+0000be30: 2020 2074 6f20 6372 6561 7465 2074 6865     to create the
+0000be40: 2072 6573 706f 6e73 6520 7370 6563 7472   response spectr
+0000be50: 756d 0a20 2020 2050 4152 414d 4554 4552  um.    PARAMETER
+0000be60: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+0000be70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0000be80: 2020 736f 7572 6365 3a20 6f62 7370 7920    source: obspy 
+0000be90: 7374 7265 616d 206f 626a 6563 7420 6f66  stream object of
+0000bea0: 2074 6172 6765 7465 6420 6e6f 6973 6520   targeted noise 
+0000beb0: 6461 7461 0a20 2020 2072 6573 705f 6669  data.    resp_fi
+0000bec0: 6c65 3a20 6e75 6d70 7920 6461 7461 2066  le: numpy data f
+0000bed0: 696c 6520 6f66 2072 6573 706f 6e73 6520  ile of response 
+0000bee0: 7370 6563 7472 756d 0a20 2020 2064 6f77  spectrum.    dow
+0000bef0: 6e73 616d 705f 6672 6571 3a20 7361 6d70  nsamp_freq: samp
+0000bf00: 6c69 6e67 2072 6174 6520 6f66 2074 6865  ling rate of the
+0000bf10: 2073 6f75 7263 6520 6461 7461 0a20 2020   source data.   
+0000bf20: 2070 7265 5f66 696c 743a 2070 7265 2d64   pre_filt: pre-d
+0000bf30: 6566 696e 6564 2066 696c 7465 7220 7061  efined filter pa
+0000bf40: 7261 6d65 7465 7273 0a20 2020 2052 4554  rameters.    RET
+0000bf50: 5552 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d  URNS:.    ------
+0000bf60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000bf70: 0a20 2020 2073 6f75 7263 653a 206f 6273  .    source: obs
+0000bf80: 7079 2073 7472 6561 6d20 6f62 6a65 6374  py stream object
+0000bf90: 206f 6620 6e6f 6973 6520 6461 7461 2077   of noise data w
+0000bfa0: 6974 6820 696e 7374 7275 6d65 6e74 2072  ith instrument r
+0000bfb0: 6573 706f 6e73 6520 7265 6d6f 7665 640a  esponse removed.
+0000bfc0: 2020 2020 2222 220a 2020 2020 2320 2d2d      """.    # --
+0000bfd0: 2d2d 2d2d 2d2d 7265 7370 5f66 696c 6520  ------resp_file 
+0000bfe0: 6973 2074 6865 2069 6e76 6572 7465 6420  is the inverted 
+0000bff0: 7370 6563 7472 756d 2072 6573 706f 6e73  spectrum respons
+0000c000: 652d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072  e---------.    r
+0000c010: 6573 707a 203d 206e 702e 6c6f 6164 2872  espz = np.load(r
+0000c020: 6573 705f 6669 6c65 290a 2020 2020 6e72  esp_file).    nr
+0000c030: 6573 707a 203d 2072 6573 707a 5b31 5d5b  espz = respz[1][
+0000c040: 3a5d 0a20 2020 2073 7065 635f 6672 6571  :].    spec_freq
+0000c050: 203d 206d 6178 2872 6573 707a 5b30 5d29   = max(respz[0])
+0000c060: 0a0a 2020 2020 2320 2d2d 2d2d 2d2d 2d6f  ..    # -------o
+0000c070: 6e20 6375 7272 656e 7420 7472 6163 652d  n current trace-
+0000c080: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6e66  ---------.    nf
+0000c090: 6674 203d 205f 6e70 7473 326e 6666 7428  ft = _npts2nfft(
+0000c0a0: 736f 7572 6365 5b30 5d2e 7374 6174 732e  source[0].stats.
+0000c0b0: 6e70 7473 290a 2020 2020 7370 7320 3d20  npts).    sps = 
+0000c0c0: 696e 7428 736f 7572 6365 5b30 5d2e 7374  int(source[0].st
+0000c0d0: 6174 732e 7361 6d70 6c69 6e67 5f72 6174  ats.sampling_rat
+0000c0e0: 6529 0a0a 2020 2020 2320 2d2d 2d2d 2d2d  e)..    # ------
+0000c0f0: 2d2d 2d64 6f20 7468 6520 696e 7465 7270  ---do the interp
+0000c100: 6f6c 6174 696f 6e20 6966 206e 6565 6465  olation if neede
+0000c110: 642d 2d2d 2d2d 2d2d 2d0a 2020 2020 6966  d--------.    if
+0000c120: 2073 7065 635f 6672 6571 203c 2030 2e35   spec_freq < 0.5
+0000c130: 202a 2073 7073 3a0a 2020 2020 2020 2020   * sps:.        
+0000c140: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000c150: 2822 7370 6563 7472 756d 2066 696c 6520  ("spectrum file 
+0000c160: 6861 7320 7065 616b 2066 7265 7120 736d  has peak freq sm
+0000c170: 616c 6c65 7220 7468 616e 2074 6865 2064  aller than the d
+0000c180: 6174 612c 2061 626f 7274 2122 290a 2020  ata, abort!").  
+0000c190: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000c1a0: 696e 6478 203d 206e 702e 7768 6572 6528  indx = np.where(
+0000c1b0: 7265 7370 7a5b 305d 203c 3d20 302e 3520  respz[0] <= 0.5 
+0000c1c0: 2a20 7370 7329 0a20 2020 2020 2020 206e  * sps).        n
+0000c1d0: 6672 6571 203d 206e 702e 6c69 6e73 7061  freq = np.linspa
+0000c1e0: 6365 2830 2c20 302e 3520 2a20 7370 732c  ce(0, 0.5 * sps,
+0000c1f0: 206e 6666 7420 2f2f 2032 202b 2031 290a   nfft // 2 + 1).
+0000c200: 2020 2020 2020 2020 6e72 6573 707a 203d          nrespz =
+0000c210: 206e 702e 696e 7465 7270 286e 6672 6571   np.interp(nfreq
+0000c220: 2c20 6e70 2e72 6561 6c28 7265 7370 7a5b  , np.real(respz[
+0000c230: 305d 5b69 6e64 785d 292c 2072 6573 707a  0][indx]), respz
+0000c240: 5b31 5d5b 696e 6478 5d29 0a0a 2020 2020  [1][indx])..    
+0000c250: 2320 2d2d 2d2d 646f 2069 6e74 6572 706f  # ----do interpo
+0000c260: 6c61 7469 6f6e 2069 6620 6e65 6365 7373  lation if necess
+0000c270: 6172 792d 2d2d 2d2d 0a20 2020 2073 6f75  ary-----.    sou
+0000c280: 7263 655f 7370 6563 7420 3d20 6e70 2e66  rce_spect = np.f
+0000c290: 6674 2e72 6666 7428 736f 7572 6365 5b30  ft.rfft(source[0
+0000c2a0: 5d2e 6461 7461 2c20 6e3d 6e66 6674 290a  ].data, n=nfft).
+0000c2b0: 0a20 2020 2023 202d 2d2d 2d2d 6e72 6573  .    # -----nres
+0000c2c0: 707a 2069 7320 696e 7665 7273 6564 2028  pz is inversed (
+0000c2d0: 7761 7465 722d 6c65 7665 6c65 6429 2073  water-leveled) s
+0000c2e0: 7065 6374 7275 6d2d 2d2d 2d2d 0a20 2020  pectrum-----.   
+0000c2f0: 2073 6f75 7263 655f 7370 6563 7420 2a3d   source_spect *=
+0000c300: 206e 7265 7370 7a0a 2020 2020 736f 7572   nrespz.    sour
+0000c310: 6365 5b30 5d2e 6461 7461 203d 206e 702e  ce[0].data = np.
+0000c320: 6666 742e 6972 6666 7428 736f 7572 6365  fft.irfft(source
+0000c330: 5f73 7065 6374 295b 3020 3a20 736f 7572  _spect)[0 : sour
+0000c340: 6365 5b30 5d2e 7374 6174 732e 6e70 7473  ce[0].stats.npts
+0000c350: 5d0a 0a20 2020 2069 6620 7072 655f 6669  ]..    if pre_fi
+0000c360: 6c74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  lt is not None:.
+0000c370: 2020 2020 2020 2020 736f 7572 6365 5b30          source[0
+0000c380: 5d2e 6461 7461 203d 206e 702e 666c 6f61  ].data = np.floa
+0000c390: 7433 3228 0a20 2020 2020 2020 2020 2020  t32(.           
+0000c3a0: 2062 616e 6470 6173 7328 0a20 2020 2020   bandpass(.     
+0000c3b0: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0000c3c0: 655b 305d 2e64 6174 612c 0a20 2020 2020  e[0].data,.     
+0000c3d0: 2020 2020 2020 2020 2020 2070 7265 5f66             pre_f
+0000c3e0: 696c 745b 305d 2c0a 2020 2020 2020 2020  ilt[0],.        
+0000c3f0: 2020 2020 2020 2020 7072 655f 6669 6c74          pre_filt
+0000c400: 5b2d 315d 2c0a 2020 2020 2020 2020 2020  [-1],.          
+0000c410: 2020 2020 2020 6466 3d73 7073 2c0a 2020        df=sps,.  
+0000c420: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000c430: 726e 6572 733d 342c 0a20 2020 2020 2020  rners=4,.       
+0000c440: 2020 2020 2020 2020 207a 6572 6f70 6861           zeropha
+0000c450: 7365 3d54 7275 652c 0a20 2020 2020 2020  se=True,.       
+0000c460: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
+0000c470: 0a0a 2020 2020 7265 7475 726e 2073 6f75  ..    return sou
+0000c480: 7263 650a 0a0a 6465 6620 6d61 6428 6172  rce...def mad(ar
+0000c490: 7229 3a0a 2020 2020 2222 220a 2020 2020  r):.    """.    
+0000c4a0: 4d65 6469 616e 2041 6273 6f6c 7574 6520  Median Absolute 
+0000c4b0: 4465 7669 6174 696f 6e3a 204d 4144 203d  Deviation: MAD =
+0000c4c0: 206d 6564 6961 6e28 7c58 692d 206d 6564   median(|Xi- med
+0000c4d0: 6961 6e28 5829 7c29 0a20 2020 2050 4152  ian(X)|).    PAR
+0000c4e0: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
+0000c4f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000c500: 0a20 2020 2061 7272 3a20 6e75 6d70 792e  .    arr: numpy.
+0000c510: 6e64 6172 7261 792c 2073 6569 736d 6963  ndarray, seismic
+0000c520: 2074 7261 6365 2064 6174 6120 6172 7261   trace data arra
+0000c530: 790a 2020 2020 5245 5455 524e 533a 0a20  y.    RETURNS:. 
+0000c540: 2020 2064 6174 613a 204d 6564 6961 6e20     data: Median 
+0000c550: 4162 736f 6c75 7465 2044 6576 6961 7469  Absolute Deviati
+0000c560: 6f6e 206f 6620 6461 7461 0a20 2020 2022  on of data.    "
+0000c570: 2222 0a20 2020 2069 6620 6e6f 7420 6e70  "".    if not np
+0000c580: 2e6d 612e 6973 5f6d 6173 6b65 6428 6172  .ma.is_masked(ar
+0000c590: 7229 3a0a 2020 2020 2020 2020 6d65 6420  r):.        med 
+0000c5a0: 3d20 6e70 2e6d 6564 6961 6e28 6172 7229  = np.median(arr)
+0000c5b0: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
+0000c5c0: 6e70 2e6d 6564 6961 6e28 6e70 2e61 6273  np.median(np.abs
+0000c5d0: 2861 7272 202d 206d 6564 2929 0a20 2020  (arr - med)).   
+0000c5e0: 2065 6c73 653a 0a20 2020 2020 2020 206d   else:.        m
+0000c5f0: 6564 203d 206e 702e 6d61 2e6d 6564 6961  ed = np.ma.media
+0000c600: 6e28 6172 7229 0a20 2020 2020 2020 2064  n(arr).        d
+0000c610: 6174 6120 3d20 6e70 2e6d 612e 6d65 6469  ata = np.ma.medi
+0000c620: 616e 286e 702e 6d61 2e61 6273 2861 7272  an(np.ma.abs(arr
+0000c630: 202d 206d 6564 2929 0a20 2020 2072 6574   - med)).    ret
+0000c640: 7572 6e20 6461 7461 0a0a 0a64 6566 2064  urn data...def d
+0000c650: 6574 7265 6e64 2864 6174 6129 3a0a 2020  etrend(data):.  
+0000c660: 2020 2222 220a 2020 2020 7468 6973 2066    """.    this f
+0000c670: 756e 6374 696f 6e20 7265 6d6f 7665 7320  unction removes 
+0000c680: 7468 6520 7369 676e 616c 2074 7265 6e64  the signal trend
+0000c690: 2062 6173 6564 206f 6e20 5152 2064 6563   based on QR dec
+0000c6a0: 6f6d 706f 7369 6f6e 0a20 2020 204e 4f54  omposion.    NOT
+0000c6b0: 453a 2051 5220 6973 2061 206c 6f74 2066  E: QR is a lot f
+0000c6c0: 6173 7465 7220 7468 616e 2074 6865 206c  aster than the l
+0000c6d0: 6561 7374 2073 7175 6172 6520 696e 7665  east square inve
+0000c6e0: 7273 696f 6e20 7573 6564 2062 790a 2020  rsion used by.  
+0000c6f0: 2020 7363 6970 7920 2861 6c73 6f20 696e    scipy (also in
+0000c700: 206f 6273 7079 292e 0a20 2020 2050 4152   obspy)..    PAR
+0000c710: 414d 4554 4552 533a 0a20 2020 202d 2d2d  AMETERS:.    ---
+0000c720: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000c730: 2d2d 0a20 2020 2064 6174 613a 2069 6e70  --.    data: inp
+0000c740: 7574 2064 6174 6120 6d61 7472 6978 0a20  ut data matrix. 
+0000c750: 2020 2052 4554 5552 4e53 3a0a 2020 2020     RETURNS:.    
+0000c760: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000c770: 2d2d 2d2d 2d0a 2020 2020 6461 7461 3a20  -----.    data: 
+0000c780: 6461 7461 206d 6174 7269 7820 7769 7468  data matrix with
+0000c790: 2074 7265 6e64 2072 656d 6f76 6564 0a20   trend removed. 
+0000c7a0: 2020 2022 2222 0a20 2020 2023 206e 6461     """.    # nda
+0000c7b0: 7461 203d 206e 702e 7a65 726f 7328 7368  ta = np.zeros(sh
+0000c7c0: 6170 653d 6461 7461 2e73 6861 7065 2c64  ape=data.shape,d
+0000c7d0: 7479 7065 3d64 6174 612e 6474 7970 6529  type=data.dtype)
+0000c7e0: 0a20 2020 2069 6620 6461 7461 2e6e 6469  .    if data.ndi
+0000c7f0: 6d20 3d3d 2031 3a0a 2020 2020 2020 2020  m == 1:.        
+0000c800: 6e70 7473 203d 2064 6174 612e 7368 6170  npts = data.shap
+0000c810: 655b 305d 0a20 2020 2020 2020 2058 203d  e[0].        X =
+0000c820: 206e 702e 6f6e 6573 2828 6e70 7473 2c20   np.ones((npts, 
+0000c830: 3229 290a 2020 2020 2020 2020 585b 3a2c  2)).        X[:,
+0000c840: 2030 5d20 3d20 6e70 2e61 7261 6e67 6528   0] = np.arange(
+0000c850: 302c 206e 7074 7329 202f 206e 7074 730a  0, npts) / npts.
+0000c860: 2020 2020 2020 2020 512c 2052 203d 206e          Q, R = n
+0000c870: 702e 6c69 6e61 6c67 2e71 7228 5829 0a20  p.linalg.qr(X). 
+0000c880: 2020 2020 2020 2072 7120 3d20 6e70 2e64         rq = np.d
+0000c890: 6f74 286e 702e 6c69 6e61 6c67 2e69 6e76  ot(np.linalg.inv
+0000c8a0: 2852 292c 2051 2e74 7261 6e73 706f 7365  (R), Q.transpose
+0000c8b0: 2829 290a 2020 2020 2020 2020 636f 6566  ()).        coef
+0000c8c0: 6620 3d20 6e70 2e64 6f74 2872 712c 2064  f = np.dot(rq, d
+0000c8d0: 6174 6129 0a20 2020 2020 2020 2064 6174  ata).        dat
+0000c8e0: 6120 3d20 6461 7461 202d 206e 702e 646f  a = data - np.do
+0000c8f0: 7428 582c 2063 6f65 6666 290a 2020 2020  t(X, coeff).    
+0000c900: 656c 6966 2064 6174 612e 6e64 696d 203d  elif data.ndim =
+0000c910: 3d20 323a 0a20 2020 2020 2020 206e 7074  = 2:.        npt
+0000c920: 7320 3d20 6461 7461 2e73 6861 7065 5b31  s = data.shape[1
+0000c930: 5d0a 2020 2020 2020 2020 5820 3d20 6e70  ].        X = np
+0000c940: 2e6f 6e65 7328 286e 7074 732c 2032 2929  .ones((npts, 2))
+0000c950: 0a20 2020 2020 2020 2058 5b3a 2c20 305d  .        X[:, 0]
+0000c960: 203d 206e 702e 6172 616e 6765 2830 2c20   = np.arange(0, 
+0000c970: 6e70 7473 2920 2f20 6e70 7473 0a20 2020  npts) / npts.   
+0000c980: 2020 2020 2051 2c20 5220 3d20 6e70 2e6c       Q, R = np.l
+0000c990: 696e 616c 672e 7172 2858 290a 2020 2020  inalg.qr(X).    
+0000c9a0: 2020 2020 7271 203d 206e 702e 646f 7428      rq = np.dot(
+0000c9b0: 6e70 2e6c 696e 616c 672e 696e 7628 5229  np.linalg.inv(R)
+0000c9c0: 2c20 512e 7472 616e 7370 6f73 6528 2929  , Q.transpose())
+0000c9d0: 0a20 2020 2020 2020 2066 6f72 2069 6920  .        for ii 
+0000c9e0: 696e 2072 616e 6765 2864 6174 612e 7368  in range(data.sh
+0000c9f0: 6170 655b 305d 293a 0a20 2020 2020 2020  ape[0]):.       
+0000ca00: 2020 2020 2063 6f65 6666 203d 206e 702e       coeff = np.
+0000ca10: 646f 7428 7271 2c20 6461 7461 5b69 695d  dot(rq, data[ii]
+0000ca20: 290a 2020 2020 2020 2020 2020 2020 6461  ).            da
+0000ca30: 7461 5b69 695d 203d 2064 6174 615b 6969  ta[ii] = data[ii
+0000ca40: 5d20 2d20 6e70 2e64 6f74 2858 2c20 636f  ] - np.dot(X, co
+0000ca50: 6566 6629 0a20 2020 2072 6574 7572 6e20  eff).    return 
+0000ca60: 6461 7461 0a0a 0a64 6566 2064 656d 6561  data...def demea
+0000ca70: 6e28 6461 7461 293a 0a20 2020 2022 2222  n(data):.    """
+0000ca80: 0a20 2020 2074 6869 7320 6675 6e63 7469  .    this functi
+0000ca90: 6f6e 2072 656d 6f76 6520 7468 6520 6d65  on remove the me
+0000caa0: 616e 206f 6620 7468 6520 7369 676e 616c  an of the signal
+0000cab0: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
+0000cac0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+0000cad0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064  ----------.    d
+0000cae0: 6174 613a 2069 6e70 7574 2064 6174 6120  ata: input data 
+0000caf0: 6d61 7472 6978 0a20 2020 2052 4554 5552  matrix.    RETUR
+0000cb00: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+0000cb10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0000cb20: 2020 6461 7461 3a20 6461 7461 206d 6174    data: data mat
+0000cb30: 7269 7820 7769 7468 206d 6561 6e20 7265  rix with mean re
+0000cb40: 6d6f 7665 640a 2020 2020 2222 220a 2020  moved.    """.  
+0000cb50: 2020 2320 6e64 6174 6120 3d20 6e70 2e7a    # ndata = np.z
+0000cb60: 6572 6f73 2873 6861 7065 3d64 6174 612e  eros(shape=data.
+0000cb70: 7368 6170 652c 6474 7970 653d 6461 7461  shape,dtype=data
+0000cb80: 2e64 7479 7065 290a 2020 2020 6966 2064  .dtype).    if d
+0000cb90: 6174 612e 6e64 696d 203d 3d20 313a 0a20  ata.ndim == 1:. 
+0000cba0: 2020 2020 2020 2064 6174 6120 3d20 6461         data = da
+0000cbb0: 7461 202d 206e 702e 6d65 616e 2864 6174  ta - np.mean(dat
+0000cbc0: 6129 0a20 2020 2065 6c69 6620 6461 7461  a).    elif data
+0000cbd0: 2e6e 6469 6d20 3d3d 2032 3a0a 2020 2020  .ndim == 2:.    
+0000cbe0: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
+0000cbf0: 6e67 6528 6461 7461 2e73 6861 7065 5b30  nge(data.shape[0
+0000cc00: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0000cc10: 6461 7461 5b69 695d 203d 2064 6174 615b  data[ii] = data[
+0000cc20: 6969 5d20 2d20 6e70 2e6d 6561 6e28 6461  ii] - np.mean(da
+0000cc30: 7461 5b69 695d 290a 2020 2020 7265 7475  ta[ii]).    retu
+0000cc40: 726e 2064 6174 610a 0a0a 6465 6620 7461  rn data...def ta
+0000cc50: 7065 7228 6461 7461 293a 0a20 2020 2022  per(data):.    "
+0000cc60: 2222 0a20 2020 2074 6869 7320 6675 6e63  "".    this func
+0000cc70: 7469 6f6e 2061 7070 6c69 6573 2061 2063  tion applies a c
+0000cc80: 6f73 696e 6520 7461 7065 7220 7573 696e  osine taper usin
+0000cc90: 6720 6f62 7370 7920 6675 6e63 7469 6f6e  g obspy function
+0000cca0: 730a 2020 2020 5041 5241 4d45 5445 5253  s.    PARAMETERS
+0000ccb0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+0000ccc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+0000ccd0: 6461 7461 3a20 696e 7075 7420 6461 7461  data: input data
+0000cce0: 206d 6174 7269 780a 2020 2020 5245 5455   matrix.    RETU
+0000ccf0: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
+0000cd00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+0000cd10: 2020 2064 6174 613a 2064 6174 6120 6d61     data: data ma
+0000cd20: 7472 6978 2077 6974 6820 7461 7065 7220  trix with taper 
+0000cd30: 6170 706c 6965 640a 2020 2020 2222 220a  applied.    """.
+0000cd40: 2020 2020 2320 6e64 6174 6120 3d20 6e70      # ndata = np
+0000cd50: 2e7a 6572 6f73 2873 6861 7065 3d64 6174  .zeros(shape=dat
+0000cd60: 612e 7368 6170 652c 6474 7970 653d 6461  a.shape,dtype=da
+0000cd70: 7461 2e64 7479 7065 290a 2020 2020 6966  ta.dtype).    if
+0000cd80: 2064 6174 612e 6e64 696d 203d 3d20 313a   data.ndim == 1:
+0000cd90: 0a20 2020 2020 2020 206e 7074 7320 3d20  .        npts = 
+0000cda0: 6461 7461 2e73 6861 7065 5b30 5d0a 2020  data.shape[0].  
+0000cdb0: 2020 2020 2020 2320 7769 6e64 6f77 206c        # window l
+0000cdc0: 656e 6774 680a 2020 2020 2020 2020 6966  ength.        if
+0000cdd0: 206e 7074 7320 2a20 302e 3035 203e 2032   npts * 0.05 > 2
+0000cde0: 303a 0a20 2020 2020 2020 2020 2020 2077  0:.            w
+0000cdf0: 6c65 6e20 3d20 3230 0a20 2020 2020 2020  len = 20.       
+0000ce00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ce10: 2020 2077 6c65 6e20 3d20 6e70 7473 202a     wlen = npts *
+0000ce20: 2030 2e30 350a 2020 2020 2020 2020 2320   0.05.        # 
+0000ce30: 7461 7065 7220 7661 6c75 6573 0a20 2020  taper values.   
+0000ce40: 2020 2020 2066 756e 6320 3d20 5f67 6574       func = _get
+0000ce50: 5f66 756e 6374 696f 6e5f 6672 6f6d 5f65  _function_from_e
+0000ce60: 6e74 7279 5f70 6f69 6e74 2822 7461 7065  ntry_point("tape
+0000ce70: 7222 2c20 2268 616e 6e22 290a 2020 2020  r", "hann").    
+0000ce80: 2020 2020 6966 2032 202a 2077 6c65 6e20      if 2 * wlen 
+0000ce90: 3d3d 206e 7074 733a 0a20 2020 2020 2020  == npts:.       
+0000cea0: 2020 2020 2074 6170 6572 5f73 6964 6573       taper_sides
+0000ceb0: 203d 2066 756e 6328 3220 2a20 776c 656e   = func(2 * wlen
+0000cec0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000ced0: 2020 2020 2020 2020 2020 2020 7461 7065              tape
+0000cee0: 725f 7369 6465 7320 3d20 6675 6e63 2832  r_sides = func(2
+0000cef0: 202a 2077 6c65 6e20 2b20 3129 0a20 2020   * wlen + 1).   
+0000cf00: 2020 2020 2023 2074 6170 6572 2077 696e       # taper win
+0000cf10: 646f 770a 2020 2020 2020 2020 7769 6e20  dow.        win 
+0000cf20: 3d20 6e70 2e68 7374 6163 6b28 0a20 2020  = np.hstack(.   
+0000cf30: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
+0000cf40: 2020 2020 2020 2020 2020 2074 6170 6572             taper
+0000cf50: 5f73 6964 6573 5b3a 776c 656e 5d2c 0a20  _sides[:wlen],. 
+0000cf60: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0000cf70: 702e 6f6e 6573 286e 7074 7320 2d20 3220  p.ones(npts - 2 
+0000cf80: 2a20 776c 656e 292c 0a20 2020 2020 2020  * wlen),.       
+0000cf90: 2020 2020 2020 2020 2074 6170 6572 5f73           taper_s
+0000cfa0: 6964 6573 5b6c 656e 2874 6170 6572 5f73  ides[len(taper_s
+0000cfb0: 6964 6573 2920 2d20 776c 656e 203a 5d2c  ides) - wlen :],
+0000cfc0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000cfd0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000cfe0: 2064 6174 6120 2a3d 2077 696e 0a20 2020   data *= win.   
+0000cff0: 2065 6c69 6620 6461 7461 2e6e 6469 6d20   elif data.ndim 
+0000d000: 3d3d 2032 3a0a 2020 2020 2020 2020 6e70  == 2:.        np
+0000d010: 7473 203d 2064 6174 612e 7368 6170 655b  ts = data.shape[
+0000d020: 315d 0a20 2020 2020 2020 2023 2077 696e  1].        # win
+0000d030: 646f 7720 6c65 6e67 7468 0a20 2020 2020  dow length.     
+0000d040: 2020 2069 6620 6e70 7473 202a 2030 2e30     if npts * 0.0
+0000d050: 3520 3e20 3230 3a0a 2020 2020 2020 2020  5 > 20:.        
+0000d060: 2020 2020 776c 656e 203d 2032 300a 2020      wlen = 20.  
+0000d070: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000d080: 2020 2020 2020 2020 776c 656e 203d 206e          wlen = n
+0000d090: 7074 7320 2a20 302e 3035 0a20 2020 2020  pts * 0.05.     
+0000d0a0: 2020 2023 2074 6170 6572 2076 616c 7565     # taper value
+0000d0b0: 730a 2020 2020 2020 2020 6675 6e63 203d  s.        func =
+0000d0c0: 205f 6765 745f 6675 6e63 7469 6f6e 5f66   _get_function_f
+0000d0d0: 726f 6d5f 656e 7472 795f 706f 696e 7428  rom_entry_point(
+0000d0e0: 2274 6170 6572 222c 2022 6861 6e6e 2229  "taper", "hann")
+0000d0f0: 0a20 2020 2020 2020 2069 6620 3220 2a20  .        if 2 * 
+0000d100: 776c 656e 203d 3d20 6e70 7473 3a0a 2020  wlen == npts:.  
+0000d110: 2020 2020 2020 2020 2020 7461 7065 725f            taper_
+0000d120: 7369 6465 7320 3d20 6675 6e63 2832 202a  sides = func(2 *
+0000d130: 2077 6c65 6e29 0a20 2020 2020 2020 2065   wlen).        e
+0000d140: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000d150: 2074 6170 6572 5f73 6964 6573 203d 2066   taper_sides = f
+0000d160: 756e 6328 3220 2a20 776c 656e 202b 2031  unc(2 * wlen + 1
+0000d170: 290a 2020 2020 2020 2020 2320 7461 7065  ).        # tape
+0000d180: 7220 7769 6e64 6f77 0a20 2020 2020 2020  r window.       
+0000d190: 2077 696e 203d 206e 702e 6873 7461 636b   win = np.hstack
+0000d1a0: 280a 2020 2020 2020 2020 2020 2020 280a  (.            (.
+0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1c0: 7461 7065 725f 7369 6465 735b 3a77 6c65  taper_sides[:wle
+0000d1d0: 6e5d 2c0a 2020 2020 2020 2020 2020 2020  n],.            
+0000d1e0: 2020 2020 6e70 2e6f 6e65 7328 6e70 7473      np.ones(npts
+0000d1f0: 202d 2032 202a 2077 6c65 6e29 2c0a 2020   - 2 * wlen),.  
+0000d200: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0000d210: 7065 725f 7369 6465 735b 6c65 6e28 7461  per_sides[len(ta
+0000d220: 7065 725f 7369 6465 7329 202d 2077 6c65  per_sides) - wle
+0000d230: 6e20 3a5d 2c0a 2020 2020 2020 2020 2020  n :],.          
+0000d240: 2020 290a 2020 2020 2020 2020 290a 2020    ).        ).  
+0000d250: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
+0000d260: 7261 6e67 6528 6461 7461 2e73 6861 7065  range(data.shape
+0000d270: 5b30 5d29 3a0a 2020 2020 2020 2020 2020  [0]):.          
+0000d280: 2020 6461 7461 5b69 695d 202a 3d20 7769    data[ii] *= wi
+0000d290: 6e0a 2020 2020 7265 7475 726e 2064 6174  n.    return dat
+0000d2a0: 610a 0a0a 2320 406a 6974 286e 6f70 7974  a...# @jit(nopyt
+0000d2b0: 686f 6e20 3d20 5472 7565 290a 0a0a 2320  hon = True)...# 
+0000d2c0: 6368 616e 6765 2074 6865 206d 6f76 696e  change the movin
+0000d2d0: 6720 6176 6572 6167 6520 6361 6c63 756c  g average calcul
+0000d2e0: 6174 696f 6e20 746f 2074 616b 6520 6173  ation to take as
+0000d2f0: 2069 6e70 7574 204e 2074 6865 2066 756c   input N the ful
+0000d300: 6c20 7769 6e64 6f77 206c 656e 6774 6820  l window length 
+0000d310: 746f 2073 6d6f 6f74 680a 6465 6620 6d6f  to smooth.def mo
+0000d320: 7669 6e67 5f61 7665 2841 2c20 4e29 3a0a  ving_ave(A, N):.
+0000d330: 2020 2020 2222 220a 2020 2020 416c 7465      """.    Alte
+0000d340: 726e 6174 6976 6520 6675 6e63 7469 6f6e  rnative function
+0000d350: 2066 6f72 206d 6f76 696e 6720 6176 6572   for moving aver
+0000d360: 6167 6520 666f 7220 616e 2061 7272 6179  age for an array
+0000d370: 2e0a 2020 2020 5041 5241 4d45 5445 5253  ..    PARAMETERS
+0000d380: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+0000d390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+0000d3a0: 413a 2031 2d44 2061 7272 6179 206f 6620  A: 1-D array of 
+0000d3b0: 6461 7461 2074 6f20 6265 2073 6d6f 6f74  data to be smoot
+0000d3c0: 6865 640a 2020 2020 4e3a 2069 6e74 6567  hed.    N: integ
+0000d3d0: 6572 2c20 6974 2064 6566 696e 6573 2074  er, it defines t
+0000d3e0: 6865 2066 756c 6c21 2120 7769 6e64 6f77  he full!! window
+0000d3f0: 206c 656e 6774 6820 746f 2073 6d6f 6f74   length to smoot
+0000d400: 680a 2020 2020 5245 5455 524e 533a 0a20  h.    RETURNS:. 
+0000d410: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0000d420: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2042 3a20  --------.    B: 
+0000d430: 312d 4420 6172 7261 7920 7769 7468 2073  1-D array with s
+0000d440: 6d6f 6f74 6865 6420 6461 7461 0a20 2020  moothed data.   
+0000d450: 2022 2222 0a20 2020 2023 2064 6566 696e   """.    # defin
+0000d460: 6573 2061 6e20 6172 7261 7920 7769 7468  es an array with
+0000d470: 204e 2065 7874 7261 2073 616d 706c 6573   N extra samples
+0000d480: 2061 7420 6569 7468 6572 2073 6964 650a   at either side.
+0000d490: 2020 2020 7465 6d70 203d 206e 702e 7a65      temp = np.ze
+0000d4a0: 726f 7328 6c65 6e28 4129 202b 2032 202a  ros(len(A) + 2 *
+0000d4b0: 204e 290a 2020 2020 2320 7365 7420 7468   N).    # set th
+0000d4c0: 6520 6365 6e74 7261 6c20 706f 7274 696f  e central portio
+0000d4d0: 6e20 6f66 2074 6865 2061 7272 6179 2074  n of the array t
+0000d4e0: 6f20 410a 2020 2020 7465 6d70 5b4e 3a2d  o A.    temp[N:-
+0000d4f0: 4e5d 203d 2041 0a20 2020 2023 206c 6561  N] = A.    # lea
+0000d500: 6469 6e67 2073 616d 706c 6573 3a20 6571  ding samples: eq
+0000d510: 7561 6c20 746f 2066 6972 7374 2073 616d  ual to first sam
+0000d520: 706c 6520 6f66 2061 6374 7561 6c20 6172  ple of actual ar
+0000d530: 7261 790a 2020 2020 7465 6d70 5b30 3a4e  ray.    temp[0:N
+0000d540: 5d20 3d20 7465 6d70 5b4e 5d0a 2020 2020  ] = temp[N].    
+0000d550: 2320 7472 6169 6c69 6e67 2073 616d 706c  # trailing sampl
+0000d560: 6573 3a20 4571 7561 6c20 746f 206c 6173  es: Equal to las
+0000d570: 7420 7361 6d70 6c65 206f 6620 6163 7475  t sample of actu
+0000d580: 616c 2061 7272 6179 0a20 2020 2074 656d  al array.    tem
+0000d590: 705b 2d4e 3a5d 203d 2074 656d 705b 2d4e  p[-N:] = temp[-N
+0000d5a0: 202d 2031 5d0a 2020 2020 2320 636f 6e76   - 1].    # conv
+0000d5b0: 6f6c 7665 2077 6974 6820 6120 626f 7863  olve with a boxc
+0000d5c0: 6172 2061 6e64 206e 6f72 6d61 6c69 7a65  ar and normalize
+0000d5d0: 2c20 616e 6420 7573 6520 6f6e 6c79 2063  , and use only c
+0000d5e0: 656e 7472 616c 2070 6f72 7469 6f6e 206f  entral portion o
+0000d5f0: 6620 7468 6520 7265 7375 6c74 0a20 2020  f the result.   
+0000d600: 2023 2077 6974 6820 6c65 6e67 7468 2065   # with length e
+0000d610: 7175 616c 2074 6f20 7468 6520 6f72 6967  qual to the orig
+0000d620: 696e 616c 2061 7272 6179 2c20 6469 7363  inal array, disc
+0000d630: 6172 6469 6e67 2074 6865 2061 6464 6564  arding the added
+0000d640: 206c 6561 6469 6e67 2061 6e64 2074 7261   leading and tra
+0000d650: 696c 696e 6720 7361 6d70 6c65 730a 2020  iling samples.  
+0000d660: 2020 4220 3d20 6e70 2e63 6f6e 766f 6c76    B = np.convolv
+0000d670: 6528 7465 6d70 2c20 6e70 2e6f 6e65 7328  e(temp, np.ones(
+0000d680: 4e29 202f 204e 2c20 6d6f 6465 3d22 7361  N) / N, mode="sa
+0000d690: 6d65 2229 5b4e 3a2d 4e5d 0a20 2020 2072  me")[N:-N].    r
+0000d6a0: 6574 7572 6e20 420a 0a0a 2320 6368 616e  eturn B...# chan
+0000d6b0: 6765 2074 6865 206d 6f76 696e 6720 6176  ge the moving av
+0000d6c0: 6572 6167 6520 6361 6c63 756c 6174 696f  erage calculatio
+0000d6d0: 6e20 746f 2074 616b 6520 6173 2069 6e70  n to take as inp
+0000d6e0: 7574 204e 2074 6865 2066 756c 6c20 7769  ut N the full wi
+0000d6f0: 6e64 6f77 206c 656e 6774 6820 746f 2073  ndow length to s
+0000d700: 6d6f 6f74 680a 6465 6620 6d6f 7669 6e67  mooth.def moving
+0000d710: 5f61 7665 5f32 4428 412c 204e 293a 0a20  _ave_2D(A, N):. 
+0000d720: 2020 2022 2222 0a20 2020 2041 6c74 6572     """.    Alter
+0000d730: 6e61 7469 7665 2066 756e 6374 696f 6e20  native function 
+0000d740: 666f 7220 6d6f 7669 6e67 2061 7665 7261  for moving avera
+0000d750: 6765 2066 6f72 2061 6e20 6172 7261 792e  ge for an array.
+0000d760: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
+0000d770: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+0000d780: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2041  ----------.    A
+0000d790: 3a20 322d 4420 6172 7261 7920 6f66 2064  : 2-D array of d
+0000d7a0: 6174 6120 746f 2062 6520 736d 6f6f 7468  ata to be smooth
+0000d7b0: 6564 0a20 2020 204e 3a20 696e 7465 6765  ed.    N: intege
+0000d7c0: 722c 2069 7420 6465 6669 6e65 7320 7468  r, it defines th
+0000d7d0: 6520 6675 6c6c 2121 2077 696e 646f 7720  e full!! window 
+0000d7e0: 6c65 6e67 7468 2074 6f20 736d 6f6f 7468  length to smooth
+0000d7f0: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
+0000d800: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+0000d810: 2d2d 2d2d 2d2d 2d0a 2020 2020 423a 2032  -------.    B: 2
+0000d820: 2d44 2061 7272 6179 2077 6974 6820 736d  -D array with sm
+0000d830: 6f6f 7468 6564 2064 6174 610a 2020 2020  oothed data.    
+0000d840: 2222 220a 2020 2020 6e74 632c 206e 7370  """.    ntc, nsp
+0000d850: 7420 3d20 412e 7368 6170 650a 2020 2020  t = A.shape.    
+0000d860: 2320 6465 6669 6e65 7320 616e 2061 7272  # defines an arr
+0000d870: 6179 2077 6974 6820 4e20 6578 7472 6120  ay with N extra 
+0000d880: 7361 6d70 6c65 7320 6174 2065 6974 6865  samples at eithe
+0000d890: 7220 7369 6465 0a20 2020 2074 656d 7020  r side.    temp 
+0000d8a0: 3d20 6e70 2e7a 6572 6f73 285b 6e74 632c  = np.zeros([ntc,
+0000d8b0: 206e 7370 7420 2b20 3220 2a20 4e5d 290a   nspt + 2 * N]).
+0000d8c0: 2020 2020 2320 7365 7420 7468 6520 6365      # set the ce
+0000d8d0: 6e74 7261 6c20 706f 7274 696f 6e20 6f66  ntral portion of
+0000d8e0: 2074 6865 2061 7272 6179 2074 6f20 410a   the array to A.
+0000d8f0: 2020 2020 7465 6d70 5b3a 2c20 4e3a 2d4e      temp[:, N:-N
+0000d900: 5d20 3d20 410a 2020 2020 2320 6c65 6164  ] = A.    # lead
+0000d910: 696e 6720 7361 6d70 6c65 733a 2065 7175  ing samples: equ
+0000d920: 616c 2074 6f20 6669 7273 7420 7361 6d70  al to first samp
+0000d930: 6c65 206f 6620 6163 7475 616c 2061 7272  le of actual arr
+0000d940: 6179 0a20 2020 2074 656d 705b 3a2c 2030  ay.    temp[:, 0
+0000d950: 3a4e 5d20 3d20 6e70 2e72 6570 6561 7428  :N] = np.repeat(
+0000d960: 6e70 2e65 7870 616e 645f 6469 6d73 2874  np.expand_dims(t
+0000d970: 656d 705b 3a2c 204e 5d2c 2061 7869 733d  emp[:, N], axis=
+0000d980: 2d31 292c 204e 2c20 6178 6973 3d2d 3129  -1), N, axis=-1)
+0000d990: 0a20 2020 2023 2074 7261 696c 696e 6720  .    # trailing 
+0000d9a0: 7361 6d70 6c65 733a 2045 7175 616c 2074  samples: Equal t
+0000d9b0: 6f20 6c61 7374 2073 616d 706c 6520 6f66  o last sample of
+0000d9c0: 2061 6374 7561 6c20 6172 7261 790a 2020   actual array.  
+0000d9d0: 2020 7465 6d70 5b3a 2c20 2d4e 3a5d 203d    temp[:, -N:] =
+0000d9e0: 206e 702e 7265 7065 6174 286e 702e 6578   np.repeat(np.ex
+0000d9f0: 7061 6e64 5f64 696d 7328 7465 6d70 5b3a  pand_dims(temp[:
+0000da00: 2c20 2d4e 202d 2031 5d2c 2061 7869 733d  , -N - 1], axis=
+0000da10: 2d31 292c 204e 2c20 6178 6973 3d2d 3129  -1), N, axis=-1)
+0000da20: 0a20 2020 2023 2063 6f6e 766f 6c76 6520  .    # convolve 
+0000da30: 7769 7468 2061 2062 6f78 6361 7220 616e  with a boxcar an
+0000da40: 6420 6e6f 726d 616c 697a 652c 2061 6e64  d normalize, and
+0000da50: 2075 7365 206f 6e6c 7920 6365 6e74 7261   use only centra
+0000da60: 6c20 706f 7274 696f 6e20 6f66 2074 6865  l portion of the
+0000da70: 2072 6573 756c 740a 2020 2020 2320 7769   result.    # wi
+0000da80: 7468 206c 656e 6774 6820 6571 7561 6c20  th length equal 
+0000da90: 746f 2074 6865 206f 7269 6769 6e61 6c20  to the original 
+0000daa0: 6172 7261 792c 2064 6973 6361 7264 696e  array, discardin
+0000dab0: 6720 7468 6520 6164 6465 6420 6c65 6164  g the added lead
+0000dac0: 696e 6720 616e 6420 7472 6169 6c69 6e67  ing and trailing
+0000dad0: 2073 616d 706c 6573 0a20 2020 2042 203d   samples.    B =
+0000dae0: 2073 6369 7079 2e73 6967 6e61 6c2e 636f   scipy.signal.co
+0000daf0: 6e76 6f6c 7665 3264 2874 656d 702c 206e  nvolve2d(temp, n
+0000db00: 702e 6578 7061 6e64 5f64 696d 7328 6e70  p.expand_dims(np
+0000db10: 2e6f 6e65 7328 4e29 202f 204e 2c20 6178  .ones(N) / N, ax
+0000db20: 6973 3d30 292c 206d 6f64 653d 2273 616d  is=0), mode="sam
+0000db30: 6522 295b 3a2c 204e 3a2d 4e5d 0a20 2020  e")[:, N:-N].   
+0000db40: 2072 6574 7572 6e20 420a 0a0a 6465 6620   return B...def 
+0000db50: 726f 6275 7374 5f73 7461 636b 2863 635f  robust_stack(cc_
+0000db60: 6172 7261 792c 2065 7073 696c 6f6e 293a  array, epsilon):
+0000db70: 0a20 2020 2022 2222 0a20 2020 2074 6869  .    """.    thi
+0000db80: 7320 6973 2061 2072 6f62 7573 7420 7374  s is a robust st
+0000db90: 6163 6b69 6e67 2061 6c67 6f72 6974 686d  acking algorithm
+0000dba0: 2064 6573 6372 6962 6564 2069 6e20 5061   described in Pa
+0000dbb0: 6c76 6973 2061 6e64 2056 6572 6e6f 6e20  lvis and Vernon 
+0000dbc0: 3230 3130 0a0a 2020 2020 5041 5241 4d45  2010..    PARAME
+0000dbd0: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+0000dbe0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000dbf0: 0a20 2020 2063 635f 6172 7261 793a 206e  .    cc_array: n
+0000dc00: 756d 7079 2e6e 6461 7272 6179 2063 6f6e  umpy.ndarray con
+0000dc10: 7461 696e 7320 7468 6520 3244 2063 726f  tains the 2D cro
+0000dc20: 7373 2063 6f72 7265 6c61 7469 6f6e 206d  ss correlation m
+0000dc30: 6174 7269 780a 2020 2020 6570 7369 6c6f  atrix.    epsilo
+0000dc40: 6e3a 2072 6573 6964 7561 6c20 7468 7265  n: residual thre
+0000dc50: 686f 6c64 2074 6f20 7175 6974 2074 6865  hold to quit the
+0000dc60: 2069 7465 7261 7469 6f6e 0a20 2020 2052   iteration.    R
+0000dc70: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
+0000dc80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000dc90: 2d2d 0a20 2020 206e 6577 7374 6163 6b3a  --.    newstack:
+0000dca0: 206e 756d 7079 2076 6563 746f 7220 636f   numpy vector co
+0000dcb0: 6e74 6169 6e73 2074 6865 2073 7461 636b  ntains the stack
+0000dcc0: 6564 2063 726f 7373 2063 6f72 7265 6c61  ed cross correla
+0000dcd0: 7469 6f6e 0a0a 2020 2020 5772 6974 7465  tion..    Writte
+0000dce0: 6e20 6279 204d 6172 696e 6520 4465 6e6f  n by Marine Deno
+0000dcf0: 6c6c 650a 2020 2020 2222 220a 2020 2020  lle.    """.    
+0000dd00: 7265 7320 3d20 3965 3920 2023 2072 6573  res = 9e9  # res
+0000dd10: 6964 7561 6c73 0a20 2020 2077 203d 206e  iduals.    w = n
+0000dd20: 702e 6f6e 6573 2863 635f 6172 7261 792e  p.ones(cc_array.
+0000dd30: 7368 6170 655b 305d 290a 2020 2020 6e73  shape[0]).    ns
+0000dd40: 7465 7020 3d20 300a 2020 2020 6e65 7773  tep = 0.    news
+0000dd50: 7461 636b 203d 206e 702e 6d65 6469 616e  tack = np.median
+0000dd60: 2863 635f 6172 7261 792c 2061 7869 733d  (cc_array, axis=
+0000dd70: 3029 0a20 2020 2077 6869 6c65 2072 6573  0).    while res
+0000dd80: 203e 2065 7073 696c 6f6e 3a0a 2020 2020   > epsilon:.    
+0000dd90: 2020 2020 7374 6163 6b20 3d20 6e65 7773      stack = news
+0000dda0: 7461 636b 0a20 2020 2020 2020 2066 6f72  tack.        for
+0000ddb0: 2069 2069 6e20 7261 6e67 6528 6363 5f61   i in range(cc_a
+0000ddc0: 7272 6179 2e73 6861 7065 5b30 5d29 3a0a  rray.shape[0]):.
+0000ddd0: 2020 2020 2020 2020 2020 2020 6372 6170              crap
+0000dde0: 203d 206e 702e 6d75 6c74 6970 6c79 2873   = np.multiply(s
+0000ddf0: 7461 636b 2c20 6363 5f61 7272 6179 5b69  tack, cc_array[i
+0000de00: 2c20 3a5d 2e54 290a 2020 2020 2020 2020  , :].T).        
+0000de10: 2020 2020 6372 6170 5f64 6f74 203d 206e      crap_dot = n
+0000de20: 702e 7375 6d28 6372 6170 290a 2020 2020  p.sum(crap).    
+0000de30: 2020 2020 2020 2020 6469 5f6e 6f72 6d20          di_norm 
+0000de40: 3d20 6e70 2e6c 696e 616c 672e 6e6f 726d  = np.linalg.norm
+0000de50: 2863 635f 6172 7261 795b 692c 203a 5d29  (cc_array[i, :])
+0000de60: 0a20 2020 2020 2020 2020 2020 2072 6920  .            ri 
+0000de70: 3d20 6363 5f61 7272 6179 5b69 2c20 3a5d  = cc_array[i, :]
+0000de80: 202d 2063 7261 705f 646f 7420 2a20 7374   - crap_dot * st
+0000de90: 6163 6b0a 2020 2020 2020 2020 2020 2020  ack.            
+0000dea0: 7269 5f6e 6f72 6d20 3d20 6e70 2e6c 696e  ri_norm = np.lin
+0000deb0: 616c 672e 6e6f 726d 2872 6929 0a20 2020  alg.norm(ri).   
+0000dec0: 2020 2020 2020 2020 2077 5b69 5d20 3d20           w[i] = 
+0000ded0: 6e70 2e61 6273 2863 7261 705f 646f 7429  np.abs(crap_dot)
+0000dee0: 202f 2064 695f 6e6f 726d 202f 2072 695f   / di_norm / ri_
+0000def0: 6e6f 726d 2020 2320 2f6c 656e 2863 635f  norm  # /len(cc_
+0000df00: 6172 7261 795b 3a2c 315d 290a 2020 2020  array[:,1]).    
+0000df10: 2020 2020 2320 7072 696e 7428 7729 0a20      # print(w). 
+0000df20: 2020 2020 2020 2077 203d 2077 202f 206e         w = w / n
+0000df30: 702e 7375 6d28 7729 0a20 2020 2020 2020  p.sum(w).       
+0000df40: 206e 6577 7374 6163 6b20 3d20 6e70 2e73   newstack = np.s
+0000df50: 756d 2828 7720 2a20 6363 5f61 7272 6179  um((w * cc_array
+0000df60: 2e54 292e 542c 2061 7869 733d 3029 2020  .T).T, axis=0)  
+0000df70: 2320 2f6c 656e 2863 635f 6172 7261 795b  # /len(cc_array[
+0000df80: 3a2c 315d 290a 2020 2020 2020 2020 7265  :,1]).        re
+0000df90: 7320 3d20 6e70 2e6c 696e 616c 672e 6e6f  s = np.linalg.no
+0000dfa0: 726d 286e 6577 7374 6163 6b20 2d20 7374  rm(newstack - st
+0000dfb0: 6163 6b2c 206f 7264 3d31 2920 2f20 6e70  ack, ord=1) / np
+0000dfc0: 2e6c 696e 616c 672e 6e6f 726d 286e 6577  .linalg.norm(new
+0000dfd0: 7374 6163 6b29 202f 206c 656e 2863 635f  stack) / len(cc_
+0000dfe0: 6172 7261 795b 3a2c 2031 5d29 0a20 2020  array[:, 1]).   
+0000dff0: 2020 2020 206e 7374 6570 202b 3d20 310a       nstep += 1.
+0000e000: 2020 2020 2020 2020 6966 206e 7374 6570          if nstep
+0000e010: 203e 2031 303a 0a20 2020 2020 2020 2020   > 10:.         
+0000e020: 2020 2072 6574 7572 6e20 6e65 7773 7461     return newsta
+0000e030: 636b 2c20 772c 206e 7374 6570 0a20 2020  ck, w, nstep.   
+0000e040: 2072 6574 7572 6e20 6e65 7773 7461 636b   return newstack
+0000e050: 2c20 772c 206e 7374 6570 0a0a 0a64 6566  , w, nstep...def
+0000e060: 2073 656c 6563 7469 7665 5f73 7461 636b   selective_stack
+0000e070: 2863 635f 6172 7261 792c 2065 7073 696c  (cc_array, epsil
+0000e080: 6f6e 293a 0a20 2020 2022 2222 0a20 2020  on):.    """.   
+0000e090: 2074 6869 7320 6973 2061 2073 656c 6563   this is a selec
+0000e0a0: 7469 7665 2073 7461 636b 696e 6720 616c  tive stacking al
+0000e0b0: 676f 7269 7468 6d20 6465 7665 6c6f 7065  gorithm develope
+0000e0c0: 6420 6279 204a 6172 6564 2042 7279 616e  d by Jared Bryan
+0000e0d0: 2e0a 0a20 2020 2050 4152 414d 4554 4552  ...    PARAMETER
+0000e0e0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+0000e0f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0000e100: 2020 6363 5f61 7272 6179 3a20 6e75 6d70    cc_array: nump
+0000e110: 792e 6e64 6172 7261 7920 636f 6e74 6169  y.ndarray contai
+0000e120: 6e73 2074 6865 2032 4420 6372 6f73 7320  ns the 2D cross 
+0000e130: 636f 7272 656c 6174 696f 6e20 6d61 7472  correlation matr
+0000e140: 6978 0a20 2020 2065 7073 696c 6f6e 3a20  ix.    epsilon: 
+0000e150: 7265 7369 6475 616c 2074 6872 6568 6f6c  residual threhol
+0000e160: 6420 746f 2071 7569 7420 7468 6520 6974  d to quit the it
+0000e170: 6572 6174 696f 6e0a 2020 2020 5245 5455  eration.    RETU
+0000e180: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
+0000e190: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+0000e1a0: 2020 2020 6e65 7773 7461 636b 3a20 6e75      newstack: nu
+0000e1b0: 6d70 7920 7665 6374 6f72 2063 6f6e 7461  mpy vector conta
+0000e1c0: 696e 7320 7468 6520 7374 6163 6b65 6420  ins the stacked 
+0000e1d0: 6372 6f73 7320 636f 7272 656c 6174 696f  cross correlatio
+0000e1e0: 6e0a 0a20 2020 2057 7269 7474 656e 2062  n..    Written b
+0000e1f0: 7920 4d61 7269 6e65 2044 656e 6f6c 6c65  y Marine Denolle
+0000e200: 0a20 2020 2022 2222 0a20 2020 2063 6320  .    """.    cc 
+0000e210: 3d20 6e70 2e6f 6e65 7328 6363 5f61 7272  = np.ones(cc_arr
+0000e220: 6179 2e73 6861 7065 5b30 5d29 0a20 2020  ay.shape[0]).   
+0000e230: 206e 6577 7374 6163 6b20 3d20 6e70 2e6d   newstack = np.m
+0000e240: 6561 6e28 6363 5f61 7272 6179 2c20 6178  ean(cc_array, ax
+0000e250: 6973 3d30 290a 2020 2020 666f 7220 6920  is=0).    for i 
+0000e260: 696e 2072 616e 6765 2863 635f 6172 7261  in range(cc_arra
+0000e270: 792e 7368 6170 655b 305d 293a 0a20 2020  y.shape[0]):.   
+0000e280: 2020 2020 2063 635b 695d 203d 206e 702e       cc[i] = np.
+0000e290: 7375 6d28 6e70 2e6d 756c 7469 706c 7928  sum(np.multiply(
+0000e2a0: 6e65 7773 7461 636b 2c20 6363 5f61 7272  newstack, cc_arr
+0000e2b0: 6179 5b69 2c20 3a5d 2e54 2929 0a20 2020  ay[i, :].T)).   
+0000e2c0: 2069 6b20 3d20 6e70 2e77 6865 7265 2863   ik = np.where(c
+0000e2d0: 6320 3e3d 2065 7073 696c 6f6e 295b 305d  c >= epsilon)[0]
+0000e2e0: 0a20 2020 206e 6577 7374 6163 6b20 3d20  .    newstack = 
+0000e2f0: 6e70 2e6d 6561 6e28 6363 5f61 7272 6179  np.mean(cc_array
+0000e300: 5b69 6b2c 203a 5d2c 2061 7869 733d 3029  [ik, :], axis=0)
+0000e310: 0a0a 2020 2020 7265 7475 726e 206e 6577  ..    return new
+0000e320: 7374 6163 6b2c 2063 630a 0a0a 6465 6620  stack, cc...def 
+0000e330: 7768 6974 656e 5f31 4428 7469 6d65 7365  whiten_1D(timese
+0000e340: 7269 6573 2c20 6666 745f 7061 7261 2c20  ries, fft_para, 
+0000e350: 6e5f 7461 7065 7229 3a0a 2020 2020 2222  n_taper):.    ""
+0000e360: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
+0000e370: 696f 6e20 7461 6b65 7320 6120 312d 6469  ion takes a 1-di
+0000e380: 6d65 6e73 696f 6e61 6c20 7469 6d65 7365  mensional timese
+0000e390: 7269 6573 2061 7272 6179 2c20 7472 616e  ries array, tran
+0000e3a0: 7366 6f72 6d73 2074 6f20 6672 6571 7565  sforms to freque
+0000e3b0: 6e63 7920 646f 6d61 696e 2075 7369 6e67  ncy domain using
+0000e3c0: 2066 6674 2c0a 2020 2020 7768 6974 656e   fft,.    whiten
+0000e3d0: 7320 7468 6520 616d 706c 6974 7564 6520  s the amplitude 
+0000e3e0: 6f66 2074 6865 2073 7065 6374 7275 6d20  of the spectrum 
+0000e3f0: 696e 2066 7265 7175 656e 6379 2064 6f6d  in frequency dom
+0000e400: 6169 6e20 6265 7477 6565 6e20 2a66 7265  ain between *fre
+0000e410: 716d 696e 2a20 616e 6420 2a66 7265 716d  qmin* and *freqm
+0000e420: 6178 2a0a 2020 2020 616e 6420 7265 7475  ax*.    and retu
+0000e430: 726e 7320 7468 6520 7768 6974 656e 6564  rns the whitened
+0000e440: 2066 6674 2e0a 2020 2020 5041 5241 4d45   fft..    PARAME
+0000e450: 5445 5253 3a0a 2020 2020 2d2d 2d2d 2d2d  TERS:.    ------
+0000e460: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000e470: 0a20 2020 2064 6174 613a 206e 756d 7079  .    data: numpy
+0000e480: 2e6e 6461 7272 6179 2063 6f6e 7461 696e  .ndarray contain
+0000e490: 7320 7468 6520 3144 2074 696d 6520 7365  s the 1D time se
+0000e4a0: 7269 6573 2074 6f20 7768 6974 656e 0a20  ries to whiten. 
+0000e4b0: 2020 2066 6674 5f70 6172 613a 2064 6963     fft_para: dic
+0000e4c0: 7420 636f 6e74 6169 6e69 6e67 2061 6c6c  t containing all
+0000e4d0: 2066 6674 5f63 6320 7061 7261 6d65 7465   fft_cc paramete
+0000e4e0: 7273 2073 7563 6820 6173 0a20 2020 2020  rs such as.     
+0000e4f0: 2020 2064 743a 2054 6865 2073 616d 706c     dt: The sampl
+0000e500: 696e 6720 7370 6163 6520 6f66 2074 6865  ing space of the
+0000e510: 2060 6461 7461 600a 2020 2020 2020 2020   `data`.        
+0000e520: 6672 6571 6d69 6e3a 2054 6865 206c 6f77  freqmin: The low
+0000e530: 6572 2066 7265 7175 656e 6379 2062 6f75  er frequency bou
+0000e540: 6e64 0a20 2020 2020 2020 2066 7265 716d  nd.        freqm
+0000e550: 6178 3a20 5468 6520 7570 7065 7220 6672  ax: The upper fr
+0000e560: 6571 7565 6e63 7920 626f 756e 640a 2020  equency bound.  
+0000e570: 2020 2020 2020 736d 6f6f 7468 5f4e 3a20        smooth_N: 
+0000e580: 696e 7465 6765 722c 2069 7420 6465 6669  integer, it defi
+0000e590: 6e65 7320 7468 6520 6861 6c66 2077 696e  nes the half win
+0000e5a0: 646f 7720 6c65 6e67 7468 2074 6f20 736d  dow length to sm
+0000e5b0: 6f6f 7468 0a20 2020 2020 2020 206e 5f74  ooth.        n_t
+0000e5c0: 6170 6572 2c20 6f70 7469 6f6e 616c 3a20  aper, optional: 
+0000e5d0: 696e 7465 6765 722c 2064 6566 696e 6520  integer, define 
+0000e5e0: 7468 6520 7769 6474 6820 6f66 2074 6865  the width of the
+0000e5f0: 2074 6170 6572 2069 6e20 7361 6d70 6c65   taper in sample
+0000e600: 730a 2020 2020 5245 5455 524e 533a 0a20  s.    RETURNS:. 
+0000e610: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0000e620: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 4646  ---------.    FF
+0000e630: 5452 6177 5369 676e 3a20 6e75 6d70 792e  TRawSign: numpy.
+0000e640: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
+0000e650: 2074 6865 2046 4654 206f 6620 7468 6520   the FFT of the 
+0000e660: 7768 6974 656e 6564 2069 6e70 7574 2074  whitened input t
+0000e670: 7261 6365 2062 6574 7765 656e 2074 6865  race between the
+0000e680: 2066 7265 7175 656e 6379 2062 6f75 6e64   frequency bound
+0000e690: 730a 2020 2020 2222 220a 2020 2020 2320  s.    """.    # 
+0000e6a0: 6c6f 6164 2070 6172 616d 6574 6572 730a  load parameters.
+0000e6b0: 2020 2020 6465 6c74 6120 3d20 6666 745f      delta = fft_
+0000e6c0: 7061 7261 5b22 6474 225d 0a20 2020 2066  para["dt"].    f
+0000e6d0: 7265 716d 696e 203d 2066 6674 5f70 6172  reqmin = fft_par
+0000e6e0: 615b 2266 7265 716d 696e 225d 0a20 2020  a["freqmin"].   
+0000e6f0: 2066 7265 716d 6178 203d 2066 6674 5f70   freqmax = fft_p
+0000e700: 6172 615b 2266 7265 716d 6178 225d 0a20  ara["freqmax"]. 
+0000e710: 2020 2073 6d6f 6f74 685f 4e20 3d20 6666     smooth_N = ff
+0000e720: 745f 7061 7261 5b22 736d 6f6f 7468 5f4e  t_para["smooth_N
+0000e730: 225d 0a0a 2020 2020 6e66 6674 203d 206e  "]..    nfft = n
+0000e740: 6578 745f 6661 7374 5f6c 656e 286c 656e  ext_fast_len(len
+0000e750: 2874 696d 6573 6572 6965 7329 290a 2020  (timeseries)).  
+0000e760: 2020 7370 6563 203d 206e 702e 6666 742e    spec = np.fft.
+0000e770: 6666 7428 7469 6d65 7365 7269 6573 2c20  fft(timeseries, 
+0000e780: 6e66 6674 290a 2020 2020 6672 6571 203d  nfft).    freq =
+0000e790: 206e 702e 6666 742e 6666 7466 7265 7128   np.fft.fftfreq(
+0000e7a0: 6e66 6674 2c20 643d 6465 6c74 6129 0a0a  nfft, d=delta)..
+0000e7b0: 2020 2020 6978 3020 3d20 6e70 2e61 7267      ix0 = np.arg
+0000e7c0: 6d69 6e28 6e70 2e61 6273 2866 7265 7120  min(np.abs(freq 
+0000e7d0: 2d20 6672 6571 6d69 6e29 290a 2020 2020  - freqmin)).    
+0000e7e0: 6978 3120 3d20 6e70 2e61 7267 6d69 6e28  ix1 = np.argmin(
+0000e7f0: 6e70 2e61 6273 2866 7265 7120 2d20 6672  np.abs(freq - fr
+0000e800: 6571 6d61 7829 290a 0a20 2020 2069 6620  eqmax))..    if 
+0000e810: 6978 3120 2b20 6e5f 7461 7065 7220 3e20  ix1 + n_taper > 
+0000e820: 6e66 6674 3a0a 2020 2020 2020 2020 6978  nfft:.        ix
+0000e830: 3131 203d 206e 6666 740a 2020 2020 656c  11 = nfft.    el
+0000e840: 7365 3a0a 2020 2020 2020 2020 6978 3131  se:.        ix11
+0000e850: 203d 2069 7831 202b 206e 5f74 6170 6572   = ix1 + n_taper
+0000e860: 0a0a 2020 2020 6966 2069 7830 202d 206e  ..    if ix0 - n
+0000e870: 5f74 6170 6572 203c 2030 3a0a 2020 2020  _taper < 0:.    
+0000e880: 2020 2020 6978 3030 203d 2030 0a20 2020      ix00 = 0.   
+0000e890: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
+0000e8a0: 7830 3020 3d20 6978 3020 2d20 6e5f 7461  x00 = ix0 - n_ta
+0000e8b0: 7065 720a 0a20 2020 2073 7065 635f 6f75  per..    spec_ou
+0000e8c0: 7420 3d20 7370 6563 2e63 6f70 7928 290a  t = spec.copy().
+0000e8d0: 2020 2020 7370 6563 5f6f 7574 5b30 3a69      spec_out[0:i
+0000e8e0: 7830 305d 203d 2030 2e30 202b 2030 2e30  x00] = 0.0 + 0.0
+0000e8f0: 6a0a 2020 2020 7370 6563 5f6f 7574 5b69  j.    spec_out[i
+0000e900: 7831 313a 5d20 3d20 302e 3020 2b20 302e  x11:] = 0.0 + 0.
+0000e910: 306a 0a0a 2020 2020 6966 2073 6d6f 6f74  0j..    if smoot
+0000e920: 685f 4e20 3c3d 2031 3a0a 2020 2020 2020  h_N <= 1:.      
+0000e930: 2020 7370 6563 5f6f 7574 5b69 7830 303a    spec_out[ix00:
+0000e940: 6978 3131 5d20 3d20 6e70 2e65 7870 2831  ix11] = np.exp(1
+0000e950: 2e30 6a20 2a20 6e70 2e61 6e67 6c65 2873  .0j * np.angle(s
+0000e960: 7065 635f 6f75 745b 6978 3030 3a69 7831  pec_out[ix00:ix1
+0000e970: 315d 2929 0a20 2020 2065 6c73 653a 0a20  1])).    else:. 
+0000e980: 2020 2020 2020 2073 7065 635f 6f75 745b         spec_out[
+0000e990: 6978 3030 3a69 7831 315d 202f 3d20 6d6f  ix00:ix11] /= mo
+0000e9a0: 7669 6e67 5f61 7665 286e 702e 6162 7328  ving_ave(np.abs(
+0000e9b0: 7370 6563 5f6f 7574 5b69 7830 303a 6978  spec_out[ix00:ix
+0000e9c0: 3131 5d29 2c20 736d 6f6f 7468 5f4e 290a  11]), smooth_N).
+0000e9d0: 0a20 2020 2078 203d 206e 702e 6c69 6e73  .    x = np.lins
+0000e9e0: 7061 6365 286e 702e 7069 202f 2032 2e30  pace(np.pi / 2.0
+0000e9f0: 2c20 6e70 2e70 692c 2069 7830 202d 2069  , np.pi, ix0 - i
+0000ea00: 7830 3029 0a20 2020 2073 7065 635f 6f75  x00).    spec_ou
+0000ea10: 745b 6978 3030 3a69 7830 5d20 2a3d 206e  t[ix00:ix0] *= n
+0000ea20: 702e 636f 7328 7829 202a 2a20 320a 0a20  p.cos(x) ** 2.. 
+0000ea30: 2020 2078 203d 206e 702e 6c69 6e73 7061     x = np.linspa
+0000ea40: 6365 2830 2e30 2c20 6e70 2e70 6920 2f20  ce(0.0, np.pi / 
+0000ea50: 322e 302c 2069 7831 3120 2d20 6978 3129  2.0, ix11 - ix1)
+0000ea60: 0a20 2020 2073 7065 635f 6f75 745b 6978  .    spec_out[ix
+0000ea70: 313a 6978 3131 5d20 2a3d 206e 702e 636f  1:ix11] *= np.co
+0000ea80: 7328 7829 202a 2a20 320a 0a20 2020 2072  s(x) ** 2..    r
+0000ea90: 6574 7572 6e20 7370 6563 5f6f 7574 0a0a  eturn spec_out..
+0000eaa0: 0a64 6566 2077 6869 7465 6e5f 3244 2874  .def whiten_2D(t
+0000eab0: 696d 6573 6572 6965 732c 2066 6674 5f70  imeseries, fft_p
+0000eac0: 6172 612c 206e 5f74 6170 6572 293a 0a20  ara, n_taper):. 
+0000ead0: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
+0000eae0: 6675 6e63 7469 6f6e 2074 616b 6573 2061  function takes a
+0000eaf0: 2032 2d64 696d 656e 7369 6f6e 616c 2074   2-dimensional t
+0000eb00: 696d 6573 6572 6965 7320 6172 7261 792c  imeseries array,
+0000eb10: 2074 7261 6e73 666f 726d 7320 746f 2066   transforms to f
+0000eb20: 7265 7175 656e 6379 2064 6f6d 6169 6e20  requency domain 
+0000eb30: 7573 696e 6720 6666 742c 0a20 2020 2077  using fft,.    w
+0000eb40: 6869 7465 6e73 2074 6865 2061 6d70 6c69  hitens the ampli
+0000eb50: 7475 6465 206f 6620 7468 6520 7370 6563  tude of the spec
+0000eb60: 7472 756d 2069 6e20 6672 6571 7565 6e63  trum in frequenc
+0000eb70: 7920 646f 6d61 696e 2062 6574 7765 656e  y domain between
+0000eb80: 202a 6672 6571 6d69 6e2a 2061 6e64 202a   *freqmin* and *
+0000eb90: 6672 6571 6d61 782a 0a20 2020 2061 6e64  freqmax*.    and
+0000eba0: 2072 6574 7572 6e73 2074 6865 2077 6869   returns the whi
+0000ebb0: 7465 6e65 6420 6666 742e 0a20 2020 2050  tened fft..    P
+0000ebc0: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
+0000ebd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000ebe0: 2d2d 2d2d 2d0a 2020 2020 6461 7461 3a20  -----.    data: 
+0000ebf0: 6e75 6d70 792e 6e64 6172 7261 7920 636f  numpy.ndarray co
+0000ec00: 6e74 6169 6e73 2074 6865 2031 4420 7469  ntains the 1D ti
+0000ec10: 6d65 2073 6572 6965 7320 746f 2077 6869  me series to whi
+0000ec20: 7465 6e0a 2020 2020 6666 745f 7061 7261  ten.    fft_para
+0000ec30: 3a20 6469 6374 2063 6f6e 7461 696e 696e  : dict containin
+0000ec40: 6720 616c 6c20 6666 745f 6363 2070 6172  g all fft_cc par
+0000ec50: 616d 6574 6572 7320 7375 6368 2061 730a  ameters such as.
+0000ec60: 2020 2020 2020 2020 6474 3a20 5468 6520          dt: The 
+0000ec70: 7361 6d70 6c69 6e67 2073 7061 6365 206f  sampling space o
+0000ec80: 6620 7468 6520 6064 6174 6160 0a20 2020  f the `data`.   
+0000ec90: 2020 2020 2066 7265 716d 696e 3a20 5468       freqmin: Th
+0000eca0: 6520 6c6f 7765 7220 6672 6571 7565 6e63  e lower frequenc
+0000ecb0: 7920 626f 756e 640a 2020 2020 2020 2020  y bound.        
+0000ecc0: 6672 6571 6d61 783a 2054 6865 2075 7070  freqmax: The upp
+0000ecd0: 6572 2066 7265 7175 656e 6379 2062 6f75  er frequency bou
+0000ece0: 6e64 0a20 2020 2020 2020 2073 6d6f 6f74  nd.        smoot
+0000ecf0: 685f 4e3a 2069 6e74 6567 6572 2c20 6974  h_N: integer, it
+0000ed00: 2064 6566 696e 6573 2074 6865 2068 616c   defines the hal
+0000ed10: 6620 7769 6e64 6f77 206c 656e 6774 6820  f window length 
+0000ed20: 746f 2073 6d6f 6f74 680a 2020 2020 2020  to smooth.      
+0000ed30: 2020 6e5f 7461 7065 722c 206f 7074 696f    n_taper, optio
+0000ed40: 6e61 6c3a 2069 6e74 6567 6572 2c20 6465  nal: integer, de
+0000ed50: 6669 6e65 2074 6865 2077 6964 7468 206f  fine the width o
+0000ed60: 6620 7468 6520 7461 7065 7220 696e 2073  f the taper in s
+0000ed70: 616d 706c 6573 0a20 2020 2052 4554 5552  amples.    RETUR
+0000ed80: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+0000ed90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+0000eda0: 2020 2046 4654 5261 7753 6967 6e3a 206e     FFTRawSign: n
+0000edb0: 756d 7079 2e6e 6461 7272 6179 2063 6f6e  umpy.ndarray con
+0000edc0: 7461 696e 7320 7468 6520 4646 5420 6f66  tains the FFT of
+0000edd0: 2074 6865 2077 6869 7465 6e65 6420 696e   the whitened in
+0000ede0: 7075 7420 7472 6163 6520 6265 7477 6565  put trace betwee
+0000edf0: 6e20 7468 6520 6672 6571 7565 6e63 7920  n the frequency 
+0000ee00: 626f 756e 6473 0a20 2020 2022 2222 0a20  bounds.    """. 
+0000ee10: 2020 2023 206c 6f61 6420 7061 7261 6d65     # load parame
+0000ee20: 7465 7273 0a20 2020 2064 656c 7461 203d  ters.    delta =
+0000ee30: 2066 6674 5f70 6172 615b 2264 7422 5d0a   fft_para["dt"].
+0000ee40: 2020 2020 6672 6571 6d69 6e20 3d20 6666      freqmin = ff
+0000ee50: 745f 7061 7261 5b22 6672 6571 6d69 6e22  t_para["freqmin"
+0000ee60: 5d0a 2020 2020 6672 6571 6d61 7820 3d20  ].    freqmax = 
+0000ee70: 6666 745f 7061 7261 5b22 6672 6571 6d61  fft_para["freqma
+0000ee80: 7822 5d0a 2020 2020 736d 6f6f 7468 5f4e  x"].    smooth_N
+0000ee90: 203d 2066 6674 5f70 6172 615b 2273 6d6f   = fft_para["smo
+0000eea0: 6f74 685f 4e22 5d0a 0a20 2020 206e 6666  oth_N"]..    nff
+0000eeb0: 7420 3d20 6e65 7874 5f66 6173 745f 6c65  t = next_fast_le
+0000eec0: 6e28 7469 6d65 7365 7269 6573 2e73 6861  n(timeseries.sha
+0000eed0: 7065 5b31 5d29 0a20 2020 2073 7065 6320  pe[1]).    spec 
+0000eee0: 3d20 6e70 2e66 6674 2e66 6674 6e28 7469  = np.fft.fftn(ti
+0000eef0: 6d65 7365 7269 6573 2c20 733d 5b6e 6666  meseries, s=[nff
+0000ef00: 745d 290a 2020 2020 6672 6571 203d 206e  t]).    freq = n
+0000ef10: 702e 6666 742e 6666 7466 7265 7128 6e66  p.fft.fftfreq(nf
+0000ef20: 6674 2c20 643d 6465 6c74 6129 0a0a 2020  ft, d=delta)..  
+0000ef30: 2020 6978 3020 3d20 6e70 2e61 7267 6d69    ix0 = np.argmi
+0000ef40: 6e28 6e70 2e61 6273 2866 7265 7120 2d20  n(np.abs(freq - 
+0000ef50: 6672 6571 6d69 6e29 290a 2020 2020 6978  freqmin)).    ix
+0000ef60: 3120 3d20 6e70 2e61 7267 6d69 6e28 6e70  1 = np.argmin(np
+0000ef70: 2e61 6273 2866 7265 7120 2d20 6672 6571  .abs(freq - freq
+0000ef80: 6d61 7829 290a 0a20 2020 2069 6620 6978  max))..    if ix
+0000ef90: 3120 2b20 6e5f 7461 7065 7220 3e20 6e66  1 + n_taper > nf
+0000efa0: 6674 3a0a 2020 2020 2020 2020 6978 3131  ft:.        ix11
+0000efb0: 203d 206e 6666 740a 2020 2020 656c 7365   = nfft.    else
+0000efc0: 3a0a 2020 2020 2020 2020 6978 3131 203d  :.        ix11 =
+0000efd0: 2069 7831 202b 206e 5f74 6170 6572 0a0a   ix1 + n_taper..
+0000efe0: 2020 2020 6966 2069 7830 202d 206e 5f74      if ix0 - n_t
+0000eff0: 6170 6572 203c 2030 3a0a 2020 2020 2020  aper < 0:.      
+0000f000: 2020 6978 3030 203d 2030 0a20 2020 2065    ix00 = 0.    e
+0000f010: 6c73 653a 0a20 2020 2020 2020 2069 7830  lse:.        ix0
+0000f020: 3020 3d20 6978 3020 2d20 6e5f 7461 7065  0 = ix0 - n_tape
+0000f030: 720a 0a20 2020 2073 7065 635f 6f75 7420  r..    spec_out 
+0000f040: 3d20 7370 6563 2e63 6f70 7928 2920 2023  = spec.copy()  #
+0000f050: 206d 6179 2062 6520 696e 636f 6e76 656e   may be inconven
+0000f060: 6965 6e74 2064 7565 2074 6f20 6869 6768  ient due to high
+0000f070: 6572 206d 656d 6f72 7920 7573 6167 650a  er memory usage.
+0000f080: 2020 2020 7370 6563 5f6f 7574 5b3a 2c20      spec_out[:, 
+0000f090: 303a 6978 3030 5d20 3d20 302e 3020 2b20  0:ix00] = 0.0 + 
+0000f0a0: 302e 306a 0a20 2020 2073 7065 635f 6f75  0.0j.    spec_ou
+0000f0b0: 745b 3a2c 2069 7831 313a 5d20 3d20 302e  t[:, ix11:] = 0.
+0000f0c0: 3020 2b20 302e 306a 0a0a 2020 2020 6966  0 + 0.0j..    if
+0000f0d0: 2073 6d6f 6f74 685f 4e20 3c3d 2031 3a0a   smooth_N <= 1:.
+0000f0e0: 2020 2020 2020 2020 7370 6563 5f6f 7574          spec_out
+0000f0f0: 5b3a 2c20 6978 3030 3a69 7831 315d 203d  [:, ix00:ix11] =
+0000f100: 206e 702e 6578 7028 312e 306a 202a 206e   np.exp(1.0j * n
+0000f110: 702e 616e 676c 6528 7370 6563 5f6f 7574  p.angle(spec_out
+0000f120: 5b3a 2c20 6978 3030 3a69 7831 315d 2929  [:, ix00:ix11]))
+0000f130: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000f140: 2020 2073 7065 635f 6f75 745b 3a2c 2069     spec_out[:, i
+0000f150: 7830 303a 6978 3131 5d20 2f3d 206d 6f76  x00:ix11] /= mov
+0000f160: 696e 675f 6176 655f 3244 286e 702e 6162  ing_ave_2D(np.ab
+0000f170: 7328 7370 6563 5f6f 7574 5b3a 2c20 6978  s(spec_out[:, ix
+0000f180: 3030 3a69 7831 315d 292c 2073 6d6f 6f74  00:ix11]), smoot
+0000f190: 685f 4e29 0a0a 2020 2020 7820 3d20 6e70  h_N)..    x = np
+0000f1a0: 2e6c 696e 7370 6163 6528 6e70 2e70 6920  .linspace(np.pi 
+0000f1b0: 2f20 322e 302c 206e 702e 7069 2c20 6978  / 2.0, np.pi, ix
+0000f1c0: 3020 2d20 6978 3030 290a 2020 2020 7370  0 - ix00).    sp
+0000f1d0: 6563 5f6f 7574 5b3a 2c20 6978 3030 3a69  ec_out[:, ix00:i
+0000f1e0: 7830 5d20 2a3d 206e 702e 636f 7328 7829  x0] *= np.cos(x)
+0000f1f0: 202a 2a20 320a 0a20 2020 2078 203d 206e   ** 2..    x = n
+0000f200: 702e 6c69 6e73 7061 6365 2830 2e30 2c20  p.linspace(0.0, 
+0000f210: 6e70 2e70 6920 2f20 322e 302c 2069 7831  np.pi / 2.0, ix1
+0000f220: 3120 2d20 6978 3129 0a20 2020 2073 7065  1 - ix1).    spe
+0000f230: 635f 6f75 745b 3a2c 2069 7831 3a69 7831  c_out[:, ix1:ix1
+0000f240: 315d 202a 3d20 6e70 2e63 6f73 2878 2920  1] *= np.cos(x) 
+0000f250: 2a2a 2032 0a0a 2020 2020 7265 7475 726e  ** 2..    return
+0000f260: 2073 7065 635f 6f75 740a 0a0a 6465 6620   spec_out...def 
+0000f270: 7768 6974 656e 2864 6174 612c 2066 6674  whiten(data, fft
+0000f280: 5f70 6172 612c 206e 5f74 6170 6572 3d31  _para, n_taper=1
+0000f290: 3030 293a 0a20 2020 2022 2222 0a20 2020  00):.    """.   
+0000f2a0: 2054 6869 7320 6675 6e63 7469 6f6e 2074   This function t
+0000f2b0: 616b 6573 2061 2074 696d 6573 6572 6965  akes a timeserie
+0000f2c0: 7320 6172 7261 792c 2074 7261 6e73 666f  s array, transfo
+0000f2d0: 726d 7320 746f 2066 7265 7175 656e 6379  rms to frequency
+0000f2e0: 2064 6f6d 6169 6e20 7573 696e 6720 6666   domain using ff
+0000f2f0: 742c 0a20 2020 2077 6869 7465 6e73 2074  t,.    whitens t
+0000f300: 6865 2061 6d70 6c69 7475 6465 206f 6620  he amplitude of 
+0000f310: 7468 6520 7370 6563 7472 756d 2069 6e20  the spectrum in 
+0000f320: 6672 6571 7565 6e63 7920 646f 6d61 696e  frequency domain
+0000f330: 2062 6574 7765 656e 202a 6672 6571 6d69   between *freqmi
+0000f340: 6e2a 2061 6e64 202a 6672 6571 6d61 782a  n* and *freqmax*
+0000f350: 0a20 2020 2061 6e64 2072 6574 7572 6e73  .    and returns
+0000f360: 2074 6865 2077 6869 7465 6e65 6420 6666   the whitened ff
+0000f370: 742e 0a20 2020 2050 4152 414d 4554 4552  t..    PARAMETER
+0000f380: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
+0000f390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0000f3a0: 2020 6461 7461 3a20 6e75 6d70 792e 6e64    data: numpy.nd
+0000f3b0: 6172 7261 7920 636f 6e74 6169 6e73 2074  array contains t
+0000f3c0: 6865 2031 4420 7469 6d65 2073 6572 6965  he 1D time serie
+0000f3d0: 7320 746f 2077 6869 7465 6e0a 2020 2020  s to whiten.    
+0000f3e0: 6666 745f 7061 7261 3a20 6469 6374 2063  fft_para: dict c
+0000f3f0: 6f6e 7461 696e 696e 6720 616c 6c20 6666  ontaining all ff
+0000f400: 745f 6363 2070 6172 616d 6574 6572 7320  t_cc parameters 
+0000f410: 7375 6368 2061 730a 2020 2020 2020 2020  such as.        
+0000f420: 6474 3a20 5468 6520 7361 6d70 6c69 6e67  dt: The sampling
+0000f430: 2073 7061 6365 206f 6620 7468 6520 6064   space of the `d
+0000f440: 6174 6160 0a20 2020 2020 2020 2066 7265  ata`.        fre
+0000f450: 716d 696e 3a20 5468 6520 6c6f 7765 7220  qmin: The lower 
+0000f460: 6672 6571 7565 6e63 7920 626f 756e 640a  frequency bound.
+0000f470: 2020 2020 2020 2020 6672 6571 6d61 783a          freqmax:
+0000f480: 2054 6865 2075 7070 6572 2066 7265 7175   The upper frequ
+0000f490: 656e 6379 2062 6f75 6e64 0a20 2020 2020  ency bound.     
+0000f4a0: 2020 2073 6d6f 6f74 685f 4e3a 2069 6e74     smooth_N: int
+0000f4b0: 6567 6572 2c20 6974 2064 6566 696e 6573  eger, it defines
+0000f4c0: 2074 6865 2068 616c 6620 7769 6e64 6f77   the half window
+0000f4d0: 206c 656e 6774 6820 746f 2073 6d6f 6f74   length to smoot
+0000f4e0: 680a 2020 2020 2020 2020 6672 6571 5f6e  h.        freq_n
+0000f4f0: 6f72 6d3a 2077 6869 7465 6e69 6e67 206d  orm: whitening m
+0000f500: 6574 686f 6420 6265 7477 6565 6e20 276f  ethod between 'o
+0000f510: 6e65 2d62 6974 2720 616e 6420 2752 4d41  ne-bit' and 'RMA
+0000f520: 270a 2020 2020 5245 5455 524e 533a 0a20  '.    RETURNS:. 
+0000f530: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0000f540: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 4646  ---------.    FF
+0000f550: 5452 6177 5369 676e 3a20 6e75 6d70 792e  TRawSign: numpy.
+0000f560: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
+0000f570: 2074 6865 2046 4654 206f 6620 7468 6520   the FFT of the 
+0000f580: 7768 6974 656e 6564 2069 6e70 7574 2074  whitened input t
+0000f590: 7261 6365 2062 6574 7765 656e 2074 6865  race between the
+0000f5a0: 2066 7265 7175 656e 6379 2062 6f75 6e64   frequency bound
+0000f5b0: 730a 2020 2020 2222 220a 0a20 2020 2023  s.    """..    #
+0000f5c0: 2053 7065 6564 2075 7020 4646 5420 6279   Speed up FFT by
+0000f5d0: 2070 6164 6469 6e67 2074 6f20 6f70 7469   padding to opti
+0000f5e0: 6d61 6c20 7369 7a65 2066 6f72 2046 4654  mal size for FFT
+0000f5f0: 5041 434b 0a20 2020 2069 6620 6461 7461  PACK.    if data
+0000f600: 2e6e 6469 6d20 3d3d 2031 3a0a 2020 2020  .ndim == 1:.    
+0000f610: 2020 2020 4646 5452 6177 5369 676e 203d      FFTRawSign =
+0000f620: 2077 6869 7465 6e5f 3144 2864 6174 612c   whiten_1D(data,
+0000f630: 2066 6674 5f70 6172 612c 206e 5f74 6170   fft_para, n_tap
+0000f640: 6572 290a 2020 2020 2020 2020 2320 4152  er).        # AR
+0000f650: 525f 4f55 543a 204f 6e6c 7920 666f 7220  R_OUT: Only for 
+0000f660: 636f 6e73 6973 7465 6e63 7920 7769 7468  consistency with
+0000f670: 206e 6f69 7365 7079 2061 7070 726f 6163   noisepy approac
+0000f680: 6820 6f66 2068 6f6c 6469 6e67 2074 6865  h of holding the
+0000f690: 2066 756c 6c0a 2020 2020 2020 2020 2320   full.        # 
+0000f6a0: 7370 6563 7472 756d 2028 6e6f 7420 6a75  spectrum (not ju
+0000f6b0: 7374 2030 2061 6e64 2070 6f73 6974 6976  st 0 and positiv
+0000f6c0: 6520 6672 6571 2e20 7061 7274 290a 2020  e freq. part).  
+0000f6d0: 2020 2020 2020 6172 725f 6f75 7420 3d20        arr_out = 
+0000f6e0: 6e70 2e7a 6572 6f73 2828 4646 5452 6177  np.zeros((FFTRaw
+0000f6f0: 5369 676e 2e73 6861 7065 5b30 5d20 2d20  Sign.shape[0] - 
+0000f700: 3129 202a 2032 202b 2031 2c20 6474 7970  1) * 2 + 1, dtyp
+0000f710: 653d 636f 6d70 6c65 7829 0a20 2020 2020  e=complex).     
+0000f720: 2020 2061 7272 5f6f 7574 5b30 203a 2046     arr_out[0 : F
+0000f730: 4654 5261 7753 6967 6e2e 7368 6170 655b  FTRawSign.shape[
+0000f740: 305d 5d20 3d20 4646 5452 6177 5369 676e  0]] = FFTRawSign
+0000f750: 0a20 2020 2020 2020 2061 7272 5f6f 7574  .        arr_out
+0000f760: 5b46 4654 5261 7753 6967 6e2e 7368 6170  [FFTRawSign.shap
+0000f770: 655b 305d 203a 5d20 3d20 4646 5452 6177  e[0] :] = FFTRaw
+0000f780: 5369 676e 5b31 3a5d 2e63 6f6e 6a75 6761  Sign[1:].conjuga
+0000f790: 7465 2829 5b3a 3a2d 315d 0a0a 2020 2020  te()[::-1]..    
+0000f7a0: 656c 6966 2064 6174 612e 6e64 696d 203d  elif data.ndim =
+0000f7b0: 3d20 323a 0a20 2020 2020 2020 2046 4654  = 2:.        FFT
+0000f7c0: 5261 7753 6967 6e20 3d20 7768 6974 656e  RawSign = whiten
+0000f7d0: 5f32 4428 6461 7461 2c20 6666 745f 7061  _2D(data, fft_pa
+0000f7e0: 7261 2c20 6e5f 7461 7065 7229 0a20 2020  ra, n_taper).   
+0000f7f0: 2020 2020 2061 7272 5f6f 7574 203d 206e       arr_out = n
+0000f800: 702e 7a65 726f 7328 2846 4654 5261 7753  p.zeros((FFTRawS
+0000f810: 6967 6e2e 7368 6170 655b 305d 2c20 2846  ign.shape[0], (F
+0000f820: 4654 5261 7753 6967 6e2e 7368 6170 655b  FTRawSign.shape[
+0000f830: 315d 202d 2031 2920 2a20 3220 2b20 3129  1] - 1) * 2 + 1)
+0000f840: 2c20 6474 7970 653d 636f 6d70 6c65 7829  , dtype=complex)
+0000f850: 0a20 2020 2020 2020 2061 7272 5f6f 7574  .        arr_out
+0000f860: 5b3a 2c20 4646 5452 6177 5369 676e 2e73  [:, FFTRawSign.s
+0000f870: 6861 7065 5b31 5d20 3a5d 203d 2046 4654  hape[1] :] = FFT
+0000f880: 5261 7753 6967 6e5b 3a2c 2031 3a5d 2e63  RawSign[:, 1:].c
+0000f890: 6f6e 6a75 6761 7465 2829 5b3a 3a2d 315d  onjugate()[::-1]
+0000f8a0: 0a20 2020 2072 6574 7572 6e20 4646 5452  .    return FFTR
+0000f8b0: 6177 5369 676e 0a0a 0a64 6566 2061 6461  awSign...def ada
+0000f8c0: 7074 6976 655f 6669 6c74 6572 2861 7272  ptive_filter(arr
+0000f8d0: 2c20 6729 3a0a 2020 2020 2222 220a 2020  , g):.    """.  
+0000f8e0: 2020 7468 6520 6164 6170 7469 7665 2063    the adaptive c
+0000f8f0: 6f76 6172 6961 6e63 6520 6669 6c74 6572  ovariance filter
+0000f900: 2074 6f20 656e 6861 6e63 6520 636f 6865   to enhance cohe
+0000f910: 7265 6e74 2073 6967 6e61 6c73 2e20 4665  rent signals. Fe
+0000f920: 6c6c 6f77 7320 7468 6520 6d65 7468 6f64  llows the method
+0000f930: 206f 660a 2020 2020 4e61 6b61 7461 2065   of.    Nakata e
+0000f940: 7420 616c 2e2c 2032 3031 3520 2841 7070  t al., 2015 (App
+0000f950: 656e 6469 7820 4229 0a0a 2020 2020 7468  endix B)..    th
+0000f960: 6520 6669 6c74 6572 6564 2073 6967 6e61  e filtered signa
+0000f970: 6c20 5b78 315d 2069 7320 6769 7665 6e20  l [x1] is given 
+0000f980: 6279 2078 3120 3d20 6966 6674 2850 2a78  by x1 = ifft(P*x
+0000f990: 3128 7729 2920 7768 6572 6520 7831 2069  1(w)) where x1 i
+0000f9a0: 7320 7468 6520 6666 7465 6420 7370 6563  s the ffted spec
+0000f9b0: 7472 610a 2020 2020 616e 6420 5020 6973  tra.    and P is
+0000f9c0: 2074 6865 2066 696c 7465 722e 2050 2069   the filter. P i
+0000f9d0: 7320 636f 6e73 7472 7563 7465 6420 6279  s constructed by
+0000f9e0: 2075 7369 6e67 2074 6865 2074 656d 706f   using the tempo
+0000f9f0: 7261 6c20 636f 7661 7269 616e 6365 206d  ral covariance m
+0000fa00: 6174 7269 782e 0a0a 2020 2020 5041 5241  atrix...    PARA
+0000fa10: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
+0000fa20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000fa30: 2d2d 0a20 2020 2061 7272 3a20 6e75 6d70  --.    arr: nump
+0000fa40: 792e 6e64 6172 7261 7920 636f 6e74 6169  y.ndarray contai
+0000fa50: 6e73 2074 6865 2032 4420 7472 6163 6573  ns the 2D traces
+0000fa60: 206f 6620 6461 696c 792f 686f 7572 6c79   of daily/hourly
+0000fa70: 2063 726f 7373 2d63 6f72 7265 6c61 7469   cross-correlati
+0000fa80: 6f6e 2066 756e 6374 696f 6e73 0a20 2020  on functions.   
+0000fa90: 2067 3a20 6120 706f 7369 7469 7665 206e   g: a positive n
+0000faa0: 756d 6265 7220 746f 2061 646a 7573 7420  umber to adjust 
+0000fab0: 7468 6520 6669 6c74 6572 2068 6172 7368  the filter harsh
+0000fac0: 6e65 7373 0a20 2020 2052 4554 5552 4e53  ness.    RETURNS
+0000fad0: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+0000fae0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+0000faf0: 206e 6172 723a 206e 756d 7079 2076 6563   narr: numpy vec
+0000fb00: 746f 7220 636f 6e74 6169 6e73 2074 6865  tor contains the
+0000fb10: 2073 7461 636b 6564 2063 726f 7373 2063   stacked cross c
+0000fb20: 6f72 7265 6c61 7469 6f6e 2066 756e 6374  orrelation funct
+0000fb30: 696f 6e0a 2020 2020 2222 220a 2020 2020  ion.    """.    
+0000fb40: 6966 2061 7272 2e6e 6469 6d20 3d3d 2031  if arr.ndim == 1
+0000fb50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000fb60: 2061 7272 0a20 2020 204e 2c20 4d20 3d20   arr.    N, M = 
+0000fb70: 6172 722e 7368 6170 650a 2020 2020 4e66  arr.shape.    Nf
+0000fb80: 6674 203d 206e 6578 745f 6661 7374 5f6c  ft = next_fast_l
+0000fb90: 656e 284d 290a 0a20 2020 2023 2066 6674  en(M)..    # fft
+0000fba0: 2074 6865 2032 4420 6172 7261 790a 2020   the 2D array.  
+0000fbb0: 2020 7370 6563 203d 2073 6369 7079 2e66    spec = scipy.f
+0000fbc0: 6674 7061 636b 2e66 6674 2861 7272 2c20  ftpack.fft(arr, 
+0000fbd0: 6178 6973 3d31 2c20 6e3d 4e66 6674 295b  axis=1, n=Nfft)[
+0000fbe0: 3a2c 203a 4d5d 0a0a 2020 2020 2320 6d61  :, :M]..    # ma
+0000fbf0: 6b65 2063 726f 7373 2d73 7065 6374 726d  ke cross-spectrm
+0000fc00: 206d 6174 7269 780a 2020 2020 6373 7065   matrix.    cspe
+0000fc10: 6320 3d20 6e70 2e7a 6572 6f73 2873 6861  c = np.zeros(sha
+0000fc20: 7065 3d28 4e20 2a20 4e2c 204d 292c 2064  pe=(N * N, M), d
+0000fc30: 7479 7065 3d6e 702e 636f 6d70 6c65 7836  type=np.complex6
+0000fc40: 3429 0a20 2020 2066 6f72 2069 6920 696e  4).    for ii in
+0000fc50: 2072 616e 6765 284e 293a 0a20 2020 2020   range(N):.     
+0000fc60: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
+0000fc70: 6765 284e 293a 0a20 2020 2020 2020 2020  ge(N):.         
+0000fc80: 2020 206b 6b20 3d20 6969 202a 204e 202b     kk = ii * N +
+0000fc90: 206a 6a0a 2020 2020 2020 2020 2020 2020   jj.            
+0000fca0: 6373 7065 635b 6b6b 5d20 3d20 7370 6563  cspec[kk] = spec
+0000fcb0: 5b69 695d 202a 206e 702e 636f 6e6a 7567  [ii] * np.conjug
+0000fcc0: 6174 6528 7370 6563 5b6a 6a5d 290a 0a20  ate(spec[jj]).. 
+0000fcd0: 2020 2053 3120 3d20 6e70 2e7a 6572 6f73     S1 = np.zeros
+0000fce0: 284d 2c20 6474 7970 653d 6e70 2e63 6f6d  (M, dtype=np.com
+0000fcf0: 706c 6578 3634 290a 2020 2020 5332 203d  plex64).    S2 =
+0000fd00: 206e 702e 7a65 726f 7328 4d2c 2064 7479   np.zeros(M, dty
+0000fd10: 7065 3d6e 702e 636f 6d70 6c65 7836 3429  pe=np.complex64)
+0000fd20: 0a20 2020 2023 2063 6f6e 7374 7275 6374  .    # construct
+0000fd30: 2074 6865 2066 696c 7465 7220 500a 2020   the filter P.  
+0000fd40: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
+0000fd50: 6528 4e29 3a0a 2020 2020 2020 2020 6d6d  e(N):.        mm
+0000fd60: 203d 2069 6920 2a20 4e20 2b20 6969 0a20   = ii * N + ii. 
+0000fd70: 2020 2020 2020 2053 3220 2b3d 2063 7370         S2 += csp
+0000fd80: 6563 5b6d 6d5d 0a20 2020 2020 2020 2066  ec[mm].        f
+0000fd90: 6f72 206a 6a20 696e 2072 616e 6765 284e  or jj in range(N
+0000fda0: 293a 0a20 2020 2020 2020 2020 2020 206b  ):.            k
+0000fdb0: 6b20 3d20 6969 202a 204e 202b 206a 6a0a  k = ii * N + jj.
+0000fdc0: 2020 2020 2020 2020 2020 2020 5331 202b              S1 +
+0000fdd0: 3d20 6373 7065 635b 6b6b 5d0a 0a20 2020  = cspec[kk]..   
+0000fde0: 2070 203d 206e 702e 706f 7765 7228 2853   p = np.power((S
+0000fdf0: 3120 2d20 5332 2920 2f20 2853 3220 2a20  1 - S2) / (S2 * 
+0000fe00: 284e 202d 2031 2929 2c20 6729 0a0a 2020  (N - 1)), g)..  
+0000fe10: 2020 2320 6d61 6b65 2069 6666 740a 2020    # make ifft.  
+0000fe20: 2020 6e61 7272 203d 206e 702e 7265 616c    narr = np.real
+0000fe30: 2873 6369 7079 2e66 6674 7061 636b 2e69  (scipy.fftpack.i
+0000fe40: 6666 7428 6e70 2e6d 756c 7469 706c 7928  fft(np.multiply(
+0000fe50: 702c 2073 7065 6329 2c20 4e66 6674 2c20  p, spec), Nfft, 
+0000fe60: 6178 6973 3d31 295b 3a2c 203a 4d5d 290a  axis=1)[:, :M]).
+0000fe70: 2020 2020 7265 7475 726e 206e 702e 6d65      return np.me
+0000fe80: 616e 286e 6172 722c 2061 7869 733d 3029  an(narr, axis=0)
+0000fe90: 0a0a 0a64 6566 2070 7773 2861 7272 2c20  ...def pws(arr, 
+0000fea0: 7361 6d70 6c69 6e67 5f72 6174 652c 2070  sampling_rate, p
+0000feb0: 6f77 6572 3d32 2c20 7077 735f 7469 6d65  ower=2, pws_time
+0000fec0: 6761 7465 3d35 2e30 293a 0a20 2020 2022  gate=5.0):.    "
+0000fed0: 2222 0a20 2020 2050 6572 666f 726d 7320  "".    Performs 
+0000fee0: 7068 6173 652d 7765 6967 6874 6564 2073  phase-weighted s
+0000fef0: 7461 636b 206f 6e20 6172 7261 7920 6f66  tack on array of
+0000ff00: 2074 696d 6520 7365 7269 6573 2e20 4d6f   time series. Mo
+0000ff10: 6469 6669 6564 206f 6e20 7468 6520 6e6f  dified on the no
+0000ff20: 6973 6520 6675 6e63 7469 6f6e 2062 7920  ise function by 
+0000ff30: 5469 6d20 436c 696d 656e 7473 2e0a 2020  Tim Climents..  
+0000ff40: 2020 466f 6c6c 6f77 7320 6d65 7468 6f64    Follows method
+0000ff50: 7320 6f66 2053 6368 696d 6d65 6c20 616e  s of Schimmel an
+0000ff60: 6420 5061 756c 7373 656e 2c20 3139 3937  d Paulssen, 1997
+0000ff70: 2e0a 2020 2020 4966 2073 2874 2920 6973  ..    If s(t) is
+0000ff80: 2074 696d 6520 7365 7269 6573 2064 6174   time series dat
+0000ff90: 6120 2873 6569 736d 6f67 7261 6d2c 206f  a (seismogram, o
+0000ffa0: 7220 6372 6f73 732d 636f 7272 656c 6174  r cross-correlat
+0000ffb0: 696f 6e29 2c0a 2020 2020 5328 7429 203d  ion),.    S(t) =
+0000ffc0: 2073 2874 2920 2b20 692a 4828 7328 7429   s(t) + i*H(s(t)
+0000ffd0: 292c 2077 6865 7265 2048 2873 2874 2929  ), where H(s(t))
+0000ffe0: 2069 7320 4869 6c62 6572 7420 7472 616e   is Hilbert tran
+0000fff0: 7366 6f72 6d20 6f66 2073 2874 290a 2020  sform of s(t).  
+00010000: 2020 5328 7429 203d 2073 2874 2920 2b20    S(t) = s(t) + 
+00010010: 692a 4828 7328 7429 2920 3d20 4128 7429  i*H(s(t)) = A(t)
+00010020: 2a65 7870 2869 2a70 6869 2874 2929 2c20  *exp(i*phi(t)), 
+00010030: 7768 6572 650a 2020 2020 4128 7429 2069  where.    A(t) i
+00010040: 7320 656e 7665 6c6f 7065 206f 6620 7328  s envelope of s(
+00010050: 7429 2061 6e64 2070 6869 2874 2920 6973  t) and phi(t) is
+00010060: 2070 6861 7365 206f 6620 7328 7429 0a20   phase of s(t). 
+00010070: 2020 2050 6861 7365 2d77 6569 6768 7465     Phase-weighte
+00010080: 6420 7374 6163 6b2c 2067 2874 292c 2069  d stack, g(t), i
+00010090: 7320 7468 656e 3a0a 2020 2020 6728 7429  s then:.    g(t)
+000100a0: 203d 2031 2f4e 2073 756d 206a 203d 2031   = 1/N sum j = 1
+000100b0: 3a4e 2073 5f6a 2874 2920 2a20 7c20 312f  :N s_j(t) * | 1/
+000100c0: 4e20 7375 6d20 6b20 3d20 313a 4e20 6578  N sum k = 1:N ex
+000100d0: 705b 6920 2a20 7068 695f 6b28 7429 5d7c  p[i * phi_k(t)]|
+000100e0: 5e76 0a20 2020 2077 6865 7265 204e 2069  ^v.    where N i
+000100f0: 7320 6e75 6d62 6572 206f 6620 7472 6163  s number of trac
+00010100: 6573 2075 7365 642c 2076 2069 7320 7368  es used, v is sh
+00010110: 6172 706e 6573 7320 6f66 2070 6861 7365  arpness of phase
+00010120: 2d77 6569 6768 7465 6420 7374 6163 6b0a  -weighted stack.
+00010130: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
+00010140: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+00010150: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2061  ----------.    a
+00010160: 7272 3a20 4e20 6c65 6e67 7468 2061 7272  rr: N length arr
+00010170: 6179 206f 6620 7469 6d65 2073 6572 6965  ay of time serie
+00010180: 7320 6461 7461 2028 6e75 6d70 792e 6e64  s data (numpy.nd
+00010190: 6172 7261 7929 0a20 2020 2073 616d 706c  array).    sampl
+000101a0: 696e 675f 7261 7465 3a20 7361 6d70 6c69  ing_rate: sampli
+000101b0: 6e67 2072 6174 6520 6f66 2074 696d 6520  ng rate of time 
+000101c0: 7365 7269 6573 2061 7272 2028 696e 7429  series arr (int)
+000101d0: 0a20 2020 2070 6f77 6572 3a20 6578 706f  .    power: expo
+000101e0: 6e65 6e74 2066 6f72 2070 6861 7365 2073  nent for phase s
+000101f0: 7461 636b 2028 696e 7429 0a20 2020 2070  tack (int).    p
+00010200: 7773 5f74 696d 6567 6174 653a 206e 756d  ws_timegate: num
+00010210: 6265 7220 6f66 2073 6563 6f6e 6473 2074  ber of seconds t
+00010220: 6f20 736d 6f6f 7468 2070 6861 7365 2073  o smooth phase s
+00010230: 7461 636b 2028 666c 6f61 7429 0a0a 2020  tack (float)..  
+00010240: 2020 5245 5455 524e 533a 0a20 2020 202d    RETURNS:.    -
+00010250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00010260: 2d2d 2d2d 0a20 2020 2077 6569 6768 7465  ----.    weighte
+00010270: 643a 2050 6861 7365 2077 6569 6768 7465  d: Phase weighte
+00010280: 6420 7374 6163 6b20 6f66 2074 696d 6520  d stack of time 
+00010290: 7365 7269 6573 2064 6174 6120 286e 756d  series data (num
+000102a0: 7079 2e6e 6461 7272 6179 290a 2020 2020  py.ndarray).    
+000102b0: 2222 220a 0a20 2020 2069 6620 6172 722e  """..    if arr.
+000102c0: 6e64 696d 203d 3d20 313a 0a20 2020 2020  ndim == 1:.     
+000102d0: 2020 2072 6574 7572 6e20 6172 720a 2020     return arr.  
+000102e0: 2020 4e2c 204d 203d 2061 7272 2e73 6861    N, M = arr.sha
+000102f0: 7065 0a20 2020 2061 6e61 6c79 7469 6320  pe.    analytic 
+00010300: 3d20 6869 6c62 6572 7428 6172 722c 2061  = hilbert(arr, a
+00010310: 7869 733d 312c 204e 3d6e 6578 745f 6661  xis=1, N=next_fa
+00010320: 7374 5f6c 656e 284d 2929 5b3a 2c20 3a4d  st_len(M))[:, :M
+00010330: 5d0a 2020 2020 7068 6173 6520 3d20 6e70  ].    phase = np
+00010340: 2e61 6e67 6c65 2861 6e61 6c79 7469 6329  .angle(analytic)
+00010350: 0a20 2020 2070 6861 7365 5f73 7461 636b  .    phase_stack
+00010360: 203d 206e 702e 6d65 616e 286e 702e 6578   = np.mean(np.ex
+00010370: 7028 316a 202a 2070 6861 7365 292c 2061  p(1j * phase), a
+00010380: 7869 733d 3029 0a20 2020 2070 6861 7365  xis=0).    phase
+00010390: 5f73 7461 636b 203d 206e 702e 6162 7328  _stack = np.abs(
+000103a0: 7068 6173 655f 7374 6163 6b29 202a 2a20  phase_stack) ** 
+000103b0: 2870 6f77 6572 290a 0a20 2020 2023 2073  (power)..    # s
+000103c0: 6d6f 6f74 6869 6e67 0a20 2020 2023 2074  moothing.    # t
+000103d0: 696d 6567 6174 655f 7361 6d70 6c65 7320  imegate_samples 
+000103e0: 3d20 696e 7428 7077 735f 7469 6d65 6761  = int(pws_timega
+000103f0: 7465 202a 2073 616d 706c 696e 675f 7261  te * sampling_ra
+00010400: 7465 290a 2020 2020 2320 7068 6173 655f  te).    # phase_
+00010410: 7374 6163 6b20 3d20 6d6f 7669 6e67 5f61  stack = moving_a
+00010420: 7665 2870 6861 7365 5f73 7461 636b 2c74  ve(phase_stack,t
+00010430: 696d 6567 6174 655f 7361 6d70 6c65 7329  imegate_samples)
+00010440: 0a20 2020 2077 6569 6768 7465 6420 3d20  .    weighted = 
+00010450: 6e70 2e6d 756c 7469 706c 7928 6172 722c  np.multiply(arr,
+00010460: 2070 6861 7365 5f73 7461 636b 290a 2020   phase_stack).  
+00010470: 2020 7265 7475 726e 206e 702e 6d65 616e    return np.mean
+00010480: 2877 6569 6768 7465 642c 2061 7869 733d  (weighted, axis=
+00010490: 3029 0a0a 0a64 6566 206e 726f 6f74 5f73  0)...def nroot_s
+000104a0: 7461 636b 2863 635f 6172 7261 792c 2070  tack(cc_array, p
+000104b0: 6f77 6572 293a 0a20 2020 2022 2222 0a20  ower):.    """. 
+000104c0: 2020 2074 6869 7320 6973 206e 7468 2d72     this is nth-r
+000104d0: 6f6f 7420 7374 6163 6b69 6e67 2061 6c67  oot stacking alg
+000104e0: 6f72 6974 686d 2074 7261 6e73 6c61 7465  orithm translate
+000104f0: 6420 6261 7365 6420 6f6e 2074 6865 206d  d based on the m
+00010500: 6174 6c61 6220 6675 6e63 7469 6f6e 0a20  atlab function. 
+00010510: 2020 2066 726f 6d20 6874 7470 733a 2f2f     from https://
+00010520: 6769 7468 7562 2e63 6f6d 2f78 7479 616e  github.com/xtyan
+00010530: 6770 7370 2f53 6569 7353 7461 636b 2028  gpsp/SeisStack (
+00010540: 6279 2058 6961 6f74 616f 2059 616e 673b  by Xiaotao Yang;
+00010550: 2066 6f6c 6c6f 7773 2074 6865 0a20 2020   follows the.   
+00010560: 2072 6566 6572 656e 6365 206f 6620 4d69   reference of Mi
+00010570: 6c6c 6574 2c20 4620 6574 2061 6c2e 2c20  llet, F et al., 
+00010580: 3230 3139 204a 4752 290a 0a20 2020 2050  2019 JGR)..    P
+00010590: 6172 616d 6574 6572 733a 0a20 2020 202d  arameters:.    -
+000105a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+000105b0: 6363 5f61 7272 6179 3a20 6e75 6d70 792e  cc_array: numpy.
+000105c0: 6e64 6172 7261 7920 636f 6e74 6169 6e73  ndarray contains
+000105d0: 2074 6865 2032 4420 6372 6f73 7320 636f   the 2D cross co
+000105e0: 7272 656c 6174 696f 6e20 6d61 7472 6978  rrelation matrix
+000105f0: 0a20 2020 2070 6f77 6572 3a20 6e70 2e69  .    power: np.i
+00010600: 6e74 2c20 6e74 6820 726f 6f74 2066 6f72  nt, nth root for
+00010610: 2074 6865 2073 7461 636b 696e 670a 0a20   the stacking.. 
+00010620: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00010630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00010640: 206e 7374 6163 6b3a 206e 702e 6e64 6172   nstack: np.ndar
+00010650: 7261 792c 2066 696e 616c 2073 7461 636b  ray, final stack
+00010660: 6564 2077 6176 6566 6f72 6d73 0a0a 2020  ed waveforms..  
+00010670: 2020 5772 6974 7465 6e20 6279 2043 6865    Written by Che
+00010680: 6e67 7869 6e20 4a69 616e 6720 4041 4e55  ngxin Jiang @ANU
+00010690: 2028 4d61 7932 3032 3029 0a20 2020 2022   (May2020).    "
+000106a0: 2222 0a20 2020 2069 6620 6363 5f61 7272  "".    if cc_arr
+000106b0: 6179 2e6e 6469 6d20 3d3d 2031 3a0a 2020  ay.ndim == 1:.  
+000106c0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+000106d0: 7567 2822 3244 206d 6174 7269 7820 6973  ug("2D matrix is
+000106e0: 206e 6565 6465 6420 666f 7220 6e72 6f6f   needed for nroo
+000106f0: 745f 7374 6163 6b22 290a 2020 2020 2020  t_stack").      
+00010700: 2020 7265 7475 726e 2063 635f 6172 7261    return cc_arra
+00010710: 790a 2020 2020 4e2c 204d 203d 2063 635f  y.    N, M = cc_
+00010720: 6172 7261 792e 7368 6170 650a 2020 2020  array.shape.    
+00010730: 646f 7574 203d 206e 702e 7a65 726f 7328  dout = np.zeros(
+00010740: 4d2c 2064 7479 7065 3d6e 702e 666c 6f61  M, dtype=np.floa
+00010750: 7433 3229 0a0a 2020 2020 2320 636f 6e73  t32)..    # cons
+00010760: 7472 7563 7420 790a 2020 2020 666f 7220  truct y.    for 
+00010770: 6969 2069 6e20 7261 6e67 6528 4e29 3a0a  ii in range(N):.
+00010780: 2020 2020 2020 2020 6461 7420 3d20 6363          dat = cc
+00010790: 5f61 7272 6179 5b69 692c 203a 5d0a 2020  _array[ii, :].  
+000107a0: 2020 2020 2020 646f 7574 202b 3d20 6e70        dout += np
+000107b0: 2e73 6967 6e28 6461 7429 202a 206e 702e  .sign(dat) * np.
+000107c0: 6162 7328 6461 7429 202a 2a20 2831 202f  abs(dat) ** (1 /
+000107d0: 2070 6f77 6572 290a 2020 2020 646f 7574   power).    dout
+000107e0: 202f 3d20 4e0a 0a20 2020 2023 2074 6865   /= N..    # the
+000107f0: 2066 696e 616c 2073 7461 636b 6564 2077   final stacked w
+00010800: 6176 6566 6f72 6d0a 2020 2020 6e73 7461  aveform.    nsta
+00010810: 636b 203d 2064 6f75 7420 2a20 6e70 2e61  ck = dout * np.a
+00010820: 6273 2864 6f75 7429 202a 2a20 2870 6f77  bs(dout) ** (pow
+00010830: 6572 202d 2031 290a 0a20 2020 2072 6574  er - 1)..    ret
+00010840: 7572 6e20 6e73 7461 636b 0a0a 0a64 6566  urn nstack...def
+00010850: 2073 656c 6563 7469 7665 5f73 7461 636b   selective_stack
+00010860: 2863 635f 6172 7261 792c 2065 7073 696c  (cc_array, epsil
+00010870: 6f6e 2c20 6363 5f74 6829 3a20 2023 206e  on, cc_th):  # n
+00010880: 6f71 613a 2046 3831 310a 2020 2020 2222  oqa: F811.    ""
+00010890: 220a 2020 2020 7468 6973 2069 7320 6120  ".    this is a 
+000108a0: 7365 6c65 6374 6976 6520 7374 6163 6b69  selective stacki
+000108b0: 6e67 2061 6c67 6f72 6974 686d 2064 6576  ng algorithm dev
+000108c0: 656c 6f70 6564 2062 7920 4a61 7265 6420  eloped by Jared 
+000108d0: 4272 7961 6e2f 4b75 7261 6d61 204f 6b75  Bryan/Kurama Oku
+000108e0: 626f 2e0a 0a20 2020 2050 4152 414d 4554  bo...    PARAMET
+000108f0: 4552 533a 0a20 2020 202d 2d2d 2d2d 2d2d  ERS:.    -------
+00010900: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00010910: 2020 2020 6363 5f61 7272 6179 3a20 6e75      cc_array: nu
+00010920: 6d70 792e 6e64 6172 7261 7920 636f 6e74  mpy.ndarray cont
+00010930: 6169 6e73 2074 6865 2032 4420 6372 6f73  ains the 2D cros
+00010940: 7320 636f 7272 656c 6174 696f 6e20 6d61  s correlation ma
+00010950: 7472 6978 0a20 2020 2065 7073 696c 6f6e  trix.    epsilon
+00010960: 3a20 7265 7369 6475 616c 2074 6872 6568  : residual threh
+00010970: 6f6c 6420 746f 2071 7569 7420 7468 6520  old to quit the 
+00010980: 6974 6572 6174 696f 6e0a 2020 2020 6363  iteration.    cc
+00010990: 5f74 683a 206e 756d 7079 2e66 6c6f 6174  _th: numpy.float
+000109a0: 2c20 7468 7265 7368 6f6c 6420 6f66 2063  , threshold of c
+000109b0: 6f72 7265 6c61 7469 6f6e 2063 6f65 6666  orrelation coeff
+000109c0: 6963 6965 6e74 2074 6f20 6265 2073 656c  icient to be sel
+000109d0: 6563 7465 640a 0a20 2020 2052 4554 5552  ected..    RETUR
+000109e0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+000109f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+00010a00: 2020 206e 6577 7374 6163 6b3a 206e 756d     newstack: num
+00010a10: 7079 2076 6563 746f 7220 636f 6e74 6169  py vector contai
+00010a20: 6e73 2074 6865 2073 7461 636b 6564 2063  ns the stacked c
+00010a30: 726f 7373 2063 6f72 7265 6c61 7469 6f6e  ross correlation
+00010a40: 0a20 2020 206e 7374 6570 3a20 6e70 2e69  .    nstep: np.i
+00010a50: 6e74 2c20 746f 7461 6c20 6e75 6d62 6572  nt, total number
+00010a60: 206f 6620 6974 6572 6174 696f 6e73 2066   of iterations f
+00010a70: 6f72 2074 6865 2073 7461 636b 696e 670a  or the stacking.
+00010a80: 0a20 2020 204f 7269 6769 6e61 6c6c 7920  .    Originally 
+00010a90: 7269 7474 656e 2062 7920 4d61 7269 6e65  ritten by Marine
+00010aa0: 2044 656e 6f6c 6c65 0a20 2020 204d 6f64   Denolle.    Mod
+00010ab0: 6966 6965 6420 6279 2043 6865 6e67 7869  ified by Chengxi
+00010ac0: 6e20 4a69 616e 6720 4048 6172 7661 7264  n Jiang @Harvard
+00010ad0: 2028 4f63 7432 3032 3029 0a20 2020 2022   (Oct2020).    "
+00010ae0: 2222 0a20 2020 2069 6620 6363 5f61 7272  "".    if cc_arr
+00010af0: 6179 2e6e 6469 6d20 3d3d 2031 3a0a 2020  ay.ndim == 1:.  
+00010b00: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+00010b10: 7567 2822 3244 206d 6174 7269 7820 6973  ug("2D matrix is
+00010b20: 206e 6565 6465 6420 666f 7220 6e72 6f6f   needed for nroo
+00010b30: 745f 7374 6163 6b22 290a 2020 2020 2020  t_stack").      
+00010b40: 2020 7265 7475 726e 2063 635f 6172 7261    return cc_arra
+00010b50: 790a 2020 2020 4e2c 204d 203d 2063 635f  y.    N, M = cc_
+00010b60: 6172 7261 792e 7368 6170 650a 0a20 2020  array.shape..   
+00010b70: 2072 6573 203d 2039 6539 2020 2320 7265   res = 9e9  # re
+00010b80: 7369 6475 616c 730a 2020 2020 636f 6620  siduals.    cof 
+00010b90: 3d20 6e70 2e7a 6572 6f73 284e 2c20 6474  = np.zeros(N, dt
+00010ba0: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+00010bb0: 2020 2020 6e65 7773 7461 636b 203d 206e      newstack = n
+00010bc0: 702e 6d65 616e 2863 635f 6172 7261 792c  p.mean(cc_array,
+00010bd0: 2061 7869 733d 3029 0a0a 2020 2020 6e73   axis=0)..    ns
+00010be0: 7465 7020 3d20 300a 2020 2020 2320 7374  tep = 0.    # st
+00010bf0: 6172 7420 6974 6572 6174 696f 6e0a 2020  art iteration.  
+00010c00: 2020 7768 696c 6520 7265 7320 3e20 6570    while res > ep
+00010c10: 7369 6c6f 6e3a 0a20 2020 2020 2020 2066  silon:.        f
+00010c20: 6f72 2069 6920 696e 2072 616e 6765 284e  or ii in range(N
+00010c30: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+00010c40: 6f66 5b69 695d 203d 206e 702e 636f 7272  of[ii] = np.corr
+00010c50: 636f 6566 286e 6577 7374 6163 6b2c 2063  coef(newstack, c
+00010c60: 635f 6172 7261 795b 6969 2c20 3a5d 295b  c_array[ii, :])[
+00010c70: 302c 2031 5d0a 0a20 2020 2020 2020 2023  0, 1]..        #
+00010c80: 2066 696e 6420 676f 6f64 2077 6176 6566   find good wavef
+00010c90: 6f72 6d73 0a20 2020 2020 2020 2069 6e64  orms.        ind
+00010ca0: 7820 3d20 6e70 2e77 6865 7265 2863 6f66  x = np.where(cof
+00010cb0: 203e 3d20 6363 5f74 6829 5b30 5d0a 2020   >= cc_th)[0].  
+00010cc0: 2020 2020 2020 6966 206e 6f74 206c 656e        if not len
+00010cd0: 2869 6e64 7829 3a0a 2020 2020 2020 2020  (indx):.        
+00010ce0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00010cf0: 7272 6f72 2822 6361 6e6e 6f74 2066 696e  rror("cannot fin
+00010d00: 6420 676f 6f64 2077 6176 6566 6f72 6d73  d good waveforms
+00010d10: 2069 6e73 6964 6520 7365 6c65 6374 6976   inside selectiv
+00010d20: 6520 7374 6163 6b69 6e67 2229 0a20 2020  e stacking").   
+00010d30: 2020 2020 206f 6c64 7374 6163 6b20 3d20       oldstack = 
+00010d40: 6e65 7773 7461 636b 0a20 2020 2020 2020  newstack.       
+00010d50: 206e 6577 7374 6163 6b20 3d20 6e70 2e6d   newstack = np.m
+00010d60: 6561 6e28 6363 5f61 7272 6179 5b69 6e64  ean(cc_array[ind
+00010d70: 785d 2c20 6178 6973 3d30 290a 2020 2020  x], axis=0).    
+00010d80: 2020 2020 7265 7320 3d20 6e70 2e6c 696e      res = np.lin
+00010d90: 616c 672e 6e6f 726d 286e 6577 7374 6163  alg.norm(newstac
+00010da0: 6b20 2d20 6f6c 6473 7461 636b 2920 2f20  k - oldstack) / 
+00010db0: 286e 702e 6c69 6e61 6c67 2e6e 6f72 6d28  (np.linalg.norm(
+00010dc0: 6e65 7773 7461 636b 2920 2a20 4d29 0a20  newstack) * M). 
+00010dd0: 2020 2020 2020 206e 7374 6570 202b 3d20         nstep += 
+00010de0: 310a 0a20 2020 2072 6574 7572 6e20 6e65  1..    return ne
+00010df0: 7773 7461 636b 2c20 6e73 7465 700a 0a0a  wstack, nstep...
+00010e00: 6465 6620 6765 745f 6363 2873 312c 2073  def get_cc(s1, s
+00010e10: 5f72 6566 293a 0a20 2020 2023 2072 6574  _ref):.    # ret
+00010e20: 7572 6e73 2074 6865 2063 6f72 7265 6c61  urns the correla
+00010e30: 7469 6f6e 2063 6f65 6666 6963 6965 6e74  tion coefficient
+00010e40: 2062 6574 7765 656e 2077 6176 6566 6f72   between wavefor
+00010e50: 6d73 2069 6e20 7331 2061 6761 696e 7374  ms in s1 against
+00010e60: 2072 6566 6572 656e 6365 0a20 2020 2023   reference.    #
+00010e70: 2077 6176 6566 6f72 6d20 735f 7265 662e   waveform s_ref.
+00010e80: 0a20 2020 2023 0a20 2020 2063 6320 3d20  .    #.    cc = 
+00010e90: 6e70 2e7a 6572 6f73 2873 312e 7368 6170  np.zeros(s1.shap
+00010ea0: 655b 305d 290a 2020 2020 735f 7265 665f  e[0]).    s_ref_
+00010eb0: 6e6f 726d 203d 206e 702e 6c69 6e61 6c67  norm = np.linalg
+00010ec0: 2e6e 6f72 6d28 735f 7265 6629 0a20 2020  .norm(s_ref).   
+00010ed0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00010ee0: 7331 2e73 6861 7065 5b30 5d29 3a0a 2020  s1.shape[0]):.  
+00010ef0: 2020 2020 2020 6363 5b69 5d20 3d20 6e70        cc[i] = np
+00010f00: 2e73 756d 286e 702e 6d75 6c74 6970 6c79  .sum(np.multiply
+00010f10: 2873 315b 692c 203a 5d2c 2073 5f72 6566  (s1[i, :], s_ref
+00010f20: 2929 202f 206e 702e 6c69 6e61 6c67 2e6e  )) / np.linalg.n
+00010f30: 6f72 6d28 7331 5b69 2c20 3a5d 2920 2f20  orm(s1[i, :]) / 
+00010f40: 735f 7265 665f 6e6f 726d 0a20 2020 2072  s_ref_norm.    r
+00010f50: 6574 7572 6e20 6363 0a0a 0a23 2323 2323  eturn cc...#####
+00010f60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010f70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010f80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010f90: 2323 230a 2323 2323 2323 2323 2323 2323  ###.############
+00010fa0: 2323 2323 204d 4f4e 4954 4f52 494e 4720  #### MONITORING 
+00010fb0: 4655 4e43 5449 4f4e 5320 2323 2323 2323  FUNCTIONS ######
+00010fc0: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
+00010fd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010fe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00010ff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011000: 2323 2323 230a 0a22 2222 0a61 2063 6f6d  #####..""".a com
+00011010: 7069 6c61 7469 6f6e 206f 6620 616c 6c20  pilation of all 
+00011020: 6176 6169 6c61 626c 6520 636f 7265 2066  available core f
+00011030: 756e 6374 696f 6e73 2066 6f72 2063 6f6d  unctions for com
+00011040: 7075 7469 6e67 2070 6861 7365 2064 656c  puting phase del
+00011050: 6179 7320 6261 7365 6420 6f6e 2061 6d62  ays based on amb
+00011060: 6965 6e74 206e 6f69 7365 2069 6e74 6572  ient noise inter
+00011070: 6665 726f 6d65 7472 790a 0a71 7569 636b  ferometry..quick
+00011080: 2069 6e64 6578 206f 6620 6476 2f76 206d   index of dv/v m
+00011090: 6574 686f 6473 3a0a 3129 2073 7472 6574  ethods:.1) stret
+000110a0: 6368 696e 6720 2874 696d 6520 7374 7265  ching (time stre
+000110b0: 7463 6869 6e67 3b20 5765 6176 6572 2065  tching; Weaver e
+000110c0: 7420 616c 2028 3230 3131 2929 0a32 2920  t al (2011)).2) 
+000110d0: 6474 775f 6476 7620 2844 796e 616d 6963  dtw_dvv (Dynamic
+000110e0: 2054 696d 6520 5761 7270 696e 673b 204d   Time Warping; M
+000110f0: 696b 6573 656c 6c20 6574 2061 6c2e 2032  ikesell et al. 2
+00011100: 3031 3529 0a33 2920 6d77 6373 5f64 7676  015).3) mwcs_dvv
+00011110: 2028 4d6f 7669 6e67 2057 696e 646f 7720   (Moving Window 
+00011120: 4372 6f73 7320 5370 6563 7472 756d 3b20  Cross Spectrum; 
+00011130: 436c 6172 6b20 6574 2061 6c2e 2c20 3230  Clark et al., 20
+00011140: 3131 290a 3429 206d 7763 635f 6476 7620  11).4) mwcc_dvv 
+00011150: 284d 6f76 696e 6720 5769 6e64 6f77 2043  (Moving Window C
+00011160: 726f 7373 2043 6f72 7265 6c61 7469 6f6e  ross Correlation
+00011170: 3b20 536e 6965 6465 7220 6574 2061 6c2e  ; Snieder et al.
+00011180: 2c20 3230 3132 290a 3529 2077 7473 5f64  , 2012).5) wts_d
+00011190: 7676 2028 5761 7665 6c65 7420 5374 7265  vv (Wavelet Stre
+000111a0: 6368 696e 673b 2059 7561 6e20 6574 2061  ching; Yuan et a
+000111b0: 6c2e 2c20 696e 2070 7265 7029 0a36 2920  l., in prep).6) 
+000111c0: 7778 735f 6476 7620 2857 6176 656c 6574  wxs_dvv (Wavelet
+000111d0: 2058 726f 7373 2053 7065 6374 7275 6d3b   Xross Spectrum;
+000111e0: 204d 616f 2065 7420 616c 2e2c 2032 3031   Mao et al., 201
+000111f0: 3929 0a37 2920 7764 775f 6476 7620 2857  9).7) wdw_dvv (W
+00011200: 6176 656c 6574 2044 796e 616d 6963 2057  avelet Dynamic W
+00011210: 6172 7069 6e67 3b20 5975 616e 2065 7420  arping; Yuan et 
+00011220: 616c 2e2c 2069 6e20 7072 6570 290a 2222  al., in prep).""
+00011230: 220a 0a0a 6465 6620 7374 7265 7463 6869  "...def stretchi
+00011240: 6e67 2872 6566 2c20 6375 722c 2064 765f  ng(ref, cur, dv_
+00011250: 7261 6e67 652c 206e 6274 7269 616c 2c20  range, nbtrial, 
+00011260: 7061 7261 293a 0a20 2020 2022 2222 0a20  para):.    """. 
+00011270: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+00011280: 2063 6f6d 7061 7265 7320 7468 6520 5265   compares the Re
+00011290: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
+000112a0: 2074 6f20 7374 7265 7463 6865 642f 636f   to stretched/co
+000112b0: 6d70 7265 7373 6564 2063 7572 7265 6e74  mpressed current
+000112c0: 2077 6176 6566 6f72 6d73 2074 6f20 6765   waveforms to ge
+000112d0: 7420 7468 650a 2020 2020 7265 6c61 7469  t the.    relati
+000112e0: 7665 2073 6569 736d 6963 2076 656c 6f63  ve seismic veloc
+000112f0: 6974 7920 7661 7269 6174 696f 6e20 2861  ity variation (a
+00011300: 6e64 2061 7373 6f63 6961 7465 6420 6572  nd associated er
+00011310: 726f 7229 2e0a 2020 2020 4974 2061 6c73  ror)..    It als
+00011320: 6f20 636f 6d70 7574 6573 2074 6865 2063  o computes the c
+00011330: 6f72 7265 6c61 7469 6f6e 2063 6f65 6666  orrelation coeff
+00011340: 6963 6965 6e74 2062 6574 7765 656e 2074  icient between t
+00011350: 6865 2052 6566 6572 656e 6365 2077 6176  he Reference wav
+00011360: 6566 6f72 6d20 616e 6420 7468 6520 6375  eform and the cu
+00011370: 7272 656e 7420 7761 7665 666f 726d 2e0a  rrent waveform..
+00011380: 0a20 2020 2050 4152 414d 4554 4552 533a  .    PARAMETERS:
+00011390: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+000113a0: 2d2d 2d2d 2d0a 2020 2020 7265 663a 2052  -----.    ref: R
+000113b0: 6566 6572 656e 6365 2077 6176 6566 6f72  eference wavefor
+000113c0: 6d20 286e 702e 6e64 6172 7261 792c 2073  m (np.ndarray, s
+000113d0: 697a 6520 4e29 0a20 2020 2063 7572 3a20  ize N).    cur: 
+000113e0: 4375 7272 656e 7420 7761 7665 666f 726d  Current waveform
+000113f0: 2028 6e70 2e6e 6461 7272 6179 2c20 7369   (np.ndarray, si
+00011400: 7a65 204e 290a 2020 2020 6476 5f72 616e  ze N).    dv_ran
+00011410: 6765 3a20 6162 736f 6c75 7465 2062 6f75  ge: absolute bou
+00011420: 6e64 2066 6f72 2074 6865 2076 656c 6f63  nd for the veloc
+00011430: 6974 7920 7661 7269 6174 696f 6e3b 2065  ity variation; e
+00011440: 7861 6d70 6c65 3a20 6476 3d30 2e30 3320  xample: dv=0.03 
+00011450: 666f 7220 5b2d 332c 335d 250a 2020 2020  for [-3,3]%.    
+00011460: 6f66 2072 656c 6174 6976 6520 7665 6c6f  of relative velo
+00011470: 6369 7479 2063 6861 6e67 6520 2827 666c  city change ('fl
+00011480: 6f61 7427 290a 2020 2020 6e62 7472 6961  oat').    nbtria
+00011490: 6c3a 206e 756d 6265 7220 6f66 2073 7472  l: number of str
+000114a0: 6574 6368 696e 6720 636f 6566 6669 6369  etching coeffici
+000114b0: 656e 7420 6265 7477 6565 6e20 6476 6d69  ent between dvmi
+000114c0: 6e20 616e 6420 6476 6d61 782c 206e 6f20  n and dvmax, no 
+000114d0: 6e65 6564 2074 6f20 6265 2068 6967 6865  need to be highe
+000114e0: 7220 7468 616e 2031 3030 2020 2827 666c  r than 100  ('fl
+000114f0: 6f61 7427 290a 2020 2020 7061 7261 3a20  oat').    para: 
+00011500: 7665 6374 6f72 206f 6620 7468 6520 696e  vector of the in
+00011510: 6469 6365 7320 6f66 2074 6865 2063 7572  dices of the cur
+00011520: 2061 6e64 2072 6566 2077 696e 646f 7773   and ref windows
+00011530: 206f 6e20 7769 6368 2079 6f75 2077 616e   on wich you wan
+00011540: 7420 746f 2064 6f20 7468 6520 6d65 6173  t to do the meas
+00011550: 7572 656d 656e 7473 0a20 2020 2028 6e70  urements.    (np
+00011560: 2e6e 6461 7272 6179 2c20 7369 7a65 2074  .ndarray, size t
+00011570: 6d69 6e2a 6465 6c74 613a 746d 6178 2a64  min*delta:tmax*d
+00011580: 656c 7461 290a 2020 2020 466f 7220 6572  elta).    For er
+00011590: 726f 7220 636f 6d70 7574 6174 696f 6e2c  ror computation,
+000115a0: 2077 6520 6e65 6564 2070 6172 616d 6574   we need paramet
+000115b0: 6572 733a 0a20 2020 2020 2020 2066 6d69  ers:.        fmi
+000115c0: 6e3a 206d 696e 696d 756d 2066 7265 7175  n: minimum frequ
+000115d0: 656e 6379 206f 6620 7468 6520 6461 7461  ency of the data
+000115e0: 0a20 2020 2020 2020 2066 6d61 783a 206d  .        fmax: m
+000115f0: 6178 696d 756d 2066 7265 7175 656e 6379  aximum frequency
+00011600: 206f 6620 7468 6520 6461 7461 0a20 2020   of the data.   
+00011610: 2020 2020 2074 6d69 6e3a 206d 696e 696d       tmin: minim
+00011620: 756d 2074 696d 6520 7769 6e64 6f77 2077  um time window w
+00011630: 6865 7265 2074 6865 2064 762f 7620 6973  here the dv/v is
+00011640: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
+00011650: 2020 746d 6178 3a20 6d61 7869 6d75 6d20    tmax: maximum 
+00011660: 7469 6d65 2077 696e 646f 7720 7768 6572  time window wher
+00011670: 6520 7468 6520 6476 2f76 2069 7320 636f  e the dv/v is co
+00011680: 6d70 7574 6564 0a20 2020 2052 4554 5552  mputed.    RETUR
+00011690: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+000116a0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064 763a  --------.    dv:
+000116b0: 2052 656c 6174 6976 6520 7665 6c6f 6369   Relative veloci
+000116c0: 7479 2063 6861 6e67 6520 6476 2f76 2028  ty change dv/v (
+000116d0: 696e 2025 290a 2020 2020 6363 3a20 636f  in %).    cc: co
+000116e0: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
+000116f0: 6369 656e 7420 6265 7477 6565 6e20 7468  cient between th
+00011700: 6520 7265 6665 7265 6e63 6520 7761 7665  e reference wave
+00011710: 666f 726d 2061 6e64 2074 6865 2062 6573  form and the bes
+00011720: 7420 7374 7265 7463 6865 642f 636f 6d70  t stretched/comp
+00011730: 7265 7373 6564 2063 7572 7265 6e74 2077  ressed current w
+00011740: 6176 6566 6f72 6d0a 2020 2020 6364 703a  aveform.    cdp:
+00011750: 2063 6f72 7265 6c61 7469 6f6e 2063 6f65   correlation coe
+00011760: 6666 6963 6965 6e74 2062 6574 7765 656e  fficient between
+00011770: 2074 6865 2072 6566 6572 656e 6365 2077   the reference w
+00011780: 6176 6566 6f72 6d20 616e 6420 7468 6520  aveform and the 
+00011790: 696e 6974 6961 6c20 6375 7272 656e 7420  initial current 
+000117a0: 7761 7665 666f 726d 0a20 2020 2065 7272  waveform.    err
+000117b0: 6f72 3a20 4572 726f 7273 2069 6e20 7468  or: Errors in th
+000117c0: 6520 6476 2f76 206d 6561 7375 7265 6d65  e dv/v measureme
+000117d0: 6e74 7320 6261 7365 6420 6f6e 2057 6561  nts based on Wea
+000117e0: 7665 7220 6574 2061 6c20 2832 3031 3129  ver et al (2011)
+000117f0: 2c0a 2020 2020 4f6e 2074 6865 2070 7265  ,.    On the pre
+00011800: 6369 7369 6f6e 206f 6620 6e6f 6973 652d  cision of noise-
+00011810: 636f 7272 656c 6174 696f 6e20 696e 7465  correlation inte
+00011820: 7266 6572 6f6d 6574 7279 2c20 4765 6f70  rferometry, Geop
+00011830: 6879 732e 204a 2e20 496e 742e 2c20 3138  hys. J. Int., 18
+00011840: 3528 3329 0a0a 2020 2020 4e6f 7465 3a20  5(3)..    Note: 
+00011850: 5468 6520 636f 6465 2066 6972 7374 2066  The code first f
+00011860: 696e 6473 2074 6865 2062 6573 7420 636f  inds the best co
+00011870: 7272 656c 6174 696f 6e20 636f 6566 6669  rrelation coeffi
+00011880: 6369 656e 7420 6265 7477 6565 6e20 7468  cient between th
+00011890: 6520 5265 6665 7265 6e63 6520 7761 7665  e Reference wave
+000118a0: 666f 726d 2061 6e64 0a20 2020 2074 6865  form and.    the
+000118b0: 2073 7472 6574 6368 6564 2f63 6f6d 7072   stretched/compr
+000118c0: 6573 7365 6420 6375 7272 656e 7420 7761  essed current wa
+000118d0: 7665 666f 726d 2061 6d6f 6e67 2074 6865  veform among the
+000118e0: 2022 6e62 7472 6961 6c22 2076 616c 7565   "nbtrial" value
+000118f0: 732e 0a20 2020 2041 2072 6566 696e 6564  s..    A refined
+00011900: 2061 6e61 6c79 7369 7320 6973 2074 6865   analysis is the
+00011910: 6e20 7065 7266 6f72 6d65 6420 6172 6f75  n performed arou
+00011920: 6e64 2074 6869 7320 7661 6c75 6520 746f  nd this value to
+00011930: 206f 6274 6169 6e20 6120 6d6f 7265 2070   obtain a more p
+00011940: 7265 6369 7365 2064 762f 7620 6d65 6173  recise dv/v meas
+00011950: 7572 656d 656e 7420 2e0a 0a20 2020 204f  urement ...    O
+00011960: 7269 6769 6e61 6c6c 7920 6279 204c 2e20  riginally by L. 
+00011970: 5669 656e 7320 3034 2f32 362f 3230 3138  Viens 04/26/2018
+00011980: 2028 5669 656e 7320 6574 2061 6c2e 2c20   (Viens et al., 
+00011990: 3230 3138 204a 4752 290a 2020 2020 6d6f  2018 JGR).    mo
+000119a0: 6469 6669 6564 2062 7920 4368 656e 6778  dified by Chengx
+000119b0: 696e 204a 6961 6e67 0a20 2020 2022 2222  in Jiang.    """
+000119c0: 0a20 2020 2023 206c 6f61 6420 636f 6d6d  .    # load comm
+000119d0: 6f6e 2076 6172 6961 626c 6573 2066 726f  on variables fro
+000119e0: 6d20 6469 6374 696f 6e61 7279 0a20 2020  m dictionary.   
+000119f0: 2074 7769 6e20 3d20 7061 7261 5b22 7477   twin = para["tw
+00011a00: 696e 225d 0a20 2020 2066 7265 7120 3d20  in"].    freq = 
+00011a10: 7061 7261 5b22 6672 6571 225d 0a20 2020  para["freq"].   
+00011a20: 2064 7420 3d20 7061 7261 5b22 6474 225d   dt = para["dt"]
+00011a30: 0a20 2020 2074 6d69 6e20 3d20 6e70 2e6d  .    tmin = np.m
+00011a40: 696e 2874 7769 6e29 0a20 2020 2074 6d61  in(twin).    tma
+00011a50: 7820 3d20 6e70 2e6d 6178 2874 7769 6e29  x = np.max(twin)
+00011a60: 0a20 2020 2066 6d69 6e20 3d20 6e70 2e6d  .    fmin = np.m
+00011a70: 696e 2866 7265 7129 0a20 2020 2066 6d61  in(freq).    fma
+00011a80: 7820 3d20 6e70 2e6d 6178 2866 7265 7129  x = np.max(freq)
+00011a90: 0a20 2020 2074 7665 6320 3d20 6e70 2e61  .    tvec = np.a
+00011aa0: 7261 6e67 6528 746d 696e 2c20 746d 6178  range(tmin, tmax
+00011ab0: 2c20 6474 290a 0a20 2020 2023 206d 616b  , dt)..    # mak
+00011ac0: 6520 7573 6566 756c 206f 6e65 2066 6f72  e useful one for
+00011ad0: 206d 6561 7375 7265 6d65 6e74 730a 2020   measurements.  
+00011ae0: 2020 6476 6d69 6e20 3d20 2d6e 702e 6162    dvmin = -np.ab
+00011af0: 7328 6476 5f72 616e 6765 290a 2020 2020  s(dv_range).    
+00011b00: 6476 6d61 7820 3d20 6e70 2e61 6273 2864  dvmax = np.abs(d
+00011b10: 765f 7261 6e67 6529 0a20 2020 2045 7073  v_range).    Eps
+00011b20: 203d 2031 202b 2028 6e70 2e6c 696e 7370   = 1 + (np.linsp
+00011b30: 6163 6528 6476 6d69 6e2c 2064 766d 6178  ace(dvmin, dvmax
+00011b40: 2c20 6e62 7472 6961 6c29 290a 2020 2020  , nbtrial)).    
+00011b50: 636f 6620 3d20 6e70 2e7a 6572 6f73 2845  cof = np.zeros(E
+00011b60: 7073 2e73 6861 7065 2c20 6474 7970 653d  ps.shape, dtype=
+00011b70: 6e70 2e66 6c6f 6174 3332 290a 0a20 2020  np.float32)..   
+00011b80: 2023 2053 6574 206f 6620 7374 7265 7463   # Set of stretc
+00011b90: 6865 642f 636f 6d70 7265 7373 6564 2063  hed/compressed c
+00011ba0: 7572 7265 6e74 2077 6176 6566 6f72 6d73  urrent waveforms
+00011bb0: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
+00011bc0: 616e 6765 286c 656e 2845 7073 2929 3a0a  ange(len(Eps)):.
+00011bd0: 2020 2020 2020 2020 6e74 203d 2074 7665          nt = tve
+00011be0: 6320 2a20 4570 735b 6969 5d0a 2020 2020  c * Eps[ii].    
+00011bf0: 2020 2020 7320 3d20 6e70 2e69 6e74 6572      s = np.inter
+00011c00: 7028 783d 7476 6563 2c20 7870 3d6e 742c  p(x=tvec, xp=nt,
+00011c10: 2066 703d 6375 7229 0a20 2020 2020 2020   fp=cur).       
+00011c20: 2077 6176 6566 6f72 6d5f 7265 6620 3d20   waveform_ref = 
+00011c30: 7265 660a 2020 2020 2020 2020 7761 7665  ref.        wave
+00011c40: 666f 726d 5f63 7572 203d 2073 0a20 2020  form_cur = s.   
+00011c50: 2020 2020 2063 6f66 5b69 695d 203d 206e       cof[ii] = n
+00011c60: 702e 636f 7272 636f 6566 2877 6176 6566  p.corrcoef(wavef
+00011c70: 6f72 6d5f 7265 662c 2077 6176 6566 6f72  orm_ref, wavefor
+00011c80: 6d5f 6375 7229 5b30 2c20 315d 0a0a 2020  m_cur)[0, 1]..  
+00011c90: 2020 6364 7020 3d20 6e70 2e63 6f72 7263    cdp = np.corrc
+00011ca0: 6f65 6628 6375 722c 2072 6566 295b 302c  oef(cur, ref)[0,
+00011cb0: 2031 5d20 2023 2063 6f72 7265 6c61 7469   1]  # correlati
+00011cc0: 6f6e 2063 6f65 6666 6963 6965 6e74 2062  on coefficient b
+00011cd0: 6574 7765 656e 2074 6865 2072 6566 6572  etween the refer
+00011ce0: 656e 6365 2061 6e64 2069 6e69 7469 616c  ence and initial
+00011cf0: 2063 7572 7265 6e74 2077 6176 6566 6f72   current wavefor
+00011d00: 6d73 0a0a 2020 2020 2320 6669 6e64 2074  ms..    # find t
+00011d10: 6865 206d 6178 696d 756d 2063 6f72 7265  he maximum corre
+00011d20: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
+00011d30: 6e74 0a20 2020 2069 6d61 7820 3d20 6e70  nt.    imax = np
+00011d40: 2e6e 616e 6172 676d 6178 2863 6f66 290a  .nanargmax(cof).
+00011d50: 2020 2020 6966 2069 6d61 7820 3e3d 206c      if imax >= l
+00011d60: 656e 2845 7073 2920 2d20 323a 0a20 2020  en(Eps) - 2:.   
+00011d70: 2020 2020 2069 6d61 7820 3d20 696d 6178       imax = imax
+00011d80: 202d 2032 0a20 2020 2069 6620 696d 6178   - 2.    if imax
+00011d90: 203c 3d20 323a 0a20 2020 2020 2020 2069   <= 2:.        i
+00011da0: 6d61 7820 3d20 696d 6178 202b 2032 0a0a  max = imax + 2..
+00011db0: 2020 2020 2320 5072 6f63 6565 6420 746f      # Proceed to
+00011dc0: 2074 6865 2073 6563 6f6e 6420 7374 6570   the second step
+00011dd0: 2074 6f20 6765 7420 6120 6d6f 7265 2070   to get a more p
+00011de0: 7265 6369 7365 2064 762f 7620 6d65 6173  recise dv/v meas
+00011df0: 7572 656d 656e 740a 2020 2020 6474 6669  urement.    dtfi
+00011e00: 6e65 7220 3d20 6e70 2e6c 696e 7370 6163  ner = np.linspac
+00011e10: 6528 4570 735b 696d 6178 202d 2032 5d2c  e(Eps[imax - 2],
+00011e20: 2045 7073 5b69 6d61 7820 2b20 325d 2c20   Eps[imax + 2], 
+00011e30: 3130 3029 0a20 2020 206e 636f 6620 3d20  100).    ncof = 
+00011e40: 6e70 2e7a 6572 6f73 2864 7466 696e 6572  np.zeros(dtfiner
+00011e50: 2e73 6861 7065 2c20 6474 7970 653d 6e70  .shape, dtype=np
+00011e60: 2e66 6c6f 6174 3332 290a 2020 2020 666f  .float32).    fo
+00011e70: 7220 6969 2069 6e20 7261 6e67 6528 6c65  r ii in range(le
+00011e80: 6e28 6474 6669 6e65 7229 293a 0a20 2020  n(dtfiner)):.   
+00011e90: 2020 2020 206e 7420 3d20 7476 6563 202a       nt = tvec *
+00011ea0: 2064 7466 696e 6572 5b69 695d 0a20 2020   dtfiner[ii].   
+00011eb0: 2020 2020 2073 203d 206e 702e 696e 7465       s = np.inte
+00011ec0: 7270 2878 3d74 7665 632c 2078 703d 6e74  rp(x=tvec, xp=nt
+00011ed0: 2c20 6670 3d63 7572 290a 2020 2020 2020  , fp=cur).      
+00011ee0: 2020 7761 7665 666f 726d 5f72 6566 203d    waveform_ref =
+00011ef0: 2072 6566 0a20 2020 2020 2020 2077 6176   ref.        wav
+00011f00: 6566 6f72 6d5f 6375 7220 3d20 730a 2020  eform_cur = s.  
+00011f10: 2020 2020 2020 6e63 6f66 5b69 695d 203d        ncof[ii] =
+00011f20: 206e 702e 636f 7272 636f 6566 2877 6176   np.corrcoef(wav
+00011f30: 6566 6f72 6d5f 7265 662c 2077 6176 6566  eform_ref, wavef
+00011f40: 6f72 6d5f 6375 7229 5b30 2c20 315d 0a0a  orm_cur)[0, 1]..
+00011f50: 2020 2020 6363 203d 206e 702e 6d61 7828      cc = np.max(
+00011f60: 6e63 6f66 2920 2023 2046 696e 6420 6d61  ncof)  # Find ma
+00011f70: 7869 6d75 6d20 636f 7272 656c 6174 696f  ximum correlatio
+00011f80: 6e20 636f 6566 6669 6369 656e 7420 6f66  n coefficient of
+00011f90: 2074 6865 2072 6566 696e 6564 2020 616e   the refined  an
+00011fa0: 616c 7973 6973 0a20 2020 2064 7620 3d20  alysis.    dv = 
+00011fb0: 3130 302e 3020 2a20 6474 6669 6e65 725b  100.0 * dtfiner[
+00011fc0: 6e70 2e61 7267 6d61 7828 6e63 6f66 295d  np.argmax(ncof)]
+00011fd0: 202d 2031 3030 2020 2320 4d75 6c74 6970   - 100  # Multip
+00011fe0: 6c79 2062 7920 3130 3020 746f 2063 6f6e  ly by 100 to con
+00011ff0: 7665 7274 2074 6f20 7065 7263 656e 7461  vert to percenta
+00012000: 6765 2028 4570 7369 6c6f 6e20 3d20 2d64  ge (Epsilon = -d
+00012010: 742f 7420 3d20 6476 2f76 290a 0a20 2020  t/t = dv/v)..   
+00012020: 2023 2045 7272 6f72 2063 6f6d 7075 7461   # Error computa
+00012030: 7469 6f6e 2062 6173 6564 206f 6e20 5765  tion based on We
+00012040: 6176 6572 2065 7420 616c 2028 3230 3131  aver et al (2011
+00012050: 292c 204f 6e20 7468 6520 7072 6563 6973  ), On the precis
+00012060: 696f 6e20 6f66 206e 6f69 7365 2d63 6f72  ion of noise-cor
+00012070: 7265 6c61 7469 6f6e 0a20 2020 2023 2069  relation.    # i
+00012080: 6e74 6572 6665 726f 6d65 7472 792c 2047  nterferometry, G
+00012090: 656f 7068 7973 2e20 4a2e 2049 6e74 2e2c  eophys. J. Int.,
+000120a0: 2031 3835 2833 290a 2020 2020 5420 3d20   185(3).    T = 
+000120b0: 3120 2f20 2866 6d61 7820 2d20 666d 696e  1 / (fmax - fmin
+000120c0: 290a 2020 2020 5820 3d20 6363 0a20 2020  ).    X = cc.   
+000120d0: 2077 6320 3d20 6e70 2e70 6920 2a20 2866   wc = np.pi * (f
+000120e0: 6d69 6e20 2b20 666d 6178 290a 2020 2020  min + fmax).    
+000120f0: 7431 203d 206e 702e 6d69 6e28 5b74 6d69  t1 = np.min([tmi
+00012100: 6e2c 2074 6d61 785d 290a 2020 2020 7432  n, tmax]).    t2
+00012110: 203d 206e 702e 6d61 7828 5b74 6d69 6e2c   = np.max([tmin,
+00012120: 2074 6d61 785d 290a 2020 2020 6572 726f   tmax]).    erro
+00012130: 7220 3d20 3130 3020 2a20 280a 2020 2020  r = 100 * (.    
+00012140: 2020 2020 6e70 2e73 7172 7428 3120 2d20      np.sqrt(1 - 
+00012150: 582a 2a32 2920 2f20 2832 202a 2058 2920  X**2) / (2 * X) 
+00012160: 2a20 6e70 2e73 7172 7428 2836 202a 206e  * np.sqrt((6 * n
+00012170: 702e 7371 7274 286e 702e 7069 202f 2032  p.sqrt(np.pi / 2
+00012180: 2920 2a20 5429 202f 2028 7763 2a2a 3220  ) * T) / (wc**2 
+00012190: 2a20 2874 322a 2a33 202d 2074 312a 2a33  * (t2**3 - t1**3
+000121a0: 2929 290a 2020 2020 290a 0a20 2020 2072  ))).    )..    r
+000121b0: 6574 7572 6e20 6476 2c20 6572 726f 722c  eturn dv, error,
+000121c0: 2063 632c 2063 6470 0a0a 0a64 6566 2073   cc, cdp...def s
+000121d0: 7472 6574 6368 696e 675f 7665 6374 2872  tretching_vect(r
+000121e0: 6566 2c20 6375 722c 2064 765f 7261 6e67  ef, cur, dv_rang
+000121f0: 652c 206e 6274 7269 616c 2c20 7061 7261  e, nbtrial, para
+00012200: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
+00012210: 6869 7320 6675 6e63 7469 6f6e 2063 6f6d  his function com
+00012220: 7061 7265 7320 7468 6520 5265 6665 7265  pares the Refere
+00012230: 6e63 6520 7761 7665 666f 726d 2074 6f20  nce waveform to 
+00012240: 7374 7265 7463 6865 642f 636f 6d70 7265  stretched/compre
+00012250: 7373 6564 2063 7572 7265 6e74 2077 6176  ssed current wav
+00012260: 6566 6f72 6d73 0a20 2020 2074 6f20 6765  eforms.    to ge
+00012270: 7420 7468 6520 7265 6c61 7469 7665 2073  t the relative s
+00012280: 6569 736d 6963 2076 656c 6f63 6974 7920  eismic velocity 
+00012290: 7661 7269 6174 696f 6e20 2861 6e64 2061  variation (and a
+000122a0: 7373 6f63 6961 7465 6420 6572 726f 7229  ssociated error)
+000122b0: 2e0a 2020 2020 4974 2061 6c73 6f20 636f  ..    It also co
+000122c0: 6d70 7574 6573 2074 6865 2063 6f72 7265  mputes the corre
+000122d0: 6c61 7469 6f6e 2063 6f65 6666 6963 6965  lation coefficie
+000122e0: 6e74 2062 6574 7765 656e 2074 6865 2052  nt between the R
+000122f0: 6566 6572 656e 6365 2077 6176 6566 6f72  eference wavefor
+00012300: 6d20 616e 6420 7468 6520 6375 7272 656e  m and the curren
+00012310: 7420 7761 7665 666f 726d 2e0a 0a20 2020  t waveform...   
+00012320: 2050 4152 414d 4554 4552 533a 0a20 2020   PARAMETERS:.   
+00012330: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00012340: 2d0a 2020 2020 7265 663a 2052 6566 6572  -.    ref: Refer
+00012350: 656e 6365 2077 6176 6566 6f72 6d20 286e  ence waveform (n
+00012360: 702e 6e64 6172 7261 792c 2073 697a 6520  p.ndarray, size 
+00012370: 4e29 0a20 2020 2063 7572 3a20 4375 7272  N).    cur: Curr
+00012380: 656e 7420 7761 7665 666f 726d 2028 6e70  ent waveform (np
+00012390: 2e6e 6461 7272 6179 2c20 7369 7a65 204e  .ndarray, size N
+000123a0: 290a 2020 2020 6476 5f72 616e 6765 3a20  ).    dv_range: 
+000123b0: 6162 736f 6c75 7465 2062 6f75 6e64 2066  absolute bound f
+000123c0: 6f72 2074 6865 2076 656c 6f63 6974 7920  or the velocity 
+000123d0: 7661 7269 6174 696f 6e3b 2065 7861 6d70  variation; examp
+000123e0: 6c65 3a20 6476 3d30 2e30 3320 666f 7220  le: dv=0.03 for 
+000123f0: 5b2d 332c 335d 250a 2020 2020 6f66 2072  [-3,3]%.    of r
+00012400: 656c 6174 6976 6520 7665 6c6f 6369 7479  elative velocity
+00012410: 2063 6861 6e67 6520 2827 666c 6f61 7427   change ('float'
+00012420: 290a 2020 2020 6e62 7472 6961 6c3a 206e  ).    nbtrial: n
+00012430: 756d 6265 7220 6f66 2073 7472 6574 6368  umber of stretch
+00012440: 696e 6720 636f 6566 6669 6369 656e 7420  ing coefficient 
+00012450: 6265 7477 6565 6e20 6476 6d69 6e20 616e  between dvmin an
+00012460: 6420 6476 6d61 782c 206e 6f20 6e65 6564  d dvmax, no need
+00012470: 2074 6f20 6265 2068 6967 6865 7220 7468   to be higher th
+00012480: 616e 2031 3030 2020 2827 666c 6f61 7427  an 100  ('float'
+00012490: 290a 2020 2020 7061 7261 3a20 7665 6374  ).    para: vect
+000124a0: 6f72 206f 6620 7468 6520 696e 6469 6365  or of the indice
+000124b0: 7320 6f66 2074 6865 2063 7572 2061 6e64  s of the cur and
+000124c0: 2072 6566 2077 696e 646f 7773 206f 6e20   ref windows on 
+000124d0: 7769 6368 2079 6f75 2077 616e 7420 746f  wich you want to
+000124e0: 2064 6f20 7468 650a 2020 2020 6d65 6173   do the.    meas
+000124f0: 7572 656d 656e 7473 2028 6e70 2e6e 6461  urements (np.nda
+00012500: 7272 6179 2c20 7369 7a65 2074 6d69 6e2a  rray, size tmin*
+00012510: 6465 6c74 613a 746d 6178 2a64 656c 7461  delta:tmax*delta
+00012520: 290a 2020 2020 466f 7220 6572 726f 7220  ).    For error 
+00012530: 636f 6d70 7574 6174 696f 6e2c 2077 6520  computation, we 
+00012540: 6e65 6564 2070 6172 616d 6574 6572 733a  need parameters:
+00012550: 0a20 2020 2020 2020 2066 6d69 6e3a 206d  .        fmin: m
+00012560: 696e 696d 756d 2066 7265 7175 656e 6379  inimum frequency
+00012570: 206f 6620 7468 6520 6461 7461 0a20 2020   of the data.   
+00012580: 2020 2020 2066 6d61 783a 206d 6178 696d       fmax: maxim
+00012590: 756d 2066 7265 7175 656e 6379 206f 6620  um frequency of 
+000125a0: 7468 6520 6461 7461 0a20 2020 2020 2020  the data.       
+000125b0: 2074 6d69 6e3a 206d 696e 696d 756d 2074   tmin: minimum t
+000125c0: 696d 6520 7769 6e64 6f77 2077 6865 7265  ime window where
+000125d0: 2074 6865 2064 762f 7620 6973 2063 6f6d   the dv/v is com
+000125e0: 7075 7465 640a 2020 2020 2020 2020 746d  puted.        tm
+000125f0: 6178 3a20 6d61 7869 6d75 6d20 7469 6d65  ax: maximum time
+00012600: 2077 696e 646f 7720 7768 6572 6520 7468   window where th
+00012610: 6520 6476 2f76 2069 7320 636f 6d70 7574  e dv/v is comput
+00012620: 6564 0a20 2020 2052 4554 5552 4e53 3a0a  ed.    RETURNS:.
+00012630: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+00012640: 2d2d 2d2d 0a20 2020 2064 763a 2052 656c  ----.    dv: Rel
+00012650: 6174 6976 6520 7665 6c6f 6369 7479 2063  ative velocity c
+00012660: 6861 6e67 6520 6476 2f76 2028 696e 2025  hange dv/v (in %
+00012670: 290a 2020 2020 6363 3a20 636f 7272 656c  ).    cc: correl
+00012680: 6174 696f 6e20 636f 6566 6669 6369 656e  ation coefficien
+00012690: 7420 6265 7477 6565 6e20 7468 6520 7265  t between the re
+000126a0: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
+000126b0: 2061 6e64 2074 6865 2062 6573 7420 7374   and the best st
+000126c0: 7265 7463 6865 642f 636f 6d70 7265 7373  retched/compress
+000126d0: 6564 2063 7572 7265 6e74 2077 6176 6566  ed current wavef
+000126e0: 6f72 6d0a 2020 2020 6364 703a 2063 6f72  orm.    cdp: cor
+000126f0: 7265 6c61 7469 6f6e 2063 6f65 6666 6963  relation coeffic
+00012700: 6965 6e74 2062 6574 7765 656e 2074 6865  ient between the
+00012710: 2072 6566 6572 656e 6365 2077 6176 6566   reference wavef
+00012720: 6f72 6d20 616e 6420 7468 6520 696e 6974  orm and the init
+00012730: 6961 6c20 6375 7272 656e 7420 7761 7665  ial current wave
+00012740: 666f 726d 0a20 2020 2065 7272 6f72 3a20  form.    error: 
+00012750: 4572 726f 7273 2069 6e20 7468 6520 6476  Errors in the dv
+00012760: 2f76 206d 6561 7375 7265 6d65 6e74 7320  /v measurements 
+00012770: 6261 7365 6420 6f6e 2057 6561 7665 7220  based on Weaver 
+00012780: 6574 2061 6c20 2832 3031 3129 2c20 4f6e  et al (2011), On
+00012790: 2074 6865 2070 7265 6369 7369 6f6e 0a20   the precision. 
+000127a0: 2020 206f 6620 6e6f 6973 652d 636f 7272     of noise-corr
+000127b0: 656c 6174 696f 6e20 696e 7465 7266 6572  elation interfer
+000127c0: 6f6d 6574 7279 2c20 4765 6f70 6879 732e  ometry, Geophys.
+000127d0: 204a 2e20 496e 742e 2c20 3138 3528 3329   J. Int., 185(3)
+000127e0: 0a0a 2020 2020 4e6f 7465 3a20 5468 6520  ..    Note: The 
+000127f0: 636f 6465 2066 6972 7374 2066 696e 6473  code first finds
+00012800: 2074 6865 2062 6573 7420 636f 7272 656c   the best correl
+00012810: 6174 696f 6e20 636f 6566 6669 6369 656e  ation coefficien
+00012820: 7420 6265 7477 6565 6e20 7468 6520 5265  t between the Re
+00012830: 6665 7265 6e63 6520 7761 7665 666f 726d  ference waveform
+00012840: 2061 6e64 0a20 2020 2074 6865 2073 7472   and.    the str
+00012850: 6574 6368 6564 2f63 6f6d 7072 6573 7365  etched/compresse
+00012860: 6420 6375 7272 656e 7420 7761 7665 666f  d current wavefo
+00012870: 726d 2061 6d6f 6e67 2074 6865 2022 6e62  rm among the "nb
+00012880: 7472 6961 6c22 2076 616c 7565 732e 0a20  trial" values.. 
+00012890: 2020 2041 2072 6566 696e 6564 2061 6e61     A refined ana
+000128a0: 6c79 7369 7320 6973 2074 6865 6e20 7065  lysis is then pe
+000128b0: 7266 6f72 6d65 6420 6172 6f75 6e64 2074  rformed around t
+000128c0: 6869 7320 7661 6c75 6520 746f 206f 6274  his value to obt
+000128d0: 6169 6e20 6120 6d6f 7265 2070 7265 6369  ain a more preci
+000128e0: 7365 2064 762f 7620 6d65 6173 7572 656d  se dv/v measurem
+000128f0: 656e 7420 2e0a 0a20 2020 204f 7269 6769  ent ...    Origi
+00012900: 6e61 6c6c 7920 6279 204c 2e20 5669 656e  nally by L. Vien
+00012910: 7320 3034 2f32 362f 3230 3138 2028 5669  s 04/26/2018 (Vi
+00012920: 656e 7320 6574 2061 6c2e 2c20 3230 3138  ens et al., 2018
+00012930: 204a 4752 290a 2020 2020 6d6f 6469 6669   JGR).    modifi
+00012940: 6564 2062 7920 4368 656e 6778 696e 204a  ed by Chengxin J
+00012950: 6961 6e67 0a20 2020 206d 6f64 6966 6965  iang.    modifie
+00012960: 6420 6279 204c 6175 7261 2045 726d 6572  d by Laura Ermer
+00012970: 743a 2076 6563 746f 7269 7a65 6420 7665  t: vectorized ve
+00012980: 7273 696f 6e0a 2020 2020 2222 220a 2020  rsion.    """.  
+00012990: 2020 2320 6c6f 6164 2063 6f6d 6d6f 6e20    # load common 
+000129a0: 7661 7269 6162 6c65 7320 6672 6f6d 2064  variables from d
+000129b0: 6963 7469 6f6e 6172 790a 2020 2020 7477  ictionary.    tw
+000129c0: 696e 203d 2070 6172 615b 2274 7769 6e22  in = para["twin"
+000129d0: 5d0a 2020 2020 6672 6571 203d 2070 6172  ].    freq = par
+000129e0: 615b 2266 7265 7122 5d0a 2020 2020 6474  a["freq"].    dt
+000129f0: 203d 2070 6172 615b 2264 7422 5d0a 2020   = para["dt"].  
+00012a00: 2020 746d 696e 203d 206e 702e 6d69 6e28    tmin = np.min(
+00012a10: 7477 696e 290a 2020 2020 746d 6178 203d  twin).    tmax =
+00012a20: 206e 702e 6d61 7828 7477 696e 290a 2020   np.max(twin).  
+00012a30: 2020 666d 696e 203d 206e 702e 6d69 6e28    fmin = np.min(
+00012a40: 6672 6571 290a 2020 2020 666d 6178 203d  freq).    fmax =
+00012a50: 206e 702e 6d61 7828 6672 6571 290a 2020   np.max(freq).  
+00012a60: 2020 7476 6563 203d 206e 702e 6172 616e    tvec = np.aran
+00012a70: 6765 2874 6d69 6e2c 2074 6d61 782c 2064  ge(tmin, tmax, d
+00012a80: 7429 0a0a 2020 2020 2320 6d61 6b65 2075  t)..    # make u
+00012a90: 7365 6675 6c20 6f6e 6520 666f 7220 6d65  seful one for me
+00012aa0: 6173 7572 656d 656e 7473 0a20 2020 2064  asurements.    d
+00012ab0: 766d 696e 203d 202d 6e70 2e61 6273 2864  vmin = -np.abs(d
+00012ac0: 765f 7261 6e67 6529 0a20 2020 2064 766d  v_range).    dvm
+00012ad0: 6178 203d 206e 702e 6162 7328 6476 5f72  ax = np.abs(dv_r
+00012ae0: 616e 6765 290a 2020 2020 4570 7320 3d20  ange).    Eps = 
+00012af0: 3120 2b20 286e 702e 6c69 6e73 7061 6365  1 + (np.linspace
+00012b00: 2864 766d 696e 2c20 6476 6d61 782c 206e  (dvmin, dvmax, n
+00012b10: 6274 7269 616c 2929 0a20 2020 2063 6470  btrial)).    cdp
+00012b20: 203d 206e 702e 636f 7272 636f 6566 2863   = np.corrcoef(c
+00012b30: 7572 2c20 7265 6629 5b30 2c20 315d 2020  ur, ref)[0, 1]  
+00012b40: 2320 636f 7272 656c 6174 696f 6e20 636f  # correlation co
+00012b50: 6566 6669 6369 656e 7420 6265 7477 6565  efficient betwee
+00012b60: 6e20 7468 6520 7265 6665 7265 6e63 6520  n the reference 
+00012b70: 616e 6420 696e 6974 6961 6c20 6375 7272  and initial curr
+00012b80: 656e 7420 7761 7665 666f 726d 730a 2020  ent waveforms.  
+00012b90: 2020 7761 7665 666f 726d 7320 3d20 6e70    waveforms = np
+00012ba0: 2e7a 6572 6f73 2828 6e62 7472 6961 6c20  .zeros((nbtrial 
+00012bb0: 2b20 312c 206c 656e 2872 6566 2929 290a  + 1, len(ref))).
+00012bc0: 2020 2020 7761 7665 666f 726d 735b 302c      waveforms[0,
+00012bd0: 203a 5d20 3d20 7265 660a 0a20 2020 2023   :] = ref..    #
+00012be0: 2053 6574 206f 6620 7374 7265 7463 6865   Set of stretche
+00012bf0: 642f 636f 6d70 7265 7373 6564 2063 7572  d/compressed cur
+00012c00: 7265 6e74 2077 6176 6566 6f72 6d73 0a20  rent waveforms. 
+00012c10: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00012c20: 6765 286e 6274 7269 616c 293a 0a20 2020  ge(nbtrial):.   
+00012c30: 2020 2020 206e 7420 3d20 7476 6563 202a       nt = tvec *
+00012c40: 2045 7073 5b69 695d 0a20 2020 2020 2020   Eps[ii].       
+00012c50: 2073 203d 206e 702e 696e 7465 7270 2878   s = np.interp(x
+00012c60: 3d74 7665 632c 2078 703d 6e74 2c20 6670  =tvec, xp=nt, fp
+00012c70: 3d63 7572 290a 2020 2020 2020 2020 7761  =cur).        wa
+00012c80: 7665 666f 726d 735b 6969 202b 2031 2c20  veforms[ii + 1, 
+00012c90: 3a5d 203d 2073 0a20 2020 2063 6f66 203d  :] = s.    cof =
+00012ca0: 206e 702e 636f 7272 636f 6566 2877 6176   np.corrcoef(wav
+00012cb0: 6566 6f72 6d73 295b 305d 5b31 3a5d 0a0a  eforms)[0][1:]..
+00012cc0: 2020 2020 2320 6669 6e64 2074 6865 206d      # find the m
+00012cd0: 6178 696d 756d 2063 6f72 7265 6c61 7469  aximum correlati
+00012ce0: 6f6e 2063 6f65 6666 6963 6965 6e74 0a20  on coefficient. 
+00012cf0: 2020 2069 6d61 7820 3d20 6e70 2e6e 616e     imax = np.nan
+00012d00: 6172 676d 6178 2863 6f66 290a 2020 2020  argmax(cof).    
+00012d10: 6966 2069 6d61 7820 3e3d 206c 656e 2845  if imax >= len(E
+00012d20: 7073 2920 2d20 323a 0a20 2020 2020 2020  ps) - 2:.       
+00012d30: 2069 6d61 7820 3d20 696d 6178 202d 2032   imax = imax - 2
+00012d40: 0a20 2020 2069 6620 696d 6178 203c 2032  .    if imax < 2
+00012d50: 3a0a 2020 2020 2020 2020 696d 6178 203d  :.        imax =
+00012d60: 2069 6d61 7820 2b20 320a 0a20 2020 2023   imax + 2..    #
+00012d70: 2050 726f 6365 6564 2074 6f20 7468 6520   Proceed to the 
+00012d80: 7365 636f 6e64 2073 7465 7020 746f 2067  second step to g
+00012d90: 6574 2061 206d 6f72 6520 7072 6563 6973  et a more precis
+00012da0: 6520 6476 2f76 206d 6561 7375 7265 6d65  e dv/v measureme
+00012db0: 6e74 0a20 2020 2064 7466 696e 6572 203d  nt.    dtfiner =
+00012dc0: 206e 702e 6c69 6e73 7061 6365 2845 7073   np.linspace(Eps
+00012dd0: 5b69 6d61 7820 2d20 325d 2c20 4570 735b  [imax - 2], Eps[
+00012de0: 696d 6178 202b 2032 5d2c 206e 6274 7269  imax + 2], nbtri
+00012df0: 616c 290a 2020 2020 2320 6e63 6f66 2020  al).    # ncof  
+00012e00: 2020 3d20 6e70 2e7a 6572 6f73 2864 7466    = np.zeros(dtf
+00012e10: 696e 6572 2e73 6861 7065 2c64 7479 7065  iner.shape,dtype
+00012e20: 3d6e 702e 666c 6f61 7433 3229 0a20 2020  =np.float32).   
+00012e30: 2077 6176 6566 6f72 6d73 203d 206e 702e   waveforms = np.
+00012e40: 7a65 726f 7328 286e 6274 7269 616c 202b  zeros((nbtrial +
+00012e50: 2031 2c20 6c65 6e28 7265 6629 2929 0a20   1, len(ref))). 
+00012e60: 2020 2077 6176 6566 6f72 6d73 5b30 2c20     waveforms[0, 
+00012e70: 3a5d 203d 2072 6566 0a20 2020 2066 6f72  :] = ref.    for
+00012e80: 2069 6920 696e 2072 616e 6765 286c 656e   ii in range(len
+00012e90: 2864 7466 696e 6572 2929 3a0a 2020 2020  (dtfiner)):.    
+00012ea0: 2020 2020 6e74 203d 2074 7665 6320 2a20      nt = tvec * 
+00012eb0: 6474 6669 6e65 725b 6969 5d0a 2020 2020  dtfiner[ii].    
+00012ec0: 2020 2020 7320 3d20 6e70 2e69 6e74 6572      s = np.inter
+00012ed0: 7028 783d 7476 6563 2c20 7870 3d6e 742c  p(x=tvec, xp=nt,
+00012ee0: 2066 703d 6375 7229 0a20 2020 2020 2020   fp=cur).       
+00012ef0: 2077 6176 6566 6f72 6d73 5b69 6920 2b20   waveforms[ii + 
+00012f00: 312c 203a 5d20 3d20 730a 2020 2020 6e63  1, :] = s.    nc
+00012f10: 6f66 203d 206e 702e 636f 7272 636f 6566  of = np.corrcoef
+00012f20: 2877 6176 6566 6f72 6d73 295b 305d 5b31  (waveforms)[0][1
+00012f30: 3a5d 0a20 2020 2063 6320 3d20 6e70 2e6d  :].    cc = np.m
+00012f40: 6178 286e 636f 6629 2020 2320 4669 6e64  ax(ncof)  # Find
+00012f50: 206d 6178 696d 756d 2063 6f72 7265 6c61   maximum correla
+00012f60: 7469 6f6e 2063 6f65 6666 6963 6965 6e74  tion coefficient
+00012f70: 206f 6620 7468 6520 7265 6669 6e65 6420   of the refined 
+00012f80: 2061 6e61 6c79 7369 730a 2020 2020 6476   analysis.    dv
+00012f90: 203d 2031 3030 2e30 202a 2064 7466 696e   = 100.0 * dtfin
+00012fa0: 6572 5b6e 702e 6172 676d 6178 286e 636f  er[np.argmax(nco
+00012fb0: 6629 5d20 2d20 3130 3020 2023 204d 756c  f)] - 100  # Mul
+00012fc0: 7469 706c 7920 6279 2031 3030 2074 6f20  tiply by 100 to 
+00012fd0: 636f 6e76 6572 7420 746f 2070 6572 6365  convert to perce
+00012fe0: 6e74 6167 6520 2845 7073 696c 6f6e 203d  ntage (Epsilon =
+00012ff0: 202d 6474 2f74 203d 2064 762f 7629 0a0a   -dt/t = dv/v)..
+00013000: 2020 2020 2320 4572 726f 7220 636f 6d70      # Error comp
+00013010: 7574 6174 696f 6e20 6261 7365 6420 6f6e  utation based on
+00013020: 2057 6561 7665 7220 6574 2061 6c20 2832   Weaver et al (2
+00013030: 3031 3129 2c20 4f6e 2074 6865 2070 7265  011), On the pre
+00013040: 6369 7369 6f6e 206f 6620 6e6f 6973 652d  cision of noise-
+00013050: 636f 7272 656c 6174 696f 6e20 696e 7465  correlation inte
+00013060: 7266 6572 6f6d 6574 7279 2c0a 2020 2020  rferometry,.    
+00013070: 2320 4765 6f70 6879 732e 204a 2e20 496e  # Geophys. J. In
+00013080: 742e 2c20 3138 3528 3329 0a20 2020 2054  t., 185(3).    T
+00013090: 203d 2031 202f 2028 666d 6178 202d 2066   = 1 / (fmax - f
+000130a0: 6d69 6e29 0a20 2020 2058 203d 2063 630a  min).    X = cc.
+000130b0: 2020 2020 7763 203d 206e 702e 7069 202a      wc = np.pi *
+000130c0: 2028 666d 696e 202b 2066 6d61 7829 0a20   (fmin + fmax). 
+000130d0: 2020 2074 3120 3d20 6e70 2e6d 696e 285b     t1 = np.min([
+000130e0: 746d 696e 2c20 746d 6178 5d29 0a20 2020  tmin, tmax]).   
+000130f0: 2074 3220 3d20 6e70 2e6d 6178 285b 746d   t2 = np.max([tm
+00013100: 696e 2c20 746d 6178 5d29 0a20 2020 2065  in, tmax]).    e
+00013110: 7272 6f72 203d 2031 3030 202a 2028 0a20  rror = 100 * (. 
+00013120: 2020 2020 2020 206e 702e 7371 7274 2831         np.sqrt(1
+00013130: 202d 2058 2a2a 3229 202f 2028 3220 2a20   - X**2) / (2 * 
+00013140: 5829 202a 206e 702e 7371 7274 2828 3620  X) * np.sqrt((6 
+00013150: 2a20 6e70 2e73 7172 7428 6e70 2e70 6920  * np.sqrt(np.pi 
+00013160: 2f20 3229 202a 2054 2920 2f20 2877 632a  / 2) * T) / (wc*
+00013170: 2a32 202a 2028 7432 2a2a 3320 2d20 7431  *2 * (t2**3 - t1
+00013180: 2a2a 3329 2929 0a20 2020 2029 0a0a 2020  **3))).    )..  
+00013190: 2020 7265 7475 726e 2064 762c 2065 7272    return dv, err
+000131a0: 6f72 2c20 6363 2c20 6364 700a 0a0a 6465  or, cc, cdp...de
+000131b0: 6620 6474 775f 6476 7628 7265 662c 2063  f dtw_dvv(ref, c
+000131c0: 7572 2c20 7061 7261 2c20 6d61 784c 6167  ur, para, maxLag
+000131d0: 2c20 622c 2064 6972 6563 7469 6f6e 293a  , b, direction):
+000131e0: 0a20 2020 2022 2222 0a20 2020 2044 796e  .    """.    Dyn
+000131f0: 616d 6963 2074 696d 6520 7761 7270 696e  amic time warpin
+00013200: 6720 666f 7220 6476 2f76 2065 7374 696d  g for dv/v estim
+00013210: 6174 696f 6e2e 0a0a 2020 2020 5041 5241  ation...    PARA
+00013220: 4d45 5445 5253 3a0a 2020 2020 2d2d 2d2d  METERS:.    ----
+00013230: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00013240: 2072 6566 203a 2072 6566 6572 656e 6365   ref : reference
+00013250: 2073 6967 6e61 6c20 286e 702e 6172 7261   signal (np.arra
+00013260: 792c 2073 697a 6520 4e29 0a20 2020 2063  y, size N).    c
+00013270: 7572 203a 2063 7572 7265 6e74 2073 6967  ur : current sig
+00013280: 6e61 6c20 286e 702e 6172 7261 792c 2073  nal (np.array, s
+00013290: 697a 6520 4e29 0a20 2020 2070 6172 613a  ize N).    para:
+000132a0: 2064 6963 7420 636f 6e74 6169 6e69 6e67   dict containing
+000132b0: 2075 7365 6675 6c20 7061 7261 6d65 7465   useful paramete
+000132c0: 7273 2061 626f 7574 2074 6865 2064 6174  rs about the dat
+000132d0: 6120 7769 6e64 6f77 2061 6e64 2074 6172  a window and tar
+000132e0: 6765 7465 6420 6672 6571 7565 6e63 790a  geted frequency.
+000132f0: 2020 2020 6d61 784c 6167 203a 206d 6178      maxLag : max
+00013300: 206e 756d 6265 7220 6f66 2070 6f69 6e74   number of point
+00013310: 7320 746f 2073 6561 7263 6820 666f 7277  s to search forw
+00013320: 6172 6420 616e 6420 6261 636b 7761 7264  ard and backward
+00013330: 2e0a 2020 2020 2020 2020 2020 2020 5375  ..            Su
+00013340: 6767 6573 7420 7365 7474 696e 6720 6974  ggest setting it
+00013350: 206c 6172 6765 7220 6966 2077 696e 646f   larger if windo
+00013360: 7720 6973 2073 6574 206c 6172 6765 722e  w is set larger.
+00013370: 0a20 2020 2062 203a 2062 2d76 616c 7565  .    b : b-value
+00013380: 2074 6f20 6c69 6d69 7420 7374 7261 696e   to limit strain
+00013390: 2c20 7768 6963 6820 6973 2074 6f20 6c69  , which is to li
+000133a0: 6d69 7420 7468 6520 6d61 7869 6d75 6d20  mit the maximum 
+000133b0: 7665 6c6f 6369 7479 2070 6572 7475 7262  velocity perturb
+000133c0: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
+000133d0: 2020 2053 6565 2065 7175 6174 696f 6e20     See equation 
+000133e0: 3131 2069 6e20 284d 696b 6573 656c 6c20  11 in (Mikesell 
+000133f0: 6574 2061 6c2e 2032 3031 3529 0a20 2020  et al. 2015).   
+00013400: 2064 6972 6563 7469 6f6e 3a20 6469 7265   direction: dire
+00013410: 6374 696f 6e20 746f 2061 6363 756d 756c  ction to accumul
+00013420: 6174 6520 6572 726f 7273 2028 313d 666f  ate errors (1=fo
+00013430: 7277 6172 642c 202d 313d 6261 636b 7761  rward, -1=backwa
+00013440: 7264 290a 2020 2020 5245 5455 524e 533a  rd).    RETURNS:
+00013450: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+00013460: 2d2d 2d2d 2d2d 2d0a 2020 2020 2d6d 3020  -------.    -m0 
+00013470: 3a20 6573 7469 6d61 7465 6420 6476 2f76  : estimated dv/v
+00013480: 0a20 2020 2065 6d30 203a 2065 7272 6f72  .    em0 : error
+00013490: 206f 6620 6476 2f76 2065 7374 696d 6174   of dv/v estimat
+000134a0: 696f 6e0a 0a20 2020 204f 7269 6769 6e61  ion..    Origina
+000134b0: 6c20 6279 2044 6920 5961 6e67 0a20 2020  l by Di Yang.   
+000134c0: 204c 6173 7420 6d6f 6469 6669 6564 2062   Last modified b
+000134d0: 7920 4479 6c61 6e20 4d69 6b65 7365 6c6c  y Dylan Mikesell
+000134e0: 2028 3235 2046 6562 2e20 3230 3135 290a   (25 Feb. 2015).
+000134f0: 2020 2020 5472 616e 736c 6174 6564 2074      Translated t
+00013500: 6f20 7079 7468 6f6e 2062 7920 5469 6d20  o python by Tim 
+00013510: 436c 656d 656e 7473 2028 3137 2041 7567  Clements (17 Aug
+00013520: 2e20 3230 3138 290a 2020 2020 2222 220a  . 2018).    """.
+00013530: 2020 2020 7477 696e 203d 2070 6172 615b      twin = para[
+00013540: 2274 7769 6e22 5d0a 2020 2020 6474 203d  "twin"].    dt =
+00013550: 2070 6172 615b 2264 7422 5d0a 2020 2020   para["dt"].    
+00013560: 746d 696e 203d 206e 702e 6d69 6e28 7477  tmin = np.min(tw
+00013570: 696e 290a 2020 2020 746d 6178 203d 206e  in).    tmax = n
+00013580: 702e 6d61 7828 7477 696e 290a 2020 2020  p.max(twin).    
+00013590: 7476 6563 7420 3d20 6e70 2e61 7261 6e67  tvect = np.arang
+000135a0: 6528 746d 696e 2c20 746d 6178 2c20 6474  e(tmin, tmax, dt
+000135b0: 290a 0a20 2020 2023 2073 6574 7570 206f  )..    # setup o
+000135c0: 7468 6572 2070 6172 616d 6574 6572 730a  ther parameters.
+000135d0: 2020 2020 6e70 7473 203d 206c 656e 2872      npts = len(r
+000135e0: 6566 2920 2023 206e 756d 6265 7220 6f66  ef)  # number of
+000135f0: 2074 696d 6520 7361 6d70 6c65 730a 0a20   time samples.. 
+00013600: 2020 2023 2063 6f6d 7075 7465 2065 7272     # compute err
+00013610: 6f72 2066 756e 6374 696f 6e20 6f76 6572  or function over
+00013620: 206c 6167 732c 2077 6869 6368 2069 7320   lags, which is 
+00013630: 696e 6465 7065 6e64 656e 7420 6f66 2073  independent of s
+00013640: 7472 6169 6e20 6c69 6d69 7420 2762 272e  train limit 'b'.
+00013650: 0a20 2020 2065 7272 203d 2063 6f6d 7075  .    err = compu
+00013660: 7465 4572 726f 7246 756e 6374 696f 6e28  teErrorFunction(
+00013670: 6375 722c 2072 6566 2c20 6e70 7473 2c20  cur, ref, npts, 
+00013680: 6d61 784c 6167 290a 0a20 2020 2023 2064  maxLag)..    # d
+00013690: 6972 6563 7469 6f6e 2074 6f20 6163 6375  irection to accu
+000136a0: 6d75 6c61 7465 2065 7272 6f72 7320 2831  mulate errors (1
+000136b0: 3d66 6f72 7761 7264 2c20 2d31 3d62 6163  =forward, -1=bac
+000136c0: 6b77 6172 6429 0a20 2020 2064 6973 7420  kward).    dist 
+000136d0: 3d20 6163 6375 6d75 6c61 7465 4572 726f  = accumulateErro
+000136e0: 7246 756e 6374 696f 6e28 6469 7265 6374  rFunction(direct
+000136f0: 696f 6e2c 2065 7272 2c20 6e70 7473 2c20  ion, err, npts, 
+00013700: 6d61 784c 6167 2c20 6229 0a20 2020 2073  maxLag, b).    s
+00013710: 7462 6172 203d 2062 6163 6b74 7261 636b  tbar = backtrack
+00013720: 4469 7374 616e 6365 4675 6e63 7469 6f6e  DistanceFunction
+00013730: 282d 3120 2a20 6469 7265 6374 696f 6e2c  (-1 * direction,
+00013740: 2064 6973 742c 2065 7272 2c20 2d6d 6178   dist, err, -max
+00013750: 4c61 672c 2062 290a 2020 2020 7374 6261  Lag, b).    stba
+00013760: 7254 696d 6520 3d20 7374 6261 7220 2a20  rTime = stbar * 
+00013770: 6474 2020 2320 636f 6e76 6572 7420 6672  dt  # convert fr
+00013780: 6f6d 2073 616d 706c 6573 2074 6f20 7469  om samples to ti
+00013790: 6d65 0a0a 2020 2020 2320 6375 7420 7468  me..    # cut th
+000137a0: 6520 6669 7273 7420 616e 6420 6c61 7374  e first and last
+000137b0: 2035 2520 666f 7220 6265 7474 6572 2072   5% for better r
+000137c0: 6567 7265 7373 696f 6e0a 2020 2020 696e  egression.    in
+000137d0: 6478 203d 206e 702e 7768 6572 6528 2874  dx = np.where((t
+000137e0: 7665 6374 203e 3d20 302e 3035 202a 206e  vect >= 0.05 * n
+000137f0: 7074 7320 2a20 6474 2920 2620 2874 7665  pts * dt) & (tve
+00013800: 6374 203c 3d20 302e 3935 202a 206e 7074  ct <= 0.95 * npt
+00013810: 7320 2a20 6474 2929 5b30 5d0a 0a20 2020  s * dt))[0]..   
+00013820: 2023 206c 696e 6561 7220 7265 6772 6573   # linear regres
+00013830: 7369 6f6e 2074 6f20 6765 7420 6476 2f76  sion to get dv/v
+00013840: 0a20 2020 2069 6620 6e70 7473 203e 2032  .    if npts > 2
+00013850: 3a0a 2020 2020 2020 2020 2320 7765 6967  :.        # weig
+00013860: 6874 730a 2020 2020 2020 2020 7720 3d20  hts.        w = 
+00013870: 6e70 2e6f 6e65 7328 6e70 7473 290a 2020  np.ones(npts).  
+00013880: 2020 2020 2020 2320 6d2c 2061 2c20 656d        # m, a, em
+00013890: 2c20 6561 203d 206c 696e 6561 725f 7265  , ea = linear_re
+000138a0: 6772 6573 7369 6f6e 2874 696d 655f 6178  gression(time_ax
+000138b0: 6973 5b69 6e64 785d 2c20 6465 6c74 615f  is[indx], delta_
+000138c0: 745b 696e 6478 5d2c 2077 2c20 696e 7465  t[indx], w, inte
+000138d0: 7263 6570 745f 6f72 6967 696e 3d46 616c  rcept_origin=Fal
+000138e0: 7365 290a 2020 2020 2020 2020 6d30 2c20  se).        m0, 
+000138f0: 656d 3020 3d20 6c69 6e65 6172 5f72 6567  em0 = linear_reg
+00013900: 7265 7373 696f 6e28 0a20 2020 2020 2020  ression(.       
+00013910: 2020 2020 2074 7665 6374 2e66 6c61 7474       tvect.flatt
+00013920: 656e 2829 5b69 6e64 785d 2c0a 2020 2020  en()[indx],.    
+00013930: 2020 2020 2020 2020 7374 6261 7254 696d          stbarTim
+00013940: 652e 666c 6174 7465 6e28 295b 696e 6478  e.flatten()[indx
+00013950: 5d2c 0a20 2020 2020 2020 2020 2020 2077  ],.            w
+00013960: 2e66 6c61 7474 656e 2829 5b69 6e64 785d  .flatten()[indx]
+00013970: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00013980: 7465 7263 6570 745f 6f72 6967 696e 3d54  tercept_origin=T
+00013990: 7275 652c 0a20 2020 2020 2020 2029 0a0a  rue,.        )..
+000139a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000139b0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+000139c0: 6e6f 7420 656e 6f75 6768 2070 6f69 6e74  not enough point
+000139d0: 7320 746f 2065 7374 696d 6174 6520 6476  s to estimate dv
+000139e0: 2f76 2066 6f72 2064 7477 2229 0a20 2020  /v for dtw").   
+000139f0: 2020 2020 206d 3020 3d20 300a 2020 2020       m0 = 0.    
+00013a00: 2020 2020 656d 3020 3d20 300a 0a20 2020      em0 = 0..   
+00013a10: 2072 6574 7572 6e20 6d30 202a 2031 3030   return m0 * 100
+00013a20: 2c20 656d 3020 2a20 3130 302c 2064 6973  , em0 * 100, dis
+00013a30: 740a 0a0a 6465 6620 6d77 6373 5f64 7676  t...def mwcs_dvv
+00013a40: 2872 6566 2c20 6375 722c 206d 6f76 696e  (ref, cur, movin
+00013a50: 675f 7769 6e64 6f77 5f6c 656e 6774 682c  g_window_length,
+00013a60: 2073 6c69 6465 5f73 7465 702c 2070 6172   slide_step, par
+00013a70: 612c 2073 6d6f 6f74 6869 6e67 5f68 616c  a, smoothing_hal
+00013a80: 665f 7769 6e3d 3529 3a0a 2020 2020 2222  f_win=5):.    ""
+00013a90: 220a 2020 2020 4d6f 7669 6e67 2057 696e  ".    Moving Win
+00013aa0: 646f 7720 4372 6f73 7320 5370 6563 7472  dow Cross Spectr
+00013ab0: 756d 206d 6574 686f 6420 746f 206d 6561  um method to mea
+00013ac0: 7375 7265 2064 762f 7620 2872 656c 7969  sure dv/v (relyi
+00013ad0: 6e67 206f 6e20 7068 693d 322a 7069 2a66  ng on phi=2*pi*f
+00013ae0: 2a74 2069 6e20 6672 6571 2064 6f6d 6169  *t in freq domai
+00013af0: 6e29 0a0a 2020 2020 5041 5241 4d45 5445  n)..    PARAMETE
+00013b00: 5253 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  RS:.    --------
+00013b10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072 6566  --------.    ref
+00013b20: 3a20 5265 6665 7265 6e63 6520 7761 7665  : Reference wave
+00013b30: 666f 726d 2028 6e70 2e6e 6461 7272 6179  form (np.ndarray
+00013b40: 2c20 7369 7a65 204e 290a 2020 2020 6375  , size N).    cu
+00013b50: 723a 2043 7572 7265 6e74 2077 6176 6566  r: Current wavef
+00013b60: 6f72 6d20 286e 702e 6e64 6172 7261 792c  orm (np.ndarray,
+00013b70: 2073 697a 6520 4e29 0a20 2020 206d 6f76   size N).    mov
+00013b80: 696e 675f 7769 6e64 6f77 5f6c 656e 6774  ing_window_lengt
+00013b90: 683a 206d 6f76 696e 6720 7769 6e64 6f77  h: moving window
+00013ba0: 206c 656e 6774 6820 746f 2063 616c 6375   length to calcu
+00013bb0: 6c61 7465 2063 726f 7373 2d73 7065 6374  late cross-spect
+00013bc0: 7275 6d20 286e 702e 666c 6f61 742c 2069  rum (np.float, i
+00013bd0: 6e20 7365 6329 0a20 2020 2073 6c69 6465  n sec).    slide
+00013be0: 5f73 7465 703a 2073 7465 7073 2069 6e20  _step: steps in 
+00013bf0: 7469 6d65 2074 6f20 7368 6966 7420 7468  time to shift th
+00013c00: 6520 6d6f 7669 6e67 2077 696e 646f 7720  e moving window 
+00013c10: 286e 702e 666c 6f61 742c 2069 6e20 7365  (np.float, in se
+00013c20: 636f 6e64 7329 0a20 2020 2070 6172 613a  conds).    para:
+00013c30: 2061 2064 6963 7420 636f 6e74 6169 6e69   a dict containi
+00013c40: 6e67 2070 6172 616d 6574 6572 7320 6162  ng parameters ab
+00013c50: 6f75 7420 696e 7075 7420 6461 7461 2077  out input data w
+00013c60: 696e 646f 7720 616e 6420 6672 6571 7565  indow and freque
+00013c70: 6e63 7920 696e 666f 2c20 696e 636c 7564  ncy info, includ
+00013c80: 696e 670a 2020 2020 2020 2020 6465 6c74  ing.        delt
+00013c90: 612d 3e54 6865 2073 616d 706c 696e 6720  a->The sampling 
+00013ca0: 7261 7465 206f 6620 7468 6520 696e 7075  rate of the inpu
+00013cb0: 7420 7469 6d65 7365 7269 6573 2028 696e  t timeseries (in
+00013cc0: 2048 7a29 0a20 2020 2020 2020 2077 696e   Hz).        win
+00013cd0: 646f 772d 3e20 5468 6520 7461 7267 6574  dow-> The target
+00013ce0: 2077 696e 646f 7720 666f 7220 6d65 6173   window for meas
+00013cf0: 7572 696e 6720 6474 2f74 0a20 2020 2020  uring dt/t.     
+00013d00: 2020 2066 7265 712d 3e20 5468 6520 6672     freq-> The fr
+00013d10: 6571 7565 6e63 7920 626f 756e 6420 746f  equency bound to
+00013d20: 2063 6f6d 7075 7465 2074 6865 2064 6570   compute the dep
+00013d30: 6861 7369 6e67 2028 696e 2048 7a29 0a20  hasing (in Hz). 
+00013d40: 2020 2020 2020 2074 6d69 6e3a 2054 6865         tmin: The
+00013d50: 206c 6566 746d 6f73 7420 7469 6d65 206c   leftmost time l
+00013d60: 6167 2028 7573 6564 2074 6f20 636f 6d70  ag (used to comp
+00013d70: 7574 6520 7468 6520 2274 696d 6520 6c61  ute the "time la
+00013d80: 6773 2061 7272 6179 2229 0a20 2020 2073  gs array").    s
+00013d90: 6d6f 6f74 6869 6e67 5f68 616c 665f 7769  moothing_half_wi
+00013da0: 6e3a 2049 6620 6469 6666 6572 656e 7420  n: If different 
+00013db0: 6672 6f6d 2030 2c20 6465 6669 6e65 7320  from 0, defines 
+00013dc0: 7468 6520 6861 6c66 206c 656e 6774 6820  the half length 
+00013dd0: 6f66 2074 6865 2073 6d6f 6f74 6869 6e67  of the smoothing
+00013de0: 2068 616e 6e69 6e67 2077 696e 646f 772e   hanning window.
+00013df0: 0a0a 2020 2020 5245 5455 524e 533a 0a20  ..    RETURNS:. 
+00013e00: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+00013e10: 2d2d 2d2d 2d0a 2020 2020 7469 6d65 5f61  -----.    time_a
+00013e20: 7869 733a 2074 6865 2063 656e 7472 616c  xis: the central
+00013e30: 2074 696d 6573 206f 6620 7468 6520 7769   times of the wi
+00013e40: 6e64 6f77 732e 0a20 2020 2064 656c 7461  ndows..    delta
+00013e50: 5f74 3a20 6474 0a20 2020 2064 656c 7461  _t: dt.    delta
+00013e60: 5f65 7272 3a65 7272 6f72 0a20 2020 2064  _err:error.    d
+00013e70: 656c 7461 5f6d 636f 683a 206d 6561 6e20  elta_mcoh: mean 
+00013e80: 636f 6865 7265 6e63 650a 0a20 2020 2043  coherence..    C
+00013e90: 6f70 6965 6420 6672 6f6d 204d 534e 6f69  opied from MSNoi
+00013ea0: 7365 2028 6874 7470 733a 2f2f 6769 7468  se (https://gith
+00013eb0: 7562 2e63 6f6d 2f52 4f42 656c 6769 756d  ub.com/ROBelgium
+00013ec0: 2f4d 534e 6f69 7365 2f74 7265 652f 6d61  /MSNoise/tree/ma
+00013ed0: 7374 6572 2f6d 736e 6f69 7365 290a 2020  ster/msnoise).  
+00013ee0: 2020 4d6f 6469 6669 6564 2062 7920 4368    Modified by Ch
+00013ef0: 656e 6778 696e 204a 6961 6e67 0a20 2020  engxin Jiang.   
+00013f00: 2022 2222 0a20 2020 2023 2063 6f6d 6d6f   """.    # commo
+00013f10: 6e20 7661 7269 6162 6c65 730a 2020 2020  n variables.    
+00013f20: 7477 696e 203d 2070 6172 615b 2274 7769  twin = para["twi
+00013f30: 6e22 5d0a 2020 2020 6672 6571 203d 2070  n"].    freq = p
+00013f40: 6172 615b 2266 7265 7122 5d0a 2020 2020  ara["freq"].    
+00013f50: 6474 203d 2070 6172 615b 2264 7422 5d0a  dt = para["dt"].
+00013f60: 2020 2020 746d 696e 203d 206e 702e 6d69      tmin = np.mi
+00013f70: 6e28 7477 696e 290a 2020 2020 666d 696e  n(twin).    fmin
+00013f80: 203d 206e 702e 6d69 6e28 6672 6571 290a   = np.min(freq).
+00013f90: 2020 2020 666d 6178 203d 206e 702e 6d61      fmax = np.ma
+00013fa0: 7828 6672 6571 290a 0a20 2020 2023 2070  x(freq)..    # p
+00013fb0: 6172 616d 6574 6572 2069 6e69 7469 616c  arameter initial
+00013fc0: 697a 650a 2020 2020 6465 6c74 615f 7420  ize.    delta_t 
+00013fd0: 3d20 5b5d 0a20 2020 2064 656c 7461 5f65  = [].    delta_e
+00013fe0: 7272 203d 205b 5d0a 2020 2020 6465 6c74  rr = [].    delt
+00013ff0: 615f 6d63 6f68 203d 205b 5d0a 2020 2020  a_mcoh = [].    
+00014000: 7469 6d65 5f61 7869 7320 3d20 5b5d 0a0a  time_axis = []..
+00014010: 2020 2020 2320 696e 666f 206f 6e20 7468      # info on th
+00014020: 6520 6d6f 7669 6e67 2077 696e 646f 770a  e moving window.
+00014030: 2020 2020 7769 6e64 6f77 5f6c 656e 6774      window_lengt
+00014040: 685f 7361 6d70 6c65 7320 3d20 6e70 2e69  h_samples = np.i
+00014050: 6e74 286d 6f76 696e 675f 7769 6e64 6f77  nt(moving_window
+00014060: 5f6c 656e 6774 6820 2f20 6474 290a 2020  _length / dt).  
+00014070: 2020 7061 6464 203d 2069 6e74 2832 202a    padd = int(2 *
+00014080: 2a20 286e 6578 7470 6f77 3228 7769 6e64  * (nextpow2(wind
+00014090: 6f77 5f6c 656e 6774 685f 7361 6d70 6c65  ow_length_sample
+000140a0: 7329 202b 2032 2929 0a20 2020 2063 6f75  s) + 2)).    cou
+000140b0: 6e74 203d 2030 0a20 2020 2074 7020 3d20  nt = 0.    tp = 
+000140c0: 636f 7369 6e65 5f74 6170 6572 2877 696e  cosine_taper(win
+000140d0: 646f 775f 6c65 6e67 7468 5f73 616d 706c  dow_length_sampl
+000140e0: 6573 2c20 302e 3135 290a 0a20 2020 206d  es, 0.15)..    m
+000140f0: 696e 696e 6420 3d20 300a 2020 2020 6d61  inind = 0.    ma
+00014100: 7869 6e64 203d 2077 696e 646f 775f 6c65  xind = window_le
+00014110: 6e67 7468 5f73 616d 706c 6573 0a0a 2020  ngth_samples..  
+00014120: 2020 2320 6c6f 6f70 2074 6872 6f75 6768    # loop through
+00014130: 2061 6c6c 2073 7562 2d77 696e 646f 7773   all sub-windows
+00014140: 0a20 2020 2077 6869 6c65 206d 6178 696e  .    while maxin
+00014150: 6420 3c3d 206c 656e 2872 6566 293a 0a20  d <= len(ref):. 
+00014160: 2020 2020 2020 2063 6369 203d 2063 7572         cci = cur
+00014170: 5b6d 696e 696e 643a 6d61 7869 6e64 5d0a  [minind:maxind].
+00014180: 2020 2020 2020 2020 6363 6920 3d20 7363          cci = sc
+00014190: 6970 792e 7369 676e 616c 2e64 6574 7265  ipy.signal.detre
+000141a0: 6e64 2863 6369 2c20 7479 7065 3d22 6c69  nd(cci, type="li
+000141b0: 6e65 6172 2229 0a20 2020 2020 2020 2063  near").        c
+000141c0: 6369 202a 3d20 7470 0a0a 2020 2020 2020  ci *= tp..      
+000141d0: 2020 6372 6920 3d20 7265 665b 6d69 6e69    cri = ref[mini
+000141e0: 6e64 3a6d 6178 696e 645d 0a20 2020 2020  nd:maxind].     
+000141f0: 2020 2063 7269 203d 2073 6369 7079 2e73     cri = scipy.s
+00014200: 6967 6e61 6c2e 6465 7472 656e 6428 6372  ignal.detrend(cr
+00014210: 692c 2074 7970 653d 226c 696e 6561 7222  i, type="linear"
+00014220: 290a 2020 2020 2020 2020 6372 6920 2a3d  ).        cri *=
+00014230: 2074 700a 0a20 2020 2020 2020 206d 696e   tp..        min
+00014240: 696e 6420 2b3d 2069 6e74 2873 6c69 6465  ind += int(slide
+00014250: 5f73 7465 7020 2f20 6474 290a 2020 2020  _step / dt).    
+00014260: 2020 2020 6d61 7869 6e64 202b 3d20 696e      maxind += in
+00014270: 7428 736c 6964 655f 7374 6570 202f 2064  t(slide_step / d
+00014280: 7429 0a0a 2020 2020 2020 2020 2320 646f  t)..        # do
+00014290: 2066 6674 0a20 2020 2020 2020 2066 6375   fft.        fcu
+000142a0: 7220 3d20 7363 6970 792e 6666 7470 6163  r = scipy.fftpac
+000142b0: 6b2e 6666 7428 6363 692c 206e 3d70 6164  k.fft(cci, n=pad
+000142c0: 6429 5b3a 2070 6164 6420 2f2f 2032 5d0a  d)[: padd // 2].
+000142d0: 2020 2020 2020 2020 6672 6566 203d 2073          fref = s
+000142e0: 6369 7079 2e66 6674 7061 636b 2e66 6674  cipy.fftpack.fft
+000142f0: 2863 7269 2c20 6e3d 7061 6464 295b 3a20  (cri, n=padd)[: 
+00014300: 7061 6464 202f 2f20 325d 0a0a 2020 2020  padd // 2]..    
+00014310: 2020 2020 6663 7572 3220 3d20 6e70 2e72      fcur2 = np.r
+00014320: 6561 6c28 6663 7572 2920 2a2a 2032 202b  eal(fcur) ** 2 +
+00014330: 206e 702e 696d 6167 2866 6375 7229 202a   np.imag(fcur) *
+00014340: 2a20 320a 2020 2020 2020 2020 6672 6566  * 2.        fref
+00014350: 3220 3d20 6e70 2e72 6561 6c28 6672 6566  2 = np.real(fref
+00014360: 2920 2a2a 2032 202b 206e 702e 696d 6167  ) ** 2 + np.imag
+00014370: 2866 7265 6629 202a 2a20 320a 0a20 2020  (fref) ** 2..   
+00014380: 2020 2020 2023 2067 6574 2063 726f 7373       # get cross
+00014390: 2d73 7065 6374 7275 6d20 2620 646f 2066  -spectrum & do f
+000143a0: 696c 7465 7269 6e67 0a20 2020 2020 2020  iltering.       
+000143b0: 2058 203d 2066 7265 6620 2a20 2866 6375   X = fref * (fcu
+000143c0: 722e 636f 6e6a 2829 290a 2020 2020 2020  r.conj()).      
+000143d0: 2020 6966 2073 6d6f 6f74 6869 6e67 5f68    if smoothing_h
+000143e0: 616c 665f 7769 6e20 213d 2030 3a0a 2020  alf_win != 0:.  
+000143f0: 2020 2020 2020 2020 2020 6463 7572 203d            dcur =
+00014400: 206e 702e 7371 7274 2873 6d6f 6f74 6828   np.sqrt(smooth(
+00014410: 6663 7572 322c 2077 696e 646f 773d 2268  fcur2, window="h
+00014420: 616e 6e69 6e67 222c 2068 616c 665f 7769  anning", half_wi
+00014430: 6e3d 736d 6f6f 7468 696e 675f 6861 6c66  n=smoothing_half
+00014440: 5f77 696e 2929 0a20 2020 2020 2020 2020  _win)).         
+00014450: 2020 2064 7265 6620 3d20 6e70 2e73 7172     dref = np.sqr
+00014460: 7428 736d 6f6f 7468 2866 7265 6632 2c20  t(smooth(fref2, 
+00014470: 7769 6e64 6f77 3d22 6861 6e6e 696e 6722  window="hanning"
+00014480: 2c20 6861 6c66 5f77 696e 3d73 6d6f 6f74  , half_win=smoot
+00014490: 6869 6e67 5f68 616c 665f 7769 6e29 290a  hing_half_win)).
+000144a0: 2020 2020 2020 2020 2020 2020 5820 3d20              X = 
+000144b0: 736d 6f6f 7468 2858 2c20 7769 6e64 6f77  smooth(X, window
+000144c0: 3d22 6861 6e6e 696e 6722 2c20 6861 6c66  ="hanning", half
+000144d0: 5f77 696e 3d73 6d6f 6f74 6869 6e67 5f68  _win=smoothing_h
+000144e0: 616c 665f 7769 6e29 0a20 2020 2020 2020  alf_win).       
+000144f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014500: 2020 2064 6375 7220 3d20 6e70 2e73 7172     dcur = np.sqr
+00014510: 7428 6663 7572 3229 0a20 2020 2020 2020  t(fcur2).       
+00014520: 2020 2020 2064 7265 6620 3d20 6e70 2e73       dref = np.s
+00014530: 7172 7428 6672 6566 3229 0a0a 2020 2020  qrt(fref2)..    
+00014540: 2020 2020 6463 7320 3d20 6e70 2e61 6273      dcs = np.abs
+00014550: 2858 290a 0a20 2020 2020 2020 2023 2046  (X)..        # F
+00014560: 696e 6420 7468 6520 7661 6c75 6573 2074  ind the values t
+00014570: 6865 2066 7265 7175 656e 6379 2072 616e  he frequency ran
+00014580: 6765 206f 6620 696e 7465 7265 7374 0a20  ge of interest. 
+00014590: 2020 2020 2020 2066 7265 715f 7665 6320         freq_vec 
+000145a0: 3d20 7363 6970 792e 6666 7470 6163 6b2e  = scipy.fftpack.
+000145b0: 6666 7466 7265 7128 6c65 6e28 5829 202a  fftfreq(len(X) *
+000145c0: 2032 2c20 6474 295b 3a20 7061 6464 202f   2, dt)[: padd /
+000145d0: 2f20 325d 0a20 2020 2020 2020 2069 6e64  / 2].        ind
+000145e0: 6578 5f72 616e 6765 203d 206e 702e 6172  ex_range = np.ar
+000145f0: 6777 6865 7265 286e 702e 6c6f 6769 6361  gwhere(np.logica
+00014600: 6c5f 616e 6428 6672 6571 5f76 6563 203e  l_and(freq_vec >
+00014610: 3d20 666d 696e 2c20 6672 6571 5f76 6563  = fmin, freq_vec
+00014620: 203c 3d20 666d 6178 2929 0a0a 2020 2020   <= fmax))..    
+00014630: 2020 2020 2320 4765 7420 436f 6865 7265      # Get Cohere
+00014640: 6e63 6520 616e 6420 6974 7320 6d65 616e  nce and its mean
+00014650: 2076 616c 7565 0a20 2020 2020 2020 2063   value.        c
+00014660: 6f68 203d 2067 6574 436f 6865 7265 6e63  oh = getCoherenc
+00014670: 6528 6463 732c 2064 7265 662c 2064 6375  e(dcs, dref, dcu
+00014680: 7229 0a20 2020 2020 2020 206d 636f 6820  r).        mcoh 
+00014690: 3d20 6e70 2e6d 6561 6e28 636f 685b 696e  = np.mean(coh[in
+000146a0: 6465 785f 7261 6e67 655d 290a 0a20 2020  dex_range])..   
+000146b0: 2020 2020 2023 2047 6574 2057 6569 6768       # Get Weigh
+000146c0: 7473 0a20 2020 2020 2020 2077 203d 2031  ts.        w = 1
+000146d0: 2e30 202f 2028 312e 3020 2f20 2863 6f68  .0 / (1.0 / (coh
+000146e0: 5b69 6e64 6578 5f72 616e 6765 5d20 2a2a  [index_range] **
+000146f0: 2032 2920 2d20 312e 3029 0a20 2020 2020   2) - 1.0).     
+00014700: 2020 2077 5b63 6f68 5b69 6e64 6578 5f72     w[coh[index_r
+00014710: 616e 6765 5d20 3e3d 2030 2e39 395d 203d  ange] >= 0.99] =
+00014720: 2031 2e30 202f 2028 312e 3020 2f20 302e   1.0 / (1.0 / 0.
+00014730: 3938 3031 202d 2031 2e30 290a 2020 2020  9801 - 1.0).    
+00014740: 2020 2020 7720 3d20 6e70 2e73 7172 7428      w = np.sqrt(
+00014750: 7720 2a20 6e70 2e73 7172 7428 6463 735b  w * np.sqrt(dcs[
+00014760: 696e 6465 785f 7261 6e67 655d 2929 0a20  index_range])). 
+00014770: 2020 2020 2020 2077 203d 206e 702e 7265         w = np.re
+00014780: 616c 2877 290a 0a20 2020 2020 2020 2023  al(w)..        #
+00014790: 2046 7265 7175 656e 6379 2061 7272 6179   Frequency array
+000147a0: 3a0a 2020 2020 2020 2020 7620 3d20 6e70  :.        v = np
+000147b0: 2e72 6561 6c28 6672 6571 5f76 6563 5b69  .real(freq_vec[i
+000147c0: 6e64 6578 5f72 616e 6765 5d29 202a 2032  ndex_range]) * 2
+000147d0: 202a 206e 702e 7069 0a0a 2020 2020 2020   * np.pi..      
+000147e0: 2020 2320 5068 6173 653a 0a20 2020 2020    # Phase:.     
+000147f0: 2020 2070 6869 203d 206e 702e 616e 676c     phi = np.angl
+00014800: 6528 5829 0a20 2020 2020 2020 2070 6869  e(X).        phi
+00014810: 5b30 5d20 3d20 302e 300a 2020 2020 2020  [0] = 0.0.      
+00014820: 2020 7068 6920 3d20 6e70 2e75 6e77 7261    phi = np.unwra
+00014830: 7028 7068 6929 0a20 2020 2020 2020 2070  p(phi).        p
+00014840: 6869 203d 2070 6869 5b69 6e64 6578 5f72  hi = phi[index_r
+00014850: 616e 6765 5d0a 0a20 2020 2020 2020 2023  ange]..        #
+00014860: 2043 616c 6375 6c61 7465 2074 6865 2073   Calculate the s
+00014870: 6c6f 7065 2077 6974 6820 6120 7765 6967  lope with a weig
+00014880: 6874 6564 206c 6561 7374 2073 7175 6172  hted least squar
+00014890: 6520 6c69 6e65 6172 2072 6567 7265 7373  e linear regress
+000148a0: 696f 6e0a 2020 2020 2020 2020 2320 666f  ion.        # fo
+000148b0: 7263 6564 2074 6872 6f75 6768 2074 6865  rced through the
+000148c0: 206f 7269 6769 6e3b 2077 6569 6768 7473   origin; weights
+000148d0: 2066 6f72 2074 6865 2057 4c53 206d 7573   for the WLS mus
+000148e0: 7420 6265 2074 6865 2076 6172 6961 6e63  t be the varianc
+000148f0: 6520 210a 2020 2020 2020 2020 6d2c 2065  e !.        m, e
+00014900: 6d20 3d20 6c69 6e65 6172 5f72 6567 7265  m = linear_regre
+00014910: 7373 696f 6e28 762e 666c 6174 7465 6e28  ssion(v.flatten(
+00014920: 292c 2070 6869 2e66 6c61 7474 656e 2829  ), phi.flatten()
+00014930: 2c20 772e 666c 6174 7465 6e28 2929 0a20  , w.flatten()). 
+00014940: 2020 2020 2020 2064 656c 7461 5f74 2e61         delta_t.a
+00014950: 7070 656e 6428 6d29 0a0a 2020 2020 2020  ppend(m)..      
+00014960: 2020 2320 7072 696e 7420 7068 692e 7368    # print phi.sh
+00014970: 6170 652c 2076 2e73 6861 7065 2c20 772e  ape, v.shape, w.
+00014980: 7368 6170 650a 2020 2020 2020 2020 6520  shape.        e 
+00014990: 3d20 6e70 2e73 756d 2828 7068 6920 2d20  = np.sum((phi - 
+000149a0: 6d20 2a20 7629 202a 2a20 3229 202f 2028  m * v) ** 2) / (
+000149b0: 6e70 2e73 697a 6528 7629 202d 2031 290a  np.size(v) - 1).
+000149c0: 2020 2020 2020 2020 7332 7832 203d 206e          s2x2 = n
+000149d0: 702e 7375 6d28 762a 2a32 202a 2077 2a2a  p.sum(v**2 * w**
+000149e0: 3229 0a20 2020 2020 2020 2073 7832 203d  2).        sx2 =
+000149f0: 206e 702e 7375 6d28 7720 2a20 762a 2a32   np.sum(w * v**2
+00014a00: 290a 2020 2020 2020 2020 6520 3d20 6e70  ).        e = np
+00014a10: 2e73 7172 7428 6520 2a20 7332 7832 202f  .sqrt(e * s2x2 /
+00014a20: 2073 7832 2a2a 3229 0a0a 2020 2020 2020   sx2**2)..      
+00014a30: 2020 6465 6c74 615f 6572 722e 6170 7065    delta_err.appe
+00014a40: 6e64 2865 290a 2020 2020 2020 2020 6465  nd(e).        de
+00014a50: 6c74 615f 6d63 6f68 2e61 7070 656e 6428  lta_mcoh.append(
+00014a60: 6e70 2e72 6561 6c28 6d63 6f68 2929 0a20  np.real(mcoh)). 
+00014a70: 2020 2020 2020 2074 696d 655f 6178 6973         time_axis
+00014a80: 2e61 7070 656e 6428 746d 696e 202b 206d  .append(tmin + m
+00014a90: 6f76 696e 675f 7769 6e64 6f77 5f6c 656e  oving_window_len
+00014aa0: 6774 6820 2f20 322e 3020 2b20 636f 756e  gth / 2.0 + coun
+00014ab0: 7420 2a20 736c 6964 655f 7374 6570 290a  t * slide_step).
+00014ac0: 2020 2020 2020 2020 636f 756e 7420 2b3d          count +=
+00014ad0: 2031 0a0a 2020 2020 2020 2020 6465 6c20   1..        del 
+00014ae0: 6663 7572 2c20 6672 6566 0a20 2020 2020  fcur, fref.     
+00014af0: 2020 2064 656c 2058 0a20 2020 2020 2020     del X.       
+00014b00: 2064 656c 2066 7265 715f 7665 630a 2020   del freq_vec.  
+00014b10: 2020 2020 2020 6465 6c20 696e 6465 785f        del index_
+00014b20: 7261 6e67 650a 2020 2020 2020 2020 6465  range.        de
+00014b30: 6c20 772c 2076 2c20 652c 2073 3278 322c  l w, v, e, s2x2,
+00014b40: 2073 7832 2c20 6d2c 2065 6d0a 0a20 2020   sx2, m, em..   
+00014b50: 2069 6620 6d61 7869 6e64 203e 206c 656e   if maxind > len
+00014b60: 2863 7572 2920 2b20 696e 7428 736c 6964  (cur) + int(slid
+00014b70: 655f 7374 6570 202f 2064 7429 3a0a 2020  e_step / dt):.  
+00014b80: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+00014b90: 7567 2822 5468 6520 6c61 7374 2077 696e  ug("The last win
+00014ba0: 646f 7720 7761 7320 746f 6f20 736d 616c  dow was too smal
+00014bb0: 6c2c 2062 7574 2077 6173 2063 6f6d 7075  l, but was compu
+00014bc0: 7465 6422 290a 0a20 2020 2023 2065 6e73  ted")..    # ens
+00014bd0: 7572 6520 616c 6c20 6d61 7472 6978 2061  ure all matrix a
+00014be0: 7265 206e 7020 6172 7261 790a 2020 2020  re np array.    
+00014bf0: 6465 6c74 615f 7420 3d20 6e70 2e61 7272  delta_t = np.arr
+00014c00: 6179 2864 656c 7461 5f74 290a 2020 2020  ay(delta_t).    
+00014c10: 6465 6c74 615f 6572 7220 3d20 6e70 2e61  delta_err = np.a
+00014c20: 7272 6179 2864 656c 7461 5f65 7272 290a  rray(delta_err).
+00014c30: 2020 2020 6465 6c74 615f 6d63 6f68 203d      delta_mcoh =
+00014c40: 206e 702e 6172 7261 7928 6465 6c74 615f   np.array(delta_
+00014c50: 6d63 6f68 290a 2020 2020 7469 6d65 5f61  mcoh).    time_a
+00014c60: 7869 7320 3d20 6e70 2e61 7272 6179 2874  xis = np.array(t
+00014c70: 696d 655f 6178 6973 290a 0a20 2020 2023  ime_axis)..    #
+00014c80: 2072 6561 6479 2066 6f72 206c 696e 6561   ready for linea
+00014c90: 7220 7265 6772 6573 7369 6f6e 0a20 2020  r regression.   
+00014ca0: 2064 656c 7461 5f6d 696e 6368 6f20 3d20   delta_mincho = 
+00014cb0: 302e 3635 0a20 2020 2064 656c 7461 5f6d  0.65.    delta_m
+00014cc0: 6178 6572 7220 3d20 302e 310a 2020 2020  axerr = 0.1.    
+00014cd0: 6465 6c74 615f 6d61 7864 7420 3d20 302e  delta_maxdt = 0.
+00014ce0: 310a 2020 2020 696e 6478 3120 3d20 6e70  1.    indx1 = np
+00014cf0: 2e77 6865 7265 2864 656c 7461 5f6d 636f  .where(delta_mco
+00014d00: 6820 3e20 6465 6c74 615f 6d69 6e63 686f  h > delta_mincho
+00014d10: 290a 2020 2020 696e 6478 3220 3d20 6e70  ).    indx2 = np
+00014d20: 2e77 6865 7265 2864 656c 7461 5f65 7272  .where(delta_err
+00014d30: 203c 2064 656c 7461 5f6d 6178 6572 7229   < delta_maxerr)
+00014d40: 0a20 2020 2069 6e64 7833 203d 206e 702e  .    indx3 = np.
+00014d50: 7768 6572 6528 6465 6c74 615f 7420 3c20  where(delta_t < 
+00014d60: 6465 6c74 615f 6d61 7864 7429 0a0a 2020  delta_maxdt)..  
+00014d70: 2020 2320 2d2d 2d2d 2d66 696e 6420 676f    # -----find go
+00014d80: 6f64 2064 7420 6d65 6173 7572 656d 656e  od dt measuremen
+00014d90: 7473 2d2d 2d2d 2d0a 2020 2020 696e 6478  ts-----.    indx
+00014da0: 203d 206e 702e 696e 7465 7273 6563 7431   = np.intersect1
+00014db0: 6428 696e 6478 312c 2069 6e64 7832 290a  d(indx1, indx2).
+00014dc0: 2020 2020 696e 6478 203d 206e 702e 696e      indx = np.in
+00014dd0: 7465 7273 6563 7431 6428 696e 6478 2c20  tersect1d(indx, 
+00014de0: 696e 6478 3329 0a0a 2020 2020 6966 206c  indx3)..    if l
+00014df0: 656e 2869 6e64 7829 203e 2032 3a0a 2020  en(indx) > 2:.  
+00014e00: 2020 2020 2020 2320 2d2d 2d2d 6573 7469        # ----esti
+00014e10: 6d61 7465 2077 6569 6768 7420 666f 7220  mate weight for 
+00014e20: 7265 6772 6573 7369 6f6e 2d2d 2d2d 0a20  regression----. 
+00014e30: 2020 2020 2020 2077 203d 2031 202f 2064         w = 1 / d
+00014e40: 656c 7461 5f65 7272 5b69 6e64 785d 0a20  elta_err[indx]. 
+00014e50: 2020 2020 2020 2077 5b7e 6e70 2e69 7366         w[~np.isf
+00014e60: 696e 6974 6528 7729 5d20 3d20 312e 300a  inite(w)] = 1.0.
+00014e70: 0a20 2020 2020 2020 2023 202d 2d2d 2d2d  .        # -----
+00014e80: 2d2d 2d2d 646f 206c 696e 6561 7220 7265  ----do linear re
+00014e90: 6772 6573 7369 6f6e 2d2d 2d2d 2d2d 2d2d  gression--------
+00014ea0: 2d2d 2d0a 2020 2020 2020 2020 2320 6d2c  ---.        # m,
+00014eb0: 2061 2c20 656d 2c20 6561 203d 206c 696e   a, em, ea = lin
+00014ec0: 6561 725f 7265 6772 6573 7369 6f6e 2874  ear_regression(t
+00014ed0: 696d 655f 6178 6973 5b69 6e64 785d 2c20  ime_axis[indx], 
+00014ee0: 6465 6c74 615f 745b 696e 6478 5d2c 2077  delta_t[indx], w
+00014ef0: 2c20 696e 7465 7263 6570 745f 6f72 6967  , intercept_orig
+00014f00: 696e 3d46 616c 7365 290a 2020 2020 2020  in=False).      
+00014f10: 2020 6d30 2c20 656d 3020 3d20 6c69 6e65    m0, em0 = line
+00014f20: 6172 5f72 6567 7265 7373 696f 6e28 7469  ar_regression(ti
+00014f30: 6d65 5f61 7869 735b 696e 6478 5d2c 2064  me_axis[indx], d
+00014f40: 656c 7461 5f74 5b69 6e64 785d 2c20 772c  elta_t[indx], w,
+00014f50: 2069 6e74 6572 6365 7074 5f6f 7269 6769   intercept_origi
+00014f60: 6e3d 5472 7565 290a 0a20 2020 2065 6c73  n=True)..    els
+00014f70: 653a 0a20 2020 2020 2020 206c 6f67 6765  e:.        logge
+00014f80: 722e 6465 6275 6728 226e 6f74 2065 6e6f  r.debug("not eno
+00014f90: 7567 6820 706f 696e 7473 2074 6f20 6573  ugh points to es
+00014fa0: 7469 6d61 7465 2064 762f 7620 666f 7220  timate dv/v for 
+00014fb0: 6d77 6373 2229 0a20 2020 2020 2020 206d  mwcs").        m
+00014fc0: 3020 3d20 300a 2020 2020 2020 2020 656d  0 = 0.        em
+00014fd0: 3020 3d20 300a 0a20 2020 2072 6574 7572  0 = 0..    retur
+00014fe0: 6e20 2d6d 3020 2a20 3130 302c 2065 6d30  n -m0 * 100, em0
+00014ff0: 202a 2031 3030 0a0a 0a64 6566 2057 4343   * 100...def WCC
+00015000: 5f64 7676 2872 6566 2c20 6375 722c 206d  _dvv(ref, cur, m
+00015010: 6f76 696e 675f 7769 6e64 6f77 5f6c 656e  oving_window_len
+00015020: 6774 682c 2073 6c69 6465 5f73 7465 702c  gth, slide_step,
+00015030: 2070 6172 6129 3a0a 2020 2020 2222 220a   para):.    """.
+00015040: 2020 2020 5769 6e64 6f77 6564 2063 726f      Windowed cro
+00015050: 7373 2063 6f72 7265 6c61 7469 6f6e 2028  ss correlation (
+00015060: 5743 4329 2066 6f72 2064 7420 6f72 2064  WCC) for dt or d
+00015070: 762f 7620 6d65 7375 7265 6d65 6e74 2028  v/v mesurement (
+00015080: 536e 6965 6465 7220 6574 2061 6c2e 2032  Snieder et al. 2
+00015090: 3031 3229 0a0a 2020 2020 5061 7261 6d65  012)..    Parame
+000150a0: 7465 7273 3a0a 2020 2020 2d2d 2d2d 2d2d  ters:.    ------
+000150b0: 2d2d 2d2d 2d0a 2020 2020 7265 663a 2054  -----.    ref: T
+000150c0: 6865 2022 5265 6665 7265 6e63 6522 2074  he "Reference" t
+000150d0: 696d 6573 6572 6965 730a 2020 2020 6375  imeseries.    cu
+000150e0: 723a 2054 6865 2022 4375 7272 656e 7422  r: The "Current"
+000150f0: 2074 696d 6573 6572 6965 730a 2020 2020   timeseries.    
+00015100: 6d6f 7669 6e67 5f77 696e 646f 775f 6c65  moving_window_le
+00015110: 6e67 7468 3a20 5468 6520 6d6f 7669 6e67  ngth: The moving
+00015120: 2077 696e 646f 7720 6c65 6e67 7468 2028   window length (
+00015130: 696e 2073 6563 6f6e 6473 290a 2020 2020  in seconds).    
+00015140: 736c 6964 655f 7374 6570 3a20 5468 6520  slide_step: The 
+00015150: 7374 6570 2074 6f20 6a75 6d70 2066 6f72  step to jump for
+00015160: 2074 6865 206d 6f76 696e 6720 7769 6e64   the moving wind
+00015170: 6f77 2028 696e 2073 6563 6f6e 6473 290a  ow (in seconds).
+00015180: 2020 2020 7061 7261 3a20 6120 6469 6374      para: a dict
+00015190: 2063 6f6e 7461 696e 696e 6720 6672 6571   containing freq
+000151a0: 2f74 696d 6520 696e 666f 206f 6620 7468  /time info of th
+000151b0: 6520 6461 7461 206d 6174 7269 780a 0a20  e data matrix.. 
+000151c0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+000151d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+000151e0: 2074 696d 655f 6178 6973 3a20 6365 6e74   time_axis: cent
+000151f0: 7261 6c20 7469 6d65 7320 6f66 2074 6865  ral times of the
+00015200: 206d 6f76 696e 6720 7769 6e64 6f77 0a20   moving window. 
+00015210: 2020 2064 656c 7461 5f74 3a20 6474 0a20     delta_t: dt. 
+00015220: 2020 2064 656c 7461 5f65 7272 3a20 6572     delta_err: er
+00015230: 726f 720a 2020 2020 6465 6c74 615f 6d63  ror.    delta_mc
+00015240: 6f68 3a20 6d65 616e 2063 6f68 6572 656e  oh: mean coheren
+00015250: 6365 2066 6f72 2065 6163 6820 7769 6e64  ce for each wind
+00015260: 6f77 0a0a 2020 2020 5772 6974 7465 6e20  ow..    Written 
+00015270: 6279 2043 6f6e 6763 6f6e 6720 5975 616e  by Congcong Yuan
+00015280: 2028 3120 4a75 6c79 2c20 3230 3139 290a   (1 July, 2019).
+00015290: 2020 2020 2222 220a 2020 2020 2320 636f      """.    # co
+000152a0: 6d6d 6f6e 2076 6172 6961 626c 6573 0a20  mmon variables. 
+000152b0: 2020 2074 7769 6e20 3d20 7061 7261 5b22     twin = para["
+000152c0: 7477 696e 225d 0a20 2020 2064 7420 3d20  twin"].    dt = 
+000152d0: 7061 7261 5b22 6474 225d 0a20 2020 2074  para["dt"].    t
+000152e0: 6d69 6e20 3d20 6e70 2e6d 696e 2874 7769  min = np.min(twi
+000152f0: 6e29 0a0a 2020 2020 2320 7061 7261 6d65  n)..    # parame
+00015300: 7465 7220 696e 6974 6961 6c69 7a65 0a20  ter initialize. 
+00015310: 2020 2064 656c 7461 5f74 203d 205b 5d0a     delta_t = [].
+00015320: 2020 2020 6465 6c74 615f 745f 636f 6566      delta_t_coef
+00015330: 203d 205b 5d0a 2020 2020 7469 6d65 5f61   = [].    time_a
+00015340: 7869 7320 3d20 5b5d 0a0a 2020 2020 2320  xis = []..    # 
+00015350: 696e 666f 206f 6e20 7468 6520 6d6f 7669  info on the movi
+00015360: 6e67 2077 696e 646f 770a 2020 2020 7769  ng window.    wi
+00015370: 6e64 6f77 5f6c 656e 6774 685f 7361 6d70  ndow_length_samp
+00015380: 6c65 7320 3d20 6e70 2e69 6e74 286d 6f76  les = np.int(mov
+00015390: 696e 675f 7769 6e64 6f77 5f6c 656e 6774  ing_window_lengt
+000153a0: 6820 2f20 6474 290a 2020 2020 636f 756e  h / dt).    coun
+000153b0: 7420 3d20 300a 2020 2020 7470 203d 2063  t = 0.    tp = c
+000153c0: 6f73 696e 655f 7461 7065 7228 7769 6e64  osine_taper(wind
+000153d0: 6f77 5f6c 656e 6774 685f 7361 6d70 6c65  ow_length_sample
+000153e0: 732c 2030 2e31 3529 0a0a 2020 2020 6d69  s, 0.15)..    mi
+000153f0: 6e69 6e64 203d 2030 0a20 2020 206d 6178  nind = 0.    max
+00015400: 696e 6420 3d20 7769 6e64 6f77 5f6c 656e  ind = window_len
+00015410: 6774 685f 7361 6d70 6c65 730a 0a20 2020  gth_samples..   
+00015420: 2023 206c 6f6f 7020 7468 726f 7567 6820   # loop through 
+00015430: 616c 6c20 7375 622d 7769 6e64 6f77 730a  all sub-windows.
+00015440: 2020 2020 7768 696c 6520 6d61 7869 6e64      while maxind
+00015450: 203c 3d20 6c65 6e28 7265 6629 3a0a 2020   <= len(ref):.  
+00015460: 2020 2020 2020 6363 6920 3d20 6375 725b        cci = cur[
+00015470: 6d69 6e69 6e64 3a6d 6178 696e 645d 0a20  minind:maxind]. 
+00015480: 2020 2020 2020 2063 6369 203d 2073 6369         cci = sci
+00015490: 7079 2e73 6967 6e61 6c2e 6465 7472 656e  py.signal.detren
+000154a0: 6428 6363 692c 2074 7970 653d 226c 696e  d(cci, type="lin
+000154b0: 6561 7222 290a 2020 2020 2020 2020 6363  ear").        cc
+000154c0: 6920 2a3d 2074 700a 0a20 2020 2020 2020  i *= tp..       
+000154d0: 2063 7269 203d 2072 6566 5b6d 696e 696e   cri = ref[minin
+000154e0: 643a 6d61 7869 6e64 5d0a 2020 2020 2020  d:maxind].      
+000154f0: 2020 6372 6920 3d20 7363 6970 792e 7369    cri = scipy.si
+00015500: 676e 616c 2e64 6574 7265 6e64 2863 7269  gnal.detrend(cri
+00015510: 2c20 7479 7065 3d22 6c69 6e65 6172 2229  , type="linear")
+00015520: 0a20 2020 2020 2020 2063 7269 202a 3d20  .        cri *= 
+00015530: 7470 0a0a 2020 2020 2020 2020 6d69 6e69  tp..        mini
+00015540: 6e64 202b 3d20 696e 7428 736c 6964 655f  nd += int(slide_
+00015550: 7374 6570 202f 2064 7429 0a20 2020 2020  step / dt).     
+00015560: 2020 206d 6178 696e 6420 2b3d 2069 6e74     maxind += int
+00015570: 2873 6c69 6465 5f73 7465 7020 2f20 6474  (slide_step / dt
+00015580: 290a 0a20 2020 2020 2020 2023 206e 6f72  )..        # nor
+00015590: 6d61 6c69 7a65 2073 6967 6e61 6c73 2062  malize signals b
+000155a0: 6566 6f72 6520 6372 6f73 7320 636f 7272  efore cross corr
+000155b0: 656c 6174 696f 6e0a 2020 2020 2020 2020  elation.        
+000155c0: 6363 6920 3d20 2863 6369 202d 2063 6369  cci = (cci - cci
+000155d0: 2e6d 6561 6e28 2929 202f 2063 6369 2e73  .mean()) / cci.s
+000155e0: 7464 2829 0a20 2020 2020 2020 2063 7269  td().        cri
+000155f0: 203d 2028 6372 6920 2d20 6372 692e 6d65   = (cri - cri.me
+00015600: 616e 2829 2920 2f20 6372 692e 7374 6428  an()) / cri.std(
+00015610: 290a 0a20 2020 2020 2020 2023 2067 6574  )..        # get
+00015620: 206d 6178 696d 756d 2063 6f72 7265 6c61   maximum correla
+00015630: 7469 6f6e 2063 6f65 6666 6963 6965 6e74  tion coefficient
+00015640: 2061 6e64 2069 7473 2069 6e64 6578 0a20   and its index. 
+00015650: 2020 2020 2020 2063 6332 203d 206e 702e         cc2 = np.
+00015660: 636f 7272 656c 6174 6528 6363 692c 2063  correlate(cci, c
+00015670: 7269 2c20 6d6f 6465 3d22 7361 6d65 2229  ri, mode="same")
+00015680: 0a20 2020 2020 2020 2063 6332 203d 2063  .        cc2 = c
+00015690: 6332 202f 206e 702e 7371 7274 2828 6363  c2 / np.sqrt((cc
+000156a0: 692a 2a32 292e 7375 6d28 2920 2a20 2863  i**2).sum() * (c
+000156b0: 7269 2a2a 3229 2e73 756d 2829 290a 0a20  ri**2).sum()).. 
+000156c0: 2020 2020 2020 2069 6d61 7863 6332 203d         imaxcc2 =
+000156d0: 206e 702e 7768 6572 6528 6363 3220 3d3d   np.where(cc2 ==
+000156e0: 206e 702e 6d61 7828 6363 3229 295b 305d   np.max(cc2))[0]
+000156f0: 0a20 2020 2020 2020 206d 6178 6363 3220  .        maxcc2 
+00015700: 3d20 6e70 2e6d 6178 2863 6332 290a 0a20  = np.max(cc2).. 
+00015710: 2020 2020 2020 2023 2067 6574 2074 6865         # get the
+00015720: 2074 696d 6520 7368 6966 740a 2020 2020   time shift.    
+00015730: 2020 2020 6d20 3d20 2869 6d61 7863 6332      m = (imaxcc2
+00015740: 202d 2028 286d 6178 696e 6420 2d20 6d69   - ((maxind - mi
+00015750: 6e69 6e64 2920 2f2f 2032 2929 202a 2064  nind) // 2)) * d
+00015760: 740a 2020 2020 2020 2020 6465 6c74 615f  t.        delta_
+00015770: 742e 6170 7065 6e64 286d 290a 2020 2020  t.append(m).    
+00015780: 2020 2020 6465 6c74 615f 745f 636f 6566      delta_t_coef
+00015790: 2e61 7070 656e 6428 6d61 7863 6332 290a  .append(maxcc2).
+000157a0: 0a20 2020 2020 2020 2074 696d 655f 6178  .        time_ax
+000157b0: 6973 2e61 7070 656e 6428 746d 696e 202b  is.append(tmin +
+000157c0: 206d 6f76 696e 675f 7769 6e64 6f77 5f6c   moving_window_l
+000157d0: 656e 6774 6820 2f20 322e 3020 2b20 636f  ength / 2.0 + co
+000157e0: 756e 7420 2a20 736c 6964 655f 7374 6570  unt * slide_step
+000157f0: 290a 2020 2020 2020 2020 636f 756e 7420  ).        count 
+00015800: 2b3d 2031 0a0a 2020 2020 6465 6c20 6363  += 1..    del cc
+00015810: 692c 2063 7269 2c20 6363 322c 2069 6d61  i, cri, cc2, ima
+00015820: 7863 6332 2c20 6d61 7863 6332 0a20 2020  xcc2, maxcc2.   
+00015830: 2064 656c 206d 0a0a 2020 2020 6966 206d   del m..    if m
+00015840: 6178 696e 6420 3e20 6c65 6e28 6375 7229  axind > len(cur)
+00015850: 202b 2069 6e74 2873 6c69 6465 5f73 7465   + int(slide_ste
+00015860: 7020 2f20 6474 293a 0a20 2020 2020 2020  p / dt):.       
+00015870: 206c 6f67 6765 722e 6465 6275 6728 2254   logger.debug("T
+00015880: 6865 206c 6173 7420 7769 6e64 6f77 2077  he last window w
+00015890: 6173 2074 6f6f 2073 6d61 6c6c 2c20 6275  as too small, bu
+000158a0: 7420 7761 7320 636f 6d70 7574 6564 2229  t was computed")
+000158b0: 0a0a 2020 2020 6465 6c74 615f 7420 3d20  ..    delta_t = 
+000158c0: 6e70 2e61 7272 6179 2864 656c 7461 5f74  np.array(delta_t
+000158d0: 290a 2020 2020 6465 6c74 615f 745f 636f  ).    delta_t_co
+000158e0: 6566 203d 206e 702e 6172 7261 7928 6465  ef = np.array(de
+000158f0: 6c74 615f 745f 636f 6566 290a 2020 2020  lta_t_coef).    
+00015900: 7469 6d65 5f61 7869 7320 3d20 6e70 2e61  time_axis = np.a
+00015910: 7272 6179 2874 696d 655f 6178 6973 290a  rray(time_axis).
+00015920: 0a20 2020 2023 206c 696e 6561 7220 7265  .    # linear re
+00015930: 6772 6573 7369 6f6e 2074 6f20 6765 7420  gression to get 
+00015940: 6476 2f76 0a20 2020 2069 6620 636f 756e  dv/v.    if coun
+00015950: 7420 3e20 323a 0a20 2020 2020 2020 2023  t > 2:.        #
+00015960: 2073 696d 706c 6520 7765 6967 6874 0a20   simple weight. 
+00015970: 2020 2020 2020 2077 203d 206e 702e 6f6e         w = np.on
+00015980: 6573 2863 6f75 6e74 290a 2020 2020 2020  es(count).      
+00015990: 2020 2320 6d2c 2061 2c20 656d 2c20 6561    # m, a, em, ea
+000159a0: 203d 206c 696e 6561 725f 7265 6772 6573   = linear_regres
+000159b0: 7369 6f6e 2874 696d 655f 6178 6973 5b69  sion(time_axis[i
+000159c0: 6e64 785d 2c20 6465 6c74 615f 745b 696e  ndx], delta_t[in
+000159d0: 6478 5d2c 2077 2c20 696e 7465 7263 6570  dx], w, intercep
+000159e0: 745f 6f72 6967 696e 3d46 616c 7365 290a  t_origin=False).
+000159f0: 2020 2020 2020 2020 6d30 2c20 656d 3020          m0, em0 
+00015a00: 3d20 6c69 6e65 6172 5f72 6567 7265 7373  = linear_regress
+00015a10: 696f 6e28 7469 6d65 5f61 7869 732e 666c  ion(time_axis.fl
+00015a20: 6174 7465 6e28 292c 2064 656c 7461 5f74  atten(), delta_t
+00015a30: 2e66 6c61 7474 656e 2829 2c20 772e 666c  .flatten(), w.fl
+00015a40: 6174 7465 6e28 292c 2069 6e74 6572 6365  atten(), interce
+00015a50: 7074 5f6f 7269 6769 6e3d 5472 7565 290a  pt_origin=True).
+00015a60: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00015a70: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00015a80: 226e 6f74 2065 6e6f 7567 6820 706f 696e  "not enough poin
+00015a90: 7473 2074 6f20 6573 7469 6d61 7465 2064  ts to estimate d
+00015aa0: 762f 7620 666f 7220 7763 6322 290a 2020  v/v for wcc").  
+00015ab0: 2020 2020 2020 6d30 203d 2030 0a20 2020        m0 = 0.   
+00015ac0: 2020 2020 2065 6d30 203d 2030 0a0a 2020       em0 = 0..  
+00015ad0: 2020 7265 7475 726e 202d 6d30 202a 2031    return -m0 * 1
+00015ae0: 3030 2c20 656d 3020 2a20 3130 300a 0a0a  00, em0 * 100...
+00015af0: 6465 6620 7778 735f 6476 7628 0a20 2020  def wxs_dvv(.   
+00015b00: 2072 6566 2c0a 2020 2020 6375 722c 0a20   ref,.    cur,. 
+00015b10: 2020 2061 6c6c 6672 6571 2c0a 2020 2020     allfreq,.    
+00015b20: 7061 7261 2c0a 2020 2020 646a 3d31 202f  para,.    dj=1 /
+00015b30: 2031 322c 0a20 2020 2073 303d 2d31 2c0a   12,.    s0=-1,.
+00015b40: 2020 2020 4a3d 2d31 2c0a 2020 2020 7369      J=-1,.    si
+00015b50: 673d 4661 6c73 652c 0a20 2020 2077 766e  g=False,.    wvn
+00015b60: 3d22 6d6f 726c 6574 222c 0a20 2020 2075  ="morlet",.    u
+00015b70: 6e77 7261 7066 6c61 673d 4661 6c73 652c  nwrapflag=False,
+00015b80: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
+00015b90: 436f 6d70 7574 6520 6474 206f 7220 6476  Compute dt or dv
+00015ba0: 2f76 2069 6e20 7469 6d65 2061 6e64 2066  /v in time and f
+00015bb0: 7265 7175 656e 6379 2064 6f6d 6169 6e20  requency domain 
+00015bc0: 6672 6f6d 2077 6176 656c 6574 2063 726f  from wavelet cro
+00015bd0: 7373 2073 7065 6374 7275 6d20 2877 7873  ss spectrum (wxs
+00015be0: 292e 0a20 2020 2066 6f72 2061 6c6c 2066  )..    for all f
+00015bf0: 7265 7175 6563 6965 7320 696e 2061 6e20  requecies in an 
+00015c00: 696e 7465 7265 7374 2072 616e 6765 0a0a  interest range..
+00015c10: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00015c20: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+00015c30: 2d0a 2020 2020 7265 663a 2054 6865 2022  -.    ref: The "
+00015c40: 5265 6665 7265 6e63 6522 2074 696d 6573  Reference" times
+00015c50: 6572 6965 7320 286e 756d 7079 2e6e 6461  eries (numpy.nda
+00015c60: 7272 6179 290a 2020 2020 6375 723a 2054  rray).    cur: T
+00015c70: 6865 2022 4375 7272 656e 7422 2074 696d  he "Current" tim
+00015c80: 6573 6572 6965 7320 286e 756d 7079 2e6e  eseries (numpy.n
+00015c90: 6461 7272 6179 290a 2020 2020 616c 6c66  darray).    allf
+00015ca0: 7265 713a 2061 2062 6f6f 6c65 6e20 7661  req: a boolen va
+00015cb0: 7269 6162 6c65 2074 6f20 6d61 6b65 206d  riable to make m
+00015cc0: 6561 7375 7265 6d65 6e74 7320 6f6e 2061  easurements on a
+00015cd0: 6c6c 2066 7265 7175 656e 6379 2072 616e  ll frequency ran
+00015ce0: 6765 206f 7220 6e6f 740a 2020 2020 7061  ge or not.    pa
+00015cf0: 7261 3a20 6120 6469 6374 2063 6f6e 7461  ra: a dict conta
+00015d00: 696e 696e 6720 6672 6571 2f74 696d 6520  ining freq/time 
+00015d10: 696e 666f 206f 6620 7468 6520 6461 7461  info of the data
+00015d20: 206d 6174 7269 780a 2020 2020 646a 2c20   matrix.    dj, 
+00015d30: 7330 2c20 4a2c 2073 6967 2c20 7776 6e3a  s0, J, sig, wvn:
+00015d40: 2063 6f6d 6d6f 6e20 7061 7261 6d65 7465   common paramete
+00015d50: 7273 2075 7365 6420 696e 2027 7761 7665  rs used in 'wave
+00015d60: 6c65 742e 7763 7427 0a20 2020 2075 6e77  let.wct'.    unw
+00015d70: 7261 7066 6c61 673a 2054 7275 6520 2d20  rapflag: True - 
+00015d80: 756e 7772 6170 2070 6861 7365 2064 656c  unwrap phase del
+00015d90: 6179 732e 2044 6566 6175 6c74 2069 7320  ays. Default is 
+00015da0: 4661 6c73 650a 0a20 2020 2052 4554 5552  False..    RETUR
+00015db0: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
+00015dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064  ----------.    d
+00015dd0: 7676 2a31 3030 203a 2065 7374 696d 6174  vv*100 : estimat
+00015de0: 6564 2064 762f 7620 696e 2025 0a20 2020  ed dv/v in %.   
+00015df0: 2065 7272 2a31 3030 203a 2065 7272 6f72   err*100 : error
+00015e00: 206f 6620 6476 2f76 2065 7374 696d 6174   of dv/v estimat
+00015e10: 696f 6e20 696e 2025 0a0a 2020 2020 4f72  ion in %..    Or
+00015e20: 6967 696e 616c 6c79 2077 7269 7474 656e  iginally written
+00015e30: 2062 7920 5469 6d20 436c 656d 656e 7473   by Tim Clements
+00015e40: 2028 3120 4d61 7263 682c 2032 3031 3929   (1 March, 2019)
+00015e50: 0a20 2020 204d 6f64 6966 6965 6420 6279  .    Modified by
+00015e60: 2043 6f6e 6763 6f6e 6720 5975 616e 2028   Congcong Yuan (
+00015e70: 3330 204a 756e 652c 2032 3031 3929 2062  30 June, 2019) b
+00015e80: 6173 6564 206f 6e20 284d 616f 2065 7420  ased on (Mao et 
+00015e90: 616c 2e20 3230 3139 292e 0a20 2020 2055  al. 2019)..    U
+00015ea0: 7064 6174 6564 2062 7920 4368 656e 6778  pdated by Chengx
+00015eb0: 696e 204a 6961 6e67 2028 3130 204f 6374  in Jiang (10 Oct
+00015ec0: 2c20 3230 3139 2920 746f 206d 6572 6765  , 2019) to merge
+00015ed0: 2074 6865 2066 756e 6374 696f 6e61 6c69   the functionali
+00015ee0: 7479 2066 6f72 206d 6573 7572 656d 656e  ty for mesuremen
+00015ef0: 7473 0a20 2020 2061 6372 6f73 7320 616c  ts.    across al
+00015f00: 6c20 6672 6571 7565 6e63 7920 616e 6420  l frequency and 
+00015f10: 6f6e 6520 6672 6571 2072 616e 6765 0a20  one freq range. 
+00015f20: 2020 2022 2222 0a20 2020 2023 2063 6f6d     """.    # com
+00015f30: 6d6f 6e20 7661 7269 6162 6c65 730a 2020  mon variables.  
+00015f40: 2020 7477 696e 203d 2070 6172 615b 2274    twin = para["t
+00015f50: 7769 6e22 5d0a 2020 2020 6672 6571 203d  win"].    freq =
+00015f60: 2070 6172 615b 2266 7265 7122 5d0a 2020   para["freq"].  
+00015f70: 2020 6474 203d 2070 6172 615b 2264 7422    dt = para["dt"
+00015f80: 5d0a 2020 2020 746d 696e 203d 206e 702e  ].    tmin = np.
+00015f90: 6d69 6e28 7477 696e 290a 2020 2020 746d  min(twin).    tm
+00015fa0: 6178 203d 206e 702e 6d61 7828 7477 696e  ax = np.max(twin
+00015fb0: 290a 2020 2020 666d 696e 203d 206e 702e  ).    fmin = np.
+00015fc0: 6d69 6e28 6672 6571 290a 2020 2020 666d  min(freq).    fm
+00015fd0: 6178 203d 206e 702e 6d61 7828 6672 6571  ax = np.max(freq
+00015fe0: 290a 2020 2020 7476 6563 203d 206e 702e  ).    tvec = np.
+00015ff0: 6172 616e 6765 2874 6d69 6e2c 2074 6d61  arange(tmin, tma
+00016000: 782c 2064 7429 0a20 2020 206e 7074 7320  x, dt).    npts 
+00016010: 3d20 6c65 6e28 7476 6563 290a 0a20 2020  = len(tvec)..   
+00016020: 2023 2070 6572 666f 726d 2063 726f 7373   # perform cross
+00016030: 2063 6f68 6572 656e 7420 616e 616c 7973   coherent analys
+00016040: 6973 2c20 6d6f 6469 6669 6564 2066 726f  is, modified fro
+00016050: 6d20 6675 6e63 7469 6f6e 2027 7761 7665  m function 'wave
+00016060: 6c65 742e 6377 7427 0a20 2020 2057 4354  let.cwt'.    WCT
+00016070: 2c20 6157 4354 2c20 636f 692c 2066 7265  , aWCT, coi, fre
+00016080: 712c 2073 6967 203d 2077 6374 5f6d 6f64  q, sig = wct_mod
+00016090: 6966 6965 6428 7265 662c 2063 7572 2c20  ified(ref, cur, 
+000160a0: 6474 2c20 646a 3d64 6a2c 2073 303d 7330  dt, dj=dj, s0=s0
+000160b0: 2c20 4a3d 4a2c 2073 6967 3d73 6967 2c20  , J=J, sig=sig, 
+000160c0: 7761 7665 6c65 743d 7776 6e2c 206e 6f72  wavelet=wvn, nor
+000160d0: 6d61 6c69 7a65 3d54 7275 6529 0a0a 2020  malize=True)..  
+000160e0: 2020 6966 2075 6e77 7261 7066 6c61 673a    if unwrapflag:
+000160f0: 0a20 2020 2020 2020 2070 6861 7365 203d  .        phase =
+00016100: 206e 702e 756e 7772 6170 2861 5743 542c   np.unwrap(aWCT,
+00016110: 2061 7869 733d 2d31 2920 2023 2061 7869   axis=-1)  # axi
+00016120: 733d 302c 2075 7077 7261 7020 616c 6f6e  s=0, upwrap alon
+00016130: 6720 7469 6d65 3b20 6178 6973 3d2d 312c  g time; axis=-1,
+00016140: 2075 6e77 7261 7020 616c 6f6e 6720 6672   unwrap along fr
+00016150: 6571 7565 6e63 790a 2020 2020 656c 7365  equency.    else
+00016160: 3a0a 2020 2020 2020 2020 7068 6173 6520  :.        phase 
+00016170: 3d20 6157 4354 0a0a 2020 2020 2320 7a65  = aWCT..    # ze
+00016180: 726f 206f 7574 2064 6174 6120 6f75 7473  ro out data outs
+00016190: 6964 6520 6672 6571 7565 6e63 7920 6261  ide frequency ba
+000161a0: 6e64 0a20 2020 2069 6620 2866 6d61 7820  nd.    if (fmax 
+000161b0: 3e20 6e70 2e6d 6178 2866 7265 7129 2920  > np.max(freq)) 
+000161c0: 7c20 2866 6d61 7820 3c3d 2066 6d69 6e29  | (fmax <= fmin)
+000161d0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+000161e0: 5661 6c75 6545 7272 6f72 2822 4162 6f72  ValueError("Abor
+000161f0: 743a 2069 6e70 7574 2066 7265 7175 656e  t: input frequen
+00016200: 6379 206f 7574 206f 6620 6c69 6d69 7473  cy out of limits
+00016210: 2122 290a 2020 2020 656c 7365 3a0a 2020  !").    else:.  
+00016220: 2020 2020 2020 6672 6571 5f69 6e64 696e        freq_indin
+00016230: 203d 206e 702e 7768 6572 6528 2866 7265   = np.where((fre
+00016240: 7120 3e3d 2066 6d69 6e29 2026 2028 6672  q >= fmin) & (fr
+00016250: 6571 203c 3d20 666d 6178 2929 5b30 5d0a  eq <= fmax))[0].
+00016260: 0a20 2020 2023 2066 6f6c 6c6f 7720 4d57  .    # follow MW
+00016270: 4353 2074 6f20 646f 2074 776f 2073 7465  CS to do two ste
+00016280: 7073 206f 6620 6c69 6e65 6172 2072 6567  ps of linear reg
+00016290: 7265 7373 696f 6e0a 2020 2020 6966 206e  ression.    if n
+000162a0: 6f74 2061 6c6c 6672 6571 3a0a 2020 2020  ot allfreq:.    
+000162b0: 2020 2020 6465 6c74 615f 745f 6d2c 2064      delta_t_m, d
+000162c0: 656c 7461 5f74 5f75 6e63 203d 206e 702e  elta_t_unc = np.
+000162d0: 7a65 726f 7328 6e70 7473 2c20 6474 7970  zeros(npts, dtyp
+000162e0: 653d 6e70 2e66 6c6f 6174 3332 292c 206e  e=np.float32), n
+000162f0: 702e 7a65 726f 7328 6e70 7473 2c20 6474  p.zeros(npts, dt
+00016300: 7970 653d 6e70 2e66 6c6f 6174 3332 290a  ype=np.float32).
+00016310: 2020 2020 2020 2020 2320 6173 7375 6d65          # assume
+00016320: 2074 6865 2074 7665 6320 6973 2074 6865   the tvec is the
+00016330: 2074 696d 6520 7769 6e64 6f77 2074 6f20   time window to 
+00016340: 6d65 6173 7572 6520 6474 0a20 2020 2020  measure dt.     
+00016350: 2020 2066 6f72 2069 7420 696e 2072 616e     for it in ran
+00016360: 6765 286e 7074 7329 3a0a 2020 2020 2020  ge(npts):.      
+00016370: 2020 2020 2020 7720 3d20 3120 2f20 5743        w = 1 / WC
+00016380: 545b 6672 6571 5f69 6e64 696e 2c20 6974  T[freq_indin, it
+00016390: 5d0a 2020 2020 2020 2020 2020 2020 775b  ].            w[
+000163a0: 7e6e 702e 6973 6669 6e69 7465 2877 295d  ~np.isfinite(w)]
+000163b0: 203d 2031 2e30 0a20 2020 2020 2020 2020   = 1.0.         
+000163c0: 2020 2064 656c 7461 5f74 5f6d 5b69 745d     delta_t_m[it]
+000163d0: 2c20 6465 6c74 615f 745f 756e 635b 6974  , delta_t_unc[it
+000163e0: 5d20 3d20 6c69 6e65 6172 5f72 6567 7265  ] = linear_regre
+000163f0: 7373 696f 6e28 6672 6571 5b66 7265 715f  ssion(freq[freq_
+00016400: 696e 6469 6e5d 202a 2032 202a 206e 702e  indin] * 2 * np.
+00016410: 7069 2c20 7068 6173 655b 6672 6571 5f69  pi, phase[freq_i
+00016420: 6e64 696e 2c20 6974 5d2c 2077 290a 0a20  ndin, it], w).. 
+00016430: 2020 2020 2020 2023 206e 6577 2077 6569         # new wei
+00016440: 6768 7473 2066 6f72 2072 6567 7265 7373  ghts for regress
+00016450: 696f 6e0a 2020 2020 2020 2020 7732 203d  ion.        w2 =
+00016460: 2031 202f 206e 702e 6d65 616e 2857 4354   1 / np.mean(WCT
+00016470: 5b66 7265 715f 696e 6469 6e2c 203a 5d2c  [freq_indin, :],
+00016480: 2061 7869 733d 3029 0a20 2020 2020 2020   axis=0).       
+00016490: 2077 325b 7e6e 702e 6973 6669 6e69 7465   w2[~np.isfinite
+000164a0: 2877 3229 5d20 3d20 312e 300a 0a20 2020  (w2)] = 1.0..   
+000164b0: 2020 2020 2023 206e 6f77 2075 7365 2064       # now use d
+000164c0: 7420 616e 6420 7420 746f 2067 6574 2064  t and t to get d
+000164d0: 762f 760a 2020 2020 2020 2020 6966 206c  v/v.        if l
+000164e0: 656e 2877 3229 203e 2032 3a0a 2020 2020  en(w2) > 2:.    
+000164f0: 2020 2020 2020 2020 6966 206e 6f74 206e          if not n
+00016500: 702e 616e 7928 6465 6c74 615f 745f 6d29  p.any(delta_t_m)
+00016510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016520: 2020 6476 762c 2065 7272 203d 206e 702e    dvv, err = np.
+00016530: 6e61 6e2c 206e 702e 6e61 6e0a 2020 2020  nan, np.nan.    
+00016540: 2020 2020 2020 2020 6d2c 2065 6d20 3d20          m, em = 
+00016550: 6c69 6e65 6172 5f72 6567 7265 7373 696f  linear_regressio
+00016560: 6e28 7476 6563 2c20 6465 6c74 615f 745f  n(tvec, delta_t_
+00016570: 6d2c 2077 322c 2069 6e74 6572 6365 7074  m, w2, intercept
+00016580: 5f6f 7269 6769 6e3d 5472 7565 290a 2020  _origin=True).  
+00016590: 2020 2020 2020 2020 2020 6476 762c 2065            dvv, e
+000165a0: 7272 203d 202d 6d2c 2065 6d0a 2020 2020  rr = -m, em.    
+000165b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000165c0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
+000165d0: 7567 2822 6e6f 7420 656e 6f75 6768 2070  ug("not enough p
+000165e0: 6f69 6e74 7320 746f 2065 7374 696d 6174  oints to estimat
+000165f0: 6520 6476 2f76 2066 6f72 2077 7473 2229  e dv/v for wts")
+00016600: 0a20 2020 2020 2020 2020 2020 2064 7676  .            dvv
+00016610: 2c20 6572 7220 3d20 6e70 2e6e 616e 2c20  , err = np.nan, 
+00016620: 6e70 2e6e 616e 0a0a 2020 2020 2020 2020  np.nan..        
+00016630: 7265 7475 726e 2064 7676 202a 2031 3030  return dvv * 100
+00016640: 2c20 6572 7220 2a20 3130 300a 0a20 2020  , err * 100..   
+00016650: 2023 2063 6f6e 7665 7274 2070 6861 7365   # convert phase
+00016660: 2064 6972 6563 746c 7920 746f 2064 656c   directly to del
+00016670: 7461 5f74 2066 6f72 2061 6c6c 2066 7265  ta_t for all fre
+00016680: 7175 656e 6369 6573 0a20 2020 2065 6c73  quencies.    els
+00016690: 653a 0a20 2020 2020 2020 2023 2063 6f6e  e:.        # con
+000166a0: 7665 7274 2070 6861 7365 2064 656c 6179  vert phase delay
+000166b0: 2074 6f20 7469 6d65 2064 656c 6179 0a20   to time delay. 
+000166c0: 2020 2020 2020 2064 656c 7461 5f74 203d         delta_t =
+000166d0: 2070 6861 7365 202f 2028 3220 2a20 6e70   phase / (2 * np
+000166e0: 2e70 6920 2a20 6672 6571 5b3a 2c20 4e6f  .pi * freq[:, No
+000166f0: 6e65 5d29 2020 2320 6e6f 726d 616c 697a  ne])  # normaliz
+00016700: 6520 7068 6173 6520 6279 2028 322a 7069  e phase by (2*pi
+00016710: 2a66 7265 7175 656e 6379 290a 2020 2020  *frequency).    
+00016720: 2020 2020 6476 762c 2065 7272 203d 206e      dvv, err = n
+00016730: 702e 7a65 726f 7328 6672 6571 5f69 6e64  p.zeros(freq_ind
+00016740: 696e 2e73 6861 7065 292c 206e 702e 7a65  in.shape), np.ze
+00016750: 726f 7328 6672 6571 5f69 6e64 696e 2e73  ros(freq_indin.s
+00016760: 6861 7065 290a 0a20 2020 2020 2020 2023  hape)..        #
+00016770: 206c 6f6f 7020 7468 726f 7567 6820 6672   loop through fr
+00016780: 6571 2066 6f72 206c 696e 6561 7220 7265  eq for linear re
+00016790: 6772 6573 7369 6f6e 0a20 2020 2020 2020  gression.       
+000167a0: 2066 6f72 2069 692c 2069 6672 6571 2069   for ii, ifreq i
+000167b0: 6e20 656e 756d 6572 6174 6528 6672 6571  n enumerate(freq
+000167c0: 5f69 6e64 696e 293a 0a20 2020 2020 2020  _indin):.       
+000167d0: 2020 2020 2069 6620 6c65 6e28 7476 6563       if len(tvec
+000167e0: 2920 3e20 323a 0a20 2020 2020 2020 2020  ) > 2:.         
+000167f0: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
+00016800: 2e61 6e79 2864 656c 7461 5f74 5b69 6672  .any(delta_t[ifr
+00016810: 6571 5d29 3a0a 2020 2020 2020 2020 2020  eq]):.          
+00016820: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00016830: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00016840: 2020 2020 2320 686f 7720 746f 2062 6574      # how to bet
+00016850: 7465 7220 6170 7072 6f61 6368 2074 6865  ter approach the
+00016860: 2075 6e63 6572 7461 696e 7479 206f 6620   uncertainty of 
+00016870: 6465 6c74 615f 740a 2020 2020 2020 2020  delta_t.        
+00016880: 2020 2020 2020 2020 7720 3d20 3120 2f20          w = 1 / 
+00016890: 5743 545b 6966 7265 715d 0a20 2020 2020  WCT[ifreq].     
+000168a0: 2020 2020 2020 2020 2020 2077 5b7e 6e70             w[~np
+000168b0: 2e69 7366 696e 6974 6528 7729 5d20 3d20  .isfinite(w)] = 
+000168c0: 312e 300a 0a20 2020 2020 2020 2020 2020  1.0..           
+000168d0: 2020 2020 2023 206d 2c20 612c 2065 6d2c       # m, a, em,
+000168e0: 2065 6120 3d20 6c69 6e65 6172 5f72 6567   ea = linear_reg
+000168f0: 7265 7373 696f 6e28 7469 6d65 5f61 7869  ression(time_axi
+00016900: 735b 696e 6478 5d2c 2064 656c 7461 5f74  s[indx], delta_t
+00016910: 5b69 6e64 785d 2c20 772c 2069 6e74 6572  [indx], w, inter
+00016920: 6365 7074 5f6f 7269 6769 6e3d 4661 6c73  cept_origin=Fals
+00016930: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00016940: 2020 206d 2c20 656d 203d 206c 696e 6561     m, em = linea
+00016950: 725f 7265 6772 6573 7369 6f6e 2874 7665  r_regression(tve
+00016960: 632c 2064 656c 7461 5f74 5b69 6672 6571  c, delta_t[ifreq
+00016970: 5d2c 2077 2c20 696e 7465 7263 6570 745f  ], w, intercept_
+00016980: 6f72 6967 696e 3d54 7275 6529 0a20 2020  origin=True).   
+00016990: 2020 2020 2020 2020 2020 2020 2064 7676               dvv
+000169a0: 5b69 695d 2c20 6572 725b 6969 5d20 3d20  [ii], err[ii] = 
+000169b0: 2d6d 2c20 656d 0a20 2020 2020 2020 2020  -m, em.         
+000169c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000169d0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+000169e0: 6465 6275 6728 226e 6f74 2065 6e6f 7567  debug("not enoug
+000169f0: 6820 706f 696e 7473 2074 6f20 6573 7469  h points to esti
+00016a00: 6d61 7465 2064 762f 7620 666f 7220 7774  mate dv/v for wt
+00016a10: 7322 290a 2020 2020 2020 2020 2020 2020  s").            
+00016a20: 2020 2020 6476 765b 6969 5d2c 2065 7272      dvv[ii], err
+00016a30: 5b69 695d 203d 206e 702e 6e61 6e2c 206e  [ii] = np.nan, n
+00016a40: 702e 6e61 6e0a 0a20 2020 2020 2020 2072  p.nan..        r
+00016a50: 6574 7572 6e20 6672 6571 5b66 7265 715f  eturn freq[freq_
+00016a60: 696e 6469 6e5d 2c20 6476 7620 2a20 3130  indin], dvv * 10
+00016a70: 302c 2065 7272 202a 2031 3030 0a0a 0a64  0, err * 100...d
+00016a80: 6566 2077 7473 5f64 7676 280a 2020 2020  ef wts_dvv(.    
+00016a90: 7265 662c 0a20 2020 2063 7572 2c0a 2020  ref,.    cur,.  
+00016aa0: 2020 616c 6c66 7265 712c 0a20 2020 2070    allfreq,.    p
+00016ab0: 6172 612c 0a20 2020 2064 765f 7261 6e67  ara,.    dv_rang
+00016ac0: 652c 0a20 2020 206e 6274 7269 616c 2c0a  e,.    nbtrial,.
+00016ad0: 2020 2020 646a 3d31 202f 2031 322c 0a20      dj=1 / 12,. 
+00016ae0: 2020 2073 303d 2d31 2c0a 2020 2020 4a3d     s0=-1,.    J=
+00016af0: 2d31 2c0a 2020 2020 7776 6e3d 226d 6f72  -1,.    wvn="mor
+00016b00: 6c65 7422 2c0a 2020 2020 6e6f 726d 616c  let",.    normal
+00016b10: 697a 653d 5472 7565 2c0a 293a 0a20 2020  ize=True,.):.   
+00016b20: 2022 2222 0a20 2020 2041 7070 6c79 2073   """.    Apply s
+00016b30: 7472 6574 6368 696e 6720 6d65 7468 6f64  tretching method
+00016b40: 2074 6f20 636f 6e74 696e 756f 7573 2077   to continuous w
+00016b50: 6176 656c 6574 2074 7261 6e73 666f 726d  avelet transform
+00016b60: 6174 696f 6e20 2843 5754 2920 6f66 2073  ation (CWT) of s
+00016b70: 6967 6e61 6c73 0a20 2020 2066 6f72 2061  ignals.    for a
+00016b80: 6c6c 2066 7265 7175 6563 6965 7320 696e  ll frequecies in
+00016b90: 2061 6e20 696e 7465 7265 7374 2072 616e   an interest ran
+00016ba0: 6765 0a0a 2020 2020 5061 7261 6d65 7465  ge..    Paramete
+00016bb0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00016bc0: 2d2d 2d2d 2d0a 2020 2020 7265 663a 2054  -----.    ref: T
+00016bd0: 6865 2022 5265 6665 7265 6e63 6522 2074  he "Reference" t
+00016be0: 696d 6573 6572 6965 7320 286e 756d 7079  imeseries (numpy
+00016bf0: 2e6e 6461 7272 6179 290a 2020 2020 6375  .ndarray).    cu
+00016c00: 723a 2054 6865 2022 4375 7272 656e 7422  r: The "Current"
+00016c10: 2074 696d 6573 6572 6965 7320 286e 756d   timeseries (num
+00016c20: 7079 2e6e 6461 7272 6179 290a 2020 2020  py.ndarray).    
+00016c30: 616c 6c66 7265 713a 2061 2062 6f6f 6c65  allfreq: a boole
+00016c40: 6e20 7661 7269 6162 6c65 2074 6f20 6d61  n variable to ma
+00016c50: 6b65 206d 6561 7375 7265 6d65 6e74 7320  ke measurements 
+00016c60: 6f6e 2061 6c6c 2066 7265 7175 656e 6379  on all frequency
+00016c70: 2072 616e 6765 206f 7220 6e6f 740a 2020   range or not.  
+00016c80: 2020 7061 7261 3a20 6120 6469 6374 2063    para: a dict c
+00016c90: 6f6e 7461 696e 696e 6720 6672 6571 2f74  ontaining freq/t
+00016ca0: 696d 6520 696e 666f 206f 6620 7468 6520  ime info of the 
+00016cb0: 6461 7461 206d 6174 7269 780a 2020 2020  data matrix.    
+00016cc0: 6476 5f72 616e 6765 3a20 6162 736f 6c75  dv_range: absolu
+00016cd0: 7465 2062 6f75 6e64 2066 6f72 2074 6865  te bound for the
+00016ce0: 2076 656c 6f63 6974 7920 7661 7269 6174   velocity variat
+00016cf0: 696f 6e3b 2065 7861 6d70 6c65 3a20 6476  ion; example: dv
+00016d00: 3d30 2e30 3320 666f 7220 5b2d 332c 335d  =0.03 for [-3,3]
+00016d10: 250a 2020 2020 6f66 2072 656c 6174 6976  %.    of relativ
+00016d20: 6520 7665 6c6f 6369 7479 2063 6861 6e67  e velocity chang
+00016d30: 6520 2866 6c6f 6174 290a 2020 2020 6e62  e (float).    nb
+00016d40: 7472 6961 6c3a 206e 756d 6265 7220 6f66  trial: number of
+00016d50: 2073 7472 6574 6368 696e 6720 636f 6566   stretching coef
+00016d60: 6669 6369 656e 7420 6265 7477 6565 6e20  ficient between 
+00016d70: 6476 6d69 6e20 616e 6420 6476 6d61 782c  dvmin and dvmax,
+00016d80: 206e 6f20 6e65 6564 2074 6f20 6265 2068   no need to be h
+00016d90: 6967 6865 7220 7468 616e 2031 3030 2020  igher than 100  
+00016da0: 2866 6c6f 6174 290a 2020 2020 646a 2c20  (float).    dj, 
+00016db0: 7330 2c20 4a2c 2073 6967 2c20 7776 6e3a  s0, J, sig, wvn:
+00016dc0: 2063 6f6d 6d6f 6e20 7061 7261 6d65 7465   common paramete
+00016dd0: 7273 2075 7365 6420 696e 2027 7761 7665  rs used in 'wave
+00016de0: 6c65 742e 7763 7427 0a20 2020 206e 6f72  let.wct'.    nor
+00016df0: 6d61 6c69 7a65 3a20 6e6f 726d 616c 697a  malize: normaliz
+00016e00: 6520 7468 6520 7761 7665 6c65 7420 7370  e the wavelet sp
+00016e10: 6563 7472 756d 206f 7220 6e6f 742e 2044  ectrum or not. D
+00016e20: 6566 6175 6c74 2069 7320 5472 7565 0a0a  efault is True..
+00016e30: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+00016e40: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00016e50: 2d2d 2d0a 2020 2020 6476 763a 2065 7374  ---.    dvv: est
+00016e60: 696d 6174 6564 2064 762f 760a 2020 2020  imated dv/v.    
+00016e70: 6572 723a 2065 7272 6f72 206f 6620 6476  err: error of dv
+00016e80: 2f76 2065 7374 696d 6174 696f 6e0a 0a20  /v estimation.. 
+00016e90: 2020 2057 7269 7474 656e 2062 7920 436f     Written by Co
+00016ea0: 6e67 636f 6e67 2059 7561 6e20 2833 3020  ngcong Yuan (30 
+00016eb0: 4a75 6e2c 2032 3031 3929 0a20 2020 2022  Jun, 2019).    "
+00016ec0: 2222 0a20 2020 2023 2063 6f6d 6d6f 6e20  "".    # common 
+00016ed0: 7661 7269 6162 6c65 730a 2020 2020 6672  variables.    fr
+00016ee0: 6571 203d 2070 6172 615b 2266 7265 7122  eq = para["freq"
+00016ef0: 5d0a 2020 2020 6474 203d 2070 6172 615b  ].    dt = para[
+00016f00: 2264 7422 5d0a 2020 2020 666d 696e 203d  "dt"].    fmin =
+00016f10: 206e 702e 6d69 6e28 6672 6571 290a 2020   np.min(freq).  
+00016f20: 2020 666d 6178 203d 206e 702e 6d61 7828    fmax = np.max(
+00016f30: 6672 6571 290a 0a20 2020 2023 2061 7070  freq)..    # app
+00016f40: 6c79 2063 7774 206f 6e20 7477 6f20 7472  ly cwt on two tr
+00016f50: 6163 6573 0a20 2020 2063 7774 312c 2073  aces.    cwt1, s
+00016f60: 6a2c 2066 7265 712c 2063 6f69 2c20 5f2c  j, freq, coi, _,
+00016f70: 205f 203d 2070 7963 7774 2e63 7774 2863   _ = pycwt.cwt(c
+00016f80: 7572 2c20 6474 2c20 646a 2c20 7330 2c20  ur, dt, dj, s0, 
+00016f90: 4a2c 2077 766e 290a 2020 2020 6377 7432  J, wvn).    cwt2
+00016fa0: 2c20 736a 2c20 6672 6571 2c20 636f 692c  , sj, freq, coi,
+00016fb0: 205f 2c20 5f20 3d20 7079 6377 742e 6377   _, _ = pycwt.cw
+00016fc0: 7428 7265 662c 2064 742c 2064 6a2c 2073  t(ref, dt, dj, s
+00016fd0: 302c 204a 2c20 7776 6e29 0a0a 2020 2020  0, J, wvn)..    
+00016fe0: 2320 6578 7472 6163 7420 7265 616c 2076  # extract real v
+00016ff0: 616c 7565 7320 6f66 2063 7774 0a20 2020  alues of cwt.   
+00017000: 2072 6377 7431 2c20 7263 7774 3220 3d20   rcwt1, rcwt2 = 
+00017010: 6e70 2e72 6561 6c28 6377 7431 292c 206e  np.real(cwt1), n
+00017020: 702e 7265 616c 2863 7774 3229 0a0a 2020  p.real(cwt2)..  
+00017030: 2020 2320 7a65 726f 206f 7574 2064 6174    # zero out dat
+00017040: 6120 6f75 7473 6964 6520 6672 6571 7565  a outside freque
+00017050: 6e63 7920 6261 6e64 0a20 2020 2069 6620  ncy band.    if 
+00017060: 2866 6d61 7820 3e20 6e70 2e6d 6178 2866  (fmax > np.max(f
+00017070: 7265 7129 2920 7c20 2866 6d61 7820 3c3d  req)) | (fmax <=
+00017080: 2066 6d69 6e29 3a0a 2020 2020 2020 2020   fmin):.        
+00017090: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000170a0: 2822 4162 6f72 743a 2069 6e70 7574 2066  ("Abort: input f
+000170b0: 7265 7175 656e 6379 206f 7574 206f 6620  requency out of 
+000170c0: 6c69 6d69 7473 2122 290a 2020 2020 656c  limits!").    el
+000170d0: 7365 3a0a 2020 2020 2020 2020 6672 6571  se:.        freq
+000170e0: 5f69 6e64 696e 203d 206e 702e 7768 6572  _indin = np.wher
+000170f0: 6528 2866 7265 7120 3e3d 2066 6d69 6e29  e((freq >= fmin)
+00017100: 2026 2028 6672 6571 203c 3d20 666d 6178   & (freq <= fmax
+00017110: 2929 5b30 5d0a 0a20 2020 2023 2063 6f6e  ))[0]..    # con
+00017120: 7665 7274 2077 6176 656c 6574 2064 6f6d  vert wavelet dom
+00017130: 6169 6e20 6261 636b 2074 6f20 7469 6d65  ain back to time
+00017140: 2064 6f6d 6169 6e20 287e 6669 6c74 6572   domain (~filter
+00017150: 696e 6729 0a20 2020 2069 6620 6e6f 7420  ing).    if not 
+00017160: 616c 6c66 7265 713a 0a20 2020 2020 2020  allfreq:.       
+00017170: 2023 2069 6e76 6572 7365 2063 7774 2074   # inverse cwt t
+00017180: 6f20 7469 6d65 2064 6f6d 6169 6e0a 2020  o time domain.  
+00017190: 2020 2020 2020 6963 7774 3120 3d20 7079        icwt1 = py
+000171a0: 6377 742e 6963 7774 2863 7774 315b 6672  cwt.icwt(cwt1[fr
+000171b0: 6571 5f69 6e64 696e 5d2c 2073 6a5b 6672  eq_indin], sj[fr
+000171c0: 6571 5f69 6e64 696e 5d2c 2064 742c 2064  eq_indin], dt, d
+000171d0: 6a2c 2077 766e 290a 2020 2020 2020 2020  j, wvn).        
+000171e0: 6963 7774 3220 3d20 7079 6377 742e 6963  icwt2 = pycwt.ic
+000171f0: 7774 2863 7774 325b 6672 6571 5f69 6e64  wt(cwt2[freq_ind
+00017200: 696e 5d2c 2073 6a5b 6672 6571 5f69 6e64  in], sj[freq_ind
+00017210: 696e 5d2c 2064 742c 2064 6a2c 2077 766e  in], dt, dj, wvn
+00017220: 290a 0a20 2020 2020 2020 2023 2061 7373  )..        # ass
+00017230: 756d 6520 616c 6c20 7469 6d65 2077 696e  ume all time win
+00017240: 646f 7720 6973 2075 7365 640a 2020 2020  dow is used.    
+00017250: 2020 2020 7763 7774 312c 2077 6377 7432      wcwt1, wcwt2
+00017260: 203d 206e 702e 7265 616c 2869 6377 7431   = np.real(icwt1
+00017270: 292c 206e 702e 7265 616c 2869 6377 7432  ), np.real(icwt2
+00017280: 290a 0a20 2020 2020 2020 2023 204e 6f72  )..        # Nor
+00017290: 6d61 6c69 7a65 7320 626f 7468 2073 6967  malizes both sig
+000172a0: 6e61 6c73 2c20 6966 2061 7070 726f 7072  nals, if appropr
+000172b0: 6961 7465 2e0a 2020 2020 2020 2020 6966  iate..        if
+000172c0: 206e 6f72 6d61 6c69 7a65 3a0a 2020 2020   normalize:.    
+000172d0: 2020 2020 2020 2020 6e63 7774 3120 3d20          ncwt1 = 
+000172e0: 2877 6377 7431 202d 2077 6377 7431 2e6d  (wcwt1 - wcwt1.m
+000172f0: 6561 6e28 2929 202f 2077 6377 7431 2e73  ean()) / wcwt1.s
+00017300: 7464 2829 0a20 2020 2020 2020 2020 2020  td().           
+00017310: 206e 6377 7432 203d 2028 7763 7774 3220   ncwt2 = (wcwt2 
+00017320: 2d20 7763 7774 322e 6d65 616e 2829 2920  - wcwt2.mean()) 
+00017330: 2f20 7763 7774 322e 7374 6428 290a 2020  / wcwt2.std().  
+00017340: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00017350: 2020 2020 2020 2020 6e63 7774 3120 3d20          ncwt1 = 
+00017360: 7763 7774 310a 2020 2020 2020 2020 2020  wcwt1.          
+00017370: 2020 6e63 7774 3220 3d20 7763 7774 320a    ncwt2 = wcwt2.
+00017380: 0a20 2020 2020 2020 2023 2072 756e 2073  .        # run s
+00017390: 7472 6574 6368 696e 670a 2020 2020 2020  tretching.      
+000173a0: 2020 6476 762c 2065 7272 2c20 6363 2c20    dvv, err, cc, 
+000173b0: 6364 7020 3d20 7374 7265 7463 6869 6e67  cdp = stretching
+000173c0: 286e 6377 7432 2c20 6e63 7774 312c 2064  (ncwt2, ncwt1, d
+000173d0: 765f 7261 6e67 652c 206e 6274 7269 616c  v_range, nbtrial
+000173e0: 2c20 7061 7261 290a 2020 2020 2020 2020  , para).        
+000173f0: 7265 7475 726e 2064 7676 2c20 6572 720a  return dvv, err.
+00017400: 0a20 2020 2023 2064 6972 6563 746c 7920  .    # directly 
+00017410: 7461 6b65 2061 6476 616e 7461 6765 206f  take advantage o
+00017420: 6620 7468 650a 2020 2020 656c 7365 3a0a  f the.    else:.
+00017430: 2020 2020 2020 2020 2320 696e 6974 6961          # initia
+00017440: 6c69 7a65 2076 6172 6961 626c 650a 2020  lize variable.  
+00017450: 2020 2020 2020 6e66 7265 7120 3d20 6c65        nfreq = le
+00017460: 6e28 6672 6571 5f69 6e64 696e 290a 2020  n(freq_indin).  
+00017470: 2020 2020 2020 6476 762c 2063 632c 2063        dvv, cc, c
+00017480: 6470 2c20 6572 7220 3d20 280a 2020 2020  dp, err = (.    
+00017490: 2020 2020 2020 2020 6e70 2e7a 6572 6f73          np.zeros
+000174a0: 286e 6672 6571 2c20 6474 7970 653d 6e70  (nfreq, dtype=np
+000174b0: 2e66 6c6f 6174 3332 292c 0a20 2020 2020  .float32),.     
+000174c0: 2020 2020 2020 206e 702e 7a65 726f 7328         np.zeros(
+000174d0: 6e66 7265 712c 2064 7479 7065 3d6e 702e  nfreq, dtype=np.
+000174e0: 666c 6f61 7433 3229 2c0a 2020 2020 2020  float32),.      
+000174f0: 2020 2020 2020 6e70 2e7a 6572 6f73 286e        np.zeros(n
+00017500: 6672 6571 2c20 6474 7970 653d 6e70 2e66  freq, dtype=np.f
+00017510: 6c6f 6174 3332 292c 0a20 2020 2020 2020  loat32),.       
+00017520: 2020 2020 206e 702e 7a65 726f 7328 6e66       np.zeros(nf
+00017530: 7265 712c 2064 7479 7065 3d6e 702e 666c  req, dtype=np.fl
+00017540: 6f61 7433 3229 2c0a 2020 2020 2020 2020  oat32),.        
+00017550: 290a 0a20 2020 2020 2020 2023 206c 6f6f  )..        # loo
+00017560: 7020 7468 726f 7567 6820 6561 6368 2066  p through each f
+00017570: 7265 710a 2020 2020 2020 2020 666f 7220  req.        for 
+00017580: 6969 2c20 6966 7265 7120 696e 2065 6e75  ii, ifreq in enu
+00017590: 6d65 7261 7465 2866 7265 715f 696e 6469  merate(freq_indi
+000175a0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+000175b0: 2320 7072 6570 6172 6520 7769 6e64 6f77  # prepare window
+000175c0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+000175d0: 2020 2020 7763 7774 312c 2077 6377 7432      wcwt1, wcwt2
+000175e0: 203d 2072 6377 7431 5b69 6672 6571 5d2c   = rcwt1[ifreq],
+000175f0: 2072 6377 7432 5b69 6672 6571 5d0a 0a20   rcwt2[ifreq].. 
+00017600: 2020 2020 2020 2020 2020 2023 204e 6f72             # Nor
+00017610: 6d61 6c69 7a65 7320 626f 7468 2073 6967  malizes both sig
+00017620: 6e61 6c73 2c20 6966 2061 7070 726f 7072  nals, if appropr
+00017630: 6961 7465 2e0a 2020 2020 2020 2020 2020  iate..          
+00017640: 2020 6966 206e 6f72 6d61 6c69 7a65 3a0a    if normalize:.
+00017650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017660: 6e63 7774 3120 3d20 2877 6377 7431 202d  ncwt1 = (wcwt1 -
+00017670: 2077 6377 7431 2e6d 6561 6e28 2929 202f   wcwt1.mean()) /
+00017680: 2077 6377 7431 2e73 7464 2829 0a20 2020   wcwt1.std().   
+00017690: 2020 2020 2020 2020 2020 2020 206e 6377               ncw
+000176a0: 7432 203d 2028 7763 7774 3220 2d20 7763  t2 = (wcwt2 - wc
+000176b0: 7774 322e 6d65 616e 2829 2920 2f20 7763  wt2.mean()) / wc
+000176c0: 7774 322e 7374 6428 290a 2020 2020 2020  wt2.std().      
+000176d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000176e0: 2020 2020 2020 2020 2020 2020 6e63 7774              ncwt
+000176f0: 3120 3d20 7763 7774 310a 2020 2020 2020  1 = wcwt1.      
+00017700: 2020 2020 2020 2020 2020 6e63 7774 3220            ncwt2 
+00017710: 3d20 7763 7774 320a 0a20 2020 2020 2020  = wcwt2..       
+00017720: 2020 2020 2023 2072 756e 2073 7472 6574       # run stret
+00017730: 6368 696e 670a 2020 2020 2020 2020 2020  ching.          
+00017740: 2020 6476 2c20 6572 726f 722c 2063 312c    dv, error, c1,
+00017750: 2063 3220 3d20 7374 7265 7463 6869 6e67   c2 = stretching
+00017760: 286e 6377 7432 2c20 6e63 7774 312c 2064  (ncwt2, ncwt1, d
+00017770: 765f 7261 6e67 652c 206e 6274 7269 616c  v_range, nbtrial
+00017780: 2c20 7061 7261 290a 2020 2020 2020 2020  , para).        
+00017790: 2020 2020 6476 765b 6969 5d2c 2063 635b      dvv[ii], cc[
+000177a0: 6969 5d2c 2063 6470 5b69 695d 2c20 6572  ii], cdp[ii], er
+000177b0: 725b 6969 5d20 3d20 6476 2c20 6331 2c20  r[ii] = dv, c1, 
+000177c0: 6332 2c20 6572 726f 720a 0a20 2020 2020  c2, error..     
+000177d0: 2020 2072 6574 7572 6e20 6672 6571 5b66     return freq[f
+000177e0: 7265 715f 696e 6469 6e5d 2c20 6476 762c  req_indin], dvv,
+000177f0: 2065 7272 0a0a 0a64 6566 2077 7464 7477   err...def wtdtw
+00017800: 5f61 6c6c 6672 6571 280a 2020 2020 7265  _allfreq(.    re
+00017810: 662c 0a20 2020 2063 7572 2c0a 2020 2020  f,.    cur,.    
+00017820: 616c 6c66 7265 712c 0a20 2020 2070 6172  allfreq,.    par
+00017830: 612c 0a20 2020 206d 6178 4c61 672c 0a20  a,.    maxLag,. 
+00017840: 2020 2062 2c0a 2020 2020 6469 7265 6374     b,.    direct
+00017850: 696f 6e2c 0a20 2020 2064 6a3d 3120 2f20  ion,.    dj=1 / 
+00017860: 3132 2c0a 2020 2020 7330 3d2d 312c 0a20  12,.    s0=-1,. 
+00017870: 2020 204a 3d2d 312c 0a20 2020 2077 766e     J=-1,.    wvn
+00017880: 3d22 6d6f 726c 6574 222c 0a20 2020 206e  ="morlet",.    n
+00017890: 6f72 6d61 6c69 7a65 3d54 7275 652c 0a29  ormalize=True,.)
+000178a0: 3a0a 2020 2020 2222 220a 2020 2020 4170  :.    """.    Ap
+000178b0: 706c 7920 6479 6e61 6d69 6320 7469 6d65  ply dynamic time
+000178c0: 2077 6172 7069 6e67 206d 6574 686f 6420   warping method 
+000178d0: 746f 2063 6f6e 7469 6e75 6f75 7320 7761  to continuous wa
+000178e0: 7665 6c65 7420 7472 616e 7366 6f72 6d61  velet transforma
+000178f0: 7469 6f6e 2028 4357 5429 206f 6620 7369  tion (CWT) of si
+00017900: 676e 616c 730a 2020 2020 666f 7220 616c  gnals.    for al
+00017910: 6c20 6672 6571 7565 6369 6573 2069 6e20  l frequecies in 
+00017920: 616e 2069 6e74 6572 6573 7420 7261 6e67  an interest rang
+00017930: 650a 0a20 2020 2050 6172 616d 6574 6572  e..    Parameter
+00017940: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00017950: 2d2d 2d2d 0a20 2020 2072 6566 3a20 5468  ----.    ref: Th
+00017960: 6520 2252 6566 6572 656e 6365 2220 7469  e "Reference" ti
+00017970: 6d65 7365 7269 6573 2028 6e75 6d70 792e  meseries (numpy.
+00017980: 6e64 6172 7261 7929 0a20 2020 2063 7572  ndarray).    cur
+00017990: 3a20 5468 6520 2243 7572 7265 6e74 2220  : The "Current" 
+000179a0: 7469 6d65 7365 7269 6573 2028 6e75 6d70  timeseries (nump
+000179b0: 792e 6e64 6172 7261 7929 0a20 2020 2061  y.ndarray).    a
+000179c0: 6c6c 6672 6571 3a20 6120 626f 6f6c 656e  llfreq: a boolen
+000179d0: 2076 6172 6961 626c 6520 746f 206d 616b   variable to mak
+000179e0: 6520 6d65 6173 7572 656d 656e 7473 206f  e measurements o
+000179f0: 6e20 616c 6c20 6672 6571 7565 6e63 7920  n all frequency 
+00017a00: 7261 6e67 6520 6f72 206e 6f74 0a20 2020  range or not.   
+00017a10: 206d 6178 4c61 673a 206d 6178 206e 756d   maxLag: max num
+00017a20: 6265 7220 6f66 2070 6f69 6e74 7320 746f  ber of points to
+00017a30: 2073 6561 7263 6820 666f 7277 6172 6420   search forward 
+00017a40: 616e 6420 6261 636b 7761 7264 2e0a 2020  and backward..  
+00017a50: 2020 623a 2062 2d76 616c 7565 2074 6f20    b: b-value to 
+00017a60: 6c69 6d69 7420 7374 7261 696e 2c20 7768  limit strain, wh
+00017a70: 6963 6820 6973 2074 6f20 6c69 6d69 7420  ich is to limit 
+00017a80: 7468 6520 6d61 7869 6d75 6d20 7665 6c6f  the maximum velo
+00017a90: 6369 7479 2070 6572 7475 7262 6174 696f  city perturbatio
+00017aa0: 6e2e 0a20 2020 2053 6565 2065 7175 6174  n..    See equat
+00017ab0: 696f 6e20 3131 2069 6e20 284d 696b 6573  ion 11 in (Mikes
+00017ac0: 656c 6c20 6574 2061 6c2e 2032 3031 3529  ell et al. 2015)
+00017ad0: 0a20 2020 2064 6972 6563 7469 6f6e 3a20  .    direction: 
+00017ae0: 6469 7265 6374 696f 6e20 746f 2061 6363  direction to acc
+00017af0: 756d 756c 6174 6520 6572 726f 7273 2028  umulate errors (
+00017b00: 313d 666f 7277 6172 642c 202d 313d 6261  1=forward, -1=ba
+00017b10: 636b 7761 7264 290a 2020 2020 646a 2c20  ckward).    dj, 
+00017b20: 7330 2c20 4a2c 2073 6967 2c20 7776 6e3a  s0, J, sig, wvn:
+00017b30: 2063 6f6d 6d6f 6e20 7061 7261 6d65 7465   common paramete
+00017b40: 7273 2075 7365 6420 696e 2027 7761 7665  rs used in 'wave
+00017b50: 6c65 742e 7763 7427 0a20 2020 206e 6f72  let.wct'.    nor
+00017b60: 6d61 6c69 7a65 3a20 6e6f 726d 616c 697a  malize: normaliz
+00017b70: 6520 7468 6520 7761 7665 6c65 7420 7370  e the wavelet sp
+00017b80: 6563 7472 756d 206f 7220 6e6f 742e 2044  ectrum or not. D
+00017b90: 6566 6175 6c74 2069 7320 5472 7565 0a0a  efault is True..
+00017ba0: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
+00017bb0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
+00017bc0: 2d2d 2d0a 2020 2020 6476 763a 2065 7374  ---.    dvv: est
+00017bd0: 696d 6174 6564 2064 762f 760a 2020 2020  imated dv/v.    
+00017be0: 6572 723a 2065 7272 6f72 206f 6620 6476  err: error of dv
+00017bf0: 2f76 2065 7374 696d 6174 696f 6e0a 0a20  /v estimation.. 
+00017c00: 2020 2057 7269 7474 656e 2062 7920 436f     Written by Co
+00017c10: 6e67 636f 6e67 2059 7561 6e20 2833 3020  ngcong Yuan (30 
+00017c20: 4a75 6e2c 2032 3031 3929 0a20 2020 2022  Jun, 2019).    "
+00017c30: 2222 0a20 2020 2023 2063 6f6d 6d6f 6e20  "".    # common 
+00017c40: 7661 7269 6162 6c65 730a 2020 2020 6672  variables.    fr
+00017c50: 6571 203d 2070 6172 615b 2266 7265 7122  eq = para["freq"
+00017c60: 5d0a 2020 2020 6474 203d 2070 6172 615b  ].    dt = para[
+00017c70: 2264 7422 5d0a 2020 2020 666d 696e 203d  "dt"].    fmin =
+00017c80: 206e 702e 6d69 6e28 6672 6571 290a 2020   np.min(freq).  
+00017c90: 2020 666d 6178 203d 206e 702e 6d61 7828    fmax = np.max(
+00017ca0: 6672 6571 290a 0a20 2020 2023 2061 7070  freq)..    # app
+00017cb0: 6c79 2063 7774 206f 6e20 7477 6f20 7472  ly cwt on two tr
+00017cc0: 6163 6573 0a20 2020 2063 7774 312c 2073  aces.    cwt1, s
+00017cd0: 6a2c 2066 7265 712c 2063 6f69 2c20 5f2c  j, freq, coi, _,
+00017ce0: 205f 203d 2070 7963 7774 2e63 7774 2863   _ = pycwt.cwt(c
+00017cf0: 7572 2c20 6474 2c20 646a 2c20 7330 2c20  ur, dt, dj, s0, 
+00017d00: 4a2c 2077 766e 290a 2020 2020 6377 7432  J, wvn).    cwt2
+00017d10: 2c20 736a 2c20 6672 6571 2c20 636f 692c  , sj, freq, coi,
+00017d20: 205f 2c20 5f20 3d20 7079 6377 742e 6377   _, _ = pycwt.cw
+00017d30: 7428 7265 662c 2064 742c 2064 6a2c 2073  t(ref, dt, dj, s
+00017d40: 302c 204a 2c20 7776 6e29 0a0a 2020 2020  0, J, wvn)..    
+00017d50: 2320 6578 7472 6163 7420 7265 616c 2076  # extract real v
+00017d60: 616c 7565 7320 6f66 2063 7774 0a20 2020  alues of cwt.   
+00017d70: 2072 6377 7431 2c20 7263 7774 3220 3d20   rcwt1, rcwt2 = 
+00017d80: 6e70 2e72 6561 6c28 6377 7431 292c 206e  np.real(cwt1), n
+00017d90: 702e 7265 616c 2863 7774 3229 0a0a 2020  p.real(cwt2)..  
+00017da0: 2020 2320 7a65 726f 206f 7574 2063 6f6e    # zero out con
+00017db0: 6520 6f66 2069 6e66 6c75 656e 6365 2061  e of influence a
+00017dc0: 6e64 2064 6174 6120 6f75 7473 6964 6520  nd data outside 
+00017dd0: 6672 6571 7565 6e63 7920 6261 6e64 0a20  frequency band. 
+00017de0: 2020 2069 6620 2866 6d61 7820 3e20 6e70     if (fmax > np
+00017df0: 2e6d 6178 2866 7265 7129 2920 7c20 2866  .max(freq)) | (f
+00017e00: 6d61 7820 3c3d 2066 6d69 6e29 3a0a 2020  max <= fmin):.  
+00017e10: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00017e20: 6545 7272 6f72 2822 4162 6f72 743a 2069  eError("Abort: i
+00017e30: 6e70 7574 2066 7265 7175 656e 6379 206f  nput frequency o
+00017e40: 7574 206f 6620 6c69 6d69 7473 2122 290a  ut of limits!").
+00017e50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00017e60: 2020 6672 6571 5f69 6e64 696e 203d 206e    freq_indin = n
+00017e70: 702e 7768 6572 6528 2866 7265 7120 3e3d  p.where((freq >=
+00017e80: 2066 6d69 6e29 2026 2028 6672 6571 203c   fmin) & (freq <
+00017e90: 3d20 666d 6178 2929 5b30 5d0a 0a20 2020  = fmax))[0]..   
+00017ea0: 2020 2020 2023 2055 7365 2044 5457 206d       # Use DTW m
+00017eb0: 6574 686f 6420 746f 2065 7874 7261 6374  ethod to extract
+00017ec0: 2064 7676 0a20 2020 2020 2020 206e 6672   dvv.        nfr
+00017ed0: 6571 203d 206c 656e 2866 7265 715f 696e  eq = len(freq_in
+00017ee0: 6469 6e29 0a20 2020 2020 2020 2064 7676  din).        dvv
+00017ef0: 2c20 6572 7220 3d20 6e70 2e7a 6572 6f73  , err = np.zeros
+00017f00: 286e 6672 6571 2c20 6474 7970 653d 6e70  (nfreq, dtype=np
+00017f10: 2e66 6c6f 6174 3332 292c 206e 702e 7a65  .float32), np.ze
+00017f20: 726f 7328 6e66 7265 712c 2064 7479 7065  ros(nfreq, dtype
+00017f30: 3d6e 702e 666c 6f61 7433 3229 0a0a 2020  =np.float32)..  
+00017f40: 2020 2020 2020 666f 7220 6969 2c20 6966        for ii, if
+00017f50: 7265 7120 696e 2065 6e75 6d65 7261 7465  req in enumerate
+00017f60: 2866 7265 715f 696e 6469 6e29 3a0a 2020  (freq_indin):.  
+00017f70: 2020 2020 2020 2020 2020 2320 7072 6570            # prep
+00017f80: 6172 6520 7769 6e64 6f77 6564 2064 6174  are windowed dat
+00017f90: 610a 2020 2020 2020 2020 2020 2020 7763  a.            wc
+00017fa0: 7774 312c 2077 6377 7432 203d 2072 6377  wt1, wcwt2 = rcw
+00017fb0: 7431 5b69 6672 6571 5d2c 2072 6377 7432  t1[ifreq], rcwt2
+00017fc0: 5b69 6672 6571 5d0a 2020 2020 2020 2020  [ifreq].        
+00017fd0: 2020 2020 2320 4e6f 726d 616c 697a 6573      # Normalizes
+00017fe0: 2062 6f74 6820 7369 676e 616c 732c 2069   both signals, i
+00017ff0: 6620 6170 7072 6f70 7269 6174 652e 0a20  f appropriate.. 
+00018000: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00018010: 726d 616c 697a 653a 0a20 2020 2020 2020  rmalize:.       
+00018020: 2020 2020 2020 2020 206e 6377 7431 203d           ncwt1 =
+00018030: 2028 7763 7774 3120 2d20 7763 7774 312e   (wcwt1 - wcwt1.
+00018040: 6d65 616e 2829 2920 2f20 7763 7774 312e  mean()) / wcwt1.
+00018050: 7374 6428 290a 2020 2020 2020 2020 2020  std().          
+00018060: 2020 2020 2020 6e63 7774 3220 3d20 2877        ncwt2 = (w
+00018070: 6377 7432 202d 2077 6377 7432 2e6d 6561  cwt2 - wcwt2.mea
+00018080: 6e28 2929 202f 2077 6377 7432 2e73 7464  n()) / wcwt2.std
+00018090: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+000180a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000180b0: 2020 2020 206e 6377 7431 203d 2077 6377       ncwt1 = wcw
+000180c0: 7431 0a20 2020 2020 2020 2020 2020 2020  t1.             
+000180d0: 2020 206e 6377 7432 203d 2077 6377 7432     ncwt2 = wcwt2
+000180e0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+000180f0: 7275 6e20 6474 770a 2020 2020 2020 2020  run dtw.        
+00018100: 2020 2020 6476 2c20 6572 726f 722c 2064      dv, error, d
+00018110: 6973 7420 3d20 6474 775f 6476 7628 6e63  ist = dtw_dvv(nc
+00018120: 7774 322c 206e 6377 7431 2c20 7061 7261  wt2, ncwt1, para
+00018130: 2c20 6d61 784c 6167 2c20 622c 2064 6972  , maxLag, b, dir
+00018140: 6563 7469 6f6e 290a 2020 2020 2020 2020  ection).        
+00018150: 2020 2020 6476 765b 6969 5d2c 2065 7272      dvv[ii], err
+00018160: 5b69 695d 203d 2064 762c 2065 7272 6f72  [ii] = dv, error
+00018170: 0a0a 2020 2020 6465 6c20 6377 7431 2c20  ..    del cwt1, 
+00018180: 6377 7432 2c20 7263 7774 312c 2072 6377  cwt2, rcwt1, rcw
+00018190: 7432 2c20 6e63 7774 312c 206e 6377 7432  t2, ncwt1, ncwt2
+000181a0: 2c20 7763 7774 312c 2077 6377 7432 2c20  , wcwt1, wcwt2, 
+000181b0: 636f 692c 2073 6a2c 2064 6973 740a 0a20  coi, sj, dist.. 
+000181c0: 2020 2069 6620 6e6f 7420 616c 6c66 7265     if not allfre
+000181d0: 713a 0a20 2020 2020 2020 2072 6574 7572  q:.        retur
+000181e0: 6e20 6e70 2e6d 6561 6e28 6476 7629 2c20  n np.mean(dvv), 
+000181f0: 6e70 2e6d 6561 6e28 6572 7229 0a20 2020  np.mean(err).   
+00018200: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
+00018210: 6574 7572 6e20 6672 6571 5b66 7265 715f  eturn freq[freq_
+00018220: 696e 6469 6e5d 2c20 6476 762c 2065 7272  indin], dvv, err
+00018230: 0a0a 0a23 2323 2323 2323 2323 2323 2323  ...#############
+00018240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018260: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018270: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
+00018280: 2320 4d4f 4e49 544f 5249 4e47 2055 5449  # MONITORING UTI
+00018290: 4c49 5459 2046 554e 4354 494f 4e53 2023  LITY FUNCTIONS #
+000182a0: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
 000182b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000182c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000182d0: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
-000182e0: 2323 2323 2323 2323 2323 2323 2320 4d4f  ############# MO
-000182f0: 4e49 544f 5249 4e47 2055 5449 4c49 5459  NITORING UTILITY
-00018300: 2046 554e 4354 494f 4e53 2023 2323 2323   FUNCTIONS #####
-00018310: 2323 2323 2323 2323 2323 0a23 2323 2323  ##########.#####
-00018320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018350: 2323 2323 2323 2323 0a0a 2222 220a 6265  ########..""".be
-00018360: 6c6f 7720 6172 6520 6173 7365 6d62 6c79  low are assembly
-00018370: 206f 6620 7468 6520 6d6f 6e69 746f 7269   of the monitori
-00018380: 6e67 2075 7469 6c69 7479 2066 756e 6374  ng utility funct
-00018390: 696f 6e73 2063 616c 6c65 6420 6279 206d  ions called by m
-000183a0: 6f6e 6974 6f72 696e 6720 6675 6e63 7469  onitoring functi
-000183b0: 6f6e 730a 2222 220a 0a0a 6465 6620 736d  ons."""...def sm
-000183c0: 6f6f 7468 2878 2c20 7769 6e64 6f77 3d22  ooth(x, window="
-000183d0: 626f 7863 6172 222c 2068 616c 665f 7769  boxcar", half_wi
-000183e0: 6e3d 3329 3a0a 2020 2020 2222 220a 2020  n=3):.    """.  
-000183f0: 2020 7065 7266 6f72 6d73 2073 6d6f 6f74    performs smoot
-00018400: 6869 6e67 2069 6e20 696e 7465 7265 7374  hing in interest
-00018410: 6564 2074 696d 6520 7769 6e64 6f77 0a0a  ed time window..
-00018420: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00018430: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
-00018440: 2d0a 2020 2020 783a 2074 696d 6573 6572  -.    x: timeser
-00018450: 6973 2064 6174 610a 2020 2020 7769 6e64  is data.    wind
-00018460: 6f77 3a20 7479 7065 7320 6f66 2077 696e  ow: types of win
-00018470: 646f 7720 746f 2064 6f20 736d 6f6f 7468  dow to do smooth
-00018480: 696e 670a 2020 2020 6861 6c66 5f77 696e  ing.    half_win
-00018490: 3a20 6861 6c66 2077 696e 646f 7720 6c65  : half window le
-000184a0: 6e67 7468 0a0a 2020 2020 5245 5455 524e  ngth..    RETURN
-000184b0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-000184c0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 793a  ---------.    y:
-000184d0: 2073 6d6f 6f74 6865 6420 7469 6d65 2077   smoothed time w
-000184e0: 696e 646f 770a 2020 2020 2222 220a 2020  indow.    """.  
-000184f0: 2020 2320 544f 444f 3a20 646f 6373 7469    # TODO: docsti
-00018500: 6e67 0a20 2020 2077 696e 646f 775f 6c65  ng.    window_le
-00018510: 6e20 3d20 3220 2a20 6861 6c66 5f77 696e  n = 2 * half_win
-00018520: 202b 2031 0a20 2020 2023 2065 7874 656e   + 1.    # exten
-00018530: 6469 6e67 2074 6865 2064 6174 6120 6174  ding the data at
-00018540: 2062 6567 696e 6e69 6e67 2061 6e64 2061   beginning and a
-00018550: 7420 7468 6520 656e 640a 2020 2020 2320  t the end.    # 
-00018560: 746f 2061 7070 6c79 2074 6865 2077 696e  to apply the win
-00018570: 646f 7720 6174 2074 6865 2062 6f72 6465  dow at the borde
-00018580: 7273 0a20 2020 2073 203d 206e 702e 725f  rs.    s = np.r_
-00018590: 5b78 5b77 696e 646f 775f 6c65 6e20 2d20  [x[window_len - 
-000185a0: 3120 3a20 3020 3a20 2d31 5d2c 2078 2c20  1 : 0 : -1], x, 
-000185b0: 785b 2d31 3a2d 7769 6e64 6f77 5f6c 656e  x[-1:-window_len
-000185c0: 3a2d 315d 5d0a 2020 2020 6966 2077 696e  :-1]].    if win
-000185d0: 646f 7720 3d3d 2022 626f 7863 6172 223a  dow == "boxcar":
-000185e0: 0a20 2020 2020 2020 2077 203d 2073 6369  .        w = sci
-000185f0: 7079 2e73 6967 6e61 6c2e 626f 7863 6172  py.signal.boxcar
-00018600: 2877 696e 646f 775f 6c65 6e29 2e61 7374  (window_len).ast
-00018610: 7970 6528 2263 6f6d 706c 6578 2229 0a20  ype("complex"). 
-00018620: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00018630: 2077 203d 2073 6369 7079 2e73 6967 6e61   w = scipy.signa
-00018640: 6c2e 6861 6e6e 696e 6728 7769 6e64 6f77  l.hanning(window
-00018650: 5f6c 656e 292e 6173 7479 7065 2822 636f  _len).astype("co
-00018660: 6d70 6c65 7822 290a 2020 2020 7920 3d20  mplex").    y = 
-00018670: 6e70 2e63 6f6e 766f 6c76 6528 7720 2f20  np.convolve(w / 
-00018680: 772e 7375 6d28 292c 2073 2c20 6d6f 6465  w.sum(), s, mode
-00018690: 3d22 7661 6c69 6422 290a 2020 2020 7265  ="valid").    re
-000186a0: 7475 726e 2079 5b68 616c 665f 7769 6e20  turn y[half_win 
-000186b0: 3a20 6c65 6e28 7929 202d 2068 616c 665f  : len(y) - half_
-000186c0: 7769 6e5d 0a0a 0a64 6566 206e 6578 7470  win]...def nextp
-000186d0: 6f77 3228 7829 3a0a 2020 2020 2222 220a  ow2(x):.    """.
-000186e0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
-000186f0: 6e65 7874 2070 6f77 6572 206f 6620 3220  next power of 2 
-00018700: 6f66 2078 2e0a 2020 2020 2222 220a 2020  of x..    """.  
-00018710: 2020 7265 7475 726e 2069 6e74 286e 702e    return int(np.
-00018720: 6365 696c 286e 702e 6c6f 6732 286e 702e  ceil(np.log2(np.
-00018730: 6162 7328 7829 2929 290a 0a0a 6465 6620  abs(x))))...def 
-00018740: 6765 7443 6f68 6572 656e 6365 2864 6373  getCoherence(dcs
-00018750: 2c20 6473 312c 2064 7332 293a 0a20 2020  , ds1, ds2):.   
-00018760: 2022 2222 0a20 2020 2067 6574 2063 726f   """.    get cro
-00018770: 7373 2063 6f68 6572 656e 6365 2062 6574  ss coherence bet
-00018780: 7765 656e 2072 6566 6572 656e 6365 2061  ween reference a
-00018790: 6e64 2063 7572 7265 6e74 2077 6176 6566  nd current wavef
-000187a0: 6f72 6d73 2066 6f6c 6c6f 7769 6e67 2065  orms following e
-000187b0: 7175 6174 696f 6e20 6f66 2041 3320 696e  quation of A3 in
-000187c0: 2043 6c61 726b 2065 7420 616c 2e2c 2032   Clark et al., 2
-000187d0: 3031 310a 0a20 2020 2050 6172 616d 6574  011..    Paramet
-000187e0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000187f0: 2d2d 2d2d 2d2d 0a20 2020 2064 6373 3a20  ------.    dcs: 
-00018800: 616d 706c 6974 7564 6520 6f66 2074 6865  amplitude of the
-00018810: 2063 726f 7373 2073 7065 6374 7275 6d0a   cross spectrum.
-00018820: 2020 2020 6473 313a 2061 6d70 6c69 7475      ds1: amplitu
-00018830: 6465 206f 6620 7468 6520 7370 6563 7472  de of the spectr
-00018840: 756d 206f 6620 6375 7272 656e 7420 7761  um of current wa
-00018850: 7665 666f 726d 0a20 2020 2064 7332 3a20  veform.    ds2: 
-00018860: 616d 706c 6974 7564 6520 6f66 2074 6865  amplitude of the
-00018870: 2073 7065 6374 7275 6d20 6f66 2072 6566   spectrum of ref
-00018880: 6572 656e 6365 2077 6176 6566 6f72 6d0a  erence waveform.
-00018890: 0a20 2020 2052 4554 5552 4e53 3a0a 2020  .    RETURNS:.  
-000188a0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
-000188b0: 2d2d 2d2d 0a20 2020 2063 6f68 3a20 636f  ----.    coh: co
-000188c0: 6872 6572 656e 6379 206d 6174 7269 7820  hrerency matrix 
-000188d0: 7573 6564 2066 6f72 2065 7374 696d 6174  used for estimat
-000188e0: 6520 7468 6520 726f 6275 7374 6e65 7373  e the robustness
-000188f0: 206f 6620 7468 6520 6372 6f73 7320 7370   of the cross sp
-00018900: 6563 7472 756d 0a20 2020 2022 2222 0a20  ectrum.    """. 
-00018910: 2020 206e 203d 206c 656e 2864 6373 290a     n = len(dcs).
-00018920: 2020 2020 636f 6820 3d20 6e70 2e7a 6572      coh = np.zer
-00018930: 6f73 286e 292e 6173 7479 7065 2822 636f  os(n).astype("co
-00018940: 6d70 6c65 7822 290a 2020 2020 7661 6c69  mplex").    vali
-00018950: 6473 203d 206e 702e 6172 6777 6865 7265  ds = np.argwhere
-00018960: 286e 702e 6c6f 6769 6361 6c5f 616e 6428  (np.logical_and(
-00018970: 6e70 2e61 6273 2864 7331 2920 3e20 302c  np.abs(ds1) > 0,
-00018980: 206e 702e 6162 7328 6473 3229 203e 2030   np.abs(ds2) > 0
-00018990: 2929 0a20 2020 2063 6f68 5b76 616c 6964  )).    coh[valid
-000189a0: 735d 203d 2064 6373 5b76 616c 6964 735d  s] = dcs[valids]
-000189b0: 202f 2028 6473 315b 7661 6c69 6473 5d20   / (ds1[valids] 
-000189c0: 2a20 6473 325b 7661 6c69 6473 5d29 0a20  * ds2[valids]). 
-000189d0: 2020 2063 6f68 5b63 6f68 203e 2028 312e     coh[coh > (1.
-000189e0: 3020 2b20 306a 295d 203d 2031 2e30 202b  0 + 0j)] = 1.0 +
-000189f0: 2030 6a0a 2020 2020 7265 7475 726e 2063   0j.    return c
-00018a00: 6f68 0a0a 0a64 6566 2063 6f6d 7075 7465  oh...def compute
-00018a10: 4572 726f 7246 756e 6374 696f 6e28 7531  ErrorFunction(u1
-00018a20: 2c20 7530 2c20 6e53 616d 706c 652c 206c  , u0, nSample, l
-00018a30: 6167 2c20 6e6f 726d 3d22 4c32 2229 3a0a  ag, norm="L2"):.
-00018a40: 2020 2020 2222 220a 2020 2020 636f 6d70      """.    comp
-00018a50: 7574 6520 4572 726f 7220 4675 6e63 7469  ute Error Functi
-00018a60: 6f6e 2075 7365 6420 696e 2044 5457 2e20  on used in DTW. 
-00018a70: 5468 6520 6572 726f 7220 6675 6e63 7469  The error functi
-00018a80: 6f6e 2069 7320 6571 7561 7469 6f6e 2031  on is equation 1
-00018a90: 2069 6e20 4861 6c65 2c20 3230 3133 2e20   in Hale, 2013. 
-00018aa0: 596f 7520 636f 756c 6420 756e 636f 6d6d  You could uncomm
-00018ab0: 656e 7420 7468 650a 2020 2020 4c31 206e  ent the.    L1 n
-00018ac0: 6f72 6d20 616e 6420 636f 6d6d 656e 7420  orm and comment 
-00018ad0: 7468 6520 4c32 206e 6f72 6d20 6966 2079  the L2 norm if y
-00018ae0: 6f75 2077 616e 7420 6f6e 204c 696e 6520  ou want on Line 
-00018af0: 3239 0a0a 2020 2020 5061 7261 6d65 7465  29..    Paramete
-00018b00: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00018b10: 2d2d 2d2d 2d0a 2020 2020 7531 3a20 2074  -----.    u1:  t
-00018b20: 7261 6365 2074 6861 7420 7765 2077 616e  race that we wan
-00018b30: 7420 746f 2077 6172 703b 2073 697a 6520  t to warp; size 
-00018b40: 3d20 286e 7361 6d70 2c31 290a 2020 2020  = (nsamp,1).    
-00018b50: 7530 3a20 2072 6566 6572 656e 6365 2074  u0:  reference t
-00018b60: 7261 6365 2074 6f20 636f 6d70 6172 6520  race to compare 
-00018b70: 7769 7468 3a20 7369 7a65 203d 2028 6e73  with: size = (ns
-00018b80: 616d 702c 3129 0a20 2020 206e 5361 6d70  amp,1).    nSamp
-00018b90: 6c65 3a20 6e75 6d65 7220 6f66 2070 6f69  le: numer of poi
-00018ba0: 6e74 7320 746f 2063 6f6d 7061 7265 2069  nts to compare i
-00018bb0: 6e20 7468 6520 7472 6163 6573 0a20 2020  n the traces.   
-00018bc0: 206c 6167 3a20 6d61 7869 6d75 6d20 6c61   lag: maximum la
-00018bd0: 6720 696e 2073 616d 706c 6520 6e75 6d62  g in sample numb
-00018be0: 6572 2074 6f20 7365 6172 6368 0a20 2020  er to search.   
-00018bf0: 206e 6f72 6d3a 2027 4c32 2720 6f72 2027   norm: 'L2' or '
-00018c00: 4c31 2720 2864 6566 6175 6c74 2069 7320  L1' (default is 
-00018c10: 274c 3227 290a 0a20 2020 2052 4554 5552  'L2')..    RETUR
-00018c20: 4e53 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d  NS:.    --------
-00018c30: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2065  ----------.    e
-00018c40: 7272 3a20 7468 6520 3244 2065 7272 6f72  rr: the 2D error
-00018c50: 2066 756e 6374 696f 6e3b 2073 697a 6520   function; size 
-00018c60: 3d20 286e 7361 6d70 2c32 2a6c 6167 2b31  = (nsamp,2*lag+1
-00018c70: 290a 0a20 2020 204f 7269 6769 6e61 6c20  )..    Original 
-00018c80: 6279 2044 6920 5961 6e67 0a20 2020 204c  by Di Yang.    L
-00018c90: 6173 7420 6d6f 6469 6669 6564 2062 7920  ast modified by 
-00018ca0: 4479 6c61 6e20 4d69 6b65 7365 6c6c 2028  Dylan Mikesell (
-00018cb0: 3235 2046 6562 2e20 3230 3135 290a 2020  25 Feb. 2015).  
-00018cc0: 2020 5472 616e 736c 6174 6564 2074 6f20    Translated to 
-00018cd0: 7079 7468 6f6e 2062 7920 5469 6d20 436c  python by Tim Cl
-00018ce0: 656d 656e 7473 2028 3137 2041 7567 2e20  ements (17 Aug. 
-00018cf0: 3230 3138 290a 0a20 2020 2022 2222 0a0a  2018)..    """..
-00018d00: 2020 2020 6966 206c 6167 203e 3d20 6e53      if lag >= nS
-00018d10: 616d 706c 653a 0a20 2020 2020 2020 2072  ample:.        r
-00018d20: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00018d30: 2263 6f6d 7075 7465 4572 726f 7246 756e  "computeErrorFun
-00018d40: 6374 696f 6e3a 6c61 6750 726f 626c 656d  ction:lagProblem
-00018d50: 222c 2022 6c61 6720 6d75 7374 2062 6520  ", "lag must be 
-00018d60: 736d 616c 6c65 7220 7468 616e 206e 5361  smaller than nSa
-00018d70: 6d70 6c65 2229 0a0a 2020 2020 2320 416c  mple")..    # Al
-00018d80: 6c6f 6361 7465 2065 7272 6f72 2066 756e  locate error fun
-00018d90: 6374 696f 6e20 7661 7269 6162 6c65 0a20  ction variable. 
-00018da0: 2020 2065 7272 203d 206e 702e 7a65 726f     err = np.zero
-00018db0: 7328 5b6e 5361 6d70 6c65 2c20 3220 2a20  s([nSample, 2 * 
-00018dc0: 6c61 6720 2b20 315d 290a 0a20 2020 2023  lag + 1])..    #
-00018dd0: 2069 6e69 7469 616c 2065 7272 6f72 2063   initial error c
-00018de0: 616c 6375 6c61 7469 6f6e 0a20 2020 2023  alculation.    #
-00018df0: 206c 6f6f 7020 6f76 6572 206c 6167 730a   loop over lags.
-00018e00: 2020 2020 666f 7220 6c6c 2069 6e20 6e70      for ll in np
-00018e10: 2e61 7261 6e67 6528 2d6c 6167 2c20 6c61  .arange(-lag, la
-00018e20: 6720 2b20 3129 3a0a 2020 2020 2020 2020  g + 1):.        
-00018e30: 7468 6973 4c61 6720 3d20 6c6c 202b 206c  thisLag = ll + l
-00018e40: 6167 0a0a 2020 2020 2020 2020 2320 6c6f  ag..        # lo
-00018e50: 6f70 206f 7665 7220 7361 6d70 6c65 730a  op over samples.
-00018e60: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00018e70: 6e20 7261 6e67 6528 6e53 616d 706c 6529  n range(nSample)
-00018e80: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00018e90: 736b 6970 2063 6f72 6e65 7273 2066 6f72  skip corners for
-00018ea0: 206e 6f77 2c20 7765 2077 696c 6c20 636f   now, we will co
-00018eb0: 6d65 2062 6163 6b20 746f 2074 6865 7365  me back to these
-00018ec0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00018ed0: 2869 6920 2b20 6c6c 203e 3d20 3029 2026  (ii + ll >= 0) &
-00018ee0: 2028 6969 202b 206c 6c20 3c20 6e53 616d   (ii + ll < nSam
-00018ef0: 706c 6529 3a0a 2020 2020 2020 2020 2020  ple):.          
-00018f00: 2020 2020 2020 6572 725b 6969 2c20 7468        err[ii, th
-00018f10: 6973 4c61 675d 203d 2075 315b 6969 5d20  isLag] = u1[ii] 
-00018f20: 2d20 7530 5b69 6920 2b20 6c6c 5d0a 0a20  - u0[ii + ll].. 
-00018f30: 2020 2069 6620 6e6f 726d 203d 3d20 224c     if norm == "L
-00018f40: 3222 3a0a 2020 2020 2020 2020 6572 7220  2":.        err 
-00018f50: 3d20 6572 722a 2a32 0a20 2020 2065 6c69  = err**2.    eli
-00018f60: 6620 6e6f 726d 203d 3d20 224c 3122 3a0a  f norm == "L1":.
-00018f70: 2020 2020 2020 2020 6572 7220 3d20 6e70          err = np
-00018f80: 2e61 6273 2865 7272 290a 0a20 2020 2023  .abs(err)..    #
-00018f90: 204e 6f77 2066 6978 2063 6f72 6e65 7273   Now fix corners
-00018fa0: 2077 6974 6820 636f 6e73 7461 6e74 2065   with constant e
-00018fb0: 7874 7261 706f 6c61 7469 6f6e 0a20 2020  xtrapolation.   
-00018fc0: 2066 6f72 206c 6c20 696e 206e 702e 6172   for ll in np.ar
-00018fd0: 616e 6765 282d 6c61 672c 206c 6167 202b  ange(-lag, lag +
-00018fe0: 2031 293a 0a20 2020 2020 2020 2074 6869   1):.        thi
-00018ff0: 734c 6167 203d 206c 6c20 2b20 6c61 670a  sLag = ll + lag.
-00019000: 0a20 2020 2020 2020 2066 6f72 2069 6920  .        for ii 
-00019010: 696e 2072 616e 6765 286e 5361 6d70 6c65  in range(nSample
-00019020: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-00019030: 6620 6969 202b 206c 6c20 3c20 303a 0a20  f ii + ll < 0:. 
-00019040: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00019050: 7272 5b69 692c 2074 6869 734c 6167 5d20  rr[ii, thisLag] 
-00019060: 3d20 6572 725b 2d6c 6c2c 2074 6869 734c  = err[-ll, thisL
-00019070: 6167 5d0a 0a20 2020 2020 2020 2020 2020  ag]..           
-00019080: 2065 6c69 6620 6969 202b 206c 6c20 3e20   elif ii + ll > 
-00019090: 6e53 616d 706c 6520 2d20 313a 0a20 2020  nSample - 1:.   
-000190a0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-000190b0: 5b69 692c 2074 6869 734c 6167 5d20 3d20  [ii, thisLag] = 
-000190c0: 6572 725b 6e53 616d 706c 6520 2d20 6c6c  err[nSample - ll
-000190d0: 202d 2031 2c20 7468 6973 4c61 675d 0a0a   - 1, thisLag]..
-000190e0: 2020 2020 7265 7475 726e 2065 7272 0a0a      return err..
-000190f0: 0a64 6566 2061 6363 756d 756c 6174 6545  .def accumulateE
-00019100: 7272 6f72 4675 6e63 7469 6f6e 2864 6972  rrorFunction(dir
-00019110: 2c20 6572 722c 206e 5361 6d70 6c65 2c20  , err, nSample, 
-00019120: 6c61 672c 2062 293a 0a20 2020 2022 2222  lag, b):.    """
-00019130: 0a20 2020 2061 6363 756d 756c 6174 696f  .    accumulatio
-00019140: 6e20 6f66 2074 6865 2065 7272 6f72 2c20  n of the error, 
-00019150: 7768 6963 6820 666f 6c6c 6f77 7320 7468  which follows th
-00019160: 6520 6571 7561 7469 6f6e 2036 2069 6e20  e equation 6 in 
-00019170: 4861 6c65 2c20 3230 3133 2e0a 0a20 2020  Hale, 2013...   
-00019180: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00019190: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-000191a0: 2020 2064 6972 3a20 6163 6375 6d75 6c61     dir: accumula
-000191b0: 7469 6f6e 2064 6972 6563 7469 6f6e 2028  tion direction (
-000191c0: 2064 6972 203e 2030 203d 2066 6f72 7761   dir > 0 = forwa
-000191d0: 7264 2069 6e20 7469 6d65 2c20 6469 7220  rd in time, dir 
-000191e0: 3c3d 2030 203d 2062 6163 6b77 6172 6420  <= 0 = backward 
-000191f0: 696e 2074 696d 6529 0a20 2020 2065 7272  in time).    err
-00019200: 3a20 7468 6520 3244 2065 7272 6f72 2066  : the 2D error f
-00019210: 756e 6374 696f 6e3b 2073 697a 6520 3d20  unction; size = 
-00019220: 286e 7361 6d70 2c32 2a6c 6167 2b31 290a  (nsamp,2*lag+1).
-00019230: 2020 2020 6e53 616d 706c 653a 206e 756d      nSample: num
-00019240: 6572 206f 6620 706f 696e 7473 2074 6f20  er of points to 
-00019250: 636f 6d70 6172 6520 696e 2074 6865 2074  compare in the t
-00019260: 7261 6365 730a 2020 2020 6c61 673a 206d  races.    lag: m
-00019270: 6178 696d 756d 206c 6167 2069 6e20 7361  aximum lag in sa
-00019280: 6d70 6c65 206e 756d 6265 7220 746f 2073  mple number to s
-00019290: 6561 7263 680a 2020 2020 623a 2073 7472  earch.    b: str
-000192a0: 6169 6e20 6c69 6d69 7420 2869 6e74 6567  ain limit (integ
-000192b0: 6572 2076 616c 7565 203e 3d20 3129 0a0a  er value >= 1)..
-000192c0: 2020 2020 5245 5455 524e 533a 0a20 2020      RETURNS:.   
-000192d0: 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   ---------------
-000192e0: 2d2d 2d0a 2020 2020 643a 2074 6865 2032  ---.    d: the 2
-000192f0: 4420 6469 7374 616e 6365 2066 756e 6374  D distance funct
-00019300: 696f 6e3b 2073 697a 6520 3d20 286e 7361  ion; size = (nsa
-00019310: 6d70 2c32 2a6c 6167 2b31 290a 0a20 2020  mp,2*lag+1)..   
-00019320: 204f 7269 6769 6e61 6c20 6279 2044 6920   Original by Di 
-00019330: 5961 6e67 0a20 2020 204c 6173 7420 6d6f  Yang.    Last mo
-00019340: 6469 6669 6564 2062 7920 4479 6c61 6e20  dified by Dylan 
-00019350: 4d69 6b65 7365 6c6c 2028 3235 2046 6562  Mikesell (25 Feb
-00019360: 2e20 3230 3135 290a 2020 2020 5472 616e  . 2015).    Tran
-00019370: 736c 6174 6564 2074 6f20 7079 7468 6f6e  slated to python
-00019380: 2062 7920 5469 6d20 436c 656d 656e 7473   by Tim Clements
-00019390: 2028 3137 2041 7567 2e20 3230 3138 290a   (17 Aug. 2018).
-000193a0: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
-000193b0: 6e75 6d62 6572 206f 6620 6c61 6773 2066  number of lags f
-000193c0: 726f 6d20 5b20 2d6c 6167 203a 202b 6c61  rom [ -lag : +la
-000193d0: 6720 5d0a 2020 2020 6e4c 6167 203d 2028  g ].    nLag = (
-000193e0: 3220 2a20 6c61 6729 202b 2031 0a0a 2020  2 * lag) + 1..  
-000193f0: 2020 2320 616c 6c6f 6361 7465 2064 6973    # allocate dis
-00019400: 7461 6e63 6520 6d61 7472 6978 0a20 2020  tance matrix.   
-00019410: 2064 203d 206e 702e 7a65 726f 7328 5b6e   d = np.zeros([n
-00019420: 5361 6d70 6c65 2c20 6e4c 6167 5d29 0a0a  Sample, nLag])..
-00019430: 2020 2020 2320 5365 7475 7020 696e 6469      # Setup indi
-00019440: 6365 7320 6261 7365 6420 6f6e 2066 6f72  ces based on for
-00019450: 7761 7264 206f 7220 6261 636b 7761 7264  ward or backward
-00019460: 2061 6363 756d 756c 6174 696f 6e20 6469   accumulation di
-00019470: 7265 6374 696f 6e0a 2020 2020 6966 2064  rection.    if d
-00019480: 6972 203e 2030 3a20 2023 2046 4f52 5741  ir > 0:  # FORWA
-00019490: 5244 0a20 2020 2020 2020 2069 4265 6769  RD.        iBegi
-000194a0: 6e2c 2069 456e 642c 2069 496e 6320 3d20  n, iEnd, iInc = 
-000194b0: 302c 206e 5361 6d70 6c65 202d 2031 2c20  0, nSample - 1, 
-000194c0: 310a 2020 2020 656c 7365 3a20 2023 2042  1.    else:  # B
-000194d0: 4143 4b57 4152 440a 2020 2020 2020 2020  ACKWARD.        
-000194e0: 6942 6567 696e 2c20 6945 6e64 2c20 6949  iBegin, iEnd, iI
-000194f0: 6e63 203d 206e 5361 6d70 6c65 202d 2031  nc = nSample - 1
-00019500: 2c20 302c 202d 310a 0a20 2020 2023 204c  , 0, -1..    # L
-00019510: 6f6f 7020 7468 726f 7567 6820 616c 6c20  oop through all 
-00019520: 7469 6d65 7320 6969 2069 6e20 666f 7277  times ii in forw
-00019530: 6172 6420 6f72 2062 6163 6b77 6172 6420  ard or backward 
-00019540: 6469 7265 6374 696f 6e0a 2020 2020 666f  direction.    fo
-00019550: 7220 6969 2069 6e20 7261 6e67 6528 6942  r ii in range(iB
-00019560: 6567 696e 2c20 6945 6e64 202b 2069 496e  egin, iEnd + iIn
-00019570: 632c 2069 496e 6329 3a0a 2020 2020 2020  c, iInc):.      
-00019580: 2020 2320 6d69 6e2f 6d61 7820 746f 2061    # min/max to a
-00019590: 6363 6f75 6e74 2066 6f72 2074 6865 2065  ccount for the e
-000195a0: 6467 6573 2f62 6f75 6e64 6172 6965 730a  dges/boundaries.
-000195b0: 2020 2020 2020 2020 6a69 203d 206d 6178          ji = max
-000195c0: 285b 302c 206d 696e 285b 6e53 616d 706c  ([0, min([nSampl
-000195d0: 6520 2d20 312c 2069 6920 2d20 6949 6e63  e - 1, ii - iInc
-000195e0: 5d29 5d29 0a20 2020 2020 2020 206a 6220  ])]).        jb 
-000195f0: 3d20 6d61 7828 5b30 2c20 6d69 6e28 5b6e  = max([0, min([n
-00019600: 5361 6d70 6c65 202d 2031 2c20 6969 202d  Sample - 1, ii -
-00019610: 2069 496e 6320 2a20 625d 295d 290a 0a20   iInc * b])]).. 
-00019620: 2020 2020 2020 2023 206c 6f6f 7020 7468         # loop th
-00019630: 726f 7567 6820 616c 6c20 6c61 670a 2020  rough all lag.  
-00019640: 2020 2020 2020 666f 7220 6c6c 2069 6e20        for ll in 
-00019650: 7261 6e67 6528 6e4c 6167 293a 0a20 2020  range(nLag):.   
-00019660: 2020 2020 2020 2020 2023 2063 6865 636b           # check
-00019670: 206c 696d 6974 7320 6f6e 206c 6167 2069   limits on lag i
-00019680: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
-00019690: 2020 206c 4d69 6e75 7331 203d 206c 6c20     lMinus1 = ll 
-000196a0: 2d20 310a 0a20 2020 2020 2020 2020 2020  - 1..           
-000196b0: 2023 2063 6865 636b 206c 6167 2069 6e64   # check lag ind
-000196c0: 6578 2069 7320 6772 6561 7465 7220 7468  ex is greater th
-000196d0: 616e 2030 0a20 2020 2020 2020 2020 2020  an 0.           
-000196e0: 2069 6620 6c4d 696e 7573 3120 3c20 303a   if lMinus1 < 0:
-000196f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019700: 206c 4d69 6e75 7331 203d 2030 2020 2320   lMinus1 = 0  # 
-00019710: 6d61 6b65 206c 6167 203d 2066 6972 7374  make lag = first
-00019720: 206c 6167 0a0a 2020 2020 2020 2020 2020   lag..          
-00019730: 2020 6c50 6c75 7331 203d 206c 6c20 2b20    lPlus1 = ll + 
-00019740: 3120 2023 206c 6167 2061 7420 6c2b 310a  1  # lag at l+1.
-00019750: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00019760: 6865 636b 206c 6167 2069 6e64 6578 206c  heck lag index l
-00019770: 6573 7320 7468 616e 206d 6178 206c 6167  ess than max lag
-00019780: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00019790: 6c50 6c75 7331 203e 206e 4c61 6720 2d20  lPlus1 > nLag - 
-000197a0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-000197b0: 2020 206c 506c 7573 3120 3d20 6e4c 6167     lPlus1 = nLag
-000197c0: 202d 2031 0a0a 2020 2020 2020 2020 2020   - 1..          
-000197d0: 2020 2320 6765 7420 6469 7374 616e 6365    # get distance
-000197e0: 2061 7420 6c61 6773 2028 6c6c 2d31 2c20   at lags (ll-1, 
-000197f0: 6c6c 2c20 6c6c 2b31 290a 2020 2020 2020  ll, ll+1).      
-00019800: 2020 2020 2020 6469 7374 4c6d 696e 7573        distLminus
-00019810: 3120 3d20 645b 6a62 2c20 6c4d 696e 7573  1 = d[jb, lMinus
-00019820: 315d 2020 2320 6d69 6e75 733a 2020 645b  1]  # minus:  d[
-00019830: 692d 622c 206a 2d31 5d0a 2020 2020 2020  i-b, j-1].      
-00019840: 2020 2020 2020 6469 7374 4c20 3d20 645b        distL = d[
-00019850: 6a69 2c20 6c6c 5d20 2023 2061 6374 7561  ji, ll]  # actua
-00019860: 6c20 645b 692d 312c 206a 5d0a 2020 2020  l d[i-1, j].    
-00019870: 2020 2020 2020 2020 6469 7374 4c70 6c75          distLplu
-00019880: 7331 203d 2064 5b6a 622c 206c 506c 7573  s1 = d[jb, lPlus
-00019890: 315d 2020 2320 706c 7573 2064 5b69 2d62  1]  # plus d[i-b
-000198a0: 2c20 6a2b 315d 0a0a 2020 2020 2020 2020  , j+1]..        
-000198b0: 2020 2020 6966 206a 6920 213d 206a 623a      if ji != jb:
-000198c0: 2020 2320 6571 7561 7469 6f6e 2031 3020    # equation 10 
-000198d0: 696e 2048 616c 652c 2032 3031 330a 2020  in Hale, 2013.  
-000198e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000198f0: 7220 6b62 2069 6e20 7261 6e67 6528 6a69  r kb in range(ji
-00019900: 2c20 6a62 202b 2069 496e 6320 2d20 312c  , jb + iInc - 1,
-00019910: 202d 6949 6e63 293a 0a20 2020 2020 2020   -iInc):.       
-00019920: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-00019930: 744c 6d69 6e75 7331 203d 2064 6973 744c  tLminus1 = distL
-00019940: 6d69 6e75 7331 202b 2065 7272 5b6b 622c  minus1 + err[kb,
-00019950: 206c 4d69 6e75 7331 5d0a 2020 2020 2020   lMinus1].      
-00019960: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00019970: 7374 4c70 6c75 7331 203d 2064 6973 744c  stLplus1 = distL
-00019980: 706c 7573 3120 2b20 6572 725b 6b62 2c20  plus1 + err[kb, 
-00019990: 6c50 6c75 7331 5d0a 0a20 2020 2020 2020  lPlus1]..       
-000199a0: 2020 2020 2023 2065 7175 6174 696f 6e20       # equation 
-000199b0: 3620 2869 6620 623d 3129 206f 7220 3130  6 (if b=1) or 10
-000199c0: 2028 6966 2062 3e31 2920 696e 2048 616c   (if b>1) in Hal
-000199d0: 6520 2832 3031 3329 2061 6674 6572 2074  e (2013) after t
-000199e0: 7265 6174 696e 6720 626f 756e 6461 7269  reating boundari
-000199f0: 6573 0a20 2020 2020 2020 2020 2020 2064  es.            d
-00019a00: 5b69 692c 206c 6c5d 203d 2065 7272 5b69  [ii, ll] = err[i
-00019a10: 692c 206c 6c5d 202b 206d 696e 285b 6469  i, ll] + min([di
-00019a20: 7374 4c6d 696e 7573 312c 2064 6973 744c  stLminus1, distL
-00019a30: 2c20 6469 7374 4c70 6c75 7331 5d29 0a0a  , distLplus1])..
-00019a40: 2020 2020 7265 7475 726e 2064 0a0a 0a64      return d...d
-00019a50: 6566 2062 6163 6b74 7261 636b 4469 7374  ef backtrackDist
-00019a60: 616e 6365 4675 6e63 7469 6f6e 2864 6972  anceFunction(dir
-00019a70: 2c20 642c 2065 7272 2c20 6c6d 696e 2c20  , d, err, lmin, 
-00019a80: 6229 3a0a 2020 2020 2222 220a 2020 2020  b):.    """.    
-00019a90: 5468 6520 6675 6e63 7469 6f6e 2069 7320  The function is 
-00019aa0: 6571 7561 7469 6f6e 2032 2069 6e20 4861  equation 2 in Ha
-00019ab0: 6c65 2c20 3230 3133 2e0a 0a20 2020 2050  le, 2013...    P
-00019ac0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00019ad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00019ae0: 2064 6972 3a20 7369 6465 2074 6f20 7374   dir: side to st
-00019af0: 6172 7420 6d69 6e69 6d69 7a61 7469 6f6e  art minimization
-00019b00: 2028 2064 6972 203e 2030 203d 2066 726f   ( dir > 0 = fro
-00019b10: 6e74 2c20 6469 7220 3c3d 2030 203d 2020  nt, dir <= 0 =  
-00019b20: 6261 636b 290a 2020 2020 6420 3a20 7468  back).    d : th
-00019b30: 6520 3244 2064 6973 7461 6e63 6520 6675  e 2D distance fu
-00019b40: 6e63 7469 6f6e 3b20 7369 7a65 203d 2028  nction; size = (
-00019b50: 6e73 616d 702c 322a 6c61 672b 3129 0a20  nsamp,2*lag+1). 
-00019b60: 2020 2065 7272 3a20 7468 6520 3244 2065     err: the 2D e
-00019b70: 7272 6f72 2066 756e 6374 696f 6e3b 2073  rror function; s
-00019b80: 697a 6520 3d20 286e 7361 6d70 2c32 2a6c  ize = (nsamp,2*l
-00019b90: 6167 2b31 290a 2020 2020 6c6d 696e 3a20  ag+1).    lmin: 
-00019ba0: 6d69 6e69 6d75 6d20 6c61 6720 746f 2073  minimum lag to s
-00019bb0: 6561 7263 6820 6f76 6572 0a20 2020 2062  earch over.    b
-00019bc0: 203a 2073 7472 6169 6e20 6c69 6d69 7420   : strain limit 
-00019bd0: 2869 6e74 6567 6572 2076 616c 7565 203e  (integer value >
-00019be0: 3d20 3129 0a0a 2020 2020 5245 5455 524e  = 1)..    RETURN
-00019bf0: 533a 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  S:.    ---------
-00019c00: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7374  ---------.    st
-00019c10: 6261 723a 2076 6563 746f 7220 6f66 2069  bar: vector of i
-00019c20: 6e74 6567 6572 2073 6869 6674 7320 7375  nteger shifts su
-00019c30: 626a 6563 7420 746f 207c 7528 6929 2d75  bject to |u(i)-u
-00019c40: 2869 2d31 297c 203c 3d20 312f 620a 0a20  (i-1)| <= 1/b.. 
-00019c50: 2020 204f 7269 6769 6e61 6c20 6279 2044     Original by D
-00019c60: 6920 5961 6e67 0a20 2020 204c 6173 7420  i Yang.    Last 
-00019c70: 6d6f 6469 6669 6564 2062 7920 4479 6c61  modified by Dyla
-00019c80: 6e20 4d69 6b65 7365 6c6c 2028 3139 2044  n Mikesell (19 D
-00019c90: 6563 2e20 3230 3134 290a 0a20 2020 2054  ec. 2014)..    T
-00019ca0: 7261 6e73 6c61 7465 6420 746f 2070 7974  ranslated to pyt
-00019cb0: 686f 6e20 6279 2054 696d 2043 6c65 6d65  hon by Tim Cleme
-00019cc0: 6e74 7320 2831 3720 4175 672e 2032 3031  nts (17 Aug. 201
-00019cd0: 3829 0a0a 2020 2020 2222 220a 0a20 2020  8)..    """..   
-00019ce0: 206e 5361 6d70 6c65 2c20 6e4c 6167 203d   nSample, nLag =
-00019cf0: 2064 2e73 6861 7065 0a20 2020 2073 7462   d.shape.    stb
-00019d00: 6172 203d 206e 702e 7a65 726f 7328 6e53  ar = np.zeros(nS
-00019d10: 616d 706c 6529 0a0a 2020 2020 2320 5365  ample)..    # Se
-00019d20: 7475 7020 696e 6469 6365 7320 6261 7365  tup indices base
-00019d30: 6420 6f6e 2066 6f72 7761 7264 206f 7220  d on forward or 
-00019d40: 6261 636b 7761 7264 2061 6363 756d 756c  backward accumul
-00019d50: 6174 696f 6e20 6469 7265 6374 696f 6e0a  ation direction.
-00019d60: 2020 2020 6966 2064 6972 203e 2030 3a20      if dir > 0: 
-00019d70: 2023 2046 4f52 5741 5244 0a20 2020 2020   # FORWARD.     
-00019d80: 2020 2069 4265 6769 6e2c 2069 456e 642c     iBegin, iEnd,
-00019d90: 2069 496e 6320 3d20 302c 206e 5361 6d70   iInc = 0, nSamp
-00019da0: 6c65 202d 2031 2c20 310a 2020 2020 656c  le - 1, 1.    el
-00019db0: 7365 3a20 2023 2042 4143 4b57 4152 440a  se:  # BACKWARD.
-00019dc0: 2020 2020 2020 2020 6942 6567 696e 2c20          iBegin, 
-00019dd0: 6945 6e64 2c20 6949 6e63 203d 206e 5361  iEnd, iInc = nSa
-00019de0: 6d70 6c65 202d 2031 2c20 302c 202d 310a  mple - 1, 0, -1.
-00019df0: 0a20 2020 2023 2073 7461 7274 2066 726f  .    # start fro
-00019e00: 6d20 7468 6520 656e 6420 2866 726f 6e74  m the end (front
-00019e10: 206f 7220 6261 636b 290a 2020 2020 6c6c   or back).    ll
-00019e20: 203d 206e 702e 6172 676d 696e 2864 5b69   = np.argmin(d[i
-00019e30: 4265 6769 6e2c 203a 5d29 2020 2320 6669  Begin, :])  # fi
-00019e40: 6e64 206d 696e 696d 756d 2061 6363 756d  nd minimum accum
-00019e50: 756c 6174 6564 2064 6973 7461 6e63 6520  ulated distance 
-00019e60: 6174 2066 726f 6e74 206f 7220 6261 636b  at front or back
-00019e70: 2064 6570 656e 6469 6e67 206f 6e20 2764   depending on 'd
-00019e80: 6972 270a 2020 2020 7374 6261 725b 6942  ir'.    stbar[iB
-00019e90: 6567 696e 5d20 3d20 6c6c 202b 206c 6d69  egin] = ll + lmi
-00019ea0: 6e20 2023 2061 6273 6f6c 7574 6520 7661  n  # absolute va
-00019eb0: 6c75 6520 6f66 2069 6e74 6567 6572 2073  lue of integer s
-00019ec0: 6869 6674 0a0a 2020 2020 2320 6d6f 7665  hift..    # move
-00019ed0: 2074 6872 6f75 6768 2061 6c6c 2074 696d   through all tim
-00019ee0: 6520 7361 6d70 6c65 7320 696e 2066 6f72  e samples in for
-00019ef0: 7761 7264 206f 7220 6261 636b 7761 7264  ward or backward
-00019f00: 2064 6972 6563 7469 6f6e 0a20 2020 2069   direction.    i
-00019f10: 6920 3d20 6942 6567 696e 0a0a 2020 2020  i = iBegin..    
-00019f20: 7768 696c 6520 6969 2021 3d20 6945 6e64  while ii != iEnd
-00019f30: 3a0a 2020 2020 2020 2020 2320 6d69 6e2f  :.        # min/
-00019f40: 6d61 7820 666f 7220 6564 6765 732f 626f  max for edges/bo
-00019f50: 756e 6461 7269 6573 0a20 2020 2020 2020  undaries.       
-00019f60: 206a 6920 3d20 6e70 2e6d 6178 285b 302c   ji = np.max([0,
-00019f70: 206e 702e 6d69 6e28 5b6e 5361 6d70 6c65   np.min([nSample
-00019f80: 202d 2031 2c20 6969 202b 2069 496e 635d   - 1, ii + iInc]
-00019f90: 295d 290a 2020 2020 2020 2020 6a62 203d  )]).        jb =
-00019fa0: 206e 702e 6d61 7828 5b30 2c20 6e70 2e6d   np.max([0, np.m
-00019fb0: 696e 285b 6e53 616d 706c 6520 2d20 312c  in([nSample - 1,
-00019fc0: 2069 6920 2b20 6949 6e63 202a 2062 5d29   ii + iInc * b])
-00019fd0: 5d29 0a0a 2020 2020 2020 2020 2320 6368  ])..        # ch
-00019fe0: 6563 6b20 6c69 6d69 7473 206f 6e20 6c61  eck limits on la
-00019ff0: 6720 696e 6469 6365 730a 2020 2020 2020  g indices.      
-0001a000: 2020 6c4d 696e 7573 3120 3d20 6c6c 202d    lMinus1 = ll -
-0001a010: 2031 0a0a 2020 2020 2020 2020 6966 206c   1..        if l
-0001a020: 4d69 6e75 7331 203c 2030 3a20 2023 2063  Minus1 < 0:  # c
-0001a030: 6865 636b 206c 6167 2069 6e64 6578 2069  heck lag index i
-0001a040: 7320 6772 6561 7465 7220 7468 616e 2031  s greater than 1
-0001a050: 0a20 2020 2020 2020 2020 2020 206c 4d69  .            lMi
-0001a060: 6e75 7331 203d 2030 2020 2320 6d61 6b65  nus1 = 0  # make
-0001a070: 206c 6167 203d 2066 6972 7374 206c 6167   lag = first lag
-0001a080: 0a0a 2020 2020 2020 2020 6c50 6c75 7331  ..        lPlus1
-0001a090: 203d 206c 6c20 2b20 310a 0a20 2020 2020   = ll + 1..     
-0001a0a0: 2020 2069 6620 6c50 6c75 7331 203e 206e     if lPlus1 > n
-0001a0b0: 4c61 6720 2d20 313a 2020 2320 6368 6563  Lag - 1:  # chec
-0001a0c0: 6b20 6c61 6720 696e 6465 7820 6c65 7373  k lag index less
-0001a0d0: 2074 6861 6e20 6d61 7820 6c61 670a 2020   than max lag.  
-0001a0e0: 2020 2020 2020 2020 2020 6c50 6c75 7331            lPlus1
-0001a0f0: 203d 206e 4c61 6720 2d20 310a 0a20 2020   = nLag - 1..   
-0001a100: 2020 2020 2023 2067 6574 2064 6973 7461       # get dista
-0001a110: 6e63 6520 6174 206c 6167 7320 286c 6c2d  nce at lags (ll-
-0001a120: 312c 206c 6c2c 206c 6c2b 3129 0a20 2020  1, ll, ll+1).   
-0001a130: 2020 2020 2064 6973 744c 6d69 6e75 7331       distLminus1
-0001a140: 203d 2064 5b6a 622c 206c 4d69 6e75 7331   = d[jb, lMinus1
-0001a150: 5d20 2023 206d 696e 7573 3a20 2064 5b69  ]  # minus:  d[i
-0001a160: 2d62 2c20 6a2d 315d 0a20 2020 2020 2020  -b, j-1].       
-0001a170: 2064 6973 744c 203d 2064 5b6a 692c 206c   distL = d[ji, l
-0001a180: 6c5d 2020 2320 6163 7475 616c 2064 5b69  l]  # actual d[i
-0001a190: 2d31 2c20 6a5d 0a20 2020 2020 2020 2064  -1, j].        d
-0001a1a0: 6973 744c 706c 7573 3120 3d20 645b 6a62  istLplus1 = d[jb
-0001a1b0: 2c20 6c50 6c75 7331 5d20 2023 2070 6c75  , lPlus1]  # plu
-0001a1c0: 7320 645b 692d 622c 206a 2b31 5d0a 0a20  s d[i-b, j+1].. 
-0001a1d0: 2020 2020 2020 2023 2065 7175 6174 696f         # equatio
-0001a1e0: 6e20 3130 2069 6e20 4861 6c65 2028 3230  n 10 in Hale (20
-0001a1f0: 3133 290a 2020 2020 2020 2020 2320 7375  13).        # su
-0001a200: 6d20 6572 726f 7273 206f 7665 7220 692d  m errors over i-
-0001a210: 313a 692d 622b 310a 2020 2020 2020 2020  1:i-b+1.        
-0001a220: 6966 206a 6920 213d 206a 623a 0a20 2020  if ji != jb:.   
-0001a230: 2020 2020 2020 2020 2066 6f72 206b 6220           for kb 
-0001a240: 696e 2072 616e 6765 286a 692c 206a 6220  in range(ji, jb 
-0001a250: 2d20 6949 6e63 202d 2031 2c20 6949 6e63  - iInc - 1, iInc
-0001a260: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001a270: 2020 2064 6973 744c 6d69 6e75 7331 203d     distLminus1 =
-0001a280: 2064 6973 744c 6d69 6e75 7331 202b 2065   distLminus1 + e
-0001a290: 7272 5b6b 622c 206c 4d69 6e75 7331 5d0a  rr[kb, lMinus1].
-0001a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2b0: 6469 7374 4c70 6c75 7331 203d 2064 6973  distLplus1 = dis
-0001a2c0: 744c 706c 7573 3120 2b20 6572 725b 6b62  tLplus1 + err[kb
-0001a2d0: 2c20 6c50 6c75 7331 5d0a 0a20 2020 2020  , lPlus1]..     
-0001a2e0: 2020 2023 2075 7064 6174 6520 6d69 6e69     # update mini
-0001a2f0: 6d75 6d20 6469 7374 616e 6365 2074 6f20  mum distance to 
-0001a300: 7072 6576 696f 7573 2073 616d 706c 650a  previous sample.
-0001a310: 2020 2020 2020 2020 646c 203d 206e 702e          dl = np.
-0001a320: 6d69 6e28 5b64 6973 744c 6d69 6e75 7331  min([distLminus1
-0001a330: 2c20 6469 7374 4c2c 2064 6973 744c 706c  , distL, distLpl
-0001a340: 7573 315d 290a 0a20 2020 2020 2020 2069  us1])..        i
-0001a350: 6620 646c 2021 3d20 6469 7374 4c3a 2020  f dl != distL:  
-0001a360: 2320 7468 656e 206c 6c20 7e3d 206c 6c20  # then ll ~= ll 
-0001a370: 616e 6420 7765 2063 6865 636b 2066 6f72  and we check for
-0001a380: 7761 7264 2061 6e64 2062 6163 6b77 6172  ward and backwar
-0001a390: 640a 2020 2020 2020 2020 2020 2020 6966  d.            if
-0001a3a0: 2064 6c20 3d3d 2064 6973 744c 6d69 6e75   dl == distLminu
-0001a3b0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-0001a3c0: 2020 2020 6c6c 203d 206c 4d69 6e75 7331      ll = lMinus1
-0001a3d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001a3e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001a3f0: 2020 206c 6c20 3d20 6c50 6c75 7331 0a0a     ll = lPlus1..
-0001a400: 2020 2020 2020 2020 2320 6173 7375 6d65          # assume
-0001a410: 2069 6920 3d20 6969 202d 2031 0a20 2020   ii = ii - 1.   
-0001a420: 2020 2020 2069 6920 2b3d 2069 496e 630a       ii += iInc.
-0001a430: 0a20 2020 2020 2020 2023 2061 6273 6f6c  .        # absol
-0001a440: 7574 6520 696e 7465 6765 7220 6f66 206c  ute integer of l
-0001a450: 6167 0a20 2020 2020 2020 2073 7462 6172  ag.        stbar
-0001a460: 5b69 695d 203d 206c 6c20 2b20 6c6d 696e  [ii] = ll + lmin
-0001a470: 0a0a 2020 2020 2020 2020 2320 6e6f 7720  ..        # now 
-0001a480: 6d6f 7665 2074 6f20 636f 7272 6563 7420  move to correct 
-0001a490: 7469 6d65 2069 6e64 6578 2c20 6966 2073  time index, if s
-0001a4a0: 6d6f 6f74 6869 6e67 2064 6966 6665 7265  moothing differe
-0001a4b0: 6e63 6520 6f76 6572 206d 616e 790a 2020  nce over many.  
-0001a4c0: 2020 2020 2020 2320 7469 6d65 2073 616d        # time sam
-0001a4d0: 706c 6573 2075 7369 6e67 2027 6227 0a20  ples using 'b'. 
-0001a4e0: 2020 2020 2020 2069 6620 286c 6c20 3d3d         if (ll ==
-0001a4f0: 206c 4d69 6e75 7331 2920 7c20 286c 6c20   lMinus1) | (ll 
-0001a500: 3d3d 206c 506c 7573 3129 3a20 2023 2063  == lPlus1):  # c
-0001a510: 6865 636b 2065 6467 6573 2074 6f20 7365  heck edges to se
-0001a520: 6520 6162 6f75 7420 6220 7661 6c75 6573  e about b values
-0001a530: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001a540: 6a69 2021 3d20 6a62 3a20 2023 2069 6620  ji != jb:  # if 
-0001a550: 623e 3120 7468 656e 206e 6565 6420 746f  b>1 then need to
-0001a560: 206d 6f76 6520 6d6f 7265 2073 7465 7073   move more steps
-0001a570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a580: 2066 6f72 206b 6220 696e 2072 616e 6765   for kb in range
-0001a590: 286a 692c 206a 6220 2d20 6949 6e63 202d  (ji, jb - iInc -
-0001a5a0: 2031 2c20 6949 6e63 293a 0a20 2020 2020   1, iInc):.     
-0001a5b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a5c0: 6920 3d20 6969 202b 2069 496e 6320 2023  i = ii + iInc  #
-0001a5d0: 206d 6f76 6520 6672 6f6d 2069 2d31 3a69   move from i-1:i
-0001a5e0: 2d62 2d31 0a20 2020 2020 2020 2020 2020  -b-1.           
-0001a5f0: 2020 2020 2020 2020 2073 7462 6172 5b69           stbar[i
-0001a600: 695d 203d 206c 6c20 2b20 6c6d 696e 2020  i] = ll + lmin  
-0001a610: 2320 636f 6e73 7461 6e74 206c 6167 206f  # constant lag o
-0001a620: 7665 7220 7468 6174 2074 696d 650a 0a20  ver that time.. 
-0001a630: 2020 2072 6574 7572 6e20 7374 6261 720a     return stbar.
-0001a640: 0a0a 6465 6620 7763 745f 6d6f 6469 6669  ..def wct_modifi
-0001a650: 6564 280a 2020 2020 7931 2c20 7932 2c20  ed(.    y1, y2, 
-0001a660: 6474 2c20 646a 3d31 202f 2031 322c 2073  dt, dj=1 / 12, s
-0001a670: 303d 2d31 2c20 4a3d 2d31 2c20 7369 673d  0=-1, J=-1, sig=
-0001a680: 5472 7565 2c20 7369 676e 6966 6963 616e  True, significan
-0001a690: 6365 5f6c 6576 656c 3d30 2e39 352c 2077  ce_level=0.95, w
-0001a6a0: 6176 656c 6574 3d22 6d6f 726c 6574 222c  avelet="morlet",
-0001a6b0: 206e 6f72 6d61 6c69 7a65 3d54 7275 652c   normalize=True,
-0001a6c0: 202a 2a6b 7761 7267 730a 293a 0a20 2020   **kwargs.):.   
-0001a6d0: 2022 2222 0a20 2020 2020 2020 2057 6176   """.        Wav
-0001a6e0: 656c 6574 2063 6f68 6572 656e 6365 2074  elet coherence t
-0001a6f0: 7261 6e73 666f 726d 2028 5743 5429 2e0a  ransform (WCT)..
-0001a700: 2020 2020 e280 8b0a 2020 2020 2020 2020      ....        
-0001a710: 5468 6520 5743 5420 6669 6e64 7320 7265  The WCT finds re
-0001a720: 6769 6f6e 7320 696e 2074 696d 6520 6672  gions in time fr
-0001a730: 6571 7565 6e63 7920 7370 6163 6520 7768  equency space wh
-0001a740: 6572 6520 7468 6520 7477 6f20 7469 6d65  ere the two time
-0001a750: 0a20 2020 2020 2020 2073 6572 6965 7320  .        series 
-0001a760: 636f 2d76 6172 792c 2062 7574 2064 6f20  co-vary, but do 
-0001a770: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
-0001a780: 6861 7665 2068 6967 6820 706f 7765 722e  have high power.
-0001a790: 0a20 2020 20e2 808b 0a20 2020 2020 2020  .    ....       
-0001a7a0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0001a7b0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-0001a7c0: 2020 2020 2020 2079 312c 2079 3220 3a20         y1, y2 : 
-0001a7d0: 6e75 6d70 792e 6e64 6172 7261 792c 206c  numpy.ndarray, l
-0001a7e0: 6973 740a 2020 2020 2020 2020 2020 2020  ist.            
-0001a7f0: 496e 7075 7420 7369 676e 616c 732e 0a20  Input signals.. 
-0001a800: 2020 2020 2020 2064 7420 3a20 666c 6f61         dt : floa
-0001a810: 740a 2020 2020 2020 2020 2020 2020 5361  t.            Sa
-0001a820: 6d70 6c65 2073 7061 6369 6e67 2e0a 2020  mple spacing..  
-0001a830: 2020 2020 2020 646a 203a 2066 6c6f 6174        dj : float
-0001a840: 2c20 6f70 7469 6f6e 616c 0a20 2020 2020  , optional.     
-0001a850: 2020 2020 2020 2053 7061 6369 6e67 2062         Spacing b
-0001a860: 6574 7765 656e 2064 6973 6372 6574 6520  etween discrete 
-0001a870: 7363 616c 6573 2e20 4465 6661 756c 7420  scales. Default 
-0001a880: 7661 6c75 6520 6973 2031 2f31 322e 0a20  value is 1/12.. 
-0001a890: 2020 2020 2020 2020 2020 2053 6d61 6c6c             Small
-0001a8a0: 6572 2076 616c 7565 7320 7769 6c6c 2072  er values will r
-0001a8b0: 6573 756c 7420 696e 2062 6574 7465 7220  esult in better 
-0001a8c0: 7363 616c 6520 7265 736f 6c75 7469 6f6e  scale resolution
-0001a8d0: 2c20 6275 740a 2020 2020 2020 2020 2020  , but.          
-0001a8e0: 2020 736c 6f77 6572 2063 616c 6375 6c61    slower calcula
-0001a8f0: 7469 6f6e 2061 6e64 2070 6c6f 742e 0a20  tion and plot.. 
-0001a900: 2020 2020 2020 2073 3020 3a20 666c 6f61         s0 : floa
-0001a910: 742c 206f 7074 696f 6e61 6c0a 2020 2020  t, optional.    
-0001a920: 2020 2020 2020 2020 536d 616c 6c65 7374          Smallest
-0001a930: 2073 6361 6c65 206f 6620 7468 6520 7761   scale of the wa
-0001a940: 7665 6c65 742e 2044 6566 6175 6c74 2076  velet. Default v
-0001a950: 616c 7565 2069 7320 322a 6474 2e0a 2020  alue is 2*dt..  
-0001a960: 2020 2020 2020 4a20 3a20 666c 6f61 742c        J : float,
-0001a970: 206f 7074 696f 6e61 6c0a 2020 2020 2020   optional.      
-0001a980: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
-0001a990: 7363 616c 6573 206c 6573 7320 6f6e 652e  scales less one.
-0001a9a0: 2053 6361 6c65 7320 7261 6e67 6520 6672   Scales range fr
-0001a9b0: 6f6d 2073 3020 7570 2074 6f0a 2020 2020  om s0 up to.    
-0001a9c0: 2020 2020 2020 2020 7330 202a 2032 2a2a          s0 * 2**
-0001a9d0: 284a 202a 2064 6a29 2c20 7768 6963 6820  (J * dj), which 
-0001a9e0: 6769 7665 7320 6120 746f 7461 6c20 6f66  gives a total of
-0001a9f0: 2028 4a20 2b20 3129 2073 6361 6c65 732e   (J + 1) scales.
-0001aa00: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
-0001aa10: 6175 6c74 2069 7320 4a20 3d20 286c 6f67  ault is J = (log
-0001aa20: 3228 4e2a 6474 2f73 6f29 292f 646a 2e0a  2(N*dt/so))/dj..
-0001aa30: 2020 2020 2020 2020 7369 676e 6966 6963          signific
-0001aa40: 616e 6365 5f6c 6576 656c 2028 666c 6f61  ance_level (floa
-0001aa50: 742c 206f 7074 696f 6e61 6c29 203a 0a20  t, optional) :. 
-0001aa60: 2020 2020 2020 2020 2020 2053 6967 6e69             Signi
-0001aa70: 6669 6361 6e63 6520 6c65 7665 6c20 746f  ficance level to
-0001aa80: 2075 7365 2e20 4465 6661 756c 7420 6973   use. Default is
-0001aa90: 2030 2e39 352e 0a20 2020 2020 2020 206e   0.95..        n
-0001aaa0: 6f72 6d61 6c69 7a65 2028 626f 6f6c 6561  ormalize (boolea
-0001aab0: 6e2c 206f 7074 696f 6e61 6c29 203a 0a20  n, optional) :. 
-0001aac0: 2020 2020 2020 2020 2020 2049 6620 7365             If se
-0001aad0: 7420 746f 2074 7275 652c 206e 6f72 6d61  t to true, norma
-0001aae0: 6c69 7a65 7320 4357 5420 6279 2074 6865  lizes CWT by the
-0001aaf0: 2073 7461 6e64 6172 6420 6465 7669 6174   standard deviat
-0001ab00: 696f 6e20 6f66 0a20 2020 2020 2020 2020  ion of.         
-0001ab10: 2020 2074 6865 2073 6967 6e61 6c73 2e0a     the signals..
-0001ab20: 2020 2020 e280 8b0a 2020 2020 2020 2020      ....        
-0001ab30: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-0001ab40: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0001ab50: 544f 444f 3a20 536f 6d65 7468 696e 6720  TODO: Something 
-0001ab60: 5442 4120 616e 6420 5442 430a 2020 2020  TBA and TBC.    
-0001ab70: e280 8b0a 2020 2020 2020 2020 5365 6520  ....        See 
-0001ab80: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-0001ab90: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6377  -----.        cw
-0001aba0: 742c 2078 7774 0a20 2020 20e2 808b 0a20  t, xwt.    .... 
-0001abb0: 2020 2022 2222 0a0a 2020 2020 7761 7665     """..    wave
-0001abc0: 6c65 7420 3d20 7079 6377 742e 7761 7665  let = pycwt.wave
-0001abd0: 6c65 742e 5f63 6865 636b 5f70 6172 616d  let._check_param
-0001abe0: 6574 6572 5f77 6176 656c 6574 2877 6176  eter_wavelet(wav
-0001abf0: 656c 6574 290a 2020 2020 2320 4368 6563  elet).    # Chec
-0001ac00: 6b69 6e67 2073 6f6d 6520 696e 7075 7420  king some input 
-0001ac10: 7061 7261 6d65 7465 7273 0a20 2020 2069  parameters.    i
-0001ac20: 6620 7330 203d 3d20 2d31 3a0a 2020 2020  f s0 == -1:.    
-0001ac30: 2020 2020 2320 4e75 6d62 6572 206f 6620      # Number of 
-0001ac40: 7363 616c 6573 0a20 2020 2020 2020 2073  scales.        s
-0001ac50: 3020 3d20 3220 2a20 6474 202f 2077 6176  0 = 2 * dt / wav
-0001ac60: 656c 6574 2e66 6c61 6d62 6461 2829 0a20  elet.flambda(). 
-0001ac70: 2020 2069 6620 4a20 3d3d 202d 313a 0a20     if J == -1:. 
-0001ac80: 2020 2020 2020 2023 204e 756d 6265 7220         # Number 
-0001ac90: 6f66 2073 6361 6c65 730a 2020 2020 2020  of scales.      
-0001aca0: 2020 4a20 3d20 6e70 2e69 6e74 286e 702e    J = np.int(np.
-0001acb0: 726f 756e 6428 6e70 2e6c 6f67 3228 7931  round(np.log2(y1
-0001acc0: 2e73 697a 6520 2a20 6474 202f 2073 3029  .size * dt / s0)
-0001acd0: 202f 2064 6a29 290a 0a20 2020 2023 204d   / dj))..    # M
-0001ace0: 616b 6573 2073 7572 6520 696e 7075 7420  akes sure input 
-0001acf0: 7369 676e 616c 7320 6172 6520 6e75 6d70  signals are nump
-0001ad00: 7920 6172 7261 7973 2e0a 2020 2020 7931  y arrays..    y1
-0001ad10: 203d 206e 702e 6173 6172 7261 7928 7931   = np.asarray(y1
-0001ad20: 290a 2020 2020 7932 203d 206e 702e 6173  ).    y2 = np.as
-0001ad30: 6172 7261 7928 7932 290a 2020 2020 2320  array(y2).    # 
-0001ad40: 4361 6c63 756c 6174 6573 2074 6865 2073  Calculates the s
-0001ad50: 7461 6e64 6172 6420 6465 7669 6174 696f  tandard deviatio
-0001ad60: 6e20 6f66 2062 6f74 6820 696e 7075 7420  n of both input 
-0001ad70: 7369 676e 616c 732e 0a20 2020 2073 7464  signals..    std
-0001ad80: 3120 3d20 7931 2e73 7464 2829 0a20 2020  1 = y1.std().   
-0001ad90: 2073 7464 3220 3d20 7932 2e73 7464 2829   std2 = y2.std()
-0001ada0: 0a20 2020 2023 204e 6f72 6d61 6c69 7a65  .    # Normalize
-0001adb0: 7320 626f 7468 2073 6967 6e61 6c73 2c20  s both signals, 
-0001adc0: 6966 2061 7070 726f 7072 6961 7465 2e0a  if appropriate..
-0001add0: 2020 2020 6966 206e 6f72 6d61 6c69 7a65      if normalize
-0001ade0: 3a0a 2020 2020 2020 2020 7931 5f6e 6f72  :.        y1_nor
-0001adf0: 6d61 6c20 3d20 2879 3120 2d20 7931 2e6d  mal = (y1 - y1.m
-0001ae00: 6561 6e28 2929 202f 2073 7464 310a 2020  ean()) / std1.  
-0001ae10: 2020 2020 2020 7932 5f6e 6f72 6d61 6c20        y2_normal 
-0001ae20: 3d20 2879 3220 2d20 7932 2e6d 6561 6e28  = (y2 - y2.mean(
-0001ae30: 2929 202f 2073 7464 320a 2020 2020 656c  )) / std2.    el
-0001ae40: 7365 3a0a 2020 2020 2020 2020 7931 5f6e  se:.        y1_n
-0001ae50: 6f72 6d61 6c20 3d20 7931 0a20 2020 2020  ormal = y1.     
-0001ae60: 2020 2079 325f 6e6f 726d 616c 203d 2079     y2_normal = y
-0001ae70: 320a 0a20 2020 2023 2043 616c 6375 6c61  2..    # Calcula
-0001ae80: 7465 7320 7468 6520 4357 5420 6f66 2074  tes the CWT of t
-0001ae90: 6865 2074 696d 652d 7365 7269 6573 206d  he time-series m
-0001aea0: 616b 696e 6720 7375 7265 2074 6865 2073  aking sure the s
-0001aeb0: 616d 6520 7061 7261 6d65 7465 7273 0a20  ame parameters. 
-0001aec0: 2020 2023 2061 7265 2075 7365 6420 696e     # are used in
-0001aed0: 2062 6f74 6820 6361 6c63 756c 6174 696f   both calculatio
-0001aee0: 6e73 2e0a 2020 2020 5f6b 7761 7267 7320  ns..    _kwargs 
-0001aef0: 3d20 6469 6374 2864 6a3d 646a 2c20 7330  = dict(dj=dj, s0
-0001af00: 3d73 302c 204a 3d4a 2c20 7761 7665 6c65  =s0, J=J, wavele
-0001af10: 743d 7761 7665 6c65 7429 0a20 2020 2057  t=wavelet).    W
-0001af20: 312c 2073 6a2c 2066 7265 712c 2063 6f69  1, sj, freq, coi
-0001af30: 2c20 5f2c 205f 203d 2070 7963 7774 2e63  , _, _ = pycwt.c
-0001af40: 7774 2879 315f 6e6f 726d 616c 2c20 6474  wt(y1_normal, dt
-0001af50: 2c20 2a2a 5f6b 7761 7267 7329 0a20 2020  , **_kwargs).   
-0001af60: 2057 322c 2073 6a2c 2066 7265 712c 2063   W2, sj, freq, c
-0001af70: 6f69 2c20 5f2c 205f 203d 2070 7963 7774  oi, _, _ = pycwt
-0001af80: 2e63 7774 2879 325f 6e6f 726d 616c 2c20  .cwt(y2_normal, 
-0001af90: 6474 2c20 2a2a 5f6b 7761 7267 7329 0a0a  dt, **_kwargs)..
-0001afa0: 2020 2020 7363 616c 6573 3120 3d20 6e70      scales1 = np
-0001afb0: 2e6f 6e65 7328 5b31 2c20 7931 2e73 697a  .ones([1, y1.siz
-0001afc0: 655d 2920 2a20 736a 5b3a 2c20 4e6f 6e65  e]) * sj[:, None
-0001afd0: 5d0a 2020 2020 7363 616c 6573 3220 3d20  ].    scales2 = 
-0001afe0: 6e70 2e6f 6e65 7328 5b31 2c20 7932 2e73  np.ones([1, y2.s
-0001aff0: 697a 655d 2920 2a20 736a 5b3a 2c20 4e6f  ize]) * sj[:, No
-0001b000: 6e65 5d0a 0a20 2020 2023 2053 6d6f 6f74  ne]..    # Smoot
-0001b010: 6820 7468 6520 7761 7665 6c65 7420 7370  h the wavelet sp
-0001b020: 6563 7472 6120 6265 666f 7265 2074 7275  ectra before tru
-0001b030: 6e63 6174 696e 672e 0a20 2020 2053 3120  ncating..    S1 
-0001b040: 3d20 7761 7665 6c65 742e 736d 6f6f 7468  = wavelet.smooth
-0001b050: 286e 702e 6162 7328 5731 2920 2a2a 2032  (np.abs(W1) ** 2
-0001b060: 202f 2073 6361 6c65 7331 2c20 6474 2c20   / scales1, dt, 
-0001b070: 646a 2c20 736a 290a 2020 2020 5332 203d  dj, sj).    S2 =
-0001b080: 2077 6176 656c 6574 2e73 6d6f 6f74 6828   wavelet.smooth(
-0001b090: 6e70 2e61 6273 2857 3229 202a 2a20 3220  np.abs(W2) ** 2 
-0001b0a0: 2f20 7363 616c 6573 322c 2064 742c 2064  / scales2, dt, d
-0001b0b0: 6a2c 2073 6a29 0a0a 2020 2020 2320 4e6f  j, sj)..    # No
-0001b0c0: 7720 7468 6520 7761 7665 6c65 7420 7472  w the wavelet tr
-0001b0d0: 616e 7366 6f72 6d20 636f 6865 7265 6e63  ansform coherenc
-0001b0e0: 650a 2020 2020 5731 3220 3d20 5731 202a  e.    W12 = W1 *
-0001b0f0: 2057 322e 636f 6e6a 2829 0a20 2020 2073   W2.conj().    s
-0001b100: 6361 6c65 7320 3d20 6e70 2e6f 6e65 7328  cales = np.ones(
-0001b110: 5b31 2c20 7931 2e73 697a 655d 2920 2a20  [1, y1.size]) * 
-0001b120: 736a 5b3a 2c20 4e6f 6e65 5d0a 2020 2020  sj[:, None].    
-0001b130: 5331 3220 3d20 7761 7665 6c65 742e 736d  S12 = wavelet.sm
-0001b140: 6f6f 7468 2857 3132 202f 2073 6361 6c65  ooth(W12 / scale
-0001b150: 732c 2064 742c 2064 6a2c 2073 6a29 0a20  s, dt, dj, sj). 
-0001b160: 2020 2057 4354 203d 206e 702e 6162 7328     WCT = np.abs(
-0001b170: 5331 3229 202a 2a20 3220 2f20 2853 3120  S12) ** 2 / (S1 
-0001b180: 2a20 5332 290a 2020 2020 6157 4354 203d  * S2).    aWCT =
-0001b190: 206e 702e 616e 676c 6528 5731 3229 0a0a   np.angle(W12)..
-0001b1a0: 2020 2020 2320 4361 6c63 756c 6174 6573      # Calculates
-0001b1b0: 2074 6865 2073 6967 6e69 6669 6361 6e63   the significanc
-0001b1c0: 6520 7573 696e 6720 4d6f 6e74 6520 4361  e using Monte Ca
-0001b1d0: 726c 6f20 7369 6d75 6c61 7469 6f6e 7320  rlo simulations 
-0001b1e0: 7769 7468 2039 3525 0a20 2020 2023 2063  with 95%.    # c
-0001b1f0: 6f6e 6669 6465 6e63 6520 6173 2061 2066  onfidence as a f
-0001b200: 756e 6374 696f 6e20 6f66 2073 6361 6c65  unction of scale
-0001b210: 2e0a 0a20 2020 2069 6620 7369 673a 0a20  ...    if sig:. 
-0001b220: 2020 2020 2020 2061 312c 2062 312c 2063         a1, b1, c
-0001b230: 3120 3d20 7079 6377 742e 6172 3128 7931  1 = pycwt.ar1(y1
-0001b240: 290a 2020 2020 2020 2020 6132 2c20 6232  ).        a2, b2
-0001b250: 2c20 6332 203d 2070 7963 7774 2e61 7231  , c2 = pycwt.ar1
-0001b260: 2879 3229 0a20 2020 2020 2020 2073 6967  (y2).        sig
-0001b270: 203d 2070 7963 7774 2e77 6374 5f73 6967   = pycwt.wct_sig
-0001b280: 6e69 6669 6361 6e63 6528 0a20 2020 2020  nificance(.     
-0001b290: 2020 2020 2020 2061 312c 2061 322c 2064         a1, a2, d
-0001b2a0: 743d 6474 2c20 646a 3d64 6a2c 2073 303d  t=dt, dj=dj, s0=
-0001b2b0: 7330 2c20 4a3d 4a2c 2073 6967 6e69 6669  s0, J=J, signifi
-0001b2c0: 6361 6e63 655f 6c65 7665 6c3d 7369 676e  cance_level=sign
-0001b2d0: 6966 6963 616e 6365 5f6c 6576 656c 2c20  ificance_level, 
-0001b2e0: 7761 7665 6c65 743d 7761 7665 6c65 742c  wavelet=wavelet,
-0001b2f0: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-0001b300: 2020 290a 2020 2020 656c 7365 3a0a 2020    ).    else:.  
-0001b310: 2020 2020 2020 7369 6720 3d20 6e70 2e61        sig = np.a
-0001b320: 7361 7272 6179 285b 305d 290a 0a20 2020  sarray([0])..   
-0001b330: 2072 6574 7572 6e20 5743 542c 2061 5743   return WCT, aWC
-0001b340: 542c 2063 6f69 2c20 6672 6571 2c20 7369  T, coi, freq, si
-0001b350: 670a 0a0a 2323 2323 2323 2323 2323 2323  g...############
-0001b360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000182d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000182e0: 2323 2323 2323 2323 2323 2323 0a0a 2222  ############..""
+000182f0: 220a 6265 6c6f 7720 6172 6520 6173 7365  ".below are asse
+00018300: 6d62 6c79 206f 6620 7468 6520 6d6f 6e69  mbly of the moni
+00018310: 746f 7269 6e67 2075 7469 6c69 7479 2066  toring utility f
+00018320: 756e 6374 696f 6e73 2063 616c 6c65 6420  unctions called 
+00018330: 6279 206d 6f6e 6974 6f72 696e 6720 6675  by monitoring fu
+00018340: 6e63 7469 6f6e 730a 2222 220a 0a0a 6465  nctions."""...de
+00018350: 6620 736d 6f6f 7468 2878 2c20 7769 6e64  f smooth(x, wind
+00018360: 6f77 3d22 626f 7863 6172 222c 2068 616c  ow="boxcar", hal
+00018370: 665f 7769 6e3d 3329 3a0a 2020 2020 2222  f_win=3):.    ""
+00018380: 220a 2020 2020 7065 7266 6f72 6d73 2073  ".    performs s
+00018390: 6d6f 6f74 6869 6e67 2069 6e20 696e 7465  moothing in inte
+000183a0: 7265 7374 6564 2074 696d 6520 7769 6e64  rested time wind
+000183b0: 6f77 0a0a 2020 2020 5061 7261 6d65 7465  ow..    Paramete
+000183c0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+000183d0: 2d2d 2d2d 2d0a 2020 2020 783a 2074 696d  -----.    x: tim
+000183e0: 6573 6572 6973 2064 6174 610a 2020 2020  eseris data.    
+000183f0: 7769 6e64 6f77 3a20 7479 7065 7320 6f66  window: types of
+00018400: 2077 696e 646f 7720 746f 2064 6f20 736d   window to do sm
+00018410: 6f6f 7468 696e 670a 2020 2020 6861 6c66  oothing.    half
+00018420: 5f77 696e 3a20 6861 6c66 2077 696e 646f  _win: half windo
+00018430: 7720 6c65 6e67 7468 0a0a 2020 2020 5245  w length..    RE
+00018440: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
+00018450: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00018460: 2020 793a 2073 6d6f 6f74 6865 6420 7469    y: smoothed ti
+00018470: 6d65 2077 696e 646f 770a 2020 2020 2222  me window.    ""
+00018480: 220a 2020 2020 2320 544f 444f 3a20 646f  ".    # TODO: do
+00018490: 6373 7469 6e67 0a20 2020 2077 696e 646f  csting.    windo
+000184a0: 775f 6c65 6e20 3d20 3220 2a20 6861 6c66  w_len = 2 * half
+000184b0: 5f77 696e 202b 2031 0a20 2020 2023 2065  _win + 1.    # e
+000184c0: 7874 656e 6469 6e67 2074 6865 2064 6174  xtending the dat
+000184d0: 6120 6174 2062 6567 696e 6e69 6e67 2061  a at beginning a
+000184e0: 6e64 2061 7420 7468 6520 656e 640a 2020  nd at the end.  
+000184f0: 2020 2320 746f 2061 7070 6c79 2074 6865    # to apply the
+00018500: 2077 696e 646f 7720 6174 2074 6865 2062   window at the b
+00018510: 6f72 6465 7273 0a20 2020 2073 203d 206e  orders.    s = n
+00018520: 702e 725f 5b78 5b77 696e 646f 775f 6c65  p.r_[x[window_le
+00018530: 6e20 2d20 3120 3a20 3020 3a20 2d31 5d2c  n - 1 : 0 : -1],
+00018540: 2078 2c20 785b 2d31 3a2d 7769 6e64 6f77   x, x[-1:-window
+00018550: 5f6c 656e 3a2d 315d 5d0a 2020 2020 6966  _len:-1]].    if
+00018560: 2077 696e 646f 7720 3d3d 2022 626f 7863   window == "boxc
+00018570: 6172 223a 0a20 2020 2020 2020 2077 203d  ar":.        w =
+00018580: 2073 6369 7079 2e73 6967 6e61 6c2e 626f   scipy.signal.bo
+00018590: 7863 6172 2877 696e 646f 775f 6c65 6e29  xcar(window_len)
+000185a0: 2e61 7374 7970 6528 2263 6f6d 706c 6578  .astype("complex
+000185b0: 2229 0a20 2020 2065 6c73 653a 0a20 2020  ").    else:.   
+000185c0: 2020 2020 2077 203d 2073 6369 7079 2e73       w = scipy.s
+000185d0: 6967 6e61 6c2e 6861 6e6e 696e 6728 7769  ignal.hanning(wi
+000185e0: 6e64 6f77 5f6c 656e 292e 6173 7479 7065  ndow_len).astype
+000185f0: 2822 636f 6d70 6c65 7822 290a 2020 2020  ("complex").    
+00018600: 7920 3d20 6e70 2e63 6f6e 766f 6c76 6528  y = np.convolve(
+00018610: 7720 2f20 772e 7375 6d28 292c 2073 2c20  w / w.sum(), s, 
+00018620: 6d6f 6465 3d22 7661 6c69 6422 290a 2020  mode="valid").  
+00018630: 2020 7265 7475 726e 2079 5b68 616c 665f    return y[half_
+00018640: 7769 6e20 3a20 6c65 6e28 7929 202d 2068  win : len(y) - h
+00018650: 616c 665f 7769 6e5d 0a0a 0a64 6566 206e  alf_win]...def n
+00018660: 6578 7470 6f77 3228 7829 3a0a 2020 2020  extpow2(x):.    
+00018670: 2222 220a 2020 2020 5265 7475 726e 7320  """.    Returns 
+00018680: 7468 6520 6e65 7874 2070 6f77 6572 206f  the next power o
+00018690: 6620 3220 6f66 2078 2e0a 2020 2020 2222  f 2 of x..    ""
+000186a0: 220a 2020 2020 7265 7475 726e 2069 6e74  ".    return int
+000186b0: 286e 702e 6365 696c 286e 702e 6c6f 6732  (np.ceil(np.log2
+000186c0: 286e 702e 6162 7328 7829 2929 290a 0a0a  (np.abs(x))))...
+000186d0: 6465 6620 6765 7443 6f68 6572 656e 6365  def getCoherence
+000186e0: 2864 6373 2c20 6473 312c 2064 7332 293a  (dcs, ds1, ds2):
+000186f0: 0a20 2020 2022 2222 0a20 2020 2067 6574  .    """.    get
+00018700: 2063 726f 7373 2063 6f68 6572 656e 6365   cross coherence
+00018710: 2062 6574 7765 656e 2072 6566 6572 656e   between referen
+00018720: 6365 2061 6e64 2063 7572 7265 6e74 2077  ce and current w
+00018730: 6176 6566 6f72 6d73 2066 6f6c 6c6f 7769  aveforms followi
+00018740: 6e67 2065 7175 6174 696f 6e20 6f66 2041  ng equation of A
+00018750: 3320 696e 2043 6c61 726b 2065 7420 616c  3 in Clark et al
+00018760: 2e2c 2032 3031 310a 0a20 2020 2050 6172  ., 2011..    Par
+00018770: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00018780: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2064  ----------.    d
+00018790: 6373 3a20 616d 706c 6974 7564 6520 6f66  cs: amplitude of
+000187a0: 2074 6865 2063 726f 7373 2073 7065 6374   the cross spect
+000187b0: 7275 6d0a 2020 2020 6473 313a 2061 6d70  rum.    ds1: amp
+000187c0: 6c69 7475 6465 206f 6620 7468 6520 7370  litude of the sp
+000187d0: 6563 7472 756d 206f 6620 6375 7272 656e  ectrum of curren
+000187e0: 7420 7761 7665 666f 726d 0a20 2020 2064  t waveform.    d
+000187f0: 7332 3a20 616d 706c 6974 7564 6520 6f66  s2: amplitude of
+00018800: 2074 6865 2073 7065 6374 7275 6d20 6f66   the spectrum of
+00018810: 2072 6566 6572 656e 6365 2077 6176 6566   reference wavef
+00018820: 6f72 6d0a 0a20 2020 2052 4554 5552 4e53  orm..    RETURNS
+00018830: 3a0a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  :.    ----------
+00018840: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6f68  --------.    coh
+00018850: 3a20 636f 6872 6572 656e 6379 206d 6174  : cohrerency mat
+00018860: 7269 7820 7573 6564 2066 6f72 2065 7374  rix used for est
+00018870: 696d 6174 6520 7468 6520 726f 6275 7374  imate the robust
+00018880: 6e65 7373 206f 6620 7468 6520 6372 6f73  ness of the cros
+00018890: 7320 7370 6563 7472 756d 0a20 2020 2022  s spectrum.    "
+000188a0: 2222 0a20 2020 206e 203d 206c 656e 2864  "".    n = len(d
+000188b0: 6373 290a 2020 2020 636f 6820 3d20 6e70  cs).    coh = np
+000188c0: 2e7a 6572 6f73 286e 292e 6173 7479 7065  .zeros(n).astype
+000188d0: 2822 636f 6d70 6c65 7822 290a 2020 2020  ("complex").    
+000188e0: 7661 6c69 6473 203d 206e 702e 6172 6777  valids = np.argw
+000188f0: 6865 7265 286e 702e 6c6f 6769 6361 6c5f  here(np.logical_
+00018900: 616e 6428 6e70 2e61 6273 2864 7331 2920  and(np.abs(ds1) 
+00018910: 3e20 302c 206e 702e 6162 7328 6473 3229  > 0, np.abs(ds2)
+00018920: 203e 2030 2929 0a20 2020 2063 6f68 5b76   > 0)).    coh[v
+00018930: 616c 6964 735d 203d 2064 6373 5b76 616c  alids] = dcs[val
+00018940: 6964 735d 202f 2028 6473 315b 7661 6c69  ids] / (ds1[vali
+00018950: 6473 5d20 2a20 6473 325b 7661 6c69 6473  ds] * ds2[valids
+00018960: 5d29 0a20 2020 2063 6f68 5b63 6f68 203e  ]).    coh[coh >
+00018970: 2028 312e 3020 2b20 306a 295d 203d 2031   (1.0 + 0j)] = 1
+00018980: 2e30 202b 2030 6a0a 2020 2020 7265 7475  .0 + 0j.    retu
+00018990: 726e 2063 6f68 0a0a 0a64 6566 2063 6f6d  rn coh...def com
+000189a0: 7075 7465 4572 726f 7246 756e 6374 696f  puteErrorFunctio
+000189b0: 6e28 7531 2c20 7530 2c20 6e53 616d 706c  n(u1, u0, nSampl
+000189c0: 652c 206c 6167 2c20 6e6f 726d 3d22 4c32  e, lag, norm="L2
+000189d0: 2229 3a0a 2020 2020 2222 220a 2020 2020  "):.    """.    
+000189e0: 636f 6d70 7574 6520 4572 726f 7220 4675  compute Error Fu
+000189f0: 6e63 7469 6f6e 2075 7365 6420 696e 2044  nction used in D
+00018a00: 5457 2e20 5468 6520 6572 726f 7220 6675  TW. The error fu
+00018a10: 6e63 7469 6f6e 2069 7320 6571 7561 7469  nction is equati
+00018a20: 6f6e 2031 2069 6e20 4861 6c65 2c20 3230  on 1 in Hale, 20
+00018a30: 3133 2e20 596f 7520 636f 756c 6420 756e  13. You could un
+00018a40: 636f 6d6d 656e 7420 7468 650a 2020 2020  comment the.    
+00018a50: 4c31 206e 6f72 6d20 616e 6420 636f 6d6d  L1 norm and comm
+00018a60: 656e 7420 7468 6520 4c32 206e 6f72 6d20  ent the L2 norm 
+00018a70: 6966 2079 6f75 2077 616e 7420 6f6e 204c  if you want on L
+00018a80: 696e 6520 3239 0a0a 2020 2020 5061 7261  ine 29..    Para
+00018a90: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00018aa0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7531  ---------.    u1
+00018ab0: 3a20 2074 7261 6365 2074 6861 7420 7765  :  trace that we
+00018ac0: 2077 616e 7420 746f 2077 6172 703b 2073   want to warp; s
+00018ad0: 697a 6520 3d20 286e 7361 6d70 2c31 290a  ize = (nsamp,1).
+00018ae0: 2020 2020 7530 3a20 2072 6566 6572 656e      u0:  referen
+00018af0: 6365 2074 7261 6365 2074 6f20 636f 6d70  ce trace to comp
+00018b00: 6172 6520 7769 7468 3a20 7369 7a65 203d  are with: size =
+00018b10: 2028 6e73 616d 702c 3129 0a20 2020 206e   (nsamp,1).    n
+00018b20: 5361 6d70 6c65 3a20 6e75 6d65 7220 6f66  Sample: numer of
+00018b30: 2070 6f69 6e74 7320 746f 2063 6f6d 7061   points to compa
+00018b40: 7265 2069 6e20 7468 6520 7472 6163 6573  re in the traces
+00018b50: 0a20 2020 206c 6167 3a20 6d61 7869 6d75  .    lag: maximu
+00018b60: 6d20 6c61 6720 696e 2073 616d 706c 6520  m lag in sample 
+00018b70: 6e75 6d62 6572 2074 6f20 7365 6172 6368  number to search
+00018b80: 0a20 2020 206e 6f72 6d3a 2027 4c32 2720  .    norm: 'L2' 
+00018b90: 6f72 2027 4c31 2720 2864 6566 6175 6c74  or 'L1' (default
+00018ba0: 2069 7320 274c 3227 290a 0a20 2020 2052   is 'L2')..    R
+00018bb0: 4554 5552 4e53 3a0a 2020 2020 2d2d 2d2d  ETURNS:.    ----
+00018bc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+00018bd0: 2020 2065 7272 3a20 7468 6520 3244 2065     err: the 2D e
+00018be0: 7272 6f72 2066 756e 6374 696f 6e3b 2073  rror function; s
+00018bf0: 697a 6520 3d20 286e 7361 6d70 2c32 2a6c  ize = (nsamp,2*l
+00018c00: 6167 2b31 290a 0a20 2020 204f 7269 6769  ag+1)..    Origi
+00018c10: 6e61 6c20 6279 2044 6920 5961 6e67 0a20  nal by Di Yang. 
+00018c20: 2020 204c 6173 7420 6d6f 6469 6669 6564     Last modified
+00018c30: 2062 7920 4479 6c61 6e20 4d69 6b65 7365   by Dylan Mikese
+00018c40: 6c6c 2028 3235 2046 6562 2e20 3230 3135  ll (25 Feb. 2015
+00018c50: 290a 2020 2020 5472 616e 736c 6174 6564  ).    Translated
+00018c60: 2074 6f20 7079 7468 6f6e 2062 7920 5469   to python by Ti
+00018c70: 6d20 436c 656d 656e 7473 2028 3137 2041  m Clements (17 A
+00018c80: 7567 2e20 3230 3138 290a 0a20 2020 2022  ug. 2018)..    "
+00018c90: 2222 0a0a 2020 2020 6966 206c 6167 203e  ""..    if lag >
+00018ca0: 3d20 6e53 616d 706c 653a 0a20 2020 2020  = nSample:.     
+00018cb0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00018cc0: 726f 7228 2263 6f6d 7075 7465 4572 726f  ror("computeErro
+00018cd0: 7246 756e 6374 696f 6e3a 6c61 6750 726f  rFunction:lagPro
+00018ce0: 626c 656d 222c 2022 6c61 6720 6d75 7374  blem", "lag must
+00018cf0: 2062 6520 736d 616c 6c65 7220 7468 616e   be smaller than
+00018d00: 206e 5361 6d70 6c65 2229 0a0a 2020 2020   nSample")..    
+00018d10: 2320 416c 6c6f 6361 7465 2065 7272 6f72  # Allocate error
+00018d20: 2066 756e 6374 696f 6e20 7661 7269 6162   function variab
+00018d30: 6c65 0a20 2020 2065 7272 203d 206e 702e  le.    err = np.
+00018d40: 7a65 726f 7328 5b6e 5361 6d70 6c65 2c20  zeros([nSample, 
+00018d50: 3220 2a20 6c61 6720 2b20 315d 290a 0a20  2 * lag + 1]).. 
+00018d60: 2020 2023 2069 6e69 7469 616c 2065 7272     # initial err
+00018d70: 6f72 2063 616c 6375 6c61 7469 6f6e 0a20  or calculation. 
+00018d80: 2020 2023 206c 6f6f 7020 6f76 6572 206c     # loop over l
+00018d90: 6167 730a 2020 2020 666f 7220 6c6c 2069  ags.    for ll i
+00018da0: 6e20 6e70 2e61 7261 6e67 6528 2d6c 6167  n np.arange(-lag
+00018db0: 2c20 6c61 6720 2b20 3129 3a0a 2020 2020  , lag + 1):.    
+00018dc0: 2020 2020 7468 6973 4c61 6720 3d20 6c6c      thisLag = ll
+00018dd0: 202b 206c 6167 0a0a 2020 2020 2020 2020   + lag..        
+00018de0: 2320 6c6f 6f70 206f 7665 7220 7361 6d70  # loop over samp
+00018df0: 6c65 730a 2020 2020 2020 2020 666f 7220  les.        for 
+00018e00: 6969 2069 6e20 7261 6e67 6528 6e53 616d  ii in range(nSam
+00018e10: 706c 6529 3a0a 2020 2020 2020 2020 2020  ple):.          
+00018e20: 2020 2320 736b 6970 2063 6f72 6e65 7273    # skip corners
+00018e30: 2066 6f72 206e 6f77 2c20 7765 2077 696c   for now, we wil
+00018e40: 6c20 636f 6d65 2062 6163 6b20 746f 2074  l come back to t
+00018e50: 6865 7365 0a20 2020 2020 2020 2020 2020  hese.           
+00018e60: 2069 6620 2869 6920 2b20 6c6c 203e 3d20   if (ii + ll >= 
+00018e70: 3029 2026 2028 6969 202b 206c 6c20 3c20  0) & (ii + ll < 
+00018e80: 6e53 616d 706c 6529 3a0a 2020 2020 2020  nSample):.      
+00018e90: 2020 2020 2020 2020 2020 6572 725b 6969            err[ii
+00018ea0: 2c20 7468 6973 4c61 675d 203d 2075 315b  , thisLag] = u1[
+00018eb0: 6969 5d20 2d20 7530 5b69 6920 2b20 6c6c  ii] - u0[ii + ll
+00018ec0: 5d0a 0a20 2020 2069 6620 6e6f 726d 203d  ]..    if norm =
+00018ed0: 3d20 224c 3222 3a0a 2020 2020 2020 2020  = "L2":.        
+00018ee0: 6572 7220 3d20 6572 722a 2a32 0a20 2020  err = err**2.   
+00018ef0: 2065 6c69 6620 6e6f 726d 203d 3d20 224c   elif norm == "L
+00018f00: 3122 3a0a 2020 2020 2020 2020 6572 7220  1":.        err 
+00018f10: 3d20 6e70 2e61 6273 2865 7272 290a 0a20  = np.abs(err).. 
+00018f20: 2020 2023 204e 6f77 2066 6978 2063 6f72     # Now fix cor
+00018f30: 6e65 7273 2077 6974 6820 636f 6e73 7461  ners with consta
+00018f40: 6e74 2065 7874 7261 706f 6c61 7469 6f6e  nt extrapolation
+00018f50: 0a20 2020 2066 6f72 206c 6c20 696e 206e  .    for ll in n
+00018f60: 702e 6172 616e 6765 282d 6c61 672c 206c  p.arange(-lag, l
+00018f70: 6167 202b 2031 293a 0a20 2020 2020 2020  ag + 1):.       
+00018f80: 2074 6869 734c 6167 203d 206c 6c20 2b20   thisLag = ll + 
+00018f90: 6c61 670a 0a20 2020 2020 2020 2066 6f72  lag..        for
+00018fa0: 2069 6920 696e 2072 616e 6765 286e 5361   ii in range(nSa
+00018fb0: 6d70 6c65 293a 0a20 2020 2020 2020 2020  mple):.         
+00018fc0: 2020 2069 6620 6969 202b 206c 6c20 3c20     if ii + ll < 
+00018fd0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00018fe0: 2020 2065 7272 5b69 692c 2074 6869 734c     err[ii, thisL
+00018ff0: 6167 5d20 3d20 6572 725b 2d6c 6c2c 2074  ag] = err[-ll, t
+00019000: 6869 734c 6167 5d0a 0a20 2020 2020 2020  hisLag]..       
+00019010: 2020 2020 2065 6c69 6620 6969 202b 206c       elif ii + l
+00019020: 6c20 3e20 6e53 616d 706c 6520 2d20 313a  l > nSample - 1:
+00019030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019040: 2065 7272 5b69 692c 2074 6869 734c 6167   err[ii, thisLag
+00019050: 5d20 3d20 6572 725b 6e53 616d 706c 6520  ] = err[nSample 
+00019060: 2d20 6c6c 202d 2031 2c20 7468 6973 4c61  - ll - 1, thisLa
+00019070: 675d 0a0a 2020 2020 7265 7475 726e 2065  g]..    return e
+00019080: 7272 0a0a 0a64 6566 2061 6363 756d 756c  rr...def accumul
+00019090: 6174 6545 7272 6f72 4675 6e63 7469 6f6e  ateErrorFunction
+000190a0: 2864 6972 2c20 6572 722c 206e 5361 6d70  (dir, err, nSamp
+000190b0: 6c65 2c20 6c61 672c 2062 293a 0a20 2020  le, lag, b):.   
+000190c0: 2022 2222 0a20 2020 2061 6363 756d 756c   """.    accumul
+000190d0: 6174 696f 6e20 6f66 2074 6865 2065 7272  ation of the err
+000190e0: 6f72 2c20 7768 6963 6820 666f 6c6c 6f77  or, which follow
+000190f0: 7320 7468 6520 6571 7561 7469 6f6e 2036  s the equation 6
+00019100: 2069 6e20 4861 6c65 2c20 3230 3133 2e0a   in Hale, 2013..
+00019110: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00019120: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d      ------------
+00019130: 2d2d 0a20 2020 2064 6972 3a20 6163 6375  --.    dir: accu
+00019140: 6d75 6c61 7469 6f6e 2064 6972 6563 7469  mulation directi
+00019150: 6f6e 2028 2064 6972 203e 2030 203d 2066  on ( dir > 0 = f
+00019160: 6f72 7761 7264 2069 6e20 7469 6d65 2c20  orward in time, 
+00019170: 6469 7220 3c3d 2030 203d 2062 6163 6b77  dir <= 0 = backw
+00019180: 6172 6420 696e 2074 696d 6529 0a20 2020  ard in time).   
+00019190: 2065 7272 3a20 7468 6520 3244 2065 7272   err: the 2D err
+000191a0: 6f72 2066 756e 6374 696f 6e3b 2073 697a  or function; siz
+000191b0: 6520 3d20 286e 7361 6d70 2c32 2a6c 6167  e = (nsamp,2*lag
+000191c0: 2b31 290a 2020 2020 6e53 616d 706c 653a  +1).    nSample:
+000191d0: 206e 756d 6572 206f 6620 706f 696e 7473   numer of points
+000191e0: 2074 6f20 636f 6d70 6172 6520 696e 2074   to compare in t
+000191f0: 6865 2074 7261 6365 730a 2020 2020 6c61  he traces.    la
+00019200: 673a 206d 6178 696d 756d 206c 6167 2069  g: maximum lag i
+00019210: 6e20 7361 6d70 6c65 206e 756d 6265 7220  n sample number 
+00019220: 746f 2073 6561 7263 680a 2020 2020 623a  to search.    b:
+00019230: 2073 7472 6169 6e20 6c69 6d69 7420 2869   strain limit (i
+00019240: 6e74 6567 6572 2076 616c 7565 203e 3d20  nteger value >= 
+00019250: 3129 0a0a 2020 2020 5245 5455 524e 533a  1)..    RETURNS:
+00019260: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d  .    -----------
+00019270: 2d2d 2d2d 2d2d 2d0a 2020 2020 643a 2074  -------.    d: t
+00019280: 6865 2032 4420 6469 7374 616e 6365 2066  he 2D distance f
+00019290: 756e 6374 696f 6e3b 2073 697a 6520 3d20  unction; size = 
+000192a0: 286e 7361 6d70 2c32 2a6c 6167 2b31 290a  (nsamp,2*lag+1).
+000192b0: 0a20 2020 204f 7269 6769 6e61 6c20 6279  .    Original by
+000192c0: 2044 6920 5961 6e67 0a20 2020 204c 6173   Di Yang.    Las
+000192d0: 7420 6d6f 6469 6669 6564 2062 7920 4479  t modified by Dy
+000192e0: 6c61 6e20 4d69 6b65 7365 6c6c 2028 3235  lan Mikesell (25
+000192f0: 2046 6562 2e20 3230 3135 290a 2020 2020   Feb. 2015).    
+00019300: 5472 616e 736c 6174 6564 2074 6f20 7079  Translated to py
+00019310: 7468 6f6e 2062 7920 5469 6d20 436c 656d  thon by Tim Clem
+00019320: 656e 7473 2028 3137 2041 7567 2e20 3230  ents (17 Aug. 20
+00019330: 3138 290a 0a20 2020 2022 2222 0a0a 2020  18)..    """..  
+00019340: 2020 2320 6e75 6d62 6572 206f 6620 6c61    # number of la
+00019350: 6773 2066 726f 6d20 5b20 2d6c 6167 203a  gs from [ -lag :
+00019360: 202b 6c61 6720 5d0a 2020 2020 6e4c 6167   +lag ].    nLag
+00019370: 203d 2028 3220 2a20 6c61 6729 202b 2031   = (2 * lag) + 1
+00019380: 0a0a 2020 2020 2320 616c 6c6f 6361 7465  ..    # allocate
+00019390: 2064 6973 7461 6e63 6520 6d61 7472 6978   distance matrix
+000193a0: 0a20 2020 2064 203d 206e 702e 7a65 726f  .    d = np.zero
+000193b0: 7328 5b6e 5361 6d70 6c65 2c20 6e4c 6167  s([nSample, nLag
+000193c0: 5d29 0a0a 2020 2020 2320 5365 7475 7020  ])..    # Setup 
+000193d0: 696e 6469 6365 7320 6261 7365 6420 6f6e  indices based on
+000193e0: 2066 6f72 7761 7264 206f 7220 6261 636b   forward or back
+000193f0: 7761 7264 2061 6363 756d 756c 6174 696f  ward accumulatio
+00019400: 6e20 6469 7265 6374 696f 6e0a 2020 2020  n direction.    
+00019410: 6966 2064 6972 203e 2030 3a20 2023 2046  if dir > 0:  # F
+00019420: 4f52 5741 5244 0a20 2020 2020 2020 2069  ORWARD.        i
+00019430: 4265 6769 6e2c 2069 456e 642c 2069 496e  Begin, iEnd, iIn
+00019440: 6320 3d20 302c 206e 5361 6d70 6c65 202d  c = 0, nSample -
+00019450: 2031 2c20 310a 2020 2020 656c 7365 3a20   1, 1.    else: 
+00019460: 2023 2042 4143 4b57 4152 440a 2020 2020   # BACKWARD.    
+00019470: 2020 2020 6942 6567 696e 2c20 6945 6e64      iBegin, iEnd
+00019480: 2c20 6949 6e63 203d 206e 5361 6d70 6c65  , iInc = nSample
+00019490: 202d 2031 2c20 302c 202d 310a 0a20 2020   - 1, 0, -1..   
+000194a0: 2023 204c 6f6f 7020 7468 726f 7567 6820   # Loop through 
+000194b0: 616c 6c20 7469 6d65 7320 6969 2069 6e20  all times ii in 
+000194c0: 666f 7277 6172 6420 6f72 2062 6163 6b77  forward or backw
+000194d0: 6172 6420 6469 7265 6374 696f 6e0a 2020  ard direction.  
+000194e0: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
+000194f0: 6528 6942 6567 696e 2c20 6945 6e64 202b  e(iBegin, iEnd +
+00019500: 2069 496e 632c 2069 496e 6329 3a0a 2020   iInc, iInc):.  
+00019510: 2020 2020 2020 2320 6d69 6e2f 6d61 7820        # min/max 
+00019520: 746f 2061 6363 6f75 6e74 2066 6f72 2074  to account for t
+00019530: 6865 2065 6467 6573 2f62 6f75 6e64 6172  he edges/boundar
+00019540: 6965 730a 2020 2020 2020 2020 6a69 203d  ies.        ji =
+00019550: 206d 6178 285b 302c 206d 696e 285b 6e53   max([0, min([nS
+00019560: 616d 706c 6520 2d20 312c 2069 6920 2d20  ample - 1, ii - 
+00019570: 6949 6e63 5d29 5d29 0a20 2020 2020 2020  iInc])]).       
+00019580: 206a 6220 3d20 6d61 7828 5b30 2c20 6d69   jb = max([0, mi
+00019590: 6e28 5b6e 5361 6d70 6c65 202d 2031 2c20  n([nSample - 1, 
+000195a0: 6969 202d 2069 496e 6320 2a20 625d 295d  ii - iInc * b])]
+000195b0: 290a 0a20 2020 2020 2020 2023 206c 6f6f  )..        # loo
+000195c0: 7020 7468 726f 7567 6820 616c 6c20 6c61  p through all la
+000195d0: 670a 2020 2020 2020 2020 666f 7220 6c6c  g.        for ll
+000195e0: 2069 6e20 7261 6e67 6528 6e4c 6167 293a   in range(nLag):
+000195f0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
+00019600: 6865 636b 206c 696d 6974 7320 6f6e 206c  heck limits on l
+00019610: 6167 2069 6e64 6963 6573 0a20 2020 2020  ag indices.     
+00019620: 2020 2020 2020 206c 4d69 6e75 7331 203d         lMinus1 =
+00019630: 206c 6c20 2d20 310a 0a20 2020 2020 2020   ll - 1..       
+00019640: 2020 2020 2023 2063 6865 636b 206c 6167       # check lag
+00019650: 2069 6e64 6578 2069 7320 6772 6561 7465   index is greate
+00019660: 7220 7468 616e 2030 0a20 2020 2020 2020  r than 0.       
+00019670: 2020 2020 2069 6620 6c4d 696e 7573 3120       if lMinus1 
+00019680: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
+00019690: 2020 2020 206c 4d69 6e75 7331 203d 2030       lMinus1 = 0
+000196a0: 2020 2320 6d61 6b65 206c 6167 203d 2066    # make lag = f
+000196b0: 6972 7374 206c 6167 0a0a 2020 2020 2020  irst lag..      
+000196c0: 2020 2020 2020 6c50 6c75 7331 203d 206c        lPlus1 = l
+000196d0: 6c20 2b20 3120 2023 206c 6167 2061 7420  l + 1  # lag at 
+000196e0: 6c2b 310a 0a20 2020 2020 2020 2020 2020  l+1..           
+000196f0: 2023 2063 6865 636b 206c 6167 2069 6e64   # check lag ind
+00019700: 6578 206c 6573 7320 7468 616e 206d 6178  ex less than max
+00019710: 206c 6167 0a20 2020 2020 2020 2020 2020   lag.           
+00019720: 2069 6620 6c50 6c75 7331 203e 206e 4c61   if lPlus1 > nLa
+00019730: 6720 2d20 313a 0a20 2020 2020 2020 2020  g - 1:.         
+00019740: 2020 2020 2020 206c 506c 7573 3120 3d20         lPlus1 = 
+00019750: 6e4c 6167 202d 2031 0a0a 2020 2020 2020  nLag - 1..      
+00019760: 2020 2020 2020 2320 6765 7420 6469 7374        # get dist
+00019770: 616e 6365 2061 7420 6c61 6773 2028 6c6c  ance at lags (ll
+00019780: 2d31 2c20 6c6c 2c20 6c6c 2b31 290a 2020  -1, ll, ll+1).  
+00019790: 2020 2020 2020 2020 2020 6469 7374 4c6d            distLm
+000197a0: 696e 7573 3120 3d20 645b 6a62 2c20 6c4d  inus1 = d[jb, lM
+000197b0: 696e 7573 315d 2020 2320 6d69 6e75 733a  inus1]  # minus:
+000197c0: 2020 645b 692d 622c 206a 2d31 5d0a 2020    d[i-b, j-1].  
+000197d0: 2020 2020 2020 2020 2020 6469 7374 4c20            distL 
+000197e0: 3d20 645b 6a69 2c20 6c6c 5d20 2023 2061  = d[ji, ll]  # a
+000197f0: 6374 7561 6c20 645b 692d 312c 206a 5d0a  ctual d[i-1, j].
+00019800: 2020 2020 2020 2020 2020 2020 6469 7374              dist
+00019810: 4c70 6c75 7331 203d 2064 5b6a 622c 206c  Lplus1 = d[jb, l
+00019820: 506c 7573 315d 2020 2320 706c 7573 2064  Plus1]  # plus d
+00019830: 5b69 2d62 2c20 6a2b 315d 0a0a 2020 2020  [i-b, j+1]..    
+00019840: 2020 2020 2020 2020 6966 206a 6920 213d          if ji !=
+00019850: 206a 623a 2020 2320 6571 7561 7469 6f6e   jb:  # equation
+00019860: 2031 3020 696e 2048 616c 652c 2032 3031   10 in Hale, 201
+00019870: 330a 2020 2020 2020 2020 2020 2020 2020  3.              
+00019880: 2020 666f 7220 6b62 2069 6e20 7261 6e67    for kb in rang
+00019890: 6528 6a69 2c20 6a62 202b 2069 496e 6320  e(ji, jb + iInc 
+000198a0: 2d20 312c 202d 6949 6e63 293a 0a20 2020  - 1, -iInc):.   
+000198b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000198c0: 2064 6973 744c 6d69 6e75 7331 203d 2064   distLminus1 = d
+000198d0: 6973 744c 6d69 6e75 7331 202b 2065 7272  istLminus1 + err
+000198e0: 5b6b 622c 206c 4d69 6e75 7331 5d0a 2020  [kb, lMinus1].  
+000198f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019900: 2020 6469 7374 4c70 6c75 7331 203d 2064    distLplus1 = d
+00019910: 6973 744c 706c 7573 3120 2b20 6572 725b  istLplus1 + err[
+00019920: 6b62 2c20 6c50 6c75 7331 5d0a 0a20 2020  kb, lPlus1]..   
+00019930: 2020 2020 2020 2020 2023 2065 7175 6174           # equat
+00019940: 696f 6e20 3620 2869 6620 623d 3129 206f  ion 6 (if b=1) o
+00019950: 7220 3130 2028 6966 2062 3e31 2920 696e  r 10 (if b>1) in
+00019960: 2048 616c 6520 2832 3031 3329 2061 6674   Hale (2013) aft
+00019970: 6572 2074 7265 6174 696e 6720 626f 756e  er treating boun
+00019980: 6461 7269 6573 0a20 2020 2020 2020 2020  daries.         
+00019990: 2020 2064 5b69 692c 206c 6c5d 203d 2065     d[ii, ll] = e
+000199a0: 7272 5b69 692c 206c 6c5d 202b 206d 696e  rr[ii, ll] + min
+000199b0: 285b 6469 7374 4c6d 696e 7573 312c 2064  ([distLminus1, d
+000199c0: 6973 744c 2c20 6469 7374 4c70 6c75 7331  istL, distLplus1
+000199d0: 5d29 0a0a 2020 2020 7265 7475 726e 2064  ])..    return d
+000199e0: 0a0a 0a64 6566 2062 6163 6b74 7261 636b  ...def backtrack
+000199f0: 4469 7374 616e 6365 4675 6e63 7469 6f6e  DistanceFunction
+00019a00: 2864 6972 2c20 642c 2065 7272 2c20 6c6d  (dir, d, err, lm
+00019a10: 696e 2c20 6229 3a0a 2020 2020 2222 220a  in, b):.    """.
+00019a20: 2020 2020 5468 6520 6675 6e63 7469 6f6e      The function
+00019a30: 2069 7320 6571 7561 7469 6f6e 2032 2069   is equation 2 i
+00019a40: 6e20 4861 6c65 2c20 3230 3133 2e0a 0a20  n Hale, 2013... 
+00019a50: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00019a60: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    --------------
+00019a70: 0a20 2020 2064 6972 3a20 7369 6465 2074  .    dir: side t
+00019a80: 6f20 7374 6172 7420 6d69 6e69 6d69 7a61  o start minimiza
+00019a90: 7469 6f6e 2028 2064 6972 203e 2030 203d  tion ( dir > 0 =
+00019aa0: 2066 726f 6e74 2c20 6469 7220 3c3d 2030   front, dir <= 0
+00019ab0: 203d 2020 6261 636b 290a 2020 2020 6420   =  back).    d 
+00019ac0: 3a20 7468 6520 3244 2064 6973 7461 6e63  : the 2D distanc
+00019ad0: 6520 6675 6e63 7469 6f6e 3b20 7369 7a65  e function; size
+00019ae0: 203d 2028 6e73 616d 702c 322a 6c61 672b   = (nsamp,2*lag+
+00019af0: 3129 0a20 2020 2065 7272 3a20 7468 6520  1).    err: the 
+00019b00: 3244 2065 7272 6f72 2066 756e 6374 696f  2D error functio
+00019b10: 6e3b 2073 697a 6520 3d20 286e 7361 6d70  n; size = (nsamp
+00019b20: 2c32 2a6c 6167 2b31 290a 2020 2020 6c6d  ,2*lag+1).    lm
+00019b30: 696e 3a20 6d69 6e69 6d75 6d20 6c61 6720  in: minimum lag 
+00019b40: 746f 2073 6561 7263 6820 6f76 6572 0a20  to search over. 
+00019b50: 2020 2062 203a 2073 7472 6169 6e20 6c69     b : strain li
+00019b60: 6d69 7420 2869 6e74 6567 6572 2076 616c  mit (integer val
+00019b70: 7565 203e 3d20 3129 0a0a 2020 2020 5245  ue >= 1)..    RE
+00019b80: 5455 524e 533a 0a20 2020 202d 2d2d 2d2d  TURNS:.    -----
+00019b90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00019ba0: 2020 7374 6261 723a 2076 6563 746f 7220    stbar: vector 
+00019bb0: 6f66 2069 6e74 6567 6572 2073 6869 6674  of integer shift
+00019bc0: 7320 7375 626a 6563 7420 746f 207c 7528  s subject to |u(
+00019bd0: 6929 2d75 2869 2d31 297c 203c 3d20 312f  i)-u(i-1)| <= 1/
+00019be0: 620a 0a20 2020 204f 7269 6769 6e61 6c20  b..    Original 
+00019bf0: 6279 2044 6920 5961 6e67 0a20 2020 204c  by Di Yang.    L
+00019c00: 6173 7420 6d6f 6469 6669 6564 2062 7920  ast modified by 
+00019c10: 4479 6c61 6e20 4d69 6b65 7365 6c6c 2028  Dylan Mikesell (
+00019c20: 3139 2044 6563 2e20 3230 3134 290a 0a20  19 Dec. 2014).. 
+00019c30: 2020 2054 7261 6e73 6c61 7465 6420 746f     Translated to
+00019c40: 2070 7974 686f 6e20 6279 2054 696d 2043   python by Tim C
+00019c50: 6c65 6d65 6e74 7320 2831 3720 4175 672e  lements (17 Aug.
+00019c60: 2032 3031 3829 0a0a 2020 2020 2222 220a   2018)..    """.
+00019c70: 0a20 2020 206e 5361 6d70 6c65 2c20 6e4c  .    nSample, nL
+00019c80: 6167 203d 2064 2e73 6861 7065 0a20 2020  ag = d.shape.   
+00019c90: 2073 7462 6172 203d 206e 702e 7a65 726f   stbar = np.zero
+00019ca0: 7328 6e53 616d 706c 6529 0a0a 2020 2020  s(nSample)..    
+00019cb0: 2320 5365 7475 7020 696e 6469 6365 7320  # Setup indices 
+00019cc0: 6261 7365 6420 6f6e 2066 6f72 7761 7264  based on forward
+00019cd0: 206f 7220 6261 636b 7761 7264 2061 6363   or backward acc
+00019ce0: 756d 756c 6174 696f 6e20 6469 7265 6374  umulation direct
+00019cf0: 696f 6e0a 2020 2020 6966 2064 6972 203e  ion.    if dir >
+00019d00: 2030 3a20 2023 2046 4f52 5741 5244 0a20   0:  # FORWARD. 
+00019d10: 2020 2020 2020 2069 4265 6769 6e2c 2069         iBegin, i
+00019d20: 456e 642c 2069 496e 6320 3d20 302c 206e  End, iInc = 0, n
+00019d30: 5361 6d70 6c65 202d 2031 2c20 310a 2020  Sample - 1, 1.  
+00019d40: 2020 656c 7365 3a20 2023 2042 4143 4b57    else:  # BACKW
+00019d50: 4152 440a 2020 2020 2020 2020 6942 6567  ARD.        iBeg
+00019d60: 696e 2c20 6945 6e64 2c20 6949 6e63 203d  in, iEnd, iInc =
+00019d70: 206e 5361 6d70 6c65 202d 2031 2c20 302c   nSample - 1, 0,
+00019d80: 202d 310a 0a20 2020 2023 2073 7461 7274   -1..    # start
+00019d90: 2066 726f 6d20 7468 6520 656e 6420 2866   from the end (f
+00019da0: 726f 6e74 206f 7220 6261 636b 290a 2020  ront or back).  
+00019db0: 2020 6c6c 203d 206e 702e 6172 676d 696e    ll = np.argmin
+00019dc0: 2864 5b69 4265 6769 6e2c 203a 5d29 2020  (d[iBegin, :])  
+00019dd0: 2320 6669 6e64 206d 696e 696d 756d 2061  # find minimum a
+00019de0: 6363 756d 756c 6174 6564 2064 6973 7461  ccumulated dista
+00019df0: 6e63 6520 6174 2066 726f 6e74 206f 7220  nce at front or 
+00019e00: 6261 636b 2064 6570 656e 6469 6e67 206f  back depending o
+00019e10: 6e20 2764 6972 270a 2020 2020 7374 6261  n 'dir'.    stba
+00019e20: 725b 6942 6567 696e 5d20 3d20 6c6c 202b  r[iBegin] = ll +
+00019e30: 206c 6d69 6e20 2023 2061 6273 6f6c 7574   lmin  # absolut
+00019e40: 6520 7661 6c75 6520 6f66 2069 6e74 6567  e value of integ
+00019e50: 6572 2073 6869 6674 0a0a 2020 2020 2320  er shift..    # 
+00019e60: 6d6f 7665 2074 6872 6f75 6768 2061 6c6c  move through all
+00019e70: 2074 696d 6520 7361 6d70 6c65 7320 696e   time samples in
+00019e80: 2066 6f72 7761 7264 206f 7220 6261 636b   forward or back
+00019e90: 7761 7264 2064 6972 6563 7469 6f6e 0a20  ward direction. 
+00019ea0: 2020 2069 6920 3d20 6942 6567 696e 0a0a     ii = iBegin..
+00019eb0: 2020 2020 7768 696c 6520 6969 2021 3d20      while ii != 
+00019ec0: 6945 6e64 3a0a 2020 2020 2020 2020 2320  iEnd:.        # 
+00019ed0: 6d69 6e2f 6d61 7820 666f 7220 6564 6765  min/max for edge
+00019ee0: 732f 626f 756e 6461 7269 6573 0a20 2020  s/boundaries.   
+00019ef0: 2020 2020 206a 6920 3d20 6e70 2e6d 6178       ji = np.max
+00019f00: 285b 302c 206e 702e 6d69 6e28 5b6e 5361  ([0, np.min([nSa
+00019f10: 6d70 6c65 202d 2031 2c20 6969 202b 2069  mple - 1, ii + i
+00019f20: 496e 635d 295d 290a 2020 2020 2020 2020  Inc])]).        
+00019f30: 6a62 203d 206e 702e 6d61 7828 5b30 2c20  jb = np.max([0, 
+00019f40: 6e70 2e6d 696e 285b 6e53 616d 706c 6520  np.min([nSample 
+00019f50: 2d20 312c 2069 6920 2b20 6949 6e63 202a  - 1, ii + iInc *
+00019f60: 2062 5d29 5d29 0a0a 2020 2020 2020 2020   b])])..        
+00019f70: 2320 6368 6563 6b20 6c69 6d69 7473 206f  # check limits o
+00019f80: 6e20 6c61 6720 696e 6469 6365 730a 2020  n lag indices.  
+00019f90: 2020 2020 2020 6c4d 696e 7573 3120 3d20        lMinus1 = 
+00019fa0: 6c6c 202d 2031 0a0a 2020 2020 2020 2020  ll - 1..        
+00019fb0: 6966 206c 4d69 6e75 7331 203c 2030 3a20  if lMinus1 < 0: 
+00019fc0: 2023 2063 6865 636b 206c 6167 2069 6e64   # check lag ind
+00019fd0: 6578 2069 7320 6772 6561 7465 7220 7468  ex is greater th
+00019fe0: 616e 2031 0a20 2020 2020 2020 2020 2020  an 1.           
+00019ff0: 206c 4d69 6e75 7331 203d 2030 2020 2320   lMinus1 = 0  # 
+0001a000: 6d61 6b65 206c 6167 203d 2066 6972 7374  make lag = first
+0001a010: 206c 6167 0a0a 2020 2020 2020 2020 6c50   lag..        lP
+0001a020: 6c75 7331 203d 206c 6c20 2b20 310a 0a20  lus1 = ll + 1.. 
+0001a030: 2020 2020 2020 2069 6620 6c50 6c75 7331         if lPlus1
+0001a040: 203e 206e 4c61 6720 2d20 313a 2020 2320   > nLag - 1:  # 
+0001a050: 6368 6563 6b20 6c61 6720 696e 6465 7820  check lag index 
+0001a060: 6c65 7373 2074 6861 6e20 6d61 7820 6c61  less than max la
+0001a070: 670a 2020 2020 2020 2020 2020 2020 6c50  g.            lP
+0001a080: 6c75 7331 203d 206e 4c61 6720 2d20 310a  lus1 = nLag - 1.
+0001a090: 0a20 2020 2020 2020 2023 2067 6574 2064  .        # get d
+0001a0a0: 6973 7461 6e63 6520 6174 206c 6167 7320  istance at lags 
+0001a0b0: 286c 6c2d 312c 206c 6c2c 206c 6c2b 3129  (ll-1, ll, ll+1)
+0001a0c0: 0a20 2020 2020 2020 2064 6973 744c 6d69  .        distLmi
+0001a0d0: 6e75 7331 203d 2064 5b6a 622c 206c 4d69  nus1 = d[jb, lMi
+0001a0e0: 6e75 7331 5d20 2023 206d 696e 7573 3a20  nus1]  # minus: 
+0001a0f0: 2064 5b69 2d62 2c20 6a2d 315d 0a20 2020   d[i-b, j-1].   
+0001a100: 2020 2020 2064 6973 744c 203d 2064 5b6a       distL = d[j
+0001a110: 692c 206c 6c5d 2020 2320 6163 7475 616c  i, ll]  # actual
+0001a120: 2064 5b69 2d31 2c20 6a5d 0a20 2020 2020   d[i-1, j].     
+0001a130: 2020 2064 6973 744c 706c 7573 3120 3d20     distLplus1 = 
+0001a140: 645b 6a62 2c20 6c50 6c75 7331 5d20 2023  d[jb, lPlus1]  #
+0001a150: 2070 6c75 7320 645b 692d 622c 206a 2b31   plus d[i-b, j+1
+0001a160: 5d0a 0a20 2020 2020 2020 2023 2065 7175  ]..        # equ
+0001a170: 6174 696f 6e20 3130 2069 6e20 4861 6c65  ation 10 in Hale
+0001a180: 2028 3230 3133 290a 2020 2020 2020 2020   (2013).        
+0001a190: 2320 7375 6d20 6572 726f 7273 206f 7665  # sum errors ove
+0001a1a0: 7220 692d 313a 692d 622b 310a 2020 2020  r i-1:i-b+1.    
+0001a1b0: 2020 2020 6966 206a 6920 213d 206a 623a      if ji != jb:
+0001a1c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001a1d0: 206b 6220 696e 2072 616e 6765 286a 692c   kb in range(ji,
+0001a1e0: 206a 6220 2d20 6949 6e63 202d 2031 2c20   jb - iInc - 1, 
+0001a1f0: 6949 6e63 293a 0a20 2020 2020 2020 2020  iInc):.         
+0001a200: 2020 2020 2020 2064 6973 744c 6d69 6e75         distLminu
+0001a210: 7331 203d 2064 6973 744c 6d69 6e75 7331  s1 = distLminus1
+0001a220: 202b 2065 7272 5b6b 622c 206c 4d69 6e75   + err[kb, lMinu
+0001a230: 7331 5d0a 2020 2020 2020 2020 2020 2020  s1].            
+0001a240: 2020 2020 6469 7374 4c70 6c75 7331 203d      distLplus1 =
+0001a250: 2064 6973 744c 706c 7573 3120 2b20 6572   distLplus1 + er
+0001a260: 725b 6b62 2c20 6c50 6c75 7331 5d0a 0a20  r[kb, lPlus1].. 
+0001a270: 2020 2020 2020 2023 2075 7064 6174 6520         # update 
+0001a280: 6d69 6e69 6d75 6d20 6469 7374 616e 6365  minimum distance
+0001a290: 2074 6f20 7072 6576 696f 7573 2073 616d   to previous sam
+0001a2a0: 706c 650a 2020 2020 2020 2020 646c 203d  ple.        dl =
+0001a2b0: 206e 702e 6d69 6e28 5b64 6973 744c 6d69   np.min([distLmi
+0001a2c0: 6e75 7331 2c20 6469 7374 4c2c 2064 6973  nus1, distL, dis
+0001a2d0: 744c 706c 7573 315d 290a 0a20 2020 2020  tLplus1])..     
+0001a2e0: 2020 2069 6620 646c 2021 3d20 6469 7374     if dl != dist
+0001a2f0: 4c3a 2020 2320 7468 656e 206c 6c20 7e3d  L:  # then ll ~=
+0001a300: 206c 6c20 616e 6420 7765 2063 6865 636b   ll and we check
+0001a310: 2066 6f72 7761 7264 2061 6e64 2062 6163   forward and bac
+0001a320: 6b77 6172 640a 2020 2020 2020 2020 2020  kward.          
+0001a330: 2020 6966 2064 6c20 3d3d 2064 6973 744c    if dl == distL
+0001a340: 6d69 6e75 7331 3a0a 2020 2020 2020 2020  minus1:.        
+0001a350: 2020 2020 2020 2020 6c6c 203d 206c 4d69          ll = lMi
+0001a360: 6e75 7331 0a20 2020 2020 2020 2020 2020  nus1.           
+0001a370: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001a380: 2020 2020 2020 206c 6c20 3d20 6c50 6c75         ll = lPlu
+0001a390: 7331 0a0a 2020 2020 2020 2020 2320 6173  s1..        # as
+0001a3a0: 7375 6d65 2069 6920 3d20 6969 202d 2031  sume ii = ii - 1
+0001a3b0: 0a20 2020 2020 2020 2069 6920 2b3d 2069  .        ii += i
+0001a3c0: 496e 630a 0a20 2020 2020 2020 2023 2061  Inc..        # a
+0001a3d0: 6273 6f6c 7574 6520 696e 7465 6765 7220  bsolute integer 
+0001a3e0: 6f66 206c 6167 0a20 2020 2020 2020 2073  of lag.        s
+0001a3f0: 7462 6172 5b69 695d 203d 206c 6c20 2b20  tbar[ii] = ll + 
+0001a400: 6c6d 696e 0a0a 2020 2020 2020 2020 2320  lmin..        # 
+0001a410: 6e6f 7720 6d6f 7665 2074 6f20 636f 7272  now move to corr
+0001a420: 6563 7420 7469 6d65 2069 6e64 6578 2c20  ect time index, 
+0001a430: 6966 2073 6d6f 6f74 6869 6e67 2064 6966  if smoothing dif
+0001a440: 6665 7265 6e63 6520 6f76 6572 206d 616e  ference over man
+0001a450: 790a 2020 2020 2020 2020 2320 7469 6d65  y.        # time
+0001a460: 2073 616d 706c 6573 2075 7369 6e67 2027   samples using '
+0001a470: 6227 0a20 2020 2020 2020 2069 6620 286c  b'.        if (l
+0001a480: 6c20 3d3d 206c 4d69 6e75 7331 2920 7c20  l == lMinus1) | 
+0001a490: 286c 6c20 3d3d 206c 506c 7573 3129 3a20  (ll == lPlus1): 
+0001a4a0: 2023 2063 6865 636b 2065 6467 6573 2074   # check edges t
+0001a4b0: 6f20 7365 6520 6162 6f75 7420 6220 7661  o see about b va
+0001a4c0: 6c75 6573 0a20 2020 2020 2020 2020 2020  lues.           
+0001a4d0: 2069 6620 6a69 2021 3d20 6a62 3a20 2023   if ji != jb:  #
+0001a4e0: 2069 6620 623e 3120 7468 656e 206e 6565   if b>1 then nee
+0001a4f0: 6420 746f 206d 6f76 6520 6d6f 7265 2073  d to move more s
+0001a500: 7465 7073 0a20 2020 2020 2020 2020 2020  teps.           
+0001a510: 2020 2020 2066 6f72 206b 6220 696e 2072       for kb in r
+0001a520: 616e 6765 286a 692c 206a 6220 2d20 6949  ange(ji, jb - iI
+0001a530: 6e63 202d 2031 2c20 6949 6e63 293a 0a20  nc - 1, iInc):. 
+0001a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a550: 2020 2069 6920 3d20 6969 202b 2069 496e     ii = ii + iIn
+0001a560: 6320 2023 206d 6f76 6520 6672 6f6d 2069  c  # move from i
+0001a570: 2d31 3a69 2d62 2d31 0a20 2020 2020 2020  -1:i-b-1.       
+0001a580: 2020 2020 2020 2020 2020 2020 2073 7462               stb
+0001a590: 6172 5b69 695d 203d 206c 6c20 2b20 6c6d  ar[ii] = ll + lm
+0001a5a0: 696e 2020 2320 636f 6e73 7461 6e74 206c  in  # constant l
+0001a5b0: 6167 206f 7665 7220 7468 6174 2074 696d  ag over that tim
+0001a5c0: 650a 0a20 2020 2072 6574 7572 6e20 7374  e..    return st
+0001a5d0: 6261 720a 0a0a 6465 6620 7763 745f 6d6f  bar...def wct_mo
+0001a5e0: 6469 6669 6564 280a 2020 2020 7931 2c20  dified(.    y1, 
+0001a5f0: 7932 2c20 6474 2c20 646a 3d31 202f 2031  y2, dt, dj=1 / 1
+0001a600: 322c 2073 303d 2d31 2c20 4a3d 2d31 2c20  2, s0=-1, J=-1, 
+0001a610: 7369 673d 5472 7565 2c20 7369 676e 6966  sig=True, signif
+0001a620: 6963 616e 6365 5f6c 6576 656c 3d30 2e39  icance_level=0.9
+0001a630: 352c 2077 6176 656c 6574 3d22 6d6f 726c  5, wavelet="morl
+0001a640: 6574 222c 206e 6f72 6d61 6c69 7a65 3d54  et", normalize=T
+0001a650: 7275 652c 202a 2a6b 7761 7267 730a 293a  rue, **kwargs.):
+0001a660: 0a20 2020 2022 2222 0a20 2020 2020 2020  .    """.       
+0001a670: 2057 6176 656c 6574 2063 6f68 6572 656e   Wavelet coheren
+0001a680: 6365 2074 7261 6e73 666f 726d 2028 5743  ce transform (WC
+0001a690: 5429 2e0a 2020 2020 e280 8b0a 2020 2020  T)..    ....    
+0001a6a0: 2020 2020 5468 6520 5743 5420 6669 6e64      The WCT find
+0001a6b0: 7320 7265 6769 6f6e 7320 696e 2074 696d  s regions in tim
+0001a6c0: 6520 6672 6571 7565 6e63 7920 7370 6163  e frequency spac
+0001a6d0: 6520 7768 6572 6520 7468 6520 7477 6f20  e where the two 
+0001a6e0: 7469 6d65 0a20 2020 2020 2020 2073 6572  time.        ser
+0001a6f0: 6965 7320 636f 2d76 6172 792c 2062 7574  ies co-vary, but
+0001a700: 2064 6f20 6e6f 7420 6e65 6365 7373 6172   do not necessar
+0001a710: 696c 7920 6861 7665 2068 6967 6820 706f  ily have high po
+0001a720: 7765 722e 0a20 2020 20e2 808b 0a20 2020  wer..    ....   
+0001a730: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+0001a740: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+0001a750: 2d2d 0a20 2020 2020 2020 2079 312c 2079  --.        y1, y
+0001a760: 3220 3a20 6e75 6d70 792e 6e64 6172 7261  2 : numpy.ndarra
+0001a770: 792c 206c 6973 740a 2020 2020 2020 2020  y, list.        
+0001a780: 2020 2020 496e 7075 7420 7369 676e 616c      Input signal
+0001a790: 732e 0a20 2020 2020 2020 2064 7420 3a20  s..        dt : 
+0001a7a0: 666c 6f61 740a 2020 2020 2020 2020 2020  float.          
+0001a7b0: 2020 5361 6d70 6c65 2073 7061 6369 6e67    Sample spacing
+0001a7c0: 2e0a 2020 2020 2020 2020 646a 203a 2066  ..        dj : f
+0001a7d0: 6c6f 6174 2c20 6f70 7469 6f6e 616c 0a20  loat, optional. 
+0001a7e0: 2020 2020 2020 2020 2020 2053 7061 6369             Spaci
+0001a7f0: 6e67 2062 6574 7765 656e 2064 6973 6372  ng between discr
+0001a800: 6574 6520 7363 616c 6573 2e20 4465 6661  ete scales. Defa
+0001a810: 756c 7420 7661 6c75 6520 6973 2031 2f31  ult value is 1/1
+0001a820: 322e 0a20 2020 2020 2020 2020 2020 2053  2..            S
+0001a830: 6d61 6c6c 6572 2076 616c 7565 7320 7769  maller values wi
+0001a840: 6c6c 2072 6573 756c 7420 696e 2062 6574  ll result in bet
+0001a850: 7465 7220 7363 616c 6520 7265 736f 6c75  ter scale resolu
+0001a860: 7469 6f6e 2c20 6275 740a 2020 2020 2020  tion, but.      
+0001a870: 2020 2020 2020 736c 6f77 6572 2063 616c        slower cal
+0001a880: 6375 6c61 7469 6f6e 2061 6e64 2070 6c6f  culation and plo
+0001a890: 742e 0a20 2020 2020 2020 2073 3020 3a20  t..        s0 : 
+0001a8a0: 666c 6f61 742c 206f 7074 696f 6e61 6c0a  float, optional.
+0001a8b0: 2020 2020 2020 2020 2020 2020 536d 616c              Smal
+0001a8c0: 6c65 7374 2073 6361 6c65 206f 6620 7468  lest scale of th
+0001a8d0: 6520 7761 7665 6c65 742e 2044 6566 6175  e wavelet. Defau
+0001a8e0: 6c74 2076 616c 7565 2069 7320 322a 6474  lt value is 2*dt
+0001a8f0: 2e0a 2020 2020 2020 2020 4a20 3a20 666c  ..        J : fl
+0001a900: 6f61 742c 206f 7074 696f 6e61 6c0a 2020  oat, optional.  
+0001a910: 2020 2020 2020 2020 2020 4e75 6d62 6572            Number
+0001a920: 206f 6620 7363 616c 6573 206c 6573 7320   of scales less 
+0001a930: 6f6e 652e 2053 6361 6c65 7320 7261 6e67  one. Scales rang
+0001a940: 6520 6672 6f6d 2073 3020 7570 2074 6f0a  e from s0 up to.
+0001a950: 2020 2020 2020 2020 2020 2020 7330 202a              s0 *
+0001a960: 2032 2a2a 284a 202a 2064 6a29 2c20 7768   2**(J * dj), wh
+0001a970: 6963 6820 6769 7665 7320 6120 746f 7461  ich gives a tota
+0001a980: 6c20 6f66 2028 4a20 2b20 3129 2073 6361  l of (J + 1) sca
+0001a990: 6c65 732e 0a20 2020 2020 2020 2020 2020  les..           
+0001a9a0: 2044 6566 6175 6c74 2069 7320 4a20 3d20   Default is J = 
+0001a9b0: 286c 6f67 3228 4e2a 6474 2f73 6f29 292f  (log2(N*dt/so))/
+0001a9c0: 646a 2e0a 2020 2020 2020 2020 7369 676e  dj..        sign
+0001a9d0: 6966 6963 616e 6365 5f6c 6576 656c 2028  ificance_level (
+0001a9e0: 666c 6f61 742c 206f 7074 696f 6e61 6c29  float, optional)
+0001a9f0: 203a 0a20 2020 2020 2020 2020 2020 2053   :.            S
+0001aa00: 6967 6e69 6669 6361 6e63 6520 6c65 7665  ignificance leve
+0001aa10: 6c20 746f 2075 7365 2e20 4465 6661 756c  l to use. Defaul
+0001aa20: 7420 6973 2030 2e39 352e 0a20 2020 2020  t is 0.95..     
+0001aa30: 2020 206e 6f72 6d61 6c69 7a65 2028 626f     normalize (bo
+0001aa40: 6f6c 6561 6e2c 206f 7074 696f 6e61 6c29  olean, optional)
+0001aa50: 203a 0a20 2020 2020 2020 2020 2020 2049   :.            I
+0001aa60: 6620 7365 7420 746f 2074 7275 652c 206e  f set to true, n
+0001aa70: 6f72 6d61 6c69 7a65 7320 4357 5420 6279  ormalizes CWT by
+0001aa80: 2074 6865 2073 7461 6e64 6172 6420 6465   the standard de
+0001aa90: 7669 6174 696f 6e20 6f66 0a20 2020 2020  viation of.     
+0001aaa0: 2020 2020 2020 2074 6865 2073 6967 6e61         the signa
+0001aab0: 6c73 2e0a 2020 2020 e280 8b0a 2020 2020  ls..    ....    
+0001aac0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+0001aad0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0001aae0: 2020 2020 544f 444f 3a20 536f 6d65 7468      TODO: Someth
+0001aaf0: 696e 6720 5442 4120 616e 6420 5442 430a  ing TBA and TBC.
+0001ab00: 2020 2020 e280 8b0a 2020 2020 2020 2020      ....        
+0001ab10: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
+0001ab20: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+0001ab30: 2020 6377 742c 2078 7774 0a20 2020 20e2    cwt, xwt.    .
+0001ab40: 808b 0a20 2020 2022 2222 0a0a 2020 2020  ...    """..    
+0001ab50: 7761 7665 6c65 7420 3d20 7079 6377 742e  wavelet = pycwt.
+0001ab60: 7761 7665 6c65 742e 5f63 6865 636b 5f70  wavelet._check_p
+0001ab70: 6172 616d 6574 6572 5f77 6176 656c 6574  arameter_wavelet
+0001ab80: 2877 6176 656c 6574 290a 2020 2020 2320  (wavelet).    # 
+0001ab90: 4368 6563 6b69 6e67 2073 6f6d 6520 696e  Checking some in
+0001aba0: 7075 7420 7061 7261 6d65 7465 7273 0a20  put parameters. 
+0001abb0: 2020 2069 6620 7330 203d 3d20 2d31 3a0a     if s0 == -1:.
+0001abc0: 2020 2020 2020 2020 2320 4e75 6d62 6572          # Number
+0001abd0: 206f 6620 7363 616c 6573 0a20 2020 2020   of scales.     
+0001abe0: 2020 2073 3020 3d20 3220 2a20 6474 202f     s0 = 2 * dt /
+0001abf0: 2077 6176 656c 6574 2e66 6c61 6d62 6461   wavelet.flambda
+0001ac00: 2829 0a20 2020 2069 6620 4a20 3d3d 202d  ().    if J == -
+0001ac10: 313a 0a20 2020 2020 2020 2023 204e 756d  1:.        # Num
+0001ac20: 6265 7220 6f66 2073 6361 6c65 730a 2020  ber of scales.  
+0001ac30: 2020 2020 2020 4a20 3d20 6e70 2e69 6e74        J = np.int
+0001ac40: 286e 702e 726f 756e 6428 6e70 2e6c 6f67  (np.round(np.log
+0001ac50: 3228 7931 2e73 697a 6520 2a20 6474 202f  2(y1.size * dt /
+0001ac60: 2073 3029 202f 2064 6a29 290a 0a20 2020   s0) / dj))..   
+0001ac70: 2023 204d 616b 6573 2073 7572 6520 696e   # Makes sure in
+0001ac80: 7075 7420 7369 676e 616c 7320 6172 6520  put signals are 
+0001ac90: 6e75 6d70 7920 6172 7261 7973 2e0a 2020  numpy arrays..  
+0001aca0: 2020 7931 203d 206e 702e 6173 6172 7261    y1 = np.asarra
+0001acb0: 7928 7931 290a 2020 2020 7932 203d 206e  y(y1).    y2 = n
+0001acc0: 702e 6173 6172 7261 7928 7932 290a 2020  p.asarray(y2).  
+0001acd0: 2020 2320 4361 6c63 756c 6174 6573 2074    # Calculates t
+0001ace0: 6865 2073 7461 6e64 6172 6420 6465 7669  he standard devi
+0001acf0: 6174 696f 6e20 6f66 2062 6f74 6820 696e  ation of both in
+0001ad00: 7075 7420 7369 676e 616c 732e 0a20 2020  put signals..   
+0001ad10: 2073 7464 3120 3d20 7931 2e73 7464 2829   std1 = y1.std()
+0001ad20: 0a20 2020 2073 7464 3220 3d20 7932 2e73  .    std2 = y2.s
+0001ad30: 7464 2829 0a20 2020 2023 204e 6f72 6d61  td().    # Norma
+0001ad40: 6c69 7a65 7320 626f 7468 2073 6967 6e61  lizes both signa
+0001ad50: 6c73 2c20 6966 2061 7070 726f 7072 6961  ls, if appropria
+0001ad60: 7465 2e0a 2020 2020 6966 206e 6f72 6d61  te..    if norma
+0001ad70: 6c69 7a65 3a0a 2020 2020 2020 2020 7931  lize:.        y1
+0001ad80: 5f6e 6f72 6d61 6c20 3d20 2879 3120 2d20  _normal = (y1 - 
+0001ad90: 7931 2e6d 6561 6e28 2929 202f 2073 7464  y1.mean()) / std
+0001ada0: 310a 2020 2020 2020 2020 7932 5f6e 6f72  1.        y2_nor
+0001adb0: 6d61 6c20 3d20 2879 3220 2d20 7932 2e6d  mal = (y2 - y2.m
+0001adc0: 6561 6e28 2929 202f 2073 7464 320a 2020  ean()) / std2.  
+0001add0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ade0: 7931 5f6e 6f72 6d61 6c20 3d20 7931 0a20  y1_normal = y1. 
+0001adf0: 2020 2020 2020 2079 325f 6e6f 726d 616c         y2_normal
+0001ae00: 203d 2079 320a 0a20 2020 2023 2043 616c   = y2..    # Cal
+0001ae10: 6375 6c61 7465 7320 7468 6520 4357 5420  culates the CWT 
+0001ae20: 6f66 2074 6865 2074 696d 652d 7365 7269  of the time-seri
+0001ae30: 6573 206d 616b 696e 6720 7375 7265 2074  es making sure t
+0001ae40: 6865 2073 616d 6520 7061 7261 6d65 7465  he same paramete
+0001ae50: 7273 0a20 2020 2023 2061 7265 2075 7365  rs.    # are use
+0001ae60: 6420 696e 2062 6f74 6820 6361 6c63 756c  d in both calcul
+0001ae70: 6174 696f 6e73 2e0a 2020 2020 5f6b 7761  ations..    _kwa
+0001ae80: 7267 7320 3d20 6469 6374 2864 6a3d 646a  rgs = dict(dj=dj
+0001ae90: 2c20 7330 3d73 302c 204a 3d4a 2c20 7761  , s0=s0, J=J, wa
+0001aea0: 7665 6c65 743d 7761 7665 6c65 7429 0a20  velet=wavelet). 
+0001aeb0: 2020 2057 312c 2073 6a2c 2066 7265 712c     W1, sj, freq,
+0001aec0: 2063 6f69 2c20 5f2c 205f 203d 2070 7963   coi, _, _ = pyc
+0001aed0: 7774 2e63 7774 2879 315f 6e6f 726d 616c  wt.cwt(y1_normal
+0001aee0: 2c20 6474 2c20 2a2a 5f6b 7761 7267 7329  , dt, **_kwargs)
+0001aef0: 0a20 2020 2057 322c 2073 6a2c 2066 7265  .    W2, sj, fre
+0001af00: 712c 2063 6f69 2c20 5f2c 205f 203d 2070  q, coi, _, _ = p
+0001af10: 7963 7774 2e63 7774 2879 325f 6e6f 726d  ycwt.cwt(y2_norm
+0001af20: 616c 2c20 6474 2c20 2a2a 5f6b 7761 7267  al, dt, **_kwarg
+0001af30: 7329 0a0a 2020 2020 7363 616c 6573 3120  s)..    scales1 
+0001af40: 3d20 6e70 2e6f 6e65 7328 5b31 2c20 7931  = np.ones([1, y1
+0001af50: 2e73 697a 655d 2920 2a20 736a 5b3a 2c20  .size]) * sj[:, 
+0001af60: 4e6f 6e65 5d0a 2020 2020 7363 616c 6573  None].    scales
+0001af70: 3220 3d20 6e70 2e6f 6e65 7328 5b31 2c20  2 = np.ones([1, 
+0001af80: 7932 2e73 697a 655d 2920 2a20 736a 5b3a  y2.size]) * sj[:
+0001af90: 2c20 4e6f 6e65 5d0a 0a20 2020 2023 2053  , None]..    # S
+0001afa0: 6d6f 6f74 6820 7468 6520 7761 7665 6c65  mooth the wavele
+0001afb0: 7420 7370 6563 7472 6120 6265 666f 7265  t spectra before
+0001afc0: 2074 7275 6e63 6174 696e 672e 0a20 2020   truncating..   
+0001afd0: 2053 3120 3d20 7761 7665 6c65 742e 736d   S1 = wavelet.sm
+0001afe0: 6f6f 7468 286e 702e 6162 7328 5731 2920  ooth(np.abs(W1) 
+0001aff0: 2a2a 2032 202f 2073 6361 6c65 7331 2c20  ** 2 / scales1, 
+0001b000: 6474 2c20 646a 2c20 736a 290a 2020 2020  dt, dj, sj).    
+0001b010: 5332 203d 2077 6176 656c 6574 2e73 6d6f  S2 = wavelet.smo
+0001b020: 6f74 6828 6e70 2e61 6273 2857 3229 202a  oth(np.abs(W2) *
+0001b030: 2a20 3220 2f20 7363 616c 6573 322c 2064  * 2 / scales2, d
+0001b040: 742c 2064 6a2c 2073 6a29 0a0a 2020 2020  t, dj, sj)..    
+0001b050: 2320 4e6f 7720 7468 6520 7761 7665 6c65  # Now the wavele
+0001b060: 7420 7472 616e 7366 6f72 6d20 636f 6865  t transform cohe
+0001b070: 7265 6e63 650a 2020 2020 5731 3220 3d20  rence.    W12 = 
+0001b080: 5731 202a 2057 322e 636f 6e6a 2829 0a20  W1 * W2.conj(). 
+0001b090: 2020 2073 6361 6c65 7320 3d20 6e70 2e6f     scales = np.o
+0001b0a0: 6e65 7328 5b31 2c20 7931 2e73 697a 655d  nes([1, y1.size]
+0001b0b0: 2920 2a20 736a 5b3a 2c20 4e6f 6e65 5d0a  ) * sj[:, None].
+0001b0c0: 2020 2020 5331 3220 3d20 7761 7665 6c65      S12 = wavele
+0001b0d0: 742e 736d 6f6f 7468 2857 3132 202f 2073  t.smooth(W12 / s
+0001b0e0: 6361 6c65 732c 2064 742c 2064 6a2c 2073  cales, dt, dj, s
+0001b0f0: 6a29 0a20 2020 2057 4354 203d 206e 702e  j).    WCT = np.
+0001b100: 6162 7328 5331 3229 202a 2a20 3220 2f20  abs(S12) ** 2 / 
+0001b110: 2853 3120 2a20 5332 290a 2020 2020 6157  (S1 * S2).    aW
+0001b120: 4354 203d 206e 702e 616e 676c 6528 5731  CT = np.angle(W1
+0001b130: 3229 0a0a 2020 2020 2320 4361 6c63 756c  2)..    # Calcul
+0001b140: 6174 6573 2074 6865 2073 6967 6e69 6669  ates the signifi
+0001b150: 6361 6e63 6520 7573 696e 6720 4d6f 6e74  cance using Mont
+0001b160: 6520 4361 726c 6f20 7369 6d75 6c61 7469  e Carlo simulati
+0001b170: 6f6e 7320 7769 7468 2039 3525 0a20 2020  ons with 95%.   
+0001b180: 2023 2063 6f6e 6669 6465 6e63 6520 6173   # confidence as
+0001b190: 2061 2066 756e 6374 696f 6e20 6f66 2073   a function of s
+0001b1a0: 6361 6c65 2e0a 0a20 2020 2069 6620 7369  cale...    if si
+0001b1b0: 673a 0a20 2020 2020 2020 2061 312c 2062  g:.        a1, b
+0001b1c0: 312c 2063 3120 3d20 7079 6377 742e 6172  1, c1 = pycwt.ar
+0001b1d0: 3128 7931 290a 2020 2020 2020 2020 6132  1(y1).        a2
+0001b1e0: 2c20 6232 2c20 6332 203d 2070 7963 7774  , b2, c2 = pycwt
+0001b1f0: 2e61 7231 2879 3229 0a20 2020 2020 2020  .ar1(y2).       
+0001b200: 2073 6967 203d 2070 7963 7774 2e77 6374   sig = pycwt.wct
+0001b210: 5f73 6967 6e69 6669 6361 6e63 6528 0a20  _significance(. 
+0001b220: 2020 2020 2020 2020 2020 2061 312c 2061             a1, a
+0001b230: 322c 2064 743d 6474 2c20 646a 3d64 6a2c  2, dt=dt, dj=dj,
+0001b240: 2073 303d 7330 2c20 4a3d 4a2c 2073 6967   s0=s0, J=J, sig
+0001b250: 6e69 6669 6361 6e63 655f 6c65 7665 6c3d  nificance_level=
+0001b260: 7369 676e 6966 6963 616e 6365 5f6c 6576  significance_lev
+0001b270: 656c 2c20 7761 7665 6c65 743d 7761 7665  el, wavelet=wave
+0001b280: 6c65 742c 202a 2a6b 7761 7267 730a 2020  let, **kwargs.  
+0001b290: 2020 2020 2020 290a 2020 2020 656c 7365        ).    else
+0001b2a0: 3a0a 2020 2020 2020 2020 7369 6720 3d20  :.        sig = 
+0001b2b0: 6e70 2e61 7361 7272 6179 285b 305d 290a  np.asarray([0]).
+0001b2c0: 0a20 2020 2072 6574 7572 6e20 5743 542c  .    return WCT,
+0001b2d0: 2061 5743 542c 2063 6f69 2c20 6672 6571   aWCT, coi, freq
+0001b2e0: 2c20 7369 670a 0a0a 2323 2323 2323 2323  , sig...########
+0001b2f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b300: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b310: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b320: 2323 2323 2323 2323 0a23 2323 2323 2323  ########.#######
+0001b330: 2323 2323 2323 2323 2320 4449 5350 4552  ######### DISPER
+0001b340: 5349 4f4e 2045 5854 5241 4354 494f 4e20  SION EXTRACTION 
+0001b350: 4655 4e43 5449 4f4e 5320 2323 2323 2323  FUNCTIONS ######
+0001b360: 2323 2323 2323 2323 230a 2323 2323 2323  #########.######
 0001b370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0001b380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b390: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
-0001b3a0: 2323 2323 2320 4449 5350 4552 5349 4f4e  ##### DISPERSION
-0001b3b0: 2045 5854 5241 4354 494f 4e20 4655 4e43   EXTRACTION FUNC
-0001b3c0: 5449 4f4e 5320 2323 2323 2323 2323 2323  TIONS ##########
-0001b3d0: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
-0001b3e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b3f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b410: 2323 2323 2323 0a0a 0a23 2066 756e 6374  ######...# funct
-0001b420: 696f 6e20 746f 2065 7874 7261 6374 2074  ion to extract t
-0001b430: 6865 2064 6973 7065 7273 696f 6e20 6672  he dispersion fr
-0001b440: 6f6d 2074 6865 2069 6d61 6765 0a64 6566  om the image.def
-0001b450: 2065 7874 7261 6374 5f64 6973 7065 7273   extract_dispers
-0001b460: 696f 6e28 616d 702c 2070 6572 2c20 7665  ion(amp, per, ve
-0001b470: 6c29 3a0a 2020 2020 2222 220a 2020 2020  l):.    """.    
-0001b480: 7468 6973 2066 756e 6374 696f 6e20 7461  this function ta
-0001b490: 6b65 7320 7468 6520 6469 7370 6572 7369  kes the dispersi
-0001b4a0: 6f6e 2069 6d61 6765 2066 726f 6d20 4357  on image from CW
-0001b4b0: 5420 6173 2069 6e70 7574 2c20 7472 6163  T as input, trac
-0001b4c0: 6b73 2074 6865 2067 6c6f 6261 6c20 6d61  ks the global ma
-0001b4d0: 7869 6e75 6d20 6f6e 0a20 2020 2074 6865  xinum on.    the
-0001b4e0: 2077 6176 656c 6574 2073 7065 6374 7275   wavelet spectru
-0001b4f0: 6d20 616d 706c 6974 7564 6520 616e 6420  m amplitude and 
-0001b500: 6578 7472 6163 7420 7468 6520 7365 6374  extract the sect
-0001b510: 696f 6e73 2077 6974 6820 636f 6e74 696e  ions with contin
-0001b520: 6f75 7320 616e 6420 6869 6768 2071 7561  ous and high qua
-0001b530: 6c69 7479 2064 6174 610a 0a20 2020 2050  lity data..    P
-0001b540: 4152 414d 4554 4552 533a 0a20 2020 202d  ARAMETERS:.    -
-0001b550: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-0001b560: 2020 2020 616d 703a 2032 4420 616d 706c      amp: 2D ampl
-0001b570: 6974 7564 6520 6d61 7472 6978 206f 6620  itude matrix of 
-0001b580: 7468 6520 7761 7665 6c65 7420 7370 6563  the wavelet spec
-0001b590: 7472 756d 0a20 2020 2070 6861 7365 3a20  trum.    phase: 
-0001b5a0: 3244 2070 6861 7365 206d 6174 7269 7820  2D phase matrix 
-0001b5b0: 6f66 2074 6865 2077 6176 656c 6574 2073  of the wavelet s
-0001b5c0: 7065 6374 7275 6d0a 2020 2020 7065 723a  pectrum.    per:
-0001b5d0: 2020 7065 7269 6f64 2076 6563 746f 7220    period vector 
-0001b5e0: 666f 7220 7468 6520 3244 206d 6174 7269  for the 2D matri
-0001b5f0: 780a 2020 2020 7665 6c3a 2020 7665 6c20  x.    vel:  vel 
-0001b600: 7665 6374 6f72 206f 6620 7468 6520 3244  vector of the 2D
-0001b610: 206d 6174 7269 780a 2020 2020 5245 5455   matrix.    RETU
-0001b620: 524e 533a 0a20 2020 202d 2d2d 2d2d 2d2d  RNS:.    -------
-0001b630: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7065  ---------.    pe
-0001b640: 723a 2020 6365 6e74 7261 6c20 6672 6571  r:  central freq
-0001b650: 7565 6e63 7920 6f66 2065 6163 6820 7761  uency of each wa
-0001b660: 7665 6c65 7420 7363 616c 6520 7769 7468  velet scale with
-0001b670: 2067 6f6f 6420 6461 7461 0a20 2020 2067   good data.    g
-0001b680: 763a 2020 2067 726f 7570 2076 656c 6f63  v:   group veloc
-0001b690: 6974 7920 7665 6374 6f72 2061 7420 6561  ity vector at ea
-0001b6a0: 6368 2066 7265 7175 656e 6379 0a20 2020  ch frequency.   
-0001b6b0: 2022 2222 0a20 2020 206d 6178 6761 7020   """.    maxgap 
-0001b6c0: 3d20 350a 2020 2020 6e70 6572 203d 2061  = 5.    nper = a
-0001b6d0: 6d70 2e73 6861 7065 5b30 5d0a 2020 2020  mp.shape[0].    
-0001b6e0: 6776 203d 206e 702e 7a65 726f 7328 6e70  gv = np.zeros(np
-0001b6f0: 6572 2c20 6474 7970 653d 6e70 2e66 6c6f  er, dtype=np.flo
-0001b700: 6174 3332 290a 2020 2020 6476 656c 203d  at32).    dvel =
-0001b710: 2076 656c 5b31 5d20 2d20 7665 6c5b 305d   vel[1] - vel[0]
-0001b720: 0a0a 2020 2020 2320 6669 6e64 2067 6c6f  ..    # find glo
-0001b730: 6261 6c20 6d61 7869 6d75 6d0a 2020 2020  bal maximum.    
-0001b740: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-0001b750: 6e70 6572 293a 0a20 2020 2020 2020 206d  nper):.        m
-0001b760: 6178 7661 6c75 6520 3d20 6e70 2e6d 6178  axvalue = np.max
-0001b770: 2861 6d70 5b69 695d 2c20 6178 6973 3d30  (amp[ii], axis=0
-0001b780: 290a 2020 2020 2020 2020 696e 6478 203d  ).        indx =
-0001b790: 206c 6973 7428 616d 705b 6969 5d29 2e69   list(amp[ii]).i
-0001b7a0: 6e64 6578 286d 6178 7661 6c75 6529 0a20  ndex(maxvalue). 
-0001b7b0: 2020 2020 2020 2067 765b 6969 5d20 3d20         gv[ii] = 
-0001b7c0: 7665 6c5b 696e 6478 5d0a 0a20 2020 2023  vel[indx]..    #
-0001b7d0: 2063 6865 636b 2074 6865 2063 6f6e 7469   check the conti
-0001b7e0: 6e75 6f75 7320 6f66 2074 6865 2064 6973  nuous of the dis
-0001b7f0: 7065 7273 696f 6e0a 2020 2020 666f 7220  persion.    for 
-0001b800: 6969 2069 6e20 7261 6e67 6528 312c 206e  ii in range(1, n
-0001b810: 7065 7220 2d20 3135 293a 0a20 2020 2020  per - 15):.     
-0001b820: 2020 2023 2031 3520 6973 2074 6865 206d     # 15 is the m
-0001b830: 696e 756d 756d 206c 656e 6774 6820 6e65  inumum length ne
-0001b840: 6564 6564 2066 6f72 206f 7574 7075 740a  eded for output.
-0001b850: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
-0001b860: 6e20 7261 6e67 6528 3135 293a 0a20 2020  n range(15):.   
-0001b870: 2020 2020 2020 2020 2069 6620 6e70 2e61           if np.a
-0001b880: 6273 2867 765b 6969 202b 206a 6a5d 202d  bs(gv[ii + jj] -
-0001b890: 2067 765b 6969 202b 2031 202b 206a 6a5d   gv[ii + 1 + jj]
-0001b8a0: 2920 3e20 6d61 7867 6170 202a 2064 7665  ) > maxgap * dve
-0001b8b0: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-0001b8c0: 2020 2067 765b 6969 5d20 3d20 300a 2020     gv[ii] = 0.  
-0001b8d0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-0001b8e0: 6561 6b0a 0a20 2020 2023 2072 656d 6f76  eak..    # remov
-0001b8f0: 6520 7468 6520 6261 6420 6f6e 6573 0a20  e the bad ones. 
-0001b900: 2020 2069 6e64 7820 3d20 6e70 2e77 6865     indx = np.whe
-0001b910: 7265 2867 7620 3e20 3029 5b30 5d0a 0a20  re(gv > 0)[0].. 
-0001b920: 2020 2072 6574 7572 6e20 7065 725b 696e     return per[in
-0001b930: 6478 5d2c 2067 765b 696e 6478 5d0a       dx], gv[indx].
+0001b390: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001b3a0: 2323 2323 2323 2323 2323 0a0a 0a23 2066  ##########...# f
+0001b3b0: 756e 6374 696f 6e20 746f 2065 7874 7261  unction to extra
+0001b3c0: 6374 2074 6865 2064 6973 7065 7273 696f  ct the dispersio
+0001b3d0: 6e20 6672 6f6d 2074 6865 2069 6d61 6765  n from the image
+0001b3e0: 0a64 6566 2065 7874 7261 6374 5f64 6973  .def extract_dis
+0001b3f0: 7065 7273 696f 6e28 616d 702c 2070 6572  persion(amp, per
+0001b400: 2c20 7665 6c29 3a0a 2020 2020 2222 220a  , vel):.    """.
+0001b410: 2020 2020 7468 6973 2066 756e 6374 696f      this functio
+0001b420: 6e20 7461 6b65 7320 7468 6520 6469 7370  n takes the disp
+0001b430: 6572 7369 6f6e 2069 6d61 6765 2066 726f  ersion image fro
+0001b440: 6d20 4357 5420 6173 2069 6e70 7574 2c20  m CWT as input, 
+0001b450: 7472 6163 6b73 2074 6865 2067 6c6f 6261  tracks the globa
+0001b460: 6c20 6d61 7869 6e75 6d20 6f6e 0a20 2020  l maxinum on.   
+0001b470: 2074 6865 2077 6176 656c 6574 2073 7065   the wavelet spe
+0001b480: 6374 7275 6d20 616d 706c 6974 7564 6520  ctrum amplitude 
+0001b490: 616e 6420 6578 7472 6163 7420 7468 6520  and extract the 
+0001b4a0: 7365 6374 696f 6e73 2077 6974 6820 636f  sections with co
+0001b4b0: 6e74 696e 6f75 7320 616e 6420 6869 6768  ntinous and high
+0001b4c0: 2071 7561 6c69 7479 2064 6174 610a 0a20   quality data.. 
+0001b4d0: 2020 2050 4152 414d 4554 4552 533a 0a20     PARAMETERS:. 
+0001b4e0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d     -------------
+0001b4f0: 2d2d 2d0a 2020 2020 616d 703a 2032 4420  ---.    amp: 2D 
+0001b500: 616d 706c 6974 7564 6520 6d61 7472 6978  amplitude matrix
+0001b510: 206f 6620 7468 6520 7761 7665 6c65 7420   of the wavelet 
+0001b520: 7370 6563 7472 756d 0a20 2020 2070 6861  spectrum.    pha
+0001b530: 7365 3a20 3244 2070 6861 7365 206d 6174  se: 2D phase mat
+0001b540: 7269 7820 6f66 2074 6865 2077 6176 656c  rix of the wavel
+0001b550: 6574 2073 7065 6374 7275 6d0a 2020 2020  et spectrum.    
+0001b560: 7065 723a 2020 7065 7269 6f64 2076 6563  per:  period vec
+0001b570: 746f 7220 666f 7220 7468 6520 3244 206d  tor for the 2D m
+0001b580: 6174 7269 780a 2020 2020 7665 6c3a 2020  atrix.    vel:  
+0001b590: 7665 6c20 7665 6374 6f72 206f 6620 7468  vel vector of th
+0001b5a0: 6520 3244 206d 6174 7269 780a 2020 2020  e 2D matrix.    
+0001b5b0: 5245 5455 524e 533a 0a20 2020 202d 2d2d  RETURNS:.    ---
+0001b5c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0001b5d0: 2020 7065 723a 2020 6365 6e74 7261 6c20    per:  central 
+0001b5e0: 6672 6571 7565 6e63 7920 6f66 2065 6163  frequency of eac
+0001b5f0: 6820 7761 7665 6c65 7420 7363 616c 6520  h wavelet scale 
+0001b600: 7769 7468 2067 6f6f 6420 6461 7461 0a20  with good data. 
+0001b610: 2020 2067 763a 2020 2067 726f 7570 2076     gv:   group v
+0001b620: 656c 6f63 6974 7920 7665 6374 6f72 2061  elocity vector a
+0001b630: 7420 6561 6368 2066 7265 7175 656e 6379  t each frequency
+0001b640: 0a20 2020 2022 2222 0a20 2020 206d 6178  .    """.    max
+0001b650: 6761 7020 3d20 350a 2020 2020 6e70 6572  gap = 5.    nper
+0001b660: 203d 2061 6d70 2e73 6861 7065 5b30 5d0a   = amp.shape[0].
+0001b670: 2020 2020 6776 203d 206e 702e 7a65 726f      gv = np.zero
+0001b680: 7328 6e70 6572 2c20 6474 7970 653d 6e70  s(nper, dtype=np
+0001b690: 2e66 6c6f 6174 3332 290a 2020 2020 6476  .float32).    dv
+0001b6a0: 656c 203d 2076 656c 5b31 5d20 2d20 7665  el = vel[1] - ve
+0001b6b0: 6c5b 305d 0a0a 2020 2020 2320 6669 6e64  l[0]..    # find
+0001b6c0: 2067 6c6f 6261 6c20 6d61 7869 6d75 6d0a   global maximum.
+0001b6d0: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
+0001b6e0: 6e67 6528 6e70 6572 293a 0a20 2020 2020  nge(nper):.     
+0001b6f0: 2020 206d 6178 7661 6c75 6520 3d20 6e70     maxvalue = np
+0001b700: 2e6d 6178 2861 6d70 5b69 695d 2c20 6178  .max(amp[ii], ax
+0001b710: 6973 3d30 290a 2020 2020 2020 2020 696e  is=0).        in
+0001b720: 6478 203d 206c 6973 7428 616d 705b 6969  dx = list(amp[ii
+0001b730: 5d29 2e69 6e64 6578 286d 6178 7661 6c75  ]).index(maxvalu
+0001b740: 6529 0a20 2020 2020 2020 2067 765b 6969  e).        gv[ii
+0001b750: 5d20 3d20 7665 6c5b 696e 6478 5d0a 0a20  ] = vel[indx].. 
+0001b760: 2020 2023 2063 6865 636b 2074 6865 2063     # check the c
+0001b770: 6f6e 7469 6e75 6f75 7320 6f66 2074 6865  ontinuous of the
+0001b780: 2064 6973 7065 7273 696f 6e0a 2020 2020   dispersion.    
+0001b790: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+0001b7a0: 312c 206e 7065 7220 2d20 3135 293a 0a20  1, nper - 15):. 
+0001b7b0: 2020 2020 2020 2023 2031 3520 6973 2074         # 15 is t
+0001b7c0: 6865 206d 696e 756d 756d 206c 656e 6774  he minumum lengt
+0001b7d0: 6820 6e65 6564 6564 2066 6f72 206f 7574  h needed for out
+0001b7e0: 7075 740a 2020 2020 2020 2020 666f 7220  put.        for 
+0001b7f0: 6a6a 2069 6e20 7261 6e67 6528 3135 293a  jj in range(15):
+0001b800: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001b810: 6e70 2e61 6273 2867 765b 6969 202b 206a  np.abs(gv[ii + j
+0001b820: 6a5d 202d 2067 765b 6969 202b 2031 202b  j] - gv[ii + 1 +
+0001b830: 206a 6a5d 2920 3e20 6d61 7867 6170 202a   jj]) > maxgap *
+0001b840: 2064 7665 6c3a 0a20 2020 2020 2020 2020   dvel:.         
+0001b850: 2020 2020 2020 2067 765b 6969 5d20 3d20         gv[ii] = 
+0001b860: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0001b870: 2020 6272 6561 6b0a 0a20 2020 2023 2072    break..    # r
+0001b880: 656d 6f76 6520 7468 6520 6261 6420 6f6e  emove the bad on
+0001b890: 6573 0a20 2020 2069 6e64 7820 3d20 6e70  es.    indx = np
+0001b8a0: 2e77 6865 7265 2867 7620 3e20 3029 5b30  .where(gv > 0)[0
+0001b8b0: 5d0a 0a20 2020 2072 6574 7572 6e20 7065  ]..    return pe
+0001b8c0: 725b 696e 6478 5d2c 2067 765b 696e 6478  r[indx], gv[indx
+0001b8d0: 5d0a                                     ].
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/plotting_modules.py` & `noisepy_seis-0.9.0/src/noisepy/seis/plotting_modules.py`

 * *Files 0% similar despite different names*

```diff
@@ -692,16 +692,16 @@
 
         ds = pyasdf.ASDFDataSet(sfile, mode="r")
         try:
             # load data to variables
             dist[ii] = ds.auxiliary_data[dtype][path].parameters["dist"]
             ngood[ii] = ds.auxiliary_data[dtype][path].parameters["ngood"]
             tdata = ds.auxiliary_data[dtype][path].data[indx1:indx2]
-        except Exception:
-            print("continue! cannot read %s " % sfile)
+        except Exception as e:
+            print(f"continue! cannot read {sfile}: {e}")
             continue
 
         data[ii] = bandpass(tdata, freqmin, freqmax, int(1 / dt), corners=4, zerophase=True)
 
     # average cc
     ntrace = int(np.round(np.max(dist) + 0.51) / dist_inc)
     ndata = np.zeros(shape=(ntrace, indx2 - indx1), dtype=np.float32)
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/stores.py` & `noisepy_seis-0.9.0/src/noisepy/seis/stores.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,32 +1,22 @@
 from abc import ABC, abstractmethod
-from datetime import datetime
-from typing import Any, Dict, List
+from typing import Any, Dict, List, Tuple
 
 import numpy as np
 import obspy
 from datetimerange import DateTimeRange
 
-from .datatypes import Channel, ChannelData, ConfigParameters, Station
+from .datatypes import Channel, ChannelData, ChannelType, ConfigParameters, Station
 
 
 class DataStore(ABC):
     """
     A base abstraction over a data source for seismic data
     """
 
-    # TODO: Are these needed or is get_channels() enough?
-    # @abstractmethod
-    # def get_stations(self) -> List[Station]:
-    #     pass
-
-    # @abstractmethod
-    # def get_channel_types(self) -> List[ChannelType]:
-    #     pass
-
     @abstractmethod
     def get_channels(self, timespan: DateTimeRange) -> List[Channel]:
         pass
 
     @abstractmethod
     def get_timespans(self) -> List[DateTimeRange]:
         pass
@@ -84,9 +74,25 @@
         pass
 
     @abstractmethod
     def mark_done(self, timespan: DateTimeRange):
         pass
 
     @abstractmethod
-    def read(self, chan1: Channel, chan2: Channel, start: datetime, end: datetime) -> np.ndarray:
+    def get_timespans(self) -> List[DateTimeRange]:
+        pass
+
+    @abstractmethod
+    def get_station_pairs(self, timespan: DateTimeRange) -> List[Tuple[Station, Station]]:
+        pass
+
+    @abstractmethod
+    def get_channeltype_pairs(
+        self, timespan: DateTimeRange, src_sta: Station, rec_sta: Station
+    ) -> List[Tuple[ChannelType, ChannelType]]:
+        pass
+
+    @abstractmethod
+    def read(
+        self, timespan: DateTimeRange, src_sta: Station, rec_sta: Station, src_ch: ChannelType, rec_ch: ChannelType
+    ) -> Tuple[Dict, np.ndarray]:
         pass
```

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/comp_stacking.py` & `noisepy_seis-0.9.0/src/noisepy/seis/application_modules/comp_stacking.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/dispersion_analysis.py` & `noisepy_seis-0.9.0/src/noisepy/seis/application_modules/dispersion_analysis.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/measure_dvv.py` & `noisepy_seis-0.9.0/src/noisepy/seis/application_modules/measure_dvv.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/src/noisepy/seis/application_modules/write_sac.py` & `noisepy_seis-0.9.0/src/noisepy/seis/application_modules/write_sac.py`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/.gitignore` & `noisepy_seis-0.9.0/.gitignore`

 * *Files 2% similar despite different names*

```diff
@@ -160,7 +160,10 @@
 #.idea/
 
 # Cache location for inventory (used by FDSNChannelCatalog)
 noisepy_cache/
 
 # Version file generated at build time
 src/noisepy/seis/_version.py
+
+# MacOS
+.DS_Store
```

### Comparing `noisepy_seis-0.8.2.1/LICENSE` & `noisepy_seis-0.9.0/LICENSE`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/README.md` & `noisepy_seis-0.9.0/README.md`

 * *Files identical despite different names*

### Comparing `noisepy_seis-0.8.2.1/pyproject.toml` & `noisepy_seis-0.9.0/pyproject.toml`

 * *Files 10% similar despite different names*

```diff
@@ -4,15 +4,15 @@
 
 [project]
 name = "noisepy-seis"
 dynamic = ["version"]
 description = "A High-performance Computing Python Package for Ambient Noise Analysis"
 readme = "README.md"
 license = {file= "LICENSE"}
-requires-python = ">=3.8"
+requires-python = ">=3.8,<3.11"
 authors = [
     { email = "mdenolle@uw.edu", name = "Marine Denolle" },
     { email = "chengxin_jiang@fas.harvard.edu", name = "Chengxin Jiang" },
 ]
 keywords = [
     "ambient",
     "change",
@@ -40,14 +40,18 @@
     "numpy>=1.22.0",
     "pandas>=1.5.3",
     "pyasdf>=0.7.5",
     "pycwt>=0.3.0a22",
     "diskcache>=5.5",
     "fsspec>=2023.4.0",
     "s3fs>=2023.4.0",
+    "ray>=2.4.0",
+    "pydantic>=1.10.0",
+    "PyYAML>=6.0",
+    "pydantic-yaml>=0.11",
 ]
 
 
 [project.urls]
 Homepage = "https://github.com/mdenolle/NoisePy"
 
 [tool.hatch.version]
@@ -68,14 +72,15 @@
 packages = ["src/noisepy"]
 
 [project.optional-dependencies]
 dev = [
     "pytest>=7.2.2",
     "memory-profiler>=0.61",
     "pre-commit>=3.2",
+    "ray[default]>=2.4.0",
 ]
 
 [project.scripts]
 noisepy = "noisepy.seis:main.main_cli"
 
 [tool.black]
 line-length = 120
```

### Comparing `noisepy_seis-0.8.2.1/PKG-INFO` & `noisepy_seis-0.9.0/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: noisepy-seis
-Version: 0.8.2.1
+Version: 0.9.0
 Summary: A High-performance Computing Python Package for Ambient Noise Analysis
 Project-URL: Homepage, https://github.com/mdenolle/NoisePy
 Author-email: Marine Denolle <mdenolle@uw.edu>, Chengxin Jiang <chengxin_jiang@fas.harvard.edu>
 License: MIT License
         
         Copyright (c) 2019 Marine Denolle & Chengxin Jiang
         
@@ -28,30 +28,35 @@
 License-File: LICENSE
 Keywords: ambient,change,cross-correlation,dispersion,monitoring,noise,seismic,surface,velocity,wave
 Classifier: Environment :: Console
 Classifier: Intended Audience :: Developers
 Classifier: Intended Audience :: Science/Research
 Classifier: Operating System :: OS Independent
 Classifier: Programming Language :: Python :: 3.8
-Requires-Python: >=3.8
+Requires-Python: <3.11,>=3.8
 Requires-Dist: datetimerange==2.0.0
 Requires-Dist: diskcache>=5.5
 Requires-Dist: fsspec>=2023.4.0
 Requires-Dist: h5py>=3.8.0
 Requires-Dist: mpi4py>=3.1.4
 Requires-Dist: numba>=0.57.0
 Requires-Dist: numpy>=1.22.0
 Requires-Dist: pandas>=1.5.3
 Requires-Dist: pyasdf>=0.7.5
 Requires-Dist: pycwt>=0.3.0a22
+Requires-Dist: pydantic-yaml>=0.11
+Requires-Dist: pydantic>=1.10.0
+Requires-Dist: pyyaml>=6.0
+Requires-Dist: ray>=2.4.0
 Requires-Dist: s3fs>=2023.4.0
 Provides-Extra: dev
 Requires-Dist: memory-profiler>=0.61; extra == 'dev'
 Requires-Dist: pre-commit>=3.2; extra == 'dev'
 Requires-Dist: pytest>=7.2.2; extra == 'dev'
+Requires-Dist: ray[default]>=2.4.0; extra == 'dev'
 Description-Content-Type: text/markdown
 
 # About NoisePy
 NoisePy is a Python package designed for fast and easy computation of ambient noise cross-correlation functions. It provides additional functionality for noise monitoring and surface wave dispersion analysis.
 
 Disclaimer: this code should not be used "as-is" and not run like a blackbox. The user is expected to change local paths and parameters. Submit an issue to github with information such as the scripts+error messages to debug.
```

