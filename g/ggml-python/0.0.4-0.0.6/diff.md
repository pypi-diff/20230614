# Comparing `tmp/ggml_python-0.0.4.tar.gz` & `tmp/ggml-python-0.0.6.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ggml_python-0.0.4.tar", last modified: Tue Jun  6 21:30:56 2023, max compression
+gzip compressed data, was "ggml-python-0.0.6.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
```

## Comparing `ggml_python-0.0.4.tar` & `ggml-python-0.0.6.tar`

### file list

```diff
@@ -1,89 +1,124 @@
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.416195 ggml_python-0.0.4/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     3146 2023-06-05 21:12:46.000000 ggml_python-0.0.4/.gitignore
--rw-rw-r--   0 andrei    (1000) andrei    (1000)       87 2023-04-10 18:49:28.000000 ggml_python-0.0.4/.gitmodules
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      210 2023-06-02 07:15:43.000000 ggml_python-0.0.4/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     1069 2023-05-16 20:17:05.000000 ggml_python-0.0.4/LICENSE.md
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      577 2023-06-06 21:30:56.416195 ggml_python-0.0.4/PKG-INFO
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     1715 2023-06-06 21:28:28.000000 ggml_python-0.0.4/README.md
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.392195 ggml_python-0.0.4/_skbuild/
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.392195 ggml_python-0.0.4/_skbuild/linux-x86_64-3.8/
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.392195 ggml_python-0.0.4/_skbuild/linux-x86_64-3.8/cmake-install/
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.396195 ggml_python-0.0.4/_skbuild/linux-x86_64-3.8/cmake-install/ggml/
--rw-r--r--   0 andrei    (1000) andrei    (1000)   352328 2023-06-05 22:49:22.000000 ggml_python-0.0.4/_skbuild/linux-x86_64-3.8/cmake-install/ggml/libggml.so
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.396195 ggml_python-0.0.4/_skbuild/linux-x86_64-3.8/cmake-install/lib/
--rw-r--r--   0 andrei    (1000) andrei    (1000)   352328 2023-06-05 22:49:22.000000 ggml_python-0.0.4/_skbuild/linux-x86_64-3.8/cmake-install/lib/libggml.so
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.400195 ggml_python-0.0.4/ggml/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)       19 2023-05-27 13:55:32.000000 ggml_python-0.0.4/ggml/__init__.py
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    34092 2023-06-05 17:56:23.000000 ggml_python-0.0.4/ggml/experimental.py
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    95400 2023-06-05 19:39:58.000000 ggml_python-0.0.4/ggml/ggml.py
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.400195 ggml_python-0.0.4/ggml_python.egg-info/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      577 2023-06-06 21:30:56.000000 ggml_python-0.0.4/ggml_python.egg-info/PKG-INFO
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     2194 2023-06-06 21:30:56.000000 ggml_python-0.0.4/ggml_python.egg-info/SOURCES.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)        1 2023-06-06 21:30:56.000000 ggml_python-0.0.4/ggml_python.egg-info/dependency_links.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)       14 2023-06-06 21:30:56.000000 ggml_python-0.0.4/ggml_python.egg-info/requires.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)        5 2023-06-06 21:30:56.000000 ggml_python-0.0.4/ggml_python.egg-info/top_level.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      149 2023-04-10 18:49:46.000000 ggml_python-0.0.4/pyproject.toml
--rw-rw-r--   0 andrei    (1000) andrei    (1000)       38 2023-06-06 21:30:56.416195 ggml_python-0.0.4/setup.cfg
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      672 2023-06-06 21:30:20.000000 ggml_python-0.0.4/setup.py
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.400195 ggml_python-0.0.4/tests/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      661 2023-06-05 19:18:53.000000 ggml_python-0.0.4/tests/test_experimental.py
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     1057 2023-05-30 07:25:18.000000 ggml_python-0.0.4/tests/test_ggml.py
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.392195 ggml_python-0.0.4/vendor/
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.400195 ggml_python-0.0.4/vendor/ggml/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      126 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/.gitignore
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     2630 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     1072 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/LICENSE
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     4788 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/README.md
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.400195 ggml_python-0.0.4/vendor/ggml/cmake/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     2037 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/cmake/BuildTypes.cmake
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      717 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/cmake/GitVars.cmake
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.400195 ggml_python-0.0.4/vendor/ggml/examples/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      794 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/examples/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)   241358 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/examples/dr_wav.h
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.404195 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      311 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     6370 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/README.md
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     6313 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     4873 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     6436 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py
--rwxrwxr-x   0 andrei    (1000) andrei    (1000)     1752 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/download-ggml-model.sh
--rwxrwxr-x   0 andrei    (1000) andrei    (1000)     1117 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/download-model.sh
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    29384 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/main.cpp
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     5854 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-2/quantize.cpp
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.404195 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      311 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    11108 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/README.md
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     5509 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py
--rwxrwxr-x   0 andrei    (1000) andrei    (1000)     1728 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/download-ggml-model.sh
--rwxrwxr-x   0 andrei    (1000) andrei    (1000)      571 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/download-model.sh
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    25824 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/main.cpp
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     5856 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/gpt-j/quantize.cpp
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.408195 ggml_python-0.0.4/vendor/ggml/examples/whisper/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      501 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)      718 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/README.md
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     9506 2023-04-10 18:49:28.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/convert-pt-to-ggml.py
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    36271 2023-05-16 19:32:05.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/main.cpp
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     8093 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/quantize.cpp
--rw-rw-r--   0 andrei    (1000) andrei    (1000)   184815 2023-05-30 19:43:39.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/whisper.cpp
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    23750 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/examples/whisper/whisper.h
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.396195 ggml_python-0.0.4/vendor/ggml/include/
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.408195 ggml_python-0.0.4/vendor/ggml/include/ggml/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    41105 2023-06-03 18:53:57.000000 ggml_python-0.0.4/vendor/ggml/include/ggml/ggml.h
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.408195 ggml_python-0.0.4/vendor/ggml/src/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     8706 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/src/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)   537379 2023-06-03 18:53:57.000000 ggml_python-0.0.4/vendor/ggml/src/ggml.c
-drwxrwxr-x   0 andrei    (1000) andrei    (1000)        0 2023-06-06 21:30:56.416195 ggml_python-0.0.4/vendor/ggml/tests/
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     9406 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/CMakeLists.txt
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     6569 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-blas0.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    37497 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-grad0.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    10522 2023-05-29 16:50:02.000000 ggml_python-0.0.4/vendor/ggml/tests/test-mul-mat0.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     9003 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-mul-mat1.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    91837 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-mul-mat2.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     5141 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-svd0.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     3157 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-vec0.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    21179 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-vec1.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     7310 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test-vec2.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     1182 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test0.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)    15073 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test1.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     5703 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test2.c
--rw-rw-r--   0 andrei    (1000) andrei    (1000)     2841 2023-05-14 15:45:17.000000 ggml_python-0.0.4/vendor/ggml/tests/test3.c
+-rw-r--r--   0        0        0     2055 2022-11-09 12:37:21.000000 ggml-python-0.0.6/.github/workflows/test.yaml
+-rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 ggml-python-0.0.6/.gitignore
+-rw-r--r--   0        0        0       87 2022-11-09 12:37:21.000000 ggml-python-0.0.6/.gitmodules
+-rw-r--r--   0        0        0      800 2022-11-09 12:37:21.000000 ggml-python-0.0.6/CMakeLists.txt
+-rw-r--r--   0        0        0     1069 2022-11-09 12:37:21.000000 ggml-python-0.0.6/LICENSE.md
+-rw-r--r--   0        0        0      958 2022-11-09 12:37:21.000000 ggml-python-0.0.6/Makefile
+-rw-r--r--   0        0        0     1946 2022-11-09 12:37:21.000000 ggml-python-0.0.6/README.md
+-rw-r--r--   0        0        0      604 2022-11-09 12:37:21.000000 ggml-python-0.0.6/examples/replit/README.md
+-rw-r--r--   0        0        0     7182 2022-11-09 12:37:21.000000 ggml-python-0.0.6/examples/replit/app.py
+-rw-r--r--   0        0        0    17910 2022-11-09 12:37:21.000000 ggml-python-0.0.6/examples/replit/input.txt
+-rw-r--r--   0        0        0    45211 2022-11-09 12:37:21.000000 ggml-python-0.0.6/examples/replit/main.py
+-rw-r--r--   0        0        0       19 2022-11-09 12:37:21.000000 ggml-python-0.0.6/ggml/__init__.py
+-rw-r--r--   0        0        0    34424 2022-11-09 12:37:21.000000 ggml-python-0.0.6/ggml/experimental.py
+-rw-r--r--   0        0        0   102848 2022-11-09 12:37:21.000000 ggml-python-0.0.6/ggml/ggml.py
+-rw-r--r--   0        0        0      988 2022-11-09 12:37:21.000000 ggml-python-0.0.6/pyproject.toml
+-rw-r--r--   0        0        0        0 2022-11-09 12:37:21.000000 ggml-python-0.0.6/tests/__init__.py
+-rw-r--r--   0        0        0      661 2022-11-09 12:37:21.000000 ggml-python-0.0.6/tests/test_experimental.py
+-rw-r--r--   0        0        0     1057 2022-11-09 12:37:21.000000 ggml-python-0.0.6/tests/test_ggml.py
+-rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/.git
+-rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/.gitignore
+-rw-r--r--   0        0        0     2630 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/CMakeLists.txt
+-rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/LICENSE
+-rw-r--r--   0        0        0     4788 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/README.md
+-rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/cmake/BuildTypes.cmake
+-rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/cmake/GitVars.cmake
+-rw-r--r--   0        0        0      794 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/CMakeLists.txt
+-rw-r--r--   0        0        0     8269 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/common-ggml.cpp
+-rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/common-ggml.h
+-rw-r--r--   0        0        0    23292 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/common.cpp
+-rw-r--r--   0        0        0     4373 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/common.h
+-rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/dolly-v2/CMakeLists.txt
+-rw-r--r--   0        0        0     5321 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/dolly-v2/README.md
+-rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28814 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/dolly-v2/main.cpp
+-rw-r--r--   0        0        0     6032 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/dolly-v2/quantize.cpp
+-rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/dr_wav.h
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/CMakeLists.txt
+-rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/README.md
+-rw-r--r--   0        0        0     6313 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py
+-rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py
+-rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/download-ggml-model.sh
+-rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/download-model.sh
+-rw-r--r--   0        0        0    29384 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/main.cpp
+-rw-r--r--   0        0        0     5854 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-2/quantize.cpp
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/CMakeLists.txt
+-rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/README.md
+-rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/download-ggml-model.sh
+-rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/download-model.sh
+-rw-r--r--   0        0        0    25824 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/main.cpp
+-rw-r--r--   0        0        0     5856 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-j/quantize.cpp
+-rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-neox/CMakeLists.txt
+-rw-r--r--   0        0        0     3871 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-neox/README.md
+-rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28274 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-neox/main.cpp
+-rw-r--r--   0        0        0     5840 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/gpt-neox/quantize.cpp
+-rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/CMakeLists.txt
+-rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/README.md
+-rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0     3328 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/main-cpu.cpp
+-rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/main-mtl.cpp
+-rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/main-mtl.h
+-rw-r--r--   0        0        0    21062 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/main-mtl.m
+-rw-r--r--   0        0        0     9369 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/main.cpp
+-rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/web/.gitignore
+-rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mnist/web/index.html
+-rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mpt/CMakeLists.txt
+-rw-r--r--   0        0        0     4722 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mpt/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    38057 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mpt/main.cpp
+-rw-r--r--   0        0        0     6096 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/mpt/quantize.cpp
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/dolly-v2.txt
+-rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/gpt-2-chinese.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/gpt-2.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/gpt-j.txt
+-rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/gpt-neox-japanese.txt
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/gpt-neox.txt
+-rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/polyglot-ko.txt
+-rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/replit.txt
+-rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/starcoder.txt
+-rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/test-cases.txt
+-rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/tokenize_huggingface.py
+-rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/prompts/whisper.txt
+-rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/replit/CMakeLists.txt
+-rw-r--r--   0        0        0     3169 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/replit/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    27139 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/replit/main.cpp
+-rw-r--r--   0        0        0     5636 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/replit/quantize.cpp
+-rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/starcoder/CMakeLists.txt
+-rw-r--r--   0        0        0     3757 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/starcoder/README.md
+-rw-r--r--   0        0        0     7758 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py
+-rw-r--r--   0        0        0    30865 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/starcoder/main.cpp
+-rw-r--r--   0        0        0     5875 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/starcoder/quantize.cpp
+-rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/CMakeLists.txt
+-rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/README.md
+-rw-r--r--   0        0        0     9506 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    36271 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/main.cpp
+-rw-r--r--   0        0        0     8093 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/quantize.cpp
+-rw-r--r--   0        0        0   184815 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/whisper.cpp
+-rw-r--r--   0        0        0    23750 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/examples/whisper/whisper.h
+-rw-r--r--   0        0        0    43215 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/include/ggml/ggml.h
+-rwxr-xr-x   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/scripts/sync-llama.sh
+-rwxr-xr-x   0        0        0     1067 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/scripts/sync-whisper.sh
+-rw-r--r--   0        0        0     8752 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/src/CMakeLists.txt
+-rw-r--r--   0        0        0    36160 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/src/ggml-cuda.cu
+-rw-r--r--   0        0        0      906 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/src/ggml-cuda.h
+-rw-r--r--   0        0        0    11852 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/src/ggml-opencl.c
+-rw-r--r--   0        0        0      661 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/src/ggml-opencl.h
+-rw-r--r--   0        0        0   537384 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/src/ggml.c
+-rw-r--r--   0        0        0     9406 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/CMakeLists.txt
+-rw-r--r--   0        0        0     6569 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-blas0.c
+-rw-r--r--   0        0        0    37497 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-grad0.c
+-rw-r--r--   0        0        0    10522 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-mul-mat0.c
+-rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-mul-mat1.c
+-rw-r--r--   0        0        0    91837 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-mul-mat2.c
+-rw-r--r--   0        0        0     5616 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-opt.c
+-rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-svd0.c
+-rw-r--r--   0        0        0     3157 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-vec0.c
+-rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-vec1.c
+-rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test-vec2.c
+-rw-r--r--   0        0        0     1182 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test0.c
+-rw-r--r--   0        0        0    15073 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test1.c
+-rw-r--r--   0        0        0     5703 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test2.c
+-rw-r--r--   0        0        0     2841 2022-11-09 12:37:21.000000 ggml-python-0.0.6/vendor/ggml/tests/test3.c
+-rw-r--r--   0        0        0     2678 2022-11-09 12:37:21.000000 ggml-python-0.0.6/PKG-INFO
```

### Comparing `ggml_python-0.0.4/.gitignore` & `ggml-python-0.0.6/.gitignore`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/LICENSE.md` & `ggml-python-0.0.6/LICENSE.md`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/README.md` & `ggml-python-0.0.6/README.md`

 * *Files 6% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 # Python bindings for [`ggml`](https://github.com/ggerganov/ggml)
 
+[![Tests](https://github.com/abetlen/ggml-python/actions/workflows/test.yaml/badge.svg)](https://github.com/abetlen/ggml-python/actions/workflows/test.yaml)
 [![PyPI](https://img.shields.io/pypi/v/ggml-python)](https://pypi.org/project/ggml-python/)
 [![PyPI - Python Version](https://img.shields.io/pypi/pyversions/ggml-python)](https://pypi.org/project/ggml-python/)
 [![PyPI - License](https://img.shields.io/pypi/l/ggml-python)](https://pypi.org/project/ggml-python/)
 [![PyPI - Downloads](https://img.shields.io/pypi/dm/ggml-python)](https://pypi.org/project/ggml-python/)
 
 
 Python bindings for the [`ggml`](https://github.com/ggerganov/ggml) tensor library for machine learning.
@@ -35,8 +36,12 @@
 
 ## Troubleshooting
 
 If you are having trouble installing `ggml-python` or activating specific features please try to install it with the `--verbose` and `--no-cache-dir` flags to get more information about any issues:
 
 ```bash
 [options] pip install ggml-python --verbose --no-cache-dir --force-reinstall --upgrade
-```
+```
+
+# License
+
+This project is licensed under the terms of the MIT license.
```

### Comparing `ggml_python-0.0.4/ggml/experimental.py` & `ggml-python-0.0.6/ggml/experimental.py`

 * *Files 1% similar despite different names*

```diff
@@ -10,39 +10,48 @@
 
 _default_context: Optional["Context"] = None
 
 
 def default_context() -> "Context":
     global _default_context
     if _default_context is None:
-        _default_context = Context(InitParams())
+        _default_context = Context()
     return _default_context
 
 
 class InitParams:
     def __init__(
         self,
         mem_size: int = 16 * 1024 * 1024,
         mem_buffer: Optional[ctypes.c_void_p] = None,
         no_alloc: bool = False,
     ):
         self.mem_size = mem_size
         self.mem_buffer = mem_buffer
         self.no_alloc = no_alloc
         self.params = ggml.ggml_init_params(
-            mem_size=self.mem_size,
+            mem_size=ctypes.c_size_t(self.mem_size),
             mem_buffer=self.mem_buffer,
-            no_alloc=self.no_alloc,
+            no_alloc=ctypes.c_bool(self.no_alloc),
         )
 
 
 class Context:
-    def __init__(self, init_params: InitParams):
-        self.init_params = init_params
-        self.context: ggml.ggml_context_p = ggml.ggml_init(init_params.params)
+    def __init__(
+        self,
+        mem_size: int = 16 * 1024 * 1024,
+        mem_buffer: Optional[ctypes.c_void_p] = None,
+        no_alloc: bool = False,
+    ):
+        self.init_params = InitParams(
+            mem_size=mem_size,
+            mem_buffer=mem_buffer,
+            no_alloc=no_alloc,
+        )
+        self.context: ggml.ggml_context_p = ggml.ggml_init(self.init_params.params)
 
     def __del__(self):
         ggml.ggml_free(self.context)
 
 
 class GGML_TYPE(enum.Enum):
     F32 = ggml.GGML_TYPE_F32.value
@@ -1069,44 +1078,44 @@
 
 class CGraph:
     def __init__(self, cgraph: ggml.ggml_cgraph, ctx: Optional[Context] = None):
         self.cgraph = cgraph
         self.ctx = ctx or default_context()
 
     def compute(self):
-        ggml.ggml_graph_compute(self.ctx.context, ctypes.pointer(self.cgraph))
+        ggml.ggml_graph_compute(self.ctx.context, ctypes.byref(self.cgraph))  # type: ignore
 
     def reset(self):
-        ggml.ggml_graph_reset(ctypes.pointer(self.cgraph))
+        ggml.ggml_graph_reset(ctypes.byref(self.cgraph))  # type: ignore
 
     def get_tensor(self, name: bytes):
         return Tensor(
-            tensor=ggml.ggml_graph_get_tensor(ctypes.pointer(self.cgraph), name),
+            tensor=ggml.ggml_graph_get_tensor(ctypes.byref(self.cgraph), name),  # type: ignore
             ctx=self.ctx,
         )
 
     def graph_export(self, fname: bytes):
-        ggml.ggml_graph_export(ctypes.pointer(self.cgraph), fname)
+        ggml.ggml_graph_export(ctypes.byref(self.cgraph), fname)  # type: ignore
 
     def build_forward_expand(self, tensor: Tensor):
-        ggml.ggml_build_forward_expand(ctypes.pointer(self.cgraph), tensor.tensor)
+        ggml.ggml_build_forward_expand(ctypes.byref(self.cgraph), tensor.tensor)  # type: ignore
 
     @staticmethod
     def print(a: "CGraph"):
-        ggml.ggml_graph_print(ctypes.pointer(a.cgraph))
+        ggml.ggml_graph_print(ctypes.byref(a.cgraph))  # type: ignore
 
     @staticmethod
     def dump_dot(
         gb: "CGraph",
         gf: Optional["CGraph"],
         filename: bytes,
     ):
         gf_p = ctypes.pointer(gf.cgraph) if gf else None
         ggml.ggml_graph_dump_dot(
-            ctypes.pointer(gb.cgraph), gf_p, filename  # type: ignore
+            ctypes.byref(gb.cgraph), gf_p, filename  # type: ignore
         )
 
     @classmethod
     def build_forward(cls, tensor: Tensor):
         return CGraph(cgraph=ggml.ggml_build_forward(tensor.tensor), ctx=tensor.ctx)
 
     @classmethod
```

### Comparing `ggml_python-0.0.4/ggml/ggml.py` & `ggml-python-0.0.6/ggml/ggml.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,34 +1,38 @@
 import os
 import sys
 import ctypes
 import pathlib
+from typing import List
 
 
 # Load the library
 def load_shared_library(lib_base_name: str):
+    # Construct the paths to the possible shared library names
+    _base_path = pathlib.Path(__file__).parent.resolve()
+    # Searching for the library in the current directory under the name "libllama" (default name
+    # for llamacpp) and "llama" (default name for this repo)
+    _lib_paths: List[pathlib.Path] = []
     # Determine the file extension based on the platform
     if sys.platform.startswith("linux"):
-        lib_ext = ".so"
+        _lib_paths += [
+            _base_path / f"lib{lib_base_name}.so",
+        ]
     elif sys.platform == "darwin":
-        lib_ext = ".so"
+        _lib_paths += [
+            _base_path / f"lib{lib_base_name}.so",
+            _base_path / f"lib{lib_base_name}.dylib",
+        ]
     elif sys.platform == "win32":
-        lib_ext = ".dll"
+        _lib_paths += [
+            _base_path / f"{lib_base_name}.dll",
+        ]
     else:
         raise RuntimeError("Unsupported platform")
 
-    # Construct the paths to the possible shared library names
-    _base_path = pathlib.Path(__file__).parent.resolve()
-    # Searching for the library in the current directory under the name "libllama" (default name
-    # for llamacpp) and "llama" (default name for this repo)
-    _lib_paths = [
-        _base_path / f"lib{lib_base_name}{lib_ext}",
-        _base_path / f"{lib_base_name}{lib_ext}",
-    ]
-
     cdll_args = dict()  # type: ignore
     # Add the library directory to the DLL search path on Windows (if needed)
     if sys.platform == "win32" and sys.version_info >= (3, 8):
         os.add_dll_directory(str(_base_path))
         cdll_args["winmode"] = 0
 
     # Try to load the shared library, handling potential errors
@@ -1090,14 +1094,34 @@
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 ]
 lib.ggml_add1.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_add1_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         struct ggml_tensor  * b);
+def ggml_add1_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+    b,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
+    return lib.ggml_add1_inplace(ctx, a, b)
+
+
+lib.ggml_add1_inplace.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_tensor),
+    ctypes.POINTER(ggml_tensor),
+]
+lib.ggml_add1_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_acc(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b,
 #         size_t                nb1,
 #         size_t                nb2,
 #         size_t                nb3,
@@ -1174,14 +1198,34 @@
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 ]
 lib.ggml_sub.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_sub_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         struct ggml_tensor  * b);
+def ggml_sub_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+    b,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
+    return lib.ggml_sub_inplace(ctx, a, b)
+
+
+lib.ggml_sub_inplace.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_tensor),
+    ctypes.POINTER(ggml_tensor),
+]
+lib.ggml_sub_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_mul(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_mul(
     ctx: ggml_context_p,
     a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
@@ -1194,14 +1238,34 @@
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 ]
 lib.ggml_mul.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_mul_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         struct ggml_tensor  * b);
+def ggml_mul_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+    b,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
+    return lib.ggml_mul_inplace(ctx, a, b)
+
+
+lib.ggml_mul_inplace.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_tensor),
+    ctypes.POINTER(ggml_tensor),
+]
+lib.ggml_mul_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_div(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_div(
     ctx: ggml_context_p,
     a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
@@ -1214,42 +1278,90 @@
     ggml_context_p,
     ctypes.POINTER(ggml_tensor),
     ctypes.POINTER(ggml_tensor),
 ]
 lib.ggml_div.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_div_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a,
+#         struct ggml_tensor  * b);
+def ggml_div_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+    b,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
+    return lib.ggml_div_inplace(ctx, a, b)
+
+
+lib.ggml_div_inplace.argtypes = [
+    ggml_context_p,
+    ctypes.POINTER(ggml_tensor),
+    ctypes.POINTER(ggml_tensor),
+]
+lib.ggml_div_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_sqr(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sqr(
     ctx,  # type: ggml_context_p
     a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_sqr(ctx, a)
 
 
 lib.ggml_sqr.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sqr.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_sqr_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_sqr_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
+    return lib.ggml_sqr_inplace(ctx, a)
+
+
+lib.ggml_sqr_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_sqr_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_sqrt(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sqrt(
     ctx,  # type: ggml_context_p
     a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_sqrt(ctx, a)
 
 
 lib.ggml_sqrt.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sqrt.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_sqrt_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_sqrt_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
+    return lib.ggml_sqrt_inplace(ctx, a)
+
+
+lib.ggml_sqrt_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_sqrt_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_log(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_log(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_log(ctx, a)
@@ -1346,40 +1458,82 @@
     return lib.ggml_abs(ctx, a)
 
 
 lib.ggml_abs.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_abs.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_abs_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_abs_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_abs_inplace(ctx, a)
+
+
+lib.ggml_abs_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_abs_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_sgn(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_sgn(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_sgn(ctx, a)
 
 
 lib.ggml_sgn.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_sgn.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_sgn_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_sgn_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_sgn_inplace(ctx, a)
+
+
+lib.ggml_sgn_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_sgn_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_neg(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_neg(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_neg(ctx, a)
 
 
 lib.ggml_neg.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_neg.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_neg_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_neg_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_neg_inplace(ctx, a)
+
+
+lib.ggml_neg_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_neg_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_step(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_step(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_step(ctx, a)
@@ -1398,41 +1552,83 @@
     return lib.ggml_relu(ctx, a)
 
 
 lib.ggml_relu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_relu.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_relu_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_relu_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_relu_inplace(ctx, a)
+
+
+lib.ggml_relu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_relu_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # // TODO: double-check this computation is correct
 # GGML_API struct ggml_tensor * ggml_gelu(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_gelu(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_gelu(ctx, a)
 
 
 lib.ggml_gelu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_gelu.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_gelu_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_gelu_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_gelu_inplace(ctx, a)
+
+
+lib.ggml_gelu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_gelu_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_silu(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_silu(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_silu(ctx, a)
 
 
 lib.ggml_silu.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_silu.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_silu_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_silu_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_silu_inplace(ctx, a)
+
+
+lib.ggml_silu_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_silu_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # // a - x
 # // b - dy
 # GGML_API struct ggml_tensor * ggml_silu_back(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_silu_back(
@@ -1462,27 +1658,55 @@
     return lib.ggml_norm(ctx, a)
 
 
 lib.ggml_norm.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_norm.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_norm_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_norm_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_norm_inplace(ctx, a)
+
+
+lib.ggml_norm_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_norm_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # GGML_API struct ggml_tensor * ggml_rms_norm(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a);
 def ggml_rms_norm(
     ctx: ggml_context_p, a  # type: ctypes._Pointer[ggml_tensor] # type: ignore
 ):  # type: (...) -> ctypes._Pointer[ggml_tensor] # type: ignore
     return lib.ggml_rms_norm(ctx, a)
 
 
 lib.ggml_rms_norm.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
 lib.ggml_rms_norm.restype = ctypes.POINTER(ggml_tensor)
 
 
+# GGML_API struct ggml_tensor * ggml_rms_norm_inplace(
+#         struct ggml_context * ctx,
+#         struct ggml_tensor  * a);
+def ggml_rms_norm_inplace(
+    ctx: ggml_context_p,
+    a,  # type: ctypes._Pointer[ggml_tensor] # type: ignore
+):  # type: (...) -> ctypes.POINTER[ggml_tensor] # type: ignore
+    return lib.ggml_rms_norm_inplace(ctx, a)
+
+
+lib.ggml_rms_norm_inplace.argtypes = [ggml_context_p, ctypes.POINTER(ggml_tensor)]
+lib.ggml_rms_norm_inplace.restype = ctypes.POINTER(ggml_tensor)
+
+
 # // a - x
 # // b - dy
 # GGML_API struct ggml_tensor * ggml_rms_norm_back(
 #         struct ggml_context * ctx,
 #         struct ggml_tensor  * a,
 #         struct ggml_tensor  * b);
 def ggml_rms_norm_back(
```

### Comparing `ggml_python-0.0.4/tests/test_experimental.py` & `ggml-python-0.0.6/tests/test_experimental.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/tests/test_ggml.py` & `ggml-python-0.0.6/tests/test_ggml.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/CMakeLists.txt` & `ggml-python-0.0.6/vendor/ggml/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/LICENSE` & `ggml-python-0.0.6/vendor/ggml/LICENSE`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/README.md` & `ggml-python-0.0.6/vendor/ggml/README.md`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/cmake/BuildTypes.cmake` & `ggml-python-0.0.6/vendor/ggml/cmake/BuildTypes.cmake`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/cmake/GitVars.cmake` & `ggml-python-0.0.6/vendor/ggml/cmake/GitVars.cmake`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/CMakeLists.txt` & `ggml-python-0.0.6/vendor/ggml/examples/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/dr_wav.h` & `ggml-python-0.0.6/vendor/ggml/examples/dr_wav.h`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/README.md` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/README.md`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/download-ggml-model.sh` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/download-model.sh` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/main.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-2/quantize.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-j/README.md` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-j/README.md`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-j/download-ggml-model.sh` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-j/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-j/download-model.sh` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-j/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-j/main.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-j/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/gpt-j/quantize.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/gpt-j/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/whisper/README.md` & `ggml-python-0.0.6/vendor/ggml/examples/whisper/README.md`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/whisper/convert-pt-to-ggml.py` & `ggml-python-0.0.6/vendor/ggml/examples/whisper/convert-pt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/whisper/main.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/whisper/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/whisper/quantize.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/whisper/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/whisper/whisper.cpp` & `ggml-python-0.0.6/vendor/ggml/examples/whisper/whisper.cpp`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/examples/whisper/whisper.h` & `ggml-python-0.0.6/vendor/ggml/examples/whisper/whisper.h`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/include/ggml/ggml.h` & `ggml-python-0.0.6/vendor/ggml/include/ggml/ggml.h`

 * *Files 8% similar despite different names*

```diff
@@ -535,14 +535,19 @@
             struct ggml_tensor  * b);
 
     GGML_API struct ggml_tensor * ggml_add1(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
+    GGML_API struct ggml_tensor * ggml_add1_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a,
+            struct ggml_tensor  * b);
+
     GGML_API struct ggml_tensor * ggml_acc(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b,
             size_t                nb1,
             size_t                nb2,
             size_t                nb3,
@@ -558,32 +563,55 @@
             size_t                offset);
 
     GGML_API struct ggml_tensor * ggml_sub(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
+    GGML_API struct ggml_tensor * ggml_sub_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a,
+            struct ggml_tensor  * b);
+
     GGML_API struct ggml_tensor * ggml_mul(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
+    GGML_API struct ggml_tensor * ggml_mul_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a,
+            struct ggml_tensor  * b);
+
     GGML_API struct ggml_tensor * ggml_div(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
+    GGML_API struct ggml_tensor * ggml_div_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a,
+            struct ggml_tensor  * b);
+
     GGML_API struct ggml_tensor * ggml_sqr(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_sqr_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_sqrt(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_sqrt_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_log(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
     GGML_API struct ggml_tensor * ggml_log_inplace(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
@@ -610,56 +638,92 @@
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
     GGML_API struct ggml_tensor * ggml_abs(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_abs_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_sgn(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_sgn_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_neg(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_neg_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_step(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_step_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_relu(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_relu_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     // TODO: double-check this computation is correct
     GGML_API struct ggml_tensor * ggml_gelu(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_gelu_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_silu(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_silu_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     // a - x
     // b - dy
     GGML_API struct ggml_tensor * ggml_silu_back(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
 
     // normalize along rows
     // TODO: eps is hardcoded to 1e-5 for now
     GGML_API struct ggml_tensor * ggml_norm(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_norm_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     GGML_API struct ggml_tensor * ggml_rms_norm(
             struct ggml_context * ctx,
             struct ggml_tensor  * a);
 
+    GGML_API struct ggml_tensor * ggml_rms_norm_inplace(
+            struct ggml_context * ctx,
+            struct ggml_tensor  * a);
+
     // a - x
     // b - dy
     GGML_API struct ggml_tensor * ggml_rms_norm_back(
             struct ggml_context * ctx,
             struct ggml_tensor  * a,
             struct ggml_tensor  * b);
```

### Comparing `ggml_python-0.0.4/vendor/ggml/src/CMakeLists.txt` & `ggml-python-0.0.6/vendor/ggml/src/CMakeLists.txt`

 * *Files 0% similar despite different names*

```diff
@@ -222,14 +222,16 @@
 if (MSVC)
     target_link_libraries(${TARGET} PUBLIC ${GGML_EXTRA_LIBS} ${CMAKE_THREAD_LIBS_INIT})
 else()
     target_link_libraries(${TARGET} PUBLIC m ${GGML_EXTRA_LIBS} ${CMAKE_THREAD_LIBS_INIT})
 endif()
 
 if (BUILD_SHARED_LIBS)
+    set(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)
+
     target_link_libraries(${TARGET} PUBLIC
         ${CMAKE_DL_LIBS}
         )
 
     target_compile_definitions(${TARGET} PUBLIC
         GGML_SHARED
         )
```

### Comparing `ggml_python-0.0.4/vendor/ggml/src/ggml.c` & `ggml-python-0.0.6/vendor/ggml/src/ggml.c`

 * *Files 0% similar despite different names*

```diff
@@ -12585,15 +12585,15 @@
 00031280: 7420 3d20 6767 6d6c 5f76 6965 775f 7465  t = ggml_view_te
 00031290: 6e73 6f72 2863 7478 2c20 6129 3b0a 0a20  nsor(ctx, a);.. 
 000312a0: 2020 2067 676d 6c5f 7363 7261 7463 685f     ggml_scratch_
 000312b0: 7361 7665 2863 7478 293b 0a0a 2020 2020  save(ctx);..    
 000312c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
 000312d0: 6f72 202a 2062 203d 2067 676d 6c5f 6e65  or * b = ggml_ne
 000312e0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-000312f0: 2047 474d 4c5f 5459 5045 5f49 3332 2c20   GGML_TYPE_I32, 
+000312f0: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
 00031300: 3329 3b0a 0a20 2020 2028 2866 6c6f 6174  3);..    ((float
 00031310: 202a 2920 622d 3e64 6174 6129 5b30 5d20   *) b->data)[0] 
 00031320: 3d20 6d69 6e3b 0a20 2020 2028 2866 6c6f  = min;.    ((flo
 00031330: 6174 202a 2920 622d 3e64 6174 6129 5b31  at *) b->data)[1
 00031340: 5d20 3d20 6d61 783b 0a0a 2020 2020 6767  ] = max;..    gg
 00031350: 6d6c 5f73 6372 6174 6368 5f6c 6f61 6428  ml_scratch_load(
 00031360: 6374 7829 3b0a 0a20 2020 2072 6573 756c  ctx);..    resul
@@ -20727,12861 +20727,12861 @@
 00050f60: 206e 6531 322d 3129 3b0a 2020 2020 636f   ne12-1);.    co
 00050f70: 6e73 7420 696e 7420 696d 3320 3d20 286e  nst int im3 = (n
 00050f80: 6531 3320 3d3d 2030 203f 2030 203a 206e  e13 == 0 ? 0 : n
 00050f90: 6531 332d 3129 3b0a 0a20 2020 2047 474d  e13-1);..    GGM
 00050fa0: 4c5f 4153 5345 5254 286f 6666 7365 7420  L_ASSERT(offset 
 00050fb0: 2b20 696d 302a 6e62 3020 202b 2069 6d31  + im0*nb0  + im1
 00050fc0: 2a6e 6231 2020 2b20 696d 322a 6e62 3220  *nb1  + im2*nb2 
-00050fd0: 202b 2069 6d33 2a6e 6233 2020 3c20 6767   + im3*nb3  < gg
-00050fe0: 6d6c 5f6e 6279 7465 7328 6473 7429 293b  ml_nbytes(dst));
-00050ff0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00051000: 5428 6e62 3130 203d 3d20 7369 7a65 6f66  T(nb10 == sizeof
-00051010: 2866 6c6f 6174 2929 3b0a 0a20 2020 202f  (float));..    /
-00051020: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-00051030: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-00051040: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-00051050: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-00051060: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-00051070: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-00051080: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-00051090: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-000510a0: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-000510b0: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-000510c0: 2020 2066 6f72 2028 696e 7420 6972 203d     for (int ir =
-000510d0: 2069 7230 3b20 6972 203c 2069 7231 3b20   ir0; ir < ir1; 
-000510e0: 2b2b 6972 2920 7b0a 2020 2020 2020 2020  ++ir) {.        
-000510f0: 2f2f 2073 7263 3020 616e 6420 6473 7420  // src0 and dst 
-00051100: 6172 6520 7669 6577 6564 2077 6974 6820  are viewed with 
-00051110: 7368 6170 6520 6f66 2073 7263 3120 616e  shape of src1 an
-00051120: 6420 6f66 6673 6574 0a20 2020 2020 2020  d offset.       
-00051130: 202f 2f20 3d3e 2073 616d 6520 696e 6469   // => same indi
-00051140: 6365 730a 2020 2020 2020 2020 636f 6e73  ces.        cons
-00051150: 7420 696e 7420 6933 203d 2069 722f 286e  t int i3 = ir/(n
-00051160: 6531 322a 6e65 3131 293b 0a20 2020 2020  e12*ne11);.     
-00051170: 2020 2063 6f6e 7374 2069 6e74 2069 3220     const int i2 
-00051180: 3d20 2869 7220 2d20 6933 2a6e 6531 322a  = (ir - i3*ne12*
-00051190: 6e65 3131 292f 6e65 3131 3b0a 2020 2020  ne11)/ne11;.    
-000511a0: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
-000511b0: 203d 2028 6972 202d 2069 332a 6e65 3132   = (ir - i3*ne12
-000511c0: 2a6e 6531 3120 2d20 6932 2a6e 6531 3129  *ne11 - i2*ne11)
-000511d0: 3b0a 0a20 2020 2020 2020 2067 676d 6c5f  ;..        ggml_
-000511e0: 7665 635f 6370 795f 6633 3228 6e63 2c0a  vec_cpy_f32(nc,.
-000511f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051200: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00051210: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
-00051220: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
-00051230: 3220 202b 2069 312a 6e62 3120 202b 206f  2  + i1*nb1  + o
-00051240: 6666 7365 7429 2c0a 2020 2020 2020 2020  ffset),.        
-00051250: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-00051260: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
-00051270: 2d3e 6461 7461 202b 2069 332a 6e62 3133  ->data + i3*nb13
-00051280: 202b 2069 322a 6e62 3132 202b 2069 312a   + i2*nb12 + i1*
-00051290: 6e62 3131 2929 3b0a 2020 2020 7d0a 7d0a  nb11));.    }.}.
-000512a0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000512b0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000512c0: 645f 7365 7428 0a20 2020 2020 2020 2063  d_set(.        c
-000512d0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000512e0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-000512f0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00051300: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00051310: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00051320: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00051330: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00051340: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00051350: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00051360: 2067 676d 6c5f 7465 6e73 6f72 202a 206f   ggml_tensor * o
-00051370: 7074 302c 0a20 2020 2020 2020 2073 7472  pt0,.        str
-00051380: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00051390: 2a20 6473 7429 207b 0a0a 2020 2020 7377  * dst) {..    sw
-000513a0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
-000513b0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-000513c0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-000513d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000513e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000513f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051400: 7264 5f73 6574 5f66 3332 2870 6172 616d  rd_set_f32(param
-00051410: 732c 2073 7263 302c 2073 7263 312c 206f  s, src0, src1, o
-00051420: 7074 302c 2064 7374 293b 0a20 2020 2020  pt0, dst);.     
-00051430: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00051440: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00051450: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
-00051460: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00051470: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
-00051480: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00051490: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
-000514a0: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-000514b0: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
-000514c0: 4747 4d4c 5f54 5950 455f 5135 5f31 3a0a  GGML_TYPE_Q5_1:.
-000514d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000514e0: 4c5f 5459 5045 5f51 385f 303a 0a20 2020  L_TYPE_Q8_0:.   
-000514f0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00051500: 5950 455f 5138 5f31 3a0a 2020 2020 2020  YPE_Q8_1:.      
-00051510: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00051520: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00051530: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00051540: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00051550: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00051560: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-00051570: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051580: 7264 5f63 7079 0a0a 7374 6174 6963 2076  rd_cpy..static v
-00051590: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-000515a0: 5f66 6f72 7761 7264 5f63 7079 280a 2020  _forward_cpy(.  
-000515b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000515c0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-000515d0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-000515e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000515f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00051600: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00051610: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00051620: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00051630: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00051640: 6f72 7761 7264 5f64 7570 2870 6172 616d  orward_dup(param
-00051650: 732c 2073 7263 302c 2064 7374 293b 0a7d  s, src0, dst);.}
-00051660: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00051670: 655f 666f 7277 6172 645f 636f 6e74 0a0a  e_forward_cont..
-00051680: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00051690: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000516a0: 5f63 6f6e 7428 0a20 2020 2020 2020 2063  _cont(.        c
-000516b0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000516c0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-000516d0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-000516e0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000516f0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00051700: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
-00051710: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00051720: 6473 7429 207b 0a20 2020 2067 676d 6c5f  dst) {.    ggml_
-00051730: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00051740: 6475 7028 7061 7261 6d73 2c20 7372 6330  dup(params, src0
-00051750: 2c20 6473 7429 3b0a 7d0a 0a2f 2f20 6767  , dst);.}..// gg
-00051760: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051770: 7264 5f72 6573 6861 7065 0a0a 7374 6174  rd_reshape..stat
-00051780: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00051790: 7075 7465 5f66 6f72 7761 7264 5f72 6573  pute_forward_res
-000517a0: 6861 7065 280a 2020 2020 2020 2020 636f  hape(.        co
-000517b0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000517c0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-000517d0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-000517e0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000517f0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00051800: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00051810: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00051820: 7374 2920 7b0a 2020 2020 2f2f 204e 4f50  st) {.    // NOP
-00051830: 0a20 2020 2055 4e55 5345 4428 7061 7261  .    UNUSED(para
-00051840: 6d73 293b 0a20 2020 2055 4e55 5345 4428  ms);.    UNUSED(
-00051850: 7372 6330 293b 0a20 2020 2055 4e55 5345  src0);.    UNUSE
-00051860: 4428 6473 7429 3b0a 7d0a 0a2f 2f20 6767  D(dst);.}..// gg
-00051870: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051880: 7264 5f76 6965 770a 0a73 7461 7469 6320  rd_view..static 
-00051890: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-000518a0: 655f 666f 7277 6172 645f 7669 6577 280a  e_forward_view(.
-000518b0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000518c0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000518d0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-000518e0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-000518f0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00051900: 736f 7220 2a20 7372 6330 2920 7b0a 2020  sor * src0) {.  
-00051910: 2020 2f2f 204e 4f50 0a20 2020 2055 4e55    // NOP.    UNU
-00051920: 5345 4428 7061 7261 6d73 293b 0a20 2020  SED(params);.   
-00051930: 2055 4e55 5345 4428 7372 6330 293b 0a7d   UNUSED(src0);.}
-00051940: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-00051950: 655f 666f 7277 6172 645f 7065 726d 7574  e_forward_permut
-00051960: 650a 0a73 7461 7469 6320 766f 6964 2067  e..static void g
-00051970: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00051980: 6172 645f 7065 726d 7574 6528 0a20 2020  ard_permute(.   
-00051990: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000519a0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-000519b0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-000519c0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000519d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000519e0: 202a 2073 7263 3029 207b 0a20 2020 202f   * src0) {.    /
-000519f0: 2f20 4e4f 500a 2020 2020 554e 5553 4544  / NOP.    UNUSED
-00051a00: 2870 6172 616d 7329 3b0a 2020 2020 554e  (params);.    UN
-00051a10: 5553 4544 2873 7263 3029 3b0a 7d0a 0a2f  USED(src0);.}../
-00051a20: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00051a30: 6f72 7761 7264 5f74 7261 6e73 706f 7365  orward_transpose
-00051a40: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00051a50: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051a60: 7264 5f74 7261 6e73 706f 7365 280a 2020  rd_transpose(.  
-00051a70: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00051a80: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00051a90: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00051aa0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00051ab0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00051ac0: 7220 2a20 7372 6330 2920 7b0a 2020 2020  r * src0) {.    
-00051ad0: 2f2f 204e 4f50 0a20 2020 2055 4e55 5345  // NOP.    UNUSE
-00051ae0: 4428 7061 7261 6d73 293b 0a20 2020 2055  D(params);.    U
-00051af0: 4e55 5345 4428 7372 6330 293b 0a7d 0a0a  NUSED(src0);.}..
-00051b00: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00051b10: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
-00051b20: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00051b30: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00051b40: 7264 5f67 6574 5f72 6f77 735f 7128 0a20  rd_get_rows_q(. 
-00051b50: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00051b60: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00051b70: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00051b80: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00051b90: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00051ba0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-00051bb0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00051bc0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00051bd0: 6331 2c0a 2020 2020 2020 2020 2020 2020  c1,.            
-00051be0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00051bf0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00051c00: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
-00051c10: 3e69 7468 203d 3d20 3029 3b0a 0a20 2020  >ith == 0);..   
-00051c20: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00051c30: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-00051c40: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-00051c50: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00051c60: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-00051c70: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-00051c80: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
-00051c90: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
-00051ca0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00051cb0: 7420 6e72 203d 2067 676d 6c5f 6e65 6c65  t nr = ggml_nele
-00051cc0: 6d65 6e74 7328 7372 6331 293b 0a20 2020  ments(src1);.   
-00051cd0: 2063 6f6e 7374 2065 6e75 6d20 6767 6d6c   const enum ggml
-00051ce0: 5f74 7970 6520 7479 7065 203d 2073 7263  _type type = src
-00051cf0: 302d 3e74 7970 653b 0a20 2020 2064 6571  0->type;.    deq
-00051d00: 7561 6e74 697a 655f 726f 775f 715f 7420  uantize_row_q_t 
-00051d10: 636f 6e73 7420 6465 7175 616e 7469 7a65  const dequantize
-00051d20: 5f72 6f77 5f71 203d 2071 7561 6e74 697a  _row_q = quantiz
-00051d30: 655f 666e 735b 7479 7065 5d2e 6465 7175  e_fns[type].dequ
-00051d40: 616e 7469 7a65 5f72 6f77 5f71 3b0a 0a20  antize_row_q;.. 
-00051d50: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
-00051d60: 6e65 5b30 5d20 3d3d 206e 6329 3b0a 2020  ne[0] == nc);.  
-00051d70: 2020 6173 7365 7274 2820 6473 742d 3e6e    assert( dst->n
-00051d80: 655b 315d 203d 3d20 6e72 293b 0a20 2020  e[1] == nr);.   
-00051d90: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
-00051da0: 5b30 5d20 3d3d 2047 474d 4c5f 5459 5045  [0] == GGML_TYPE
-00051db0: 5f53 495a 455b 7479 7065 5d29 3b0a 0a20  _SIZE[type]);.. 
-00051dc0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00051dd0: 303b 2069 203c 206e 723b 202b 2b69 2920  0; i < nr; ++i) 
-00051de0: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
-00051df0: 696e 7420 7220 3d20 2828 696e 7433 325f  int r = ((int32_
-00051e00: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
-00051e10: 5b69 5d3b 0a0a 2020 2020 2020 2020 6465  [i];..        de
-00051e20: 7175 616e 7469 7a65 5f72 6f77 5f71 280a  quantize_row_q(.
-00051e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051e40: 2863 6f6e 7374 2076 6f69 6420 2a29 2028  (const void *) (
-00051e50: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-00051e60: 6174 6120 2b20 722a 7372 6330 2d3e 6e62  ata + r*src0->nb
-00051e70: 5b31 5d29 2c0a 2020 2020 2020 2020 2020  [1]),.          
-00051e80: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-00051e90: 7420 2a29 2028 2863 6861 7220 2a29 2020  t *) ((char *)  
-00051ea0: 6473 742d 3e64 6174 6120 2b20 692a 6473  dst->data + i*ds
-00051eb0: 742d 3e6e 625b 315d 292c 206e 6329 3b0a  t->nb[1]), nc);.
-00051ec0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-00051ed0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-00051ee0: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-00051ef0: 7773 5f66 3136 280a 2020 2020 2020 2020  ws_f16(.        
-00051f00: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00051f10: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00051f20: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00051f30: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00051f40: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00051f50: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-00051f60: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00051f70: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-00051f80: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00051f90: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00051fa0: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
-00051fb0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
-00051fc0: 2030 293b 0a0a 2020 2020 6966 2028 7061   0);..    if (pa
-00051fd0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00051fe0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-00051ff0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00052000: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00052010: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00052020: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00052030: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-00052040: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
-00052050: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-00052060: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-00052070: 7263 3129 3b0a 0a20 2020 2061 7373 6572  rc1);..    asser
-00052080: 7428 2064 7374 2d3e 6e65 5b30 5d20 3d3d  t( dst->ne[0] ==
-00052090: 206e 6329 3b0a 2020 2020 6173 7365 7274   nc);.    assert
-000520a0: 2820 6473 742d 3e6e 655b 315d 203d 3d20  ( dst->ne[1] == 
-000520b0: 6e72 293b 0a20 2020 2061 7373 6572 7428  nr);.    assert(
-000520c0: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
-000520d0: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-000520e0: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
-000520f0: 6e74 2069 203d 2030 3b20 6920 3c20 6e72  nt i = 0; i < nr
-00052100: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00052110: 2063 6f6e 7374 2069 6e74 2072 203d 2028   const int r = (
-00052120: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-00052130: 2d3e 6461 7461 295b 695d 3b0a 0a20 2020  ->data)[i];..   
-00052140: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-00052150: 3d20 303b 206a 203c 206e 633b 202b 2b6a  = 0; j < nc; ++j
-00052160: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00052170: 6767 6d6c 5f66 7031 365f 7420 7620 3d20  ggml_fp16_t v = 
-00052180: 2828 6767 6d6c 5f66 7031 365f 7420 2a29  ((ggml_fp16_t *)
-00052190: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-000521a0: 3e64 6174 6120 2b20 722a 7372 6330 2d3e  >data + r*src0->
-000521b0: 6e62 5b31 5d29 295b 6a5d 3b0a 2020 2020  nb[1]))[j];.    
-000521c0: 2020 2020 2020 2020 2828 666c 6f61 7420          ((float 
-000521d0: 2a29 2028 2863 6861 7220 2a29 2020 6473  *) ((char *)  ds
-000521e0: 742d 3e64 6174 6120 2b20 692a 6473 742d  t->data + i*dst-
-000521f0: 3e6e 625b 315d 2929 5b6a 5d20 3d20 4747  >nb[1]))[j] = GG
-00052200: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-00052210: 7629 3b0a 2020 2020 2020 2020 7d0a 2020  v);.        }.  
-00052220: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-00052230: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00052240: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
-00052250: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-00052260: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00052270: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00052280: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00052290: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000522a0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-000522b0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000522c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000522d0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-000522e0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
-000522f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00052300: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-00052310: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
-00052320: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
-00052330: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00052340: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
-00052350: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00052360: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-00052370: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-00052380: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
-00052390: 6f6e 7374 2069 6e74 206e 6320 3d20 7372  onst int nc = sr
-000523a0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-000523b0: 6f6e 7374 2069 6e74 206e 7220 3d20 6767  onst int nr = gg
-000523c0: 6d6c 5f6e 656c 656d 656e 7473 2873 7263  ml_nelements(src
-000523d0: 3129 3b0a 0a20 2020 2061 7373 6572 7428  1);..    assert(
-000523e0: 2064 7374 2d3e 6e65 5b30 5d20 3d3d 206e   dst->ne[0] == n
-000523f0: 6329 3b0a 2020 2020 6173 7365 7274 2820  c);.    assert( 
-00052400: 6473 742d 3e6e 655b 315d 203d 3d20 6e72  dst->ne[1] == nr
-00052410: 293b 0a20 2020 2061 7373 6572 7428 7372  );.    assert(sr
-00052420: 6330 2d3e 6e62 5b30 5d20 3d3d 2073 697a  c0->nb[0] == siz
-00052430: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00052440: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00052450: 3b20 6920 3c20 6e72 3b20 2b2b 6929 207b  ; i < nr; ++i) {
-00052460: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00052470: 6e74 2072 203d 2028 2869 6e74 3332 5f74  nt r = ((int32_t
-00052480: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-00052490: 695d 3b0a 0a20 2020 2020 2020 2067 676d  i];..        ggm
-000524a0: 6c5f 7665 635f 6370 795f 6633 3228 6e63  l_vec_cpy_f32(nc
-000524b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000524c0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-000524d0: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
-000524e0: 202b 2069 2a64 7374 2d3e 6e62 5b31 5d29   + i*dst->nb[1])
-000524f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00052500: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00052510: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-00052520: 202b 2072 2a73 7263 302d 3e6e 625b 315d   + r*src0->nb[1]
-00052530: 2929 3b0a 2020 2020 7d0a 7d0a 0a73 7461  ));.    }.}..sta
-00052540: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00052550: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
-00052560: 745f 726f 7773 280a 2020 2020 2020 2020  t_rows(.        
-00052570: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00052580: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00052590: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-000525a0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000525b0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000525c0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-000525d0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000525e0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-000525f0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00052600: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00052610: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00052620: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00052630: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00052640: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
-00052650: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00052660: 345f 313a 0a20 2020 2020 2020 2063 6173  4_1:.        cas
-00052670: 6520 4747 4d4c 5f54 5950 455f 5135 5f30  e GGML_TYPE_Q5_0
-00052680: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00052690: 474d 4c5f 5459 5045 5f51 355f 313a 0a20  GML_TYPE_Q5_1:. 
-000526a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000526b0: 5f54 5950 455f 5138 5f30 3a0a 2020 2020  _TYPE_Q8_0:.    
-000526c0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-000526d0: 5045 5f51 385f 313a 0a20 2020 2020 2020  PE_Q8_1:.       
-000526e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000526f0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00052700: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
-00052710: 726f 7773 5f71 2870 6172 616d 732c 2073  rows_q(params, s
-00052720: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
-00052730: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00052740: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00052750: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
-00052760: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00052770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052780: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00052790: 7761 7264 5f67 6574 5f72 6f77 735f 6631  ward_get_rows_f1
-000527a0: 3628 7061 7261 6d73 2c20 7372 6330 2c20  6(params, src0, 
-000527b0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-000527c0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000527d0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000527e0: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-000527f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00052800: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00052810: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00052820: 6765 745f 726f 7773 5f66 3332 2870 6172  get_rows_f32(par
-00052830: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00052840: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00052850: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00052860: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-00052870: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00052880: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00052890: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-000528a0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000528b0: 616b 3b0a 2020 2020 7d0a 0a20 2020 202f  ak;.    }..    /
-000528c0: 2f73 7461 7469 6320 626f 6f6c 2066 6972  /static bool fir
-000528d0: 7374 203d 2074 7275 653b 0a20 2020 202f  st = true;.    /
-000528e0: 2f70 7269 6e74 6628 226e 6530 203d 2025  /printf("ne0 = %
-000528f0: 642c 206e 6531 203d 2025 642c 206e 6532  d, ne1 = %d, ne2
-00052900: 203d 2025 645c 6e22 2c20 6473 742d 3e6e   = %d\n", dst->n
-00052910: 655b 305d 2c20 6473 742d 3e6e 655b 315d  e[0], dst->ne[1]
-00052920: 2c20 6473 742d 3e6e 655b 325d 293b 0a20  , dst->ne[2]);. 
-00052930: 2020 202f 2f69 6620 2866 6972 7374 2920     //if (first) 
-00052940: 7b0a 2020 2020 2f2f 2020 2020 6669 7273  {.    //    firs
-00052950: 7420 3d20 6661 6c73 653b 0a20 2020 202f  t = false;.    /
-00052960: 2f7d 2065 6c73 6520 7b0a 2020 2020 2f2f  /} else {.    //
-00052970: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
-00052980: 2030 3b20 6b20 3c20 6473 742d 3e6e 655b   0; k < dst->ne[
-00052990: 315d 3b20 2b2b 6b29 207b 0a20 2020 202f  1]; ++k) {.    /
-000529a0: 2f20 2020 2020 2020 2066 6f72 2028 696e  /        for (in
-000529b0: 7420 6a20 3d20 303b 206a 203c 2064 7374  t j = 0; j < dst
-000529c0: 2d3e 6e65 5b30 5d2f 3136 3b20 2b2b 6a29  ->ne[0]/16; ++j)
-000529d0: 207b 0a20 2020 202f 2f20 2020 2020 2020   {.    //       
-000529e0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-000529f0: 3d20 303b 2069 203c 2031 363b 202b 2b69  = 0; i < 16; ++i
-00052a00: 2920 7b0a 2020 2020 2f2f 2020 2020 2020  ) {.    //      
-00052a10: 2020 2020 2020 2020 2020 7072 696e 7466            printf
-00052a20: 2822 2538 2e34 6620 222c 2028 2866 6c6f  ("%8.4f ", ((flo
-00052a30: 6174 202a 2920 6473 742d 3e64 6174 6129  at *) dst->data)
-00052a40: 5b6b 2a64 7374 2d3e 6e65 5b30 5d20 2b20  [k*dst->ne[0] + 
-00052a50: 6a2a 3136 202b 2069 5d29 3b0a 2020 2020  j*16 + i]);.    
-00052a60: 2f2f 2020 2020 2020 2020 2020 2020 7d0a  //            }.
-00052a70: 2020 2020 2f2f 2020 2020 2020 2020 2020      //          
-00052a80: 2020 7072 696e 7466 2822 5c6e 2229 3b0a    printf("\n");.
-00052a90: 2020 2020 2f2f 2020 2020 2020 2020 7d0a      //        }.
-00052aa0: 2020 2020 2f2f 2020 2020 2020 2020 7072      //        pr
-00052ab0: 696e 7466 2822 5c6e 2229 3b0a 2020 2020  intf("\n");.    
-00052ac0: 2f2f 2020 2020 7d0a 2020 2020 2f2f 2020  //    }.    //  
-00052ad0: 2020 7072 696e 7466 2822 5c6e 2229 3b0a    printf("\n");.
-00052ae0: 2020 2020 2f2f 2020 2020 6578 6974 2830      //    exit(0
-00052af0: 293b 0a20 2020 202f 2f7d 0a7d 0a0a 2f2f  );.    //}.}..//
-00052b00: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00052b10: 7277 6172 645f 6765 745f 726f 7773 5f62  rward_get_rows_b
-00052b20: 6163 6b0a 0a73 7461 7469 6320 766f 6964  ack..static void
-00052b30: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00052b40: 7277 6172 645f 6765 745f 726f 7773 5f62  rward_get_rows_b
-00052b50: 6163 6b5f 6633 325f 6631 3628 0a20 2020  ack_f32_f16(.   
-00052b60: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00052b70: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00052b80: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00052b90: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00052ba0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00052bb0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00052bc0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00052bd0: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-00052be0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00052bf0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00052c00: 6f72 202a 206f 7074 302c 0a20 2020 2020  or * opt0,.     
-00052c10: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
-00052c20: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00052c30: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
-00052c40: 5345 5254 2870 6172 616d 732d 3e69 7468  SERT(params->ith
-00052c50: 203d 3d20 3029 3b0a 2020 2020 4747 4d4c   == 0);.    GGML
-00052c60: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
-00052c70: 5f73 616d 655f 7368 6170 6528 6f70 7430  _same_shape(opt0
-00052c80: 2c20 6473 7429 293b 0a20 2020 2047 474d  , dst));.    GGM
-00052c90: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-00052ca0: 5f63 6f6e 7469 6775 6f75 7328 6f70 7430  _contiguous(opt0
-00052cb0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00052cc0: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
-00052cd0: 6967 756f 7573 2864 7374 2929 3b0a 0a20  iguous(dst));.. 
-00052ce0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00052cf0: 666f 7277 6172 645f 6475 705f 7361 6d65  forward_dup_same
-00052d00: 5f63 6f6e 7428 7061 7261 6d73 2c20 6f70  _cont(params, op
-00052d10: 7430 2c20 6473 7429 3b0a 0a20 2020 2069  t0, dst);..    i
-00052d20: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00052d30: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00052d40: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-00052d50: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00052d60: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00052d70: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00052d80: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00052d90: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-00052da0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00052db0: 6e72 203d 2067 676d 6c5f 6e65 6c65 6d65  nr = ggml_neleme
-00052dc0: 6e74 7328 7372 6331 293b 0a0a 2020 2020  nts(src1);..    
-00052dd0: 4747 4d4c 5f41 5353 4552 5428 2064 7374  GGML_ASSERT( dst
-00052de0: 2d3e 6e65 5b30 5d20 3d3d 206e 6329 3b0a  ->ne[0] == nc);.
-00052df0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00052e00: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
-00052e10: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-00052e20: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
-00052e30: 6e74 2069 203d 2030 3b20 6920 3c20 6e72  nt i = 0; i < nr
-00052e40: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00052e50: 2063 6f6e 7374 2069 6e74 2072 203d 2028   const int r = (
-00052e60: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-00052e70: 2d3e 6461 7461 295b 695d 3b0a 0a20 2020  ->data)[i];..   
-00052e80: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-00052e90: 3d20 303b 206a 203c 206e 633b 202b 2b6a  = 0; j < nc; ++j
-00052ea0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00052eb0: 6767 6d6c 5f66 7031 365f 7420 7620 3d20  ggml_fp16_t v = 
-00052ec0: 2828 6767 6d6c 5f66 7031 365f 7420 2a29  ((ggml_fp16_t *)
-00052ed0: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
-00052ee0: 3e64 6174 6120 2b20 692a 7372 6330 2d3e  >data + i*src0->
-00052ef0: 6e62 5b31 5d29 295b 6a5d 3b0a 2020 2020  nb[1]))[j];.    
-00052f00: 2020 2020 2020 2020 2828 666c 6f61 7420          ((float 
-00052f10: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
-00052f20: 2d3e 6461 7461 202b 2072 2a64 7374 2d3e  ->data + r*dst->
-00052f30: 6e62 5b31 5d29 295b 6a5d 202b 3d20 4747  nb[1]))[j] += GG
-00052f40: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-00052f50: 7629 3b0a 2020 2020 2020 2020 7d0a 2020  v);.        }.  
-00052f60: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-00052f70: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00052f80: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
-00052f90: 5f62 6163 6b5f 6633 3228 0a20 2020 2020  _back_f32(.     
-00052fa0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00052fb0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00052fc0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00052fd0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00052fe0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00052ff0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-00053000: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00053010: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-00053020: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00053030: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00053040: 202a 206f 7074 302c 0a20 2020 2020 2020   * opt0,.       
-00053050: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00053060: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00053070: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-00053080: 5254 2870 6172 616d 732d 3e69 7468 203d  RT(params->ith =
-00053090: 3d20 3029 3b0a 2020 2020 4747 4d4c 5f41  = 0);.    GGML_A
-000530a0: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-000530b0: 616d 655f 7368 6170 6528 6f70 7430 2c20  ame_shape(opt0, 
-000530c0: 6473 7429 293b 0a20 2020 2047 474d 4c5f  dst));.    GGML_
-000530d0: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
-000530e0: 6f6e 7469 6775 6f75 7328 6f70 7430 2929  ontiguous(opt0))
-000530f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00053100: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-00053110: 756f 7573 2864 7374 2929 3b0a 0a20 2020  uous(dst));..   
-00053120: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00053130: 7277 6172 645f 6475 705f 7361 6d65 5f63  rward_dup_same_c
-00053140: 6f6e 7428 7061 7261 6d73 2c20 6f70 7430  ont(params, opt0
-00053150: 2c20 6473 7429 3b0a 0a20 2020 2069 6620  , dst);..    if 
-00053160: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00053170: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00053180: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00053190: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000531a0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000531b0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000531c0: 2020 2020 636f 6e73 7420 696e 7420 6e63      const int nc
-000531d0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
-000531e0: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-000531f0: 203d 2067 676d 6c5f 6e65 6c65 6d65 6e74   = ggml_nelement
-00053200: 7328 7372 6331 293b 0a0a 2020 2020 4747  s(src1);..    GG
-00053210: 4d4c 5f41 5353 4552 5428 2064 7374 2d3e  ML_ASSERT( dst->
-00053220: 6e65 5b30 5d20 3d3d 206e 6329 3b0a 2020  ne[0] == nc);.  
-00053230: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
-00053240: 6330 2d3e 6e62 5b30 5d20 3d3d 2073 697a  c0->nb[0] == siz
-00053250: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00053260: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00053270: 3b20 6920 3c20 6e72 3b20 2b2b 6929 207b  ; i < nr; ++i) {
-00053280: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00053290: 6e74 2072 203d 2028 2869 6e74 3332 5f74  nt r = ((int32_t
-000532a0: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-000532b0: 695d 3b0a 0a20 2020 2020 2020 2067 676d  i];..        ggm
-000532c0: 6c5f 7665 635f 6164 645f 6633 3228 6e63  l_vec_add_f32(nc
-000532d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000532e0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-000532f0: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
-00053300: 202b 2072 2a64 7374 2d3e 6e62 5b31 5d29   + r*dst->nb[1])
-00053310: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00053320: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00053330: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
-00053340: 202b 2072 2a64 7374 2d3e 6e62 5b31 5d29   + r*dst->nb[1])
-00053350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00053360: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
-00053370: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-00053380: 202b 2069 2a73 7263 302d 3e6e 625b 315d   + i*src0->nb[1]
-00053390: 2929 3b0a 2020 2020 7d0a 7d0a 0a0a 7374  ));.    }.}...st
-000533a0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-000533b0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
-000533c0: 6574 5f72 6f77 735f 6261 636b 280a 2020  et_rows_back(.  
-000533d0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000533e0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-000533f0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00053400: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00053410: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00053420: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00053430: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00053440: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00053450: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
-00053460: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00053470: 736f 7220 2a20 6f70 7430 2c0a 2020 2020  sor * opt0,.    
-00053480: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00053490: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-000534a0: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-000534b0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-000534c0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000534d0: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
-000534e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000534f0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00053500: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
-00053510: 735f 6261 636b 5f66 3332 5f66 3136 2870  s_back_f32_f16(p
-00053520: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
-00053530: 312c 206f 7074 302c 2064 7374 293b 0a20  1, opt0, dst);. 
-00053540: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00053550: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00053560: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00053570: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00053580: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00053590: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000535a0: 7264 5f67 6574 5f72 6f77 735f 6261 636b  rd_get_rows_back
-000535b0: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-000535c0: 302c 2073 7263 312c 206f 7074 302c 2064  0, src1, opt0, d
-000535d0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-000535e0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000535f0: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00053600: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00053610: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00053620: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00053630: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00053640: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f73  ;.    }..    //s
-00053650: 7461 7469 6320 626f 6f6c 2066 6972 7374  tatic bool first
-00053660: 203d 2074 7275 653b 0a20 2020 202f 2f70   = true;.    //p
-00053670: 7269 6e74 6628 226e 6530 203d 2025 642c  rintf("ne0 = %d,
-00053680: 206e 6531 203d 2025 642c 206e 6532 203d   ne1 = %d, ne2 =
-00053690: 2025 645c 6e22 2c20 6473 742d 3e6e 655b   %d\n", dst->ne[
-000536a0: 305d 2c20 6473 742d 3e6e 655b 315d 2c20  0], dst->ne[1], 
-000536b0: 6473 742d 3e6e 655b 325d 293b 0a20 2020  dst->ne[2]);.   
-000536c0: 202f 2f69 6620 2866 6972 7374 2920 7b0a   //if (first) {.
-000536d0: 2020 2020 2f2f 2020 2020 6669 7273 7420      //    first 
-000536e0: 3d20 6661 6c73 653b 0a20 2020 202f 2f7d  = false;.    //}
-000536f0: 2065 6c73 6520 7b0a 2020 2020 2f2f 2020   else {.    //  
-00053700: 2020 666f 7220 2869 6e74 206b 203d 2030    for (int k = 0
-00053710: 3b20 6b20 3c20 6473 742d 3e6e 655b 315d  ; k < dst->ne[1]
-00053720: 3b20 2b2b 6b29 207b 0a20 2020 202f 2f20  ; ++k) {.    // 
-00053730: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00053740: 6a20 3d20 303b 206a 203c 2064 7374 2d3e  j = 0; j < dst->
-00053750: 6e65 5b30 5d2f 3136 3b20 2b2b 6a29 207b  ne[0]/16; ++j) {
-00053760: 0a20 2020 202f 2f20 2020 2020 2020 2020  .    //         
-00053770: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00053780: 303b 2069 203c 2031 363b 202b 2b69 2920  0; i < 16; ++i) 
-00053790: 7b0a 2020 2020 2f2f 2020 2020 2020 2020  {.    //        
-000537a0: 2020 2020 2020 2020 7072 696e 7466 2822          printf("
-000537b0: 2538 2e34 6620 222c 2028 2866 6c6f 6174  %8.4f ", ((float
-000537c0: 202a 2920 6473 742d 3e64 6174 6129 5b6b   *) dst->data)[k
-000537d0: 2a64 7374 2d3e 6e65 5b30 5d20 2b20 6a2a  *dst->ne[0] + j*
-000537e0: 3136 202b 2069 5d29 3b0a 2020 2020 2f2f  16 + i]);.    //
-000537f0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00053800: 2020 2f2f 2020 2020 2020 2020 2020 2020    //            
-00053810: 7072 696e 7466 2822 5c6e 2229 3b0a 2020  printf("\n");.  
-00053820: 2020 2f2f 2020 2020 2020 2020 7d0a 2020    //        }.  
-00053830: 2020 2f2f 2020 2020 2020 2020 7072 696e    //        prin
-00053840: 7466 2822 5c6e 2229 3b0a 2020 2020 2f2f  tf("\n");.    //
-00053850: 2020 2020 7d0a 2020 2020 2f2f 2020 2020      }.    //    
-00053860: 7072 696e 7466 2822 5c6e 2229 3b0a 2020  printf("\n");.  
-00053870: 2020 2f2f 2020 2020 6578 6974 2830 293b    //    exit(0);
-00053880: 0a20 2020 202f 2f7d 0a7d 0a0a 2f2f 2067  .    //}.}..// g
-00053890: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000538a0: 6172 645f 6469 6167 0a0a 7374 6174 6963  ard_diag..static
-000538b0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000538c0: 7465 5f66 6f72 7761 7264 5f64 6961 675f  te_forward_diag_
-000538d0: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-000538e0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000538f0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00053900: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00053910: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00053920: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00053930: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00053940: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00053950: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
-00053960: 5345 5254 2870 6172 616d 732d 3e69 7468  SERT(params->ith
-00053970: 203d 3d20 3029 3b0a 0a20 2020 2069 6620   == 0);..    if 
-00053980: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00053990: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-000539a0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-000539b0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000539c0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000539d0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000539e0: 2020 2020 2f2f 2054 4f44 4f3a 2068 616e      // TODO: han
-000539f0: 646c 6520 7472 616e 7370 6f73 6564 2f70  dle transposed/p
-00053a00: 6572 6d75 7465 6420 6d61 7472 6963 6573  ermuted matrices
-00053a10: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00053a20: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
-00053a30: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00053a40: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-00053a50: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-00053a60: 696e 7420 6e65 3032 203d 2073 7263 302d  int ne02 = src0-
-00053a70: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-00053a80: 7420 696e 7420 6e65 3033 203d 2073 7263  t int ne03 = src
-00053a90: 302d 3e6e 655b 335d 3b0a 2020 2020 636f  0->ne[3];.    co
-00053aa0: 6e73 7420 696e 7420 6e65 3020 3d20 6473  nst int ne0 = ds
-00053ab0: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
-00053ac0: 6e73 7420 696e 7420 6e65 3120 3d20 6473  nst int ne1 = ds
-00053ad0: 742d 3e6e 655b 315d 3b0a 2020 2020 636f  t->ne[1];.    co
-00053ae0: 6e73 7420 696e 7420 6e65 3220 3d20 6473  nst int ne2 = ds
-00053af0: 742d 3e6e 655b 325d 3b0a 2020 2020 636f  t->ne[2];.    co
-00053b00: 6e73 7420 696e 7420 6e65 3320 3d20 6473  nst int ne3 = ds
-00053b10: 742d 3e6e 655b 335d 3b0a 2020 2020 4747  t->ne[3];.    GG
-00053b20: 4d4c 5f41 5353 4552 5428 6e65 3030 203d  ML_ASSERT(ne00 =
-00053b30: 3d20 6e65 3029 3b0a 2020 2020 4747 4d4c  = ne0);.    GGML
-00053b40: 5f41 5353 4552 5428 6e65 3030 203d 3d20  _ASSERT(ne00 == 
-00053b50: 6e65 3129 3b0a 2020 2020 4747 4d4c 5f41  ne1);.    GGML_A
-00053b60: 5353 4552 5428 6e65 3031 203d 3d20 3129  SSERT(ne01 == 1)
-00053b70: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00053b80: 5428 6e65 3032 203d 3d20 6e65 3229 3b0a  T(ne02 == ne2);.
-00053b90: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00053ba0: 6e65 3033 203d 3d20 6e65 3329 3b0a 0a20  ne03 == ne3);.. 
-00053bb0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-00053bc0: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
-00053bd0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00053be0: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
-00053bf0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00053c00: 6e74 206e 6230 3220 3d20 7372 6330 2d3e  nt nb02 = src0->
-00053c10: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
-00053c20: 2069 6e74 206e 6230 3320 3d20 7372 6330   int nb03 = src0
-00053c30: 2d3e 6e62 5b33 5d3b 0a20 2020 2063 6f6e  ->nb[3];.    con
-00053c40: 7374 2069 6e74 206e 6230 203d 2064 7374  st int nb0 = dst
-00053c50: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-00053c60: 7374 2069 6e74 206e 6231 203d 2064 7374  st int nb1 = dst
-00053c70: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-00053c80: 7374 2069 6e74 206e 6232 203d 2064 7374  st int nb2 = dst
-00053c90: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
-00053ca0: 7374 2069 6e74 206e 6233 203d 2064 7374  st int nb3 = dst
-00053cb0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 4747  ->nb[3];..    GG
-00053cc0: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-00053cd0: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00053ce0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00053cf0: 5428 6e62 3020 203d 3d20 7369 7a65 6f66  T(nb0  == sizeof
-00053d00: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-00053d10: 6f72 2028 696e 7420 6933 203d 2030 3b20  or (int i3 = 0; 
-00053d20: 6933 203c 206e 6533 3b20 6933 2b2b 2920  i3 < ne3; i3++) 
-00053d30: 7b0a 2020 2020 2020 2020 666f 7220 2869  {.        for (i
-00053d40: 6e74 2069 3220 3d20 303b 2069 3220 3c20  nt i2 = 0; i2 < 
-00053d50: 6e65 323b 2069 322b 2b29 207b 0a20 2020  ne2; i2++) {.   
-00053d60: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00053d70: 7420 6931 203d 2030 3b20 6931 203c 206e  t i1 = 0; i1 < n
-00053d80: 6531 3b20 6931 2b2b 2920 7b0a 2020 2020  e1; i1++) {.    
-00053d90: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00053da0: 7420 2a20 6420 3d20 2866 6c6f 6174 202a  t * d = (float *
-00053db0: 2928 2863 6861 7220 2a29 2020 6473 742d  )((char *)  dst-
-00053dc0: 3e64 6174 6120 2b20 6933 2a6e 6233 2020  >data + i3*nb3  
-00053dd0: 2b20 6932 2a6e 6232 202b 2069 312a 6e62  + i2*nb2 + i1*nb
-00053de0: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-00053df0: 2020 2020 666c 6f61 7420 2a20 7320 3d20      float * s = 
-00053e00: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-00053e10: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00053e20: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-00053e30: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
-00053e40: 2020 2020 666f 7220 2869 6e74 2069 3020      for (int i0 
-00053e50: 3d20 303b 2069 3020 3c20 6931 3b20 6930  = 0; i0 < i1; i0
-00053e60: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00053e70: 2020 2020 2020 2020 2020 645b 6930 5d20            d[i0] 
-00053e80: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-00053e90: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00053ea0: 2020 2020 2020 2064 5b69 315d 203d 2073         d[i1] = s
-00053eb0: 5b69 315d 3b0a 2020 2020 2020 2020 2020  [i1];.          
-00053ec0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00053ed0: 3020 3d20 6931 2b31 3b20 6930 203c 206e  0 = i1+1; i0 < n
-00053ee0: 6530 3b20 6930 2b2b 2920 7b0a 2020 2020  e0; i0++) {.    
+00050fd0: 202b 2069 6d33 2a6e 6233 2020 3c3d 2067   + im3*nb3  <= g
+00050fe0: 676d 6c5f 6e62 7974 6573 2864 7374 2929  gml_nbytes(dst))
+00050ff0: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00051000: 5254 286e 6231 3020 3d3d 2073 697a 656f  RT(nb10 == sizeo
+00051010: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00051020: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
+00051030: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00051040: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
+00051050: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
+00051060: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
+00051070: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
+00051080: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
+00051090: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
+000510a0: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
+000510b0: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
+000510c0: 2020 2020 666f 7220 2869 6e74 2069 7220      for (int ir 
+000510d0: 3d20 6972 303b 2069 7220 3c20 6972 313b  = ir0; ir < ir1;
+000510e0: 202b 2b69 7229 207b 0a20 2020 2020 2020   ++ir) {.       
+000510f0: 202f 2f20 7372 6330 2061 6e64 2064 7374   // src0 and dst
+00051100: 2061 7265 2076 6965 7765 6420 7769 7468   are viewed with
+00051110: 2073 6861 7065 206f 6620 7372 6331 2061   shape of src1 a
+00051120: 6e64 206f 6666 7365 740a 2020 2020 2020  nd offset.      
+00051130: 2020 2f2f 203d 3e20 7361 6d65 2069 6e64    // => same ind
+00051140: 6963 6573 0a20 2020 2020 2020 2063 6f6e  ices.        con
+00051150: 7374 2069 6e74 2069 3320 3d20 6972 2f28  st int i3 = ir/(
+00051160: 6e65 3132 2a6e 6531 3129 3b0a 2020 2020  ne12*ne11);.    
+00051170: 2020 2020 636f 6e73 7420 696e 7420 6932      const int i2
+00051180: 203d 2028 6972 202d 2069 332a 6e65 3132   = (ir - i3*ne12
+00051190: 2a6e 6531 3129 2f6e 6531 313b 0a20 2020  *ne11)/ne11;.   
+000511a0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+000511b0: 3120 3d20 2869 7220 2d20 6933 2a6e 6531  1 = (ir - i3*ne1
+000511c0: 322a 6e65 3131 202d 2069 322a 6e65 3131  2*ne11 - i2*ne11
+000511d0: 293b 0a0a 2020 2020 2020 2020 6767 6d6c  );..        ggml
+000511e0: 5f76 6563 5f63 7079 5f66 3332 286e 632c  _vec_cpy_f32(nc,
+000511f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051200: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00051210: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+00051220: 2b20 6933 2a6e 6233 2020 2b20 6932 2a6e  + i3*nb3  + i2*n
+00051230: 6232 2020 2b20 6931 2a6e 6231 2020 2b20  b2  + i1*nb1  + 
+00051240: 6f66 6673 6574 292c 0a20 2020 2020 2020  offset),.       
+00051250: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+00051260: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
+00051270: 312d 3e64 6174 6120 2b20 6933 2a6e 6231  1->data + i3*nb1
+00051280: 3320 2b20 6932 2a6e 6231 3220 2b20 6931  3 + i2*nb12 + i1
+00051290: 2a6e 6231 3129 293b 0a20 2020 207d 0a7d  *nb11));.    }.}
+000512a0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+000512b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000512c0: 7264 5f73 6574 280a 2020 2020 2020 2020  rd_set(.        
+000512d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000512e0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+000512f0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00051300: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00051310: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00051320: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+00051330: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00051340: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+00051350: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00051360: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00051370: 6f70 7430 2c0a 2020 2020 2020 2020 7374  opt0,.        st
+00051380: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00051390: 202a 2064 7374 2920 7b0a 0a20 2020 2073   * dst) {..    s
+000513a0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+000513b0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+000513c0: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+000513d0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000513e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000513f0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00051400: 6172 645f 7365 745f 6633 3228 7061 7261  ard_set_f32(para
+00051410: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+00051420: 6f70 7430 2c20 6473 7429 3b0a 2020 2020  opt0, dst);.    
+00051430: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00051440: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00051450: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
+00051460: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00051470: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
+00051480: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00051490: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
+000514a0: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
+000514b0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+000514c0: 2047 474d 4c5f 5459 5045 5f51 355f 313a   GGML_TYPE_Q5_1:
+000514d0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000514e0: 4d4c 5f54 5950 455f 5138 5f30 3a0a 2020  ML_TYPE_Q8_0:.  
+000514f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00051500: 5459 5045 5f51 385f 313a 0a20 2020 2020  TYPE_Q8_1:.     
+00051510: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00051520: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00051530: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00051540: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00051550: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00051560: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00051570: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00051580: 6172 645f 6370 790a 0a73 7461 7469 6320  ard_cpy..static 
+00051590: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+000515a0: 655f 666f 7277 6172 645f 6370 7928 0a20  e_forward_cpy(. 
+000515b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000515c0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000515d0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000515e0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+000515f0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00051600: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00051610: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00051620: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00051630: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00051640: 666f 7277 6172 645f 6475 7028 7061 7261  forward_dup(para
+00051650: 6d73 2c20 7372 6330 2c20 6473 7429 3b0a  ms, src0, dst);.
+00051660: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00051670: 7465 5f66 6f72 7761 7264 5f63 6f6e 740a  te_forward_cont.
+00051680: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00051690: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000516a0: 645f 636f 6e74 280a 2020 2020 2020 2020  d_cont(.        
+000516b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000516c0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+000516d0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+000516e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000516f0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00051700: 6330 2c0a 2020 2020 2020 2020 7374 7275  c0,.        stru
+00051710: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00051720: 2064 7374 2920 7b0a 2020 2020 6767 6d6c   dst) {.    ggml
+00051730: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00051740: 5f64 7570 2870 6172 616d 732c 2073 7263  _dup(params, src
+00051750: 302c 2064 7374 293b 0a7d 0a0a 2f2f 2067  0, dst);.}..// g
+00051760: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00051770: 6172 645f 7265 7368 6170 650a 0a73 7461  ard_reshape..sta
+00051780: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00051790: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
+000517a0: 7368 6170 6528 0a20 2020 2020 2020 2063  shape(.        c
+000517b0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000517c0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+000517d0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+000517e0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000517f0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00051800: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00051810: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00051820: 6473 7429 207b 0a20 2020 202f 2f20 4e4f  dst) {.    // NO
+00051830: 500a 2020 2020 554e 5553 4544 2870 6172  P.    UNUSED(par
+00051840: 616d 7329 3b0a 2020 2020 554e 5553 4544  ams);.    UNUSED
+00051850: 2873 7263 3029 3b0a 2020 2020 554e 5553  (src0);.    UNUS
+00051860: 4544 2864 7374 293b 0a7d 0a0a 2f2f 2067  ED(dst);.}..// g
+00051870: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00051880: 6172 645f 7669 6577 0a0a 7374 6174 6963  ard_view..static
+00051890: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+000518a0: 7465 5f66 6f72 7761 7264 5f76 6965 7728  te_forward_view(
+000518b0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000518c0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+000518d0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+000518e0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+000518f0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00051900: 6e73 6f72 202a 2073 7263 3029 207b 0a20  nsor * src0) {. 
+00051910: 2020 202f 2f20 4e4f 500a 2020 2020 554e     // NOP.    UN
+00051920: 5553 4544 2870 6172 616d 7329 3b0a 2020  USED(params);.  
+00051930: 2020 554e 5553 4544 2873 7263 3029 3b0a    UNUSED(src0);.
+00051940: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00051950: 7465 5f66 6f72 7761 7264 5f70 6572 6d75  te_forward_permu
+00051960: 7465 0a0a 7374 6174 6963 2076 6f69 6420  te..static void 
+00051970: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00051980: 7761 7264 5f70 6572 6d75 7465 280a 2020  ward_permute(.  
+00051990: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000519a0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000519b0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000519c0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000519d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000519e0: 7220 2a20 7372 6330 2920 7b0a 2020 2020  r * src0) {.    
+000519f0: 2f2f 204e 4f50 0a20 2020 2055 4e55 5345  // NOP.    UNUSE
+00051a00: 4428 7061 7261 6d73 293b 0a20 2020 2055  D(params);.    U
+00051a10: 4e55 5345 4428 7372 6330 293b 0a7d 0a0a  NUSED(src0);.}..
+00051a20: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
+00051a30: 666f 7277 6172 645f 7472 616e 7370 6f73  forward_transpos
+00051a40: 650a 0a73 7461 7469 6320 766f 6964 2067  e..static void g
+00051a50: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00051a60: 6172 645f 7472 616e 7370 6f73 6528 0a20  ard_transpose(. 
+00051a70: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00051a80: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00051a90: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00051aa0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00051ab0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00051ac0: 6f72 202a 2073 7263 3029 207b 0a20 2020  or * src0) {.   
+00051ad0: 202f 2f20 4e4f 500a 2020 2020 554e 5553   // NOP.    UNUS
+00051ae0: 4544 2870 6172 616d 7329 3b0a 2020 2020  ED(params);.    
+00051af0: 554e 5553 4544 2873 7263 3029 3b0a 7d0a  UNUSED(src0);.}.
+00051b00: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+00051b10: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
+00051b20: 730a 0a73 7461 7469 6320 766f 6964 2067  s..static void g
+00051b30: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00051b40: 6172 645f 6765 745f 726f 7773 5f71 280a  ard_get_rows_q(.
+00051b50: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00051b60: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00051b70: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00051b80: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00051b90: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00051ba0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00051bb0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00051bc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00051bd0: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
+00051be0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00051bf0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00051c00: 2020 2061 7373 6572 7428 7061 7261 6d73     assert(params
+00051c10: 2d3e 6974 6820 3d3d 2030 293b 0a0a 2020  ->ith == 0);..  
+00051c20: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00051c30: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00051c40: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+00051c50: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00051c60: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+00051c70: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+00051c80: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+00051c90: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
+00051ca0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00051cb0: 6e74 206e 7220 3d20 6767 6d6c 5f6e 656c  nt nr = ggml_nel
+00051cc0: 656d 656e 7473 2873 7263 3129 3b0a 2020  ements(src1);.  
+00051cd0: 2020 636f 6e73 7420 656e 756d 2067 676d    const enum ggm
+00051ce0: 6c5f 7479 7065 2074 7970 6520 3d20 7372  l_type type = sr
+00051cf0: 6330 2d3e 7479 7065 3b0a 2020 2020 6465  c0->type;.    de
+00051d00: 7175 616e 7469 7a65 5f72 6f77 5f71 5f74  quantize_row_q_t
+00051d10: 2063 6f6e 7374 2064 6571 7561 6e74 697a   const dequantiz
+00051d20: 655f 726f 775f 7120 3d20 7175 616e 7469  e_row_q = quanti
+00051d30: 7a65 5f66 6e73 5b74 7970 655d 2e64 6571  ze_fns[type].deq
+00051d40: 7561 6e74 697a 655f 726f 775f 713b 0a0a  uantize_row_q;..
+00051d50: 2020 2020 6173 7365 7274 2820 6473 742d      assert( dst-
+00051d60: 3e6e 655b 305d 203d 3d20 6e63 293b 0a20  >ne[0] == nc);. 
+00051d70: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
+00051d80: 6e65 5b31 5d20 3d3d 206e 7229 3b0a 2020  ne[1] == nr);.  
+00051d90: 2020 6173 7365 7274 2873 7263 302d 3e6e    assert(src0->n
+00051da0: 625b 305d 203d 3d20 4747 4d4c 5f54 5950  b[0] == GGML_TYP
+00051db0: 455f 5349 5a45 5b74 7970 655d 293b 0a0a  E_SIZE[type]);..
+00051dc0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00051dd0: 2030 3b20 6920 3c20 6e72 3b20 2b2b 6929   0; i < nr; ++i)
+00051de0: 207b 0a20 2020 2020 2020 2063 6f6e 7374   {.        const
+00051df0: 2069 6e74 2072 203d 2028 2869 6e74 3332   int r = ((int32
+00051e00: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+00051e10: 295b 695d 3b0a 0a20 2020 2020 2020 2064  )[i];..        d
+00051e20: 6571 7561 6e74 697a 655f 726f 775f 7128  equantize_row_q(
+00051e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051e40: 2028 636f 6e73 7420 766f 6964 202a 2920   (const void *) 
+00051e50: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00051e60: 6461 7461 202b 2072 2a73 7263 302d 3e6e  data + r*src0->n
+00051e70: 625b 315d 292c 0a20 2020 2020 2020 2020  b[1]),.         
+00051e80: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+00051e90: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00051ea0: 2064 7374 2d3e 6461 7461 202b 2069 2a64   dst->data + i*d
+00051eb0: 7374 2d3e 6e62 5b31 5d29 2c20 6e63 293b  st->nb[1]), nc);
+00051ec0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00051ed0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00051ee0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+00051ef0: 6f77 735f 6631 3628 0a20 2020 2020 2020  ows_f16(.       
+00051f00: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00051f10: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00051f20: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00051f30: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00051f40: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00051f50: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+00051f60: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00051f70: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+00051f80: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00051f90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00051fa0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+00051fb0: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
+00051fc0: 3d20 3029 3b0a 0a20 2020 2069 6620 2870  = 0);..    if (p
+00051fd0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+00051fe0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+00051ff0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+00052000: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+00052010: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+00052020: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+00052030: 2020 636f 6e73 7420 696e 7420 6e63 203d    const int nc =
+00052040: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
+00052050: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
+00052060: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
+00052070: 7372 6331 293b 0a0a 2020 2020 6173 7365  src1);..    asse
+00052080: 7274 2820 6473 742d 3e6e 655b 305d 203d  rt( dst->ne[0] =
+00052090: 3d20 6e63 293b 0a20 2020 2061 7373 6572  = nc);.    asser
+000520a0: 7428 2064 7374 2d3e 6e65 5b31 5d20 3d3d  t( dst->ne[1] ==
+000520b0: 206e 7229 3b0a 2020 2020 6173 7365 7274   nr);.    assert
+000520c0: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
+000520d0: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
+000520e0: 5f74 2929 3b0a 0a20 2020 2066 6f72 2028  _t));..    for (
+000520f0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00052100: 723b 202b 2b69 2920 7b0a 2020 2020 2020  r; ++i) {.      
+00052110: 2020 636f 6e73 7420 696e 7420 7220 3d20    const int r = 
+00052120: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+00052130: 312d 3e64 6174 6129 5b69 5d3b 0a0a 2020  1->data)[i];..  
+00052140: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00052150: 203d 2030 3b20 6a20 3c20 6e63 3b20 2b2b   = 0; j < nc; ++
+00052160: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+00052170: 2067 676d 6c5f 6670 3136 5f74 2076 203d   ggml_fp16_t v =
+00052180: 2028 2867 676d 6c5f 6670 3136 5f74 202a   ((ggml_fp16_t *
+00052190: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+000521a0: 2d3e 6461 7461 202b 2072 2a73 7263 302d  ->data + r*src0-
+000521b0: 3e6e 625b 315d 2929 5b6a 5d3b 0a20 2020  >nb[1]))[j];.   
+000521c0: 2020 2020 2020 2020 2028 2866 6c6f 6174           ((float
+000521d0: 202a 2920 2828 6368 6172 202a 2920 2064   *) ((char *)  d
+000521e0: 7374 2d3e 6461 7461 202b 2069 2a64 7374  st->data + i*dst
+000521f0: 2d3e 6e62 5b31 5d29 295b 6a5d 203d 2047  ->nb[1]))[j] = G
+00052200: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+00052210: 2876 293b 0a20 2020 2020 2020 207d 0a20  (v);.        }. 
+00052220: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+00052230: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00052240: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
+00052250: 735f 6633 3228 0a20 2020 2020 2020 2063  s_f32(.        c
+00052260: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00052270: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+00052280: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+00052290: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000522a0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+000522b0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+000522c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000522d0: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+000522e0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+000522f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00052300: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
+00052310: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
+00052320: 3029 3b0a 0a20 2020 2069 6620 2870 6172  0);..    if (par
+00052330: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00052340: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
+00052350: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+00052360: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
+00052370: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
+00052380: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+00052390: 636f 6e73 7420 696e 7420 6e63 203d 2073  const int nc = s
+000523a0: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
+000523b0: 636f 6e73 7420 696e 7420 6e72 203d 2067  const int nr = g
+000523c0: 676d 6c5f 6e65 6c65 6d65 6e74 7328 7372  gml_nelements(sr
+000523d0: 6331 293b 0a0a 2020 2020 6173 7365 7274  c1);..    assert
+000523e0: 2820 6473 742d 3e6e 655b 305d 203d 3d20  ( dst->ne[0] == 
+000523f0: 6e63 293b 0a20 2020 2061 7373 6572 7428  nc);.    assert(
+00052400: 2064 7374 2d3e 6e65 5b31 5d20 3d3d 206e   dst->ne[1] == n
+00052410: 7229 3b0a 2020 2020 6173 7365 7274 2873  r);.    assert(s
+00052420: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
+00052430: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
+00052440: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00052450: 303b 2069 203c 206e 723b 202b 2b69 2920  0; i < nr; ++i) 
+00052460: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
+00052470: 696e 7420 7220 3d20 2828 696e 7433 325f  int r = ((int32_
+00052480: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
+00052490: 5b69 5d3b 0a0a 2020 2020 2020 2020 6767  [i];..        gg
+000524a0: 6d6c 5f76 6563 5f63 7079 5f66 3332 286e  ml_vec_cpy_f32(n
+000524b0: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+000524c0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+000524d0: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
+000524e0: 6120 2b20 692a 6473 742d 3e6e 625b 315d  a + i*dst->nb[1]
+000524f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00052500: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00052510: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00052520: 6120 2b20 722a 7372 6330 2d3e 6e62 5b31  a + r*src0->nb[1
+00052530: 5d29 293b 0a20 2020 207d 0a7d 0a0a 7374  ]));.    }.}..st
+00052540: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00052550: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
+00052560: 6574 5f72 6f77 7328 0a20 2020 2020 2020  et_rows(.       
+00052570: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00052580: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00052590: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+000525a0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000525b0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+000525c0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+000525d0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000525e0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+000525f0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00052600: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00052610: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+00052620: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+00052630: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00052640: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
+00052650: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00052660: 5134 5f31 3a0a 2020 2020 2020 2020 6361  Q4_1:.        ca
+00052670: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
+00052680: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+00052690: 4747 4d4c 5f54 5950 455f 5135 5f31 3a0a  GGML_TYPE_Q5_1:.
+000526a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000526b0: 4c5f 5459 5045 5f51 385f 303a 0a20 2020  L_TYPE_Q8_0:.   
+000526c0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000526d0: 5950 455f 5138 5f31 3a0a 2020 2020 2020  YPE_Q8_1:.      
+000526e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000526f0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00052700: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
+00052710: 5f72 6f77 735f 7128 7061 7261 6d73 2c20  _rows_q(params, 
+00052720: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00052730: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00052740: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00052750: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
+00052760: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
+00052770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00052780: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00052790: 7277 6172 645f 6765 745f 726f 7773 5f66  rward_get_rows_f
+000527a0: 3136 2870 6172 616d 732c 2073 7263 302c  16(params, src0,
+000527b0: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
+000527c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000527d0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000527e0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
+000527f0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00052800: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00052810: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00052820: 5f67 6574 5f72 6f77 735f 6633 3228 7061  _get_rows_f32(pa
+00052830: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
+00052840: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+00052850: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00052860: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
+00052870: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00052880: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00052890: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+000528a0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000528b0: 6561 6b3b 0a20 2020 207d 0a0a 2020 2020  eak;.    }..    
+000528c0: 2f2f 7374 6174 6963 2062 6f6f 6c20 6669  //static bool fi
+000528d0: 7273 7420 3d20 7472 7565 3b0a 2020 2020  rst = true;.    
+000528e0: 2f2f 7072 696e 7466 2822 6e65 3020 3d20  //printf("ne0 = 
+000528f0: 2564 2c20 6e65 3120 3d20 2564 2c20 6e65  %d, ne1 = %d, ne
+00052900: 3220 3d20 2564 5c6e 222c 2064 7374 2d3e  2 = %d\n", dst->
+00052910: 6e65 5b30 5d2c 2064 7374 2d3e 6e65 5b31  ne[0], dst->ne[1
+00052920: 5d2c 2064 7374 2d3e 6e65 5b32 5d29 3b0a  ], dst->ne[2]);.
+00052930: 2020 2020 2f2f 6966 2028 6669 7273 7429      //if (first)
+00052940: 207b 0a20 2020 202f 2f20 2020 2066 6972   {.    //    fir
+00052950: 7374 203d 2066 616c 7365 3b0a 2020 2020  st = false;.    
+00052960: 2f2f 7d20 656c 7365 207b 0a20 2020 202f  //} else {.    /
+00052970: 2f20 2020 2066 6f72 2028 696e 7420 6b20  /    for (int k 
+00052980: 3d20 303b 206b 203c 2064 7374 2d3e 6e65  = 0; k < dst->ne
+00052990: 5b31 5d3b 202b 2b6b 2920 7b0a 2020 2020  [1]; ++k) {.    
+000529a0: 2f2f 2020 2020 2020 2020 666f 7220 2869  //        for (i
+000529b0: 6e74 206a 203d 2030 3b20 6a20 3c20 6473  nt j = 0; j < ds
+000529c0: 742d 3e6e 655b 305d 2f31 363b 202b 2b6a  t->ne[0]/16; ++j
+000529d0: 2920 7b0a 2020 2020 2f2f 2020 2020 2020  ) {.    //      
+000529e0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+000529f0: 203d 2030 3b20 6920 3c20 3136 3b20 2b2b   = 0; i < 16; ++
+00052a00: 6929 207b 0a20 2020 202f 2f20 2020 2020  i) {.    //     
+00052a10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00052a20: 6628 2225 382e 3466 2022 2c20 2828 666c  f("%8.4f ", ((fl
+00052a30: 6f61 7420 2a29 2064 7374 2d3e 6461 7461  oat *) dst->data
+00052a40: 295b 6b2a 6473 742d 3e6e 655b 305d 202b  )[k*dst->ne[0] +
+00052a50: 206a 2a31 3620 2b20 695d 293b 0a20 2020   j*16 + i]);.   
+00052a60: 202f 2f20 2020 2020 2020 2020 2020 207d   //            }
+00052a70: 0a20 2020 202f 2f20 2020 2020 2020 2020  .    //         
+00052a80: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
+00052a90: 0a20 2020 202f 2f20 2020 2020 2020 207d  .    //        }
+00052aa0: 0a20 2020 202f 2f20 2020 2020 2020 2070  .    //        p
+00052ab0: 7269 6e74 6628 225c 6e22 293b 0a20 2020  rintf("\n");.   
+00052ac0: 202f 2f20 2020 207d 0a20 2020 202f 2f20   //    }.    // 
+00052ad0: 2020 2070 7269 6e74 6628 225c 6e22 293b     printf("\n");
+00052ae0: 0a20 2020 202f 2f20 2020 2065 7869 7428  .    //    exit(
+00052af0: 3029 3b0a 2020 2020 2f2f 7d0a 7d0a 0a2f  0);.    //}.}../
+00052b00: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00052b10: 6f72 7761 7264 5f67 6574 5f72 6f77 735f  orward_get_rows_
+00052b20: 6261 636b 0a0a 7374 6174 6963 2076 6f69  back..static voi
+00052b30: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00052b40: 6f72 7761 7264 5f67 6574 5f72 6f77 735f  orward_get_rows_
+00052b50: 6261 636b 5f66 3332 5f66 3136 280a 2020  back_f32_f16(.  
+00052b60: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00052b70: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00052b80: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00052b90: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00052ba0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00052bb0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00052bc0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00052bd0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00052be0: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
+00052bf0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00052c00: 736f 7220 2a20 6f70 7430 2c0a 2020 2020  sor * opt0,.    
+00052c10: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+00052c20: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00052c30: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
+00052c40: 5353 4552 5428 7061 7261 6d73 2d3e 6974  SSERT(params->it
+00052c50: 6820 3d3d 2030 293b 0a20 2020 2047 474d  h == 0);.    GGM
+00052c60: 4c5f 4153 5345 5254 2867 676d 6c5f 6172  L_ASSERT(ggml_ar
+00052c70: 655f 7361 6d65 5f73 6861 7065 286f 7074  e_same_shape(opt
+00052c80: 302c 2064 7374 2929 3b0a 2020 2020 4747  0, dst));.    GG
+00052c90: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00052ca0: 735f 636f 6e74 6967 756f 7573 286f 7074  s_contiguous(opt
+00052cb0: 3029 293b 0a20 2020 2047 474d 4c5f 4153  0));.    GGML_AS
+00052cc0: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+00052cd0: 7469 6775 6f75 7328 6473 7429 293b 0a0a  tiguous(dst));..
+00052ce0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00052cf0: 5f66 6f72 7761 7264 5f64 7570 5f73 616d  _forward_dup_sam
+00052d00: 655f 636f 6e74 2870 6172 616d 732c 206f  e_cont(params, o
+00052d10: 7074 302c 2064 7374 293b 0a0a 2020 2020  pt0, dst);..    
+00052d20: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00052d30: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+00052d40: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
+00052d50: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00052d60: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+00052d70: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00052d80: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
+00052d90: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
+00052da0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00052db0: 206e 7220 3d20 6767 6d6c 5f6e 656c 656d   nr = ggml_nelem
+00052dc0: 656e 7473 2873 7263 3129 3b0a 0a20 2020  ents(src1);..   
+00052dd0: 2047 474d 4c5f 4153 5345 5254 2820 6473   GGML_ASSERT( ds
+00052de0: 742d 3e6e 655b 305d 203d 3d20 6e63 293b  t->ne[0] == nc);
+00052df0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00052e00: 2873 7263 302d 3e6e 625b 305d 203d 3d20  (src0->nb[0] == 
+00052e10: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
+00052e20: 5f74 2929 3b0a 0a20 2020 2066 6f72 2028  _t));..    for (
+00052e30: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00052e40: 723b 202b 2b69 2920 7b0a 2020 2020 2020  r; ++i) {.      
+00052e50: 2020 636f 6e73 7420 696e 7420 7220 3d20    const int r = 
+00052e60: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+00052e70: 312d 3e64 6174 6129 5b69 5d3b 0a0a 2020  1->data)[i];..  
+00052e80: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00052e90: 203d 2030 3b20 6a20 3c20 6e63 3b20 2b2b   = 0; j < nc; ++
+00052ea0: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+00052eb0: 2067 676d 6c5f 6670 3136 5f74 2076 203d   ggml_fp16_t v =
+00052ec0: 2028 2867 676d 6c5f 6670 3136 5f74 202a   ((ggml_fp16_t *
+00052ed0: 2920 2828 6368 6172 202a 2920 7372 6330  ) ((char *) src0
+00052ee0: 2d3e 6461 7461 202b 2069 2a73 7263 302d  ->data + i*src0-
+00052ef0: 3e6e 625b 315d 2929 5b6a 5d3b 0a20 2020  >nb[1]))[j];.   
+00052f00: 2020 2020 2020 2020 2028 2866 6c6f 6174           ((float
+00052f10: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+00052f20: 742d 3e64 6174 6120 2b20 722a 6473 742d  t->data + r*dst-
+00052f30: 3e6e 625b 315d 2929 5b6a 5d20 2b3d 2047  >nb[1]))[j] += G
+00052f40: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+00052f50: 2876 293b 0a20 2020 2020 2020 207d 0a20  (v);.        }. 
+00052f60: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+00052f70: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00052f80: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
+00052f90: 735f 6261 636b 5f66 3332 280a 2020 2020  s_back_f32(.    
+00052fa0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00052fb0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00052fc0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00052fd0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00052fe0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00052ff0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00053000: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00053010: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+00053020: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00053030: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00053040: 7220 2a20 6f70 7430 2c0a 2020 2020 2020  r * opt0,.      
+00053050: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00053060: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00053070: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+00053080: 4552 5428 7061 7261 6d73 2d3e 6974 6820  ERT(params->ith 
+00053090: 3d3d 2030 293b 0a20 2020 2047 474d 4c5f  == 0);.    GGML_
+000530a0: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
+000530b0: 7361 6d65 5f73 6861 7065 286f 7074 302c  same_shape(opt0,
+000530c0: 2064 7374 2929 3b0a 2020 2020 4747 4d4c   dst));.    GGML
+000530d0: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+000530e0: 636f 6e74 6967 756f 7573 286f 7074 3029  contiguous(opt0)
+000530f0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00053100: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+00053110: 6775 6f75 7328 6473 7429 293b 0a0a 2020  guous(dst));..  
+00053120: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00053130: 6f72 7761 7264 5f64 7570 5f73 616d 655f  orward_dup_same_
+00053140: 636f 6e74 2870 6172 616d 732c 206f 7074  cont(params, opt
+00053150: 302c 2064 7374 293b 0a0a 2020 2020 6966  0, dst);..    if
+00053160: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00053170: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00053180: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00053190: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+000531a0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+000531b0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+000531c0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000531d0: 6320 3d20 7372 6330 2d3e 6e65 5b30 5d3b  c = src0->ne[0];
+000531e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000531f0: 7220 3d20 6767 6d6c 5f6e 656c 656d 656e  r = ggml_nelemen
+00053200: 7473 2873 7263 3129 3b0a 0a20 2020 2047  ts(src1);..    G
+00053210: 474d 4c5f 4153 5345 5254 2820 6473 742d  GML_ASSERT( dst-
+00053220: 3e6e 655b 305d 203d 3d20 6e63 293b 0a20  >ne[0] == nc);. 
+00053230: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+00053240: 7263 302d 3e6e 625b 305d 203d 3d20 7369  rc0->nb[0] == si
+00053250: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
+00053260: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00053270: 303b 2069 203c 206e 723b 202b 2b69 2920  0; i < nr; ++i) 
+00053280: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
+00053290: 696e 7420 7220 3d20 2828 696e 7433 325f  int r = ((int32_
+000532a0: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
+000532b0: 5b69 5d3b 0a0a 2020 2020 2020 2020 6767  [i];..        gg
+000532c0: 6d6c 5f76 6563 5f61 6464 5f66 3332 286e  ml_vec_add_f32(n
+000532d0: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
+000532e0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+000532f0: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
+00053300: 6120 2b20 722a 6473 742d 3e6e 625b 315d  a + r*dst->nb[1]
+00053310: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00053320: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00053330: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
+00053340: 6120 2b20 722a 6473 742d 3e6e 625b 315d  a + r*dst->nb[1]
+00053350: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00053360: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
+00053370: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00053380: 6120 2b20 692a 7372 6330 2d3e 6e62 5b31  a + i*src0->nb[1
+00053390: 5d29 293b 0a20 2020 207d 0a7d 0a0a 0a73  ]));.    }.}...s
+000533a0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+000533b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000533c0: 6765 745f 726f 7773 5f62 6163 6b28 0a20  get_rows_back(. 
+000533d0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000533e0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000533f0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00053400: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00053410: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00053420: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00053430: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00053440: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00053450: 6331 2c0a 2020 2020 2020 2020 636f 6e73  c1,.        cons
+00053460: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00053470: 6e73 6f72 202a 206f 7074 302c 0a20 2020  nsor * opt0,.   
+00053480: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00053490: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+000534a0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
+000534b0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+000534c0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000534d0: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
+000534e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000534f0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00053500: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
+00053510: 7773 5f62 6163 6b5f 6633 325f 6631 3628  ws_back_f32_f16(
+00053520: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
+00053530: 6331 2c20 6f70 7430 2c20 6473 7429 3b0a  c1, opt0, dst);.
+00053540: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00053550: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00053560: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+00053570: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00053580: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00053590: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000535a0: 6172 645f 6765 745f 726f 7773 5f62 6163  ard_get_rows_bac
+000535b0: 6b5f 6633 3228 7061 7261 6d73 2c20 7372  k_f32(params, sr
+000535c0: 6330 2c20 7372 6331 2c20 6f70 7430 2c20  c0, src1, opt0, 
+000535d0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+000535e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000535f0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00053600: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00053610: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00053620: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00053630: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00053640: 6b3b 0a20 2020 207d 0a0a 2020 2020 2f2f  k;.    }..    //
+00053650: 7374 6174 6963 2062 6f6f 6c20 6669 7273  static bool firs
+00053660: 7420 3d20 7472 7565 3b0a 2020 2020 2f2f  t = true;.    //
+00053670: 7072 696e 7466 2822 6e65 3020 3d20 2564  printf("ne0 = %d
+00053680: 2c20 6e65 3120 3d20 2564 2c20 6e65 3220  , ne1 = %d, ne2 
+00053690: 3d20 2564 5c6e 222c 2064 7374 2d3e 6e65  = %d\n", dst->ne
+000536a0: 5b30 5d2c 2064 7374 2d3e 6e65 5b31 5d2c  [0], dst->ne[1],
+000536b0: 2064 7374 2d3e 6e65 5b32 5d29 3b0a 2020   dst->ne[2]);.  
+000536c0: 2020 2f2f 6966 2028 6669 7273 7429 207b    //if (first) {
+000536d0: 0a20 2020 202f 2f20 2020 2066 6972 7374  .    //    first
+000536e0: 203d 2066 616c 7365 3b0a 2020 2020 2f2f   = false;.    //
+000536f0: 7d20 656c 7365 207b 0a20 2020 202f 2f20  } else {.    // 
+00053700: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
+00053710: 303b 206b 203c 2064 7374 2d3e 6e65 5b31  0; k < dst->ne[1
+00053720: 5d3b 202b 2b6b 2920 7b0a 2020 2020 2f2f  ]; ++k) {.    //
+00053730: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00053740: 206a 203d 2030 3b20 6a20 3c20 6473 742d   j = 0; j < dst-
+00053750: 3e6e 655b 305d 2f31 363b 202b 2b6a 2920  >ne[0]/16; ++j) 
+00053760: 7b0a 2020 2020 2f2f 2020 2020 2020 2020  {.    //        
+00053770: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00053780: 2030 3b20 6920 3c20 3136 3b20 2b2b 6929   0; i < 16; ++i)
+00053790: 207b 0a20 2020 202f 2f20 2020 2020 2020   {.    //       
+000537a0: 2020 2020 2020 2020 2070 7269 6e74 6628           printf(
+000537b0: 2225 382e 3466 2022 2c20 2828 666c 6f61  "%8.4f ", ((floa
+000537c0: 7420 2a29 2064 7374 2d3e 6461 7461 295b  t *) dst->data)[
+000537d0: 6b2a 6473 742d 3e6e 655b 305d 202b 206a  k*dst->ne[0] + j
+000537e0: 2a31 3620 2b20 695d 293b 0a20 2020 202f  *16 + i]);.    /
+000537f0: 2f20 2020 2020 2020 2020 2020 207d 0a20  /            }. 
+00053800: 2020 202f 2f20 2020 2020 2020 2020 2020     //           
+00053810: 2070 7269 6e74 6628 225c 6e22 293b 0a20   printf("\n");. 
+00053820: 2020 202f 2f20 2020 2020 2020 207d 0a20     //        }. 
+00053830: 2020 202f 2f20 2020 2020 2020 2070 7269     //        pri
+00053840: 6e74 6628 225c 6e22 293b 0a20 2020 202f  ntf("\n");.    /
+00053850: 2f20 2020 207d 0a20 2020 202f 2f20 2020  /    }.    //   
+00053860: 2070 7269 6e74 6628 225c 6e22 293b 0a20   printf("\n");. 
+00053870: 2020 202f 2f20 2020 2065 7869 7428 3029     //    exit(0)
+00053880: 3b0a 2020 2020 2f2f 7d0a 7d0a 0a2f 2f20  ;.    //}.}..// 
+00053890: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000538a0: 7761 7264 5f64 6961 670a 0a73 7461 7469  ward_diag..stati
+000538b0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+000538c0: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+000538d0: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+000538e0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000538f0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00053900: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00053910: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00053920: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00053930: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00053940: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00053950: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
+00053960: 5353 4552 5428 7061 7261 6d73 2d3e 6974  SSERT(params->it
+00053970: 6820 3d3d 2030 293b 0a0a 2020 2020 6966  h == 0);..    if
+00053980: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00053990: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+000539a0: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+000539b0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+000539c0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+000539d0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+000539e0: 0a20 2020 202f 2f20 544f 444f 3a20 6861  .    // TODO: ha
+000539f0: 6e64 6c65 2074 7261 6e73 706f 7365 642f  ndle transposed/
+00053a00: 7065 726d 7574 6564 206d 6174 7269 6365  permuted matrice
+00053a10: 730a 0a20 2020 2063 6f6e 7374 2069 6e74  s..    const int
+00053a20: 206e 6530 3020 3d20 7372 6330 2d3e 6e65   ne00 = src0->ne
+00053a30: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00053a40: 6e74 206e 6530 3120 3d20 7372 6330 2d3e  nt ne01 = src0->
+00053a50: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00053a60: 2069 6e74 206e 6530 3220 3d20 7372 6330   int ne02 = src0
+00053a70: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+00053a80: 7374 2069 6e74 206e 6530 3320 3d20 7372  st int ne03 = sr
+00053a90: 6330 2d3e 6e65 5b33 5d3b 0a20 2020 2063  c0->ne[3];.    c
+00053aa0: 6f6e 7374 2069 6e74 206e 6530 203d 2064  onst int ne0 = d
+00053ab0: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
+00053ac0: 6f6e 7374 2069 6e74 206e 6531 203d 2064  onst int ne1 = d
+00053ad0: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 2063  st->ne[1];.    c
+00053ae0: 6f6e 7374 2069 6e74 206e 6532 203d 2064  onst int ne2 = d
+00053af0: 7374 2d3e 6e65 5b32 5d3b 0a20 2020 2063  st->ne[2];.    c
+00053b00: 6f6e 7374 2069 6e74 206e 6533 203d 2064  onst int ne3 = d
+00053b10: 7374 2d3e 6e65 5b33 5d3b 0a20 2020 2047  st->ne[3];.    G
+00053b20: 474d 4c5f 4153 5345 5254 286e 6530 3020  GML_ASSERT(ne00 
+00053b30: 3d3d 206e 6530 293b 0a20 2020 2047 474d  == ne0);.    GGM
+00053b40: 4c5f 4153 5345 5254 286e 6530 3020 3d3d  L_ASSERT(ne00 ==
+00053b50: 206e 6531 293b 0a20 2020 2047 474d 4c5f   ne1);.    GGML_
+00053b60: 4153 5345 5254 286e 6530 3120 3d3d 2031  ASSERT(ne01 == 1
+00053b70: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00053b80: 5254 286e 6530 3220 3d3d 206e 6532 293b  RT(ne02 == ne2);
+00053b90: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00053ba0: 286e 6530 3320 3d3d 206e 6533 293b 0a0a  (ne03 == ne3);..
+00053bb0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+00053bc0: 3030 203d 2073 7263 302d 3e6e 625b 305d  00 = src0->nb[0]
+00053bd0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00053be0: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+00053bf0: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+00053c00: 696e 7420 6e62 3032 203d 2073 7263 302d  int nb02 = src0-
+00053c10: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+00053c20: 7420 696e 7420 6e62 3033 203d 2073 7263  t int nb03 = src
+00053c30: 302d 3e6e 625b 335d 3b0a 2020 2020 636f  0->nb[3];.    co
+00053c40: 6e73 7420 696e 7420 6e62 3020 3d20 6473  nst int nb0 = ds
+00053c50: 742d 3e6e 625b 305d 3b0a 2020 2020 636f  t->nb[0];.    co
+00053c60: 6e73 7420 696e 7420 6e62 3120 3d20 6473  nst int nb1 = ds
+00053c70: 742d 3e6e 625b 315d 3b0a 2020 2020 636f  t->nb[1];.    co
+00053c80: 6e73 7420 696e 7420 6e62 3220 3d20 6473  nst int nb2 = ds
+00053c90: 742d 3e6e 625b 325d 3b0a 2020 2020 636f  t->nb[2];.    co
+00053ca0: 6e73 7420 696e 7420 6e62 3320 3d20 6473  nst int nb3 = ds
+00053cb0: 742d 3e6e 625b 335d 3b0a 0a20 2020 2047  t->nb[3];..    G
+00053cc0: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+00053cd0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00053ce0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00053cf0: 5254 286e 6230 2020 3d3d 2073 697a 656f  RT(nb0  == sizeo
+00053d00: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00053d10: 666f 7220 2869 6e74 2069 3320 3d20 303b  for (int i3 = 0;
+00053d20: 2069 3320 3c20 6e65 333b 2069 332b 2b29   i3 < ne3; i3++)
+00053d30: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
+00053d40: 696e 7420 6932 203d 2030 3b20 6932 203c  int i2 = 0; i2 <
+00053d50: 206e 6532 3b20 6932 2b2b 2920 7b0a 2020   ne2; i2++) {.  
+00053d60: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00053d70: 6e74 2069 3120 3d20 303b 2069 3120 3c20  nt i1 = 0; i1 < 
+00053d80: 6e65 313b 2069 312b 2b29 207b 0a20 2020  ne1; i1++) {.   
+00053d90: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+00053da0: 6174 202a 2064 203d 2028 666c 6f61 7420  at * d = (float 
+00053db0: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
+00053dc0: 2d3e 6461 7461 202b 2069 332a 6e62 3320  ->data + i3*nb3 
+00053dd0: 202b 2069 322a 6e62 3220 2b20 6931 2a6e   + i2*nb2 + i1*n
+00053de0: 6231 293b 0a20 2020 2020 2020 2020 2020  b1);.           
+00053df0: 2020 2020 2066 6c6f 6174 202a 2073 203d       float * s =
+00053e00: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+00053e10: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00053e20: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
+00053e30: 3032 293b 0a20 2020 2020 2020 2020 2020  02);.           
+00053e40: 2020 2020 2066 6f72 2028 696e 7420 6930       for (int i0
+00053e50: 203d 2030 3b20 6930 203c 2069 313b 2069   = 0; i0 < i1; i
+00053e60: 302b 2b29 207b 0a20 2020 2020 2020 2020  0++) {.         
+00053e70: 2020 2020 2020 2020 2020 2064 5b69 305d             d[i0]
+00053e80: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
+00053e90: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00053ea0: 2020 2020 2020 2020 645b 6931 5d20 3d20          d[i1] = 
+00053eb0: 735b 6931 5d3b 0a20 2020 2020 2020 2020  s[i1];.         
+00053ec0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00053ed0: 6930 203d 2069 312b 313b 2069 3020 3c20  i0 = i1+1; i0 < 
+00053ee0: 6e65 303b 2069 302b 2b29 207b 0a20 2020  ne0; i0++) {.   
 00053ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053f00: 645b 6930 5d20 3d20 303b 0a20 2020 2020  d[i0] = 0;.     
-00053f10: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00053f20: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00053f30: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-00053f40: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00053f50: 6f6d 7075 7465 5f66 6f72 7761 7264 5f64  ompute_forward_d
-00053f60: 6961 6728 0a20 2020 2020 2020 2063 6f6e  iag(.        con
-00053f70: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00053f80: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-00053f90: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00053fa0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00053fb0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00053fc0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00053fd0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00053fe0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00053ff0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00054000: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00054010: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-00054020: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00054030: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00054040: 6d70 7574 655f 666f 7277 6172 645f 6469  mpute_forward_di
-00054050: 6167 5f66 3332 2870 6172 616d 732c 2073  ag_f32(params, s
-00054060: 7263 302c 2064 7374 293b 0a20 2020 2020  rc0, dst);.     
-00054070: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00054080: 2020 2020 2020 2020 6465 6661 756c 743a          default:
-00054090: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000540a0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-000540b0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000540c0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000540d0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-000540e0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-000540f0: 5f66 6f72 7761 7264 5f64 6961 675f 6d61  _forward_diag_ma
-00054100: 736b 5f69 6e66 0a0a 7374 6174 6963 2076  sk_inf..static v
-00054110: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00054120: 5f66 6f72 7761 7264 5f64 6961 675f 6d61  _forward_diag_ma
-00054130: 736b 5f66 3332 280a 2020 2020 2020 2020  sk_f32(.        
-00054140: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00054150: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00054160: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00054170: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00054180: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00054190: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-000541a0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000541b0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-000541c0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000541d0: 5f74 656e 736f 7220 2a20 6473 742c 0a20  _tensor * dst,. 
-000541e0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-000541f0: 6174 2076 616c 7565 2920 7b0a 2020 2020  at value) {.    
-00054200: 6173 7365 7274 2873 7263 312d 3e74 7970  assert(src1->typ
-00054210: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
-00054220: 3332 293b 0a20 2020 2061 7373 6572 7428  32);.    assert(
-00054230: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-00054240: 7263 3129 203d 3d20 3229 3b0a 0a20 2020  rc1) == 2);..   
-00054250: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-00054260: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-00054270: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-00054280: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-00054290: 2020 2020 636f 6e73 7420 696e 7420 206e      const int  n
-000542a0: 5f70 6173 7420 203d 2020 2020 2020 2028  _past  =       (
-000542b0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-000542c0: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
-000542d0: 636f 6e73 7420 626f 6f6c 2069 6e70 6c61  const bool inpla
-000542e0: 6365 203d 2028 626f 6f6c 2928 2869 6e74  ce = (bool)((int
-000542f0: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-00054300: 7461 295b 315d 3b0a 0a20 2020 2061 7373  ta)[1];..    ass
-00054310: 6572 7428 6e5f 7061 7374 203e 3d20 3029  ert(n_past >= 0)
-00054320: 3b0a 0a20 2020 2069 6620 2821 696e 706c  ;..    if (!inpl
-00054330: 6163 6520 2626 2028 7061 7261 6d73 2d3e  ace && (params->
-00054340: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00054350: 4b5f 494e 4954 2929 207b 0a20 2020 2020  K_INIT)) {.     
-00054360: 2020 202f 2f20 6d65 6d63 7079 206e 6565     // memcpy nee
-00054370: 6473 2074 6f20 6265 2073 796e 6368 726f  ds to be synchro
-00054380: 6e69 7a65 6420 6163 726f 7373 2074 6872  nized across thr
-00054390: 6561 6473 2074 6f20 6176 6f69 6420 7261  eads to avoid ra
-000543a0: 6365 2063 6f6e 6469 7469 6f6e 732e 0a20  ce conditions.. 
-000543b0: 2020 2020 2020 202f 2f20 3d3e 2064 6f20         // => do 
-000543c0: 6974 2069 6e20 494e 4954 2070 6861 7365  it in INIT phase
-000543d0: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
-000543e0: 5345 5254 2867 676d 6c5f 6e65 6c65 6d65  SERT(ggml_neleme
-000543f0: 6e74 7328 6473 7429 203d 3d20 6767 6d6c  nts(dst) == ggml
-00054400: 5f6e 656c 656d 656e 7473 2873 7263 3029  _nelements(src0)
-00054410: 293b 0a20 2020 2020 2020 2047 474d 4c5f  );.        GGML_
-00054420: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
-00054430: 6f6e 7469 6775 6f75 7328 6473 7429 2026  ontiguous(dst) &
-00054440: 2620 6767 6d6c 5f69 735f 636f 6e74 6967  & ggml_is_contig
-00054450: 756f 7573 2873 7263 3029 293b 0a20 2020  uous(src0));.   
-00054460: 2020 2020 206d 656d 6370 7928 0a20 2020       memcpy(.   
-00054470: 2020 2020 2020 2020 2028 2863 6861 7220           ((char 
-00054480: 2a29 2020 6473 742d 3e64 6174 6129 2c0a  *)  dst->data),.
-00054490: 2020 2020 2020 2020 2020 2020 2828 6368              ((ch
-000544a0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-000544b0: 292c 0a20 2020 2020 2020 2020 2020 2067  ),.            g
-000544c0: 676d 6c5f 6e62 7974 6573 2864 7374 2929  gml_nbytes(dst))
-000544d0: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
-000544e0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-000544f0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00054500: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00054510: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00054520: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00054530: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00054540: 2020 2020 2f2f 2054 4f44 4f3a 2068 616e      // TODO: han
-00054550: 646c 6520 7472 616e 7370 6f73 6564 2f70  dle transposed/p
-00054560: 6572 6d75 7465 6420 6d61 7472 6963 6573  ermuted matrices
-00054570: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00054580: 6e20 203d 2067 676d 6c5f 6e72 6f77 7328  n  = ggml_nrows(
-00054590: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
-000545a0: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
-000545b0: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
-000545c0: 2069 6e74 206e 7220 3d20 7372 6330 2d3e   int nr = src0->
-000545d0: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-000545e0: 2069 6e74 206e 7a20 3d20 6e2f 6e72 3b0a   int nz = n/nr;.
-000545f0: 0a20 2020 2061 7373 6572 7428 2064 7374  .    assert( dst
-00054600: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-00054610: 6628 666c 6f61 7429 293b 0a20 2020 2061  f(float));.    a
-00054620: 7373 6572 7428 7372 6330 2d3e 6e62 5b30  ssert(src0->nb[0
-00054630: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
-00054640: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
-00054650: 6e74 206b 203d 2030 3b20 6b20 3c20 6e7a  nt k = 0; k < nz
-00054660: 3b20 6b2b 2b29 207b 0a20 2020 2020 2020  ; k++) {.       
-00054670: 2066 6f72 2028 696e 7420 6a20 3d20 6974   for (int j = it
-00054680: 683b 206a 203c 206e 723b 206a 202b 3d20  h; j < nr; j += 
-00054690: 6e74 6829 207b 0a20 2020 2020 2020 2020  nth) {.         
-000546a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000546b0: 6e5f 7061 7374 3b20 6920 3c20 6e63 3b20  n_past; i < nc; 
-000546c0: 692b 2b29 207b 0a20 2020 2020 2020 2020  i++) {.         
-000546d0: 2020 2020 2020 2069 6620 2869 203e 206e         if (i > n
-000546e0: 5f70 6173 7420 2b20 6a29 207b 0a20 2020  _past + j) {.   
+00053f00: 2064 5b69 305d 203d 2030 3b0a 2020 2020   d[i0] = 0;.    
+00053f10: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00053f20: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00053f30: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00053f40: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00053f50: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00053f60: 6469 6167 280a 2020 2020 2020 2020 636f  diag(.        co
+00053f70: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00053f80: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00053f90: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00053fa0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00053fb0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00053fc0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00053fd0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00053fe0: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
+00053ff0: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
+00054000: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00054010: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00054020: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00054030: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00054040: 6f6d 7075 7465 5f66 6f72 7761 7264 5f64  ompute_forward_d
+00054050: 6961 675f 6633 3228 7061 7261 6d73 2c20  iag_f32(params, 
+00054060: 7372 6330 2c20 6473 7429 3b0a 2020 2020  src0, dst);.    
+00054070: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00054080: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00054090: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000540a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000540b0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000540c0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000540d0: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+000540e0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+000540f0: 655f 666f 7277 6172 645f 6469 6167 5f6d  e_forward_diag_m
+00054100: 6173 6b5f 696e 660a 0a73 7461 7469 6320  ask_inf..static 
+00054110: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+00054120: 655f 666f 7277 6172 645f 6469 6167 5f6d  e_forward_diag_m
+00054130: 6173 6b5f 6633 3228 0a20 2020 2020 2020  ask_f32(.       
+00054140: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00054150: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00054160: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00054170: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00054180: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00054190: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+000541a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000541b0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+000541c0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000541d0: 6c5f 7465 6e73 6f72 202a 2064 7374 2c0a  l_tensor * dst,.
+000541e0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+000541f0: 6f61 7420 7661 6c75 6529 207b 0a20 2020  oat value) {.   
+00054200: 2061 7373 6572 7428 7372 6331 2d3e 7479   assert(src1->ty
+00054210: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00054220: 4933 3229 3b0a 2020 2020 6173 7365 7274  I32);.    assert
+00054230: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
+00054240: 7372 6331 2920 3d3d 2032 293b 0a0a 2020  src1) == 2);..  
+00054250: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
+00054260: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
+00054270: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
+00054280: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
+00054290: 0a20 2020 2063 6f6e 7374 2069 6e74 2020  .    const int  
+000542a0: 6e5f 7061 7374 2020 3d20 2020 2020 2020  n_past  =       
+000542b0: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+000542c0: 312d 3e64 6174 6129 5b30 5d3b 0a20 2020  1->data)[0];.   
+000542d0: 2063 6f6e 7374 2062 6f6f 6c20 696e 706c   const bool inpl
+000542e0: 6163 6520 3d20 2862 6f6f 6c29 2828 696e  ace = (bool)((in
+000542f0: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
+00054300: 6174 6129 5b31 5d3b 0a0a 2020 2020 6173  ata)[1];..    as
+00054310: 7365 7274 286e 5f70 6173 7420 3e3d 2030  sert(n_past >= 0
+00054320: 293b 0a0a 2020 2020 6966 2028 2169 6e70  );..    if (!inp
+00054330: 6c61 6365 2026 2620 2870 6172 616d 732d  lace && (params-
+00054340: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00054350: 534b 5f49 4e49 5429 2920 7b0a 2020 2020  SK_INIT)) {.    
+00054360: 2020 2020 2f2f 206d 656d 6370 7920 6e65      // memcpy ne
+00054370: 6564 7320 746f 2062 6520 7379 6e63 6872  eds to be synchr
+00054380: 6f6e 697a 6564 2061 6372 6f73 7320 7468  onized across th
+00054390: 7265 6164 7320 746f 2061 766f 6964 2072  reads to avoid r
+000543a0: 6163 6520 636f 6e64 6974 696f 6e73 2e0a  ace conditions..
+000543b0: 2020 2020 2020 2020 2f2f 203d 3e20 646f          // => do
+000543c0: 2069 7420 696e 2049 4e49 5420 7068 6173   it in INIT phas
+000543d0: 650a 2020 2020 2020 2020 4747 4d4c 5f41  e.        GGML_A
+000543e0: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
+000543f0: 656e 7473 2864 7374 2920 3d3d 2067 676d  ents(dst) == ggm
+00054400: 6c5f 6e65 6c65 6d65 6e74 7328 7372 6330  l_nelements(src0
+00054410: 2929 3b0a 2020 2020 2020 2020 4747 4d4c  ));.        GGML
+00054420: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+00054430: 636f 6e74 6967 756f 7573 2864 7374 2920  contiguous(dst) 
+00054440: 2626 2067 676d 6c5f 6973 5f63 6f6e 7469  && ggml_is_conti
+00054450: 6775 6f75 7328 7372 6330 2929 3b0a 2020  guous(src0));.  
+00054460: 2020 2020 2020 6d65 6d63 7079 280a 2020        memcpy(.  
+00054470: 2020 2020 2020 2020 2020 2828 6368 6172            ((char
+00054480: 202a 2920 2064 7374 2d3e 6461 7461 292c   *)  dst->data),
+00054490: 0a20 2020 2020 2020 2020 2020 2028 2863  .            ((c
+000544a0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+000544b0: 6129 2c0a 2020 2020 2020 2020 2020 2020  a),.            
+000544c0: 6767 6d6c 5f6e 6279 7465 7328 6473 7429  ggml_nbytes(dst)
+000544d0: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
+000544e0: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+000544f0: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00054500: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00054510: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00054520: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00054530: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00054540: 0a20 2020 202f 2f20 544f 444f 3a20 6861  .    // TODO: ha
+00054550: 6e64 6c65 2074 7261 6e73 706f 7365 642f  ndle transposed/
+00054560: 7065 726d 7574 6564 206d 6174 7269 6365  permuted matrice
+00054570: 730a 0a20 2020 2063 6f6e 7374 2069 6e74  s..    const int
+00054580: 206e 2020 3d20 6767 6d6c 5f6e 726f 7773   n  = ggml_nrows
+00054590: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
+000545a0: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
+000545b0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
+000545c0: 7420 696e 7420 6e72 203d 2073 7263 302d  t int nr = src0-
+000545d0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+000545e0: 7420 696e 7420 6e7a 203d 206e 2f6e 723b  t int nz = n/nr;
+000545f0: 0a0a 2020 2020 6173 7365 7274 2820 6473  ..    assert( ds
+00054600: 742d 3e6e 625b 305d 203d 3d20 7369 7a65  t->nb[0] == size
+00054610: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
+00054620: 6173 7365 7274 2873 7263 302d 3e6e 625b  assert(src0->nb[
+00054630: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
+00054640: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
+00054650: 696e 7420 6b20 3d20 303b 206b 203c 206e  int k = 0; k < n
+00054660: 7a3b 206b 2b2b 2920 7b0a 2020 2020 2020  z; k++) {.      
+00054670: 2020 666f 7220 2869 6e74 206a 203d 2069    for (int j = i
+00054680: 7468 3b20 6a20 3c20 6e72 3b20 6a20 2b3d  th; j < nr; j +=
+00054690: 206e 7468 2920 7b0a 2020 2020 2020 2020   nth) {.        
+000546a0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+000546b0: 206e 5f70 6173 743b 2069 203c 206e 633b   n_past; i < nc;
+000546c0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+000546d0: 2020 2020 2020 2020 6966 2028 6920 3e20          if (i > 
+000546e0: 6e5f 7061 7374 202b 206a 2920 7b0a 2020  n_past + j) {.  
 000546f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00054700: 202a 2866 6c6f 6174 202a 2928 2863 6861   *(float *)((cha
-00054710: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-00054720: 206b 2a64 7374 2d3e 6e62 5b32 5d20 2b20   k*dst->nb[2] + 
-00054730: 6a2a 6473 742d 3e6e 625b 315d 202b 2069  j*dst->nb[1] + i
-00054740: 2a64 7374 2d3e 6e62 5b30 5d29 203d 2076  *dst->nb[0]) = v
-00054750: 616c 7565 3b0a 2020 2020 2020 2020 2020  alue;.          
-00054760: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00054770: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-00054780: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-00054790: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-000547a0: 655f 666f 7277 6172 645f 6469 6167 5f6d  e_forward_diag_m
-000547b0: 6173 6b5f 696e 6628 0a20 2020 2020 2020  ask_inf(.       
-000547c0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000547d0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-000547e0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-000547f0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00054800: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00054810: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00054820: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00054830: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-00054840: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00054850: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00054860: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
-00054870: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
-00054880: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00054890: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-000548a0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000548b0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-000548c0: 7465 5f66 6f72 7761 7264 5f64 6961 675f  te_forward_diag_
-000548d0: 6d61 736b 5f66 3332 2870 6172 616d 732c  mask_f32(params,
-000548e0: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
-000548f0: 2c20 2d49 4e46 494e 4954 5929 3b0a 2020  , -INFINITY);.  
-00054900: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00054910: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
-00054920: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-00054930: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00054940: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00054950: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
-00054960: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
-00054970: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-00054980: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00054990: 7761 7264 5f64 6961 675f 6d61 736b 5f7a  ward_diag_mask_z
-000549a0: 6572 6f28 0a20 2020 2020 2020 2063 6f6e  ero(.        con
-000549b0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000549c0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000549d0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000549e0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000549f0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00054a00: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00054a10: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00054a20: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00054a30: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00054a40: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00054a50: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-00054a60: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00054a70: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00054a80: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-00054a90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00054aa0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00054ab0: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
-00054ac0: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-00054ad0: 302c 2073 7263 312c 2064 7374 2c20 3029  0, src1, dst, 0)
-00054ae0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00054af0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-00054b00: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-00054b10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00054b20: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00054b30: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00054b40: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00054b50: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
-00054b60: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00054b70: 736f 6674 5f6d 6178 0a0a 7374 6174 6963  soft_max..static
-00054b80: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00054b90: 7465 5f66 6f72 7761 7264 5f73 6f66 745f  te_forward_soft_
-00054ba0: 6d61 785f 6633 3228 0a20 2020 2020 2020  max_f32(.       
-00054bb0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00054bc0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00054bd0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00054be0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00054bf0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00054c00: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
-00054c10: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00054c20: 2a20 6473 7429 207b 0a20 2020 2047 474d  * dst) {.    GGM
-00054c30: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-00054c40: 5f63 6f6e 7469 6775 6f75 7328 7372 6330  _contiguous(src0
-00054c50: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00054c60: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
-00054c70: 6967 756f 7573 2864 7374 2929 3b0a 2020  iguous(dst));.  
-00054c80: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00054c90: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00054ca0: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
-00054cb0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00054cc0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00054cd0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-00054ce0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00054cf0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00054d00: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00054d10: 2020 2020 7d0a 0a20 2020 202f 2f20 544f      }..    // TO
-00054d20: 444f 3a20 6861 6e64 6c65 2074 7261 6e73  DO: handle trans
-00054d30: 706f 7365 642f 7065 726d 7574 6564 206d  posed/permuted m
-00054d40: 6174 7269 6365 730a 0a20 2020 2063 6f6e  atrices..    con
-00054d50: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
-00054d60: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
-00054d70: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
-00054d80: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
-00054d90: 636f 6e73 7420 696e 7420 6e63 203d 2073  const int nc = s
-00054da0: 7263 302d 3e6e 655b 305d 3b0a 2020 2020  rc0->ne[0];.    
-00054db0: 636f 6e73 7420 696e 7420 6e72 203d 2067  const int nr = g
-00054dc0: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
-00054dd0: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
-00054de0: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
-00054df0: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
-00054e00: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
-00054e10: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
-00054e20: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
-00054e30: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-00054e40: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
-00054e50: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
-00054e60: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
-00054e70: 6e72 293b 0a0a 2020 2020 666f 7220 2869  nr);..    for (i
-00054e80: 6e74 2069 3120 3d20 6972 303b 2069 3120  nt i1 = ir0; i1 
-00054e90: 3c20 6972 313b 2069 312b 2b29 207b 0a20  < ir1; i1++) {. 
-00054ea0: 2020 2020 2020 2066 6c6f 6174 202a 7370         float *sp
-00054eb0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-00054ec0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
-00054ed0: 202b 2069 312a 7372 6330 2d3e 6e62 5b31   + i1*src0->nb[1
-00054ee0: 5d29 3b0a 2020 2020 2020 2020 666c 6f61  ]);.        floa
-00054ef0: 7420 2a64 7020 3d20 2866 6c6f 6174 202a  t *dp = (float *
-00054f00: 2928 2863 6861 7220 2a29 2020 6473 742d  )((char *)  dst-
-00054f10: 3e64 6174 6120 2b20 2069 312a 6473 742d  >data +  i1*dst-
-00054f20: 3e6e 625b 315d 293b 0a0a 2369 666e 6465  >nb[1]);..#ifnde
-00054f30: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
-00054f40: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00054f50: 2069 203c 206e 633b 202b 2b69 2920 7b0a   i < nc; ++i) {.
-00054f60: 2020 2020 2020 2020 2020 2020 2f2f 7072              //pr
-00054f70: 696e 7466 2822 705b 2564 5d20 3d20 2566  intf("p[%d] = %f
-00054f80: 5c6e 222c 2069 2c20 705b 695d 293b 0a20  \n", i, p[i]);. 
-00054f90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00054fa0: 7428 2169 736e 616e 2873 705b 695d 2929  t(!isnan(sp[i]))
-00054fb0: 3b0a 2020 2020 2020 2020 7d0a 2365 6e64  ;.        }.#end
-00054fc0: 6966 0a0a 2020 2020 2020 2020 666c 6f61  if..        floa
-00054fd0: 7420 6d61 7820 3d20 2d49 4e46 494e 4954  t max = -INFINIT
-00054fe0: 593b 0a20 2020 2020 2020 2067 676d 6c5f  Y;.        ggml_
-00054ff0: 7665 635f 6d61 785f 6633 3228 6e63 2c20  vec_max_f32(nc, 
-00055000: 266d 6178 2c20 7370 293b 0a0a 2020 2020  &max, sp);..    
-00055010: 2020 2020 6767 6d6c 5f66 6c6f 6174 2073      ggml_float s
-00055020: 756d 203d 2030 2e30 3b0a 0a20 2020 2020  um = 0.0;..     
-00055030: 2020 2075 696e 7431 365f 7420 7363 7674     uint16_t scvt
-00055040: 3b0a 2020 2020 2020 2020 666f 7220 2869  ;.        for (i
-00055050: 6e74 2069 203d 2030 3b20 6920 3c20 6e63  nt i = 0; i < nc
-00055060: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00055070: 2020 2020 2069 6620 2873 705b 695d 203d       if (sp[i] =
-00055080: 3d20 2d49 4e46 494e 4954 5929 207b 0a20  = -INFINITY) {. 
-00055090: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000550a0: 705b 695d 203d 2030 2e30 663b 0a20 2020  p[i] = 0.0f;.   
-000550b0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-000550c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000550d0: 2020 2f2f 2063 6f6e 7374 2066 6c6f 6174    // const float
-000550e0: 2076 616c 203d 2028 7370 5b69 5d20 3d3d   val = (sp[i] ==
-000550f0: 202d 494e 4649 4e49 5459 2920 3f20 302e   -INFINITY) ? 0.
-00055100: 3020 3a20 6578 7028 7370 5b69 5d20 2d20  0 : exp(sp[i] - 
-00055110: 6d61 7829 3b0a 2020 2020 2020 2020 2020  max);.          
-00055120: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-00055130: 7420 7320 3d20 4747 4d4c 5f46 5033 325f  t s = GGML_FP32_
-00055140: 544f 5f46 5031 3628 7370 5b69 5d20 2d20  TO_FP16(sp[i] - 
-00055150: 6d61 7829 3b0a 2020 2020 2020 2020 2020  max);.          
-00055160: 2020 2020 2020 6d65 6d63 7079 2826 7363        memcpy(&sc
-00055170: 7674 2c20 2673 2c20 7369 7a65 6f66 2873  vt, &s, sizeof(s
-00055180: 6376 7429 293b 0a20 2020 2020 2020 2020  cvt));.         
-00055190: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-000551a0: 6174 2076 616c 203d 2047 474d 4c5f 4650  at val = GGML_FP
-000551b0: 3136 5f54 4f5f 4650 3332 2874 6162 6c65  16_TO_FP32(table
-000551c0: 5f65 7870 5f66 3136 5b73 6376 745d 293b  _exp_f16[scvt]);
-000551d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000551e0: 2073 756d 202b 3d20 2867 676d 6c5f 666c   sum += (ggml_fl
-000551f0: 6f61 7429 7661 6c3b 0a20 2020 2020 2020  oat)val;.       
-00055200: 2020 2020 2020 2020 2064 705b 695d 203d           dp[i] =
-00055210: 2076 616c 3b0a 2020 2020 2020 2020 2020   val;.          
-00055220: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
-00055230: 2020 2020 2020 2061 7373 6572 7428 7375         assert(su
-00055240: 6d20 3e20 302e 3029 3b0a 0a20 2020 2020  m > 0.0);..     
-00055250: 2020 2073 756d 203d 2031 2e30 2f73 756d     sum = 1.0/sum
-00055260: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
-00055270: 6563 5f73 6361 6c65 5f66 3332 286e 632c  ec_scale_f32(nc,
-00055280: 2064 702c 2073 756d 293b 0a0a 2369 666e   dp, sum);..#ifn
-00055290: 6465 6620 4e44 4542 5547 0a20 2020 2020  def NDEBUG.     
-000552a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000552b0: 303b 2069 203c 206e 633b 202b 2b69 2920  0; i < nc; ++i) 
-000552c0: 7b0a 2020 2020 2020 2020 2020 2020 6173  {.            as
-000552d0: 7365 7274 2821 6973 6e61 6e28 6470 5b69  sert(!isnan(dp[i
-000552e0: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
-000552f0: 2061 7373 6572 7428 2169 7369 6e66 2864   assert(!isinf(d
-00055300: 705b 695d 2929 3b0a 2020 2020 2020 2020  p[i]));.        
-00055310: 7d0a 2365 6e64 6966 0a20 2020 207d 0a7d  }.#endif.    }.}
-00055320: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00055330: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00055340: 7264 5f73 6f66 745f 6d61 7828 0a20 2020  rd_soft_max(.   
-00055350: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00055360: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00055370: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00055380: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00055390: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000553a0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-000553b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000553c0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-000553d0: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-000553e0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-000553f0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00055400: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00055410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00055420: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055430: 7277 6172 645f 736f 6674 5f6d 6178 5f66  rward_soft_max_f
-00055440: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00055450: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00055460: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00055470: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-00055480: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00055490: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000554a0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-000554b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000554c0: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-000554d0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000554e0: 7761 7264 5f61 6c69 6269 0a0a 7374 6174  ward_alibi..stat
-000554f0: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00055500: 7075 7465 5f66 6f72 7761 7264 5f61 6c69  pute_forward_ali
-00055510: 6269 5f66 3332 280a 2020 2020 2020 2020  bi_f32(.        
-00055520: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00055530: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00055540: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00055550: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00055560: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00055570: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-00055580: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00055590: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-000555a0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000555b0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000555c0: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
-000555d0: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a20  ms->ith == 0);. 
-000555e0: 2020 2061 7373 6572 7428 7372 6331 2d3e     assert(src1->
-000555f0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-00055600: 455f 4933 3229 3b0a 2020 2020 6173 7365  E_I32);.    asse
-00055610: 7274 2867 676d 6c5f 6e65 6c65 6d65 6e74  rt(ggml_nelement
-00055620: 7328 7372 6331 2920 3d3d 2033 293b 0a0a  s(src1) == 3);..
-00055630: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00055640: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00055650: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-00055660: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00055670: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00055680: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00055690: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
-000556a0: 2069 6e74 2020 206e 5f70 6173 7420 2020   int   n_past   
-000556b0: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
-000556c0: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
-000556d0: 2020 2063 6f6e 7374 2069 6e74 2020 206e     const int   n
-000556e0: 5f68 6561 6420 2020 3d20 2828 696e 7433  _head   = ((int3
-000556f0: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
-00055700: 6129 5b31 5d3b 0a20 2020 2063 6f6e 7374  a)[1];.    const
-00055710: 2066 6c6f 6174 206d 6178 5f62 6961 7320   float max_bias 
-00055720: 3d20 2828 666c 6f61 7420 2a29 2020 2073  = ((float *)   s
-00055730: 7263 312d 3e64 6174 6129 5b32 5d3b 0a0a  rc1->data)[2];..
-00055740: 2020 2020 6173 7365 7274 286e 5f70 6173      assert(n_pas
-00055750: 7420 3e3d 2030 293b 0a0a 2020 2020 636f  t >= 0);..    co
-00055760: 6e73 7420 696e 7420 6e65 3020 3d20 7372  nst int ne0 = sr
-00055770: 6330 2d3e 6e65 5b30 5d3b 202f 2f20 616c  c0->ne[0]; // al
-00055780: 6c5f 7365 715f 6c65 6e20 3d20 6e5f 7061  l_seq_len = n_pa
-00055790: 7374 202b 206e 6531 0a20 2020 2063 6f6e  st + ne1.    con
-000557a0: 7374 2069 6e74 206e 6531 203d 2073 7263  st int ne1 = src
-000557b0: 302d 3e6e 655b 315d 3b20 2f2f 2073 6571  0->ne[1]; // seq
-000557c0: 5f6c 656e 5f77 6974 686f 7574 5f70 6173  _len_without_pas
-000557d0: 740a 2020 2020 2f2f 636f 6e73 7420 696e  t.    //const in
-000557e0: 7420 6e65 3220 3d20 7372 6330 2d3e 6e65  t ne2 = src0->ne
-000557f0: 5b32 5d3b 202f 2f20 6e5f 6865 6164 202d  [2]; // n_head -
-00055800: 3e20 7468 6973 2069 7320 6b0a 2020 2020  > this is k.    
-00055810: 2f2f 636f 6e73 7420 696e 7420 6e65 3320  //const int ne3 
-00055820: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 202f  = src0->ne[3]; /
-00055830: 2f20 3120 2d3e 2062 737a 0a0a 2020 2020  / 1 -> bsz..    
-00055840: 636f 6e73 7420 696e 7420 6e20 203d 2067  const int n  = g
-00055850: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
-00055860: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00055870: 6532 5f6e 6533 203d 206e 2f6e 6531 3b20  e2_ne3 = n/ne1; 
-00055880: 2f2f 206e 6532 2a6e 6533 0a0a 2020 2020  // ne2*ne3..    
-00055890: 636f 6e73 7420 696e 7420 6e62 3020 3d20  const int nb0 = 
-000558a0: 7372 6330 2d3e 6e62 5b30 5d3b 0a20 2020  src0->nb[0];.   
-000558b0: 2063 6f6e 7374 2069 6e74 206e 6231 203d   const int nb1 =
-000558c0: 2073 7263 302d 3e6e 625b 315d 3b0a 2020   src0->nb[1];.  
-000558d0: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
-000558e0: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
-000558f0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-00055900: 6233 203d 2073 7263 302d 3e6e 625b 335d  b3 = src0->nb[3]
-00055910: 3b0a 0a20 2020 2061 7373 6572 7428 6e62  ;..    assert(nb
-00055920: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00055930: 7429 293b 0a20 2020 2061 7373 6572 7428  t));.    assert(
-00055940: 6e65 3120 2b20 6e5f 7061 7374 203d 3d20  ne1 + n_past == 
-00055950: 6e65 3029 3b20 2876 6f69 6429 206e 5f70  ne0); (void) n_p
-00055960: 6173 743b 0a0a 2020 2020 2f2f 2061 6464  ast;..    // add
-00055970: 2061 6c69 6269 2074 6f20 7372 6330 2028   alibi to src0 (
-00055980: 4b51 5f73 6361 6c65 6429 0a20 2020 2063  KQ_scaled).    c
-00055990: 6f6e 7374 2069 6e74 206e 5f68 6561 6473  onst int n_heads
-000559a0: 5f6c 6f67 325f 666c 6f6f 7220 3d20 3120  _log2_floor = 1 
-000559b0: 3c3c 2028 696e 7429 2066 6c6f 6f72 286c  << (int) floor(l
-000559c0: 6f67 3228 6e5f 6865 6164 2929 3b0a 0a20  og2(n_head));.. 
-000559d0: 2020 2063 6f6e 7374 2066 6c6f 6174 206d     const float m
-000559e0: 3020 3d20 706f 7766 2832 2e30 662c 202d  0 = powf(2.0f, -
-000559f0: 286d 6178 5f62 6961 7329 202f 206e 5f68  (max_bias) / n_h
-00055a00: 6561 6473 5f6c 6f67 325f 666c 6f6f 7229  eads_log2_floor)
-00055a10: 3b0a 2020 2020 636f 6e73 7420 666c 6f61  ;.    const floa
-00055a20: 7420 6d31 203d 2070 6f77 6628 322e 3066  t m1 = powf(2.0f
-00055a30: 2c20 2d28 6d61 785f 6269 6173 202f 2032  , -(max_bias / 2
-00055a40: 2e30 6629 202f 206e 5f68 6561 6473 5f6c  .0f) / n_heads_l
-00055a50: 6f67 325f 666c 6f6f 7229 3b0a 0a20 2020  og2_floor);..   
-00055a60: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00055a70: 2069 203c 206e 6530 3b20 692b 2b29 207b   i < ne0; i++) {
-00055a80: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-00055a90: 7420 6a20 3d20 303b 206a 203c 206e 6531  t j = 0; j < ne1
-00055aa0: 3b20 6a2b 2b29 207b 0a20 2020 2020 2020  ; j++) {.       
-00055ab0: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
-00055ac0: 3d20 303b 206b 203c 206e 6532 5f6e 6533  = 0; k < ne2_ne3
-00055ad0: 3b20 6b2b 2b29 207b 0a20 2020 2020 2020  ; k++) {.       
-00055ae0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-00055af0: 2063 6f6e 7374 2073 7263 203d 2028 666c   const src = (fl
-00055b00: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-00055b10: 7372 6330 2d3e 6461 7461 202b 2069 2a6e  src0->data + i*n
-00055b20: 6230 202b 206a 2a6e 6231 202b 206b 2a6e  b0 + j*nb1 + k*n
-00055b30: 6232 293b 0a20 2020 2020 2020 2020 2020  b2);.           
-00055b40: 2020 2020 2066 6c6f 6174 202a 2020 2020       float *    
-00055b50: 2020 7064 7374 203d 2028 666c 6f61 7420    pdst = (float 
-00055b60: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
-00055b70: 2d3e 6461 7461 202b 2069 2a6e 6230 202b  ->data + i*nb0 +
-00055b80: 206a 2a6e 6231 202b 206b 2a6e 6232 293b   j*nb1 + k*nb2);
-00055b90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00055ba0: 2020 2f2f 2054 4f44 4f3a 206b 2a6e 6232    // TODO: k*nb2
-00055bb0: 206f 7220 6b2a 6e62 330a 0a20 2020 2020   or k*nb3..     
-00055bc0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00055bd0: 206d 5f6b 3b0a 0a20 2020 2020 2020 2020   m_k;..         
-00055be0: 2020 2020 2020 2069 6620 286b 203c 206e         if (k < n
-00055bf0: 5f68 6561 6473 5f6c 6f67 325f 666c 6f6f  _heads_log2_floo
-00055c00: 7229 207b 0a20 2020 2020 2020 2020 2020  r) {.           
-00055c10: 2020 2020 2020 2020 206d 5f6b 203d 2070           m_k = p
-00055c20: 6f77 6628 6d30 2c20 6b20 2b20 3129 3b0a  owf(m0, k + 1);.
-00055c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00055c40: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-00055c50: 2020 2020 2020 2020 2020 2020 206d 5f6b               m_k
-00055c60: 203d 2070 6f77 6628 6d31 2c20 3220 2a20   = powf(m1, 2 * 
-00055c70: 286b 202d 206e 5f68 6561 6473 5f6c 6f67  (k - n_heads_log
-00055c80: 325f 666c 6f6f 7229 202b 2031 293b 0a20  2_floor) + 1);. 
-00055c90: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00055ca0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00055cb0: 2020 7064 7374 5b30 5d20 3d20 2869 2d6e    pdst[0] = (i-n
-00055cc0: 6530 2b31 2920 2a20 6d5f 6b20 2b20 7372  e0+1) * m_k + sr
-00055cd0: 635b 305d 3b0a 0a20 2020 2020 2020 2020  c[0];..         
-00055ce0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-00055cf0: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-00055d00: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00055d10: 5f66 6f72 7761 7264 5f61 6c69 6269 5f66  _forward_alibi_f
-00055d20: 3136 280a 2020 2020 2020 2020 636f 6e73  16(.        cons
-00055d30: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00055d40: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00055d50: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00055d60: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00055d70: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00055d80: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00055d90: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00055da0: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00055db0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00055dc0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00055dd0: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
-00055de0: 6974 6820 3d3d 2030 293b 0a20 2020 2061  ith == 0);.    a
-00055df0: 7373 6572 7428 7372 6331 2d3e 7479 7065  ssert(src1->type
-00055e00: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
-00055e10: 3229 3b0a 2020 2020 6173 7365 7274 2867  2);.    assert(g
-00055e20: 676d 6c5f 6e65 6c65 6d65 6e74 7328 7372  gml_nelements(sr
-00055e30: 6331 2920 3d3d 2033 293b 0a0a 2020 2020  c1) == 3);..    
-00055e40: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00055e50: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-00055e60: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-00055e70: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00055e80: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-00055e90: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00055ea0: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-00055eb0: 2020 206e 5f70 6173 7420 2020 3d20 2828     n_past   = ((
-00055ec0: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
-00055ed0: 3e64 6174 6129 5b30 5d3b 0a20 2020 2063  >data)[0];.    c
-00055ee0: 6f6e 7374 2069 6e74 2020 206e 5f68 6561  onst int   n_hea
-00055ef0: 6420 2020 3d20 2828 696e 7433 325f 7420  d   = ((int32_t 
-00055f00: 2a29 2073 7263 312d 3e64 6174 6129 5b31  *) src1->data)[1
-00055f10: 5d3b 0a20 2020 2063 6f6e 7374 2066 6c6f  ];.    const flo
-00055f20: 6174 206d 6178 5f62 6961 7320 3d20 2828  at max_bias = ((
-00055f30: 666c 6f61 7420 2a29 2020 2073 7263 312d  float *)   src1-
-00055f40: 3e64 6174 6129 5b32 5d3b 0a0a 2020 2020  >data)[2];..    
-00055f50: 6173 7365 7274 286e 5f70 6173 7420 3e3d  assert(n_past >=
-00055f60: 2030 293b 0a0a 2020 2020 636f 6e73 7420   0);..    const 
-00055f70: 696e 7420 6e65 3020 3d20 7372 6330 2d3e  int ne0 = src0->
-00055f80: 6e65 5b30 5d3b 202f 2f20 616c 6c5f 7365  ne[0]; // all_se
-00055f90: 715f 6c65 6e20 3d20 6e5f 7061 7374 202b  q_len = n_past +
-00055fa0: 206e 6531 0a20 2020 2063 6f6e 7374 2069   ne1.    const i
-00055fb0: 6e74 206e 6531 203d 2073 7263 302d 3e6e  nt ne1 = src0->n
-00055fc0: 655b 315d 3b20 2f2f 2073 6571 5f6c 656e  e[1]; // seq_len
-00055fd0: 5f77 6974 686f 7574 5f70 6173 740a 2020  _without_past.  
-00055fe0: 2020 2f2f 636f 6e73 7420 696e 7420 6e65    //const int ne
-00055ff0: 3220 3d20 7372 6330 2d3e 6e65 5b32 5d3b  2 = src0->ne[2];
-00056000: 202f 2f20 6e5f 6865 6164 202d 3e20 7468   // n_head -> th
-00056010: 6973 2069 7320 6b0a 2020 2020 2f2f 636f  is is k.    //co
-00056020: 6e73 7420 696e 7420 6e65 3320 3d20 7372  nst int ne3 = sr
-00056030: 6330 2d3e 6e65 5b33 5d3b 202f 2f20 3120  c0->ne[3]; // 1 
-00056040: 2d3e 2062 737a 0a0a 2020 2020 636f 6e73  -> bsz..    cons
-00056050: 7420 696e 7420 6e20 203d 2067 676d 6c5f  t int n  = ggml_
-00056060: 6e72 6f77 7328 7372 6330 293b 0a20 2020  nrows(src0);.   
-00056070: 2063 6f6e 7374 2069 6e74 206e 6532 5f6e   const int ne2_n
-00056080: 6533 203d 206e 2f6e 6531 3b20 2f2f 206e  e3 = n/ne1; // n
-00056090: 6532 2a6e 6533 0a0a 2020 2020 636f 6e73  e2*ne3..    cons
-000560a0: 7420 696e 7420 6e62 3020 3d20 7372 6330  t int nb0 = src0
-000560b0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-000560c0: 7374 2069 6e74 206e 6231 203d 2073 7263  st int nb1 = src
-000560d0: 302d 3e6e 625b 315d 3b0a 2020 2020 636f  0->nb[1];.    co
-000560e0: 6e73 7420 696e 7420 6e62 3220 3d20 7372  nst int nb2 = sr
-000560f0: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 202f  c0->nb[2];.    /
-00056100: 2f63 6f6e 7374 2069 6e74 206e 6233 203d  /const int nb3 =
-00056110: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
-00056120: 2020 2061 7373 6572 7428 6e62 3020 3d3d     assert(nb0 ==
-00056130: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
-00056140: 365f 7429 293b 0a20 2020 2061 7373 6572  6_t));.    asser
-00056150: 7428 6e65 3120 2b20 6e5f 7061 7374 203d  t(ne1 + n_past =
-00056160: 3d20 6e65 3029 3b20 2876 6f69 6429 206e  = ne0); (void) n
-00056170: 5f70 6173 743b 0a0a 2020 2020 2f2f 2061  _past;..    // a
-00056180: 6464 2061 6c69 6269 2074 6f20 7372 6330  dd alibi to src0
-00056190: 2028 4b51 5f73 6361 6c65 6429 0a20 2020   (KQ_scaled).   
-000561a0: 2063 6f6e 7374 2069 6e74 206e 5f68 6561   const int n_hea
-000561b0: 6473 5f6c 6f67 325f 666c 6f6f 7220 3d20  ds_log2_floor = 
-000561c0: 3120 3c3c 2028 696e 7429 2066 6c6f 6f72  1 << (int) floor
-000561d0: 286c 6f67 3228 6e5f 6865 6164 2929 3b0a  (log2(n_head));.
-000561e0: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
-000561f0: 206d 3020 3d20 706f 7766 2832 2e30 662c   m0 = powf(2.0f,
-00056200: 202d 286d 6178 5f62 6961 7329 202f 206e   -(max_bias) / n
-00056210: 5f68 6561 6473 5f6c 6f67 325f 666c 6f6f  _heads_log2_floo
-00056220: 7229 3b0a 2020 2020 636f 6e73 7420 666c  r);.    const fl
-00056230: 6f61 7420 6d31 203d 2070 6f77 6628 322e  oat m1 = powf(2.
-00056240: 3066 2c20 2d28 6d61 785f 6269 6173 202f  0f, -(max_bias /
-00056250: 2032 2e30 6629 202f 206e 5f68 6561 6473   2.0f) / n_heads
-00056260: 5f6c 6f67 325f 666c 6f6f 7229 3b0a 0a20  _log2_floor);.. 
-00056270: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00056280: 303b 2069 203c 206e 6530 3b20 692b 2b29  0; i < ne0; i++)
-00056290: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
-000562a0: 696e 7420 6a20 3d20 303b 206a 203c 206e  int j = 0; j < n
-000562b0: 6531 3b20 6a2b 2b29 207b 0a20 2020 2020  e1; j++) {.     
-000562c0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000562d0: 6b20 3d20 303b 206b 203c 206e 6532 5f6e  k = 0; k < ne2_n
-000562e0: 6533 3b20 6b2b 2b29 207b 0a20 2020 2020  e3; k++) {.     
-000562f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00056300: 6670 3136 5f74 202a 2063 6f6e 7374 2073  fp16_t * const s
-00056310: 7263 2020 3d20 2867 676d 6c5f 6670 3136  rc  = (ggml_fp16
-00056320: 5f74 202a 2928 2863 6861 7220 2a29 2073  _t *)((char *) s
-00056330: 7263 302d 3e64 6174 6120 2b20 692a 6e62  rc0->data + i*nb
-00056340: 3020 2b20 6a2a 6e62 3120 2b20 6b2a 6e62  0 + j*nb1 + k*nb
-00056350: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
-00056360: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00056370: 2a20 2020 2020 2070 6473 7420 203d 2020  *      pdst  =  
-00056380: 2020 2020 2028 666c 6f61 7420 2a29 2828       (float *)((
-00056390: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
-000563a0: 7461 202b 2069 2a6e 6230 202b 206a 2a6e  ta + i*nb0 + j*n
-000563b0: 6231 202b 206b 2a6e 6232 293b 0a0a 2020  b1 + k*nb2);..  
-000563c0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-000563d0: 2054 4f44 4f3a 206b 2a6e 6232 206f 7220   TODO: k*nb2 or 
-000563e0: 6b2a 6e62 330a 0a20 2020 2020 2020 2020  k*nb3..         
-000563f0: 2020 2020 2020 2066 6c6f 6174 206d 5f6b         float m_k
-00056400: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00056410: 2020 2069 6620 286b 203c 206e 5f68 6561     if (k < n_hea
-00056420: 6473 5f6c 6f67 325f 666c 6f6f 7229 207b  ds_log2_floor) {
-00056430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00056440: 2020 2020 206d 5f6b 203d 2070 6f77 6628       m_k = powf(
-00056450: 6d30 2c20 6b20 2b20 3129 3b0a 2020 2020  m0, k + 1);.    
-00056460: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-00056470: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-00056480: 2020 2020 2020 2020 206d 5f6b 203d 2070           m_k = p
-00056490: 6f77 6628 6d31 2c20 3220 2a20 286b 202d  owf(m1, 2 * (k -
-000564a0: 206e 5f68 6561 6473 5f6c 6f67 325f 666c   n_heads_log2_fl
-000564b0: 6f6f 7229 202b 2031 293b 0a20 2020 2020  oor) + 1);.     
-000564c0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-000564d0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-000564e0: 2077 6520 7265 7475 726e 2046 3332 0a20   we return F32. 
-000564f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00056500: 6473 745b 305d 203d 2028 692d 6e65 302b  dst[0] = (i-ne0+
-00056510: 3129 202a 206d 5f6b 202b 2047 474d 4c5f  1) * m_k + GGML_
-00056520: 4650 3136 5f54 4f5f 4650 3332 2873 7263  FP16_TO_FP32(src
-00056530: 5b30 5d29 3b0a 2020 2020 2020 2020 2020  [0]);.          
-00056540: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-00056550: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-00056560: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00056570: 666f 7277 6172 645f 616c 6962 6928 0a20  forward_alibi(. 
-00056580: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00056590: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-000565a0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-000565b0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000565c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000565d0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-000565e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000565f0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00056600: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
-00056610: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00056620: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00056630: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00056640: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00056650: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00056660: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00056670: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00056680: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00056690: 5f61 6c69 6269 5f66 3136 2870 6172 616d  _alibi_f16(param
-000566a0: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-000566b0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-000566c0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000566d0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-000566e0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-000566f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00056700: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00056710: 5f66 6f72 7761 7264 5f61 6c69 6269 5f66  _forward_alibi_f
-00056720: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00056730: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-00056740: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00056750: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00056760: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
-00056770: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00056780: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
-00056790: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-000567a0: 5045 5f51 355f 303a 0a20 2020 2020 2020  PE_Q5_0:.       
-000567b0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-000567c0: 5135 5f31 3a0a 2020 2020 2020 2020 6361  Q5_1:.        ca
-000567d0: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
-000567e0: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
-000567f0: 4747 4d4c 5f54 5950 455f 5138 5f31 3a0a  GGML_TYPE_Q8_1:.
-00056800: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00056810: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
-00056820: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00056830: 455f 4931 363a 0a20 2020 2020 2020 2063  E_I16:.        c
-00056840: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
-00056850: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
-00056860: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
-00056870: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00056880: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00056890: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-000568a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000568b0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-000568c0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-000568d0: 655f 666f 7277 6172 645f 636c 616d 700a  e_forward_clamp.
-000568e0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000568f0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00056900: 645f 636c 616d 705f 6633 3228 0a20 2020  d_clamp_f32(.   
-00056910: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00056920: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-00056930: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00056940: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00056950: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00056960: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00056970: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00056980: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-00056990: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-000569a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-000569b0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-000569c0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
-000569d0: 3029 3b0a 2020 2020 6173 7365 7274 2873  0);.    assert(s
-000569e0: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
-000569f0: 4c5f 5459 5045 5f49 3332 293b 0a20 2020  L_TYPE_I32);.   
-00056a00: 2061 7373 6572 7428 6767 6d6c 5f6e 656c   assert(ggml_nel
-00056a10: 656d 656e 7473 2873 7263 3129 203d 3d20  ements(src1) == 
-00056a20: 3229 3b0a 0a20 2020 2069 6620 2870 6172  2);..    if (par
-00056a30: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00056a40: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-00056a50: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00056a60: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00056a70: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00056a80: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00056a90: 636f 6e73 7420 696e 7420 6d69 6e20 3d20  const int min = 
-00056aa0: 2828 666c 6f61 7420 2a29 2073 7263 312d  ((float *) src1-
-00056ab0: 3e64 6174 6129 5b30 5d3b 0a20 2020 2063  >data)[0];.    c
-00056ac0: 6f6e 7374 2069 6e74 206d 6178 203d 2028  onst int max = (
-00056ad0: 2866 6c6f 6174 202a 2920 7372 6331 2d3e  (float *) src1->
-00056ae0: 6461 7461 295b 315d 3b0a 0a20 2020 2063  data)[1];..    c
-00056af0: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
-00056b00: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
-00056b10: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
-00056b20: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
-00056b30: 2020 636f 6e73 7420 696e 7420 6e20 203d    const int n  =
-00056b40: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
-00056b50: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
-00056b60: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
-00056b70: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
-00056b80: 7a65 5f74 206e 6230 3020 3d20 7372 6330  ze_t nb00 = src0
-00056b90: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-00056ba0: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
-00056bb0: 2073 7263 302d 3e6e 625b 315d 3b0a 0a20   src0->nb[1];.. 
-00056bc0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00056bd0: 6e62 3020 3d20 6473 742d 3e6e 625b 305d  nb0 = dst->nb[0]
-00056be0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-00056bf0: 5f74 206e 6231 203d 2064 7374 2d3e 6e62  _t nb1 = dst->nb
-00056c00: 5b31 5d3b 0a0a 2020 2020 4747 4d4c 5f41  [1];..    GGML_A
-00056c10: 5353 4552 5428 206e 6230 203d 3d20 7369  SSERT( nb0 == si
-00056c20: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
-00056c30: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00056c40: 3030 203d 3d20 7369 7a65 6f66 2866 6c6f  00 == sizeof(flo
-00056c50: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
-00056c60: 696e 7420 6a20 3d20 6974 683b 206a 203c  int j = ith; j <
-00056c70: 206e 3b20 6a20 2b3d 206e 7468 2920 7b0a   n; j += nth) {.
-00056c80: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00056c90: 6473 745f 7074 7220 203d 2028 666c 6f61  dst_ptr  = (floa
-00056ca0: 7420 2a29 2028 2863 6861 7220 2a29 2020  t *) ((char *)  
-00056cb0: 6473 742d 3e64 6174 6120 2b20 6a2a 6e62  dst->data + j*nb
-00056cc0: 3129 3b0a 2020 2020 2020 2020 666c 6f61  1);.        floa
-00056cd0: 7420 2a20 7372 6330 5f70 7472 203d 2028  t * src0_ptr = (
-00056ce0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00056cf0: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00056d00: 6a2a 6e62 3031 293b 0a0a 2020 2020 2020  j*nb01);..      
-00056d10: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00056d20: 3b20 6920 3c20 6e63 3b20 692b 2b29 207b  ; i < nc; i++) {
-00056d30: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
-00056d40: 5f70 7472 5b69 5d20 3d20 4d41 5828 4d49  _ptr[i] = MAX(MI
-00056d50: 4e28 7372 6330 5f70 7472 5b69 5d2c 206d  N(src0_ptr[i], m
-00056d60: 6178 292c 206d 696e 293b 0a20 2020 2020  ax), min);.     
-00056d70: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-00056d80: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00056d90: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00056da0: 6c61 6d70 280a 2020 2020 2020 2020 636f  lamp(.        co
-00056db0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00056dc0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00056dd0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00056de0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00056df0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00056e00: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00056e10: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00056e20: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-00056e30: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00056e40: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00056e50: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
-00056e60: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
-00056e70: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00056e80: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
-00056e90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00056ea0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00056eb0: 666f 7277 6172 645f 636c 616d 705f 6633  forward_clamp_f3
-00056ec0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
-00056ed0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-00056ee0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00056ef0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00056f00: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
-00056f10: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00056f20: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
-00056f30: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00056f40: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
-00056f50: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
-00056f60: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
-00056f70: 2047 474d 4c5f 5459 5045 5f51 355f 313a   GGML_TYPE_Q5_1:
-00056f80: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00056f90: 4d4c 5f54 5950 455f 5138 5f30 3a0a 2020  ML_TYPE_Q8_0:.  
-00056fa0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00056fb0: 5459 5045 5f51 385f 313a 0a20 2020 2020  TYPE_Q8_1:.     
-00056fc0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00056fd0: 455f 4938 3a0a 2020 2020 2020 2020 6361  E_I8:.        ca
-00056fe0: 7365 2047 474d 4c5f 5459 5045 5f49 3136  se GGML_TYPE_I16
-00056ff0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00057000: 474d 4c5f 5459 5045 5f49 3332 3a0a 2020  GML_TYPE_I32:.  
-00057010: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00057020: 5459 5045 5f43 4f55 4e54 3a0a 2020 2020  TYPE_COUNT:.    
-00057030: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00057040: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00057050: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-00057060: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00057070: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
-00057080: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00057090: 6172 645f 726f 7065 0a0a 7374 6174 6963  ard_rope..static
-000570a0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000570b0: 7465 5f66 6f72 7761 7264 5f72 6f70 655f  te_forward_rope_
-000570c0: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-000570d0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000570e0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000570f0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-00057100: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00057110: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-00057120: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00057130: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00057140: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00057150: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00057160: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00057170: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
-00057180: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-00057190: 5f54 5950 455f 4933 3229 3b0a 2020 2020  _TYPE_I32);.    
-000571a0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-000571b0: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
-000571c0: 203d 3d20 3329 3b0a 0a20 2020 2069 6620   == 3);..    if 
-000571d0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-000571e0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-000571f0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00057200: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00057210: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00057220: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00057230: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-00057240: 7061 7374 203d 2028 2869 6e74 3332 5f74  past = ((int32_t
-00057250: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-00057260: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00057270: 7420 6e5f 6469 6d73 203d 2028 2869 6e74  t n_dims = ((int
-00057280: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-00057290: 7461 295b 315d 3b0a 2020 2020 636f 6e73  ta)[1];.    cons
-000572a0: 7420 696e 7420 6d6f 6465 2020 203d 2028  t int mode   = (
-000572b0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-000572c0: 2d3e 6461 7461 295b 325d 3b0a 0a20 2020  ->data)[2];..   
-000572d0: 2061 7373 6572 7428 6e5f 7061 7374 203e   assert(n_past >
-000572e0: 3d20 3029 3b0a 0a20 2020 2063 6f6e 7374  = 0);..    const
-000572f0: 2073 697a 655f 7420 6e62 3030 203d 2073   size_t nb00 = s
-00057300: 7263 302d 3e6e 625b 305d 3b0a 2020 2020  rc0->nb[0];.    
-00057310: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-00057320: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
-00057330: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00057340: 7420 6e62 3032 203d 2073 7263 302d 3e6e  t nb02 = src0->n
-00057350: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-00057360: 7369 7a65 5f74 206e 6230 3320 3d20 7372  size_t nb03 = sr
-00057370: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
-00057380: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00057390: 3020 3d20 6473 742d 3e6e 655b 305d 3b0a  0 = dst->ne[0];.
-000573a0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000573b0: 7420 6e65 3120 3d20 6473 742d 3e6e 655b  t ne1 = dst->ne[
-000573c0: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-000573d0: 7436 345f 7420 6e65 3220 3d20 6473 742d  t64_t ne2 = dst-
-000573e0: 3e6e 655b 325d 3b0a 2020 2020 636f 6e73  >ne[2];.    cons
-000573f0: 7420 696e 7436 345f 7420 6e65 3320 3d20  t int64_t ne3 = 
-00057400: 6473 742d 3e6e 655b 335d 3b0a 0a20 2020  dst->ne[3];..   
-00057410: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-00057420: 3020 3d20 6473 742d 3e6e 625b 305d 3b0a  0 = dst->nb[0];.
-00057430: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00057440: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
-00057450: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
-00057460: 655f 7420 6e62 3220 3d20 6473 742d 3e6e  e_t nb2 = dst->n
-00057470: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
-00057480: 7369 7a65 5f74 206e 6233 203d 2064 7374  size_t nb3 = dst
-00057490: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 2f2f  ->nb[3];..    //
-000574a0: 7072 696e 7466 2822 6e65 303a 2025 642c  printf("ne0: %d,
-000574b0: 206e 6531 3a20 2564 2c20 6e65 323a 2025   ne1: %d, ne2: %
-000574c0: 642c 206e 6533 3a20 2564 5c6e 222c 206e  d, ne3: %d\n", n
-000574d0: 6530 2c20 6e65 312c 206e 6532 2c20 6e65  e0, ne1, ne2, ne
-000574e0: 3329 3b0a 2020 2020 2f2f 7072 696e 7466  3);.    //printf
-000574f0: 2822 6e5f 7061 7374 203d 2025 642c 206e  ("n_past = %d, n
-00057500: 6532 203d 2025 645c 6e22 2c20 6e5f 7061  e2 = %d\n", n_pa
-00057510: 7374 2c20 6e65 3229 3b0a 0a20 2020 2047  st, ne2);..    G
-00057520: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
-00057530: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00057540: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-00057550: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
-00057560: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-00057570: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
-00057580: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
-00057590: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
-000575a0: 726f 7773 2864 7374 293b 0a0a 2020 2020  rows(dst);..    
-000575b0: 4747 4d4c 5f41 5353 4552 5428 6e5f 6469  GGML_ASSERT(n_di
-000575c0: 6d73 203c 3d20 6e65 3029 3b0a 2020 2020  ms <= ne0);.    
-000575d0: 4747 4d4c 5f41 5353 4552 5428 6e5f 6469  GGML_ASSERT(n_di
-000575e0: 6d73 2025 2032 203d 3d20 3029 3b0a 0a20  ms % 2 == 0);.. 
-000575f0: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
-00057600: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-00057610: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
-00057620: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-00057630: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-00057640: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-00057650: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
-00057660: 203d 2064 722a 6974 683b 0a20 2020 2063   = dr*ith;.    c
-00057670: 6f6e 7374 2069 6e74 2069 7231 203d 204d  onst int ir1 = M
-00057680: 494e 2869 7230 202b 2064 722c 206e 7229  IN(ir0 + dr, nr)
-00057690: 3b0a 0a20 2020 202f 2f20 726f 7720 696e  ;..    // row in
-000576a0: 6465 7820 7573 6564 2074 6f20 6465 7465  dex used to dete
-000576b0: 726d 696e 6520 7768 6963 6820 7468 7265  rmine which thre
-000576c0: 6164 2074 6f20 7573 650a 2020 2020 696e  ad to use.    in
-000576d0: 7420 6972 203d 2030 3b0a 0a20 2020 2063  t ir = 0;..    c
-000576e0: 6f6e 7374 2066 6c6f 6174 2074 6865 7461  onst float theta
-000576f0: 5f73 6361 6c65 203d 2070 6f77 6628 3130  _scale = powf(10
-00057700: 3030 302e 302c 202d 322e 3066 2f6e 5f64  000.0, -2.0f/n_d
-00057710: 696d 7329 3b0a 0a20 2020 2063 6f6e 7374  ims);..    const
-00057720: 2062 6f6f 6c20 6973 5f6e 656f 7820 3d20   bool is_neox = 
-00057730: 6d6f 6465 2026 2032 3b0a 0a20 2020 2066  mode & 2;..    f
-00057740: 6f72 2028 696e 7436 345f 7420 6933 203d  or (int64_t i3 =
-00057750: 2030 3b20 6933 203c 206e 6533 3b20 6933   0; i3 < ne3; i3
-00057760: 2b2b 2920 7b0a 2020 2020 2020 2020 666f  ++) {.        fo
-00057770: 7220 2869 6e74 3634 5f74 2069 3220 3d20  r (int64_t i2 = 
-00057780: 2828 6d6f 6465 2026 2031 2920 3d3d 2030  ((mode & 1) == 0
-00057790: 203f 2030 203a 206e 5f70 6173 7429 3b20   ? 0 : n_past); 
-000577a0: 6932 203c 206e 6532 3b20 6932 2b2b 2920  i2 < ne2; i2++) 
-000577b0: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
-000577c0: 6e73 7420 696e 7436 345f 7420 7020 3d20  nst int64_t p = 
-000577d0: 2828 6d6f 6465 2026 2031 2920 3d3d 2030  ((mode & 1) == 0
-000577e0: 203f 206e 5f70 6173 7420 2b20 6932 203a   ? n_past + i2 :
-000577f0: 2069 3229 3b0a 2020 2020 2020 2020 2020   i2);.          
-00057800: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-00057810: 3120 3d20 303b 2069 3120 3c20 6e65 313b  1 = 0; i1 < ne1;
-00057820: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
-00057830: 2020 2020 2020 2020 2069 6620 2869 722b           if (ir+
-00057840: 2b20 3c20 6972 3029 2063 6f6e 7469 6e75  + < ir0) continu
-00057850: 653b 0a20 2020 2020 2020 2020 2020 2020  e;.             
-00057860: 2020 2069 6620 2869 7220 2020 3e20 6972     if (ir   > ir
-00057870: 3129 2062 7265 616b 3b0a 0a20 2020 2020  1) break;..     
-00057880: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00057890: 2074 6865 7461 203d 2028 666c 6f61 7429   theta = (float)
-000578a0: 703b 0a0a 2020 2020 2020 2020 2020 2020  p;..            
-000578b0: 2020 2020 6966 2028 2169 735f 6e65 6f78      if (!is_neox
-000578c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000578d0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000578e0: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-000578f0: 3c20 6e65 303b 2069 3020 2b3d 2032 2920  < ne0; i0 += 2) 
-00057900: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00057910: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00057920: 666c 6f61 7420 636f 735f 7468 6574 6120  float cos_theta 
-00057930: 3d20 636f 7366 2874 6865 7461 293b 0a20  = cosf(theta);. 
-00057940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057950: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-00057960: 6174 2073 696e 5f74 6865 7461 203d 2073  at sin_theta = s
-00057970: 696e 6628 7468 6574 6129 3b0a 0a20 2020  inf(theta);..   
-00057980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057990: 2020 2020 2074 6865 7461 202a 3d20 7468       theta *= th
-000579a0: 6574 615f 7363 616c 653b 0a0a 2020 2020  eta_scale;..    
-000579b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000579c0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-000579d0: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
-000579e0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-000579f0: 2073 7263 302d 3e64 6174 6120 2b20 6933   src0->data + i3
-00057a00: 2a6e 6230 3320 2b20 6932 2a6e 6230 3220  *nb03 + i2*nb02 
-00057a10: 2b20 6931 2a6e 6230 3120 2b20 6930 2a6e  + i1*nb01 + i0*n
-00057a20: 6230 3029 3b0a 2020 2020 2020 2020 2020  b00);.          
+00054700: 2020 2a28 666c 6f61 7420 2a29 2828 6368    *(float *)((ch
+00054710: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00054720: 2b20 6b2a 6473 742d 3e6e 625b 325d 202b  + k*dst->nb[2] +
+00054730: 206a 2a64 7374 2d3e 6e62 5b31 5d20 2b20   j*dst->nb[1] + 
+00054740: 692a 6473 742d 3e6e 625b 305d 2920 3d20  i*dst->nb[0]) = 
+00054750: 7661 6c75 653b 0a20 2020 2020 2020 2020  value;.         
+00054760: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00054770: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00054780: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00054790: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+000547a0: 7465 5f66 6f72 7761 7264 5f64 6961 675f  te_forward_diag_
+000547b0: 6d61 736b 5f69 6e66 280a 2020 2020 2020  mask_inf(.      
+000547c0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000547d0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000547e0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000547f0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00054800: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00054810: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+00054820: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00054830: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00054840: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00054850: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00054860: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+00054870: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00054880: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00054890: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+000548a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000548b0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+000548c0: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+000548d0: 5f6d 6173 6b5f 6633 3228 7061 7261 6d73  _mask_f32(params
+000548e0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
+000548f0: 742c 202d 494e 4649 4e49 5459 293b 0a20  t, -INFINITY);. 
+00054900: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00054910: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
+00054920: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+00054930: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00054940: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00054950: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+00054960: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00054970: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+00054980: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00054990: 7277 6172 645f 6469 6167 5f6d 6173 6b5f  rward_diag_mask_
+000549a0: 7a65 726f 280a 2020 2020 2020 2020 636f  zero(.        co
+000549b0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000549c0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+000549d0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+000549e0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+000549f0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00054a00: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00054a10: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00054a20: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+00054a30: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00054a40: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00054a50: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+00054a60: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00054a70: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00054a80: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+00054a90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00054aa0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00054ab0: 666f 7277 6172 645f 6469 6167 5f6d 6173  forward_diag_mas
+00054ac0: 6b5f 6633 3228 7061 7261 6d73 2c20 7372  k_f32(params, sr
+00054ad0: 6330 2c20 7372 6331 2c20 6473 742c 2030  c0, src1, dst, 0
+00054ae0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00054af0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00054b00: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+00054b10: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00054b20: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00054b30: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00054b40: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00054b50: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
+00054b60: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00054b70: 5f73 6f66 745f 6d61 780a 0a73 7461 7469  _soft_max..stati
+00054b80: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00054b90: 7574 655f 666f 7277 6172 645f 736f 6674  ute_forward_soft
+00054ba0: 5f6d 6178 5f66 3332 280a 2020 2020 2020  _max_f32(.      
+00054bb0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00054bc0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00054bd0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00054be0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00054bf0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00054c00: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
+00054c10: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00054c20: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
+00054c30: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00054c40: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
+00054c50: 3029 293b 0a20 2020 2047 474d 4c5f 4153  0));.    GGML_AS
+00054c60: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+00054c70: 7469 6775 6f75 7328 6473 7429 293b 0a20  tiguous(dst));. 
+00054c80: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+00054c90: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
+00054ca0: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
+00054cb0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00054cc0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00054cd0: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00054ce0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00054cf0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00054d00: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00054d10: 0a20 2020 207d 0a0a 2020 2020 2f2f 2054  .    }..    // T
+00054d20: 4f44 4f3a 2068 616e 646c 6520 7472 616e  ODO: handle tran
+00054d30: 7370 6f73 6564 2f70 6572 6d75 7465 6420  sposed/permuted 
+00054d40: 6d61 7472 6963 6573 0a0a 2020 2020 636f  matrices..    co
+00054d50: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
+00054d60: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
+00054d70: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
+00054d80: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
+00054d90: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
+00054da0: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+00054db0: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
+00054dc0: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+00054dd0: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+00054de0: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+00054df0: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+00054e00: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+00054e10: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+00054e20: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+00054e30: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00054e40: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+00054e50: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+00054e60: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+00054e70: 206e 7229 3b0a 0a20 2020 2066 6f72 2028   nr);..    for (
+00054e80: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
+00054e90: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
+00054ea0: 2020 2020 2020 2020 666c 6f61 7420 2a73          float *s
+00054eb0: 7020 3d20 2866 6c6f 6174 202a 2928 2863  p = (float *)((c
+00054ec0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+00054ed0: 6120 2b20 6931 2a73 7263 302d 3e6e 625b  a + i1*src0->nb[
+00054ee0: 315d 293b 0a20 2020 2020 2020 2066 6c6f  1]);.        flo
+00054ef0: 6174 202a 6470 203d 2028 666c 6f61 7420  at *dp = (float 
+00054f00: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
+00054f10: 2d3e 6461 7461 202b 2020 6931 2a64 7374  ->data +  i1*dst
+00054f20: 2d3e 6e62 5b31 5d29 3b0a 0a23 6966 6e64  ->nb[1]);..#ifnd
+00054f30: 6566 204e 4445 4255 470a 2020 2020 2020  ef NDEBUG.      
+00054f40: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00054f50: 3b20 6920 3c20 6e63 3b20 2b2b 6929 207b  ; i < nc; ++i) {
+00054f60: 0a20 2020 2020 2020 2020 2020 202f 2f70  .            //p
+00054f70: 7269 6e74 6628 2270 5b25 645d 203d 2025  rintf("p[%d] = %
+00054f80: 665c 6e22 2c20 692c 2070 5b69 5d29 3b0a  f\n", i, p[i]);.
+00054f90: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00054fa0: 7274 2821 6973 6e61 6e28 7370 5b69 5d29  rt(!isnan(sp[i])
+00054fb0: 293b 0a20 2020 2020 2020 207d 0a23 656e  );.        }.#en
+00054fc0: 6469 660a 0a20 2020 2020 2020 2066 6c6f  dif..        flo
+00054fd0: 6174 206d 6178 203d 202d 494e 4649 4e49  at max = -INFINI
+00054fe0: 5459 3b0a 2020 2020 2020 2020 6767 6d6c  TY;.        ggml
+00054ff0: 5f76 6563 5f6d 6178 5f66 3332 286e 632c  _vec_max_f32(nc,
+00055000: 2026 6d61 782c 2073 7029 3b0a 0a20 2020   &max, sp);..   
+00055010: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
+00055020: 7375 6d20 3d20 302e 303b 0a0a 2020 2020  sum = 0.0;..    
+00055030: 2020 2020 7569 6e74 3136 5f74 2073 6376      uint16_t scv
+00055040: 743b 0a20 2020 2020 2020 2066 6f72 2028  t;.        for (
+00055050: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
+00055060: 633b 2069 2b2b 2920 7b0a 2020 2020 2020  c; i++) {.      
+00055070: 2020 2020 2020 6966 2028 7370 5b69 5d20        if (sp[i] 
+00055080: 3d3d 202d 494e 4649 4e49 5459 2920 7b0a  == -INFINITY) {.
+00055090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000550a0: 6470 5b69 5d20 3d20 302e 3066 3b0a 2020  dp[i] = 0.0f;.  
+000550b0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+000550c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000550d0: 2020 202f 2f20 636f 6e73 7420 666c 6f61     // const floa
+000550e0: 7420 7661 6c20 3d20 2873 705b 695d 203d  t val = (sp[i] =
+000550f0: 3d20 2d49 4e46 494e 4954 5929 203f 2030  = -INFINITY) ? 0
+00055100: 2e30 203a 2065 7870 2873 705b 695d 202d  .0 : exp(sp[i] -
+00055110: 206d 6178 293b 0a20 2020 2020 2020 2020   max);.         
+00055120: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
+00055130: 5f74 2073 203d 2047 474d 4c5f 4650 3332  _t s = GGML_FP32
+00055140: 5f54 4f5f 4650 3136 2873 705b 695d 202d  _TO_FP16(sp[i] -
+00055150: 206d 6178 293b 0a20 2020 2020 2020 2020   max);.         
+00055160: 2020 2020 2020 206d 656d 6370 7928 2673         memcpy(&s
+00055170: 6376 742c 2026 732c 2073 697a 656f 6628  cvt, &s, sizeof(
+00055180: 7363 7674 2929 3b0a 2020 2020 2020 2020  scvt));.        
+00055190: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+000551a0: 6f61 7420 7661 6c20 3d20 4747 4d4c 5f46  oat val = GGML_F
+000551b0: 5031 365f 544f 5f46 5033 3228 7461 626c  P16_TO_FP32(tabl
+000551c0: 655f 6578 705f 6631 365b 7363 7674 5d29  e_exp_f16[scvt])
+000551d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000551e0: 2020 7375 6d20 2b3d 2028 6767 6d6c 5f66    sum += (ggml_f
+000551f0: 6c6f 6174 2976 616c 3b0a 2020 2020 2020  loat)val;.      
+00055200: 2020 2020 2020 2020 2020 6470 5b69 5d20            dp[i] 
+00055210: 3d20 7661 6c3b 0a20 2020 2020 2020 2020  = val;.         
+00055220: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+00055230: 2020 2020 2020 2020 6173 7365 7274 2873          assert(s
+00055240: 756d 203e 2030 2e30 293b 0a0a 2020 2020  um > 0.0);..    
+00055250: 2020 2020 7375 6d20 3d20 312e 302f 7375      sum = 1.0/su
+00055260: 6d3b 0a20 2020 2020 2020 2067 676d 6c5f  m;.        ggml_
+00055270: 7665 635f 7363 616c 655f 6633 3228 6e63  vec_scale_f32(nc
+00055280: 2c20 6470 2c20 7375 6d29 3b0a 0a23 6966  , dp, sum);..#if
+00055290: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
+000552a0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+000552b0: 2030 3b20 6920 3c20 6e63 3b20 2b2b 6929   0; i < nc; ++i)
+000552c0: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
+000552d0: 7373 6572 7428 2169 736e 616e 2864 705b  ssert(!isnan(dp[
+000552e0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+000552f0: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
+00055300: 6470 5b69 5d29 293b 0a20 2020 2020 2020  dp[i]));.       
+00055310: 207d 0a23 656e 6469 660a 2020 2020 7d0a   }.#endif.    }.
+00055320: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00055330: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00055340: 6172 645f 736f 6674 5f6d 6178 280a 2020  ard_soft_max(.  
+00055350: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00055360: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00055370: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00055380: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00055390: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000553a0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+000553b0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+000553c0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+000553d0: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+000553e0: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+000553f0: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+00055400: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+00055410: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00055420: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00055430: 6f72 7761 7264 5f73 6f66 745f 6d61 785f  orward_soft_max_
+00055440: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+00055450: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+00055460: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00055470: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
+00055480: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00055490: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000554a0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+000554b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000554c0: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
+000554d0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000554e0: 7277 6172 645f 616c 6962 690a 0a73 7461  rward_alibi..sta
+000554f0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00055500: 6d70 7574 655f 666f 7277 6172 645f 616c  mpute_forward_al
+00055510: 6962 695f 6633 3228 0a20 2020 2020 2020  ibi_f32(.       
+00055520: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00055530: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00055540: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00055550: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00055560: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00055570: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+00055580: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00055590: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+000555a0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+000555b0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+000555c0: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
+000555d0: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
+000555e0: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
+000555f0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00055600: 5045 5f49 3332 293b 0a20 2020 2061 7373  PE_I32);.    ass
+00055610: 6572 7428 6767 6d6c 5f6e 656c 656d 656e  ert(ggml_nelemen
+00055620: 7473 2873 7263 3129 203d 3d20 3329 3b0a  ts(src1) == 3);.
+00055630: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00055640: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00055650: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+00055660: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00055670: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00055680: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+00055690: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+000556a0: 7420 696e 7420 2020 6e5f 7061 7374 2020  t int   n_past  
+000556b0: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+000556c0: 7372 6331 2d3e 6461 7461 295b 305d 3b0a  src1->data)[0];.
+000556d0: 2020 2020 636f 6e73 7420 696e 7420 2020      const int   
+000556e0: 6e5f 6865 6164 2020 203d 2028 2869 6e74  n_head   = ((int
+000556f0: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
+00055700: 7461 295b 315d 3b0a 2020 2020 636f 6e73  ta)[1];.    cons
+00055710: 7420 666c 6f61 7420 6d61 785f 6269 6173  t float max_bias
+00055720: 203d 2028 2866 6c6f 6174 202a 2920 2020   = ((float *)   
+00055730: 7372 6331 2d3e 6461 7461 295b 325d 3b0a  src1->data)[2];.
+00055740: 0a20 2020 2061 7373 6572 7428 6e5f 7061  .    assert(n_pa
+00055750: 7374 203e 3d20 3029 3b0a 0a20 2020 2063  st >= 0);..    c
+00055760: 6f6e 7374 2069 6e74 206e 6530 203d 2073  onst int ne0 = s
+00055770: 7263 302d 3e6e 655b 305d 3b20 2f2f 2061  rc0->ne[0]; // a
+00055780: 6c6c 5f73 6571 5f6c 656e 203d 206e 5f70  ll_seq_len = n_p
+00055790: 6173 7420 2b20 6e65 310a 2020 2020 636f  ast + ne1.    co
+000557a0: 6e73 7420 696e 7420 6e65 3120 3d20 7372  nst int ne1 = sr
+000557b0: 6330 2d3e 6e65 5b31 5d3b 202f 2f20 7365  c0->ne[1]; // se
+000557c0: 715f 6c65 6e5f 7769 7468 6f75 745f 7061  q_len_without_pa
+000557d0: 7374 0a20 2020 202f 2f63 6f6e 7374 2069  st.    //const i
+000557e0: 6e74 206e 6532 203d 2073 7263 302d 3e6e  nt ne2 = src0->n
+000557f0: 655b 325d 3b20 2f2f 206e 5f68 6561 6420  e[2]; // n_head 
+00055800: 2d3e 2074 6869 7320 6973 206b 0a20 2020  -> this is k.   
+00055810: 202f 2f63 6f6e 7374 2069 6e74 206e 6533   //const int ne3
+00055820: 203d 2073 7263 302d 3e6e 655b 335d 3b20   = src0->ne[3]; 
+00055830: 2f2f 2031 202d 3e20 6273 7a0a 0a20 2020  // 1 -> bsz..   
+00055840: 2063 6f6e 7374 2069 6e74 206e 2020 3d20   const int n  = 
+00055850: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
+00055860: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00055870: 6e65 325f 6e65 3320 3d20 6e2f 6e65 313b  ne2_ne3 = n/ne1;
+00055880: 202f 2f20 6e65 322a 6e65 330a 0a20 2020   // ne2*ne3..   
+00055890: 2063 6f6e 7374 2069 6e74 206e 6230 203d   const int nb0 =
+000558a0: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
+000558b0: 2020 636f 6e73 7420 696e 7420 6e62 3120    const int nb1 
+000558c0: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
+000558d0: 2020 2063 6f6e 7374 2069 6e74 206e 6232     const int nb2
+000558e0: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+000558f0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+00055900: 6e62 3320 3d20 7372 6330 2d3e 6e62 5b33  nb3 = src0->nb[3
+00055910: 5d3b 0a0a 2020 2020 6173 7365 7274 286e  ];..    assert(n
+00055920: 6230 203d 3d20 7369 7a65 6f66 2866 6c6f  b0 == sizeof(flo
+00055930: 6174 2929 3b0a 2020 2020 6173 7365 7274  at));.    assert
+00055940: 286e 6531 202b 206e 5f70 6173 7420 3d3d  (ne1 + n_past ==
+00055950: 206e 6530 293b 2028 766f 6964 2920 6e5f   ne0); (void) n_
+00055960: 7061 7374 3b0a 0a20 2020 202f 2f20 6164  past;..    // ad
+00055970: 6420 616c 6962 6920 746f 2073 7263 3020  d alibi to src0 
+00055980: 284b 515f 7363 616c 6564 290a 2020 2020  (KQ_scaled).    
+00055990: 636f 6e73 7420 696e 7420 6e5f 6865 6164  const int n_head
+000559a0: 735f 6c6f 6732 5f66 6c6f 6f72 203d 2031  s_log2_floor = 1
+000559b0: 203c 3c20 2869 6e74 2920 666c 6f6f 7228   << (int) floor(
+000559c0: 6c6f 6732 286e 5f68 6561 6429 293b 0a0a  log2(n_head));..
+000559d0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+000559e0: 6d30 203d 2070 6f77 6628 322e 3066 2c20  m0 = powf(2.0f, 
+000559f0: 2d28 6d61 785f 6269 6173 2920 2f20 6e5f  -(max_bias) / n_
+00055a00: 6865 6164 735f 6c6f 6732 5f66 6c6f 6f72  heads_log2_floor
+00055a10: 293b 0a20 2020 2063 6f6e 7374 2066 6c6f  );.    const flo
+00055a20: 6174 206d 3120 3d20 706f 7766 2832 2e30  at m1 = powf(2.0
+00055a30: 662c 202d 286d 6178 5f62 6961 7320 2f20  f, -(max_bias / 
+00055a40: 322e 3066 2920 2f20 6e5f 6865 6164 735f  2.0f) / n_heads_
+00055a50: 6c6f 6732 5f66 6c6f 6f72 293b 0a0a 2020  log2_floor);..  
+00055a60: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00055a70: 3b20 6920 3c20 6e65 303b 2069 2b2b 2920  ; i < ne0; i++) 
+00055a80: 7b0a 2020 2020 2020 2020 666f 7220 2869  {.        for (i
+00055a90: 6e74 206a 203d 2030 3b20 6a20 3c20 6e65  nt j = 0; j < ne
+00055aa0: 313b 206a 2b2b 2920 7b0a 2020 2020 2020  1; j++) {.      
+00055ab0: 2020 2020 2020 666f 7220 2869 6e74 206b        for (int k
+00055ac0: 203d 2030 3b20 6b20 3c20 6e65 325f 6e65   = 0; k < ne2_ne
+00055ad0: 333b 206b 2b2b 2920 7b0a 2020 2020 2020  3; k++) {.      
+00055ae0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00055af0: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
+00055b00: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+00055b10: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
+00055b20: 6e62 3020 2b20 6a2a 6e62 3120 2b20 6b2a  nb0 + j*nb1 + k*
+00055b30: 6e62 3229 3b0a 2020 2020 2020 2020 2020  nb2);.          
+00055b40: 2020 2020 2020 666c 6f61 7420 2a20 2020        float *   
+00055b50: 2020 2070 6473 7420 3d20 2866 6c6f 6174     pdst = (float
+00055b60: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
+00055b70: 742d 3e64 6174 6120 2b20 692a 6e62 3020  t->data + i*nb0 
+00055b80: 2b20 6a2a 6e62 3120 2b20 6b2a 6e62 3229  + j*nb1 + k*nb2)
+00055b90: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00055ba0: 2020 202f 2f20 544f 444f 3a20 6b2a 6e62     // TODO: k*nb
+00055bb0: 3220 6f72 206b 2a6e 6233 0a0a 2020 2020  2 or k*nb3..    
+00055bc0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+00055bd0: 7420 6d5f 6b3b 0a0a 2020 2020 2020 2020  t m_k;..        
+00055be0: 2020 2020 2020 2020 6966 2028 6b20 3c20          if (k < 
+00055bf0: 6e5f 6865 6164 735f 6c6f 6732 5f66 6c6f  n_heads_log2_flo
+00055c00: 6f72 2920 7b0a 2020 2020 2020 2020 2020  or) {.          
+00055c10: 2020 2020 2020 2020 2020 6d5f 6b20 3d20            m_k = 
+00055c20: 706f 7766 286d 302c 206b 202b 2031 293b  powf(m0, k + 1);
+00055c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00055c40: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+00055c50: 2020 2020 2020 2020 2020 2020 2020 6d5f                m_
+00055c60: 6b20 3d20 706f 7766 286d 312c 2032 202a  k = powf(m1, 2 *
+00055c70: 2028 6b20 2d20 6e5f 6865 6164 735f 6c6f   (k - n_heads_lo
+00055c80: 6732 5f66 6c6f 6f72 2920 2b20 3129 3b0a  g2_floor) + 1);.
+00055c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00055ca0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00055cb0: 2020 2070 6473 745b 305d 203d 2028 692d     pdst[0] = (i-
+00055cc0: 6e65 302b 3129 202a 206d 5f6b 202b 2073  ne0+1) * m_k + s
+00055cd0: 7263 5b30 5d3b 0a0a 2020 2020 2020 2020  rc[0];..        
+00055ce0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+00055cf0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+00055d00: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+00055d10: 655f 666f 7277 6172 645f 616c 6962 695f  e_forward_alibi_
+00055d20: 6631 3628 0a20 2020 2020 2020 2063 6f6e  f16(.        con
+00055d30: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00055d40: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00055d50: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00055d60: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00055d70: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00055d80: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00055d90: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00055da0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00055db0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00055dc0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00055dd0: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
+00055de0: 3e69 7468 203d 3d20 3029 3b0a 2020 2020  >ith == 0);.    
+00055df0: 6173 7365 7274 2873 7263 312d 3e74 7970  assert(src1->typ
+00055e00: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
+00055e10: 3332 293b 0a20 2020 2061 7373 6572 7428  32);.    assert(
+00055e20: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
+00055e30: 7263 3129 203d 3d20 3329 3b0a 0a20 2020  rc1) == 3);..   
+00055e40: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00055e50: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+00055e60: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
+00055e70: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00055e80: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+00055e90: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+00055ea0: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
+00055eb0: 7420 2020 6e5f 7061 7374 2020 203d 2028  t   n_past   = (
+00055ec0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+00055ed0: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+00055ee0: 636f 6e73 7420 696e 7420 2020 6e5f 6865  const int   n_he
+00055ef0: 6164 2020 203d 2028 2869 6e74 3332 5f74  ad   = ((int32_t
+00055f00: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+00055f10: 315d 3b0a 2020 2020 636f 6e73 7420 666c  1];.    const fl
+00055f20: 6f61 7420 6d61 785f 6269 6173 203d 2028  oat max_bias = (
+00055f30: 2866 6c6f 6174 202a 2920 2020 7372 6331  (float *)   src1
+00055f40: 2d3e 6461 7461 295b 325d 3b0a 0a20 2020  ->data)[2];..   
+00055f50: 2061 7373 6572 7428 6e5f 7061 7374 203e   assert(n_past >
+00055f60: 3d20 3029 3b0a 0a20 2020 2063 6f6e 7374  = 0);..    const
+00055f70: 2069 6e74 206e 6530 203d 2073 7263 302d   int ne0 = src0-
+00055f80: 3e6e 655b 305d 3b20 2f2f 2061 6c6c 5f73  >ne[0]; // all_s
+00055f90: 6571 5f6c 656e 203d 206e 5f70 6173 7420  eq_len = n_past 
+00055fa0: 2b20 6e65 310a 2020 2020 636f 6e73 7420  + ne1.    const 
+00055fb0: 696e 7420 6e65 3120 3d20 7372 6330 2d3e  int ne1 = src0->
+00055fc0: 6e65 5b31 5d3b 202f 2f20 7365 715f 6c65  ne[1]; // seq_le
+00055fd0: 6e5f 7769 7468 6f75 745f 7061 7374 0a20  n_without_past. 
+00055fe0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00055ff0: 6532 203d 2073 7263 302d 3e6e 655b 325d  e2 = src0->ne[2]
+00056000: 3b20 2f2f 206e 5f68 6561 6420 2d3e 2074  ; // n_head -> t
+00056010: 6869 7320 6973 206b 0a20 2020 202f 2f63  his is k.    //c
+00056020: 6f6e 7374 2069 6e74 206e 6533 203d 2073  onst int ne3 = s
+00056030: 7263 302d 3e6e 655b 335d 3b20 2f2f 2031  rc0->ne[3]; // 1
+00056040: 202d 3e20 6273 7a0a 0a20 2020 2063 6f6e   -> bsz..    con
+00056050: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
+00056060: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
+00056070: 2020 636f 6e73 7420 696e 7420 6e65 325f    const int ne2_
+00056080: 6e65 3320 3d20 6e2f 6e65 313b 202f 2f20  ne3 = n/ne1; // 
+00056090: 6e65 322a 6e65 330a 0a20 2020 2063 6f6e  ne2*ne3..    con
+000560a0: 7374 2069 6e74 206e 6230 203d 2073 7263  st int nb0 = src
+000560b0: 302d 3e6e 625b 305d 3b0a 2020 2020 636f  0->nb[0];.    co
+000560c0: 6e73 7420 696e 7420 6e62 3120 3d20 7372  nst int nb1 = sr
+000560d0: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+000560e0: 6f6e 7374 2069 6e74 206e 6232 203d 2073  onst int nb2 = s
+000560f0: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
+00056100: 2f2f 636f 6e73 7420 696e 7420 6e62 3320  //const int nb3 
+00056110: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
+00056120: 2020 2020 6173 7365 7274 286e 6230 203d      assert(nb0 =
+00056130: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
+00056140: 3136 5f74 2929 3b0a 2020 2020 6173 7365  16_t));.    asse
+00056150: 7274 286e 6531 202b 206e 5f70 6173 7420  rt(ne1 + n_past 
+00056160: 3d3d 206e 6530 293b 2028 766f 6964 2920  == ne0); (void) 
+00056170: 6e5f 7061 7374 3b0a 0a20 2020 202f 2f20  n_past;..    // 
+00056180: 6164 6420 616c 6962 6920 746f 2073 7263  add alibi to src
+00056190: 3020 284b 515f 7363 616c 6564 290a 2020  0 (KQ_scaled).  
+000561a0: 2020 636f 6e73 7420 696e 7420 6e5f 6865    const int n_he
+000561b0: 6164 735f 6c6f 6732 5f66 6c6f 6f72 203d  ads_log2_floor =
+000561c0: 2031 203c 3c20 2869 6e74 2920 666c 6f6f   1 << (int) floo
+000561d0: 7228 6c6f 6732 286e 5f68 6561 6429 293b  r(log2(n_head));
+000561e0: 0a0a 2020 2020 636f 6e73 7420 666c 6f61  ..    const floa
+000561f0: 7420 6d30 203d 2070 6f77 6628 322e 3066  t m0 = powf(2.0f
+00056200: 2c20 2d28 6d61 785f 6269 6173 2920 2f20  , -(max_bias) / 
+00056210: 6e5f 6865 6164 735f 6c6f 6732 5f66 6c6f  n_heads_log2_flo
+00056220: 6f72 293b 0a20 2020 2063 6f6e 7374 2066  or);.    const f
+00056230: 6c6f 6174 206d 3120 3d20 706f 7766 2832  loat m1 = powf(2
+00056240: 2e30 662c 202d 286d 6178 5f62 6961 7320  .0f, -(max_bias 
+00056250: 2f20 322e 3066 2920 2f20 6e5f 6865 6164  / 2.0f) / n_head
+00056260: 735f 6c6f 6732 5f66 6c6f 6f72 293b 0a0a  s_log2_floor);..
+00056270: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00056280: 2030 3b20 6920 3c20 6e65 303b 2069 2b2b   0; i < ne0; i++
+00056290: 2920 7b0a 2020 2020 2020 2020 666f 7220  ) {.        for 
+000562a0: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
+000562b0: 6e65 313b 206a 2b2b 2920 7b0a 2020 2020  ne1; j++) {.    
+000562c0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000562d0: 206b 203d 2030 3b20 6b20 3c20 6e65 325f   k = 0; k < ne2_
+000562e0: 6e65 333b 206b 2b2b 2920 7b0a 2020 2020  ne3; k++) {.    
+000562f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00056300: 5f66 7031 365f 7420 2a20 636f 6e73 7420  _fp16_t * const 
+00056310: 7372 6320 203d 2028 6767 6d6c 5f66 7031  src  = (ggml_fp1
+00056320: 365f 7420 2a29 2828 6368 6172 202a 2920  6_t *)((char *) 
+00056330: 7372 6330 2d3e 6461 7461 202b 2069 2a6e  src0->data + i*n
+00056340: 6230 202b 206a 2a6e 6231 202b 206b 2a6e  b0 + j*nb1 + k*n
+00056350: 6232 293b 0a20 2020 2020 2020 2020 2020  b2);.           
+00056360: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00056370: 202a 2020 2020 2020 7064 7374 2020 3d20   *      pdst  = 
+00056380: 2020 2020 2020 2866 6c6f 6174 202a 2928        (float *)(
+00056390: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+000563a0: 6174 6120 2b20 692a 6e62 3020 2b20 6a2a  ata + i*nb0 + j*
+000563b0: 6e62 3120 2b20 6b2a 6e62 3229 3b0a 0a20  nb1 + k*nb2);.. 
+000563c0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+000563d0: 2f20 544f 444f 3a20 6b2a 6e62 3220 6f72  / TODO: k*nb2 or
+000563e0: 206b 2a6e 6233 0a0a 2020 2020 2020 2020   k*nb3..        
+000563f0: 2020 2020 2020 2020 666c 6f61 7420 6d5f          float m_
+00056400: 6b3b 0a0a 2020 2020 2020 2020 2020 2020  k;..            
+00056410: 2020 2020 6966 2028 6b20 3c20 6e5f 6865      if (k < n_he
+00056420: 6164 735f 6c6f 6732 5f66 6c6f 6f72 2920  ads_log2_floor) 
+00056430: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00056440: 2020 2020 2020 6d5f 6b20 3d20 706f 7766        m_k = powf
+00056450: 286d 302c 206b 202b 2031 293b 0a20 2020  (m0, k + 1);.   
+00056460: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+00056470: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+00056480: 2020 2020 2020 2020 2020 6d5f 6b20 3d20            m_k = 
+00056490: 706f 7766 286d 312c 2032 202a 2028 6b20  powf(m1, 2 * (k 
+000564a0: 2d20 6e5f 6865 6164 735f 6c6f 6732 5f66  - n_heads_log2_f
+000564b0: 6c6f 6f72 2920 2b20 3129 3b0a 2020 2020  loor) + 1);.    
+000564c0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+000564d0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+000564e0: 2f20 7765 2072 6574 7572 6e20 4633 320a  / we return F32.
+000564f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00056500: 7064 7374 5b30 5d20 3d20 2869 2d6e 6530  pdst[0] = (i-ne0
+00056510: 2b31 2920 2a20 6d5f 6b20 2b20 4747 4d4c  +1) * m_k + GGML
+00056520: 5f46 5031 365f 544f 5f46 5033 3228 7372  _FP16_TO_FP32(sr
+00056530: 635b 305d 293b 0a20 2020 2020 2020 2020  c[0]);.         
+00056540: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+00056550: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+00056560: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00056570: 5f66 6f72 7761 7264 5f61 6c69 6269 280a  _forward_alibi(.
+00056580: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00056590: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+000565a0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+000565b0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+000565c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000565d0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+000565e0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000565f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00056600: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
+00056610: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00056620: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+00056630: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+00056640: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00056650: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+00056660: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00056670: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00056680: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00056690: 645f 616c 6962 695f 6631 3628 7061 7261  d_alibi_f16(para
+000566a0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+000566b0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+000566c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000566d0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000566e0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
+000566f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00056700: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00056710: 655f 666f 7277 6172 645f 616c 6962 695f  e_forward_alibi_
+00056720: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+00056730: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
+00056740: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00056750: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00056760: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
+00056770: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00056780: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
+00056790: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+000567a0: 5950 455f 5135 5f30 3a0a 2020 2020 2020  YPE_Q5_0:.      
+000567b0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+000567c0: 5f51 355f 313a 0a20 2020 2020 2020 2063  _Q5_1:.        c
+000567d0: 6173 6520 4747 4d4c 5f54 5950 455f 5138  ase GGML_TYPE_Q8
+000567e0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+000567f0: 2047 474d 4c5f 5459 5045 5f51 385f 313a   GGML_TYPE_Q8_1:
+00056800: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00056810: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
+00056820: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00056830: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
+00056840: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+00056850: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
+00056860: 2047 474d 4c5f 5459 5045 5f43 4f55 4e54   GGML_TYPE_COUNT
+00056870: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00056880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00056890: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000568a0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000568b0: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+000568c0: 0a0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  ...// ggml_compu
+000568d0: 7465 5f66 6f72 7761 7264 5f63 6c61 6d70  te_forward_clamp
+000568e0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+000568f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00056900: 7264 5f63 6c61 6d70 5f66 3332 280a 2020  rd_clamp_f32(.  
+00056910: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00056920: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00056930: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00056940: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00056950: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00056960: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00056970: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00056980: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00056990: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+000569a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000569b0: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
+000569c0: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
+000569d0: 2030 293b 0a20 2020 2061 7373 6572 7428   0);.    assert(
+000569e0: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
+000569f0: 4d4c 5f54 5950 455f 4933 3229 3b0a 2020  ML_TYPE_I32);.  
+00056a00: 2020 6173 7365 7274 2867 676d 6c5f 6e65    assert(ggml_ne
+00056a10: 6c65 6d65 6e74 7328 7372 6331 2920 3d3d  lements(src1) ==
+00056a20: 2032 293b 0a0a 2020 2020 6966 2028 7061   2);..    if (pa
+00056a30: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00056a40: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00056a50: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00056a60: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00056a70: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00056a80: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00056a90: 2063 6f6e 7374 2066 6c6f 6174 206d 696e   const float min
+00056aa0: 203d 2028 2866 6c6f 6174 202a 2920 7372   = ((float *) sr
+00056ab0: 6331 2d3e 6461 7461 295b 305d 3b0a 2020  c1->data)[0];.  
+00056ac0: 2020 636f 6e73 7420 666c 6f61 7420 6d61    const float ma
+00056ad0: 7820 3d20 2828 666c 6f61 7420 2a29 2073  x = ((float *) s
+00056ae0: 7263 312d 3e64 6174 6129 5b31 5d3b 0a0a  rc1->data)[1];..
+00056af0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+00056b00: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+00056b10: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00056b20: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+00056b30: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00056b40: 206e 2020 3d20 6767 6d6c 5f6e 726f 7773   n  = ggml_nrows
+00056b50: 2873 7263 3029 3b0a 2020 2020 636f 6e73  (src0);.    cons
+00056b60: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
+00056b70: 3e6e 655b 305d 3b0a 0a20 2020 2063 6f6e  >ne[0];..    con
+00056b80: 7374 2073 697a 655f 7420 6e62 3030 203d  st size_t nb00 =
+00056b90: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
+00056ba0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+00056bb0: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
+00056bc0: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+00056bd0: 7a65 5f74 206e 6230 203d 2064 7374 2d3e  ze_t nb0 = dst->
+00056be0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+00056bf0: 2073 697a 655f 7420 6e62 3120 3d20 6473   size_t nb1 = ds
+00056c00: 742d 3e6e 625b 315d 3b0a 0a20 2020 2047  t->nb[1];..    G
+00056c10: 474d 4c5f 4153 5345 5254 2820 6e62 3020  GML_ASSERT( nb0 
+00056c20: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00056c30: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00056c40: 5254 286e 6230 3020 3d3d 2073 697a 656f  RT(nb00 == sizeo
+00056c50: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00056c60: 666f 7220 2869 6e74 206a 203d 2069 7468  for (int j = ith
+00056c70: 3b20 6a20 3c20 6e3b 206a 202b 3d20 6e74  ; j < n; j += nt
+00056c80: 6829 207b 0a20 2020 2020 2020 2066 6c6f  h) {.        flo
+00056c90: 6174 202a 2064 7374 5f70 7472 2020 3d20  at * dst_ptr  = 
+00056ca0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00056cb0: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+00056cc0: 206a 2a6e 6231 293b 0a20 2020 2020 2020   j*nb1);.       
+00056cd0: 2066 6c6f 6174 202a 2073 7263 305f 7074   float * src0_pt
+00056ce0: 7220 3d20 2866 6c6f 6174 202a 2920 2828  r = (float *) ((
+00056cf0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+00056d00: 7461 202b 206a 2a6e 6230 3129 3b0a 0a20  ta + j*nb01);.. 
+00056d10: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00056d20: 6920 3d20 303b 2069 203c 206e 633b 2069  i = 0; i < nc; i
+00056d30: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00056d40: 2020 6473 745f 7074 725b 695d 203d 204d    dst_ptr[i] = M
+00056d50: 4158 284d 494e 2873 7263 305f 7074 725b  AX(MIN(src0_ptr[
+00056d60: 695d 2c20 6d61 7829 2c20 6d69 6e29 3b0a  i], max), min);.
+00056d70: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00056d80: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00056d90: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00056da0: 6172 645f 636c 616d 7028 0a20 2020 2020  ard_clamp(.     
+00056db0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00056dc0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00056dd0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00056de0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00056df0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00056e00: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00056e10: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00056e20: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00056e30: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00056e40: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00056e50: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00056e60: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00056e70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00056e80: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00056e90: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00056ea0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00056eb0: 7075 7465 5f66 6f72 7761 7264 5f63 6c61  pute_forward_cla
+00056ec0: 6d70 5f66 3332 2870 6172 616d 732c 2073  mp_f32(params, s
+00056ed0: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+00056ee0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00056ef0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00056f00: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
+00056f10: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00056f20: 474d 4c5f 5459 5045 5f51 345f 303a 0a20  GML_TYPE_Q4_0:. 
+00056f30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00056f40: 5f54 5950 455f 5134 5f31 3a0a 2020 2020  _TYPE_Q4_1:.    
+00056f50: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00056f60: 5045 5f51 355f 303a 0a20 2020 2020 2020  PE_Q5_0:.       
+00056f70: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00056f80: 5135 5f31 3a0a 2020 2020 2020 2020 6361  Q5_1:.        ca
+00056f90: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
+00056fa0: 303a 0a20 2020 2020 2020 2063 6173 6520  0:.        case 
+00056fb0: 4747 4d4c 5f54 5950 455f 5138 5f31 3a0a  GGML_TYPE_Q8_1:.
+00056fc0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00056fd0: 4c5f 5459 5045 5f49 383a 0a20 2020 2020  L_TYPE_I8:.     
+00056fe0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00056ff0: 455f 4931 363a 0a20 2020 2020 2020 2063  E_I16:.        c
+00057000: 6173 6520 4747 4d4c 5f54 5950 455f 4933  ase GGML_TYPE_I3
+00057010: 323a 0a20 2020 2020 2020 2063 6173 6520  2:.        case 
+00057020: 4747 4d4c 5f54 5950 455f 434f 554e 543a  GGML_TYPE_COUNT:
+00057030: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00057040: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00057050: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00057060: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00057070: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+00057080: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+00057090: 5f66 6f72 7761 7264 5f72 6f70 650a 0a73  _forward_rope..s
+000570a0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+000570b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000570c0: 726f 7065 5f66 3332 280a 2020 2020 2020  rope_f32(.      
+000570d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000570e0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000570f0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00057100: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00057110: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00057120: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+00057130: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00057140: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00057150: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00057160: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00057170: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+00057180: 5254 2873 7263 312d 3e74 7970 6520 3d3d  RT(src1->type ==
+00057190: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+000571a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000571b0: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
+000571c0: 7372 6331 2920 3d3d 2033 293b 0a0a 2020  src1) == 3);..  
+000571d0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+000571e0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000571f0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+00057200: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00057210: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+00057220: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+00057230: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+00057240: 6e74 206e 5f70 6173 7420 3d20 2828 696e  nt n_past = ((in
+00057250: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
+00057260: 6174 6129 5b30 5d3b 0a20 2020 2063 6f6e  ata)[0];.    con
+00057270: 7374 2069 6e74 206e 5f64 696d 7320 3d20  st int n_dims = 
+00057280: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+00057290: 312d 3e64 6174 6129 5b31 5d3b 0a20 2020  1->data)[1];.   
+000572a0: 2063 6f6e 7374 2069 6e74 206d 6f64 6520   const int mode 
+000572b0: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
+000572c0: 2073 7263 312d 3e64 6174 6129 5b32 5d3b   src1->data)[2];
+000572d0: 0a0a 2020 2020 6173 7365 7274 286e 5f70  ..    assert(n_p
+000572e0: 6173 7420 3e3d 2030 293b 0a0a 2020 2020  ast >= 0);..    
+000572f0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+00057300: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
+00057310: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+00057320: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+00057330: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+00057340: 7369 7a65 5f74 206e 6230 3220 3d20 7372  size_t nb02 = sr
+00057350: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
+00057360: 6f6e 7374 2073 697a 655f 7420 6e62 3033  onst size_t nb03
+00057370: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
+00057380: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00057390: 5f74 206e 6530 203d 2064 7374 2d3e 6e65  _t ne0 = dst->ne
+000573a0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+000573b0: 6e74 3634 5f74 206e 6531 203d 2064 7374  nt64_t ne1 = dst
+000573c0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+000573d0: 7374 2069 6e74 3634 5f74 206e 6532 203d  st int64_t ne2 =
+000573e0: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
+000573f0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00057400: 6533 203d 2064 7374 2d3e 6e65 5b33 5d3b  e3 = dst->ne[3];
+00057410: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+00057420: 5f74 206e 6230 203d 2064 7374 2d3e 6e62  _t nb0 = dst->nb
+00057430: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
+00057440: 697a 655f 7420 6e62 3120 3d20 6473 742d  ize_t nb1 = dst-
+00057450: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00057460: 7420 7369 7a65 5f74 206e 6232 203d 2064  t size_t nb2 = d
+00057470: 7374 2d3e 6e62 5b32 5d3b 0a20 2020 2063  st->nb[2];.    c
+00057480: 6f6e 7374 2073 697a 655f 7420 6e62 3320  onst size_t nb3 
+00057490: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
+000574a0: 2020 202f 2f70 7269 6e74 6628 226e 6530     //printf("ne0
+000574b0: 3a20 2564 2c20 6e65 313a 2025 642c 206e  : %d, ne1: %d, n
+000574c0: 6532 3a20 2564 2c20 6e65 333a 2025 645c  e2: %d, ne3: %d\
+000574d0: 6e22 2c20 6e65 302c 206e 6531 2c20 6e65  n", ne0, ne1, ne
+000574e0: 322c 206e 6533 293b 0a20 2020 202f 2f70  2, ne3);.    //p
+000574f0: 7269 6e74 6628 226e 5f70 6173 7420 3d20  rintf("n_past = 
+00057500: 2564 2c20 6e65 3220 3d20 2564 5c6e 222c  %d, ne2 = %d\n",
+00057510: 206e 5f70 6173 742c 206e 6532 293b 0a0a   n_past, ne2);..
+00057520: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00057530: 6e62 3030 203d 3d20 7369 7a65 6f66 2866  nb00 == sizeof(f
+00057540: 6c6f 6174 2929 3b0a 0a20 2020 2063 6f6e  loat));..    con
+00057550: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00057560: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00057570: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00057580: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00057590: 636f 6e73 7420 696e 7420 6e72 203d 2067  const int nr = g
+000575a0: 676d 6c5f 6e72 6f77 7328 6473 7429 3b0a  gml_nrows(dst);.
+000575b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000575c0: 286e 5f64 696d 7320 3c3d 206e 6530 293b  (n_dims <= ne0);
+000575d0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000575e0: 286e 5f64 696d 7320 2520 3220 3d3d 2030  (n_dims % 2 == 0
+000575f0: 293b 0a0a 2020 2020 2f2f 2072 6f77 7320  );..    // rows 
+00057600: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
+00057610: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
+00057620: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
+00057630: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
+00057640: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
+00057650: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+00057660: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
+00057670: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+00057680: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
+00057690: 2c20 6e72 293b 0a0a 2020 2020 2f2f 2072  , nr);..    // r
+000576a0: 6f77 2069 6e64 6578 2075 7365 6420 746f  ow index used to
+000576b0: 2064 6574 6572 6d69 6e65 2077 6869 6368   determine which
+000576c0: 2074 6872 6561 6420 746f 2075 7365 0a20   thread to use. 
+000576d0: 2020 2069 6e74 2069 7220 3d20 303b 0a0a     int ir = 0;..
+000576e0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+000576f0: 7468 6574 615f 7363 616c 6520 3d20 706f  theta_scale = po
+00057700: 7766 2831 3030 3030 2e30 2c20 2d32 2e30  wf(10000.0, -2.0
+00057710: 662f 6e5f 6469 6d73 293b 0a0a 2020 2020  f/n_dims);..    
+00057720: 636f 6e73 7420 626f 6f6c 2069 735f 6e65  const bool is_ne
+00057730: 6f78 203d 206d 6f64 6520 2620 323b 0a0a  ox = mode & 2;..
+00057740: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00057750: 2069 3320 3d20 303b 2069 3320 3c20 6e65   i3 = 0; i3 < ne
+00057760: 333b 2069 332b 2b29 207b 0a20 2020 2020  3; i3++) {.     
+00057770: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00057780: 6932 203d 2028 286d 6f64 6520 2620 3129  i2 = ((mode & 1)
+00057790: 203d 3d20 3020 3f20 3020 3a20 6e5f 7061   == 0 ? 0 : n_pa
+000577a0: 7374 293b 2069 3220 3c20 6e65 323b 2069  st); i2 < ne2; i
+000577b0: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+000577c0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000577d0: 2070 203d 2028 286d 6f64 6520 2620 3129   p = ((mode & 1)
+000577e0: 203d 3d20 3020 3f20 6e5f 7061 7374 202b   == 0 ? n_past +
+000577f0: 2069 3220 3a20 6932 293b 0a20 2020 2020   i2 : i2);.     
+00057800: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00057810: 345f 7420 6931 203d 2030 3b20 6931 203c  4_t i1 = 0; i1 <
+00057820: 206e 6531 3b20 6931 2b2b 2920 7b0a 2020   ne1; i1++) {.  
+00057830: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00057840: 2028 6972 2b2b 203c 2069 7230 2920 636f   (ir++ < ir0) co
+00057850: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
+00057860: 2020 2020 2020 2020 6966 2028 6972 2020          if (ir  
+00057870: 203e 2069 7231 2920 6272 6561 6b3b 0a0a   > ir1) break;..
+00057880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057890: 666c 6f61 7420 7468 6574 6120 3d20 2866  float theta = (f
+000578a0: 6c6f 6174 2970 3b0a 0a20 2020 2020 2020  loat)p;..       
+000578b0: 2020 2020 2020 2020 2069 6620 2821 6973           if (!is
+000578c0: 5f6e 656f 7829 207b 0a20 2020 2020 2020  _neox) {.       
+000578d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000578e0: 2028 696e 7436 345f 7420 6930 203d 2030   (int64_t i0 = 0
+000578f0: 3b20 6930 203c 206e 6530 3b20 6930 202b  ; i0 < ne0; i0 +
+00057900: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
+00057910: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00057920: 6f6e 7374 2066 6c6f 6174 2063 6f73 5f74  onst float cos_t
+00057930: 6865 7461 203d 2063 6f73 6628 7468 6574  heta = cosf(thet
+00057940: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+00057950: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00057960: 7420 666c 6f61 7420 7369 6e5f 7468 6574  t float sin_thet
+00057970: 6120 3d20 7369 6e66 2874 6865 7461 293b  a = sinf(theta);
+00057980: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00057990: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+000579a0: 2a3d 2074 6865 7461 5f73 6361 6c65 3b0a  *= theta_scale;.
+000579b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000579c0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+000579d0: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
+000579e0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+000579f0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00057a00: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
+00057a10: 6e62 3032 202b 2069 312a 6e62 3031 202b  nb02 + i1*nb01 +
+00057a20: 2069 302a 6e62 3030 293b 0a20 2020 2020   i0*nb00);.     
 00057a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057a40: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
-00057a50: 6461 7461 2020 3d20 2866 6c6f 6174 202a  data  = (float *
-00057a60: 2928 2863 6861 7220 2a29 2020 6473 742d  )((char *)  dst-
-00057a70: 3e64 6174 6120 2b20 2069 332a 6e62 3320  >data +  i3*nb3 
-00057a80: 2b20 6932 2a6e 6232 2020 2b20 6931 2a6e  + i2*nb2  + i1*n
-00057a90: 6231 2020 2b20 6930 2a6e 6230 293b 0a0a  b1  + i0*nb0);..
-00057aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057ab0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00057ac0: 6f61 7420 7830 203d 2073 7263 5b30 5d3b  oat x0 = src[0];
-00057ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00057ae0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-00057af0: 6c6f 6174 2078 3120 3d20 7372 635b 315d  loat x1 = src[1]
-00057b00: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00057b10: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
-00057b20: 6174 615b 305d 203d 2078 302a 636f 735f  ata[0] = x0*cos_
-00057b30: 7468 6574 6120 2d20 7831 2a73 696e 5f74  theta - x1*sin_t
-00057b40: 6865 7461 3b0a 2020 2020 2020 2020 2020  heta;.          
-00057b50: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-00057b60: 745f 6461 7461 5b31 5d20 3d20 7830 2a73  t_data[1] = x0*s
-00057b70: 696e 5f74 6865 7461 202b 2078 312a 636f  in_theta + x1*co
-00057b80: 735f 7468 6574 613b 0a20 2020 2020 2020  s_theta;.       
-00057b90: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00057ba0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00057bb0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-00057bc0: 2020 2020 2020 2020 2020 2020 2f2f 2054              // T
-00057bd0: 4f44 4f3a 2074 6869 7320 6973 2070 726f  ODO: this is pro
-00057be0: 6261 626c 7920 7772 6f6e 672c 2062 7574  bably wrong, but
-00057bf0: 2049 2063 616e 2774 2066 6967 7572 6520   I can't figure 
-00057c00: 6974 206f 7574 202e 2e0a 2020 2020 2020  it out ...      
-00057c10: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00057c20: 2072 6566 3a20 2068 7474 7073 3a2f 2f67   ref:  https://g
-00057c30: 6974 6875 622e 636f 6d2f 6875 6767 696e  ithub.com/huggin
-00057c40: 6766 6163 652f 7472 616e 7366 6f72 6d65  gface/transforme
-00057c50: 7273 2f62 6c6f 622f 6d61 696e 2f73 7263  rs/blob/main/src
-00057c60: 2f74 7261 6e73 666f 726d 6572 732f 6d6f  /transformers/mo
-00057c70: 6465 6c73 2f67 7074 5f6e 656f 782f 6d6f  dels/gpt_neox/mo
-00057c80: 6465 6c69 6e67 5f67 7074 5f6e 656f 782e  deling_gpt_neox.
-00057c90: 7079 234c 4c32 3531 4331 2d4c 3239 3443  py#LL251C1-L294C
-00057ca0: 3238 0a20 2020 2020 2020 2020 2020 2020  28.             
-00057cb0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00057cc0: 345f 7420 6962 203d 2030 3b20 6962 203c  4_t ib = 0; ib <
-00057cd0: 206e 6530 2f6e 5f64 696d 733b 202b 2b69   ne0/n_dims; ++i
-00057ce0: 6229 207b 0a20 2020 2020 2020 2020 2020  b) {.           
-00057cf0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00057d00: 2028 696e 7436 345f 7420 6963 203d 2030   (int64_t ic = 0
-00057d10: 3b20 6963 203c 206e 5f64 696d 733b 2069  ; ic < n_dims; i
-00057d20: 6320 2b3d 2032 2920 7b0a 2020 2020 2020  c += 2) {.      
+00057a40: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+00057a50: 2064 7374 5f64 6174 6120 203d 2028 666c   dst_data  = (fl
+00057a60: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+00057a70: 2064 7374 2d3e 6461 7461 202b 2020 6933   dst->data +  i3
+00057a80: 2a6e 6233 202b 2069 322a 6e62 3220 202b  *nb3 + i2*nb2  +
+00057a90: 2069 312a 6e62 3120 202b 2069 302a 6e62   i1*nb1  + i0*nb
+00057aa0: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
+00057ab0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00057ac0: 7374 2066 6c6f 6174 2078 3020 3d20 7372  st float x0 = sr
+00057ad0: 635b 305d 3b0a 2020 2020 2020 2020 2020  c[0];.          
+00057ae0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00057af0: 6e73 7420 666c 6f61 7420 7831 203d 2073  nst float x1 = s
+00057b00: 7263 5b31 5d3b 0a0a 2020 2020 2020 2020  rc[1];..        
+00057b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057b20: 6473 745f 6461 7461 5b30 5d20 3d20 7830  dst_data[0] = x0
+00057b30: 2a63 6f73 5f74 6865 7461 202d 2078 312a  *cos_theta - x1*
+00057b40: 7369 6e5f 7468 6574 613b 0a20 2020 2020  sin_theta;.     
+00057b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057b60: 2020 2064 7374 5f64 6174 615b 315d 203d     dst_data[1] =
+00057b70: 2078 302a 7369 6e5f 7468 6574 6120 2b20   x0*sin_theta + 
+00057b80: 7831 2a63 6f73 5f74 6865 7461 3b0a 2020  x1*cos_theta;.  
+00057b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057ba0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00057bb0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00057bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057bd0: 202f 2f20 544f 444f 3a20 7468 6973 2069   // TODO: this i
+00057be0: 7320 7072 6f62 6162 6c79 2077 726f 6e67  s probably wrong
+00057bf0: 2c20 6275 7420 4920 6361 6e27 7420 6669  , but I can't fi
+00057c00: 6775 7265 2069 7420 6f75 7420 2e2e 0a20  gure it out ... 
+00057c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057c20: 2020 202f 2f20 7265 663a 2020 6874 7470     // ref:  http
+00057c30: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f68  s://github.com/h
+00057c40: 7567 6769 6e67 6661 6365 2f74 7261 6e73  uggingface/trans
+00057c50: 666f 726d 6572 732f 626c 6f62 2f6d 6169  formers/blob/mai
+00057c60: 6e2f 7372 632f 7472 616e 7366 6f72 6d65  n/src/transforme
+00057c70: 7273 2f6d 6f64 656c 732f 6770 745f 6e65  rs/models/gpt_ne
+00057c80: 6f78 2f6d 6f64 656c 696e 675f 6770 745f  ox/modeling_gpt_
+00057c90: 6e65 6f78 2e70 7923 4c4c 3235 3143 312d  neox.py#LL251C1-
+00057ca0: 4c32 3934 4332 380a 2020 2020 2020 2020  L294C28.        
+00057cb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00057cc0: 2869 6e74 3634 5f74 2069 6220 3d20 303b  (int64_t ib = 0;
+00057cd0: 2069 6220 3c20 6e65 302f 6e5f 6469 6d73   ib < ne0/n_dims
+00057ce0: 3b20 2b2b 6962 2920 7b0a 2020 2020 2020  ; ++ib) {.      
+00057cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057d00: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+00057d10: 6320 3d20 303b 2069 6320 3c20 6e5f 6469  c = 0; ic < n_di
+00057d20: 6d73 3b20 6963 202b 3d20 3229 207b 0a20  ms; ic += 2) {. 
 00057d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057d40: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-00057d50: 7420 636f 735f 7468 6574 6120 3d20 636f  t cos_theta = co
-00057d60: 7366 2874 6865 7461 293b 0a20 2020 2020  sf(theta);.     
+00057d40: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00057d50: 2066 6c6f 6174 2063 6f73 5f74 6865 7461   float cos_theta
+00057d60: 203d 2063 6f73 6628 7468 6574 6129 3b0a   = cosf(theta);.
 00057d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057d80: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-00057d90: 6174 2073 696e 5f74 6865 7461 203d 2073  at sin_theta = s
-00057da0: 696e 6628 7468 6574 6129 3b0a 0a20 2020  inf(theta);..   
-00057db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057dc0: 2020 2020 2020 2020 2074 6865 7461 202a           theta *
-00057dd0: 3d20 7468 6574 615f 7363 616c 653b 0a0a  = theta_scale;..
-00057de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057df0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00057e00: 7420 696e 7436 345f 7420 6930 203d 2069  t int64_t i0 = i
-00057e10: 622a 6e5f 6469 6d73 202b 2069 632f 323b  b*n_dims + ic/2;
-00057e20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00057e30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00057e40: 6e73 7420 666c 6f61 7420 2a20 636f 6e73  nst float * cons
-00057e50: 7420 7372 6320 3d20 2866 6c6f 6174 202a  t src = (float *
-00057e60: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
-00057e70: 3e64 6174 6120 2b20 6933 2a6e 6230 3320  >data + i3*nb03 
-00057e80: 2b20 6932 2a6e 6230 3220 2b20 6931 2a6e  + i2*nb02 + i1*n
-00057e90: 6230 3120 2b20 6930 2a6e 6230 3029 3b0a  b01 + i0*nb00);.
-00057ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057d80: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00057d90: 7420 666c 6f61 7420 7369 6e5f 7468 6574  t float sin_thet
+00057da0: 6120 3d20 7369 6e66 2874 6865 7461 293b  a = sinf(theta);
+00057db0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00057dc0: 2020 2020 2020 2020 2020 2020 2020 7468                th
+00057dd0: 6574 6120 2a3d 2074 6865 7461 5f73 6361  eta *= theta_sca
+00057de0: 6c65 3b0a 0a20 2020 2020 2020 2020 2020  le;..           
+00057df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057e00: 2063 6f6e 7374 2069 6e74 3634 5f74 2069   const int64_t i
+00057e10: 3020 3d20 6962 2a6e 5f64 696d 7320 2b20  0 = ib*n_dims + 
+00057e20: 6963 2f32 3b0a 0a20 2020 2020 2020 2020  ic/2;..         
+00057e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057e40: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
+00057e50: 2063 6f6e 7374 2073 7263 203d 2028 666c   const src = (fl
+00057e60: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+00057e70: 7372 6330 2d3e 6461 7461 202b 2069 332a  src0->data + i3*
+00057e80: 6e62 3033 202b 2069 322a 6e62 3032 202b  nb03 + i2*nb02 +
+00057e90: 2069 312a 6e62 3031 202b 2069 302a 6e62   i1*nb01 + i0*nb
+00057ea0: 3030 293b 0a20 2020 2020 2020 2020 2020  00);.           
 00057eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057ec0: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
-00057ed0: 7461 2020 3d20 2866 6c6f 6174 202a 2928  ta  = (float *)(
-00057ee0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
-00057ef0: 6174 6120 2b20 2069 332a 6e62 3320 2b20  ata +  i3*nb3 + 
-00057f00: 6932 2a6e 6232 2020 2b20 6931 2a6e 6231  i2*nb2  + i1*nb1
-00057f10: 2020 2b20 6930 2a6e 6230 293b 0a0a 2020    + i0*nb0);..  
-00057f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057f30: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00057f40: 666c 6f61 7420 7830 203d 2073 7263 5b30  float x0 = src[0
-00057f50: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-00057f60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00057f70: 6f6e 7374 2066 6c6f 6174 2078 3120 3d20  onst float x1 = 
-00057f80: 7372 635b 6e5f 6469 6d73 2f32 5d3b 0a0a  src[n_dims/2];..
-00057f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057fa0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-00057fb0: 6461 7461 5b30 5d20 2020 2020 2020 203d  data[0]        =
-00057fc0: 2078 302a 636f 735f 7468 6574 6120 2d20   x0*cos_theta - 
-00057fd0: 7831 2a73 696e 5f74 6865 7461 3b0a 2020  x1*sin_theta;.  
-00057fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057ff0: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
-00058000: 7461 5b6e 5f64 696d 732f 325d 203d 2078  ta[n_dims/2] = x
-00058010: 302a 7369 6e5f 7468 6574 6120 2b20 7831  0*sin_theta + x1
-00058020: 2a63 6f73 5f74 6865 7461 3b0a 2020 2020  *cos_theta;.    
-00058030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058040: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00058050: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00058060: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00058070: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00058080: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-00058090: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-000580a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000580b0: 726f 7065 5f66 3136 280a 2020 2020 2020  rope_f16(.      
-000580c0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000580d0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-000580e0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-000580f0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00058100: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00058110: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00058120: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00058130: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00058140: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00058150: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00058160: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-00058170: 5254 2873 7263 312d 3e74 7970 6520 3d3d  RT(src1->type ==
-00058180: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
-00058190: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000581a0: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
-000581b0: 7372 6331 2920 3d3d 2033 293b 0a0a 2020  src1) == 3);..  
-000581c0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-000581d0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-000581e0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-000581f0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00058200: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-00058210: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00058220: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
-00058230: 6e74 206e 5f70 6173 7420 3d20 2828 696e  nt n_past = ((in
-00058240: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
-00058250: 6174 6129 5b30 5d3b 0a20 2020 2063 6f6e  ata)[0];.    con
-00058260: 7374 2069 6e74 206e 5f64 696d 7320 3d20  st int n_dims = 
-00058270: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
-00058280: 312d 3e64 6174 6129 5b31 5d3b 0a20 2020  1->data)[1];.   
-00058290: 2063 6f6e 7374 2069 6e74 206d 6f64 6520   const int mode 
-000582a0: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
-000582b0: 2073 7263 312d 3e64 6174 6129 5b32 5d3b   src1->data)[2];
-000582c0: 0a0a 2020 2020 6173 7365 7274 286e 5f70  ..    assert(n_p
-000582d0: 6173 7420 3e3d 2030 293b 0a0a 2020 2020  ast >= 0);..    
-000582e0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-000582f0: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
-00058300: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00058310: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
-00058320: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
-00058330: 7369 7a65 5f74 206e 6230 3220 3d20 7372  size_t nb02 = sr
-00058340: 6330 2d3e 6e62 5b32 5d3b 0a20 2020 2063  c0->nb[2];.    c
-00058350: 6f6e 7374 2073 697a 655f 7420 6e62 3033  onst size_t nb03
-00058360: 203d 2073 7263 302d 3e6e 625b 335d 3b0a   = src0->nb[3];.
-00058370: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00058380: 5f74 206e 6530 203d 2064 7374 2d3e 6e65  _t ne0 = dst->ne
-00058390: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-000583a0: 6e74 3634 5f74 206e 6531 203d 2064 7374  nt64_t ne1 = dst
-000583b0: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
-000583c0: 7374 2069 6e74 3634 5f74 206e 6532 203d  st int64_t ne2 =
-000583d0: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
-000583e0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-000583f0: 6533 203d 2064 7374 2d3e 6e65 5b33 5d3b  e3 = dst->ne[3];
-00058400: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
-00058410: 5f74 206e 6230 203d 2064 7374 2d3e 6e62  _t nb0 = dst->nb
-00058420: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2073  [0];.    const s
-00058430: 697a 655f 7420 6e62 3120 3d20 6473 742d  ize_t nb1 = dst-
-00058440: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
-00058450: 7420 7369 7a65 5f74 206e 6232 203d 2064  t size_t nb2 = d
-00058460: 7374 2d3e 6e62 5b32 5d3b 0a20 2020 2063  st->nb[2];.    c
-00058470: 6f6e 7374 2073 697a 655f 7420 6e62 3320  onst size_t nb3 
-00058480: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
-00058490: 2020 202f 2f70 7269 6e74 6628 226e 6530     //printf("ne0
-000584a0: 3a20 2564 2c20 6e65 313a 2025 642c 206e  : %d, ne1: %d, n
-000584b0: 6532 3a20 2564 2c20 6e65 333a 2025 645c  e2: %d, ne3: %d\
-000584c0: 6e22 2c20 6e65 302c 206e 6531 2c20 6e65  n", ne0, ne1, ne
-000584d0: 322c 206e 6533 293b 0a20 2020 202f 2f70  2, ne3);.    //p
-000584e0: 7269 6e74 6628 226e 5f70 6173 7420 3d20  rintf("n_past = 
-000584f0: 2564 2c20 6e65 3220 3d20 2564 5c6e 222c  %d, ne2 = %d\n",
-00058500: 206e 5f70 6173 742c 206e 6532 293b 0a0a   n_past, ne2);..
-00058510: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00058520: 6e62 3020 3d3d 2073 697a 656f 6628 6767  nb0 == sizeof(gg
-00058530: 6d6c 5f66 7031 365f 7429 293b 0a0a 2020  ml_fp16_t));..  
-00058540: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-00058550: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-00058560: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-00058570: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-00058580: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00058590: 7220 3d20 6767 6d6c 5f6e 726f 7773 2864  r = ggml_nrows(d
-000585a0: 7374 293b 0a0a 2020 2020 4747 4d4c 5f41  st);..    GGML_A
-000585b0: 5353 4552 5428 6e5f 6469 6d73 203c 3d20  SSERT(n_dims <= 
-000585c0: 6e65 3029 3b0a 2020 2020 4747 4d4c 5f41  ne0);.    GGML_A
-000585d0: 5353 4552 5428 6e5f 6469 6d73 2025 2032  SSERT(n_dims % 2
-000585e0: 203d 3d20 3029 3b0a 0a20 2020 202f 2f20   == 0);..    // 
-000585f0: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
-00058600: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
-00058610: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
-00058620: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
-00058630: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
-00058640: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
-00058650: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
-00058660: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-00058670: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
-00058680: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
-00058690: 202f 2f20 726f 7720 696e 6465 7820 7573   // row index us
-000586a0: 6564 2074 6f20 6465 7465 726d 696e 6520  ed to determine 
-000586b0: 7768 6963 6820 7468 7265 6164 2074 6f20  which thread to 
-000586c0: 7573 650a 2020 2020 696e 7420 6972 203d  use.    int ir =
-000586d0: 2030 3b0a 0a20 2020 2063 6f6e 7374 2066   0;..    const f
-000586e0: 6c6f 6174 2074 6865 7461 5f73 6361 6c65  loat theta_scale
-000586f0: 203d 2070 6f77 6628 3130 3030 302e 302c   = powf(10000.0,
-00058700: 202d 322e 3066 2f6e 5f64 696d 7329 3b0a   -2.0f/n_dims);.
-00058710: 0a20 2020 2063 6f6e 7374 2062 6f6f 6c20  .    const bool 
-00058720: 6973 5f6e 656f 7820 3d20 6d6f 6465 2026  is_neox = mode &
-00058730: 2032 3b0a 0a20 2020 2066 6f72 2028 696e   2;..    for (in
-00058740: 7436 345f 7420 6933 203d 2030 3b20 6933  t64_t i3 = 0; i3
-00058750: 203c 206e 6533 3b20 6933 2b2b 2920 7b0a   < ne3; i3++) {.
-00058760: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00058770: 3634 5f74 2069 3220 3d20 2828 6d6f 6465  64_t i2 = ((mode
-00058780: 2026 2031 2920 3d3d 2030 203f 2030 203a   & 1) == 0 ? 0 :
-00058790: 206e 5f70 6173 7429 3b20 6932 203c 206e   n_past); i2 < n
-000587a0: 6532 3b20 6932 2b2b 2920 7b0a 2020 2020  e2; i2++) {.    
-000587b0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000587c0: 7436 345f 7420 7020 3d20 2828 6d6f 6465  t64_t p = ((mode
-000587d0: 2026 2031 2920 3d3d 2030 203f 206e 5f70   & 1) == 0 ? n_p
-000587e0: 6173 7420 2b20 6932 203a 2069 3229 3b0a  ast + i2 : i2);.
-000587f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00058800: 2869 6e74 3634 5f74 2069 3120 3d20 303b  (int64_t i1 = 0;
-00058810: 2069 3120 3c20 6e65 313b 2069 312b 2b29   i1 < ne1; i1++)
-00058820: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00058830: 2020 2069 6620 2869 722b 2b20 3c20 6972     if (ir++ < ir
-00058840: 3029 2063 6f6e 7469 6e75 653b 0a20 2020  0) continue;.   
-00058850: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00058860: 2869 7220 2020 3e20 6972 3129 2062 7265  (ir   > ir1) bre
-00058870: 616b 3b0a 0a20 2020 2020 2020 2020 2020  ak;..           
-00058880: 2020 2020 2066 6c6f 6174 2074 6865 7461       float theta
-00058890: 203d 2028 666c 6f61 7429 703b 0a0a 2020   = (float)p;..  
-000588a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000588b0: 2028 2169 735f 6e65 6f78 2920 7b0a 2020   (!is_neox) {.  
-000588c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000588d0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-000588e0: 3020 3d20 303b 2069 3020 3c20 6e65 303b  0 = 0; i0 < ne0;
-000588f0: 2069 3020 2b3d 2032 2920 7b0a 2020 2020   i0 += 2) {.    
-00058900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058910: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00058920: 636f 735f 7468 6574 6120 3d20 636f 7366  cos_theta = cosf
-00058930: 2874 6865 7461 293b 0a20 2020 2020 2020  (theta);.       
+00057ec0: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
+00057ed0: 7374 5f64 6174 6120 203d 2028 666c 6f61  st_data  = (floa
+00057ee0: 7420 2a29 2828 6368 6172 202a 2920 2064  t *)((char *)  d
+00057ef0: 7374 2d3e 6461 7461 202b 2020 6933 2a6e  st->data +  i3*n
+00057f00: 6233 202b 2069 322a 6e62 3220 202b 2069  b3 + i2*nb2  + i
+00057f10: 312a 6e62 3120 202b 2069 302a 6e62 3029  1*nb1  + i0*nb0)
+00057f20: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00057f30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00057f40: 6f6e 7374 2066 6c6f 6174 2078 3020 3d20  onst float x0 = 
+00057f50: 7372 635b 305d 3b0a 2020 2020 2020 2020  src[0];.        
+00057f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057f70: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00057f80: 7831 203d 2073 7263 5b6e 5f64 696d 732f  x1 = src[n_dims/
+00057f90: 325d 3b0a 0a20 2020 2020 2020 2020 2020  2];..           
+00057fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057fb0: 2064 7374 5f64 6174 615b 305d 2020 2020   dst_data[0]    
+00057fc0: 2020 2020 3d20 7830 2a63 6f73 5f74 6865      = x0*cos_the
+00057fd0: 7461 202d 2078 312a 7369 6e5f 7468 6574  ta - x1*sin_thet
+00057fe0: 613b 0a20 2020 2020 2020 2020 2020 2020  a;.             
+00057ff0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00058000: 7374 5f64 6174 615b 6e5f 6469 6d73 2f32  st_data[n_dims/2
+00058010: 5d20 3d20 7830 2a73 696e 5f74 6865 7461  ] = x0*sin_theta
+00058020: 202b 2078 312a 636f 735f 7468 6574 613b   + x1*cos_theta;
+00058030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00058040: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00058050: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00058060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00058070: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00058080: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00058090: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+000580a0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000580b0: 7761 7264 5f72 6f70 655f 6631 3628 0a20  ward_rope_f16(. 
+000580c0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000580d0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000580e0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000580f0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00058100: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00058110: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00058120: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00058130: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00058140: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+00058150: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00058160: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+00058170: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
+00058180: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00058190: 4933 3229 3b0a 2020 2020 4747 4d4c 5f41  I32);.    GGML_A
+000581a0: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
+000581b0: 656e 7473 2873 7263 3129 203d 3d20 3329  ents(src1) == 3)
+000581c0: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+000581d0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000581e0: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+000581f0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00058200: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+00058210: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+00058220: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
+00058230: 6e73 7420 696e 7420 6e5f 7061 7374 203d  nst int n_past =
+00058240: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+00058250: 6331 2d3e 6461 7461 295b 305d 3b0a 2020  c1->data)[0];.  
+00058260: 2020 636f 6e73 7420 696e 7420 6e5f 6469    const int n_di
+00058270: 6d73 203d 2028 2869 6e74 3332 5f74 202a  ms = ((int32_t *
+00058280: 2920 7372 6331 2d3e 6461 7461 295b 315d  ) src1->data)[1]
+00058290: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000582a0: 6d6f 6465 2020 203d 2028 2869 6e74 3332  mode   = ((int32
+000582b0: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+000582c0: 295b 325d 3b0a 0a20 2020 2061 7373 6572  )[2];..    asser
+000582d0: 7428 6e5f 7061 7374 203e 3d20 3029 3b0a  t(n_past >= 0);.
+000582e0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+000582f0: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+00058300: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00058310: 7369 7a65 5f74 206e 6230 3120 3d20 7372  size_t nb01 = sr
+00058320: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+00058330: 6f6e 7374 2073 697a 655f 7420 6e62 3032  onst size_t nb02
+00058340: 203d 2073 7263 302d 3e6e 625b 325d 3b0a   = src0->nb[2];.
+00058350: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00058360: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
+00058370: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+00058380: 696e 7436 345f 7420 6e65 3020 3d20 6473  int64_t ne0 = ds
+00058390: 742d 3e6e 655b 305d 3b0a 2020 2020 636f  t->ne[0];.    co
+000583a0: 6e73 7420 696e 7436 345f 7420 6e65 3120  nst int64_t ne1 
+000583b0: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
+000583c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000583d0: 6e65 3220 3d20 6473 742d 3e6e 655b 325d  ne2 = dst->ne[2]
+000583e0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+000583f0: 345f 7420 6e65 3320 3d20 6473 742d 3e6e  4_t ne3 = dst->n
+00058400: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
+00058410: 2073 697a 655f 7420 6e62 3020 3d20 6473   size_t nb0 = ds
+00058420: 742d 3e6e 625b 305d 3b0a 2020 2020 636f  t->nb[0];.    co
+00058430: 6e73 7420 7369 7a65 5f74 206e 6231 203d  nst size_t nb1 =
+00058440: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
+00058450: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00058460: 3220 3d20 6473 742d 3e6e 625b 325d 3b0a  2 = dst->nb[2];.
+00058470: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+00058480: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
+00058490: 5d3b 0a0a 2020 2020 2f2f 7072 696e 7466  ];..    //printf
+000584a0: 2822 6e65 303a 2025 642c 206e 6531 3a20  ("ne0: %d, ne1: 
+000584b0: 2564 2c20 6e65 323a 2025 642c 206e 6533  %d, ne2: %d, ne3
+000584c0: 3a20 2564 5c6e 222c 206e 6530 2c20 6e65  : %d\n", ne0, ne
+000584d0: 312c 206e 6532 2c20 6e65 3329 3b0a 2020  1, ne2, ne3);.  
+000584e0: 2020 2f2f 7072 696e 7466 2822 6e5f 7061    //printf("n_pa
+000584f0: 7374 203d 2025 642c 206e 6532 203d 2025  st = %d, ne2 = %
+00058500: 645c 6e22 2c20 6e5f 7061 7374 2c20 6e65  d\n", n_past, ne
+00058510: 3229 3b0a 0a20 2020 2047 474d 4c5f 4153  2);..    GGML_AS
+00058520: 5345 5254 286e 6230 203d 3d20 7369 7a65  SERT(nb0 == size
+00058530: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+00058540: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00058550: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+00058560: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00058570: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+00058580: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+00058590: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
+000585a0: 6f77 7328 6473 7429 3b0a 0a20 2020 2047  ows(dst);..    G
+000585b0: 474d 4c5f 4153 5345 5254 286e 5f64 696d  GML_ASSERT(n_dim
+000585c0: 7320 3c3d 206e 6530 293b 0a20 2020 2047  s <= ne0);.    G
+000585d0: 474d 4c5f 4153 5345 5254 286e 5f64 696d  GML_ASSERT(n_dim
+000585e0: 7320 2520 3220 3d3d 2030 293b 0a0a 2020  s % 2 == 0);..  
+000585f0: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
+00058600: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+00058610: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
+00058620: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
+00058630: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
+00058640: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
+00058650: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
+00058660: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
+00058670: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
+00058680: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
+00058690: 0a0a 2020 2020 2f2f 2072 6f77 2069 6e64  ..    // row ind
+000586a0: 6578 2075 7365 6420 746f 2064 6574 6572  ex used to deter
+000586b0: 6d69 6e65 2077 6869 6368 2074 6872 6561  mine which threa
+000586c0: 6420 746f 2075 7365 0a20 2020 2069 6e74  d to use.    int
+000586d0: 2069 7220 3d20 303b 0a0a 2020 2020 636f   ir = 0;..    co
+000586e0: 6e73 7420 666c 6f61 7420 7468 6574 615f  nst float theta_
+000586f0: 7363 616c 6520 3d20 706f 7766 2831 3030  scale = powf(100
+00058700: 3030 2e30 2c20 2d32 2e30 662f 6e5f 6469  00.0, -2.0f/n_di
+00058710: 6d73 293b 0a0a 2020 2020 636f 6e73 7420  ms);..    const 
+00058720: 626f 6f6c 2069 735f 6e65 6f78 203d 206d  bool is_neox = m
+00058730: 6f64 6520 2620 323b 0a0a 2020 2020 666f  ode & 2;..    fo
+00058740: 7220 2869 6e74 3634 5f74 2069 3320 3d20  r (int64_t i3 = 
+00058750: 303b 2069 3320 3c20 6e65 333b 2069 332b  0; i3 < ne3; i3+
+00058760: 2b29 207b 0a20 2020 2020 2020 2066 6f72  +) {.        for
+00058770: 2028 696e 7436 345f 7420 6932 203d 2028   (int64_t i2 = (
+00058780: 286d 6f64 6520 2620 3129 203d 3d20 3020  (mode & 1) == 0 
+00058790: 3f20 3020 3a20 6e5f 7061 7374 293b 2069  ? 0 : n_past); i
+000587a0: 3220 3c20 6e65 323b 2069 322b 2b29 207b  2 < ne2; i2++) {
+000587b0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+000587c0: 7374 2069 6e74 3634 5f74 2070 203d 2028  st int64_t p = (
+000587d0: 286d 6f64 6520 2620 3129 203d 3d20 3020  (mode & 1) == 0 
+000587e0: 3f20 6e5f 7061 7374 202b 2069 3220 3a20  ? n_past + i2 : 
+000587f0: 6932 293b 0a20 2020 2020 2020 2020 2020  i2);.           
+00058800: 2066 6f72 2028 696e 7436 345f 7420 6931   for (int64_t i1
+00058810: 203d 2030 3b20 6931 203c 206e 6531 3b20   = 0; i1 < ne1; 
+00058820: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
+00058830: 2020 2020 2020 2020 6966 2028 6972 2b2b          if (ir++
+00058840: 203c 2069 7230 2920 636f 6e74 696e 7565   < ir0) continue
+00058850: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00058860: 2020 6966 2028 6972 2020 203e 2069 7231    if (ir   > ir1
+00058870: 2920 6272 6561 6b3b 0a0a 2020 2020 2020  ) break;..      
+00058880: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00058890: 7468 6574 6120 3d20 2866 6c6f 6174 2970  theta = (float)p
+000588a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000588b0: 2020 2069 6620 2821 6973 5f6e 656f 7829     if (!is_neox)
+000588c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000588d0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+000588e0: 345f 7420 6930 203d 2030 3b20 6930 203c  4_t i0 = 0; i0 <
+000588f0: 206e 6530 3b20 6930 202b 3d20 3229 207b   ne0; i0 += 2) {
+00058900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00058910: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00058920: 6c6f 6174 2063 6f73 5f74 6865 7461 203d  loat cos_theta =
+00058930: 2063 6f73 6628 7468 6574 6129 3b0a 2020   cosf(theta);.  
 00058940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058950: 2063 6f6e 7374 2066 6c6f 6174 2073 696e   const float sin
-00058960: 5f74 6865 7461 203d 2073 696e 6628 7468  _theta = sinf(th
-00058970: 6574 6129 3b0a 0a20 2020 2020 2020 2020  eta);..         
-00058980: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00058990: 6865 7461 202a 3d20 7468 6574 615f 7363  heta *= theta_sc
-000589a0: 616c 653b 0a0a 2020 2020 2020 2020 2020  ale;..          
-000589b0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000589c0: 6e73 7420 6767 6d6c 5f66 7031 365f 7420  nst ggml_fp16_t 
-000589d0: 2a20 636f 6e73 7420 7372 6320 3d20 2867  * const src = (g
-000589e0: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
-000589f0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00058a00: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
-00058a10: 2a6e 6230 3220 2b20 6931 2a6e 6230 3120  *nb02 + i1*nb01 
-00058a20: 2b20 6930 2a6e 6230 3029 3b0a 2020 2020  + i0*nb00);.    
-00058a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058a40: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-00058a50: 7031 365f 7420 2a20 6473 745f 6461 7461  p16_t * dst_data
-00058a60: 2020 3d20 2867 676d 6c5f 6670 3136 5f74    = (ggml_fp16_t
-00058a70: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
-00058a80: 742d 3e64 6174 6120 2b20 6933 2a6e 6233  t->data + i3*nb3
-00058a90: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
-00058aa0: 2a6e 6231 2020 2b20 6930 2a6e 6230 293b  *nb1  + i0*nb0);
-00058ab0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00058ac0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00058ad0: 666c 6f61 7420 7830 203d 2047 474d 4c5f  float x0 = GGML_
-00058ae0: 4650 3136 5f54 4f5f 4650 3332 2873 7263  FP16_TO_FP32(src
-00058af0: 5b30 5d29 3b0a 2020 2020 2020 2020 2020  [0]);.          
-00058b00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00058b10: 6e73 7420 666c 6f61 7420 7831 203d 2047  nst float x1 = G
-00058b20: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
-00058b30: 2873 7263 5b31 5d29 3b0a 0a20 2020 2020  (src[1]);..     
+00058950: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+00058960: 7420 7369 6e5f 7468 6574 6120 3d20 7369  t sin_theta = si
+00058970: 6e66 2874 6865 7461 293b 0a0a 2020 2020  nf(theta);..    
+00058980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058990: 2020 2020 7468 6574 6120 2a3d 2074 6865      theta *= the
+000589a0: 7461 5f73 6361 6c65 3b0a 0a20 2020 2020  ta_scale;..     
+000589b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000589c0: 2020 2063 6f6e 7374 2067 676d 6c5f 6670     const ggml_fp
+000589d0: 3136 5f74 202a 2063 6f6e 7374 2073 7263  16_t * const src
+000589e0: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
+000589f0: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
+00058a00: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
+00058a10: 202b 2069 322a 6e62 3032 202b 2069 312a   + i2*nb02 + i1*
+00058a20: 6e62 3031 202b 2069 302a 6e62 3030 293b  nb01 + i0*nb00);
+00058a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00058a40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00058a50: 676d 6c5f 6670 3136 5f74 202a 2064 7374  gml_fp16_t * dst
+00058a60: 5f64 6174 6120 203d 2028 6767 6d6c 5f66  _data  = (ggml_f
+00058a70: 7031 365f 7420 2a29 2828 6368 6172 202a  p16_t *)((char *
+00058a80: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
+00058a90: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
+00058aa0: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
+00058ab0: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
+00058ac0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00058ad0: 6f6e 7374 2066 6c6f 6174 2078 3020 3d20  onst float x0 = 
+00058ae0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+00058af0: 3228 7372 635b 305d 293b 0a20 2020 2020  2(src[0]);.     
+00058b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058b10: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
+00058b20: 3120 3d20 4747 4d4c 5f46 5031 365f 544f  1 = GGML_FP16_TO
+00058b30: 5f46 5033 3228 7372 635b 315d 293b 0a0a  _FP32(src[1]);..
 00058b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058b50: 2020 2064 7374 5f64 6174 615b 305d 203d     dst_data[0] =
-00058b60: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
-00058b70: 3136 2878 302a 636f 735f 7468 6574 6120  16(x0*cos_theta 
-00058b80: 2d20 7831 2a73 696e 5f74 6865 7461 293b  - x1*sin_theta);
-00058b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00058ba0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-00058bb0: 615b 315d 203d 2047 474d 4c5f 4650 3332  a[1] = GGML_FP32
-00058bc0: 5f54 4f5f 4650 3136 2878 302a 7369 6e5f  _TO_FP16(x0*sin_
-00058bd0: 7468 6574 6120 2b20 7831 2a63 6f73 5f74  theta + x1*cos_t
-00058be0: 6865 7461 293b 0a20 2020 2020 2020 2020  heta);.         
-00058bf0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00058c00: 2020 2020 2020 2020 2020 2020 207d 2065               } e
-00058c10: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-00058c20: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
-00058c30: 4f3a 2074 6869 7320 6973 2070 726f 6261  O: this is proba
-00058c40: 626c 7920 7772 6f6e 672c 2062 7574 2049  bly wrong, but I
-00058c50: 2063 616e 2774 2066 6967 7572 6520 6974   can't figure it
-00058c60: 206f 7574 202e 2e0a 2020 2020 2020 2020   out ...        
-00058c70: 2020 2020 2020 2020 2020 2020 2f2f 2072              // r
-00058c80: 6566 3a20 2068 7474 7073 3a2f 2f67 6974  ef:  https://git
-00058c90: 6875 622e 636f 6d2f 6875 6767 696e 6766  hub.com/huggingf
-00058ca0: 6163 652f 7472 616e 7366 6f72 6d65 7273  ace/transformers
-00058cb0: 2f62 6c6f 622f 6d61 696e 2f73 7263 2f74  /blob/main/src/t
-00058cc0: 7261 6e73 666f 726d 6572 732f 6d6f 6465  ransformers/mode
-00058cd0: 6c73 2f67 7074 5f6e 656f 782f 6d6f 6465  ls/gpt_neox/mode
-00058ce0: 6c69 6e67 5f67 7074 5f6e 656f 782e 7079  ling_gpt_neox.py
-00058cf0: 234c 4c32 3531 4331 2d4c 3239 3443 3238  #LL251C1-L294C28
-00058d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00058d10: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00058d20: 7420 6962 203d 2030 3b20 6962 203c 206e  t ib = 0; ib < n
-00058d30: 6530 2f6e 5f64 696d 733b 202b 2b69 6229  e0/n_dims; ++ib)
-00058d40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00058d50: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00058d60: 696e 7436 345f 7420 6963 203d 2030 3b20  int64_t ic = 0; 
-00058d70: 6963 203c 206e 5f64 696d 733b 2069 6320  ic < n_dims; ic 
-00058d80: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
+00058b50: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
+00058b60: 5b30 5d20 3d20 4747 4d4c 5f46 5033 325f  [0] = GGML_FP32_
+00058b70: 544f 5f46 5031 3628 7830 2a63 6f73 5f74  TO_FP16(x0*cos_t
+00058b80: 6865 7461 202d 2078 312a 7369 6e5f 7468  heta - x1*sin_th
+00058b90: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
+00058ba0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00058bb0: 745f 6461 7461 5b31 5d20 3d20 4747 4d4c  t_data[1] = GGML
+00058bc0: 5f46 5033 325f 544f 5f46 5031 3628 7830  _FP32_TO_FP16(x0
+00058bd0: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
+00058be0: 636f 735f 7468 6574 6129 3b0a 2020 2020  cos_theta);.    
+00058bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058c00: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00058c10: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00058c20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00058c30: 2f20 544f 444f 3a20 7468 6973 2069 7320  / TODO: this is 
+00058c40: 7072 6f62 6162 6c79 2077 726f 6e67 2c20  probably wrong, 
+00058c50: 6275 7420 4920 6361 6e27 7420 6669 6775  but I can't figu
+00058c60: 7265 2069 7420 6f75 7420 2e2e 0a20 2020  re it out ...   
+00058c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058c80: 202f 2f20 7265 663a 2020 6874 7470 733a   // ref:  https:
+00058c90: 2f2f 6769 7468 7562 2e63 6f6d 2f68 7567  //github.com/hug
+00058ca0: 6769 6e67 6661 6365 2f74 7261 6e73 666f  gingface/transfo
+00058cb0: 726d 6572 732f 626c 6f62 2f6d 6169 6e2f  rmers/blob/main/
+00058cc0: 7372 632f 7472 616e 7366 6f72 6d65 7273  src/transformers
+00058cd0: 2f6d 6f64 656c 732f 6770 745f 6e65 6f78  /models/gpt_neox
+00058ce0: 2f6d 6f64 656c 696e 675f 6770 745f 6e65  /modeling_gpt_ne
+00058cf0: 6f78 2e70 7923 4c4c 3235 3143 312d 4c32  ox.py#LL251C1-L2
+00058d00: 3934 4332 380a 2020 2020 2020 2020 2020  94C28.          
+00058d10: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00058d20: 6e74 3634 5f74 2069 6220 3d20 303b 2069  nt64_t ib = 0; i
+00058d30: 6220 3c20 6e65 302f 6e5f 6469 6d73 3b20  b < ne0/n_dims; 
+00058d40: 2b2b 6962 2920 7b0a 2020 2020 2020 2020  ++ib) {.        
+00058d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058d60: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
+00058d70: 3d20 303b 2069 6320 3c20 6e5f 6469 6d73  = 0; ic < n_dims
+00058d80: 3b20 6963 202b 3d20 3229 207b 0a20 2020  ; ic += 2) {.   
 00058d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058da0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00058db0: 636f 735f 7468 6574 6120 3d20 636f 7366  cos_theta = cosf
-00058dc0: 2874 6865 7461 293b 0a20 2020 2020 2020  (theta);.       
+00058da0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00058db0: 6c6f 6174 2063 6f73 5f74 6865 7461 203d  loat cos_theta =
+00058dc0: 2063 6f73 6628 7468 6574 6129 3b0a 2020   cosf(theta);.  
 00058dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058de0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-00058df0: 2073 696e 5f74 6865 7461 203d 2073 696e   sin_theta = sin
-00058e00: 6628 7468 6574 6129 3b0a 0a20 2020 2020  f(theta);..     
+00058de0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00058df0: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
+00058e00: 3d20 7369 6e66 2874 6865 7461 293b 0a0a  = sinf(theta);..
 00058e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058e20: 2020 2020 2020 2074 6865 7461 202a 3d20         theta *= 
-00058e30: 7468 6574 615f 7363 616c 653b 0a0a 2020  theta_scale;..  
-00058e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058e50: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00058e60: 696e 7436 345f 7420 6930 203d 2069 622a  int64_t i0 = ib*
-00058e70: 6e5f 6469 6d73 202b 2069 632f 323b 0a0a  n_dims + ic/2;..
-00058e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058e90: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00058ea0: 7420 6767 6d6c 5f66 7031 365f 7420 2a20  t ggml_fp16_t * 
-00058eb0: 636f 6e73 7420 7372 6320 3d20 2867 676d  const src = (ggm
-00058ec0: 6c5f 6670 3136 5f74 202a 2928 2863 6861  l_fp16_t *)((cha
-00058ed0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00058ee0: 2b20 6933 2a6e 6230 3320 2b20 6932 2a6e  + i3*nb03 + i2*n
-00058ef0: 6230 3220 2b20 6931 2a6e 6230 3120 2b20  b02 + i1*nb01 + 
-00058f00: 6930 2a6e 6230 3029 3b0a 2020 2020 2020  i0*nb00);.      
+00058e20: 2020 2020 2020 2020 2020 2020 7468 6574              thet
+00058e30: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
+00058e40: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00058e50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00058e60: 6f6e 7374 2069 6e74 3634 5f74 2069 3020  onst int64_t i0 
+00058e70: 3d20 6962 2a6e 5f64 696d 7320 2b20 6963  = ib*n_dims + ic
+00058e80: 2f32 3b0a 0a20 2020 2020 2020 2020 2020  /2;..           
+00058e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058ea0: 2063 6f6e 7374 2067 676d 6c5f 6670 3136   const ggml_fp16
+00058eb0: 5f74 202a 2063 6f6e 7374 2073 7263 203d  _t * const src =
+00058ec0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00058ed0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00058ee0: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
+00058ef0: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
+00058f00: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
 00058f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058f20: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00058f30: 5f66 7031 365f 7420 2a20 6473 745f 6461  _fp16_t * dst_da
-00058f40: 7461 2020 3d20 2867 676d 6c5f 6670 3136  ta  = (ggml_fp16
-00058f50: 5f74 202a 2928 2863 6861 7220 2a29 2020  _t *)((char *)  
-00058f60: 6473 742d 3e64 6174 6120 2b20 6933 2a6e  dst->data + i3*n
-00058f70: 6233 2020 2b20 6932 2a6e 6232 2020 2b20  b3  + i2*nb2  + 
-00058f80: 6931 2a6e 6231 2020 2b20 6930 2a6e 6230  i1*nb1  + i0*nb0
-00058f90: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00058f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00058f30: 2067 676d 6c5f 6670 3136 5f74 202a 2064   ggml_fp16_t * d
+00058f40: 7374 5f64 6174 6120 203d 2028 6767 6d6c  st_data  = (ggml
+00058f50: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
+00058f60: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+00058f70: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
+00058f80: 3220 202b 2069 312a 6e62 3120 202b 2069  2  + i1*nb1  + i
+00058f90: 302a 6e62 3029 3b0a 0a20 2020 2020 2020  0*nb0);..       
 00058fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058fb0: 636f 6e73 7420 666c 6f61 7420 7830 203d  const float x0 =
-00058fc0: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
-00058fd0: 3332 2873 7263 5b30 5d29 3b0a 2020 2020  32(src[0]);.    
-00058fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058ff0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00059000: 6f61 7420 7831 203d 2047 474d 4c5f 4650  oat x1 = GGML_FP
-00059010: 3136 5f54 4f5f 4650 3332 2873 7263 5b6e  16_TO_FP32(src[n
-00059020: 5f64 696d 732f 325d 293b 0a0a 2020 2020  _dims/2]);..    
-00059030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059040: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-00059050: 5b30 5d20 2020 2020 3d20 4747 4d4c 5f46  [0]     = GGML_F
-00059060: 5033 325f 544f 5f46 5031 3628 7830 2a63  P32_TO_FP16(x0*c
-00059070: 6f73 5f74 6865 7461 202d 2078 312a 7369  os_theta - x1*si
-00059080: 6e5f 7468 6574 6129 3b0a 2020 2020 2020  n_theta);.      
+00058fb0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00058fc0: 2078 3020 3d20 4747 4d4c 5f46 5031 365f   x0 = GGML_FP16_
+00058fd0: 544f 5f46 5033 3228 7372 635b 305d 293b  TO_FP32(src[0]);
+00058fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00058ff0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00059000: 7374 2066 6c6f 6174 2078 3120 3d20 4747  st float x1 = GG
+00059010: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+00059020: 7372 635b 6e5f 6469 6d73 2f32 5d29 3b0a  src[n_dims/2]);.
+00059030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059040: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+00059050: 5f64 6174 615b 305d 2020 2020 203d 2047  _data[0]     = G
+00059060: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+00059070: 2878 302a 636f 735f 7468 6574 6120 2d20  (x0*cos_theta - 
+00059080: 7831 2a73 696e 5f74 6865 7461 293b 0a20  x1*sin_theta);. 
 00059090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000590a0: 2020 2020 2020 6473 745f 6461 7461 5b6e        dst_data[n
-000590b0: 5f64 696d 732f 325d 203d 2047 474d 4c5f  _dims/2] = GGML_
-000590c0: 4650 3332 5f54 4f5f 4650 3136 2878 302a  FP32_TO_FP16(x0*
-000590d0: 7369 6e5f 7468 6574 6120 2b20 7831 2a63  sin_theta + x1*c
-000590e0: 6f73 5f74 6865 7461 293b 0a20 2020 2020  os_theta);.     
+000590a0: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+000590b0: 6174 615b 6e5f 6469 6d73 2f32 5d20 3d20  ata[n_dims/2] = 
+000590c0: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
+000590d0: 3628 7830 2a73 696e 5f74 6865 7461 202b  6(x0*sin_theta +
+000590e0: 2078 312a 636f 735f 7468 6574 6129 3b0a   x1*cos_theta);.
 000590f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059100: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00059110: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00059120: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00059130: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00059140: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-00059150: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00059160: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-00059170: 6f70 6528 0a20 2020 2020 2020 2063 6f6e  ope(.        con
-00059180: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00059190: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000591a0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000591b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000591c0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-000591d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000591e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000591f0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
-00059200: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00059210: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00059220: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-00059230: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00059240: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00059250: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
-00059260: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00059270: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00059280: 6f72 7761 7264 5f72 6f70 655f 6631 3628  orward_rope_f16(
-00059290: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-000592a0: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-000592b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000592c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000592d0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000592e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000592f0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00059300: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
-00059310: 7065 5f66 3332 2870 6172 616d 732c 2073  pe_f32(params, s
-00059320: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
-00059330: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00059340: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
-00059350: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-00059360: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00059370: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00059380: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00059390: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000593a0: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-000593b0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-000593c0: 6f70 655f 6261 636b 0a0a 7374 6174 6963  ope_back..static
-000593d0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000593e0: 7465 5f66 6f72 7761 7264 5f72 6f70 655f  te_forward_rope_
-000593f0: 6261 636b 5f66 3332 280a 2020 2020 2020  back_f32(.      
-00059400: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00059410: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00059420: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00059430: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00059440: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00059450: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00059460: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00059470: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00059480: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00059490: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000594a0: 207b 0a20 2020 2061 7373 6572 7428 7372   {.    assert(sr
-000594b0: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-000594c0: 5f54 5950 455f 4933 3229 3b0a 2020 2020  _TYPE_I32);.    
-000594d0: 6173 7365 7274 2867 676d 6c5f 6e65 6c65  assert(ggml_nele
-000594e0: 6d65 6e74 7328 7372 6331 2920 3d3d 2033  ments(src1) == 3
-000594f0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
-00059500: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00059510: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
-00059520: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00059530: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-00059540: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-00059550: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
-00059560: 2f20 7920 3d20 726f 7065 2878 2c20 7372  / y = rope(x, sr
-00059570: 6331 290a 2020 2020 2f2f 2064 7820 3d20  c1).    // dx = 
-00059580: 726f 7065 5f62 6163 6b28 6479 2c20 7372  rope_back(dy, sr
-00059590: 6331 290a 2020 2020 2f2f 2073 7263 3020  c1).    // src0 
-000595a0: 6973 2064 792c 2073 7263 3120 636f 6e74  is dy, src1 cont
-000595b0: 6169 6e73 206f 7074 696f 6e73 0a0a 2020  ains options..  
-000595c0: 2020 636f 6e73 7420 696e 7420 6e5f 7061    const int n_pa
-000595d0: 7374 203d 2028 2869 6e74 3332 5f74 202a  st = ((int32_t *
-000595e0: 2920 7372 6331 2d3e 6461 7461 295b 305d  ) src1->data)[0]
-000595f0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00059600: 6e5f 6469 6d73 203d 2028 2869 6e74 3332  n_dims = ((int32
-00059610: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-00059620: 295b 315d 3b0a 2020 2020 636f 6e73 7420  )[1];.    const 
-00059630: 696e 7420 6d6f 6465 2020 203d 2028 2869  int mode   = ((i
-00059640: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-00059650: 6461 7461 295b 325d 3b0a 0a20 2020 2061  data)[2];..    a
-00059660: 7373 6572 7428 6e5f 7061 7374 203e 3d20  ssert(n_past >= 
-00059670: 3029 3b0a 0a20 2020 2063 6f6e 7374 2073  0);..    const s
-00059680: 697a 655f 7420 6e62 3030 203d 2073 7263  ize_t nb00 = src
-00059690: 302d 3e6e 625b 305d 3b0a 2020 2020 636f  0->nb[0];.    co
-000596a0: 6e73 7420 7369 7a65 5f74 206e 6230 3120  nst size_t nb01 
-000596b0: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
-000596c0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-000596d0: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
-000596e0: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-000596f0: 7a65 5f74 206e 6230 3320 3d20 7372 6330  ze_t nb03 = src0
-00059700: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-00059710: 6e73 7420 696e 7436 345f 7420 6e65 3020  nst int64_t ne0 
-00059720: 3d20 6473 742d 3e6e 655b 305d 3b0a 2020  = dst->ne[0];.  
-00059730: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00059740: 6e65 3120 3d20 6473 742d 3e6e 655b 315d  ne1 = dst->ne[1]
-00059750: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00059760: 345f 7420 6e65 3220 3d20 6473 742d 3e6e  4_t ne2 = dst->n
-00059770: 655b 325d 3b0a 2020 2020 636f 6e73 7420  e[2];.    const 
-00059780: 696e 7436 345f 7420 6e65 3320 3d20 6473  int64_t ne3 = ds
-00059790: 742d 3e6e 655b 335d 3b0a 0a20 2020 2063  t->ne[3];..    c
-000597a0: 6f6e 7374 2073 697a 655f 7420 6e62 3020  onst size_t nb0 
-000597b0: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-000597c0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-000597d0: 6231 203d 2064 7374 2d3e 6e62 5b31 5d3b  b1 = dst->nb[1];
-000597e0: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-000597f0: 7420 6e62 3220 3d20 6473 742d 3e6e 625b  t nb2 = dst->nb[
-00059800: 325d 3b0a 2020 2020 636f 6e73 7420 7369  2];.    const si
-00059810: 7a65 5f74 206e 6233 203d 2064 7374 2d3e  ze_t nb3 = dst->
-00059820: 6e62 5b33 5d3b 0a0a 0a20 2020 202f 2f70  nb[3];...    //p
-00059830: 7269 6e74 6628 226e 6530 3a20 2564 2c20  rintf("ne0: %d, 
-00059840: 6e65 313a 2025 642c 206e 6532 3a20 2564  ne1: %d, ne2: %d
-00059850: 2c20 6e65 333a 2025 645c 6e22 2c20 6e65  , ne3: %d\n", ne
-00059860: 302c 206e 6531 2c20 6e65 322c 206e 6533  0, ne1, ne2, ne3
-00059870: 293b 0a20 2020 202f 2f70 7269 6e74 6628  );.    //printf(
-00059880: 226e 5f70 6173 7420 3d20 2564 2c20 6e65  "n_past = %d, ne
-00059890: 3220 3d20 2564 5c6e 222c 206e 5f70 6173  2 = %d\n", n_pas
-000598a0: 742c 206e 6532 293b 0a0a 2020 2020 6173  t, ne2);..    as
-000598b0: 7365 7274 286e 6230 203d 3d20 7369 7a65  sert(nb0 == size
-000598c0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-000598d0: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
-000598e0: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
-000598f0: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
-00059900: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
-00059910: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-00059920: 203d 2067 676d 6c5f 6e72 6f77 7328 6473   = ggml_nrows(ds
-00059930: 7429 3b0a 0a20 2020 202f 2f20 726f 7773  t);..    // rows
-00059940: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
-00059950: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
-00059960: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
-00059970: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
-00059980: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
-00059990: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-000599a0: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
-000599b0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-000599c0: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
-000599d0: 722c 206e 7229 3b0a 0a20 2020 202f 2f20  r, nr);..    // 
-000599e0: 726f 7720 696e 6465 7820 7573 6564 2074  row index used t
-000599f0: 6f20 6465 7465 726d 696e 6520 7768 6963  o determine whic
-00059a00: 6820 7468 7265 6164 2074 6f20 7573 650a  h thread to use.
-00059a10: 2020 2020 696e 7420 6972 203d 2030 3b0a      int ir = 0;.
-00059a20: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
-00059a30: 2074 6865 7461 5f73 6361 6c65 203d 2070   theta_scale = p
-00059a40: 6f77 6628 3130 3030 302e 302c 202d 322e  owf(10000.0, -2.
-00059a50: 3066 2f6e 5f64 696d 7329 3b0a 0a20 2020  0f/n_dims);..   
-00059a60: 2063 6f6e 7374 2062 6f6f 6c20 6973 5f6e   const bool is_n
-00059a70: 656f 7820 3d20 6d6f 6465 2026 2032 3b0a  eox = mode & 2;.
-00059a80: 0a20 2020 2066 6f72 2028 696e 7436 345f  .    for (int64_
-00059a90: 7420 6933 203d 2030 3b20 6933 203c 206e  t i3 = 0; i3 < n
-00059aa0: 6533 3b20 6933 2b2b 2920 7b0a 2020 2020  e3; i3++) {.    
-00059ab0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00059ac0: 2069 3220 3d20 2828 6d6f 6465 2026 2031   i2 = ((mode & 1
-00059ad0: 2920 3d3d 2030 203f 2030 203a 206e 5f70  ) == 0 ? 0 : n_p
-00059ae0: 6173 7429 3b20 6932 203c 206e 6532 3b20  ast); i2 < ne2; 
-00059af0: 6932 2b2b 2920 7b0a 2020 2020 2020 2020  i2++) {.        
-00059b00: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00059b10: 7420 7020 3d20 2828 6d6f 6465 2026 2031  t p = ((mode & 1
-00059b20: 2920 3d3d 2030 203f 206e 5f70 6173 7420  ) == 0 ? n_past 
-00059b30: 2b20 6932 203a 2069 3229 3b0a 2020 2020  + i2 : i2);.    
-00059b40: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00059b50: 3634 5f74 2069 3120 3d20 303b 2069 3120  64_t i1 = 0; i1 
-00059b60: 3c20 6e65 313b 2069 312b 2b29 207b 0a20  < ne1; i1++) {. 
-00059b70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00059b80: 6620 2869 722b 2b20 3c20 6972 3029 2063  f (ir++ < ir0) c
-00059b90: 6f6e 7469 6e75 653b 0a20 2020 2020 2020  ontinue;.       
-00059ba0: 2020 2020 2020 2020 2069 6620 2869 7220           if (ir 
-00059bb0: 2020 3e20 6972 3129 2062 7265 616b 3b0a    > ir1) break;.
-00059bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059bd0: 2066 6c6f 6174 2074 6865 7461 203d 2028   float theta = (
-00059be0: 666c 6f61 7429 703b 0a0a 2020 2020 2020  float)p;..      
-00059bf0: 2020 2020 2020 2020 2020 6966 2028 2169            if (!i
-00059c00: 735f 6e65 6f78 2920 7b0a 2020 2020 2020  s_neox) {.      
-00059c10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00059c20: 7220 2869 6e74 3634 5f74 2069 3020 3d20  r (int64_t i0 = 
-00059c30: 303b 2069 3020 3c20 6e65 303b 2069 3020  0; i0 < ne0; i0 
-00059c40: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
+00059100: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00059110: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00059120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059130: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+00059140: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00059150: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00059160: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00059170: 6172 645f 726f 7065 280a 2020 2020 2020  ard_rope(.      
+00059180: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00059190: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000591a0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000591b0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000591c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000591d0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+000591e0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000591f0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00059200: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00059210: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00059220: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+00059230: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00059240: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00059250: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+00059260: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00059270: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00059280: 7574 655f 666f 7277 6172 645f 726f 7065  ute_forward_rope
+00059290: 5f66 3136 2870 6172 616d 732c 2073 7263  _f16(params, src
+000592a0: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
+000592b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000592c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000592d0: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+000592e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000592f0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00059300: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00059310: 7264 5f72 6f70 655f 6633 3228 7061 7261  rd_rope_f32(para
+00059320: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+00059330: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+00059340: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00059350: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00059360: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00059370: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00059380: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00059390: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000593a0: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+000593b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000593c0: 6172 645f 726f 7065 5f62 6163 6b0a 0a73  ard_rope_back..s
+000593d0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+000593e0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000593f0: 726f 7065 5f62 6163 6b5f 6633 3228 0a20  rope_back_f32(. 
+00059400: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00059410: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00059420: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00059430: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00059440: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00059450: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00059460: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00059470: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00059480: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+00059490: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000594a0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+000594b0: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
+000594c0: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+000594d0: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
+000594e0: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+000594f0: 203d 3d20 3329 3b0a 0a20 2020 2069 6620   == 3);..    if 
+00059500: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00059510: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00059520: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00059530: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00059540: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00059550: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00059560: 2020 2020 2f2f 2079 203d 2072 6f70 6528      // y = rope(
+00059570: 782c 2073 7263 3129 0a20 2020 202f 2f20  x, src1).    // 
+00059580: 6478 203d 2072 6f70 655f 6261 636b 2864  dx = rope_back(d
+00059590: 792c 2073 7263 3129 0a20 2020 202f 2f20  y, src1).    // 
+000595a0: 7372 6330 2069 7320 6479 2c20 7372 6331  src0 is dy, src1
+000595b0: 2063 6f6e 7461 696e 7320 6f70 7469 6f6e   contains option
+000595c0: 730a 0a20 2020 2063 6f6e 7374 2069 6e74  s..    const int
+000595d0: 206e 5f70 6173 7420 3d20 2828 696e 7433   n_past = ((int3
+000595e0: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+000595f0: 6129 5b30 5d3b 0a20 2020 2063 6f6e 7374  a)[0];.    const
+00059600: 2069 6e74 206e 5f64 696d 7320 3d20 2828   int n_dims = ((
+00059610: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
+00059620: 3e64 6174 6129 5b31 5d3b 0a20 2020 2063  >data)[1];.    c
+00059630: 6f6e 7374 2069 6e74 206d 6f64 6520 2020  onst int mode   
+00059640: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+00059650: 7263 312d 3e64 6174 6129 5b32 5d3b 0a0a  rc1->data)[2];..
+00059660: 2020 2020 6173 7365 7274 286e 5f70 6173      assert(n_pas
+00059670: 7420 3e3d 2030 293b 0a0a 2020 2020 636f  t >= 0);..    co
+00059680: 6e73 7420 7369 7a65 5f74 206e 6230 3020  nst size_t nb00 
+00059690: 3d20 7372 6330 2d3e 6e62 5b30 5d3b 0a20  = src0->nb[0];. 
+000596a0: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+000596b0: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
+000596c0: 315d 3b0a 2020 2020 636f 6e73 7420 7369  1];.    const si
+000596d0: 7a65 5f74 206e 6230 3220 3d20 7372 6330  ze_t nb02 = src0
+000596e0: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+000596f0: 7374 2073 697a 655f 7420 6e62 3033 203d  st size_t nb03 =
+00059700: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
+00059710: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00059720: 206e 6530 203d 2064 7374 2d3e 6e65 5b30   ne0 = dst->ne[0
+00059730: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00059740: 3634 5f74 206e 6531 203d 2064 7374 2d3e  64_t ne1 = dst->
+00059750: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
+00059760: 2069 6e74 3634 5f74 206e 6532 203d 2064   int64_t ne2 = d
+00059770: 7374 2d3e 6e65 5b32 5d3b 0a20 2020 2063  st->ne[2];.    c
+00059780: 6f6e 7374 2069 6e74 3634 5f74 206e 6533  onst int64_t ne3
+00059790: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a0a   = dst->ne[3];..
+000597a0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
+000597b0: 206e 6230 203d 2064 7374 2d3e 6e62 5b30   nb0 = dst->nb[0
+000597c0: 5d3b 0a20 2020 2063 6f6e 7374 2073 697a  ];.    const siz
+000597d0: 655f 7420 6e62 3120 3d20 6473 742d 3e6e  e_t nb1 = dst->n
+000597e0: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+000597f0: 7369 7a65 5f74 206e 6232 203d 2064 7374  size_t nb2 = dst
+00059800: 2d3e 6e62 5b32 5d3b 0a20 2020 2063 6f6e  ->nb[2];.    con
+00059810: 7374 2073 697a 655f 7420 6e62 3320 3d20  st size_t nb3 = 
+00059820: 6473 742d 3e6e 625b 335d 3b0a 0a0a 2020  dst->nb[3];...  
+00059830: 2020 2f2f 7072 696e 7466 2822 6e65 303a    //printf("ne0:
+00059840: 2025 642c 206e 6531 3a20 2564 2c20 6e65   %d, ne1: %d, ne
+00059850: 323a 2025 642c 206e 6533 3a20 2564 5c6e  2: %d, ne3: %d\n
+00059860: 222c 206e 6530 2c20 6e65 312c 206e 6532  ", ne0, ne1, ne2
+00059870: 2c20 6e65 3329 3b0a 2020 2020 2f2f 7072  , ne3);.    //pr
+00059880: 696e 7466 2822 6e5f 7061 7374 203d 2025  intf("n_past = %
+00059890: 642c 206e 6532 203d 2025 645c 6e22 2c20  d, ne2 = %d\n", 
+000598a0: 6e5f 7061 7374 2c20 6e65 3229 3b0a 0a20  n_past, ne2);.. 
+000598b0: 2020 2061 7373 6572 7428 6e62 3020 3d3d     assert(nb0 ==
+000598c0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000598d0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+000598e0: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
+000598f0: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+00059900: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
+00059910: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
+00059920: 6e74 206e 7220 3d20 6767 6d6c 5f6e 726f  nt nr = ggml_nro
+00059930: 7773 2864 7374 293b 0a0a 2020 2020 2f2f  ws(dst);..    //
+00059940: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
+00059950: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
+00059960: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
+00059970: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
+00059980: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
+00059990: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+000599a0: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
+000599b0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+000599c0: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
+000599d0: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
+000599e0: 2020 2f2f 2072 6f77 2069 6e64 6578 2075    // row index u
+000599f0: 7365 6420 746f 2064 6574 6572 6d69 6e65  sed to determine
+00059a00: 2077 6869 6368 2074 6872 6561 6420 746f   which thread to
+00059a10: 2075 7365 0a20 2020 2069 6e74 2069 7220   use.    int ir 
+00059a20: 3d20 303b 0a0a 2020 2020 636f 6e73 7420  = 0;..    const 
+00059a30: 666c 6f61 7420 7468 6574 615f 7363 616c  float theta_scal
+00059a40: 6520 3d20 706f 7766 2831 3030 3030 2e30  e = powf(10000.0
+00059a50: 2c20 2d32 2e30 662f 6e5f 6469 6d73 293b  , -2.0f/n_dims);
+00059a60: 0a0a 2020 2020 636f 6e73 7420 626f 6f6c  ..    const bool
+00059a70: 2069 735f 6e65 6f78 203d 206d 6f64 6520   is_neox = mode 
+00059a80: 2620 323b 0a0a 2020 2020 666f 7220 2869  & 2;..    for (i
+00059a90: 6e74 3634 5f74 2069 3320 3d20 303b 2069  nt64_t i3 = 0; i
+00059aa0: 3320 3c20 6e65 333b 2069 332b 2b29 207b  3 < ne3; i3++) {
+00059ab0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00059ac0: 7436 345f 7420 6932 203d 2028 286d 6f64  t64_t i2 = ((mod
+00059ad0: 6520 2620 3129 203d 3d20 3020 3f20 3020  e & 1) == 0 ? 0 
+00059ae0: 3a20 6e5f 7061 7374 293b 2069 3220 3c20  : n_past); i2 < 
+00059af0: 6e65 323b 2069 322b 2b29 207b 0a20 2020  ne2; i2++) {.   
+00059b00: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00059b10: 6e74 3634 5f74 2070 203d 2028 286d 6f64  nt64_t p = ((mod
+00059b20: 6520 2620 3129 203d 3d20 3020 3f20 6e5f  e & 1) == 0 ? n_
+00059b30: 7061 7374 202b 2069 3220 3a20 6932 293b  past + i2 : i2);
+00059b40: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00059b50: 2028 696e 7436 345f 7420 6931 203d 2030   (int64_t i1 = 0
+00059b60: 3b20 6931 203c 206e 6531 3b20 6931 2b2b  ; i1 < ne1; i1++
+00059b70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00059b80: 2020 2020 6966 2028 6972 2b2b 203c 2069      if (ir++ < i
+00059b90: 7230 2920 636f 6e74 696e 7565 3b0a 2020  r0) continue;.  
+00059ba0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00059bb0: 2028 6972 2020 203e 2069 7231 2920 6272   (ir   > ir1) br
+00059bc0: 6561 6b3b 0a0a 2020 2020 2020 2020 2020  eak;..          
+00059bd0: 2020 2020 2020 666c 6f61 7420 7468 6574        float thet
+00059be0: 6120 3d20 2866 6c6f 6174 2970 3b0a 0a20  a = (float)p;.. 
+00059bf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00059c00: 6620 2821 6973 5f6e 656f 7829 207b 0a20  f (!is_neox) {. 
+00059c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059c20: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00059c30: 6930 203d 2030 3b20 6930 203c 206e 6530  i0 = 0; i0 < ne0
+00059c40: 3b20 6930 202b 3d20 3229 207b 0a20 2020  ; i0 += 2) {.   
 00059c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059c60: 636f 6e73 7420 666c 6f61 7420 636f 735f  const float cos_
-00059c70: 7468 6574 6120 3d20 636f 7366 2874 6865  theta = cosf(the
-00059c80: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
-00059c90: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00059ca0: 7374 2066 6c6f 6174 2073 696e 5f74 6865  st float sin_the
-00059cb0: 7461 203d 2073 696e 6628 7468 6574 6129  ta = sinf(theta)
-00059cc0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00059cd0: 2020 2020 2020 2020 2020 2074 6865 7461             theta
-00059ce0: 202a 3d20 7468 6574 615f 7363 616c 653b   *= theta_scale;
-00059cf0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00059d00: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00059d10: 666c 6f61 7420 2a20 636f 6e73 7420 6479  float * const dy
-00059d20: 2020 3d20 2866 6c6f 6174 202a 2928 2863    = (float *)((c
-00059d30: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-00059d40: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
-00059d50: 2a6e 6230 3220 2b20 6931 2a6e 6230 3120  *nb02 + i1*nb01 
-00059d60: 2b20 6930 2a6e 6230 3029 3b0a 2020 2020  + i0*nb00);.    
-00059d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059d80: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00059d90: 2a20 2020 2020 2020 6478 2020 3d20 2866  *       dx  = (f
-00059da0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-00059db0: 2020 6473 742d 3e64 6174 6120 2b20 6933    dst->data + i3
-00059dc0: 2a6e 6233 2020 2b20 6932 2a6e 6232 2020  *nb3  + i2*nb2  
-00059dd0: 2b20 6931 2a6e 6231 2020 2b20 6930 2a6e  + i1*nb1  + i0*n
-00059de0: 6230 293b 0a0a 2020 2020 2020 2020 2020  b0);..          
-00059df0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00059e00: 6e73 7420 666c 6f61 7420 6479 3020 3d20  nst float dy0 = 
-00059e10: 6479 5b30 5d3b 0a20 2020 2020 2020 2020  dy[0];.         
-00059e20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00059e30: 6f6e 7374 2066 6c6f 6174 2064 7931 203d  onst float dy1 =
-00059e40: 2064 795b 315d 3b0a 0a20 2020 2020 2020   dy[1];..       
+00059c60: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00059c70: 2063 6f73 5f74 6865 7461 203d 2063 6f73   cos_theta = cos
+00059c80: 6628 7468 6574 6129 3b0a 2020 2020 2020  f(theta);.      
+00059c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059ca0: 2020 636f 6e73 7420 666c 6f61 7420 7369    const float si
+00059cb0: 6e5f 7468 6574 6120 3d20 7369 6e66 2874  n_theta = sinf(t
+00059cc0: 6865 7461 293b 0a0a 2020 2020 2020 2020  heta);..        
+00059cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059ce0: 7468 6574 6120 2a3d 2074 6865 7461 5f73  theta *= theta_s
+00059cf0: 6361 6c65 3b0a 0a20 2020 2020 2020 2020  cale;..         
+00059d00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00059d10: 6f6e 7374 2066 6c6f 6174 202a 2063 6f6e  onst float * con
+00059d20: 7374 2064 7920 203d 2028 666c 6f61 7420  st dy  = (float 
+00059d30: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
+00059d40: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
+00059d50: 202b 2069 322a 6e62 3032 202b 2069 312a   + i2*nb02 + i1*
+00059d60: 6e62 3031 202b 2069 302a 6e62 3030 293b  nb01 + i0*nb00);
+00059d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059d80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00059d90: 6c6f 6174 202a 2020 2020 2020 2064 7820  loat *       dx 
+00059da0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+00059db0: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
+00059dc0: 202b 2069 332a 6e62 3320 202b 2069 322a   + i3*nb3  + i2*
+00059dd0: 6e62 3220 202b 2069 312a 6e62 3120 202b  nb2  + i1*nb1  +
+00059de0: 2069 302a 6e62 3029 3b0a 0a20 2020 2020   i0*nb0);..     
+00059df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059e00: 2020 2063 6f6e 7374 2066 6c6f 6174 2064     const float d
+00059e10: 7930 203d 2064 795b 305d 3b0a 2020 2020  y0 = dy[0];.    
+00059e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059e30: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00059e40: 6479 3120 3d20 6479 5b31 5d3b 0a0a 2020  dy1 = dy[1];..  
 00059e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059e60: 2064 785b 305d 203d 2020 2064 7930 2a63   dx[0] =   dy0*c
-00059e70: 6f73 5f74 6865 7461 202b 2064 7931 2a73  os_theta + dy1*s
-00059e80: 696e 5f74 6865 7461 3b0a 2020 2020 2020  in_theta;.      
+00059e60: 2020 2020 2020 6478 5b30 5d20 3d20 2020        dx[0] =   
+00059e70: 6479 302a 636f 735f 7468 6574 6120 2b20  dy0*cos_theta + 
+00059e80: 6479 312a 7369 6e5f 7468 6574 613b 0a20  dy1*sin_theta;. 
 00059e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059ea0: 2020 6478 5b31 5d20 3d20 2d20 6479 302a    dx[1] = - dy0*
-00059eb0: 7369 6e5f 7468 6574 6120 2b20 6479 312a  sin_theta + dy1*
-00059ec0: 636f 735f 7468 6574 613b 0a20 2020 2020  cos_theta;.     
-00059ed0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00059ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059ef0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-00059f00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00059f10: 7220 2869 6e74 3634 5f74 2069 6220 3d20  r (int64_t ib = 
-00059f20: 303b 2069 6220 3c20 6e65 302f 6e5f 6469  0; ib < ne0/n_di
-00059f30: 6d73 3b20 2b2b 6962 2920 7b0a 2020 2020  ms; ++ib) {.    
-00059f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059f50: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00059f60: 2069 6320 3d20 303b 2069 6320 3c20 6e5f   ic = 0; ic < n_
-00059f70: 6469 6d73 3b20 6963 202b 3d20 3229 207b  dims; ic += 2) {
-00059f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059f90: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00059fa0: 7374 2066 6c6f 6174 2063 6f73 5f74 6865  st float cos_the
-00059fb0: 7461 203d 2063 6f73 6628 7468 6574 6129  ta = cosf(theta)
-00059fc0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00059fd0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00059fe0: 6e73 7420 666c 6f61 7420 7369 6e5f 7468  nst float sin_th
-00059ff0: 6574 6120 3d20 7369 6e66 2874 6865 7461  eta = sinf(theta
-0005a000: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00059ea0: 2020 2020 2020 2064 785b 315d 203d 202d         dx[1] = -
+00059eb0: 2064 7930 2a73 696e 5f74 6865 7461 202b   dy0*sin_theta +
+00059ec0: 2064 7931 2a63 6f73 5f74 6865 7461 3b0a   dy1*cos_theta;.
+00059ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059ee0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00059ef0: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+00059f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059f10: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00059f20: 6962 203d 2030 3b20 6962 203c 206e 6530  ib = 0; ib < ne0
+00059f30: 2f6e 5f64 696d 733b 202b 2b69 6229 207b  /n_dims; ++ib) {
+00059f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059f50: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00059f60: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
+00059f70: 203c 206e 5f64 696d 733b 2069 6320 2b3d   < n_dims; ic +=
+00059f80: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
+00059f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059fa0: 2020 636f 6e73 7420 666c 6f61 7420 636f    const float co
+00059fb0: 735f 7468 6574 6120 3d20 636f 7366 2874  s_theta = cosf(t
+00059fc0: 6865 7461 293b 0a20 2020 2020 2020 2020  heta);.         
+00059fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00059fe0: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
+00059ff0: 696e 5f74 6865 7461 203d 2073 696e 6628  in_theta = sinf(
+0005a000: 7468 6574 6129 3b0a 0a20 2020 2020 2020  theta);..       
 0005a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a020: 7468 6574 6120 2a3d 2074 6865 7461 5f73  theta *= theta_s
-0005a030: 6361 6c65 3b0a 0a20 2020 2020 2020 2020  cale;..         
+0005a020: 2020 2020 2074 6865 7461 202a 3d20 7468       theta *= th
+0005a030: 6574 615f 7363 616c 653b 0a0a 2020 2020  eta_scale;..    
 0005a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a050: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-0005a060: 2069 3020 3d20 6962 2a6e 5f64 696d 7320   i0 = ib*n_dims 
-0005a070: 2b20 6963 2f32 3b0a 0a20 2020 2020 2020  + ic/2;..       
+0005a050: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0005a060: 7436 345f 7420 6930 203d 2069 622a 6e5f  t64_t i0 = ib*n_
+0005a070: 6469 6d73 202b 2069 632f 323b 0a0a 2020  dims + ic/2;..  
 0005a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a090: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-0005a0a0: 202a 2063 6f6e 7374 2064 7920 203d 2028   * const dy  = (
-0005a0b0: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-0005a0c0: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-0005a0d0: 332a 6e62 3033 202b 2069 322a 6e62 3032  3*nb03 + i2*nb02
-0005a0e0: 202b 2069 312a 6e62 3031 202b 2069 302a   + i1*nb01 + i0*
-0005a0f0: 6e62 3030 293b 0a20 2020 2020 2020 2020  nb00);.         
+0005a090: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005a0a0: 666c 6f61 7420 2a20 636f 6e73 7420 6479  float * const dy
+0005a0b0: 2020 3d20 2866 6c6f 6174 202a 2928 2863    = (float *)((c
+0005a0c0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
+0005a0d0: 6120 2b20 6933 2a6e 6230 3320 2b20 6932  a + i3*nb03 + i2
+0005a0e0: 2a6e 6230 3220 2b20 6931 2a6e 6230 3120  *nb02 + i1*nb01 
+0005a0f0: 2b20 6930 2a6e 6230 3029 3b0a 2020 2020  + i0*nb00);.    
 0005a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a110: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
-0005a120: 2020 2020 2020 2064 7820 203d 2028 666c         dx  = (fl
-0005a130: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-0005a140: 2064 7374 2d3e 6461 7461 202b 2069 332a   dst->data + i3*
-0005a150: 6e62 3320 202b 2069 322a 6e62 3220 202b  nb3  + i2*nb2  +
-0005a160: 2069 312a 6e62 3120 202b 2069 302a 6e62   i1*nb1  + i0*nb
-0005a170: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
+0005a110: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+0005a120: 6f61 7420 2a20 2020 2020 2020 6478 2020  oat *       dx  
+0005a130: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
+0005a140: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+0005a150: 2b20 6933 2a6e 6233 2020 2b20 6932 2a6e  + i3*nb3  + i2*n
+0005a160: 6232 2020 2b20 6931 2a6e 6231 2020 2b20  b2  + i1*nb1  + 
+0005a170: 6930 2a6e 6230 293b 0a0a 2020 2020 2020  i0*nb0);..      
 0005a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a190: 2063 6f6e 7374 2066 6c6f 6174 2064 7930   const float dy0
-0005a1a0: 203d 2064 795b 305d 3b0a 2020 2020 2020   = dy[0];.      
+0005a190: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+0005a1a0: 7420 6479 3020 3d20 6479 5b30 5d3b 0a20  t dy0 = dy[0];. 
 0005a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a1c0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005a1d0: 7420 6479 3120 3d20 6479 5b6e 5f64 696d  t dy1 = dy[n_dim
-0005a1e0: 732f 325d 3b0a 0a20 2020 2020 2020 2020  s/2];..         
+0005a1c0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005a1d0: 2066 6c6f 6174 2064 7931 203d 2064 795b   float dy1 = dy[
+0005a1e0: 6e5f 6469 6d73 2f32 5d3b 0a0a 2020 2020  n_dims/2];..    
 0005a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a200: 2020 2064 785b 305d 2020 2020 2020 2020     dx[0]        
-0005a210: 3d20 2020 6479 302a 636f 735f 7468 6574  =   dy0*cos_thet
-0005a220: 6120 2b20 6479 312a 7369 6e5f 7468 6574  a + dy1*sin_thet
-0005a230: 613b 0a20 2020 2020 2020 2020 2020 2020  a;.             
-0005a240: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0005a250: 785b 6e5f 6469 6d73 2f32 5d20 3d20 2d20  x[n_dims/2] = - 
-0005a260: 6479 302a 7369 6e5f 7468 6574 6120 2b20  dy0*sin_theta + 
-0005a270: 6479 312a 636f 735f 7468 6574 613b 0a20  dy1*cos_theta;. 
-0005a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005a290: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0005a2a0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0005a2b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005a2c0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0005a2d0: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
-0005a2e0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-0005a2f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0005a300: 7264 5f72 6f70 655f 6261 636b 5f66 3136  rd_rope_back_f16
-0005a310: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-0005a320: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-0005a330: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-0005a340: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-0005a350: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0005a360: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-0005a370: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0005a380: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0005a390: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
-0005a3a0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0005a3b0: 7220 2a20 6473 7429 207b 0a20 2020 2061  r * dst) {.    a
-0005a3c0: 7373 6572 7428 7372 6331 2d3e 7479 7065  ssert(src1->type
-0005a3d0: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
-0005a3e0: 3229 3b0a 2020 2020 6173 7365 7274 2867  2);.    assert(g
-0005a3f0: 676d 6c5f 6e65 6c65 6d65 6e74 7328 7372  gml_nelements(sr
-0005a400: 6331 2920 3d3d 2033 293b 0a0a 2020 2020  c1) == 3);..    
-0005a410: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0005a420: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-0005a430: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-0005a440: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-0005a450: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-0005a460: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-0005a470: 7d0a 0a20 2020 202f 2f20 7920 3d20 726f  }..    // y = ro
-0005a480: 7065 2878 2c20 7372 6331 290a 2020 2020  pe(x, src1).    
-0005a490: 2f2f 2064 7820 3d20 726f 7065 5f62 6163  // dx = rope_bac
-0005a4a0: 6b28 6479 2c20 7372 6331 290a 2020 2020  k(dy, src1).    
-0005a4b0: 2f2f 2073 7263 3020 6973 2064 792c 2073  // src0 is dy, s
-0005a4c0: 7263 3120 636f 6e74 6169 6e73 206f 7074  rc1 contains opt
-0005a4d0: 696f 6e73 0a0a 2020 2020 636f 6e73 7420  ions..    const 
-0005a4e0: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
-0005a4f0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-0005a500: 6461 7461 295b 305d 3b0a 2020 2020 636f  data)[0];.    co
-0005a510: 6e73 7420 696e 7420 6e5f 6469 6d73 203d  nst int n_dims =
-0005a520: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-0005a530: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
-0005a540: 2020 636f 6e73 7420 696e 7420 6d6f 6465    const int mode
-0005a550: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
-0005a560: 2920 7372 6331 2d3e 6461 7461 295b 325d  ) src1->data)[2]
-0005a570: 3b0a 0a20 2020 2061 7373 6572 7428 6e5f  ;..    assert(n_
-0005a580: 7061 7374 203e 3d20 3029 3b0a 0a20 2020  past >= 0);..   
-0005a590: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0005a5a0: 3030 203d 2073 7263 302d 3e6e 625b 305d  00 = src0->nb[0]
-0005a5b0: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
-0005a5c0: 5f74 206e 6230 3120 3d20 7372 6330 2d3e  _t nb01 = src0->
-0005a5d0: 6e62 5b31 5d3b 0a20 2020 2063 6f6e 7374  nb[1];.    const
-0005a5e0: 2073 697a 655f 7420 6e62 3032 203d 2073   size_t nb02 = s
-0005a5f0: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
-0005a600: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-0005a610: 3320 3d20 7372 6330 2d3e 6e62 5b33 5d3b  3 = src0->nb[3];
-0005a620: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-0005a630: 345f 7420 6e65 3020 3d20 6473 742d 3e6e  4_t ne0 = dst->n
-0005a640: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-0005a650: 696e 7436 345f 7420 6e65 3120 3d20 6473  int64_t ne1 = ds
-0005a660: 742d 3e6e 655b 315d 3b0a 2020 2020 636f  t->ne[1];.    co
-0005a670: 6e73 7420 696e 7436 345f 7420 6e65 3220  nst int64_t ne2 
-0005a680: 3d20 6473 742d 3e6e 655b 325d 3b0a 2020  = dst->ne[2];.  
-0005a690: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0005a6a0: 6e65 3320 3d20 6473 742d 3e6e 655b 335d  ne3 = dst->ne[3]
-0005a6b0: 3b0a 0a20 2020 2063 6f6e 7374 2073 697a  ;..    const siz
-0005a6c0: 655f 7420 6e62 3020 3d20 6473 742d 3e6e  e_t nb0 = dst->n
-0005a6d0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-0005a6e0: 7369 7a65 5f74 206e 6231 203d 2064 7374  size_t nb1 = dst
-0005a6f0: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-0005a700: 7374 2073 697a 655f 7420 6e62 3220 3d20  st size_t nb2 = 
-0005a710: 6473 742d 3e6e 625b 325d 3b0a 2020 2020  dst->nb[2];.    
-0005a720: 636f 6e73 7420 7369 7a65 5f74 206e 6233  const size_t nb3
-0005a730: 203d 2064 7374 2d3e 6e62 5b33 5d3b 0a0a   = dst->nb[3];..
-0005a740: 0a20 2020 202f 2f70 7269 6e74 6628 226e  .    //printf("n
-0005a750: 6530 3a20 2564 2c20 6e65 313a 2025 642c  e0: %d, ne1: %d,
-0005a760: 206e 6532 3a20 2564 2c20 6e65 333a 2025   ne2: %d, ne3: %
-0005a770: 645c 6e22 2c20 6e65 302c 206e 6531 2c20  d\n", ne0, ne1, 
-0005a780: 6e65 322c 206e 6533 293b 0a20 2020 202f  ne2, ne3);.    /
-0005a790: 2f70 7269 6e74 6628 226e 5f70 6173 7420  /printf("n_past 
-0005a7a0: 3d20 2564 2c20 6e65 3220 3d20 2564 5c6e  = %d, ne2 = %d\n
-0005a7b0: 222c 206e 5f70 6173 742c 206e 6532 293b  ", n_past, ne2);
-0005a7c0: 0a0a 2020 2020 6173 7365 7274 286e 6230  ..    assert(nb0
-0005a7d0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
-0005a7e0: 6670 3136 5f74 2929 3b0a 0a20 2020 2063  fp16_t));..    c
-0005a7f0: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
-0005a800: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
-0005a810: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
-0005a820: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
-0005a830: 2020 636f 6e73 7420 696e 7420 6e72 203d    const int nr =
-0005a840: 2067 676d 6c5f 6e72 6f77 7328 6473 7429   ggml_nrows(dst)
-0005a850: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
-0005a860: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
-0005a870: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
-0005a880: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
-0005a890: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
-0005a8a0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-0005a8b0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-0005a8c0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-0005a8d0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
-0005a8e0: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
-0005a8f0: 206e 7229 3b0a 0a20 2020 202f 2f20 726f   nr);..    // ro
-0005a900: 7720 696e 6465 7820 7573 6564 2074 6f20  w index used to 
-0005a910: 6465 7465 726d 696e 6520 7768 6963 6820  determine which 
-0005a920: 7468 7265 6164 2074 6f20 7573 650a 2020  thread to use.  
-0005a930: 2020 696e 7420 6972 203d 2030 3b0a 0a20    int ir = 0;.. 
-0005a940: 2020 2063 6f6e 7374 2066 6c6f 6174 2074     const float t
-0005a950: 6865 7461 5f73 6361 6c65 203d 2070 6f77  heta_scale = pow
-0005a960: 6628 3130 3030 302e 302c 202d 322e 3066  f(10000.0, -2.0f
-0005a970: 2f6e 5f64 696d 7329 3b0a 0a20 2020 2063  /n_dims);..    c
-0005a980: 6f6e 7374 2062 6f6f 6c20 6973 5f6e 656f  onst bool is_neo
-0005a990: 7820 3d20 6d6f 6465 2026 2032 3b0a 0a20  x = mode & 2;.. 
-0005a9a0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-0005a9b0: 6933 203d 2030 3b20 6933 203c 206e 6533  i3 = 0; i3 < ne3
-0005a9c0: 3b20 6933 2b2b 2920 7b0a 2020 2020 2020  ; i3++) {.      
-0005a9d0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-0005a9e0: 3220 3d20 2828 6d6f 6465 2026 2031 2920  2 = ((mode & 1) 
-0005a9f0: 3d3d 2030 203f 2030 203a 206e 5f70 6173  == 0 ? 0 : n_pas
-0005aa00: 7429 3b20 6932 203c 206e 6532 3b20 6932  t); i2 < ne2; i2
-0005aa10: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0005aa20: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0005aa30: 7020 3d20 2828 6d6f 6465 2026 2031 2920  p = ((mode & 1) 
-0005aa40: 3d3d 2030 203f 206e 5f70 6173 7420 2b20  == 0 ? n_past + 
-0005aa50: 6932 203a 2069 3229 3b0a 2020 2020 2020  i2 : i2);.      
-0005aa60: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0005aa70: 5f74 2069 3120 3d20 303b 2069 3120 3c20  _t i1 = 0; i1 < 
-0005aa80: 6e65 313b 2069 312b 2b29 207b 0a20 2020  ne1; i1++) {.   
-0005aa90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0005aaa0: 2869 722b 2b20 3c20 6972 3029 2063 6f6e  (ir++ < ir0) con
-0005aab0: 7469 6e75 653b 0a20 2020 2020 2020 2020  tinue;.         
-0005aac0: 2020 2020 2020 2069 6620 2869 7220 2020         if (ir   
-0005aad0: 3e20 6972 3129 2062 7265 616b 3b0a 0a20  > ir1) break;.. 
-0005aae0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005aaf0: 6c6f 6174 2074 6865 7461 203d 2028 666c  loat theta = (fl
-0005ab00: 6f61 7429 703b 0a0a 2020 2020 2020 2020  oat)p;..        
-0005ab10: 2020 2020 2020 2020 6966 2028 2169 735f          if (!is_
-0005ab20: 6e65 6f78 2920 7b0a 2020 2020 2020 2020  neox) {.        
-0005ab30: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0005ab40: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
-0005ab50: 2069 3020 3c20 6e65 303b 2069 3020 2b3d   i0 < ne0; i0 +=
-0005ab60: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
-0005ab70: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005ab80: 6e73 7420 666c 6f61 7420 636f 735f 7468  nst float cos_th
-0005ab90: 6574 6120 3d20 636f 7366 2874 6865 7461  eta = cosf(theta
-0005aba0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005abb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005abc0: 2066 6c6f 6174 2073 696e 5f74 6865 7461   float sin_theta
-0005abd0: 203d 2073 696e 6628 7468 6574 6129 3b0a   = sinf(theta);.
-0005abe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005abf0: 2020 2020 2020 2020 2074 6865 7461 202a           theta *
-0005ac00: 3d20 7468 6574 615f 7363 616c 653b 0a0a  = theta_scale;..
-0005ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ac20: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
-0005ac30: 6d6c 5f66 7031 365f 7420 2a20 636f 6e73  ml_fp16_t * cons
-0005ac40: 7420 6479 2020 3d20 2867 676d 6c5f 6670  t dy  = (ggml_fp
-0005ac50: 3136 5f74 202a 2928 2863 6861 7220 2a29  16_t *)((char *)
-0005ac60: 2073 7263 302d 3e64 6174 6120 2b20 6933   src0->data + i3
-0005ac70: 2a6e 6230 3320 2b20 6932 2a6e 6230 3220  *nb03 + i2*nb02 
-0005ac80: 2b20 6931 2a6e 6230 3120 2b20 6930 2a6e  + i1*nb01 + i0*n
-0005ac90: 6230 3029 3b0a 2020 2020 2020 2020 2020  b00);.          
+0005a200: 2020 2020 2020 2020 6478 5b30 5d20 2020          dx[0]   
+0005a210: 2020 2020 203d 2020 2064 7930 2a63 6f73       =   dy0*cos
+0005a220: 5f74 6865 7461 202b 2064 7931 2a73 696e  _theta + dy1*sin
+0005a230: 5f74 6865 7461 3b0a 2020 2020 2020 2020  _theta;.        
+0005a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a250: 2020 2020 6478 5b6e 5f64 696d 732f 325d      dx[n_dims/2]
+0005a260: 203d 202d 2064 7930 2a73 696e 5f74 6865   = - dy0*sin_the
+0005a270: 7461 202b 2064 7931 2a63 6f73 5f74 6865  ta + dy1*cos_the
+0005a280: 7461 3b0a 2020 2020 2020 2020 2020 2020  ta;.            
+0005a290: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0005a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005a2b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0005a2c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0005a2d0: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+0005a2e0: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+0005a2f0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+0005a300: 666f 7277 6172 645f 726f 7065 5f62 6163  forward_rope_bac
+0005a310: 6b5f 6631 3628 0a20 2020 2020 2020 2063  k_f16(.        c
+0005a320: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0005a330: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
+0005a340: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
+0005a350: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0005a360: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0005a370: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
+0005a380: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0005a390: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
+0005a3a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0005a3b0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+0005a3c0: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
+0005a3d0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+0005a3e0: 5045 5f49 3332 293b 0a20 2020 2061 7373  PE_I32);.    ass
+0005a3f0: 6572 7428 6767 6d6c 5f6e 656c 656d 656e  ert(ggml_nelemen
+0005a400: 7473 2873 7263 3129 203d 3d20 3329 3b0a  ts(src1) == 3);.
+0005a410: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0005a420: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0005a430: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+0005a440: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0005a450: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+0005a460: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0005a470: 0a20 2020 207d 0a0a 2020 2020 2f2f 2079  .    }..    // y
+0005a480: 203d 2072 6f70 6528 782c 2073 7263 3129   = rope(x, src1)
+0005a490: 0a20 2020 202f 2f20 6478 203d 2072 6f70  .    // dx = rop
+0005a4a0: 655f 6261 636b 2864 792c 2073 7263 3129  e_back(dy, src1)
+0005a4b0: 0a20 2020 202f 2f20 7372 6330 2069 7320  .    // src0 is 
+0005a4c0: 6479 2c20 7372 6331 2063 6f6e 7461 696e  dy, src1 contain
+0005a4d0: 7320 6f70 7469 6f6e 730a 0a20 2020 2063  s options..    c
+0005a4e0: 6f6e 7374 2069 6e74 206e 5f70 6173 7420  onst int n_past 
+0005a4f0: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+0005a500: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
+0005a510: 2020 2063 6f6e 7374 2069 6e74 206e 5f64     const int n_d
+0005a520: 696d 7320 3d20 2828 696e 7433 325f 7420  ims = ((int32_t 
+0005a530: 2a29 2073 7263 312d 3e64 6174 6129 5b31  *) src1->data)[1
+0005a540: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005a550: 206d 6f64 6520 2020 3d20 2828 696e 7433   mode   = ((int3
+0005a560: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+0005a570: 6129 5b32 5d3b 0a0a 2020 2020 6173 7365  a)[2];..    asse
+0005a580: 7274 286e 5f70 6173 7420 3e3d 2030 293b  rt(n_past >= 0);
+0005a590: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
+0005a5a0: 5f74 206e 6230 3020 3d20 7372 6330 2d3e  _t nb00 = src0->
+0005a5b0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
+0005a5c0: 2073 697a 655f 7420 6e62 3031 203d 2073   size_t nb01 = s
+0005a5d0: 7263 302d 3e6e 625b 315d 3b0a 2020 2020  rc0->nb[1];.    
+0005a5e0: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
+0005a5f0: 3220 3d20 7372 6330 2d3e 6e62 5b32 5d3b  2 = src0->nb[2];
+0005a600: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0005a610: 7420 6e62 3033 203d 2073 7263 302d 3e6e  t nb03 = src0->n
+0005a620: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+0005a630: 2069 6e74 3634 5f74 206e 6530 203d 2064   int64_t ne0 = d
+0005a640: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
+0005a650: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
+0005a660: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
+0005a670: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+0005a680: 206e 6532 203d 2064 7374 2d3e 6e65 5b32   ne2 = dst->ne[2
+0005a690: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005a6a0: 3634 5f74 206e 6533 203d 2064 7374 2d3e  64_t ne3 = dst->
+0005a6b0: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+0005a6c0: 7420 7369 7a65 5f74 206e 6230 203d 2064  t size_t nb0 = d
+0005a6d0: 7374 2d3e 6e62 5b30 5d3b 0a20 2020 2063  st->nb[0];.    c
+0005a6e0: 6f6e 7374 2073 697a 655f 7420 6e62 3120  onst size_t nb1 
+0005a6f0: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
+0005a700: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0005a710: 6232 203d 2064 7374 2d3e 6e62 5b32 5d3b  b2 = dst->nb[2];
+0005a720: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
+0005a730: 7420 6e62 3320 3d20 6473 742d 3e6e 625b  t nb3 = dst->nb[
+0005a740: 335d 3b0a 0a0a 2020 2020 2f2f 7072 696e  3];...    //prin
+0005a750: 7466 2822 6e65 303a 2025 642c 206e 6531  tf("ne0: %d, ne1
+0005a760: 3a20 2564 2c20 6e65 323a 2025 642c 206e  : %d, ne2: %d, n
+0005a770: 6533 3a20 2564 5c6e 222c 206e 6530 2c20  e3: %d\n", ne0, 
+0005a780: 6e65 312c 206e 6532 2c20 6e65 3329 3b0a  ne1, ne2, ne3);.
+0005a790: 2020 2020 2f2f 7072 696e 7466 2822 6e5f      //printf("n_
+0005a7a0: 7061 7374 203d 2025 642c 206e 6532 203d  past = %d, ne2 =
+0005a7b0: 2025 645c 6e22 2c20 6e5f 7061 7374 2c20   %d\n", n_past, 
+0005a7c0: 6e65 3229 3b0a 0a20 2020 2061 7373 6572  ne2);..    asser
+0005a7d0: 7428 6e62 3020 3d3d 2073 697a 656f 6628  t(nb0 == sizeof(
+0005a7e0: 6767 6d6c 5f66 7031 365f 7429 293b 0a0a  ggml_fp16_t));..
+0005a7f0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+0005a800: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+0005a810: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005a820: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+0005a830: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0005a840: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
+0005a850: 2864 7374 293b 0a0a 2020 2020 2f2f 2072  (dst);..    // r
+0005a860: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+0005a870: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+0005a880: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+0005a890: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+0005a8a0: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+0005a8b0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+0005a8c0: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+0005a8d0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+0005a8e0: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+0005a8f0: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+0005a900: 2f2f 2072 6f77 2069 6e64 6578 2075 7365  // row index use
+0005a910: 6420 746f 2064 6574 6572 6d69 6e65 2077  d to determine w
+0005a920: 6869 6368 2074 6872 6561 6420 746f 2075  hich thread to u
+0005a930: 7365 0a20 2020 2069 6e74 2069 7220 3d20  se.    int ir = 
+0005a940: 303b 0a0a 2020 2020 636f 6e73 7420 666c  0;..    const fl
+0005a950: 6f61 7420 7468 6574 615f 7363 616c 6520  oat theta_scale 
+0005a960: 3d20 706f 7766 2831 3030 3030 2e30 2c20  = powf(10000.0, 
+0005a970: 2d32 2e30 662f 6e5f 6469 6d73 293b 0a0a  -2.0f/n_dims);..
+0005a980: 2020 2020 636f 6e73 7420 626f 6f6c 2069      const bool i
+0005a990: 735f 6e65 6f78 203d 206d 6f64 6520 2620  s_neox = mode & 
+0005a9a0: 323b 0a0a 2020 2020 666f 7220 2869 6e74  2;..    for (int
+0005a9b0: 3634 5f74 2069 3320 3d20 303b 2069 3320  64_t i3 = 0; i3 
+0005a9c0: 3c20 6e65 333b 2069 332b 2b29 207b 0a20  < ne3; i3++) {. 
+0005a9d0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0005a9e0: 345f 7420 6932 203d 2028 286d 6f64 6520  4_t i2 = ((mode 
+0005a9f0: 2620 3129 203d 3d20 3020 3f20 3020 3a20  & 1) == 0 ? 0 : 
+0005aa00: 6e5f 7061 7374 293b 2069 3220 3c20 6e65  n_past); i2 < ne
+0005aa10: 323b 2069 322b 2b29 207b 0a20 2020 2020  2; i2++) {.     
+0005aa20: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0005aa30: 3634 5f74 2070 203d 2028 286d 6f64 6520  64_t p = ((mode 
+0005aa40: 2620 3129 203d 3d20 3020 3f20 6e5f 7061  & 1) == 0 ? n_pa
+0005aa50: 7374 202b 2069 3220 3a20 6932 293b 0a20  st + i2 : i2);. 
+0005aa60: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0005aa70: 696e 7436 345f 7420 6931 203d 2030 3b20  int64_t i1 = 0; 
+0005aa80: 6931 203c 206e 6531 3b20 6931 2b2b 2920  i1 < ne1; i1++) 
+0005aa90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005aaa0: 2020 6966 2028 6972 2b2b 203c 2069 7230    if (ir++ < ir0
+0005aab0: 2920 636f 6e74 696e 7565 3b0a 2020 2020  ) continue;.    
+0005aac0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0005aad0: 6972 2020 203e 2069 7231 2920 6272 6561  ir   > ir1) brea
+0005aae0: 6b3b 0a0a 2020 2020 2020 2020 2020 2020  k;..            
+0005aaf0: 2020 2020 666c 6f61 7420 7468 6574 6120      float theta 
+0005ab00: 3d20 2866 6c6f 6174 2970 3b0a 0a20 2020  = (float)p;..   
+0005ab10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0005ab20: 2821 6973 5f6e 656f 7829 207b 0a20 2020  (!is_neox) {.   
+0005ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ab40: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+0005ab50: 203d 2030 3b20 6930 203c 206e 6530 3b20   = 0; i0 < ne0; 
+0005ab60: 6930 202b 3d20 3229 207b 0a20 2020 2020  i0 += 2) {.     
+0005ab70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ab80: 2020 2063 6f6e 7374 2066 6c6f 6174 2063     const float c
+0005ab90: 6f73 5f74 6865 7461 203d 2063 6f73 6628  os_theta = cosf(
+0005aba0: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
+0005abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005abc0: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
+0005abd0: 7468 6574 6120 3d20 7369 6e66 2874 6865  theta = sinf(the
+0005abe0: 7461 293b 0a0a 2020 2020 2020 2020 2020  ta);..          
+0005abf0: 2020 2020 2020 2020 2020 2020 2020 7468                th
+0005ac00: 6574 6120 2a3d 2074 6865 7461 5f73 6361  eta *= theta_sca
+0005ac10: 6c65 3b0a 0a20 2020 2020 2020 2020 2020  le;..           
+0005ac20: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005ac30: 7374 2067 676d 6c5f 6670 3136 5f74 202a  st ggml_fp16_t *
+0005ac40: 2063 6f6e 7374 2064 7920 203d 2028 6767   const dy  = (gg
+0005ac50: 6d6c 5f66 7031 365f 7420 2a29 2828 6368  ml_fp16_t *)((ch
+0005ac60: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0005ac70: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
+0005ac80: 6e62 3032 202b 2069 312a 6e62 3031 202b  nb02 + i1*nb01 +
+0005ac90: 2069 302a 6e62 3030 293b 0a20 2020 2020   i0*nb00);.     
 0005aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005acb0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-0005acc0: 2a20 2020 2020 2020 6478 2020 3d20 2867  *       dx  = (g
-0005acd0: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
-0005ace0: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-0005acf0: 6120 2b20 6933 2a6e 6233 2020 2b20 6932  a + i3*nb3  + i2
-0005ad00: 2a6e 6232 2020 2b20 6931 2a6e 6231 2020  *nb2  + i1*nb1  
-0005ad10: 2b20 6930 2a6e 6230 293b 0a0a 2020 2020  + i0*nb0);..    
-0005ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ad30: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0005ad40: 6479 3020 3d20 4747 4d4c 5f46 5031 365f  dy0 = GGML_FP16_
-0005ad50: 544f 5f46 5033 3228 6479 5b30 5d29 3b0a  TO_FP32(dy[0]);.
-0005ad60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ad70: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005ad80: 6f61 7420 6479 3120 3d20 4747 4d4c 5f46  oat dy1 = GGML_F
-0005ad90: 5031 365f 544f 5f46 5033 3228 6479 5b31  P16_TO_FP32(dy[1
-0005ada0: 5d29 3b0a 0a20 2020 2020 2020 2020 2020  ]);..           
-0005adb0: 2020 2020 2020 2020 2020 2020 2064 785b               dx[
-0005adc0: 305d 203d 2047 474d 4c5f 4650 3332 5f54  0] = GGML_FP32_T
-0005add0: 4f5f 4650 3136 2820 6479 302a 636f 735f  O_FP16( dy0*cos_
-0005ade0: 7468 6574 6120 2b20 6479 312a 7369 6e5f  theta + dy1*sin_
-0005adf0: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
+0005acb0: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
+0005acc0: 3136 5f74 202a 2020 2020 2020 2064 7820  16_t *       dx 
+0005acd0: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
+0005ace0: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
+0005acf0: 2d3e 6461 7461 202b 2069 332a 6e62 3320  ->data + i3*nb3 
+0005ad00: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
+0005ad10: 6e62 3120 202b 2069 302a 6e62 3029 3b0a  nb1  + i0*nb0);.
+0005ad20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005ad30: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005ad40: 6c6f 6174 2064 7930 203d 2047 474d 4c5f  loat dy0 = GGML_
+0005ad50: 4650 3136 5f54 4f5f 4650 3332 2864 795b  FP16_TO_FP32(dy[
+0005ad60: 305d 293b 0a20 2020 2020 2020 2020 2020  0]);.           
+0005ad70: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005ad80: 7374 2066 6c6f 6174 2064 7931 203d 2047  st float dy1 = G
+0005ad90: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
+0005ada0: 2864 795b 315d 293b 0a0a 2020 2020 2020  (dy[1]);..      
+0005adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005adc0: 2020 6478 5b30 5d20 3d20 4747 4d4c 5f46    dx[0] = GGML_F
+0005add0: 5033 325f 544f 5f46 5031 3628 2064 7930  P32_TO_FP16( dy0
+0005ade0: 2a63 6f73 5f74 6865 7461 202b 2064 7931  *cos_theta + dy1
+0005adf0: 2a73 696e 5f74 6865 7461 293b 0a20 2020  *sin_theta);.   
 0005ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ae10: 6478 5b31 5d20 3d20 4747 4d4c 5f46 5033  dx[1] = GGML_FP3
-0005ae20: 325f 544f 5f46 5031 3628 2d64 7930 2a73  2_TO_FP16(-dy0*s
-0005ae30: 696e 5f74 6865 7461 202b 2064 7931 2a63  in_theta + dy1*c
-0005ae40: 6f73 5f74 6865 7461 293b 0a20 2020 2020  os_theta);.     
-0005ae50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005ae60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005ae70: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-0005ae80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0005ae90: 7220 2869 6e74 3634 5f74 2069 6220 3d20  r (int64_t ib = 
-0005aea0: 303b 2069 6220 3c20 6e65 302f 6e5f 6469  0; ib < ne0/n_di
-0005aeb0: 6d73 3b20 2b2b 6962 2920 7b0a 2020 2020  ms; ++ib) {.    
-0005aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005aed0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005aee0: 2069 6320 3d20 303b 2069 6320 3c20 6e5f   ic = 0; ic < n_
-0005aef0: 6469 6d73 3b20 6963 202b 3d20 3229 207b  dims; ic += 2) {
-0005af00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005af10: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0005af20: 7374 2066 6c6f 6174 2063 6f73 5f74 6865  st float cos_the
-0005af30: 7461 203d 2063 6f73 6628 7468 6574 6129  ta = cosf(theta)
-0005af40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0005af50: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005af60: 6e73 7420 666c 6f61 7420 7369 6e5f 7468  nst float sin_th
-0005af70: 6574 6120 3d20 7369 6e66 2874 6865 7461  eta = sinf(theta
-0005af80: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0005ae10: 2020 2020 2064 785b 315d 203d 2047 474d       dx[1] = GGM
+0005ae20: 4c5f 4650 3332 5f54 4f5f 4650 3136 282d  L_FP32_TO_FP16(-
+0005ae30: 6479 302a 7369 6e5f 7468 6574 6120 2b20  dy0*sin_theta + 
+0005ae40: 6479 312a 636f 735f 7468 6574 6129 3b0a  dy1*cos_theta);.
+0005ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ae60: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0005ae70: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+0005ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ae90: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0005aea0: 6962 203d 2030 3b20 6962 203c 206e 6530  ib = 0; ib < ne0
+0005aeb0: 2f6e 5f64 696d 733b 202b 2b69 6229 207b  /n_dims; ++ib) {
+0005aec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005aed0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0005aee0: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
+0005aef0: 203c 206e 5f64 696d 733b 2069 6320 2b3d   < n_dims; ic +=
+0005af00: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
+0005af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005af20: 2020 636f 6e73 7420 666c 6f61 7420 636f    const float co
+0005af30: 735f 7468 6574 6120 3d20 636f 7366 2874  s_theta = cosf(t
+0005af40: 6865 7461 293b 0a20 2020 2020 2020 2020  heta);.         
+0005af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005af60: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
+0005af70: 696e 5f74 6865 7461 203d 2073 696e 6628  in_theta = sinf(
+0005af80: 7468 6574 6129 3b0a 0a20 2020 2020 2020  theta);..       
 0005af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005afa0: 7468 6574 6120 2a3d 2074 6865 7461 5f73  theta *= theta_s
-0005afb0: 6361 6c65 3b0a 0a20 2020 2020 2020 2020  cale;..         
+0005afa0: 2020 2020 2074 6865 7461 202a 3d20 7468       theta *= th
+0005afb0: 6574 615f 7363 616c 653b 0a0a 2020 2020  eta_scale;..    
 0005afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005afd0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-0005afe0: 2069 3020 3d20 6962 2a6e 5f64 696d 7320   i0 = ib*n_dims 
-0005aff0: 2b20 6963 2f32 3b0a 0a20 2020 2020 2020  + ic/2;..       
+0005afd0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0005afe0: 7436 345f 7420 6930 203d 2069 622a 6e5f  t64_t i0 = ib*n_
+0005aff0: 6469 6d73 202b 2069 632f 323b 0a0a 2020  dims + ic/2;..  
 0005b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b010: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
-0005b020: 6670 3136 5f74 202a 2063 6f6e 7374 2064  fp16_t * const d
-0005b030: 7920 203d 2028 6767 6d6c 5f66 7031 365f  y  = (ggml_fp16_
-0005b040: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
-0005b050: 6330 2d3e 6461 7461 202b 2069 332a 6e62  c0->data + i3*nb
-0005b060: 3033 202b 2069 322a 6e62 3032 202b 2069  03 + i2*nb02 + i
-0005b070: 312a 6e62 3031 202b 2069 302a 6e62 3030  1*nb01 + i0*nb00
-0005b080: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0005b010: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005b020: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
+0005b030: 6e73 7420 6479 2020 3d20 2867 676d 6c5f  nst dy  = (ggml_
+0005b040: 6670 3136 5f74 202a 2928 2863 6861 7220  fp16_t *)((char 
+0005b050: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+0005b060: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
+0005b070: 3220 2b20 6931 2a6e 6230 3120 2b20 6930  2 + i1*nb01 + i0
+0005b080: 2a6e 6230 3029 3b0a 2020 2020 2020 2020  *nb00);.        
 0005b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b0a0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
-0005b0b0: 202a 2020 2020 2020 2064 7820 203d 2028   *       dx  = (
-0005b0c0: 6767 6d6c 5f66 7031 365f 7420 2a29 2828  ggml_fp16_t *)((
-0005b0d0: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
-0005b0e0: 7461 202b 2069 332a 6e62 3320 202b 2069  ta + i3*nb3  + i
-0005b0f0: 322a 6e62 3220 202b 2069 312a 6e62 3120  2*nb2  + i1*nb1 
-0005b100: 202b 2069 302a 6e62 3029 3b0a 0a20 2020   + i0*nb0);..   
-0005b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b120: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0005b130: 6c6f 6174 2064 7930 203d 2047 474d 4c5f  loat dy0 = GGML_
-0005b140: 4650 3136 5f54 4f5f 4650 3332 2864 795b  FP16_TO_FP32(dy[
-0005b150: 305d 293b 0a20 2020 2020 2020 2020 2020  0]);.           
+0005b0a0: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+0005b0b0: 7031 365f 7420 2a20 2020 2020 2020 6478  p16_t *       dx
+0005b0c0: 2020 3d20 2867 676d 6c5f 6670 3136 5f74    = (ggml_fp16_t
+0005b0d0: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
+0005b0e0: 742d 3e64 6174 6120 2b20 6933 2a6e 6233  t->data + i3*nb3
+0005b0f0: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
+0005b100: 2a6e 6231 2020 2b20 6930 2a6e 6230 293b  *nb1  + i0*nb0);
+0005b110: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005b120: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0005b130: 6e73 7420 666c 6f61 7420 6479 3020 3d20  nst float dy0 = 
+0005b140: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+0005b150: 3228 6479 5b30 5d29 3b0a 2020 2020 2020  2(dy[0]);.      
 0005b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b170: 2063 6f6e 7374 2066 6c6f 6174 2064 7931   const float dy1
-0005b180: 203d 2047 474d 4c5f 4650 3136 5f54 4f5f   = GGML_FP16_TO_
-0005b190: 4650 3332 2864 795b 6e5f 6469 6d73 2f32  FP32(dy[n_dims/2
-0005b1a0: 5d29 3b0a 0a20 2020 2020 2020 2020 2020  ]);..           
+0005b170: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+0005b180: 7420 6479 3120 3d20 4747 4d4c 5f46 5031  t dy1 = GGML_FP1
+0005b190: 365f 544f 5f46 5033 3228 6479 5b6e 5f64  6_TO_FP32(dy[n_d
+0005b1a0: 696d 732f 325d 293b 0a0a 2020 2020 2020  ims/2]);..      
 0005b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b1c0: 2064 785b 305d 2020 2020 2020 2020 3d20   dx[0]        = 
-0005b1d0: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
-0005b1e0: 3628 2064 7930 2a63 6f73 5f74 6865 7461  6( dy0*cos_theta
-0005b1f0: 202b 2064 7931 2a73 696e 5f74 6865 7461   + dy1*sin_theta
-0005b200: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005b210: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0005b220: 785b 6e5f 6469 6d73 2f32 5d20 3d20 4747  x[n_dims/2] = GG
-0005b230: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-0005b240: 2d64 7930 2a73 696e 5f74 6865 7461 202b  -dy0*sin_theta +
-0005b250: 2064 7931 2a63 6f73 5f74 6865 7461 293b   dy1*cos_theta);
-0005b260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005b270: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0005b280: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005b290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005b2a0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0005b2b0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0005b2c0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-0005b2d0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0005b2e0: 7761 7264 5f72 6f70 655f 6261 636b 280a  ward_rope_back(.
-0005b2f0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005b300: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0005b310: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-0005b320: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-0005b330: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005b340: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-0005b350: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005b360: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-0005b370: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
-0005b380: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005b390: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-0005b3a0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-0005b3b0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-0005b3c0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-0005b3d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0005b3e0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0005b3f0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0005b400: 645f 726f 7065 5f62 6163 6b5f 6631 3628  d_rope_back_f16(
-0005b410: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-0005b420: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-0005b430: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0005b440: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005b450: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-0005b460: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0005b470: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-0005b480: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
-0005b490: 7065 5f62 6163 6b5f 6633 3228 7061 7261  pe_back_f32(para
-0005b4a0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
-0005b4b0: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
-0005b4c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0005b4d0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
-0005b4e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0005b4f0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0005b500: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
-0005b510: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0005b520: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
-0005b530: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0005b540: 6172 645f 636f 6e76 5f31 645f 7331 5f70  ard_conv_1d_s1_p
-0005b550: 680a 0a73 7461 7469 6320 766f 6964 2067  h..static void g
-0005b560: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0005b570: 6172 645f 636f 6e76 5f31 645f 7331 5f70  ard_conv_1d_s1_p
-0005b580: 685f 6631 365f 6633 3228 0a20 2020 2020  h_f16_f32(.     
-0005b590: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0005b5a0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-0005b5b0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-0005b5c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0005b5d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0005b5e0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-0005b5f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0005b600: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-0005b610: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0005b620: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005b630: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
-0005b640: 4d4c 5f41 5353 4552 5428 7372 6330 2d3e  ML_ASSERT(src0->
-0005b650: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0005b660: 455f 4631 3629 3b0a 2020 2020 4747 4d4c  E_F16);.    GGML
-0005b670: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
-0005b680: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0005b690: 4633 3229 3b0a 2020 2020 4747 4d4c 5f41  F32);.    GGML_A
-0005b6a0: 5353 4552 5428 2064 7374 2d3e 7479 7065  SSERT( dst->type
-0005b6b0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-0005b6c0: 3229 3b0a 0a20 2020 2069 6e74 3634 5f74  2);..    int64_t
-0005b6d0: 2074 3020 3d20 6767 6d6c 5f70 6572 665f   t0 = ggml_perf_
-0005b6e0: 7469 6d65 5f75 7328 293b 0a20 2020 2055  time_us();.    U
-0005b6f0: 4e55 5345 4428 7430 293b 0a0a 2020 2020  NUSED(t0);..    
-0005b700: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005b710: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
-0005b720: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-0005b730: 345f 7420 6e65 3031 203d 2073 7263 302d  4_t ne01 = src0-
-0005b740: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-0005b750: 7420 696e 7436 345f 7420 6e65 3032 203d  t int64_t ne02 =
-0005b760: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
-0005b770: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
-0005b780: 7420 6e65 3033 203d 2073 7263 302d 3e6e  t ne03 = src0->n
-0005b790: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
-0005b7a0: 2069 6e74 3634 5f74 206e 6531 3020 3d20   int64_t ne10 = 
-0005b7b0: 7372 6331 2d3e 6e65 5b30 5d3b 0a20 2020  src1->ne[0];.   
-0005b7c0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-0005b7d0: 6531 3120 3d20 7372 6331 2d3e 6e65 5b31  e11 = src1->ne[1
-0005b7e0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-0005b7f0: 6e74 3634 5f74 206e 6531 3220 3d20 7372  nt64_t ne12 = sr
-0005b800: 6331 2d3e 6e65 5b32 5d3b 0a20 2020 202f  c1->ne[2];.    /
-0005b810: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-0005b820: 6531 3320 3d20 7372 6331 2d3e 6e65 5b33  e13 = src1->ne[3
-0005b830: 5d3b 0a0a 2020 2020 2f2f 636f 6e73 7420  ];..    //const 
-0005b840: 696e 7436 345f 7420 6e65 3020 203d 2064  int64_t ne0  = d
-0005b850: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 202f  st->ne[0];.    /
-0005b860: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-0005b870: 6531 2020 3d20 6473 742d 3e6e 655b 315d  e1  = dst->ne[1]
-0005b880: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0005b890: 7436 345f 7420 6e65 3220 203d 2064 7374  t64_t ne2  = dst
-0005b8a0: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
-0005b8b0: 6f6e 7374 2069 6e74 3634 5f74 206e 6533  onst int64_t ne3
-0005b8c0: 2020 3d20 6473 742d 3e6e 655b 335d 3b0a    = dst->ne[3];.
-0005b8d0: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-0005b8e0: 345f 7420 6e65 2020 203d 206e 6530 2a6e  4_t ne   = ne0*n
-0005b8f0: 6531 2a6e 6532 2a6e 6533 3b0a 0a20 2020  e1*ne2*ne3;..   
-0005b900: 2063 6f6e 7374 2069 6e74 206e 6230 3020   const int nb00 
-0005b910: 3d20 7372 6330 2d3e 6e62 5b30 5d3b 0a20  = src0->nb[0];. 
-0005b920: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-0005b930: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
-0005b940: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005b950: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
-0005b960: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-0005b970: 6e74 206e 6230 3320 3d20 7372 6330 2d3e  nt nb03 = src0->
-0005b980: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
-0005b990: 7420 696e 7420 6e62 3130 203d 2073 7263  t int nb10 = src
-0005b9a0: 312d 3e6e 625b 305d 3b0a 2020 2020 636f  1->nb[0];.    co
-0005b9b0: 6e73 7420 696e 7420 6e62 3131 203d 2073  nst int nb11 = s
-0005b9c0: 7263 312d 3e6e 625b 315d 3b0a 2020 2020  rc1->nb[1];.    
-0005b9d0: 2f2f 636f 6e73 7420 696e 7420 6e62 3132  //const int nb12
-0005b9e0: 203d 2073 7263 312d 3e6e 625b 325d 3b0a   = src1->nb[2];.
-0005b9f0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0005ba00: 6e62 3133 203d 2073 7263 312d 3e6e 625b  nb13 = src1->nb[
-0005ba10: 335d 3b0a 0a20 2020 202f 2f63 6f6e 7374  3];..    //const
-0005ba20: 2069 6e74 206e 6230 2020 3d20 6473 742d   int nb0  = dst-
-0005ba30: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0005ba40: 7420 696e 7420 6e62 3120 203d 2064 7374  t int nb1  = dst
-0005ba50: 2d3e 6e62 5b31 5d3b 0a20 2020 202f 2f63  ->nb[1];.    //c
-0005ba60: 6f6e 7374 2069 6e74 206e 6232 2020 3d20  onst int nb2  = 
-0005ba70: 6473 742d 3e6e 625b 325d 3b0a 2020 2020  dst->nb[2];.    
-0005ba80: 2f2f 636f 6e73 7420 696e 7420 6e62 3320  //const int nb3 
-0005ba90: 203d 2064 7374 2d3e 6e62 5b33 5d3b 0a0a   = dst->nb[3];..
-0005baa0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
-0005bab0: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
-0005bac0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005bad0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
-0005bae0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0005baf0: 206e 6b20 3d20 6e65 3030 3b0a 2020 2020   nk = ne00;.    
-0005bb00: 636f 6e73 7420 696e 7420 6e68 203d 206e  const int nh = n
-0005bb10: 6b2f 323b 0a0a 2020 2020 636f 6e73 7420  k/2;..    const 
-0005bb20: 696e 7420 6577 3020 3d20 6767 6d6c 5f75  int ew0 = ggml_u
-0005bb30: 7033 3228 6e65 3031 293b 0a0a 2020 2020  p32(ne01);..    
-0005bb40: 4747 4d4c 5f41 5353 4552 5428 6e65 3030  GGML_ASSERT(ne00
-0005bb50: 2025 2032 203d 3d20 3129 3b20 2f2f 2054   % 2 == 1); // T
-0005bb60: 4f44 4f3a 2073 7570 706f 7274 2065 7665  ODO: support eve
-0005bb70: 6e20 6b65 726e 656c 2073 697a 6573 0a20  n kernel sizes. 
-0005bb80: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0005bb90: 6230 3020 3d3d 2073 697a 656f 6628 6767  b00 == sizeof(gg
-0005bba0: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
-0005bbb0: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
-0005bbc0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-0005bbd0: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
-0005bbe0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-0005bbf0: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
-0005bc00: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-0005bc10: 2066 6978 2074 6869 7320 6d65 6d73 6574   fix this memset
-0005bc20: 2028 7773 697a 6520 6973 206f 7665 7265   (wsize is overe
-0005bc30: 7374 696d 6174 6564 290a 2020 2020 2020  stimated).      
-0005bc40: 2020 6d65 6d73 6574 2870 6172 616d 732d    memset(params-
-0005bc50: 3e77 6461 7461 2c20 302c 2070 6172 616d  >wdata, 0, param
-0005bc60: 732d 3e77 7369 7a65 293b 0a0a 2020 2020  s->wsize);..    
-0005bc70: 2020 2020 2f2f 2070 7265 7061 7265 206b      // prepare k
-0005bc80: 6572 6e65 6c20 6461 7461 2028 7372 6330  ernel data (src0
-0005bc90: 290a 2020 2020 2020 2020 7b0a 2020 2020  ).        {.    
-0005bca0: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-0005bcb0: 365f 7420 2a20 636f 6e73 7420 7764 6174  6_t * const wdat
-0005bcc0: 6120 3d20 2867 676d 6c5f 6670 3136 5f74  a = (ggml_fp16_t
-0005bcd0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
-0005bce0: 6120 2b20 303b 0a0a 2020 2020 2020 2020  a + 0;..        
-0005bcf0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005bd00: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
-0005bd10: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
-0005bd20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005bd30: 6f72 2028 696e 7436 345f 7420 6930 3120  or (int64_t i01 
-0005bd40: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
-0005bd50: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
-0005bd60: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005bd70: 6e73 7420 6767 6d6c 5f66 7031 365f 7420  nst ggml_fp16_t 
-0005bd80: 2a20 636f 6e73 7420 7372 6320 3d20 2867  * const src = (g
-0005bd90: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
-0005bda0: 6861 7220 2a29 2073 7263 302d 3e64 6174  har *) src0->dat
-0005bdb0: 6120 2b20 6930 322a 6e62 3032 202b 2069  a + i02*nb02 + i
-0005bdc0: 3031 2a6e 6230 3129 3b0a 2020 2020 2020  01*nb01);.      
-0005bdd0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0005bde0: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
-0005bdf0: 6461 7461 203d 2077 6461 7461 202b 2069  data = wdata + i
-0005be00: 3032 2a65 7730 2a6e 6530 303b 0a20 2020  02*ew0*ne00;.   
-0005be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005be20: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
-0005be30: 3020 3d20 303b 2069 3030 203c 206e 6530  0 = 0; i00 < ne0
-0005be40: 303b 2069 3030 2b2b 2920 7b0a 2020 2020  0; i00++) {.    
-0005be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005be60: 2020 2020 6473 745f 6461 7461 5b69 3030      dst_data[i00
-0005be70: 2a65 7730 202b 2069 3031 5d20 3d20 7372  *ew0 + i01] = sr
-0005be80: 635b 6930 305d 3b0a 2020 2020 2020 2020  c[i00];.        
-0005be90: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005bea0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0005beb0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005bec0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0005bed0: 202f 2f20 7072 6570 6172 6520 736f 7572   // prepare sour
-0005bee0: 6365 2064 6174 6120 2873 7263 3129 0a20  ce data (src1). 
-0005bef0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0005bf00: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
-0005bf10: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
-0005bf20: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-0005bf30: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
-0005bf40: 206e 6530 322a 6577 302a 6e65 3030 3b0a   ne02*ew0*ne00;.
-0005bf50: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0005bf60: 2028 696e 7436 345f 7420 6931 3120 3d20   (int64_t i11 = 
-0005bf70: 303b 2069 3131 203c 206e 6531 313b 2069  0; i11 < ne11; i
-0005bf80: 3131 2b2b 2920 7b0a 2020 2020 2020 2020  11++) {.        
-0005bf90: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005bfa0: 6f61 7420 2a20 636f 6e73 7420 7372 6320  oat * const src 
-0005bfb0: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
-0005bfc0: 7220 2a29 2073 7263 312d 3e64 6174 6120  r *) src1->data 
-0005bfd0: 2b20 6931 312a 6e62 3131 293b 0a20 2020  + i11*nb11);.   
-0005bfe0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0005bff0: 6c5f 6670 3136 5f74 202a 2064 7374 5f64  l_fp16_t * dst_d
-0005c000: 6174 6120 3d20 7764 6174 613b 0a20 2020  ata = wdata;.   
-0005c010: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0005c020: 2028 696e 7436 345f 7420 6931 3020 3d20   (int64_t i10 = 
-0005c030: 303b 2069 3130 203c 206e 6531 303b 2069  0; i10 < ne10; i
-0005c040: 3130 2b2b 2920 7b0a 2020 2020 2020 2020  10++) {.        
-0005c050: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005c060: 6461 7461 5b28 6931 3020 2b20 6e68 292a  data[(i10 + nh)*
-0005c070: 6577 3020 2b20 6931 315d 203d 2047 474d  ew0 + i11] = GGM
-0005c080: 4c5f 4650 3332 5f54 4f5f 4650 3136 2873  L_FP32_TO_FP16(s
-0005c090: 7263 5b69 3130 5d29 3b0a 2020 2020 2020  rc[i10]);.      
-0005c0a0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0005c0b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0005c0c0: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
-0005c0d0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-0005c0e0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-0005c0f0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-0005c100: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-0005c110: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-0005c120: 0a20 2020 202f 2f20 746f 7461 6c20 726f  .    // total ro
-0005c130: 7773 2069 6e20 6473 740a 2020 2020 636f  ws in dst.    co
-0005c140: 6e73 7420 696e 7420 6e72 203d 206e 6530  nst int nr = ne0
-0005c150: 323b 0a0a 2020 2020 2f2f 2072 6f77 7320  2;..    // rows 
-0005c160: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
-0005c170: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
-0005c180: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
-0005c190: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
-0005c1a0: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
-0005c1b0: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-0005c1c0: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
-0005c1d0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-0005c1e0: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
-0005c1f0: 2c20 6e72 293b 0a0a 2020 2020 666f 7220  , nr);..    for 
-0005c200: 2869 6e74 2069 3120 3d20 6972 303b 2069  (int i1 = ir0; i
-0005c210: 3120 3c20 6972 313b 2069 312b 2b29 207b  1 < ir1; i1++) {
-0005c220: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-0005c230: 2064 7374 5f64 6174 6120 3d20 2866 6c6f   dst_data = (flo
-0005c240: 6174 202a 2928 2863 6861 7220 2a29 2064  at *)((char *) d
-0005c250: 7374 2d3e 6461 7461 202b 2069 312a 6e62  st->data + i1*nb
-0005c260: 3129 3b0a 2020 2020 2020 2020 666f 7220  1);.        for 
-0005c270: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
-0005c280: 2069 3020 3c20 6e65 3130 3b20 2b2b 6930   i0 < ne10; ++i0
-0005c290: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005c2a0: 6473 745f 6461 7461 5b69 305d 203d 2030  dst_data[i0] = 0
-0005c2b0: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
-0005c2c0: 7220 2869 6e74 206b 203d 202d 6e68 3b20  r (int k = -nh; 
-0005c2d0: 6b20 3c3d 206e 683b 206b 2b2b 2920 7b0a  k <= nh; k++) {.
-0005c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c2f0: 666c 6f61 7420 7620 3d20 302e 3066 3b0a  float v = 0.0f;.
-0005c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c310: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3136  ggml_vec_dot_f16
-0005c320: 2865 7730 2c20 2676 2c0a 2020 2020 2020  (ew0, &v,.      
+0005b1c0: 2020 2020 2020 6478 5b30 5d20 2020 2020        dx[0]     
+0005b1d0: 2020 203d 2047 474d 4c5f 4650 3332 5f54     = GGML_FP32_T
+0005b1e0: 4f5f 4650 3136 2820 6479 302a 636f 735f  O_FP16( dy0*cos_
+0005b1f0: 7468 6574 6120 2b20 6479 312a 7369 6e5f  theta + dy1*sin_
+0005b200: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
+0005b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005b220: 2020 2020 6478 5b6e 5f64 696d 732f 325d      dx[n_dims/2]
+0005b230: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
+0005b240: 4650 3136 282d 6479 302a 7369 6e5f 7468  FP16(-dy0*sin_th
+0005b250: 6574 6120 2b20 6479 312a 636f 735f 7468  eta + dy1*cos_th
+0005b260: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
+0005b270: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0005b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005b290: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0005b2a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0005b2b0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+0005b2c0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+0005b2d0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+0005b2e0: 655f 666f 7277 6172 645f 726f 7065 5f62  e_forward_rope_b
+0005b2f0: 6163 6b28 0a20 2020 2020 2020 2063 6f6e  ack(.        con
+0005b300: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0005b310: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0005b320: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0005b330: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005b340: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0005b350: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0005b360: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005b370: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+0005b380: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0005b390: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0005b3a0: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+0005b3b0: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+0005b3c0: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+0005b3d0: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
+0005b3e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005b3f0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0005b400: 6f72 7761 7264 5f72 6f70 655f 6261 636b  orward_rope_back
+0005b410: 5f66 3136 2870 6172 616d 732c 2073 7263  _f16(params, src
+0005b420: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
+0005b430: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0005b440: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0005b450: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+0005b460: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0005b470: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0005b480: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0005b490: 7264 5f72 6f70 655f 6261 636b 5f66 3332  rd_rope_back_f32
+0005b4a0: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+0005b4b0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+0005b4c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0005b4d0: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+0005b4e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0005b4f0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0005b500: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0005b510: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0005b520: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+0005b530: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+0005b540: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
+0005b550: 5f73 315f 7068 0a0a 7374 6174 6963 2076  _s1_ph..static v
+0005b560: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+0005b570: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
+0005b580: 5f73 315f 7068 5f66 3136 5f66 3332 280a  _s1_ph_f16_f32(.
+0005b590: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005b5a0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+0005b5b0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+0005b5c0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+0005b5d0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0005b5e0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+0005b5f0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0005b600: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+0005b610: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
+0005b620: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0005b630: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+0005b640: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+0005b650: 7263 302d 3e74 7970 6520 3d3d 2047 474d  rc0->type == GGM
+0005b660: 4c5f 5459 5045 5f46 3136 293b 0a20 2020  L_TYPE_F16);.   
+0005b670: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+0005b680: 312d 3e74 7970 6520 3d3d 2047 474d 4c5f  1->type == GGML_
+0005b690: 5459 5045 5f46 3332 293b 0a20 2020 2047  TYPE_F32);.    G
+0005b6a0: 474d 4c5f 4153 5345 5254 2820 6473 742d  GML_ASSERT( dst-
+0005b6b0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+0005b6c0: 5045 5f46 3332 293b 0a0a 2020 2020 696e  PE_F32);..    in
+0005b6d0: 7436 345f 7420 7430 203d 2067 676d 6c5f  t64_t t0 = ggml_
+0005b6e0: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
+0005b6f0: 2020 2020 554e 5553 4544 2874 3029 3b0a      UNUSED(t0);.
+0005b700: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0005b710: 5f74 206e 6530 3020 3d20 7372 6330 2d3e  _t ne00 = src0->
+0005b720: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0005b730: 2069 6e74 3634 5f74 206e 6530 3120 3d20   int64_t ne01 = 
+0005b740: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
+0005b750: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0005b760: 6530 3220 3d20 7372 6330 2d3e 6e65 5b32  e02 = src0->ne[2
+0005b770: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0005b780: 6e74 3634 5f74 206e 6530 3320 3d20 7372  nt64_t ne03 = sr
+0005b790: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
+0005b7a0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0005b7b0: 3130 203d 2073 7263 312d 3e6e 655b 305d  10 = src1->ne[0]
+0005b7c0: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+0005b7d0: 345f 7420 6e65 3131 203d 2073 7263 312d  4_t ne11 = src1-
+0005b7e0: 3e6e 655b 315d 3b0a 2020 2020 2f2f 636f  >ne[1];.    //co
+0005b7f0: 6e73 7420 696e 7436 345f 7420 6e65 3132  nst int64_t ne12
+0005b800: 203d 2073 7263 312d 3e6e 655b 325d 3b0a   = src1->ne[2];.
+0005b810: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
+0005b820: 345f 7420 6e65 3133 203d 2073 7263 312d  4_t ne13 = src1-
+0005b830: 3e6e 655b 335d 3b0a 0a20 2020 202f 2f63  >ne[3];..    //c
+0005b840: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+0005b850: 2020 3d20 6473 742d 3e6e 655b 305d 3b0a    = dst->ne[0];.
+0005b860: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
+0005b870: 345f 7420 6e65 3120 203d 2064 7374 2d3e  4_t ne1  = dst->
+0005b880: 6e65 5b31 5d3b 0a20 2020 202f 2f63 6f6e  ne[1];.    //con
+0005b890: 7374 2069 6e74 3634 5f74 206e 6532 2020  st int64_t ne2  
+0005b8a0: 3d20 6473 742d 3e6e 655b 325d 3b0a 2020  = dst->ne[2];.  
+0005b8b0: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+0005b8c0: 7420 6e65 3320 203d 2064 7374 2d3e 6e65  t ne3  = dst->ne
+0005b8d0: 5b33 5d3b 0a20 2020 202f 2f63 6f6e 7374  [3];.    //const
+0005b8e0: 2069 6e74 3634 5f74 206e 6520 2020 3d20   int64_t ne   = 
+0005b8f0: 6e65 302a 6e65 312a 6e65 322a 6e65 333b  ne0*ne1*ne2*ne3;
+0005b900: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0005b910: 6e62 3030 203d 2073 7263 302d 3e6e 625b  nb00 = src0->nb[
+0005b920: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0005b930: 7420 6e62 3031 203d 2073 7263 302d 3e6e  t nb01 = src0->n
+0005b940: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+0005b950: 696e 7420 6e62 3032 203d 2073 7263 302d  int nb02 = src0-
+0005b960: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
+0005b970: 6e73 7420 696e 7420 6e62 3033 203d 2073  nst int nb03 = s
+0005b980: 7263 302d 3e6e 625b 335d 3b0a 0a20 2020  rc0->nb[3];..   
+0005b990: 2063 6f6e 7374 2069 6e74 206e 6231 3020   const int nb10 
+0005b9a0: 3d20 7372 6331 2d3e 6e62 5b30 5d3b 0a20  = src1->nb[0];. 
+0005b9b0: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+0005b9c0: 3120 3d20 7372 6331 2d3e 6e62 5b31 5d3b  1 = src1->nb[1];
+0005b9d0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0005b9e0: 206e 6231 3220 3d20 7372 6331 2d3e 6e62   nb12 = src1->nb
+0005b9f0: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+0005ba00: 2069 6e74 206e 6231 3320 3d20 7372 6331   int nb13 = src1
+0005ba10: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 2f2f  ->nb[3];..    //
+0005ba20: 636f 6e73 7420 696e 7420 6e62 3020 203d  const int nb0  =
+0005ba30: 2064 7374 2d3e 6e62 5b30 5d3b 0a20 2020   dst->nb[0];.   
+0005ba40: 2063 6f6e 7374 2069 6e74 206e 6231 2020   const int nb1  
+0005ba50: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
+0005ba60: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
+0005ba70: 3220 203d 2064 7374 2d3e 6e62 5b32 5d3b  2  = dst->nb[2];
+0005ba80: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0005ba90: 206e 6233 2020 3d20 6473 742d 3e6e 625b   nb3  = dst->nb[
+0005baa0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
+0005bab0: 6e74 2069 7468 203d 2070 6172 616d 732d  nt ith = params-
+0005bac0: 3e69 7468 3b0a 2020 2020 636f 6e73 7420  >ith;.    const 
+0005bad0: 696e 7420 6e74 6820 3d20 7061 7261 6d73  int nth = params
+0005bae0: 2d3e 6e74 683b 0a0a 2020 2020 636f 6e73  ->nth;..    cons
+0005baf0: 7420 696e 7420 6e6b 203d 206e 6530 303b  t int nk = ne00;
+0005bb00: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005bb10: 6820 3d20 6e6b 2f32 3b0a 0a20 2020 2063  h = nk/2;..    c
+0005bb20: 6f6e 7374 2069 6e74 2065 7730 203d 2067  onst int ew0 = g
+0005bb30: 676d 6c5f 7570 3332 286e 6530 3129 3b0a  gml_up32(ne01);.
+0005bb40: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0005bb50: 286e 6530 3020 2520 3220 3d3d 2031 293b  (ne00 % 2 == 1);
+0005bb60: 202f 2f20 544f 444f 3a20 7375 7070 6f72   // TODO: suppor
+0005bb70: 7420 6576 656e 206b 6572 6e65 6c20 7369  t even kernel si
+0005bb80: 7a65 730a 2020 2020 4747 4d4c 5f41 5353  zes.    GGML_ASS
+0005bb90: 4552 5428 6e62 3030 203d 3d20 7369 7a65  ERT(nb00 == size
+0005bba0: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+0005bbb0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0005bbc0: 5428 6e62 3130 203d 3d20 7369 7a65 6f66  T(nb10 == sizeof
+0005bbd0: 2866 6c6f 6174 2929 3b0a 0a20 2020 2069  (float));..    i
+0005bbe0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+0005bbf0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+0005bc00: 5429 207b 0a20 2020 2020 2020 202f 2f20  T) {.        // 
+0005bc10: 544f 444f 3a20 6669 7820 7468 6973 206d  TODO: fix this m
+0005bc20: 656d 7365 7420 2877 7369 7a65 2069 7320  emset (wsize is 
+0005bc30: 6f76 6572 6573 7469 6d61 7465 6429 0a20  overestimated). 
+0005bc40: 2020 2020 2020 206d 656d 7365 7428 7061         memset(pa
+0005bc50: 7261 6d73 2d3e 7764 6174 612c 2030 2c20  rams->wdata, 0, 
+0005bc60: 7061 7261 6d73 2d3e 7773 697a 6529 3b0a  params->wsize);.
+0005bc70: 0a20 2020 2020 2020 202f 2f20 7072 6570  .        // prep
+0005bc80: 6172 6520 6b65 726e 656c 2064 6174 6120  are kernel data 
+0005bc90: 2873 7263 3029 0a20 2020 2020 2020 207b  (src0).        {
+0005bca0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0005bcb0: 6c5f 6670 3136 5f74 202a 2063 6f6e 7374  l_fp16_t * const
+0005bcc0: 2077 6461 7461 203d 2028 6767 6d6c 5f66   wdata = (ggml_f
+0005bcd0: 7031 365f 7420 2a29 2070 6172 616d 732d  p16_t *) params-
+0005bce0: 3e77 6461 7461 202b 2030 3b0a 0a20 2020  >wdata + 0;..   
+0005bcf0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0005bd00: 7436 345f 7420 6930 3220 3d20 303b 2069  t64_t i02 = 0; i
+0005bd10: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+0005bd20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0005bd30: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0005bd40: 2069 3031 203d 2030 3b20 6930 3120 3c20   i01 = 0; i01 < 
+0005bd50: 6e65 3031 3b20 6930 312b 2b29 207b 0a20  ne01; i01++) {. 
+0005bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005bd70: 2020 2063 6f6e 7374 2067 676d 6c5f 6670     const ggml_fp
+0005bd80: 3136 5f74 202a 2063 6f6e 7374 2073 7263  16_t * const src
+0005bd90: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
+0005bda0: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
+0005bdb0: 2d3e 6461 7461 202b 2069 3032 2a6e 6230  ->data + i02*nb0
+0005bdc0: 3220 2b20 6930 312a 6e62 3031 293b 0a20  2 + i01*nb01);. 
+0005bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005bde0: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
+0005bdf0: 2064 7374 5f64 6174 6120 3d20 7764 6174   dst_data = wdat
+0005be00: 6120 2b20 6930 322a 6577 302a 6e65 3030  a + i02*ew0*ne00
+0005be10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005be20: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0005be30: 5f74 2069 3030 203d 2030 3b20 6930 3020  _t i00 = 0; i00 
+0005be40: 3c20 6e65 3030 3b20 6930 302b 2b29 207b  < ne00; i00++) {
+0005be50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005be60: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+0005be70: 615b 6930 302a 6577 3020 2b20 6930 315d  a[i00*ew0 + i01]
+0005be80: 203d 2073 7263 5b69 3030 5d3b 0a20 2020   = src[i00];.   
+0005be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005bea0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0005beb0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0005bec0: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+0005bed0: 2020 2020 2020 2f2f 2070 7265 7061 7265        // prepare
+0005bee0: 2073 6f75 7263 6520 6461 7461 2028 7372   source data (sr
+0005bef0: 6331 290a 2020 2020 2020 2020 7b0a 2020  c1).        {.  
+0005bf00: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+0005bf10: 7031 365f 7420 2a20 636f 6e73 7420 7764  p16_t * const wd
+0005bf20: 6174 6120 3d20 2867 676d 6c5f 6670 3136  ata = (ggml_fp16
+0005bf30: 5f74 202a 2920 7061 7261 6d73 2d3e 7764  _t *) params->wd
+0005bf40: 6174 6120 2b20 6e65 3032 2a65 7730 2a6e  ata + ne02*ew0*n
+0005bf50: 6530 303b 0a0a 2020 2020 2020 2020 2020  e00;..          
+0005bf60: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0005bf70: 3131 203d 2030 3b20 6931 3120 3c20 6e65  11 = 0; i11 < ne
+0005bf80: 3131 3b20 6931 312b 2b29 207b 0a20 2020  11; i11++) {.   
+0005bf90: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005bfa0: 7374 2066 6c6f 6174 202a 2063 6f6e 7374  st float * const
+0005bfb0: 2073 7263 203d 2028 666c 6f61 7420 2a29   src = (float *)
+0005bfc0: 2828 6368 6172 202a 2920 7372 6331 2d3e  ((char *) src1->
+0005bfd0: 6461 7461 202b 2069 3131 2a6e 6231 3129  data + i11*nb11)
+0005bfe0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005bff0: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+0005c000: 6473 745f 6461 7461 203d 2077 6461 7461  dst_data = wdata
+0005c010: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005c020: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0005c030: 3130 203d 2030 3b20 6931 3020 3c20 6e65  10 = 0; i10 < ne
+0005c040: 3130 3b20 6931 302b 2b29 207b 0a20 2020  10; i10++) {.   
+0005c050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c060: 2064 7374 5f64 6174 615b 2869 3130 202b   dst_data[(i10 +
+0005c070: 206e 6829 2a65 7730 202b 2069 3131 5d20   nh)*ew0 + i11] 
+0005c080: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+0005c090: 5031 3628 7372 635b 6931 305d 293b 0a20  P16(src[i10]);. 
+0005c0a0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005c0b0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0005c0c0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0005c0d0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+0005c0e0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0005c0f0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0005c100: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+0005c110: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0005c120: 2020 207d 0a0a 2020 2020 2f2f 2074 6f74     }..    // tot
+0005c130: 616c 2072 6f77 7320 696e 2064 7374 0a20  al rows in dst. 
+0005c140: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+0005c150: 3d20 6e65 3032 3b0a 0a20 2020 202f 2f20  = ne02;..    // 
+0005c160: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+0005c170: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+0005c180: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+0005c190: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
+0005c1a0: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
+0005c1b0: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
+0005c1c0: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
+0005c1d0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0005c1e0: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
+0005c1f0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
+0005c200: 2066 6f72 2028 696e 7420 6931 203d 2069   for (int i1 = i
+0005c210: 7230 3b20 6931 203c 2069 7231 3b20 6931  r0; i1 < ir1; i1
+0005c220: 2b2b 2920 7b0a 2020 2020 2020 2020 666c  ++) {.        fl
+0005c230: 6f61 7420 2a20 6473 745f 6461 7461 203d  oat * dst_data =
+0005c240: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+0005c250: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0005c260: 6931 2a6e 6231 293b 0a20 2020 2020 2020  i1*nb1);.       
+0005c270: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+0005c280: 203d 2030 3b20 6930 203c 206e 6531 303b   = 0; i0 < ne10;
+0005c290: 202b 2b69 3029 207b 0a20 2020 2020 2020   ++i0) {.       
+0005c2a0: 2020 2020 2064 7374 5f64 6174 615b 6930       dst_data[i0
+0005c2b0: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
+0005c2c0: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
+0005c2d0: 2d6e 683b 206b 203c 3d20 6e68 3b20 6b2b  -nh; k <= nh; k+
+0005c2e0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0005c2f0: 2020 2020 2066 6c6f 6174 2076 203d 2030       float v = 0
+0005c300: 2e30 663b 0a20 2020 2020 2020 2020 2020  .0f;.           
+0005c310: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
+0005c320: 745f 6631 3628 6577 302c 2026 762c 0a20  t_f16(ew0, &v,. 
 0005c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c340: 2020 2867 676d 6c5f 6670 3136 5f74 202a    (ggml_fp16_t *
-0005c350: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-0005c360: 2b20 2020 6931 2a65 7730 2a6e 6530 3020  +   i1*ew0*ne00 
-0005c370: 2b20 2020 2020 2028 6e68 202b 206b 292a  +      (nh + k)*
-0005c380: 6577 302c 0a20 2020 2020 2020 2020 2020  ew0,.           
-0005c390: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
-0005c3a0: 6d6c 5f66 7031 365f 7420 2a29 2070 6172  ml_fp16_t *) par
-0005c3b0: 616d 732d 3e77 6461 7461 202b 206e 6530  ams->wdata + ne0
-0005c3c0: 322a 6577 302a 6e65 3030 202b 2028 6930  2*ew0*ne00 + (i0
-0005c3d0: 202b 206e 6820 2b20 6b29 2a65 7730 293b   + nh + k)*ew0);
-0005c3e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005c3f0: 2020 6473 745f 6461 7461 5b69 305d 202b    dst_data[i0] +
-0005c400: 3d20 763b 0a20 2020 2020 2020 2020 2020  = v;.           
-0005c410: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-0005c420: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-0005c430: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-0005c440: 6f72 7761 7264 5f63 6f6e 765f 3164 5f73  orward_conv_1d_s
-0005c450: 315f 7068 5f66 3332 280a 2020 2020 2020  1_ph_f32(.      
-0005c460: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005c470: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0005c480: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0005c490: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005c4a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005c4b0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0005c4c0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005c4d0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0005c4e0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0005c4f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005c500: 2a20 6473 7429 207b 0a20 2020 2047 474d  * dst) {.    GGM
-0005c510: 4c5f 4153 5345 5254 2873 7263 302d 3e74  L_ASSERT(src0->t
-0005c520: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-0005c530: 5f46 3332 293b 0a20 2020 2047 474d 4c5f  _F32);.    GGML_
-0005c540: 4153 5345 5254 2873 7263 312d 3e74 7970  ASSERT(src1->typ
-0005c550: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-0005c560: 3332 293b 0a20 2020 2047 474d 4c5f 4153  32);.    GGML_AS
-0005c570: 5345 5254 2820 6473 742d 3e74 7970 6520  SERT( dst->type 
-0005c580: 3d3d 2047 474d 4c5f 5459 5045 5f46 3332  == GGML_TYPE_F32
-0005c590: 293b 0a0a 2020 2020 696e 7436 345f 7420  );..    int64_t 
-0005c5a0: 7430 203d 2067 676d 6c5f 7065 7266 5f74  t0 = ggml_perf_t
-0005c5b0: 696d 655f 7573 2829 3b0a 2020 2020 554e  ime_us();.    UN
-0005c5c0: 5553 4544 2874 3029 3b0a 0a20 2020 2063  USED(t0);..    c
-0005c5d0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-0005c5e0: 3020 3d20 7372 6330 2d3e 6e65 5b30 5d3b  0 = src0->ne[0];
-0005c5f0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0005c600: 5f74 206e 6530 3120 3d20 7372 6330 2d3e  _t ne01 = src0->
-0005c610: 6e65 5b31 5d3b 0a20 2020 2063 6f6e 7374  ne[1];.    const
-0005c620: 2069 6e74 3634 5f74 206e 6530 3220 3d20   int64_t ne02 = 
-0005c630: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
-0005c640: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-0005c650: 206e 6530 3320 3d20 7372 6330 2d3e 6e65   ne03 = src0->ne
-0005c660: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0005c670: 696e 7436 345f 7420 6e65 3130 203d 2073  int64_t ne10 = s
-0005c680: 7263 312d 3e6e 655b 305d 3b0a 2020 2020  rc1->ne[0];.    
-0005c690: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005c6a0: 3131 203d 2073 7263 312d 3e6e 655b 315d  11 = src1->ne[1]
-0005c6b0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0005c6c0: 7436 345f 7420 6e65 3132 203d 2073 7263  t64_t ne12 = src
-0005c6d0: 312d 3e6e 655b 325d 3b0a 2020 2020 2f2f  1->ne[2];.    //
-0005c6e0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005c6f0: 3133 203d 2073 7263 312d 3e6e 655b 335d  13 = src1->ne[3]
-0005c700: 3b0a 0a20 2020 202f 2f63 6f6e 7374 2069  ;..    //const i
-0005c710: 6e74 3634 5f74 206e 6530 2020 3d20 6473  nt64_t ne0  = ds
-0005c720: 742d 3e6e 655b 305d 3b0a 2020 2020 2f2f  t->ne[0];.    //
-0005c730: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005c740: 3120 203d 2064 7374 2d3e 6e65 5b31 5d3b  1  = dst->ne[1];
-0005c750: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0005c760: 3634 5f74 206e 6532 2020 3d20 6473 742d  64_t ne2  = dst-
-0005c770: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
-0005c780: 6e73 7420 696e 7436 345f 7420 6e65 3320  nst int64_t ne3 
-0005c790: 203d 2064 7374 2d3e 6e65 5b33 5d3b 0a20   = dst->ne[3];. 
-0005c7a0: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
-0005c7b0: 5f74 206e 6520 2020 3d20 6e65 302a 6e65  _t ne   = ne0*ne
-0005c7c0: 312a 6e65 322a 6e65 333b 0a0a 2020 2020  1*ne2*ne3;..    
-0005c7d0: 636f 6e73 7420 696e 7420 6e62 3030 203d  const int nb00 =
-0005c7e0: 2073 7263 302d 3e6e 625b 305d 3b0a 2020   src0->nb[0];.  
-0005c7f0: 2020 636f 6e73 7420 696e 7420 6e62 3031    const int nb01
-0005c800: 203d 2073 7263 302d 3e6e 625b 315d 3b0a   = src0->nb[1];.
-0005c810: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0005c820: 3032 203d 2073 7263 302d 3e6e 625b 325d  02 = src0->nb[2]
-0005c830: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0005c840: 7420 6e62 3033 203d 2073 7263 302d 3e6e  t nb03 = src0->n
-0005c850: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
-0005c860: 2069 6e74 206e 6231 3020 3d20 7372 6331   int nb10 = src1
-0005c870: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
-0005c880: 7374 2069 6e74 206e 6231 3120 3d20 7372  st int nb11 = sr
-0005c890: 6331 2d3e 6e62 5b31 5d3b 0a20 2020 202f  c1->nb[1];.    /
-0005c8a0: 2f63 6f6e 7374 2069 6e74 206e 6231 3220  /const int nb12 
-0005c8b0: 3d20 7372 6331 2d3e 6e62 5b32 5d3b 0a20  = src1->nb[2];. 
-0005c8c0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0005c8d0: 6231 3320 3d20 7372 6331 2d3e 6e62 5b33  b13 = src1->nb[3
-0005c8e0: 5d3b 0a0a 2020 2020 2f2f 636f 6e73 7420  ];..    //const 
-0005c8f0: 696e 7420 6e62 3020 203d 2064 7374 2d3e  int nb0  = dst->
-0005c900: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-0005c910: 2069 6e74 206e 6231 2020 3d20 6473 742d   int nb1  = dst-
-0005c920: 3e6e 625b 315d 3b0a 2020 2020 2f2f 636f  >nb[1];.    //co
-0005c930: 6e73 7420 696e 7420 6e62 3220 203d 2064  nst int nb2  = d
-0005c940: 7374 2d3e 6e62 5b32 5d3b 0a20 2020 202f  st->nb[2];.    /
-0005c950: 2f63 6f6e 7374 2069 6e74 206e 6233 2020  /const int nb3  
-0005c960: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
-0005c970: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-0005c980: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-0005c990: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-0005c9a0: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-0005c9b0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005c9c0: 6e6b 203d 206e 6530 303b 0a20 2020 2063  nk = ne00;.    c
-0005c9d0: 6f6e 7374 2069 6e74 206e 6820 3d20 6e6b  onst int nh = nk
-0005c9e0: 2f32 3b0a 0a20 2020 2063 6f6e 7374 2069  /2;..    const i
-0005c9f0: 6e74 2065 7730 203d 2067 676d 6c5f 7570  nt ew0 = ggml_up
-0005ca00: 3332 286e 6530 3129 3b0a 0a20 2020 2047  32(ne01);..    G
-0005ca10: 474d 4c5f 4153 5345 5254 286e 6530 3020  GML_ASSERT(ne00 
-0005ca20: 2520 3220 3d3d 2031 293b 202f 2f20 544f  % 2 == 1); // TO
-0005ca30: 444f 3a20 7375 7070 6f72 7420 6576 656e  DO: support even
-0005ca40: 206b 6572 6e65 6c20 7369 7a65 730a 2020   kernel sizes.  
-0005ca50: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-0005ca60: 3030 203d 3d20 7369 7a65 6f66 2866 6c6f  00 == sizeof(flo
-0005ca70: 6174 2929 3b0a 2020 2020 4747 4d4c 5f41  at));.    GGML_A
-0005ca80: 5353 4552 5428 6e62 3130 203d 3d20 7369  SSERT(nb10 == si
-0005ca90: 7a65 6f66 2866 6c6f 6174 2929 3b0a 0a20  zeof(float));.. 
-0005caa0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0005cab0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0005cac0: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
-0005cad0: 202f 2f20 544f 444f 3a20 6669 7820 7468   // TODO: fix th
-0005cae0: 6973 206d 656d 7365 7420 2877 7369 7a65  is memset (wsize
-0005caf0: 2069 7320 6f76 6572 6573 7469 6d61 7465   is overestimate
-0005cb00: 6429 0a20 2020 2020 2020 206d 656d 7365  d).        memse
-0005cb10: 7428 7061 7261 6d73 2d3e 7764 6174 612c  t(params->wdata,
-0005cb20: 2030 2c20 7061 7261 6d73 2d3e 7773 697a   0, params->wsiz
-0005cb30: 6529 3b0a 0a20 2020 2020 2020 202f 2f20  e);..        // 
-0005cb40: 7072 6570 6172 6520 6b65 726e 656c 2064  prepare kernel d
-0005cb50: 6174 6120 2873 7263 3029 0a20 2020 2020  ata (src0).     
-0005cb60: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0005cb70: 2066 6c6f 6174 202a 2063 6f6e 7374 2077   float * const w
-0005cb80: 6461 7461 203d 2028 666c 6f61 7420 2a29  data = (float *)
-0005cb90: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
-0005cba0: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
-0005cbb0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
-0005cbc0: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
-0005cbd0: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
-0005cbe0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0005cbf0: 2869 6e74 3634 5f74 2069 3031 203d 2030  (int64_t i01 = 0
-0005cc00: 3b20 6930 3120 3c20 6e65 3031 3b20 6930  ; i01 < ne01; i0
-0005cc10: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
-0005cc20: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005cc30: 2066 6c6f 6174 202a 2063 6f6e 7374 2073   float * const s
-0005cc40: 7263 203d 2028 666c 6f61 7420 2a29 2828  rc = (float *)((
-0005cc50: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-0005cc60: 7461 202b 2069 3032 2a6e 6230 3220 2b20  ta + i02*nb02 + 
-0005cc70: 6930 312a 6e62 3031 293b 0a20 2020 2020  i01*nb01);.     
-0005cc80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005cc90: 6c6f 6174 202a 2064 7374 5f64 6174 6120  loat * dst_data 
-0005cca0: 3d20 7764 6174 6120 2b20 6930 322a 6577  = wdata + i02*ew
-0005ccb0: 302a 6e65 3030 3b0a 2020 2020 2020 2020  0*ne00;.        
-0005ccc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0005ccd0: 2869 6e74 3634 5f74 2069 3030 203d 2030  (int64_t i00 = 0
-0005cce0: 3b20 6930 3020 3c20 6e65 3030 3b20 6930  ; i00 < ne00; i0
-0005ccf0: 302b 2b29 207b 0a20 2020 2020 2020 2020  0++) {.         
-0005cd00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0005cd10: 7374 5f64 6174 615b 6930 302a 6577 3020  st_data[i00*ew0 
-0005cd20: 2b20 6930 315d 203d 2073 7263 5b69 3030  + i01] = src[i00
-0005cd30: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0005cd40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0005cd50: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0005cd60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0005cd70: 207d 0a0a 2020 2020 2020 2020 2f2f 2070   }..        // p
-0005cd80: 7265 7061 7265 2073 6f75 7263 6520 6461  repare source da
-0005cd90: 7461 2028 7372 6331 290a 2020 2020 2020  ta (src1).      
-0005cda0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0005cdb0: 666c 6f61 7420 2a20 636f 6e73 7420 7764  float * const wd
-0005cdc0: 6174 6120 3d20 2866 6c6f 6174 202a 2920  ata = (float *) 
-0005cdd0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
-0005cde0: 6e65 3032 2a65 7730 2a6e 6530 303b 0a0a  ne02*ew0*ne00;..
-0005cdf0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0005ce00: 2869 6e74 3634 5f74 2069 3131 203d 2030  (int64_t i11 = 0
-0005ce10: 3b20 6931 3120 3c20 6e65 3131 3b20 6931  ; i11 < ne11; i1
-0005ce20: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
-0005ce30: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0005ce40: 6174 202a 2063 6f6e 7374 2073 7263 203d  at * const src =
-0005ce50: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
-0005ce60: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-0005ce70: 2069 3131 2a6e 6231 3129 3b0a 2020 2020   i11*nb11);.    
-0005ce80: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0005ce90: 7420 2a20 6473 745f 6461 7461 203d 2077  t * dst_data = w
-0005cea0: 6461 7461 3b0a 2020 2020 2020 2020 2020  data;.          
-0005ceb0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0005cec0: 5f74 2069 3130 203d 2030 3b20 6931 3020  _t i10 = 0; i10 
-0005ced0: 3c20 6e65 3130 3b20 6931 302b 2b29 207b  < ne10; i10++) {
-0005cee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005cef0: 2020 2020 2064 7374 5f64 6174 615b 2869       dst_data[(i
-0005cf00: 3130 202b 206e 6829 2a65 7730 202b 2069  10 + nh)*ew0 + i
-0005cf10: 3131 5d20 3d20 7372 635b 6931 305d 3b0a  11] = src[i10];.
-0005cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005cf30: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0005cf40: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0005cf50: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-0005cf60: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0005cf70: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005cf80: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-0005cf90: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0005cfa0: 2020 2020 7d0a 0a20 2020 202f 2f20 746f      }..    // to
-0005cfb0: 7461 6c20 726f 7773 2069 6e20 6473 740a  tal rows in dst.
-0005cfc0: 2020 2020 636f 6e73 7420 696e 7420 6e72      const int nr
-0005cfd0: 203d 206e 6530 323b 0a0a 2020 2020 2f2f   = ne02;..    //
-0005cfe0: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
-0005cff0: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
-0005d000: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
-0005d010: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
-0005d020: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
-0005d030: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
-0005d040: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
-0005d050: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
-0005d060: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
-0005d070: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
-0005d080: 2020 666f 7220 2869 6e74 2069 3120 3d20    for (int i1 = 
-0005d090: 6972 303b 2069 3120 3c20 6972 313b 2069  ir0; i1 < ir1; i
-0005d0a0: 312b 2b29 207b 0a20 2020 2020 2020 2066  1++) {.        f
-0005d0b0: 6c6f 6174 202a 2064 7374 5f64 6174 6120  loat * dst_data 
-0005d0c0: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
-0005d0d0: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-0005d0e0: 2069 312a 6e62 3129 3b0a 2020 2020 2020   i1*nb1);.      
-0005d0f0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-0005d100: 3020 3d20 303b 2069 3020 3c20 6e65 3130  0 = 0; i0 < ne10
-0005d110: 3b20 2b2b 6930 2920 7b0a 2020 2020 2020  ; ++i0) {.      
-0005d120: 2020 2020 2020 6473 745f 6461 7461 5b69        dst_data[i
-0005d130: 305d 203d 2030 3b0a 2020 2020 2020 2020  0] = 0;.        
-0005d140: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
-0005d150: 202d 6e68 3b20 6b20 3c3d 206e 683b 206b   -nh; k <= nh; k
-0005d160: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0005d170: 2020 2020 2020 666c 6f61 7420 7620 3d20        float v = 
-0005d180: 302e 3066 3b0a 2020 2020 2020 2020 2020  0.0f;.          
-0005d190: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-0005d1a0: 6f74 5f66 3332 2865 7730 2c20 2676 2c0a  ot_f32(ew0, &v,.
-0005d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005d1c0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-0005d1d0: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-0005d1e0: 2b20 2020 6931 2a65 7730 2a6e 6530 3020  +   i1*ew0*ne00 
-0005d1f0: 2b20 2020 2020 2028 6e68 202b 206b 292a  +      (nh + k)*
-0005d200: 6577 302c 0a20 2020 2020 2020 2020 2020  ew0,.           
-0005d210: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-0005d220: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
-0005d230: 6461 7461 202b 206e 6530 322a 6577 302a  data + ne02*ew0*
-0005d240: 6e65 3030 202b 2028 6930 202b 206e 6820  ne00 + (i0 + nh 
-0005d250: 2b20 6b29 2a65 7730 293b 0a0a 2020 2020  + k)*ew0);..    
-0005d260: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005d270: 6461 7461 5b69 305d 202b 3d20 763b 0a20  data[i0] += v;. 
-0005d280: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0005d290: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
-0005d2a0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0005d2b0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0005d2c0: 5f63 6f6e 765f 3164 5f73 315f 7068 280a  _conv_1d_s1_ph(.
-0005d2d0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005d2e0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0005d2f0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-0005d300: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-0005d310: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005d320: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-0005d330: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005d340: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-0005d350: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
-0005d360: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005d370: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-0005d380: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-0005d390: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-0005d3a0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-0005d3b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0005d3c0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0005d3d0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0005d3e0: 645f 636f 6e76 5f31 645f 7331 5f70 685f  d_conv_1d_s1_ph_
-0005d3f0: 6631 365f 6633 3228 7061 7261 6d73 2c20  f16_f32(params, 
-0005d400: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-0005d410: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-0005d420: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0005d430: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-0005d440: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-0005d450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005d460: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0005d470: 7277 6172 645f 636f 6e76 5f31 645f 7331  rward_conv_1d_s1
-0005d480: 5f70 685f 6633 3228 7061 7261 6d73 2c20  _ph_f32(params, 
-0005d490: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
-0005d4a0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-0005d4b0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-0005d4c0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-0005d4d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0005d4e0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0005d4f0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-0005d500: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0005d510: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
-0005d520: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005d530: 636f 6e76 5f31 645f 7332 5f70 680a 0a73  conv_1d_s2_ph..s
-0005d540: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0005d550: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005d560: 636f 6e76 5f31 645f 7332 5f70 685f 6631  conv_1d_s2_ph_f1
-0005d570: 365f 6633 3228 0a20 2020 2020 2020 2063  6_f32(.        c
-0005d580: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0005d590: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-0005d5a0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-0005d5b0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005d5c0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0005d5d0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-0005d5e0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005d5f0: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-0005d600: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0005d610: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0005d620: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-0005d630: 5353 4552 5428 7372 6330 2d3e 7479 7065  SSERT(src0->type
-0005d640: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-0005d650: 3629 3b0a 2020 2020 4747 4d4c 5f41 5353  6);.    GGML_ASS
-0005d660: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
-0005d670: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-0005d680: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0005d690: 5428 2064 7374 2d3e 7479 7065 203d 3d20  T( dst->type == 
-0005d6a0: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
-0005d6b0: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
-0005d6c0: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
-0005d6d0: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
-0005d6e0: 4428 7430 293b 0a0a 2020 2020 636f 6e73  D(t0);..    cons
-0005d6f0: 7420 696e 7436 345f 7420 6e65 3030 203d  t int64_t ne00 =
-0005d700: 2073 7263 302d 3e6e 655b 305d 3b0a 2020   src0->ne[0];.  
-0005d710: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0005d720: 6e65 3031 203d 2073 7263 302d 3e6e 655b  ne01 = src0->ne[
-0005d730: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0005d740: 7436 345f 7420 6e65 3032 203d 2073 7263  t64_t ne02 = src
-0005d750: 302d 3e6e 655b 325d 3b0a 2020 2020 2f2f  0->ne[2];.    //
-0005d760: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-0005d770: 3033 203d 2073 7263 302d 3e6e 655b 335d  03 = src0->ne[3]
-0005d780: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0005d790: 3634 5f74 206e 6531 3020 3d20 7372 6331  64_t ne10 = src1
-0005d7a0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
-0005d7b0: 7374 2069 6e74 3634 5f74 206e 6531 3120  st int64_t ne11 
-0005d7c0: 3d20 7372 6331 2d3e 6e65 5b31 5d3b 0a20  = src1->ne[1];. 
-0005d7d0: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
-0005d7e0: 5f74 206e 6531 3220 3d20 7372 6331 2d3e  _t ne12 = src1->
-0005d7f0: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-0005d800: 7374 2069 6e74 3634 5f74 206e 6531 3320  st int64_t ne13 
-0005d810: 3d20 7372 6331 2d3e 6e65 5b33 5d3b 0a0a  = src1->ne[3];..
-0005d820: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-0005d830: 345f 7420 6e65 3020 203d 2064 7374 2d3e  4_t ne0  = dst->
-0005d840: 6e65 5b30 5d3b 0a20 2020 202f 2f63 6f6e  ne[0];.    //con
-0005d850: 7374 2069 6e74 3634 5f74 206e 6531 2020  st int64_t ne1  
-0005d860: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
-0005d870: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
-0005d880: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
-0005d890: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-0005d8a0: 2069 6e74 3634 5f74 206e 6533 2020 3d20   int64_t ne3  = 
-0005d8b0: 6473 742d 3e6e 655b 335d 3b0a 2020 2020  dst->ne[3];.    
-0005d8c0: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
-0005d8d0: 6e65 2020 203d 206e 6530 2a6e 6531 2a6e  ne   = ne0*ne1*n
-0005d8e0: 6532 2a6e 6533 3b0a 0a20 2020 2063 6f6e  e2*ne3;..    con
-0005d8f0: 7374 2069 6e74 206e 6230 3020 3d20 7372  st int nb00 = sr
-0005d900: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c0->nb[0];.    c
-0005d910: 6f6e 7374 2069 6e74 206e 6230 3120 3d20  onst int nb01 = 
-0005d920: 7372 6330 2d3e 6e62 5b31 5d3b 0a20 2020  src0->nb[1];.   
-0005d930: 2063 6f6e 7374 2069 6e74 206e 6230 3220   const int nb02 
-0005d940: 3d20 7372 6330 2d3e 6e62 5b32 5d3b 0a20  = src0->nb[2];. 
-0005d950: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0005d960: 6230 3320 3d20 7372 6330 2d3e 6e62 5b33  b03 = src0->nb[3
-0005d970: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-0005d980: 7420 6e62 3130 203d 2073 7263 312d 3e6e  t nb10 = src1->n
-0005d990: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
-0005d9a0: 696e 7420 6e62 3131 203d 2073 7263 312d  int nb11 = src1-
-0005d9b0: 3e6e 625b 315d 3b0a 2020 2020 2f2f 636f  >nb[1];.    //co
-0005d9c0: 6e73 7420 696e 7420 6e62 3132 203d 2073  nst int nb12 = s
-0005d9d0: 7263 312d 3e6e 625b 325d 3b0a 2020 2020  rc1->nb[2];.    
-0005d9e0: 2f2f 636f 6e73 7420 696e 7420 6e62 3133  //const int nb13
-0005d9f0: 203d 2073 7263 312d 3e6e 625b 335d 3b0a   = src1->nb[3];.
-0005da00: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-0005da10: 206e 6230 2020 3d20 6473 742d 3e6e 625b   nb0  = dst->nb[
-0005da20: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0005da30: 7420 6e62 3120 203d 2064 7374 2d3e 6e62  t nb1  = dst->nb
-0005da40: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-0005da50: 2069 6e74 206e 6232 2020 3d20 6473 742d   int nb2  = dst-
-0005da60: 3e6e 625b 325d 3b0a 2020 2020 2f2f 636f  >nb[2];.    //co
-0005da70: 6e73 7420 696e 7420 6e62 3320 203d 2064  nst int nb3  = d
-0005da80: 7374 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  st->nb[3];..    
-0005da90: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
-0005daa0: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
-0005dab0: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
-0005dac0: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
-0005dad0: 2020 2063 6f6e 7374 2069 6e74 206e 6b20     const int nk 
-0005dae0: 3d20 6e65 3030 3b0a 2020 2020 636f 6e73  = ne00;.    cons
-0005daf0: 7420 696e 7420 6e68 203d 206e 6b2f 323b  t int nh = nk/2;
-0005db00: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005db10: 6577 3020 3d20 6767 6d6c 5f75 7033 3228  ew0 = ggml_up32(
-0005db20: 6e65 3031 293b 0a0a 2020 2020 4747 4d4c  ne01);..    GGML
-0005db30: 5f41 5353 4552 5428 6e65 3030 2025 2032  _ASSERT(ne00 % 2
-0005db40: 203d 3d20 3129 3b20 2f2f 2054 4f44 4f3a   == 1); // TODO:
-0005db50: 2073 7570 706f 7274 2065 7665 6e20 6b65   support even ke
-0005db60: 726e 656c 2073 697a 6573 0a20 2020 2047  rnel sizes.    G
-0005db70: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
-0005db80: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-0005db90: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
-0005dba0: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
-0005dbb0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0005dbc0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0005dbd0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005dbe0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-0005dbf0: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
-0005dc00: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
-0005dc10: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
-0005dc20: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
-0005dc30: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
-0005dc40: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
-0005dc50: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
-0005dc60: 2f2f 2070 7265 7061 7265 206b 6572 6e65  // prepare kerne
-0005dc70: 6c20 6461 7461 2028 7372 6330 290a 2020  l data (src0).  
-0005dc80: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0005dc90: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-0005dca0: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
-0005dcb0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-0005dcc0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
-0005dcd0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
-0005dce0: 666f 7220 2869 6e74 3634 5f74 2069 3032  for (int64_t i02
-0005dcf0: 203d 2030 3b20 6930 3220 3c20 6e65 3032   = 0; i02 < ne02
-0005dd00: 3b20 6930 322b 2b29 207b 0a20 2020 2020  ; i02++) {.     
-0005dd10: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0005dd20: 696e 7436 345f 7420 6930 3120 3d20 303b  int64_t i01 = 0;
-0005dd30: 2069 3031 203c 206e 6530 313b 2069 3031   i01 < ne01; i01
-0005dd40: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-0005dd50: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005dd60: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
-0005dd70: 6e73 7420 7372 6320 3d20 2867 676d 6c5f  nst src = (ggml_
-0005dd80: 6670 3136 5f74 202a 2928 2863 6861 7220  fp16_t *)((char 
-0005dd90: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-0005dda0: 6930 322a 6e62 3032 202b 2069 3031 2a6e  i02*nb02 + i01*n
-0005ddb0: 6230 3129 3b0a 2020 2020 2020 2020 2020  b01);.          
-0005ddc0: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-0005ddd0: 7031 365f 7420 2a20 6473 745f 6461 7461  p16_t * dst_data
-0005dde0: 203d 2077 6461 7461 202b 2069 3032 2a65   = wdata + i02*e
-0005ddf0: 7730 2a6e 6530 303b 0a20 2020 2020 2020  w0*ne00;.       
-0005de00: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0005de10: 2028 696e 7436 345f 7420 6930 3020 3d20   (int64_t i00 = 
-0005de20: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
-0005de30: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
+0005c340: 2020 2020 2020 2028 6767 6d6c 5f66 7031         (ggml_fp1
+0005c350: 365f 7420 2a29 2070 6172 616d 732d 3e77  6_t *) params->w
+0005c360: 6461 7461 202b 2020 2069 312a 6577 302a  data +   i1*ew0*
+0005c370: 6e65 3030 202b 2020 2020 2020 286e 6820  ne00 +      (nh 
+0005c380: 2b20 6b29 2a65 7730 2c0a 2020 2020 2020  + k)*ew0,.      
+0005c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c3a0: 2020 2867 676d 6c5f 6670 3136 5f74 202a    (ggml_fp16_t *
+0005c3b0: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
+0005c3c0: 2b20 6e65 3032 2a65 7730 2a6e 6530 3020  + ne02*ew0*ne00 
+0005c3d0: 2b20 2869 3020 2b20 6e68 202b 206b 292a  + (i0 + nh + k)*
+0005c3e0: 6577 3029 3b0a 0a20 2020 2020 2020 2020  ew0);..         
+0005c3f0: 2020 2020 2020 2064 7374 5f64 6174 615b         dst_data[
+0005c400: 6930 5d20 2b3d 2076 3b0a 2020 2020 2020  i0] += v;.      
+0005c410: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0005c420: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+0005c430: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+0005c440: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
+0005c450: 5f31 645f 7331 5f70 685f 6633 3228 0a20  _1d_s1_ph_f32(. 
+0005c460: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005c470: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+0005c480: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+0005c490: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005c4a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005c4b0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+0005c4c0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005c4d0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0005c4e0: 6331 2c0a 2020 2020 2020 2020 2020 2020  c1,.            
+0005c4f0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0005c500: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0005c510: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
+0005c520: 6330 2d3e 7479 7065 203d 3d20 4747 4d4c  c0->type == GGML
+0005c530: 5f54 5950 455f 4633 3229 3b0a 2020 2020  _TYPE_F32);.    
+0005c540: 4747 4d4c 5f41 5353 4552 5428 7372 6331  GGML_ASSERT(src1
+0005c550: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0005c560: 5950 455f 4633 3229 3b0a 2020 2020 4747  YPE_F32);.    GG
+0005c570: 4d4c 5f41 5353 4552 5428 2064 7374 2d3e  ML_ASSERT( dst->
+0005c580: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+0005c590: 455f 4633 3229 3b0a 0a20 2020 2069 6e74  E_F32);..    int
+0005c5a0: 3634 5f74 2074 3020 3d20 6767 6d6c 5f70  64_t t0 = ggml_p
+0005c5b0: 6572 665f 7469 6d65 5f75 7328 293b 0a20  erf_time_us();. 
+0005c5c0: 2020 2055 4e55 5345 4428 7430 293b 0a0a     UNUSED(t0);..
+0005c5d0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+0005c5e0: 7420 6e65 3030 203d 2073 7263 302d 3e6e  t ne00 = src0->n
+0005c5f0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+0005c600: 696e 7436 345f 7420 6e65 3031 203d 2073  int64_t ne01 = s
+0005c610: 7263 302d 3e6e 655b 315d 3b0a 2020 2020  rc0->ne[1];.    
+0005c620: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0005c630: 3032 203d 2073 7263 302d 3e6e 655b 325d  02 = src0->ne[2]
+0005c640: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+0005c650: 7436 345f 7420 6e65 3033 203d 2073 7263  t64_t ne03 = src
+0005c660: 302d 3e6e 655b 335d 3b0a 0a20 2020 2063  0->ne[3];..    c
+0005c670: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
+0005c680: 3020 3d20 7372 6331 2d3e 6e65 5b30 5d3b  0 = src1->ne[0];
+0005c690: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+0005c6a0: 5f74 206e 6531 3120 3d20 7372 6331 2d3e  _t ne11 = src1->
+0005c6b0: 6e65 5b31 5d3b 0a20 2020 202f 2f63 6f6e  ne[1];.    //con
+0005c6c0: 7374 2069 6e74 3634 5f74 206e 6531 3220  st int64_t ne12 
+0005c6d0: 3d20 7372 6331 2d3e 6e65 5b32 5d3b 0a20  = src1->ne[2];. 
+0005c6e0: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
+0005c6f0: 5f74 206e 6531 3320 3d20 7372 6331 2d3e  _t ne13 = src1->
+0005c700: 6e65 5b33 5d3b 0a0a 2020 2020 2f2f 636f  ne[3];..    //co
+0005c710: 6e73 7420 696e 7436 345f 7420 6e65 3020  nst int64_t ne0 
+0005c720: 203d 2064 7374 2d3e 6e65 5b30 5d3b 0a20   = dst->ne[0];. 
+0005c730: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
+0005c740: 5f74 206e 6531 2020 3d20 6473 742d 3e6e  _t ne1  = dst->n
+0005c750: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
+0005c760: 7420 696e 7436 345f 7420 6e65 3220 203d  t int64_t ne2  =
+0005c770: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
+0005c780: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
+0005c790: 206e 6533 2020 3d20 6473 742d 3e6e 655b   ne3  = dst->ne[
+0005c7a0: 335d 3b0a 2020 2020 2f2f 636f 6e73 7420  3];.    //const 
+0005c7b0: 696e 7436 345f 7420 6e65 2020 203d 206e  int64_t ne   = n
+0005c7c0: 6530 2a6e 6531 2a6e 6532 2a6e 6533 3b0a  e0*ne1*ne2*ne3;.
+0005c7d0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005c7e0: 6230 3020 3d20 7372 6330 2d3e 6e62 5b30  b00 = src0->nb[0
+0005c7f0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005c800: 206e 6230 3120 3d20 7372 6330 2d3e 6e62   nb01 = src0->nb
+0005c810: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+0005c820: 6e74 206e 6230 3220 3d20 7372 6330 2d3e  nt nb02 = src0->
+0005c830: 6e62 5b32 5d3b 0a20 2020 202f 2f63 6f6e  nb[2];.    //con
+0005c840: 7374 2069 6e74 206e 6230 3320 3d20 7372  st int nb03 = sr
+0005c850: 6330 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c0->nb[3];..    
+0005c860: 636f 6e73 7420 696e 7420 6e62 3130 203d  const int nb10 =
+0005c870: 2073 7263 312d 3e6e 625b 305d 3b0a 2020   src1->nb[0];.  
+0005c880: 2020 636f 6e73 7420 696e 7420 6e62 3131    const int nb11
+0005c890: 203d 2073 7263 312d 3e6e 625b 315d 3b0a   = src1->nb[1];.
+0005c8a0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+0005c8b0: 6e62 3132 203d 2073 7263 312d 3e6e 625b  nb12 = src1->nb[
+0005c8c0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+0005c8d0: 696e 7420 6e62 3133 203d 2073 7263 312d  int nb13 = src1-
+0005c8e0: 3e6e 625b 335d 3b0a 0a20 2020 202f 2f63  >nb[3];..    //c
+0005c8f0: 6f6e 7374 2069 6e74 206e 6230 2020 3d20  onst int nb0  = 
+0005c900: 6473 742d 3e6e 625b 305d 3b0a 2020 2020  dst->nb[0];.    
+0005c910: 636f 6e73 7420 696e 7420 6e62 3120 203d  const int nb1  =
+0005c920: 2064 7374 2d3e 6e62 5b31 5d3b 0a20 2020   dst->nb[1];.   
+0005c930: 202f 2f63 6f6e 7374 2069 6e74 206e 6232   //const int nb2
+0005c940: 2020 3d20 6473 742d 3e6e 625b 325d 3b0a    = dst->nb[2];.
+0005c950: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+0005c960: 6e62 3320 203d 2064 7374 2d3e 6e62 5b33  nb3  = dst->nb[3
+0005c970: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+0005c980: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+0005c990: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0005c9a0: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+0005c9b0: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
+0005c9c0: 2069 6e74 206e 6b20 3d20 6e65 3030 3b0a   int nk = ne00;.
+0005c9d0: 2020 2020 636f 6e73 7420 696e 7420 6e68      const int nh
+0005c9e0: 203d 206e 6b2f 323b 0a0a 2020 2020 636f   = nk/2;..    co
+0005c9f0: 6e73 7420 696e 7420 6577 3020 3d20 6767  nst int ew0 = gg
+0005ca00: 6d6c 5f75 7033 3228 6e65 3031 293b 0a0a  ml_up32(ne01);..
+0005ca10: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0005ca20: 6e65 3030 2025 2032 203d 3d20 3129 3b20  ne00 % 2 == 1); 
+0005ca30: 2f2f 2054 4f44 4f3a 2073 7570 706f 7274  // TODO: support
+0005ca40: 2065 7665 6e20 6b65 726e 656c 2073 697a   even kernel siz
+0005ca50: 6573 0a20 2020 2047 474d 4c5f 4153 5345  es.    GGML_ASSE
+0005ca60: 5254 286e 6230 3020 3d3d 2073 697a 656f  RT(nb00 == sizeo
+0005ca70: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
+0005ca80: 474d 4c5f 4153 5345 5254 286e 6231 3020  GML_ASSERT(nb10 
+0005ca90: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+0005caa0: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
+0005cab0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+0005cac0: 5f54 4153 4b5f 494e 4954 2920 7b0a 2020  _TASK_INIT) {.  
+0005cad0: 2020 2020 2020 2f2f 2054 4f44 4f3a 2066        // TODO: f
+0005cae0: 6978 2074 6869 7320 6d65 6d73 6574 2028  ix this memset (
+0005caf0: 7773 697a 6520 6973 206f 7665 7265 7374  wsize is overest
+0005cb00: 696d 6174 6564 290a 2020 2020 2020 2020  imated).        
+0005cb10: 6d65 6d73 6574 2870 6172 616d 732d 3e77  memset(params->w
+0005cb20: 6461 7461 2c20 302c 2070 6172 616d 732d  data, 0, params-
+0005cb30: 3e77 7369 7a65 293b 0a0a 2020 2020 2020  >wsize);..      
+0005cb40: 2020 2f2f 2070 7265 7061 7265 206b 6572    // prepare ker
+0005cb50: 6e65 6c20 6461 7461 2028 7372 6330 290a  nel data (src0).
+0005cb60: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0005cb70: 2020 2020 2020 666c 6f61 7420 2a20 636f        float * co
+0005cb80: 6e73 7420 7764 6174 6120 3d20 2866 6c6f  nst wdata = (flo
+0005cb90: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
+0005cba0: 6174 6120 2b20 303b 0a0a 2020 2020 2020  ata + 0;..      
+0005cbb0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0005cbc0: 5f74 2069 3032 203d 2030 3b20 6930 3220  _t i02 = 0; i02 
+0005cbd0: 3c20 6e65 3032 3b20 6930 322b 2b29 207b  < ne02; i02++) {
+0005cbe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005cbf0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+0005cc00: 3120 3d20 303b 2069 3031 203c 206e 6530  1 = 0; i01 < ne0
+0005cc10: 313b 2069 3031 2b2b 2920 7b0a 2020 2020  1; i01++) {.    
+0005cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc30: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
+0005cc40: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
+0005cc50: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
+0005cc60: 302d 3e64 6174 6120 2b20 6930 322a 6e62  0->data + i02*nb
+0005cc70: 3032 202b 2069 3031 2a6e 6230 3129 3b0a  02 + i01*nb01);.
+0005cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc90: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
+0005cca0: 6461 7461 203d 2077 6461 7461 202b 2069  data = wdata + i
+0005ccb0: 3032 2a65 7730 2a6e 6530 303b 0a20 2020  02*ew0*ne00;.   
+0005ccc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ccd0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+0005cce0: 3020 3d20 303b 2069 3030 203c 206e 6530  0 = 0; i00 < ne0
+0005ccf0: 303b 2069 3030 2b2b 2920 7b0a 2020 2020  0; i00++) {.    
+0005cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cd10: 2020 2020 6473 745f 6461 7461 5b69 3030      dst_data[i00
+0005cd20: 2a65 7730 202b 2069 3031 5d20 3d20 7372  *ew0 + i01] = sr
+0005cd30: 635b 6930 305d 3b0a 2020 2020 2020 2020  c[i00];.        
+0005cd40: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0005cd50: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0005cd60: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0005cd70: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0005cd80: 202f 2f20 7072 6570 6172 6520 736f 7572   // prepare sour
+0005cd90: 6365 2064 6174 6120 2873 7263 3129 0a20  ce data (src1). 
+0005cda0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0005cdb0: 2020 2020 2066 6c6f 6174 202a 2063 6f6e       float * con
+0005cdc0: 7374 2077 6461 7461 203d 2028 666c 6f61  st wdata = (floa
+0005cdd0: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
+0005cde0: 7461 202b 206e 6530 322a 6577 302a 6e65  ta + ne02*ew0*ne
+0005cdf0: 3030 3b0a 0a20 2020 2020 2020 2020 2020  00;..           
+0005ce00: 2066 6f72 2028 696e 7436 345f 7420 6931   for (int64_t i1
+0005ce10: 3120 3d20 303b 2069 3131 203c 206e 6531  1 = 0; i11 < ne1
+0005ce20: 313b 2069 3131 2b2b 2920 7b0a 2020 2020  1; i11++) {.    
+0005ce30: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0005ce40: 7420 666c 6f61 7420 2a20 636f 6e73 7420  t float * const 
+0005ce50: 7372 6320 3d20 2866 6c6f 6174 202a 2928  src = (float *)(
+0005ce60: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
+0005ce70: 6174 6120 2b20 6931 312a 6e62 3131 293b  ata + i11*nb11);
+0005ce80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005ce90: 2066 6c6f 6174 202a 2064 7374 5f64 6174   float * dst_dat
+0005cea0: 6120 3d20 7764 6174 613b 0a20 2020 2020  a = wdata;.     
+0005ceb0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0005cec0: 696e 7436 345f 7420 6931 3020 3d20 303b  int64_t i10 = 0;
+0005ced0: 2069 3130 203c 206e 6531 303b 2069 3130   i10 < ne10; i10
+0005cee0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005cef0: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
+0005cf00: 7461 5b28 6931 3020 2b20 6e68 292a 6577  ta[(i10 + nh)*ew
+0005cf10: 3020 2b20 6931 315d 203d 2073 7263 5b69  0 + i11] = src[i
+0005cf20: 3130 5d3b 0a20 2020 2020 2020 2020 2020  10];.           
+0005cf30: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0005cf40: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+0005cf50: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+0005cf60: 2020 2020 7d0a 0a20 2020 2069 6620 2870      }..    if (p
+0005cf70: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005cf80: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
+0005cf90: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
+0005cfa0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+0005cfb0: 2f2f 2074 6f74 616c 2072 6f77 7320 696e  // total rows in
+0005cfc0: 2064 7374 0a20 2020 2063 6f6e 7374 2069   dst.    const i
+0005cfd0: 6e74 206e 7220 3d20 6e65 3032 3b0a 0a20  nt nr = ne02;.. 
+0005cfe0: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
+0005cff0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+0005d000: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
+0005d010: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
+0005d020: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
+0005d030: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
+0005d040: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
+0005d050: 203d 2064 722a 6974 683b 0a20 2020 2063   = dr*ith;.    c
+0005d060: 6f6e 7374 2069 6e74 2069 7231 203d 204d  onst int ir1 = M
+0005d070: 494e 2869 7230 202b 2064 722c 206e 7229  IN(ir0 + dr, nr)
+0005d080: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+0005d090: 6931 203d 2069 7230 3b20 6931 203c 2069  i1 = ir0; i1 < i
+0005d0a0: 7231 3b20 6931 2b2b 2920 7b0a 2020 2020  r1; i1++) {.    
+0005d0b0: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
+0005d0c0: 6461 7461 203d 2028 666c 6f61 7420 2a29  data = (float *)
+0005d0d0: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
+0005d0e0: 6174 6120 2b20 6931 2a6e 6231 293b 0a20  ata + i1*nb1);. 
+0005d0f0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0005d100: 345f 7420 6930 203d 2030 3b20 6930 203c  4_t i0 = 0; i0 <
+0005d110: 206e 6531 303b 202b 2b69 3029 207b 0a20   ne10; ++i0) {. 
+0005d120: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+0005d130: 6174 615b 6930 5d20 3d20 303b 0a20 2020  ata[i0] = 0;.   
+0005d140: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0005d150: 7420 6b20 3d20 2d6e 683b 206b 203c 3d20  t k = -nh; k <= 
+0005d160: 6e68 3b20 6b2b 2b29 207b 0a20 2020 2020  nh; k++) {.     
+0005d170: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0005d180: 2076 203d 2030 2e30 663b 0a20 2020 2020   v = 0.0f;.     
+0005d190: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0005d1a0: 7665 635f 646f 745f 6633 3228 6577 302c  vec_dot_f32(ew0,
+0005d1b0: 2026 762c 0a20 2020 2020 2020 2020 2020   &v,.           
+0005d1c0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+0005d1d0: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
+0005d1e0: 6461 7461 202b 2020 2069 312a 6577 302a  data +   i1*ew0*
+0005d1f0: 6e65 3030 202b 2020 2020 2020 286e 6820  ne00 +      (nh 
+0005d200: 2b20 6b29 2a65 7730 2c0a 2020 2020 2020  + k)*ew0,.      
+0005d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d220: 2020 2866 6c6f 6174 202a 2920 7061 7261    (float *) para
+0005d230: 6d73 2d3e 7764 6174 6120 2b20 6e65 3032  ms->wdata + ne02
+0005d240: 2a65 7730 2a6e 6530 3020 2b20 2869 3020  *ew0*ne00 + (i0 
+0005d250: 2b20 6e68 202b 206b 292a 6577 3029 3b0a  + nh + k)*ew0);.
+0005d260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005d270: 2064 7374 5f64 6174 615b 6930 5d20 2b3d   dst_data[i0] +=
+0005d280: 2076 3b0a 2020 2020 2020 2020 2020 2020   v;.            
+0005d290: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+0005d2a0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+0005d2b0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0005d2c0: 7277 6172 645f 636f 6e76 5f31 645f 7331  rward_conv_1d_s1
+0005d2d0: 5f70 6828 0a20 2020 2020 2020 2063 6f6e  _ph(.        con
+0005d2e0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0005d2f0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0005d300: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0005d310: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005d320: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0005d330: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0005d340: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005d350: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+0005d360: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0005d370: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0005d380: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+0005d390: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+0005d3a0: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+0005d3b0: 3136 3a0a 2020 2020 2020 2020 2020 2020  16:.            
+0005d3c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005d3d0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0005d3e0: 6f72 7761 7264 5f63 6f6e 765f 3164 5f73  orward_conv_1d_s
+0005d3f0: 315f 7068 5f66 3136 5f66 3332 2870 6172  1_ph_f16_f32(par
+0005d400: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
+0005d410: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+0005d420: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0005d430: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005d440: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+0005d450: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0005d460: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0005d470: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+0005d480: 3164 5f73 315f 7068 5f66 3332 2870 6172  1d_s1_ph_f32(par
+0005d490: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
+0005d4a0: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+0005d4b0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0005d4c0: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
+0005d4d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0005d4e0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0005d4f0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+0005d500: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0005d510: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
+0005d520: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0005d530: 7761 7264 5f63 6f6e 765f 3164 5f73 325f  ward_conv_1d_s2_
+0005d540: 7068 0a0a 7374 6174 6963 2076 6f69 6420  ph..static void 
+0005d550: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0005d560: 7761 7264 5f63 6f6e 765f 3164 5f73 325f  ward_conv_1d_s2_
+0005d570: 7068 5f66 3136 5f66 3332 280a 2020 2020  ph_f16_f32(.    
+0005d580: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0005d590: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0005d5a0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0005d5b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005d5c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0005d5d0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0005d5e0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005d5f0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0005d600: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
+0005d610: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005d620: 7220 2a20 6473 7429 207b 0a20 2020 2047  r * dst) {.    G
+0005d630: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
+0005d640: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+0005d650: 5045 5f46 3136 293b 0a20 2020 2047 474d  PE_F16);.    GGM
+0005d660: 4c5f 4153 5345 5254 2873 7263 312d 3e74  L_ASSERT(src1->t
+0005d670: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0005d680: 5f46 3332 293b 0a20 2020 2047 474d 4c5f  _F32);.    GGML_
+0005d690: 4153 5345 5254 2820 6473 742d 3e74 7970  ASSERT( dst->typ
+0005d6a0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+0005d6b0: 3332 293b 0a0a 2020 2020 696e 7436 345f  32);..    int64_
+0005d6c0: 7420 7430 203d 2067 676d 6c5f 7065 7266  t t0 = ggml_perf
+0005d6d0: 5f74 696d 655f 7573 2829 3b0a 2020 2020  _time_us();.    
+0005d6e0: 554e 5553 4544 2874 3029 3b0a 0a20 2020  UNUSED(t0);..   
+0005d6f0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0005d700: 6530 3020 3d20 7372 6330 2d3e 6e65 5b30  e00 = src0->ne[0
+0005d710: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005d720: 3634 5f74 206e 6530 3120 3d20 7372 6330  64_t ne01 = src0
+0005d730: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+0005d740: 7374 2069 6e74 3634 5f74 206e 6530 3220  st int64_t ne02 
+0005d750: 3d20 7372 6330 2d3e 6e65 5b32 5d3b 0a20  = src0->ne[2];. 
+0005d760: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
+0005d770: 5f74 206e 6530 3320 3d20 7372 6330 2d3e  _t ne03 = src0->
+0005d780: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+0005d790: 7420 696e 7436 345f 7420 6e65 3130 203d  t int64_t ne10 =
+0005d7a0: 2073 7263 312d 3e6e 655b 305d 3b0a 2020   src1->ne[0];.  
+0005d7b0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0005d7c0: 6e65 3131 203d 2073 7263 312d 3e6e 655b  ne11 = src1->ne[
+0005d7d0: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
+0005d7e0: 696e 7436 345f 7420 6e65 3132 203d 2073  int64_t ne12 = s
+0005d7f0: 7263 312d 3e6e 655b 325d 3b0a 2020 2020  rc1->ne[2];.    
+0005d800: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+0005d810: 6e65 3133 203d 2073 7263 312d 3e6e 655b  ne13 = src1->ne[
+0005d820: 335d 3b0a 0a20 2020 202f 2f63 6f6e 7374  3];..    //const
+0005d830: 2069 6e74 3634 5f74 206e 6530 2020 3d20   int64_t ne0  = 
+0005d840: 6473 742d 3e6e 655b 305d 3b0a 2020 2020  dst->ne[0];.    
+0005d850: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+0005d860: 6e65 3120 203d 2064 7374 2d3e 6e65 5b31  ne1  = dst->ne[1
+0005d870: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0005d880: 6e74 3634 5f74 206e 6532 2020 3d20 6473  nt64_t ne2  = ds
+0005d890: 742d 3e6e 655b 325d 3b0a 2020 2020 2f2f  t->ne[2];.    //
+0005d8a0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0005d8b0: 3320 203d 2064 7374 2d3e 6e65 5b33 5d3b  3  = dst->ne[3];
+0005d8c0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0005d8d0: 3634 5f74 206e 6520 2020 3d20 6e65 302a  64_t ne   = ne0*
+0005d8e0: 6e65 312a 6e65 322a 6e65 333b 0a0a 2020  ne1*ne2*ne3;..  
+0005d8f0: 2020 636f 6e73 7420 696e 7420 6e62 3030    const int nb00
+0005d900: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
+0005d910: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
+0005d920: 3031 203d 2073 7263 302d 3e6e 625b 315d  01 = src0->nb[1]
+0005d930: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005d940: 6e62 3032 203d 2073 7263 302d 3e6e 625b  nb02 = src0->nb[
+0005d950: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+0005d960: 696e 7420 6e62 3033 203d 2073 7263 302d  int nb03 = src0-
+0005d970: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+0005d980: 7374 2069 6e74 206e 6231 3020 3d20 7372  st int nb10 = sr
+0005d990: 6331 2d3e 6e62 5b30 5d3b 0a20 2020 2063  c1->nb[0];.    c
+0005d9a0: 6f6e 7374 2069 6e74 206e 6231 3120 3d20  onst int nb11 = 
+0005d9b0: 7372 6331 2d3e 6e62 5b31 5d3b 0a20 2020  src1->nb[1];.   
+0005d9c0: 202f 2f63 6f6e 7374 2069 6e74 206e 6231   //const int nb1
+0005d9d0: 3220 3d20 7372 6331 2d3e 6e62 5b32 5d3b  2 = src1->nb[2];
+0005d9e0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0005d9f0: 206e 6231 3320 3d20 7372 6331 2d3e 6e62   nb13 = src1->nb
+0005da00: 5b33 5d3b 0a0a 2020 2020 2f2f 636f 6e73  [3];..    //cons
+0005da10: 7420 696e 7420 6e62 3020 203d 2064 7374  t int nb0  = dst
+0005da20: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+0005da30: 7374 2069 6e74 206e 6231 2020 3d20 6473  st int nb1  = ds
+0005da40: 742d 3e6e 625b 315d 3b0a 2020 2020 2f2f  t->nb[1];.    //
+0005da50: 636f 6e73 7420 696e 7420 6e62 3220 203d  const int nb2  =
+0005da60: 2064 7374 2d3e 6e62 5b32 5d3b 0a20 2020   dst->nb[2];.   
+0005da70: 202f 2f63 6f6e 7374 2069 6e74 206e 6233   //const int nb3
+0005da80: 2020 3d20 6473 742d 3e6e 625b 335d 3b0a    = dst->nb[3];.
+0005da90: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+0005daa0: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
+0005dab0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005dac0: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
+0005dad0: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
+0005dae0: 7420 6e6b 203d 206e 6530 303b 0a20 2020  t nk = ne00;.   
+0005daf0: 2063 6f6e 7374 2069 6e74 206e 6820 3d20   const int nh = 
+0005db00: 6e6b 2f32 3b0a 0a20 2020 2063 6f6e 7374  nk/2;..    const
+0005db10: 2069 6e74 2065 7730 203d 2067 676d 6c5f   int ew0 = ggml_
+0005db20: 7570 3332 286e 6530 3129 3b0a 0a20 2020  up32(ne01);..   
+0005db30: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
+0005db40: 3020 2520 3220 3d3d 2031 293b 202f 2f20  0 % 2 == 1); // 
+0005db50: 544f 444f 3a20 7375 7070 6f72 7420 6576  TODO: support ev
+0005db60: 656e 206b 6572 6e65 6c20 7369 7a65 730a  en kernel sizes.
+0005db70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0005db80: 6e62 3030 203d 3d20 7369 7a65 6f66 2867  nb00 == sizeof(g
+0005db90: 676d 6c5f 6670 3136 5f74 2929 3b0a 2020  gml_fp16_t));.  
+0005dba0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0005dbb0: 3130 203d 3d20 7369 7a65 6f66 2866 6c6f  10 == sizeof(flo
+0005dbc0: 6174 2929 3b0a 0a20 2020 2069 6620 2870  at));..    if (p
+0005dbd0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005dbe0: 474d 4c5f 5441 534b 5f49 4e49 5429 207b  GML_TASK_INIT) {
+0005dbf0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+0005dc00: 3a20 6669 7820 7468 6973 206d 656d 7365  : fix this memse
+0005dc10: 7420 2877 7369 7a65 2069 7320 6f76 6572  t (wsize is over
+0005dc20: 6573 7469 6d61 7465 6429 0a20 2020 2020  estimated).     
+0005dc30: 2020 206d 656d 7365 7428 7061 7261 6d73     memset(params
+0005dc40: 2d3e 7764 6174 612c 2030 2c20 7061 7261  ->wdata, 0, para
+0005dc50: 6d73 2d3e 7773 697a 6529 3b0a 0a20 2020  ms->wsize);..   
+0005dc60: 2020 2020 202f 2f20 7072 6570 6172 6520       // prepare 
+0005dc70: 6b65 726e 656c 2064 6174 6120 2873 7263  kernel data (src
+0005dc80: 3029 0a20 2020 2020 2020 207b 0a20 2020  0).        {.   
+0005dc90: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
+0005dca0: 3136 5f74 202a 2063 6f6e 7374 2077 6461  16_t * const wda
+0005dcb0: 7461 203d 2028 6767 6d6c 5f66 7031 365f  ta = (ggml_fp16_
+0005dcc0: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
+0005dcd0: 7461 202b 2030 3b0a 0a20 2020 2020 2020  ta + 0;..       
+0005dce0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+0005dcf0: 7420 6930 3220 3d20 303b 2069 3032 203c  t i02 = 0; i02 <
+0005dd00: 206e 6530 323b 2069 3032 2b2b 2920 7b0a   ne02; i02++) {.
+0005dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005dd20: 666f 7220 2869 6e74 3634 5f74 2069 3031  for (int64_t i01
+0005dd30: 203d 2030 3b20 6930 3120 3c20 6e65 3031   = 0; i01 < ne01
+0005dd40: 3b20 6930 312b 2b29 207b 0a20 2020 2020  ; i01++) {.     
+0005dd50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0005dd60: 6f6e 7374 2067 676d 6c5f 6670 3136 5f74  onst ggml_fp16_t
+0005dd70: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
+0005dd80: 6767 6d6c 5f66 7031 365f 7420 2a29 2828  ggml_fp16_t *)((
+0005dd90: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
+0005dda0: 7461 202b 2069 3032 2a6e 6230 3220 2b20  ta + i02*nb02 + 
+0005ddb0: 6930 312a 6e62 3031 293b 0a20 2020 2020  i01*nb01);.     
+0005ddc0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0005ddd0: 676d 6c5f 6670 3136 5f74 202a 2064 7374  gml_fp16_t * dst
+0005dde0: 5f64 6174 6120 3d20 7764 6174 6120 2b20  _data = wdata + 
+0005ddf0: 6930 322a 6577 302a 6e65 3030 3b0a 2020  i02*ew0*ne00;.  
+0005de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005de10: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0005de20: 3030 203d 2030 3b20 6930 3020 3c20 6e65  00 = 0; i00 < ne
+0005de30: 3030 3b20 6930 302b 2b29 207b 0a20 2020  00; i00++) {.   
 0005de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005de50: 6473 745f 6461 7461 5b69 3030 2a65 7730  dst_data[i00*ew0
-0005de60: 202b 2069 3031 5d20 3d20 7372 635b 6930   + i01] = src[i0
-0005de70: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-0005de80: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0005de90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0005dea0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0005deb0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
-0005dec0: 7072 6570 6172 6520 736f 7572 6365 2064  prepare source d
-0005ded0: 6174 6120 2873 7263 3129 0a20 2020 2020  ata (src1).     
-0005dee0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0005def0: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-0005df00: 6f6e 7374 2077 6461 7461 203d 2028 6767  onst wdata = (gg
-0005df10: 6d6c 5f66 7031 365f 7420 2a29 2070 6172  ml_fp16_t *) par
-0005df20: 616d 732d 3e77 6461 7461 202b 206e 6530  ams->wdata + ne0
-0005df30: 322a 6577 302a 6e65 3030 3b0a 0a20 2020  2*ew0*ne00;..   
-0005df40: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0005df50: 7436 345f 7420 6931 3120 3d20 303b 2069  t64_t i11 = 0; i
-0005df60: 3131 203c 206e 6531 313b 2069 3131 2b2b  11 < ne11; i11++
-0005df70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005df80: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0005df90: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
-0005dfa0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-0005dfb0: 2073 7263 312d 3e64 6174 6120 2b20 6931   src1->data + i1
-0005dfc0: 312a 6e62 3131 293b 0a20 2020 2020 2020  1*nb11);.       
-0005dfd0: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
-0005dfe0: 3136 5f74 202a 2064 7374 5f64 6174 6120  16_t * dst_data 
-0005dff0: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
-0005e000: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0005e010: 7436 345f 7420 6931 3020 3d20 303b 2069  t64_t i10 = 0; i
-0005e020: 3130 203c 206e 6531 303b 2069 3130 2b2b  10 < ne10; i10++
-0005e030: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005e040: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-0005e050: 5b28 6931 3020 2b20 6e68 292a 6577 3020  [(i10 + nh)*ew0 
-0005e060: 2b20 6931 315d 203d 2047 474d 4c5f 4650  + i11] = GGML_FP
-0005e070: 3332 5f54 4f5f 4650 3136 2873 7263 5b69  32_TO_FP16(src[i
-0005e080: 3130 5d29 3b0a 2020 2020 2020 2020 2020  10]);.          
-0005e090: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0005e0a0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-0005e0b0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-0005e0c0: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-0005e0d0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-0005e0e0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-0005e0f0: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-0005e100: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-0005e110: 202f 2f20 746f 7461 6c20 726f 7773 2069   // total rows i
-0005e120: 6e20 6473 740a 2020 2020 636f 6e73 7420  n dst.    const 
-0005e130: 696e 7420 6e72 203d 206e 6530 323b 0a0a  int nr = ne02;..
-0005e140: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
-0005e150: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-0005e160: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
-0005e170: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
-0005e180: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
-0005e190: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
-0005e1a0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-0005e1b0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
-0005e1c0: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
-0005e1d0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
-0005e1e0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-0005e1f0: 2069 3120 3d20 6972 303b 2069 3120 3c20   i1 = ir0; i1 < 
-0005e200: 6972 313b 2069 312b 2b29 207b 0a20 2020  ir1; i1++) {.   
-0005e210: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
-0005e220: 5f64 6174 6120 3d20 2866 6c6f 6174 202a  _data = (float *
-0005e230: 2928 2863 6861 7220 2a29 2064 7374 2d3e  )((char *) dst->
-0005e240: 6461 7461 202b 2069 312a 6e62 3129 3b0a  data + i1*nb1);.
-0005e250: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005e260: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-0005e270: 3c20 6e65 3130 3b20 6930 202b 3d20 3229  < ne10; i0 += 2)
-0005e280: 207b 0a20 2020 2020 2020 2020 2020 2064   {.            d
-0005e290: 7374 5f64 6174 615b 6930 2f32 5d20 3d20  st_data[i0/2] = 
-0005e2a0: 303b 0a20 2020 2020 2020 2020 2020 2066  0;.            f
-0005e2b0: 6f72 2028 696e 7420 6b20 3d20 2d6e 683b  or (int k = -nh;
-0005e2c0: 206b 203c 3d20 6e68 3b20 6b2b 2b29 207b   k <= nh; k++) {
-0005e2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005e2e0: 2066 6c6f 6174 2076 203d 2030 2e30 663b   float v = 0.0f;
-0005e2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005e300: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
-0005e310: 3628 6577 302c 2026 762c 0a20 2020 2020  6(ew0, &v,.     
+0005de50: 2020 2020 2064 7374 5f64 6174 615b 6930       dst_data[i0
+0005de60: 302a 6577 3020 2b20 6930 315d 203d 2073  0*ew0 + i01] = s
+0005de70: 7263 5b69 3030 5d3b 0a20 2020 2020 2020  rc[i00];.       
+0005de80: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0005de90: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005dea0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0005deb0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0005dec0: 2020 2f2f 2070 7265 7061 7265 2073 6f75    // prepare sou
+0005ded0: 7263 6520 6461 7461 2028 7372 6331 290a  rce data (src1).
+0005dee0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0005def0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
+0005df00: 7420 2a20 636f 6e73 7420 7764 6174 6120  t * const wdata 
+0005df10: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+0005df20: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
+0005df30: 2b20 6e65 3032 2a65 7730 2a6e 6530 303b  + ne02*ew0*ne00;
+0005df40: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0005df50: 7220 2869 6e74 3634 5f74 2069 3131 203d  r (int64_t i11 =
+0005df60: 2030 3b20 6931 3120 3c20 6e65 3131 3b20   0; i11 < ne11; 
+0005df70: 6931 312b 2b29 207b 0a20 2020 2020 2020  i11++) {.       
+0005df80: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005df90: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
+0005dfa0: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+0005dfb0: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
+0005dfc0: 202b 2069 3131 2a6e 6231 3129 3b0a 2020   + i11*nb11);.  
+0005dfd0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0005dfe0: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
+0005dff0: 6461 7461 203d 2077 6461 7461 3b0a 2020  data = wdata;.  
+0005e000: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0005e010: 7220 2869 6e74 3634 5f74 2069 3130 203d  r (int64_t i10 =
+0005e020: 2030 3b20 6931 3020 3c20 6e65 3130 3b20   0; i10 < ne10; 
+0005e030: 6931 302b 2b29 207b 0a20 2020 2020 2020  i10++) {.       
+0005e040: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+0005e050: 5f64 6174 615b 2869 3130 202b 206e 6829  _data[(i10 + nh)
+0005e060: 2a65 7730 202b 2069 3131 5d20 3d20 4747  *ew0 + i11] = GG
+0005e070: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+0005e080: 7372 635b 6931 305d 293b 0a20 2020 2020  src[i10]);.     
+0005e090: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0005e0a0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0005e0b0: 2020 207d 0a0a 2020 2020 2020 2020 7265     }..        re
+0005e0c0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+0005e0d0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+0005e0e0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+0005e0f0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+0005e100: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+0005e110: 0a0a 2020 2020 2f2f 2074 6f74 616c 2072  ..    // total r
+0005e120: 6f77 7320 696e 2064 7374 0a20 2020 2063  ows in dst.    c
+0005e130: 6f6e 7374 2069 6e74 206e 7220 3d20 6e65  onst int nr = ne
+0005e140: 3032 3b0a 0a20 2020 202f 2f20 726f 7773  02;..    // rows
+0005e150: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
+0005e160: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
+0005e170: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
+0005e180: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
+0005e190: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
+0005e1a0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+0005e1b0: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
+0005e1c0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+0005e1d0: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
+0005e1e0: 722c 206e 7229 3b0a 0a20 2020 2066 6f72  r, nr);..    for
+0005e1f0: 2028 696e 7420 6931 203d 2069 7230 3b20   (int i1 = ir0; 
+0005e200: 6931 203c 2069 7231 3b20 6931 2b2b 2920  i1 < ir1; i1++) 
+0005e210: 7b0a 2020 2020 2020 2020 666c 6f61 7420  {.        float 
+0005e220: 2a20 6473 745f 6461 7461 203d 2028 666c  * dst_data = (fl
+0005e230: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+0005e240: 6473 742d 3e64 6174 6120 2b20 6931 2a6e  dst->data + i1*n
+0005e250: 6231 293b 0a20 2020 2020 2020 2066 6f72  b1);.        for
+0005e260: 2028 696e 7436 345f 7420 6930 203d 2030   (int64_t i0 = 0
+0005e270: 3b20 6930 203c 206e 6531 303b 2069 3020  ; i0 < ne10; i0 
+0005e280: 2b3d 2032 2920 7b0a 2020 2020 2020 2020  += 2) {.        
+0005e290: 2020 2020 6473 745f 6461 7461 5b69 302f      dst_data[i0/
+0005e2a0: 325d 203d 2030 3b0a 2020 2020 2020 2020  2] = 0;.        
+0005e2b0: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
+0005e2c0: 202d 6e68 3b20 6b20 3c3d 206e 683b 206b   -nh; k <= nh; k
+0005e2d0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005e2e0: 2020 2020 2020 666c 6f61 7420 7620 3d20        float v = 
+0005e2f0: 302e 3066 3b0a 2020 2020 2020 2020 2020  0.0f;.          
+0005e300: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+0005e310: 6f74 5f66 3136 2865 7730 2c20 2676 2c0a  ot_f16(ew0, &v,.
 0005e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e330: 2020 2028 6767 6d6c 5f66 7031 365f 7420     (ggml_fp16_t 
-0005e340: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
-0005e350: 202b 2020 2069 312a 6577 302a 6e65 3030   +   i1*ew0*ne00
-0005e360: 202b 2020 2020 2020 286e 6820 2b20 6b29   +      (nh + k)
-0005e370: 2a65 7730 2c0a 2020 2020 2020 2020 2020  *ew0,.          
-0005e380: 2020 2020 2020 2020 2020 2020 2020 2867                (g
-0005e390: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
-0005e3a0: 7261 6d73 2d3e 7764 6174 6120 2b20 6e65  rams->wdata + ne
-0005e3b0: 3032 2a65 7730 2a6e 6530 3020 2b20 2869  02*ew0*ne00 + (i
-0005e3c0: 3020 2b20 6e68 202b 206b 292a 6577 3029  0 + nh + k)*ew0)
-0005e3d0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0005e3e0: 2020 2064 7374 5f64 6174 615b 6930 2f32     dst_data[i0/2
-0005e3f0: 5d20 2b3d 2076 3b0a 2020 2020 2020 2020  ] += v;.        
-0005e400: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-0005e410: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-0005e420: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0005e430: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
-0005e440: 645f 7332 5f70 685f 6633 3228 0a20 2020  d_s2_ph_f32(.   
-0005e450: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005e460: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0005e470: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0005e480: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005e490: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005e4a0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0005e4b0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0005e4c0: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-0005e4d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0005e4e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0005e4f0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-0005e500: 4747 4d4c 5f41 5353 4552 5428 7372 6330  GGML_ASSERT(src0
-0005e510: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005e520: 5950 455f 4633 3229 3b0a 2020 2020 4747  YPE_F32);.    GG
-0005e530: 4d4c 5f41 5353 4552 5428 7372 6331 2d3e  ML_ASSERT(src1->
-0005e540: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0005e550: 455f 4633 3229 3b0a 2020 2020 4747 4d4c  E_F32);.    GGML
-0005e560: 5f41 5353 4552 5428 2064 7374 2d3e 7479  _ASSERT( dst->ty
-0005e570: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0005e580: 4633 3229 3b0a 0a20 2020 2069 6e74 3634  F32);..    int64
-0005e590: 5f74 2074 3020 3d20 6767 6d6c 5f70 6572  _t t0 = ggml_per
-0005e5a0: 665f 7469 6d65 5f75 7328 293b 0a20 2020  f_time_us();.   
-0005e5b0: 2055 4e55 5345 4428 7430 293b 0a0a 2020   UNUSED(t0);..  
-0005e5c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0005e5d0: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
-0005e5e0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0005e5f0: 7436 345f 7420 6e65 3031 203d 2073 7263  t64_t ne01 = src
-0005e600: 302d 3e6e 655b 315d 3b0a 2020 2020 636f  0->ne[1];.    co
-0005e610: 6e73 7420 696e 7436 345f 7420 6e65 3032  nst int64_t ne02
-0005e620: 203d 2073 7263 302d 3e6e 655b 325d 3b0a   = src0->ne[2];.
-0005e630: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-0005e640: 345f 7420 6e65 3033 203d 2073 7263 302d  4_t ne03 = src0-
-0005e650: 3e6e 655b 335d 3b0a 0a20 2020 2063 6f6e  >ne[3];..    con
-0005e660: 7374 2069 6e74 3634 5f74 206e 6531 3020  st int64_t ne10 
-0005e670: 3d20 7372 6331 2d3e 6e65 5b30 5d3b 0a20  = src1->ne[0];. 
-0005e680: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-0005e690: 206e 6531 3120 3d20 7372 6331 2d3e 6e65   ne11 = src1->ne
-0005e6a0: 5b31 5d3b 0a20 2020 202f 2f63 6f6e 7374  [1];.    //const
-0005e6b0: 2069 6e74 3634 5f74 206e 6531 3220 3d20   int64_t ne12 = 
-0005e6c0: 7372 6331 2d3e 6e65 5b32 5d3b 0a20 2020  src1->ne[2];.   
-0005e6d0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-0005e6e0: 206e 6531 3320 3d20 7372 6331 2d3e 6e65   ne13 = src1->ne
-0005e6f0: 5b33 5d3b 0a0a 2020 2020 2f2f 636f 6e73  [3];..    //cons
-0005e700: 7420 696e 7436 345f 7420 6e65 3020 203d  t int64_t ne0  =
-0005e710: 2064 7374 2d3e 6e65 5b30 5d3b 0a20 2020   dst->ne[0];.   
-0005e720: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-0005e730: 206e 6531 2020 3d20 6473 742d 3e6e 655b   ne1  = dst->ne[
-0005e740: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
-0005e750: 696e 7436 345f 7420 6e65 3220 203d 2064  int64_t ne2  = d
-0005e760: 7374 2d3e 6e65 5b32 5d3b 0a20 2020 202f  st->ne[2];.    /
-0005e770: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-0005e780: 6533 2020 3d20 6473 742d 3e6e 655b 335d  e3  = dst->ne[3]
-0005e790: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0005e7a0: 7436 345f 7420 6e65 2020 203d 206e 6530  t64_t ne   = ne0
-0005e7b0: 2a6e 6531 2a6e 6532 2a6e 6533 3b0a 0a20  *ne1*ne2*ne3;.. 
-0005e7c0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-0005e7d0: 3020 3d20 7372 6330 2d3e 6e62 5b30 5d3b  0 = src0->nb[0];
-0005e7e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005e7f0: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
-0005e800: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0005e810: 206e 6230 3220 3d20 7372 6330 2d3e 6e62   nb02 = src0->nb
-0005e820: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-0005e830: 2069 6e74 206e 6230 3320 3d20 7372 6330   int nb03 = src0
-0005e840: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
-0005e850: 6e73 7420 696e 7420 6e62 3130 203d 2073  nst int nb10 = s
-0005e860: 7263 312d 3e6e 625b 305d 3b0a 2020 2020  rc1->nb[0];.    
-0005e870: 636f 6e73 7420 696e 7420 6e62 3131 203d  const int nb11 =
-0005e880: 2073 7263 312d 3e6e 625b 315d 3b0a 2020   src1->nb[1];.  
-0005e890: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-0005e8a0: 3132 203d 2073 7263 312d 3e6e 625b 325d  12 = src1->nb[2]
-0005e8b0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0005e8c0: 7420 6e62 3133 203d 2073 7263 312d 3e6e  t nb13 = src1->n
-0005e8d0: 625b 335d 3b0a 0a20 2020 202f 2f63 6f6e  b[3];..    //con
-0005e8e0: 7374 2069 6e74 206e 6230 2020 3d20 6473  st int nb0  = ds
-0005e8f0: 742d 3e6e 625b 305d 3b0a 2020 2020 636f  t->nb[0];.    co
-0005e900: 6e73 7420 696e 7420 6e62 3120 203d 2064  nst int nb1  = d
-0005e910: 7374 2d3e 6e62 5b31 5d3b 0a20 2020 202f  st->nb[1];.    /
-0005e920: 2f63 6f6e 7374 2069 6e74 206e 6232 2020  /const int nb2  
-0005e930: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
-0005e940: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-0005e950: 3320 203d 2064 7374 2d3e 6e62 5b33 5d3b  3  = dst->nb[3];
-0005e960: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005e970: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-0005e980: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-0005e990: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-0005e9a0: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
-0005e9b0: 6e74 206e 6b20 3d20 6e65 3030 3b0a 2020  nt nk = ne00;.  
-0005e9c0: 2020 636f 6e73 7420 696e 7420 6e68 203d    const int nh =
-0005e9d0: 206e 6b2f 323b 0a0a 2020 2020 636f 6e73   nk/2;..    cons
-0005e9e0: 7420 696e 7420 6577 3020 3d20 6767 6d6c  t int ew0 = ggml
-0005e9f0: 5f75 7033 3228 6e65 3031 293b 0a0a 2020  _up32(ne01);..  
-0005ea00: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-0005ea10: 3030 2025 2032 203d 3d20 3129 3b20 2f2f  00 % 2 == 1); //
-0005ea20: 2054 4f44 4f3a 2073 7570 706f 7274 2065   TODO: support e
-0005ea30: 7665 6e20 6b65 726e 656c 2073 697a 6573  ven kernel sizes
-0005ea40: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0005ea50: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
-0005ea60: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
-0005ea70: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
-0005ea80: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0005ea90: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0005eaa0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005eab0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-0005eac0: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
-0005ead0: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
-0005eae0: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
-0005eaf0: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
-0005eb00: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
-0005eb10: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
-0005eb20: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
-0005eb30: 2f2f 2070 7265 7061 7265 206b 6572 6e65  // prepare kerne
-0005eb40: 6c20 6461 7461 2028 7372 6330 290a 2020  l data (src0).  
-0005eb50: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0005eb60: 2020 2020 666c 6f61 7420 2a20 636f 6e73      float * cons
-0005eb70: 7420 7764 6174 6120 3d20 2866 6c6f 6174  t wdata = (float
-0005eb80: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
-0005eb90: 6120 2b20 303b 0a0a 2020 2020 2020 2020  a + 0;..        
-0005eba0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005ebb0: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
-0005ebc0: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
-0005ebd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005ebe0: 6f72 2028 696e 7436 345f 7420 6930 3120  or (int64_t i01 
-0005ebf0: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
-0005ec00: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
-0005ec10: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005ec20: 6e73 7420 666c 6f61 7420 2a20 636f 6e73  nst float * cons
-0005ec30: 7420 7372 6320 3d20 2866 6c6f 6174 202a  t src = (float *
-0005ec40: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
-0005ec50: 3e64 6174 6120 2b20 6930 322a 6e62 3032  >data + i02*nb02
-0005ec60: 202b 2069 3031 2a6e 6230 3129 3b0a 2020   + i01*nb01);.  
-0005ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ec80: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
-0005ec90: 7461 203d 2077 6461 7461 202b 2069 3032  ta = wdata + i02
-0005eca0: 2a65 7730 2a6e 6530 303b 0a20 2020 2020  *ew0*ne00;.     
-0005ecb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005ecc0: 6f72 2028 696e 7436 345f 7420 6930 3020  or (int64_t i00 
-0005ecd0: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
-0005ece0: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
+0005e330: 2020 2020 2020 2020 2867 676d 6c5f 6670          (ggml_fp
+0005e340: 3136 5f74 202a 2920 7061 7261 6d73 2d3e  16_t *) params->
+0005e350: 7764 6174 6120 2b20 2020 6931 2a65 7730  wdata +   i1*ew0
+0005e360: 2a6e 6530 3020 2b20 2020 2020 2028 6e68  *ne00 +      (nh
+0005e370: 202b 206b 292a 6577 302c 0a20 2020 2020   + k)*ew0,.     
+0005e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e390: 2020 2028 6767 6d6c 5f66 7031 365f 7420     (ggml_fp16_t 
+0005e3a0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
+0005e3b0: 202b 206e 6530 322a 6577 302a 6e65 3030   + ne02*ew0*ne00
+0005e3c0: 202b 2028 6930 202b 206e 6820 2b20 6b29   + (i0 + nh + k)
+0005e3d0: 2a65 7730 293b 0a0a 2020 2020 2020 2020  *ew0);..        
+0005e3e0: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
+0005e3f0: 5b69 302f 325d 202b 3d20 763b 0a20 2020  [i0/2] += v;.   
+0005e400: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0005e410: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+0005e420: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0005e430: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+0005e440: 6f6e 765f 3164 5f73 325f 7068 5f66 3332  onv_1d_s2_ph_f32
+0005e450: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0005e460: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0005e470: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0005e480: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0005e490: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0005e4a0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0005e4b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005e4c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005e4d0: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+0005e4e0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0005e4f0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0005e500: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0005e510: 2873 7263 302d 3e74 7970 6520 3d3d 2047  (src0->type == G
+0005e520: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
+0005e530: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+0005e540: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+0005e550: 4c5f 5459 5045 5f46 3332 293b 0a20 2020  L_TYPE_F32);.   
+0005e560: 2047 474d 4c5f 4153 5345 5254 2820 6473   GGML_ASSERT( ds
+0005e570: 742d 3e74 7970 6520 3d3d 2047 474d 4c5f  t->type == GGML_
+0005e580: 5459 5045 5f46 3332 293b 0a0a 2020 2020  TYPE_F32);..    
+0005e590: 696e 7436 345f 7420 7430 203d 2067 676d  int64_t t0 = ggm
+0005e5a0: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
+0005e5b0: 3b0a 2020 2020 554e 5553 4544 2874 3029  ;.    UNUSED(t0)
+0005e5c0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0005e5d0: 3634 5f74 206e 6530 3020 3d20 7372 6330  64_t ne00 = src0
+0005e5e0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+0005e5f0: 7374 2069 6e74 3634 5f74 206e 6530 3120  st int64_t ne01 
+0005e600: 3d20 7372 6330 2d3e 6e65 5b31 5d3b 0a20  = src0->ne[1];. 
+0005e610: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+0005e620: 206e 6530 3220 3d20 7372 6330 2d3e 6e65   ne02 = src0->ne
+0005e630: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+0005e640: 2069 6e74 3634 5f74 206e 6530 3320 3d20   int64_t ne03 = 
+0005e650: 7372 6330 2d3e 6e65 5b33 5d3b 0a0a 2020  src0->ne[3];..  
+0005e660: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0005e670: 6e65 3130 203d 2073 7263 312d 3e6e 655b  ne10 = src1->ne[
+0005e680: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0005e690: 7436 345f 7420 6e65 3131 203d 2073 7263  t64_t ne11 = src
+0005e6a0: 312d 3e6e 655b 315d 3b0a 2020 2020 2f2f  1->ne[1];.    //
+0005e6b0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0005e6c0: 3132 203d 2073 7263 312d 3e6e 655b 325d  12 = src1->ne[2]
+0005e6d0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+0005e6e0: 7436 345f 7420 6e65 3133 203d 2073 7263  t64_t ne13 = src
+0005e6f0: 312d 3e6e 655b 335d 3b0a 0a20 2020 202f  1->ne[3];..    /
+0005e700: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+0005e710: 6530 2020 3d20 6473 742d 3e6e 655b 305d  e0  = dst->ne[0]
+0005e720: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+0005e730: 7436 345f 7420 6e65 3120 203d 2064 7374  t64_t ne1  = dst
+0005e740: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+0005e750: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
+0005e760: 2020 3d20 6473 742d 3e6e 655b 325d 3b0a    = dst->ne[2];.
+0005e770: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
+0005e780: 345f 7420 6e65 3320 203d 2064 7374 2d3e  4_t ne3  = dst->
+0005e790: 6e65 5b33 5d3b 0a20 2020 202f 2f63 6f6e  ne[3];.    //con
+0005e7a0: 7374 2069 6e74 3634 5f74 206e 6520 2020  st int64_t ne   
+0005e7b0: 3d20 6e65 302a 6e65 312a 6e65 322a 6e65  = ne0*ne1*ne2*ne
+0005e7c0: 333b 0a0a 2020 2020 636f 6e73 7420 696e  3;..    const in
+0005e7d0: 7420 6e62 3030 203d 2073 7263 302d 3e6e  t nb00 = src0->n
+0005e7e0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+0005e7f0: 696e 7420 6e62 3031 203d 2073 7263 302d  int nb01 = src0-
+0005e800: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+0005e810: 7420 696e 7420 6e62 3032 203d 2073 7263  t int nb02 = src
+0005e820: 302d 3e6e 625b 325d 3b0a 2020 2020 2f2f  0->nb[2];.    //
+0005e830: 636f 6e73 7420 696e 7420 6e62 3033 203d  const int nb03 =
+0005e840: 2073 7263 302d 3e6e 625b 335d 3b0a 0a20   src0->nb[3];.. 
+0005e850: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+0005e860: 3020 3d20 7372 6331 2d3e 6e62 5b30 5d3b  0 = src1->nb[0];
+0005e870: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005e880: 6231 3120 3d20 7372 6331 2d3e 6e62 5b31  b11 = src1->nb[1
+0005e890: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0005e8a0: 6e74 206e 6231 3220 3d20 7372 6331 2d3e  nt nb12 = src1->
+0005e8b0: 6e62 5b32 5d3b 0a20 2020 202f 2f63 6f6e  nb[2];.    //con
+0005e8c0: 7374 2069 6e74 206e 6231 3320 3d20 7372  st int nb13 = sr
+0005e8d0: 6331 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  c1->nb[3];..    
+0005e8e0: 2f2f 636f 6e73 7420 696e 7420 6e62 3020  //const int nb0 
+0005e8f0: 203d 2064 7374 2d3e 6e62 5b30 5d3b 0a20   = dst->nb[0];. 
+0005e900: 2020 2063 6f6e 7374 2069 6e74 206e 6231     const int nb1
+0005e910: 2020 3d20 6473 742d 3e6e 625b 315d 3b0a    = dst->nb[1];.
+0005e920: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+0005e930: 6e62 3220 203d 2064 7374 2d3e 6e62 5b32  nb2  = dst->nb[2
+0005e940: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0005e950: 6e74 206e 6233 2020 3d20 6473 742d 3e6e  nt nb3  = dst->n
+0005e960: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+0005e970: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
+0005e980: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
+0005e990: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
+0005e9a0: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
+0005e9b0: 6e73 7420 696e 7420 6e6b 203d 206e 6530  nst int nk = ne0
+0005e9c0: 303b 0a20 2020 2063 6f6e 7374 2069 6e74  0;.    const int
+0005e9d0: 206e 6820 3d20 6e6b 2f32 3b0a 0a20 2020   nh = nk/2;..   
+0005e9e0: 2063 6f6e 7374 2069 6e74 2065 7730 203d   const int ew0 =
+0005e9f0: 2067 676d 6c5f 7570 3332 286e 6530 3129   ggml_up32(ne01)
+0005ea00: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+0005ea10: 5254 286e 6530 3020 2520 3220 3d3d 2031  RT(ne00 % 2 == 1
+0005ea20: 293b 202f 2f20 544f 444f 3a20 7375 7070  ); // TODO: supp
+0005ea30: 6f72 7420 6576 656e 206b 6572 6e65 6c20  ort even kernel 
+0005ea40: 7369 7a65 730a 2020 2020 4747 4d4c 5f41  sizes.    GGML_A
+0005ea50: 5353 4552 5428 6e62 3030 203d 3d20 7369  SSERT(nb00 == si
+0005ea60: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
+0005ea70: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0005ea80: 3130 203d 3d20 7369 7a65 6f66 2866 6c6f  10 == sizeof(flo
+0005ea90: 6174 2929 3b0a 0a20 2020 2069 6620 2870  at));..    if (p
+0005eaa0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005eab0: 474d 4c5f 5441 534b 5f49 4e49 5429 207b  GML_TASK_INIT) {
+0005eac0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+0005ead0: 3a20 6669 7820 7468 6973 206d 656d 7365  : fix this memse
+0005eae0: 7420 2877 7369 7a65 2069 7320 6f76 6572  t (wsize is over
+0005eaf0: 6573 7469 6d61 7465 6429 0a20 2020 2020  estimated).     
+0005eb00: 2020 206d 656d 7365 7428 7061 7261 6d73     memset(params
+0005eb10: 2d3e 7764 6174 612c 2030 2c20 7061 7261  ->wdata, 0, para
+0005eb20: 6d73 2d3e 7773 697a 6529 3b0a 0a20 2020  ms->wsize);..   
+0005eb30: 2020 2020 202f 2f20 7072 6570 6172 6520       // prepare 
+0005eb40: 6b65 726e 656c 2064 6174 6120 2873 7263  kernel data (src
+0005eb50: 3029 0a20 2020 2020 2020 207b 0a20 2020  0).        {.   
+0005eb60: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+0005eb70: 2063 6f6e 7374 2077 6461 7461 203d 2028   const wdata = (
+0005eb80: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
+0005eb90: 3e77 6461 7461 202b 2030 3b0a 0a20 2020  >wdata + 0;..   
+0005eba0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0005ebb0: 7436 345f 7420 6930 3220 3d20 303b 2069  t64_t i02 = 0; i
+0005ebc0: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
+0005ebd0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0005ebe0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0005ebf0: 2069 3031 203d 2030 3b20 6930 3120 3c20   i01 = 0; i01 < 
+0005ec00: 6e65 3031 3b20 6930 312b 2b29 207b 0a20  ne01; i01++) {. 
+0005ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ec20: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
+0005ec30: 2063 6f6e 7374 2073 7263 203d 2028 666c   const src = (fl
+0005ec40: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+0005ec50: 7372 6330 2d3e 6461 7461 202b 2069 3032  src0->data + i02
+0005ec60: 2a6e 6230 3220 2b20 6930 312a 6e62 3031  *nb02 + i01*nb01
+0005ec70: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0005ec80: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
+0005ec90: 7374 5f64 6174 6120 3d20 7764 6174 6120  st_data = wdata 
+0005eca0: 2b20 6930 322a 6577 302a 6e65 3030 3b0a  + i02*ew0*ne00;.
+0005ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ecc0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0005ecd0: 2069 3030 203d 2030 3b20 6930 3020 3c20   i00 = 0; i00 < 
+0005ece0: 6e65 3030 3b20 6930 302b 2b29 207b 0a20  ne00; i00++) {. 
 0005ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ed00: 2020 6473 745f 6461 7461 5b69 3030 2a65    dst_data[i00*e
-0005ed10: 7730 202b 2069 3031 5d20 3d20 7372 635b  w0 + i01] = src[
-0005ed20: 6930 305d 3b0a 2020 2020 2020 2020 2020  i00];.          
-0005ed30: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0005ed40: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005ed50: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0005ed60: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-0005ed70: 2f20 7072 6570 6172 6520 736f 7572 6365  / prepare source
-0005ed80: 2064 6174 6120 2873 7263 3129 0a20 2020   data (src1).   
-0005ed90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0005eda0: 2020 2066 6c6f 6174 202a 2063 6f6e 7374     float * const
-0005edb0: 2077 6461 7461 203d 2028 666c 6f61 7420   wdata = (float 
-0005edc0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
-0005edd0: 202b 206e 6530 322a 6577 302a 6e65 3030   + ne02*ew0*ne00
-0005ede0: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
-0005edf0: 6f72 2028 696e 7436 345f 7420 6931 3120  or (int64_t i11 
-0005ee00: 3d20 303b 2069 3131 203c 206e 6531 313b  = 0; i11 < ne11;
-0005ee10: 2069 3131 2b2b 2920 7b0a 2020 2020 2020   i11++) {.      
-0005ee20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005ee30: 666c 6f61 7420 2a20 636f 6e73 7420 7372  float * const sr
-0005ee40: 6320 3d20 2866 6c6f 6174 202a 2928 2863  c = (float *)((c
-0005ee50: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
-0005ee60: 6120 2b20 6931 312a 6e62 3131 293b 0a20  a + i11*nb11);. 
-0005ee70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005ee80: 6c6f 6174 202a 2064 7374 5f64 6174 6120  loat * dst_data 
-0005ee90: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
-0005eea0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0005eeb0: 7436 345f 7420 6931 3020 3d20 303b 2069  t64_t i10 = 0; i
-0005eec0: 3130 203c 206e 6531 303b 2069 3130 2b2b  10 < ne10; i10++
-0005eed0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005eee0: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-0005eef0: 5b28 6931 3020 2b20 6e68 292a 6577 3020  [(i10 + nh)*ew0 
-0005ef00: 2b20 6931 315d 203d 2073 7263 5b69 3130  + i11] = src[i10
-0005ef10: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0005ef20: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0005ef30: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-0005ef40: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0005ef50: 2020 7d0a 0a20 2020 2069 6620 2870 6172    }..    if (par
-0005ef60: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0005ef70: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
-0005ef80: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-0005ef90: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
-0005efa0: 2074 6f74 616c 2072 6f77 7320 696e 2064   total rows in d
-0005efb0: 7374 0a20 2020 2063 6f6e 7374 2069 6e74  st.    const int
-0005efc0: 206e 7220 3d20 6e65 3032 3b0a 0a20 2020   nr = ne02;..   
-0005efd0: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
-0005efe0: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-0005eff0: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
-0005f000: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
-0005f010: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
-0005f020: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
-0005f030: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
-0005f040: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
-0005f050: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
-0005f060: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
-0005f070: 0a20 2020 2066 6f72 2028 696e 7420 6931  .    for (int i1
-0005f080: 203d 2069 7230 3b20 6931 203c 2069 7231   = ir0; i1 < ir1
-0005f090: 3b20 6931 2b2b 2920 7b0a 2020 2020 2020  ; i1++) {.      
-0005f0a0: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
-0005f0b0: 7461 203d 2028 666c 6f61 7420 2a29 2828  ta = (float *)((
-0005f0c0: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
-0005f0d0: 6120 2b20 6931 2a6e 6231 293b 0a20 2020  a + i1*nb1);.   
-0005f0e0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0005f0f0: 7420 6930 203d 2030 3b20 6930 203c 206e  t i0 = 0; i0 < n
-0005f100: 6531 303b 2069 3020 2b3d 2032 2920 7b0a  e10; i0 += 2) {.
-0005f110: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005f120: 6461 7461 5b69 302f 325d 203d 2030 3b0a  data[i0/2] = 0;.
-0005f130: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0005f140: 2869 6e74 206b 203d 202d 6e68 3b20 6b20  (int k = -nh; k 
-0005f150: 3c3d 206e 683b 206b 2b2b 2920 7b0a 2020  <= nh; k++) {.  
-0005f160: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-0005f170: 6f61 7420 7620 3d20 302e 3066 3b0a 2020  oat v = 0.0f;.  
-0005f180: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0005f190: 6d6c 5f76 6563 5f64 6f74 5f66 3332 2865  ml_vec_dot_f32(e
-0005f1a0: 7730 2c20 2676 2c0a 2020 2020 2020 2020  w0, &v,.        
+0005ed00: 2020 2020 2020 2064 7374 5f64 6174 615b         dst_data[
+0005ed10: 6930 302a 6577 3020 2b20 6930 315d 203d  i00*ew0 + i01] =
+0005ed20: 2073 7263 5b69 3030 5d3b 0a20 2020 2020   src[i00];.     
+0005ed30: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005ed40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005ed50: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0005ed60: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0005ed70: 2020 2020 2f2f 2070 7265 7061 7265 2073      // prepare s
+0005ed80: 6f75 7263 6520 6461 7461 2028 7372 6331  ource data (src1
+0005ed90: 290a 2020 2020 2020 2020 7b0a 2020 2020  ).        {.    
+0005eda0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0005edb0: 636f 6e73 7420 7764 6174 6120 3d20 2866  const wdata = (f
+0005edc0: 6c6f 6174 202a 2920 7061 7261 6d73 2d3e  loat *) params->
+0005edd0: 7764 6174 6120 2b20 6e65 3032 2a65 7730  wdata + ne02*ew0
+0005ede0: 2a6e 6530 303b 0a0a 2020 2020 2020 2020  *ne00;..        
+0005edf0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0005ee00: 2069 3131 203d 2030 3b20 6931 3120 3c20   i11 = 0; i11 < 
+0005ee10: 6e65 3131 3b20 6931 312b 2b29 207b 0a20  ne11; i11++) {. 
+0005ee20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0005ee30: 6f6e 7374 2066 6c6f 6174 202a 2063 6f6e  onst float * con
+0005ee40: 7374 2073 7263 203d 2028 666c 6f61 7420  st src = (float 
+0005ee50: 2a29 2828 6368 6172 202a 2920 7372 6331  *)((char *) src1
+0005ee60: 2d3e 6461 7461 202b 2069 3131 2a6e 6231  ->data + i11*nb1
+0005ee70: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+0005ee80: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
+0005ee90: 6461 7461 203d 2077 6461 7461 3b0a 2020  data = wdata;.  
+0005eea0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0005eeb0: 7220 2869 6e74 3634 5f74 2069 3130 203d  r (int64_t i10 =
+0005eec0: 2030 3b20 6931 3020 3c20 6e65 3130 3b20   0; i10 < ne10; 
+0005eed0: 6931 302b 2b29 207b 0a20 2020 2020 2020  i10++) {.       
+0005eee0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+0005eef0: 5f64 6174 615b 2869 3130 202b 206e 6829  _data[(i10 + nh)
+0005ef00: 2a65 7730 202b 2069 3131 5d20 3d20 7372  *ew0 + i11] = sr
+0005ef10: 635b 6931 305d 3b0a 2020 2020 2020 2020  c[i10];.        
+0005ef20: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0005ef30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0005ef40: 7d0a 0a20 2020 2020 2020 2072 6574 7572  }..        retur
+0005ef50: 6e3b 0a20 2020 207d 0a0a 2020 2020 6966  n;.    }..    if
+0005ef60: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+0005ef70: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+0005ef80: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+0005ef90: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+0005efa0: 2020 202f 2f20 746f 7461 6c20 726f 7773     // total rows
+0005efb0: 2069 6e20 6473 740a 2020 2020 636f 6e73   in dst.    cons
+0005efc0: 7420 696e 7420 6e72 203d 206e 6530 323b  t int nr = ne02;
+0005efd0: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
+0005efe0: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
+0005eff0: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
+0005f000: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
+0005f010: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
+0005f020: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
+0005f030: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
+0005f040: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
+0005f050: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
+0005f060: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
+0005f070: 6e72 293b 0a0a 2020 2020 666f 7220 2869  nr);..    for (i
+0005f080: 6e74 2069 3120 3d20 6972 303b 2069 3120  nt i1 = ir0; i1 
+0005f090: 3c20 6972 313b 2069 312b 2b29 207b 0a20  < ir1; i1++) {. 
+0005f0a0: 2020 2020 2020 2066 6c6f 6174 202a 2064         float * d
+0005f0b0: 7374 5f64 6174 6120 3d20 2866 6c6f 6174  st_data = (float
+0005f0c0: 202a 2928 2863 6861 7220 2a29 2064 7374   *)((char *) dst
+0005f0d0: 2d3e 6461 7461 202b 2069 312a 6e62 3129  ->data + i1*nb1)
+0005f0e0: 3b0a 2020 2020 2020 2020 666f 7220 2869  ;.        for (i
+0005f0f0: 6e74 3634 5f74 2069 3020 3d20 303b 2069  nt64_t i0 = 0; i
+0005f100: 3020 3c20 6e65 3130 3b20 6930 202b 3d20  0 < ne10; i0 += 
+0005f110: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
+0005f120: 2064 7374 5f64 6174 615b 6930 2f32 5d20   dst_data[i0/2] 
+0005f130: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+0005f140: 2066 6f72 2028 696e 7420 6b20 3d20 2d6e   for (int k = -n
+0005f150: 683b 206b 203c 3d20 6e68 3b20 6b2b 2b29  h; k <= nh; k++)
+0005f160: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0005f170: 2020 2066 6c6f 6174 2076 203d 2030 2e30     float v = 0.0
+0005f180: 663b 0a20 2020 2020 2020 2020 2020 2020  f;.             
+0005f190: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
+0005f1a0: 6633 3228 6577 302c 2026 762c 0a20 2020  f32(ew0, &v,.   
 0005f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f1c0: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
-0005f1d0: 2d3e 7764 6174 6120 2b20 2020 6931 2a65  ->wdata +   i1*e
-0005f1e0: 7730 2a6e 6530 3020 2b20 2020 2020 2028  w0*ne00 +      (
-0005f1f0: 6e68 202b 206b 292a 6577 302c 0a20 2020  nh + k)*ew0,.   
-0005f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f210: 2020 2020 2028 666c 6f61 7420 2a29 2070       (float *) p
-0005f220: 6172 616d 732d 3e77 6461 7461 202b 206e  arams->wdata + n
-0005f230: 6530 322a 6577 302a 6e65 3030 202b 2028  e02*ew0*ne00 + (
-0005f240: 6930 202b 206e 6820 2b20 6b29 2a65 7730  i0 + nh + k)*ew0
-0005f250: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0005f260: 2020 2020 6473 745f 6461 7461 5b69 302f      dst_data[i0/
-0005f270: 325d 202b 3d20 763b 0a20 2020 2020 2020  2] += v;.       
-0005f280: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0005f290: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-0005f2a0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-0005f2b0: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
-0005f2c0: 3164 5f73 325f 7068 280a 2020 2020 2020  1d_s2_ph(.      
-0005f2d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005f2e0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0005f2f0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0005f300: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005f310: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005f320: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0005f330: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005f340: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0005f350: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0005f360: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0005f370: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-0005f380: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-0005f390: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005f3a0: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
-0005f3b0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0005f3c0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-0005f3d0: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
-0005f3e0: 5f31 645f 7332 5f70 685f 6631 365f 6633  _1d_s2_ph_f16_f3
-0005f3f0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
-0005f400: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-0005f410: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0005f420: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0005f430: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-0005f440: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0005f450: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0005f460: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005f470: 636f 6e76 5f31 645f 7332 5f70 685f 6633  conv_1d_s2_ph_f3
-0005f480: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
-0005f490: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
-0005f4a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0005f4b0: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
-0005f4c0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0005f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f4e0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0005f4f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0005f500: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
-0005f510: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-0005f520: 655f 666f 7277 6172 645f 636f 6e76 5f32  e_forward_conv_2
-0005f530: 645f 736b 5f70 300a 0a73 7461 7469 6320  d_sk_p0..static 
-0005f540: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0005f550: 655f 666f 7277 6172 645f 636f 6e76 5f32  e_forward_conv_2
-0005f560: 645f 736b 5f70 305f 6631 365f 6633 3228  d_sk_p0_f16_f32(
-0005f570: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005f580: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0005f590: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0005f5a0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0005f5b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0005f5c0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0005f5d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005f5e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005f5f0: 7372 6331 2c0a 2020 2020 2020 2020 2020  src1,.          
-0005f600: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0005f610: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-0005f620: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0005f630: 7372 6330 2d3e 7479 7065 203d 3d20 4747  src0->type == GG
-0005f640: 4d4c 5f54 5950 455f 4631 3629 3b0a 2020  ML_TYPE_F16);.  
-0005f650: 2020 4747 4d4c 5f41 5353 4552 5428 7372    GGML_ASSERT(sr
-0005f660: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-0005f670: 5f54 5950 455f 4633 3229 3b0a 2020 2020  _TYPE_F32);.    
-0005f680: 4747 4d4c 5f41 5353 4552 5428 2064 7374  GGML_ASSERT( dst
-0005f690: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005f6a0: 5950 455f 4633 3229 3b0a 0a20 2020 2069  YPE_F32);..    i
-0005f6b0: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
-0005f6c0: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
-0005f6d0: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
-0005f6e0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005f6f0: 6e65 3030 203d 2073 7263 302d 3e6e 655b  ne00 = src0->ne[
-0005f700: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0005f710: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
-0005f720: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-0005f730: 696e 7420 6e65 3032 203d 2073 7263 302d  int ne02 = src0-
-0005f740: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
-0005f750: 6e73 7420 696e 7420 6e65 3033 203d 2073  nst int ne03 = s
-0005f760: 7263 302d 3e6e 655b 335d 3b0a 0a20 2020  rc0->ne[3];..   
-0005f770: 2063 6f6e 7374 2069 6e74 206e 6531 3020   const int ne10 
-0005f780: 3d20 7372 6331 2d3e 6e65 5b30 5d3b 0a20  = src1->ne[0];. 
-0005f790: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0005f7a0: 6531 3120 3d20 7372 6331 2d3e 6e65 5b31  e11 = src1->ne[1
-0005f7b0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0005f7c0: 206e 6531 3220 3d20 7372 6331 2d3e 6e65   ne12 = src1->ne
-0005f7d0: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
-0005f7e0: 2069 6e74 206e 6531 3320 3d20 7372 6331   int ne13 = src1
-0005f7f0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-0005f800: 6e73 7420 696e 7420 6e65 3020 203d 2064  nst int ne0  = d
-0005f810: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
-0005f820: 6f6e 7374 2069 6e74 206e 6531 2020 3d20  onst int ne1  = 
-0005f830: 6473 742d 3e6e 655b 315d 3b0a 2020 2020  dst->ne[1];.    
-0005f840: 636f 6e73 7420 696e 7420 6e65 3220 203d  const int ne2  =
-0005f850: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
-0005f860: 202f 2f63 6f6e 7374 2069 6e74 206e 6533   //const int ne3
-0005f870: 2020 3d20 6473 742d 3e6e 655b 335d 3b0a    = dst->ne[3];.
-0005f880: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-0005f890: 6e65 2020 203d 206e 6530 2a6e 6531 2a6e  ne   = ne0*ne1*n
-0005f8a0: 6532 2a6e 6533 3b0a 0a20 2020 2063 6f6e  e2*ne3;..    con
-0005f8b0: 7374 2069 6e74 206e 6230 3020 3d20 7372  st int nb00 = sr
-0005f8c0: 6330 2d3e 6e62 5b30 5d3b 0a20 2020 202f  c0->nb[0];.    /
-0005f8d0: 2f63 6f6e 7374 2069 6e74 206e 6230 3120  /const int nb01 
-0005f8e0: 3d20 7372 6330 2d3e 6e62 5b31 5d3b 0a20  = src0->nb[1];. 
-0005f8f0: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0005f900: 6230 3220 3d20 7372 6330 2d3e 6e62 5b32  b02 = src0->nb[2
-0005f910: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0005f920: 206e 6230 3320 3d20 7372 6330 2d3e 6e62   nb03 = src0->nb
-0005f930: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
-0005f940: 696e 7420 6e62 3130 203d 2073 7263 312d  int nb10 = src1-
-0005f950: 3e6e 625b 305d 3b0a 2020 2020 2f2f 636f  >nb[0];.    //co
-0005f960: 6e73 7420 696e 7420 6e62 3131 203d 2073  nst int nb11 = s
-0005f970: 7263 312d 3e6e 625b 315d 3b0a 2020 2020  rc1->nb[1];.    
-0005f980: 636f 6e73 7420 696e 7420 6e62 3132 203d  const int nb12 =
-0005f990: 2073 7263 312d 3e6e 625b 325d 3b0a 2020   src1->nb[2];.  
-0005f9a0: 2020 2f2f 636f 6e73 7420 696e 7420 6e62    //const int nb
-0005f9b0: 3133 203d 2073 7263 312d 3e6e 625b 335d  13 = src1->nb[3]
-0005f9c0: 3b0a 0a20 2020 202f 2f63 6f6e 7374 2069  ;..    //const i
-0005f9d0: 6e74 206e 6230 2020 3d20 6473 742d 3e6e  nt nb0  = dst->n
-0005f9e0: 625b 305d 3b0a 2020 2020 2f2f 636f 6e73  b[0];.    //cons
-0005f9f0: 7420 696e 7420 6e62 3120 203d 2064 7374  t int nb1  = dst
-0005fa00: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-0005fa10: 7374 2069 6e74 206e 6232 2020 3d20 6473  st int nb2  = ds
-0005fa20: 742d 3e6e 625b 325d 3b0a 2020 2020 2f2f  t->nb[2];.    //
-0005fa30: 636f 6e73 7420 696e 7420 6e62 3320 203d  const int nb3  =
-0005fa40: 2064 7374 2d3e 6e62 5b33 5d3b 0a0a 2020   dst->nb[3];..  
-0005fa50: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-0005fa60: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-0005fa70: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-0005fa80: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-0005fa90: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005faa0: 6b30 203d 206e 6530 303b 0a20 2020 2063  k0 = ne00;.    c
-0005fab0: 6f6e 7374 2069 6e74 206e 6b31 203d 206e  onst int nk1 = n
-0005fac0: 6530 313b 0a0a 2020 2020 2f2f 2073 697a  e01;..    // siz
-0005fad0: 6520 6f66 2074 6865 2063 6f6e 766f 6c75  e of the convolu
-0005fae0: 7469 6f6e 2072 6f77 202d 2074 6865 206b  tion row - the k
-0005faf0: 6572 6e65 6c20 7369 7a65 2075 6e72 6f6c  ernel size unrol
-0005fb00: 6c65 6420 6163 726f 7373 2061 6c6c 2063  led across all c
-0005fb10: 6861 6e6e 656c 730a 2020 2020 2f2f 2072  hannels.    // r
-0005fb20: 6f75 6e64 2d75 7020 736f 2069 7420 6973  ound-up so it is
-0005fb30: 206d 6f72 6520 7375 6974 6162 6c65 2066   more suitable f
-0005fb40: 6f72 2053 494d 440a 2020 2020 636f 6e73  or SIMD.    cons
-0005fb50: 7420 696e 7420 6577 3020 3d20 6767 6d6c  t int ew0 = ggml
-0005fb60: 5f75 7033 3228 6e6b 302a 6e6b 312a 6e65  _up32(nk0*nk1*ne
-0005fb70: 3032 293b 0a0a 2020 2020 4747 4d4c 5f41  02);..    GGML_A
-0005fb80: 5353 4552 5428 6e62 3030 203d 3d20 7369  SSERT(nb00 == si
-0005fb90: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
-0005fba0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-0005fbb0: 4552 5428 6e62 3130 203d 3d20 7369 7a65  ERT(nb10 == size
-0005fbc0: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-0005fbd0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-0005fbe0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-0005fbf0: 4e49 5429 207b 0a20 2020 2020 2020 202f  NIT) {.        /
-0005fc00: 2f20 544f 444f 3a20 6669 7820 7468 6973  / TODO: fix this
-0005fc10: 206d 656d 7365 7420 2877 7369 7a65 2069   memset (wsize i
-0005fc20: 7320 6f76 6572 6573 7469 6d61 7465 6429  s overestimated)
-0005fc30: 0a20 2020 2020 2020 206d 656d 7365 7428  .        memset(
-0005fc40: 7061 7261 6d73 2d3e 7764 6174 612c 2030  params->wdata, 0
-0005fc50: 2c20 7061 7261 6d73 2d3e 7773 697a 6529  , params->wsize)
-0005fc60: 3b0a 0a20 2020 2020 2020 202f 2f20 7072  ;..        // pr
-0005fc70: 6570 6172 6520 736f 7572 6365 2064 6174  epare source dat
-0005fc80: 6120 2873 7263 3129 0a20 2020 2020 2020  a (src1).       
-0005fc90: 207b 0a20 2020 2020 2020 2020 2020 2067   {.            g
-0005fca0: 676d 6c5f 6670 3136 5f74 202a 2063 6f6e  gml_fp16_t * con
-0005fcb0: 7374 2077 6461 7461 203d 2028 6767 6d6c  st wdata = (ggml
-0005fcc0: 5f66 7031 365f 7420 2a29 2070 6172 616d  _fp16_t *) param
-0005fcd0: 732d 3e77 6461 7461 202b 2030 3b0a 0a20  s->wdata + 0;.. 
-0005fce0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0005fcf0: 696e 7420 6931 3220 3d20 303b 2069 3132  int i12 = 0; i12
-0005fd00: 203c 206e 6531 323b 2069 3132 2b2b 2920   < ne12; i12++) 
-0005fd10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0005fd20: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
-0005fd30: 636f 6e73 7420 7372 6320 3d20 2866 6c6f  const src = (flo
-0005fd40: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
-0005fd50: 7263 312d 3e64 6174 6120 2b20 6931 322a  rc1->data + i12*
-0005fd60: 6e62 3132 293b 0a20 2020 2020 2020 2020  nb12);.         
-0005fd70: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-0005fd80: 5f74 202a 2064 7374 5f64 6174 6120 3d20  _t * dst_data = 
-0005fd90: 7764 6174 613b 0a0a 2020 2020 2020 2020  wdata;..        
-0005fda0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005fdb0: 2069 3120 3d20 303b 2069 3120 3c20 6e65   i1 = 0; i1 < ne
-0005fdc0: 313b 2069 312b 2b29 207b 0a20 2020 2020  1; i1++) {.     
-0005fdd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005fde0: 6f72 2028 696e 7420 6930 203d 2030 3b20  or (int i0 = 0; 
-0005fdf0: 6930 203c 206e 6530 3b20 6930 2b2b 2920  i0 < ne0; i0++) 
-0005fe00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0005fe10: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0005fe20: 6e74 2069 6b31 203d 2030 3b20 696b 3120  nt ik1 = 0; ik1 
-0005fe30: 3c20 6e6b 313b 2069 6b31 2b2b 2920 7b0a  < nk1; ik1++) {.
-0005fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fe50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0005fe60: 2869 6e74 2069 6b30 203d 2030 3b20 696b  (int ik0 = 0; ik
-0005fe70: 3020 3c20 6e6b 303b 2069 6b30 2b2b 2920  0 < nk0; ik0++) 
-0005fe80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005f1c0: 2020 2020 2028 666c 6f61 7420 2a29 2070       (float *) p
+0005f1d0: 6172 616d 732d 3e77 6461 7461 202b 2020  arams->wdata +  
+0005f1e0: 2069 312a 6577 302a 6e65 3030 202b 2020   i1*ew0*ne00 +  
+0005f1f0: 2020 2020 286e 6820 2b20 6b29 2a65 7730      (nh + k)*ew0
+0005f200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0005f210: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0005f220: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+0005f230: 6120 2b20 6e65 3032 2a65 7730 2a6e 6530  a + ne02*ew0*ne0
+0005f240: 3020 2b20 2869 3020 2b20 6e68 202b 206b  0 + (i0 + nh + k
+0005f250: 292a 6577 3029 3b0a 0a20 2020 2020 2020  )*ew0);..       
+0005f260: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+0005f270: 615b 6930 2f32 5d20 2b3d 2076 3b0a 2020  a[i0/2] += v;.  
+0005f280: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0005f290: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+0005f2a0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+0005f2b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0005f2c0: 636f 6e76 5f31 645f 7332 5f70 6828 0a20  conv_1d_s2_ph(. 
+0005f2d0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005f2e0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+0005f2f0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+0005f300: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005f310: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005f320: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+0005f330: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005f340: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0005f350: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+0005f360: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005f370: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
+0005f380: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
+0005f390: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
+0005f3a0: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
+0005f3b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0005f3c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0005f3d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0005f3e0: 5f63 6f6e 765f 3164 5f73 325f 7068 5f66  _conv_1d_s2_ph_f
+0005f3f0: 3136 5f66 3332 2870 6172 616d 732c 2073  16_f32(params, s
+0005f400: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+0005f410: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0005f420: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0005f430: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
+0005f440: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0005f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f460: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0005f470: 7761 7264 5f63 6f6e 765f 3164 5f73 325f  ward_conv_1d_s2_
+0005f480: 7068 5f66 3332 2870 6172 616d 732c 2073  ph_f32(params, s
+0005f490: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+0005f4a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0005f4b0: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
+0005f4c0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+0005f4d0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0005f4e0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0005f4f0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+0005f500: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0005f510: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+0005f520: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+0005f530: 6f6e 765f 3264 5f73 6b5f 7030 0a0a 7374  onv_2d_sk_p0..st
+0005f540: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0005f550: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+0005f560: 6f6e 765f 3264 5f73 6b5f 7030 5f66 3136  onv_2d_sk_p0_f16
+0005f570: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+0005f580: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0005f590: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0005f5a0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0005f5b0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0005f5c0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+0005f5d0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005f5e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005f5f0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+0005f600: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+0005f610: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0005f620: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
+0005f630: 5345 5254 2873 7263 302d 3e74 7970 6520  SERT(src0->type 
+0005f640: 3d3d 2047 474d 4c5f 5459 5045 5f46 3136  == GGML_TYPE_F16
+0005f650: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0005f660: 5254 2873 7263 312d 3e74 7970 6520 3d3d  RT(src1->type ==
+0005f670: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
+0005f680: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0005f690: 2820 6473 742d 3e74 7970 6520 3d3d 2047  ( dst->type == G
+0005f6a0: 474d 4c5f 5459 5045 5f46 3332 293b 0a0a  GML_TYPE_F32);..
+0005f6b0: 2020 2020 696e 7436 345f 7420 7430 203d      int64_t t0 =
+0005f6c0: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
+0005f6d0: 7573 2829 3b0a 2020 2020 554e 5553 4544  us();.    UNUSED
+0005f6e0: 2874 3029 3b0a 0a20 2020 2063 6f6e 7374  (t0);..    const
+0005f6f0: 2069 6e74 206e 6530 3020 3d20 7372 6330   int ne00 = src0
+0005f700: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+0005f710: 7374 2069 6e74 206e 6530 3120 3d20 7372  st int ne01 = sr
+0005f720: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 2063  c0->ne[1];.    c
+0005f730: 6f6e 7374 2069 6e74 206e 6530 3220 3d20  onst int ne02 = 
+0005f740: 7372 6330 2d3e 6e65 5b32 5d3b 0a20 2020  src0->ne[2];.   
+0005f750: 202f 2f63 6f6e 7374 2069 6e74 206e 6530   //const int ne0
+0005f760: 3320 3d20 7372 6330 2d3e 6e65 5b33 5d3b  3 = src0->ne[3];
+0005f770: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+0005f780: 6e65 3130 203d 2073 7263 312d 3e6e 655b  ne10 = src1->ne[
+0005f790: 305d 3b0a 2020 2020 2f2f 636f 6e73 7420  0];.    //const 
+0005f7a0: 696e 7420 6e65 3131 203d 2073 7263 312d  int ne11 = src1-
+0005f7b0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+0005f7c0: 7420 696e 7420 6e65 3132 203d 2073 7263  t int ne12 = src
+0005f7d0: 312d 3e6e 655b 325d 3b0a 2020 2020 2f2f  1->ne[2];.    //
+0005f7e0: 636f 6e73 7420 696e 7420 6e65 3133 203d  const int ne13 =
+0005f7f0: 2073 7263 312d 3e6e 655b 335d 3b0a 0a20   src1->ne[3];.. 
+0005f800: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
+0005f810: 2020 3d20 6473 742d 3e6e 655b 305d 3b0a    = dst->ne[0];.
+0005f820: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0005f830: 3120 203d 2064 7374 2d3e 6e65 5b31 5d3b  1  = dst->ne[1];
+0005f840: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005f850: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
+0005f860: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+0005f870: 7420 6e65 3320 203d 2064 7374 2d3e 6e65  t ne3  = dst->ne
+0005f880: 5b33 5d3b 0a20 2020 202f 2f63 6f6e 7374  [3];.    //const
+0005f890: 2069 6e74 206e 6520 2020 3d20 6e65 302a   int ne   = ne0*
+0005f8a0: 6e65 312a 6e65 322a 6e65 333b 0a0a 2020  ne1*ne2*ne3;..  
+0005f8b0: 2020 636f 6e73 7420 696e 7420 6e62 3030    const int nb00
+0005f8c0: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
+0005f8d0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
+0005f8e0: 6e62 3031 203d 2073 7263 302d 3e6e 625b  nb01 = src0->nb[
+0005f8f0: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
+0005f900: 696e 7420 6e62 3032 203d 2073 7263 302d  int nb02 = src0-
+0005f910: 3e6e 625b 325d 3b0a 2020 2020 636f 6e73  >nb[2];.    cons
+0005f920: 7420 696e 7420 6e62 3033 203d 2073 7263  t int nb03 = src
+0005f930: 302d 3e6e 625b 335d 3b0a 0a20 2020 2063  0->nb[3];..    c
+0005f940: 6f6e 7374 2069 6e74 206e 6231 3020 3d20  onst int nb10 = 
+0005f950: 7372 6331 2d3e 6e62 5b30 5d3b 0a20 2020  src1->nb[0];.   
+0005f960: 202f 2f63 6f6e 7374 2069 6e74 206e 6231   //const int nb1
+0005f970: 3120 3d20 7372 6331 2d3e 6e62 5b31 5d3b  1 = src1->nb[1];
+0005f980: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005f990: 6231 3220 3d20 7372 6331 2d3e 6e62 5b32  b12 = src1->nb[2
+0005f9a0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+0005f9b0: 6e74 206e 6231 3320 3d20 7372 6331 2d3e  nt nb13 = src1->
+0005f9c0: 6e62 5b33 5d3b 0a0a 2020 2020 2f2f 636f  nb[3];..    //co
+0005f9d0: 6e73 7420 696e 7420 6e62 3020 203d 2064  nst int nb0  = d
+0005f9e0: 7374 2d3e 6e62 5b30 5d3b 0a20 2020 202f  st->nb[0];.    /
+0005f9f0: 2f63 6f6e 7374 2069 6e74 206e 6231 2020  /const int nb1  
+0005fa00: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
+0005fa10: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
+0005fa20: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
+0005fa30: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+0005fa40: 6233 2020 3d20 6473 742d 3e6e 625b 335d  b3  = dst->nb[3]
+0005fa50: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0005fa60: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
+0005fa70: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+0005fa80: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
+0005fa90: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
+0005faa0: 696e 7420 6e6b 3020 3d20 6e65 3030 3b0a  int nk0 = ne00;.
+0005fab0: 2020 2020 636f 6e73 7420 696e 7420 6e6b      const int nk
+0005fac0: 3120 3d20 6e65 3031 3b0a 0a20 2020 202f  1 = ne01;..    /
+0005fad0: 2f20 7369 7a65 206f 6620 7468 6520 636f  / size of the co
+0005fae0: 6e76 6f6c 7574 696f 6e20 726f 7720 2d20  nvolution row - 
+0005faf0: 7468 6520 6b65 726e 656c 2073 697a 6520  the kernel size 
+0005fb00: 756e 726f 6c6c 6564 2061 6372 6f73 7320  unrolled across 
+0005fb10: 616c 6c20 6368 616e 6e65 6c73 0a20 2020  all channels.   
+0005fb20: 202f 2f20 726f 756e 642d 7570 2073 6f20   // round-up so 
+0005fb30: 6974 2069 7320 6d6f 7265 2073 7569 7461  it is more suita
+0005fb40: 626c 6520 666f 7220 5349 4d44 0a20 2020  ble for SIMD.   
+0005fb50: 2063 6f6e 7374 2069 6e74 2065 7730 203d   const int ew0 =
+0005fb60: 2067 676d 6c5f 7570 3332 286e 6b30 2a6e   ggml_up32(nk0*n
+0005fb70: 6b31 2a6e 6530 3229 3b0a 0a20 2020 2047  k1*ne02);..    G
+0005fb80: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
+0005fb90: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+0005fba0: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
+0005fbb0: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
+0005fbc0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+0005fbd0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+0005fbe0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0005fbf0: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
+0005fc00: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
+0005fc10: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
+0005fc20: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
+0005fc30: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
+0005fc40: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
+0005fc50: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
+0005fc60: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
+0005fc70: 2f2f 2070 7265 7061 7265 2073 6f75 7263  // prepare sourc
+0005fc80: 6520 6461 7461 2028 7372 6331 290a 2020  e data (src1).  
+0005fc90: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0005fca0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+0005fcb0: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
+0005fcc0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+0005fcd0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+0005fce0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
+0005fcf0: 666f 7220 2869 6e74 2069 3132 203d 2030  for (int i12 = 0
+0005fd00: 3b20 6931 3220 3c20 6e65 3132 3b20 6931  ; i12 < ne12; i1
+0005fd10: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+0005fd20: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005fd30: 6174 202a 2063 6f6e 7374 2073 7263 203d  at * const src =
+0005fd40: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+0005fd50: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
+0005fd60: 2069 3132 2a6e 6231 3229 3b0a 2020 2020   i12*nb12);.    
+0005fd70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0005fd80: 5f66 7031 365f 7420 2a20 6473 745f 6461  _fp16_t * dst_da
+0005fd90: 7461 203d 2077 6461 7461 3b0a 0a20 2020  ta = wdata;..   
+0005fda0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0005fdb0: 2028 696e 7420 6931 203d 2030 3b20 6931   (int i1 = 0; i1
+0005fdc0: 203c 206e 6531 3b20 6931 2b2b 2920 7b0a   < ne1; i1++) {.
+0005fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fde0: 2020 2020 666f 7220 2869 6e74 2069 3020      for (int i0 
+0005fdf0: 3d20 303b 2069 3020 3c20 6e65 303b 2069  = 0; i0 < ne0; i
+0005fe00: 302b 2b29 207b 0a20 2020 2020 2020 2020  0++) {.         
+0005fe10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0005fe20: 6f72 2028 696e 7420 696b 3120 3d20 303b  or (int ik1 = 0;
+0005fe30: 2069 6b31 203c 206e 6b31 3b20 696b 312b   ik1 < nk1; ik1+
+0005fe40: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0005fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fe60: 2066 6f72 2028 696e 7420 696b 3020 3d20   for (int ik0 = 
+0005fe70: 303b 2069 6b30 203c 206e 6b30 3b20 696b  0; ik0 < nk0; ik
+0005fe80: 302b 2b29 207b 0a20 2020 2020 2020 2020  0++) {.         
 0005fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fea0: 2020 6473 745f 6461 7461 5b28 6931 2a6e    dst_data[(i1*n
-0005feb0: 6530 202b 2069 3029 2a65 7730 202b 2069  e0 + i0)*ew0 + i
-0005fec0: 3132 2a28 6e6b 302a 6e6b 3129 202b 2069  12*(nk0*nk1) + i
-0005fed0: 6b31 2a6e 6b30 202b 2069 6b30 5d20 3d0a  k1*nk0 + ik0] =.
-0005fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fea0: 2020 2020 2020 2064 7374 5f64 6174 615b         dst_data[
+0005feb0: 2869 312a 6e65 3020 2b20 6930 292a 6577  (i1*ne0 + i0)*ew
+0005fec0: 3020 2b20 6931 322a 286e 6b30 2a6e 6b31  0 + i12*(nk0*nk1
+0005fed0: 2920 2b20 696b 312a 6e6b 3020 2b20 696b  ) + ik1*nk0 + ik
+0005fee0: 305d 203d 0a20 2020 2020 2020 2020 2020  0] =.           
 0005fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ff00: 2020 2020 4747 4d4c 5f46 5033 325f 544f      GGML_FP32_TO
-0005ff10: 5f46 5031 3628 7372 635b 2869 312a 6e6b  _FP16(src[(i1*nk
-0005ff20: 3120 2b20 696b 3129 2a6e 6531 3020 2b20  1 + ik1)*ne10 + 
-0005ff30: 2869 302a 6e6b 3020 2b20 696b 3029 5d29  (i0*nk0 + ik0)])
-0005ff40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0005ff50: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0005ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ff70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0005ff80: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0005ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ffa0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-0005ffb0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0005ffc0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-0005ffd0: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-0005ffe0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005fff0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-00060000: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00060010: 2020 2020 7d0a 0a20 2020 202f 2f20 746f      }..    // to
-00060020: 7461 6c20 7061 7463 6865 7320 696e 2064  tal patches in d
-00060030: 7374 0a20 2020 2063 6f6e 7374 2069 6e74  st.    const int
-00060040: 206e 7020 3d20 6e65 323b 0a0a 2020 2020   np = ne2;..    
-00060050: 2f2f 2070 6174 6368 6573 2070 6572 2074  // patches per t
-00060060: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-00060070: 696e 7420 6470 203d 2028 6e70 202b 206e  int dp = (np + n
-00060080: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-00060090: 2020 2f2f 2070 6174 6368 2072 616e 6765    // patch range
-000600a0: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-000600b0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-000600c0: 7030 203d 2064 702a 6974 683b 0a20 2020  p0 = dp*ith;.   
-000600d0: 2063 6f6e 7374 2069 6e74 2069 7031 203d   const int ip1 =
-000600e0: 204d 494e 2869 7030 202b 2064 702c 206e   MIN(ip0 + dp, n
-000600f0: 7029 3b0a 0a20 2020 2067 676d 6c5f 6670  p);..    ggml_fp
-00060100: 3136 5f74 202a 2063 6f6e 7374 2077 6461  16_t * const wda
-00060110: 7461 203d 2028 6767 6d6c 5f66 7031 365f  ta = (ggml_fp16_
-00060120: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-00060130: 7461 202b 2030 3b0a 0a20 2020 2066 6f72  ta + 0;..    for
-00060140: 2028 696e 7420 6932 203d 2069 7030 3b20   (int i2 = ip0; 
-00060150: 6932 203c 2069 7031 3b20 6932 2b2b 2920  i2 < ip1; i2++) 
-00060160: 7b0a 2020 2020 2020 2020 666c 6f61 7420  {.        float 
-00060170: 2a20 6473 745f 6461 7461 203d 2028 666c  * dst_data = (fl
-00060180: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-00060190: 6473 742d 3e64 6174 6120 2b20 6932 2a6e  dst->data + i2*n
-000601a0: 6232 293b 0a0a 2020 2020 2020 2020 666f  b2);..        fo
-000601b0: 7220 2869 6e74 2069 3120 3d20 303b 2069  r (int i1 = 0; i
-000601c0: 3120 3c20 6e65 313b 202b 2b69 3129 207b  1 < ne1; ++i1) {
-000601d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000601e0: 2028 696e 7420 6930 203d 2030 3b20 6930   (int i0 = 0; i0
-000601f0: 203c 206e 6530 3b20 2b2b 6930 2920 7b0a   < ne0; ++i0) {.
-00060200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060210: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3136  ggml_vec_dot_f16
-00060220: 2865 7730 2c20 6473 745f 6461 7461 202b  (ew0, dst_data +
-00060230: 2069 312a 6e65 3020 2b20 6930 2c0a 2020   i1*ne0 + i0,.  
-00060240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060250: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
-00060260: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
-00060270: 7372 6330 2d3e 6461 7461 202b 2069 322a  src0->data + i2*
-00060280: 6e62 3033 292c 0a20 2020 2020 2020 2020  nb03),.         
-00060290: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000602a0: 6767 6d6c 5f66 7031 365f 7420 2a29 2020  ggml_fp16_t *)  
-000602b0: 2020 2020 2020 2020 2020 2020 2020 7764                wd
-000602c0: 6174 6120 2b20 2869 312a 6e65 3020 2b20  ata + (i1*ne0 + 
-000602d0: 6930 292a 6577 3029 3b0a 2020 2020 2020  i0)*ew0);.      
-000602e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000602f0: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
-00060300: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00060310: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
-00060320: 5f32 645f 736b 5f70 3028 0a20 2020 2020  _2d_sk_p0(.     
-00060330: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00060340: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00060350: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00060360: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00060370: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00060380: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-00060390: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000603a0: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-000603b0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000603c0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-000603d0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-000603e0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-000603f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00060400: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
-00060410: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00060420: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00060430: 7075 7465 5f66 6f72 7761 7264 5f63 6f6e  pute_forward_con
-00060440: 765f 3264 5f73 6b5f 7030 5f66 3136 5f66  v_2d_sk_p0_f16_f
-00060450: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00060460: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-00060470: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00060480: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00060490: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-000604a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000604b0: 2020 2020 2020 2020 2020 2020 2f2f 6767              //gg
-000604c0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000604d0: 7264 5f63 6f6e 765f 3264 5f73 6b5f 7030  rd_conv_2d_sk_p0
-000604e0: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-000604f0: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
-00060500: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00060510: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-00060520: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00060530: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00060540: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-00060550: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00060560: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00060570: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-00060580: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00060590: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-000605a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000605b0: 5f66 6c61 7368 5f61 7474 6e0a 0a73 7461  _flash_attn..sta
-000605c0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-000605d0: 6d70 7574 655f 666f 7277 6172 645f 666c  mpute_forward_fl
-000605e0: 6173 685f 6174 746e 5f66 3332 280a 2020  ash_attn_f32(.  
-000605f0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00060600: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00060610: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00060620: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00060630: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00060640: 7220 2a20 712c 0a20 2020 2020 2020 2063  r * q,.        c
-00060650: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00060660: 5f74 656e 736f 7220 2a20 6b2c 0a20 2020  _tensor * k,.   
-00060670: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00060680: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00060690: 762c 0a20 2020 2020 2020 2063 6f6e 7374  v,.        const
-000606a0: 2062 6f6f 6c20 6d61 736b 6564 2c0a 2020   bool masked,.  
-000606b0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-000606c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000606d0: 6473 7429 207b 0a20 2020 2069 6e74 3634  dst) {.    int64
-000606e0: 5f74 2074 3020 3d20 6767 6d6c 5f70 6572  _t t0 = ggml_per
-000606f0: 665f 7469 6d65 5f75 7328 293b 0a20 2020  f_time_us();.   
-00060700: 2055 4e55 5345 4428 7430 293b 0a0a 2020   UNUSED(t0);..  
-00060710: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00060720: 6e65 7130 203d 2071 2d3e 6e65 5b30 5d3b  neq0 = q->ne[0];
-00060730: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00060740: 5f74 206e 6571 3120 3d20 712d 3e6e 655b  _t neq1 = q->ne[
-00060750: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-00060760: 7436 345f 7420 6e65 7132 203d 2071 2d3e  t64_t neq2 = q->
-00060770: 6e65 5b32 5d3b 0a20 2020 2063 6f6e 7374  ne[2];.    const
-00060780: 2069 6e74 3634 5f74 206e 6571 3320 3d20   int64_t neq3 = 
-00060790: 712d 3e6e 655b 335d 3b0a 0a20 2020 2063  q->ne[3];..    c
-000607a0: 6f6e 7374 2069 6e74 3634 5f74 206e 656b  onst int64_t nek
-000607b0: 3020 3d20 6b2d 3e6e 655b 305d 3b0a 2020  0 = k->ne[0];.  
-000607c0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000607d0: 6e65 6b31 203d 206b 2d3e 6e65 5b31 5d3b  nek1 = k->ne[1];
-000607e0: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-000607f0: 3634 5f74 206e 656b 3220 3d20 6b2d 3e6e  64_t nek2 = k->n
-00060800: 655b 325d 3b0a 2020 2020 2f2f 636f 6e73  e[2];.    //cons
-00060810: 7420 696e 7436 345f 7420 6e65 6b33 203d  t int64_t nek3 =
-00060820: 206b 2d3e 6e65 5b33 5d3b 0a0a 2020 2020   k->ne[3];..    
-00060830: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
-00060840: 6e65 7630 203d 2076 2d3e 6e65 5b30 5d3b  nev0 = v->ne[0];
-00060850: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00060860: 5f74 206e 6576 3120 3d20 762d 3e6e 655b  _t nev1 = v->ne[
-00060870: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
-00060880: 696e 7436 345f 7420 6e65 7632 203d 2076  int64_t nev2 = v
-00060890: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
-000608a0: 6f6e 7374 2069 6e74 3634 5f74 206e 6576  onst int64_t nev
-000608b0: 3320 3d20 762d 3e6e 655b 335d 3b0a 0a20  3 = v->ne[3];.. 
-000608c0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-000608d0: 206e 6530 2020 3d20 6473 742d 3e6e 655b   ne0  = dst->ne[
-000608e0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-000608f0: 7436 345f 7420 6e65 3120 203d 2064 7374  t64_t ne1  = dst
-00060900: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
-00060910: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
-00060920: 2020 3d20 6473 742d 3e6e 655b 325d 3b0a    = dst->ne[2];.
-00060930: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
-00060940: 345f 7420 6e65 3320 203d 2064 7374 2d3e  4_t ne3  = dst->
-00060950: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-00060960: 7420 696e 7420 6e62 6b30 203d 206b 2d3e  t int nbk0 = k->
-00060970: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-00060980: 2069 6e74 206e 626b 3120 3d20 6b2d 3e6e   int nbk1 = k->n
-00060990: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
-000609a0: 696e 7420 6e62 6b32 203d 206b 2d3e 6e62  int nbk2 = k->nb
-000609b0: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
-000609c0: 6e74 206e 626b 3320 3d20 6b2d 3e6e 625b  nt nbk3 = k->nb[
-000609d0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-000609e0: 6e74 206e 6271 3020 3d20 712d 3e6e 625b  nt nbq0 = q->nb[
-000609f0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00060a00: 7420 6e62 7131 203d 2071 2d3e 6e62 5b31  t nbq1 = q->nb[1
-00060a10: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00060a20: 206e 6271 3220 3d20 712d 3e6e 625b 325d   nbq2 = q->nb[2]
-00060a30: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00060a40: 6e62 7133 203d 2071 2d3e 6e62 5b33 5d3b  nbq3 = q->nb[3];
-00060a50: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00060a60: 6e62 7630 203d 2076 2d3e 6e62 5b30 5d3b  nbv0 = v->nb[0];
-00060a70: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00060a80: 6276 3120 3d20 762d 3e6e 625b 315d 3b0a  bv1 = v->nb[1];.
-00060a90: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00060aa0: 7632 203d 2076 2d3e 6e62 5b32 5d3b 0a20  v2 = v->nb[2];. 
-00060ab0: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
-00060ac0: 3320 3d20 762d 3e6e 625b 335d 3b0a 0a20  3 = v->nb[3];.. 
-00060ad0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-00060ae0: 2020 3d20 6473 742d 3e6e 625b 305d 3b0a    = dst->nb[0];.
-00060af0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00060b00: 3120 203d 2064 7374 2d3e 6e62 5b31 5d3b  1  = dst->nb[1];
-00060b10: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00060b20: 6232 2020 3d20 6473 742d 3e6e 625b 325d  b2  = dst->nb[2]
-00060b30: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00060b40: 6e62 3320 203d 2064 7374 2d3e 6e62 5b33  nb3  = dst->nb[3
-00060b50: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-00060b60: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
-00060b70: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-00060b80: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
-00060b90: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
-00060ba0: 2069 6e74 3634 5f74 2044 203d 206e 6571   int64_t D = neq
-00060bb0: 303b 0a20 2020 2063 6f6e 7374 2069 6e74  0;.    const int
-00060bc0: 3634 5f74 204e 203d 206e 6571 313b 0a20  64_t N = neq1;. 
-00060bd0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00060be0: 2050 203d 206e 656b 3120 2d20 4e3b 0a20   P = nek1 - N;. 
-00060bf0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00060c00: 204d 203d 2050 202b 204e 3b0a 0a20 2020   M = P + N;..   
-00060c10: 2063 6f6e 7374 2069 6e74 204d 7570 203d   const int Mup =
-00060c20: 2067 676d 6c5f 7570 284d 2c20 4747 4d4c   ggml_up(M, GGML
-00060c30: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
-00060c40: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-00060c50: 4552 5428 6e65 3020 3d3d 2044 293b 0a20  ERT(ne0 == D);. 
-00060c60: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00060c70: 6531 203d 3d20 4e29 3b0a 2020 2020 4747  e1 == N);.    GG
-00060c80: 4d4c 5f41 5353 4552 5428 5020 3e3d 2030  ML_ASSERT(P >= 0
-00060c90: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-00060ca0: 4552 5428 6e62 7130 203d 3d20 7369 7a65  ERT(nbq0 == size
-00060cb0: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
-00060cc0: 4747 4d4c 5f41 5353 4552 5428 6e62 6b30  GGML_ASSERT(nbk0
-00060cd0: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-00060ce0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00060cf0: 4552 5428 6e62 7630 203d 3d20 7369 7a65  ERT(nbv0 == size
-00060d00: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
-00060d10: 2047 474d 4c5f 4153 5345 5254 286e 6571   GGML_ASSERT(neq
-00060d20: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
-00060d30: 4c5f 4153 5345 5254 286e 656b 3020 3d3d  L_ASSERT(nek0 ==
-00060d40: 2044 293b 0a20 2020 2047 474d 4c5f 4153   D);.    GGML_AS
-00060d50: 5345 5254 286e 6576 3120 3d3d 2044 293b  SERT(nev1 == D);
-00060d60: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00060d70: 5428 6e65 7131 203d 3d20 4e29 3b0a 2020  T(neq1 == N);.  
-00060d80: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-00060d90: 6b31 203d 3d20 4e20 2b20 5029 3b0a 2020  k1 == N + P);.  
-00060da0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-00060db0: 7631 203d 3d20 4429 3b0a 0a20 2020 202f  v1 == D);..    /
-00060dc0: 2f20 6473 7420 6361 6e6e 6f74 2062 6520  / dst cannot be 
-00060dd0: 7472 616e 7370 6f73 6564 206f 7220 7065  transposed or pe
-00060de0: 726d 7574 6564 0a20 2020 2047 474d 4c5f  rmuted.    GGML_
-00060df0: 4153 5345 5254 286e 6230 203d 3d20 7369  ASSERT(nb0 == si
-00060e00: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
-00060e10: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00060e20: 3020 3c3d 206e 6231 293b 0a20 2020 2047  0 <= nb1);.    G
-00060e30: 474d 4c5f 4153 5345 5254 286e 6231 203c  GML_ASSERT(nb1 <
-00060e40: 3d20 6e62 3229 3b0a 2020 2020 4747 4d4c  = nb2);.    GGML
-00060e50: 5f41 5353 4552 5428 6e62 3220 3c3d 206e  _ASSERT(nb2 <= n
-00060e60: 6233 293b 0a0a 2020 2020 6966 2028 7061  b3);..    if (pa
-00060e70: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00060e80: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
-00060e90: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-00060ea0: 2020 2020 7d0a 0a20 2020 2069 6620 2870      }..    if (p
-00060eb0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00060ec0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00060ed0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00060ee0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00060ef0: 2f2f 2070 6172 616c 6c65 6c69 7a65 2062  // parallelize b
-00060f00: 7920 7120 726f 7773 2075 7369 6e67 2067  y q rows using g
-00060f10: 676d 6c5f 7665 635f 646f 745f 6633 320a  gml_vec_dot_f32.
-00060f20: 0a20 2020 202f 2f20 746f 7461 6c20 726f  .    // total ro
-00060f30: 7773 2069 6e20 710a 2020 2020 636f 6e73  ws in q.    cons
-00060f40: 7420 696e 7420 6e72 203d 206e 6571 312a  t int nr = neq1*
-00060f50: 6e65 7132 2a6e 6571 333b 0a0a 2020 2020  neq2*neq3;..    
-00060f60: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
-00060f70: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00060f80: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-00060f90: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-00060fa0: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-00060fb0: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-00060fc0: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-00060fd0: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
-00060fe0: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
-00060ff0: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
-00061000: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00061010: 7363 616c 6520 3d20 312e 3066 2f73 7172  scale = 1.0f/sqr
-00061020: 7466 2844 293b 0a0a 2020 2020 2f2f 7072  tf(D);..    //pr
-00061030: 696e 7466 2822 503d 2564 204e 3d25 6420  intf("P=%d N=%d 
-00061040: 443d 2564 2069 7230 3d25 6420 6972 313d  D=%d ir0=%d ir1=
-00061050: 2564 2073 6361 6c65 203d 2025 665c 6e22  %d scale = %f\n"
-00061060: 2c20 502c 204e 2c20 442c 2069 7230 2c20  , P, N, D, ir0, 
-00061070: 6972 312c 2073 6361 6c65 293b 0a0a 2020  ir1, scale);..  
-00061080: 2020 666f 7220 2869 6e74 2069 7220 3d20    for (int ir = 
-00061090: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
-000610a0: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
-000610b0: 2f20 7120 696e 6469 6365 730a 2020 2020  / q indices.    
-000610c0: 2020 2020 636f 6e73 7420 696e 7420 6971      const int iq
-000610d0: 3320 3d20 6972 2f28 6e65 7132 2a6e 6571  3 = ir/(neq2*neq
-000610e0: 3129 3b0a 2020 2020 2020 2020 636f 6e73  1);.        cons
-000610f0: 7420 696e 7420 6971 3220 3d20 2869 7220  t int iq2 = (ir 
-00061100: 2d20 6971 332a 6e65 7132 2a6e 6571 3129  - iq3*neq2*neq1)
-00061110: 2f6e 6571 313b 0a20 2020 2020 2020 2063  /neq1;.        c
-00061120: 6f6e 7374 2069 6e74 2069 7131 203d 2028  onst int iq1 = (
-00061130: 6972 202d 2069 7133 2a6e 6571 322a 6e65  ir - iq3*neq2*ne
-00061140: 7131 202d 2069 7132 2a6e 6571 3129 3b0a  q1 - iq2*neq1);.
-00061150: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-00061160: 2053 203d 2028 666c 6f61 7420 2a29 2070   S = (float *) p
-00061170: 6172 616d 732d 3e77 6461 7461 202b 2069  arams->wdata + i
-00061180: 7468 2a28 4d75 7020 2b20 4341 4348 455f  th*(Mup + CACHE_
-00061190: 4c49 4e45 5f53 495a 455f 4633 3229 3b0a  LINE_SIZE_F32);.
-000611a0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-000611b0: 7420 6920 3d20 4d3b 2069 203c 204d 7570  t i = M; i < Mup
-000611c0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-000611d0: 2020 2020 2053 5b69 5d20 3d20 2d49 4e46       S[i] = -INF
-000611e0: 494e 4954 593b 0a20 2020 2020 2020 207d  INITY;.        }
-000611f0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-00061200: 6e74 3634 5f74 2069 6320 3d20 303b 2069  nt64_t ic = 0; i
-00061210: 6320 3c20 6e65 6b31 3b20 2b2b 6963 2920  c < nek1; ++ic) 
-00061220: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
-00061230: 206b 2069 6e64 6963 6573 0a20 2020 2020   k indices.     
-00061240: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00061250: 2069 6b33 203d 2069 7133 3b0a 2020 2020   ik3 = iq3;.    
-00061260: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00061270: 7420 696b 3220 3d20 6971 323b 0a20 2020  t ik2 = iq2;.   
-00061280: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00061290: 6e74 2069 6b31 203d 2069 633b 0a0a 2020  nt ik1 = ic;..  
-000612a0: 2020 2020 2020 2020 2020 2f2f 2053 2069            // S i
-000612b0: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
-000612c0: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
-000612d0: 3d20 696b 313b 0a0a 2020 2020 2020 2020  = ik1;..        
-000612e0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
-000612f0: 5f66 3332 286e 6571 302c 0a20 2020 2020  _f32(neq0,.     
-00061300: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-00061310: 202b 2069 312c 0a20 2020 2020 2020 2020   + i1,.         
-00061320: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-00061330: 7420 2a29 2028 2863 6861 7220 2a29 206b  t *) ((char *) k
-00061340: 2d3e 6461 7461 202b 2028 696b 312a 6e62  ->data + (ik1*nb
-00061350: 6b31 202b 2069 6b32 2a6e 626b 3220 2b20  k1 + ik2*nbk2 + 
-00061360: 696b 332a 6e62 6b33 2929 2c0a 2020 2020  ik3*nbk3)),.    
-00061370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061380: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00061390: 202a 2920 712d 3e64 6174 6120 2b20 2869   *) q->data + (i
-000613a0: 7131 2a6e 6271 3120 2b20 6971 322a 6e62  q1*nbq1 + iq2*nb
-000613b0: 7132 202b 2069 7133 2a6e 6271 3329 2929  q2 + iq3*nbq3)))
-000613c0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-000613d0: 2020 2020 202f 2f20 7363 616c 650a 2020       // scale.  
-000613e0: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-000613f0: 6361 6c65 5f66 3332 286e 656b 312c 2053  cale_f32(nek1, S
-00061400: 2c20 7363 616c 6529 3b0a 0a20 2020 2020  , scale);..     
-00061410: 2020 2069 6620 286d 6173 6b65 6429 207b     if (masked) {
-00061420: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00061430: 2028 696e 7436 345f 7420 6920 3d20 503b   (int64_t i = P;
-00061440: 2069 203c 204d 3b20 692b 2b29 207b 0a20   i < M; i++) {. 
-00061450: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00061460: 6620 2869 203e 2050 202b 2069 7131 2920  f (i > P + iq1) 
-00061470: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00061480: 2020 2020 2020 535b 695d 203d 202d 494e        S[i] = -IN
-00061490: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
-000614a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000614b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000614c0: 7d0a 0a20 2020 2020 2020 202f 2f20 736f  }..        // so
-000614d0: 6674 6d61 780a 2020 2020 2020 2020 7b0a  ftmax.        {.
-000614e0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-000614f0: 7420 6d61 7820 3d20 2d49 4e46 494e 4954  t max = -INFINIT
-00061500: 593b 0a20 2020 2020 2020 2020 2020 2067  Y;.            g
-00061510: 676d 6c5f 7665 635f 6d61 785f 6633 3228  gml_vec_max_f32(
-00061520: 4d2c 2026 6d61 782c 2053 293b 0a0a 2020  M, &max, S);..  
-00061530: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-00061540: 6c6f 6174 2073 756d 203d 2030 2e30 3b0a  loat sum = 0.0;.
-00061550: 2020 2020 2020 2020 2020 2020 7b0a 2369              {.#i
-00061560: 6664 6566 2047 474d 4c5f 534f 4654 5f4d  fdef GGML_SOFT_M
-00061570: 4158 5f41 4343 454c 4552 4154 450a 2020  AX_ACCELERATE.  
-00061580: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00061590: 7820 3d20 2d6d 6178 3b0a 2020 2020 2020  x = -max;.      
-000615a0: 2020 2020 2020 2020 2020 7644 5350 5f76            vDSP_v
-000615b0: 7361 6464 2853 2c20 312c 2026 6d61 782c  sadd(S, 1, &max,
-000615c0: 2053 2c20 312c 204d 7570 293b 0a20 2020   S, 1, Mup);.   
-000615d0: 2020 2020 2020 2020 2020 2020 2076 7665               vve
-000615e0: 7870 6628 532c 2053 2c20 264d 7570 293b  xpf(S, S, &Mup);
-000615f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061600: 2067 676d 6c5f 7665 635f 7375 6d5f 6633   ggml_vec_sum_f3
-00061610: 3228 4d75 702c 2026 7375 6d2c 2053 293b  2(Mup, &sum, S);
-00061620: 0a23 656c 7365 0a20 2020 2020 2020 2020  .#else.         
-00061630: 2020 2020 2020 2075 696e 7431 365f 7420         uint16_t 
-00061640: 2020 7363 7674 5b47 474d 4c5f 534f 4654    scvt[GGML_SOFT
-00061650: 5f4d 4158 5f55 4e52 4f4c 4c5d 3b0a 2020  _MAX_UNROLL];.  
-00061660: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00061670: 6d6c 5f66 6c6f 6174 2073 756d 705b 4747  ml_float sump[GG
-00061680: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-00061690: 4c4c 5d20 3d20 7b20 302e 3020 7d3b 0a0a  LL] = { 0.0 };..
-000616a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000616b0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000616c0: 6920 3c20 4d75 703b 2069 202b 3d20 4747  i < Mup; i += GG
-000616d0: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-000616e0: 4c4c 2920 7b0a 2020 2020 2020 2020 2020  LL) {.          
-000616f0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00061700: 2a20 5353 203d 2053 202b 2069 3b0a 0a20  * SS = S + i;.. 
-00061710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061720: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-00061730: 303b 206a 203c 2047 474d 4c5f 534f 4654  0; j < GGML_SOFT
-00061740: 5f4d 4158 5f55 4e52 4f4c 4c3b 202b 2b6a  _MAX_UNROLL; ++j
-00061750: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00061760: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00061770: 5353 5b6a 5d20 3d3d 202d 494e 4649 4e49  SS[j] == -INFINI
-00061780: 5459 2920 7b0a 2020 2020 2020 2020 2020  TY) {.          
+0005ff00: 2020 2020 2020 2020 2047 474d 4c5f 4650           GGML_FP
+0005ff10: 3332 5f54 4f5f 4650 3136 2873 7263 5b28  32_TO_FP16(src[(
+0005ff20: 6931 2a6e 6b31 202b 2069 6b31 292a 6e65  i1*nk1 + ik1)*ne
+0005ff30: 3130 202b 2028 6930 2a6e 6b30 202b 2069  10 + (i0*nk0 + i
+0005ff40: 6b30 295d 293b 0a20 2020 2020 2020 2020  k0)]);.         
+0005ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ff60: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0005ff70: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0005ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ff90: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0005ffa0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0005ffb0: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+0005ffc0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+0005ffd0: 2020 2020 7d0a 0a20 2020 2069 6620 2870      }..    if (p
+0005ffe0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005fff0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
+00060000: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
+00060010: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+00060020: 2f2f 2074 6f74 616c 2070 6174 6368 6573  // total patches
+00060030: 2069 6e20 6473 740a 2020 2020 636f 6e73   in dst.    cons
+00060040: 7420 696e 7420 6e70 203d 206e 6532 3b0a  t int np = ne2;.
+00060050: 0a20 2020 202f 2f20 7061 7463 6865 7320  .    // patches 
+00060060: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
+00060070: 6f6e 7374 2069 6e74 2064 7020 3d20 286e  onst int dp = (n
+00060080: 7020 2b20 6e74 6820 2d20 3129 2f6e 7468  p + nth - 1)/nth
+00060090: 3b0a 0a20 2020 202f 2f20 7061 7463 6820  ;..    // patch 
+000600a0: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
+000600b0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+000600c0: 696e 7420 6970 3020 3d20 6470 2a69 7468  int ip0 = dp*ith
+000600d0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000600e0: 6970 3120 3d20 4d49 4e28 6970 3020 2b20  ip1 = MIN(ip0 + 
+000600f0: 6470 2c20 6e70 293b 0a0a 2020 2020 6767  dp, np);..    gg
+00060100: 6d6c 5f66 7031 365f 7420 2a20 636f 6e73  ml_fp16_t * cons
+00060110: 7420 7764 6174 6120 3d20 2867 676d 6c5f  t wdata = (ggml_
+00060120: 6670 3136 5f74 202a 2920 7061 7261 6d73  fp16_t *) params
+00060130: 2d3e 7764 6174 6120 2b20 303b 0a0a 2020  ->wdata + 0;..  
+00060140: 2020 666f 7220 2869 6e74 2069 3220 3d20    for (int i2 = 
+00060150: 6970 303b 2069 3220 3c20 6970 313b 2069  ip0; i2 < ip1; i
+00060160: 322b 2b29 207b 0a20 2020 2020 2020 2066  2++) {.        f
+00060170: 6c6f 6174 202a 2064 7374 5f64 6174 6120  loat * dst_data 
+00060180: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
+00060190: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
+000601a0: 2069 322a 6e62 3229 3b0a 0a20 2020 2020   i2*nb2);..     
+000601b0: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
+000601c0: 2030 3b20 6931 203c 206e 6531 3b20 2b2b   0; i1 < ne1; ++
+000601d0: 6931 2920 7b0a 2020 2020 2020 2020 2020  i1) {.          
+000601e0: 2020 666f 7220 2869 6e74 2069 3020 3d20    for (int i0 = 
+000601f0: 303b 2069 3020 3c20 6e65 303b 202b 2b69  0; i0 < ne0; ++i
+00060200: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00060210: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
+00060220: 745f 6631 3628 6577 302c 2064 7374 5f64  t_f16(ew0, dst_d
+00060230: 6174 6120 2b20 6931 2a6e 6530 202b 2069  ata + i1*ne0 + i
+00060240: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00060250: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
+00060260: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
+00060270: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+00060280: 2b20 6932 2a6e 6230 3329 2c0a 2020 2020  + i2*nb03),.    
+00060290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000602a0: 2020 2020 2867 676d 6c5f 6670 3136 5f74      (ggml_fp16_t
+000602b0: 202a 2920 2020 2020 2020 2020 2020 2020   *)             
+000602c0: 2020 2077 6461 7461 202b 2028 6931 2a6e     wdata + (i1*n
+000602d0: 6530 202b 2069 3029 2a65 7730 293b 0a20  e0 + i0)*ew0);. 
+000602e0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000602f0: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+00060300: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00060310: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00060320: 5f63 6f6e 765f 3264 5f73 6b5f 7030 280a  _conv_2d_sk_p0(.
+00060330: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00060340: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00060350: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00060360: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00060370: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00060380: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00060390: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000603a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+000603b0: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
+000603c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+000603d0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+000603e0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+000603f0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00060400: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+00060410: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00060420: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00060430: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00060440: 645f 636f 6e76 5f32 645f 736b 5f70 305f  d_conv_2d_sk_p0_
+00060450: 6631 365f 6633 3228 7061 7261 6d73 2c20  f16_f32(params, 
+00060460: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00060470: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00060480: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00060490: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+000604a0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+000604b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000604c0: 202f 2f67 676d 6c5f 636f 6d70 7574 655f   //ggml_compute_
+000604d0: 666f 7277 6172 645f 636f 6e76 5f32 645f  forward_conv_2d_
+000604e0: 736b 5f70 305f 6633 3228 7061 7261 6d73  sk_p0_f32(params
+000604f0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
+00060500: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00060510: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00060520: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00060530: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00060540: 2020 2020 2064 6566 6175 6c74 3a0a 2020       default:.  
+00060550: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00060560: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00060570: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+00060580: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00060590: 6561 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f  eak;.    }.}..//
+000605a0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000605b0: 7277 6172 645f 666c 6173 685f 6174 746e  rward_flash_attn
+000605c0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+000605d0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000605e0: 7264 5f66 6c61 7368 5f61 7474 6e5f 6633  rd_flash_attn_f3
+000605f0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+00060600: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00060610: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00060620: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00060630: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00060640: 7465 6e73 6f72 202a 2071 2c0a 2020 2020  tensor * q,.    
+00060650: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00060660: 2067 676d 6c5f 7465 6e73 6f72 202a 206b   ggml_tensor * k
+00060670: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00060680: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00060690: 6f72 202a 2076 2c0a 2020 2020 2020 2020  or * v,.        
+000606a0: 636f 6e73 7420 626f 6f6c 206d 6173 6b65  const bool maske
+000606b0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000606c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000606d0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+000606e0: 696e 7436 345f 7420 7430 203d 2067 676d  int64_t t0 = ggm
+000606f0: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
+00060700: 3b0a 2020 2020 554e 5553 4544 2874 3029  ;.    UNUSED(t0)
+00060710: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00060720: 3634 5f74 206e 6571 3020 3d20 712d 3e6e  64_t neq0 = q->n
+00060730: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00060740: 696e 7436 345f 7420 6e65 7131 203d 2071  int64_t neq1 = q
+00060750: 2d3e 6e65 5b31 5d3b 0a20 2020 2063 6f6e  ->ne[1];.    con
+00060760: 7374 2069 6e74 3634 5f74 206e 6571 3220  st int64_t neq2 
+00060770: 3d20 712d 3e6e 655b 325d 3b0a 2020 2020  = q->ne[2];.    
+00060780: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00060790: 7133 203d 2071 2d3e 6e65 5b33 5d3b 0a0a  q3 = q->ne[3];..
+000607a0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000607b0: 7420 6e65 6b30 203d 206b 2d3e 6e65 5b30  t nek0 = k->ne[0
+000607c0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000607d0: 3634 5f74 206e 656b 3120 3d20 6b2d 3e6e  64_t nek1 = k->n
+000607e0: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
+000607f0: 7420 696e 7436 345f 7420 6e65 6b32 203d  t int64_t nek2 =
+00060800: 206b 2d3e 6e65 5b32 5d3b 0a20 2020 202f   k->ne[2];.    /
+00060810: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00060820: 656b 3320 3d20 6b2d 3e6e 655b 335d 3b0a  ek3 = k->ne[3];.
+00060830: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+00060840: 3634 5f74 206e 6576 3020 3d20 762d 3e6e  64_t nev0 = v->n
+00060850: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00060860: 696e 7436 345f 7420 6e65 7631 203d 2076  int64_t nev1 = v
+00060870: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+00060880: 6f6e 7374 2069 6e74 3634 5f74 206e 6576  onst int64_t nev
+00060890: 3220 3d20 762d 3e6e 655b 325d 3b0a 2020  2 = v->ne[2];.  
+000608a0: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+000608b0: 7420 6e65 7633 203d 2076 2d3e 6e65 5b33  t nev3 = v->ne[3
+000608c0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+000608d0: 7436 345f 7420 6e65 3020 203d 2064 7374  t64_t ne0  = dst
+000608e0: 2d3e 6e65 5b30 5d3b 0a20 2020 2063 6f6e  ->ne[0];.    con
+000608f0: 7374 2069 6e74 3634 5f74 206e 6531 2020  st int64_t ne1  
+00060900: 3d20 6473 742d 3e6e 655b 315d 3b0a 2020  = dst->ne[1];.  
+00060910: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+00060920: 7420 6e65 3220 203d 2064 7374 2d3e 6e65  t ne2  = dst->ne
+00060930: 5b32 5d3b 0a20 2020 202f 2f63 6f6e 7374  [2];.    //const
+00060940: 2069 6e74 3634 5f74 206e 6533 2020 3d20   int64_t ne3  = 
+00060950: 6473 742d 3e6e 655b 335d 3b0a 0a20 2020  dst->ne[3];..   
+00060960: 2063 6f6e 7374 2069 6e74 206e 626b 3020   const int nbk0 
+00060970: 3d20 6b2d 3e6e 625b 305d 3b0a 2020 2020  = k->nb[0];.    
+00060980: 636f 6e73 7420 696e 7420 6e62 6b31 203d  const int nbk1 =
+00060990: 206b 2d3e 6e62 5b31 5d3b 0a20 2020 2063   k->nb[1];.    c
+000609a0: 6f6e 7374 2069 6e74 206e 626b 3220 3d20  onst int nbk2 = 
+000609b0: 6b2d 3e6e 625b 325d 3b0a 2020 2020 636f  k->nb[2];.    co
+000609c0: 6e73 7420 696e 7420 6e62 6b33 203d 206b  nst int nbk3 = k
+000609d0: 2d3e 6e62 5b33 5d3b 0a0a 2020 2020 636f  ->nb[3];..    co
+000609e0: 6e73 7420 696e 7420 6e62 7130 203d 2071  nst int nbq0 = q
+000609f0: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00060a00: 7374 2069 6e74 206e 6271 3120 3d20 712d  st int nbq1 = q-
+00060a10: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00060a20: 7420 696e 7420 6e62 7132 203d 2071 2d3e  t int nbq2 = q->
+00060a30: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+00060a40: 2069 6e74 206e 6271 3320 3d20 712d 3e6e   int nbq3 = q->n
+00060a50: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+00060a60: 2069 6e74 206e 6276 3020 3d20 762d 3e6e   int nbv0 = v->n
+00060a70: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+00060a80: 696e 7420 6e62 7631 203d 2076 2d3e 6e62  int nbv1 = v->nb
+00060a90: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00060aa0: 6e74 206e 6276 3220 3d20 762d 3e6e 625b  nt nbv2 = v->nb[
+00060ab0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00060ac0: 7420 6e62 7633 203d 2076 2d3e 6e62 5b33  t nbv3 = v->nb[3
+00060ad0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00060ae0: 7420 6e62 3020 203d 2064 7374 2d3e 6e62  t nb0  = dst->nb
+00060af0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00060b00: 6e74 206e 6231 2020 3d20 6473 742d 3e6e  nt nb1  = dst->n
+00060b10: 625b 315d 3b0a 2020 2020 636f 6e73 7420  b[1];.    const 
+00060b20: 696e 7420 6e62 3220 203d 2064 7374 2d3e  int nb2  = dst->
+00060b30: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+00060b40: 2069 6e74 206e 6233 2020 3d20 6473 742d   int nb3  = dst-
+00060b50: 3e6e 625b 335d 3b0a 0a20 2020 2063 6f6e  >nb[3];..    con
+00060b60: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00060b70: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00060b80: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00060b90: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00060ba0: 636f 6e73 7420 696e 7436 345f 7420 4420  const int64_t D 
+00060bb0: 3d20 6e65 7130 3b0a 2020 2020 636f 6e73  = neq0;.    cons
+00060bc0: 7420 696e 7436 345f 7420 4e20 3d20 6e65  t int64_t N = ne
+00060bd0: 7131 3b0a 2020 2020 636f 6e73 7420 696e  q1;.    const in
+00060be0: 7436 345f 7420 5020 3d20 6e65 6b31 202d  t64_t P = nek1 -
+00060bf0: 204e 3b0a 2020 2020 636f 6e73 7420 696e   N;.    const in
+00060c00: 7436 345f 7420 4d20 3d20 5020 2b20 4e3b  t64_t M = P + N;
+00060c10: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00060c20: 4d75 7020 3d20 6767 6d6c 5f75 7028 4d2c  Mup = ggml_up(M,
+00060c30: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
+00060c40: 4e52 4f4c 4c29 3b0a 0a20 2020 2047 474d  NROLL);..    GGM
+00060c50: 4c5f 4153 5345 5254 286e 6530 203d 3d20  L_ASSERT(ne0 == 
+00060c60: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
+00060c70: 4552 5428 6e65 3120 3d3d 204e 293b 0a20  ERT(ne1 == N);. 
+00060c80: 2020 2047 474d 4c5f 4153 5345 5254 2850     GGML_ASSERT(P
+00060c90: 203e 3d20 3029 3b0a 0a20 2020 2047 474d   >= 0);..    GGM
+00060ca0: 4c5f 4153 5345 5254 286e 6271 3020 3d3d  L_ASSERT(nbq0 ==
+00060cb0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00060cc0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00060cd0: 286e 626b 3020 3d3d 2073 697a 656f 6628  (nbk0 == sizeof(
+00060ce0: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+00060cf0: 4c5f 4153 5345 5254 286e 6276 3020 3d3d  L_ASSERT(nbv0 ==
+00060d00: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00060d10: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
+00060d20: 5428 6e65 7130 203d 3d20 4429 3b0a 2020  T(neq0 == D);.  
+00060d30: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+00060d40: 6b30 203d 3d20 4429 3b0a 2020 2020 4747  k0 == D);.    GG
+00060d50: 4d4c 5f41 5353 4552 5428 6e65 7631 203d  ML_ASSERT(nev1 =
+00060d60: 3d20 4429 3b0a 0a20 2020 2047 474d 4c5f  = D);..    GGML_
+00060d70: 4153 5345 5254 286e 6571 3120 3d3d 204e  ASSERT(neq1 == N
+00060d80: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00060d90: 5254 286e 656b 3120 3d3d 204e 202b 2050  RT(nek1 == N + P
+00060da0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00060db0: 5254 286e 6576 3120 3d3d 2044 293b 0a0a  RT(nev1 == D);..
+00060dc0: 2020 2020 2f2f 2064 7374 2063 616e 6e6f      // dst canno
+00060dd0: 7420 6265 2074 7261 6e73 706f 7365 6420  t be transposed 
+00060de0: 6f72 2070 6572 6d75 7465 640a 2020 2020  or permuted.    
+00060df0: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
+00060e00: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00060e10: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00060e20: 5254 286e 6230 203c 3d20 6e62 3129 3b0a  RT(nb0 <= nb1);.
+00060e30: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00060e40: 6e62 3120 3c3d 206e 6232 293b 0a20 2020  nb1 <= nb2);.   
+00060e50: 2047 474d 4c5f 4153 5345 5254 286e 6232   GGML_ASSERT(nb2
+00060e60: 203c 3d20 6e62 3329 3b0a 0a20 2020 2069   <= nb3);..    i
+00060e70: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00060e80: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+00060e90: 5429 207b 0a20 2020 2020 2020 2072 6574  T) {.        ret
+00060ea0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+00060eb0: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00060ec0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00060ed0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00060ee0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00060ef0: 0a20 2020 202f 2f20 7061 7261 6c6c 656c  .    // parallel
+00060f00: 697a 6520 6279 2071 2072 6f77 7320 7573  ize by q rows us
+00060f10: 696e 6720 6767 6d6c 5f76 6563 5f64 6f74  ing ggml_vec_dot
+00060f20: 5f66 3332 0a0a 2020 2020 2f2f 2074 6f74  _f32..    // tot
+00060f30: 616c 2072 6f77 7320 696e 2071 0a20 2020  al rows in q.   
+00060f40: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
+00060f50: 6e65 7131 2a6e 6571 322a 6e65 7133 3b0a  neq1*neq2*neq3;.
+00060f60: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
+00060f70: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00060f80: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
+00060f90: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
+00060fa0: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
+00060fb0: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
+00060fc0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+00060fd0: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
+00060fe0: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
+00060ff0: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
+00061000: 7229 3b0a 0a20 2020 2063 6f6e 7374 2066  r);..    const f
+00061010: 6c6f 6174 2073 6361 6c65 203d 2031 2e30  loat scale = 1.0
+00061020: 662f 7371 7274 6628 4429 3b0a 0a20 2020  f/sqrtf(D);..   
+00061030: 202f 2f70 7269 6e74 6628 2250 3d25 6420   //printf("P=%d 
+00061040: 4e3d 2564 2044 3d25 6420 6972 303d 2564  N=%d D=%d ir0=%d
+00061050: 2069 7231 3d25 6420 7363 616c 6520 3d20   ir1=%d scale = 
+00061060: 2566 5c6e 222c 2050 2c20 4e2c 2044 2c20  %f\n", P, N, D, 
+00061070: 6972 302c 2069 7231 2c20 7363 616c 6529  ir0, ir1, scale)
+00061080: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00061090: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
+000610a0: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
+000610b0: 2020 2020 2f2f 2071 2069 6e64 6963 6573      // q indices
+000610c0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+000610d0: 6e74 2069 7133 203d 2069 722f 286e 6571  nt iq3 = ir/(neq
+000610e0: 322a 6e65 7131 293b 0a20 2020 2020 2020  2*neq1);.       
+000610f0: 2063 6f6e 7374 2069 6e74 2069 7132 203d   const int iq2 =
+00061100: 2028 6972 202d 2069 7133 2a6e 6571 322a   (ir - iq3*neq2*
+00061110: 6e65 7131 292f 6e65 7131 3b0a 2020 2020  neq1)/neq1;.    
+00061120: 2020 2020 636f 6e73 7420 696e 7420 6971      const int iq
+00061130: 3120 3d20 2869 7220 2d20 6971 332a 6e65  1 = (ir - iq3*ne
+00061140: 7132 2a6e 6571 3120 2d20 6971 322a 6e65  q2*neq1 - iq2*ne
+00061150: 7131 293b 0a0a 2020 2020 2020 2020 666c  q1);..        fl
+00061160: 6f61 7420 2a20 5320 3d20 2866 6c6f 6174  oat * S = (float
+00061170: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+00061180: 6120 2b20 6974 682a 284d 7570 202b 2043  a + ith*(Mup + C
+00061190: 4143 4845 5f4c 494e 455f 5349 5a45 5f46  ACHE_LINE_SIZE_F
+000611a0: 3332 293b 0a0a 2020 2020 2020 2020 666f  32);..        fo
+000611b0: 7220 2869 6e74 2069 203d 204d 3b20 6920  r (int i = M; i 
+000611c0: 3c20 4d75 703b 202b 2b69 2920 7b0a 2020  < Mup; ++i) {.  
+000611d0: 2020 2020 2020 2020 2020 535b 695d 203d            S[i] =
+000611e0: 202d 494e 4649 4e49 5459 3b0a 2020 2020   -INFINITY;.    
+000611f0: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
+00061200: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
+00061210: 2030 3b20 6963 203c 206e 656b 313b 202b   0; ic < nek1; +
+00061220: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
+00061230: 2020 202f 2f20 6b20 696e 6469 6365 730a     // k indices.
+00061240: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00061250: 7420 696e 7420 696b 3320 3d20 6971 333b  t int ik3 = iq3;
+00061260: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00061270: 7374 2069 6e74 2069 6b32 203d 2069 7132  st int ik2 = iq2
+00061280: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00061290: 6e73 7420 696e 7420 696b 3120 3d20 6963  nst int ik1 = ic
+000612a0: 3b0a 0a20 2020 2020 2020 2020 2020 202f  ;..            /
+000612b0: 2f20 5320 696e 6469 6365 730a 2020 2020  / S indices.    
+000612c0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000612d0: 7420 6931 203d 2069 6b31 3b0a 0a20 2020  t i1 = ik1;..   
+000612e0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+000612f0: 635f 646f 745f 6633 3228 6e65 7130 2c0a  c_dot_f32(neq0,.
+00061300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061310: 2020 2020 5320 2b20 6931 2c0a 2020 2020      S + i1,.    
+00061320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061330: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+00061340: 202a 2920 6b2d 3e64 6174 6120 2b20 2869   *) k->data + (i
+00061350: 6b31 2a6e 626b 3120 2b20 696b 322a 6e62  k1*nbk1 + ik2*nb
+00061360: 6b32 202b 2069 6b33 2a6e 626b 3329 292c  k2 + ik3*nbk3)),
+00061370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061380: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00061390: 2863 6861 7220 2a29 2071 2d3e 6461 7461  (char *) q->data
+000613a0: 202b 2028 6971 312a 6e62 7131 202b 2069   + (iq1*nbq1 + i
+000613b0: 7132 2a6e 6271 3220 2b20 6971 332a 6e62  q2*nbq2 + iq3*nb
+000613c0: 7133 2929 293b 0a20 2020 2020 2020 207d  q3)));.        }
+000613d0: 0a0a 2020 2020 2020 2020 2f2f 2073 6361  ..        // sca
+000613e0: 6c65 0a20 2020 2020 2020 2067 676d 6c5f  le.        ggml_
+000613f0: 7665 635f 7363 616c 655f 6633 3228 6e65  vec_scale_f32(ne
+00061400: 6b31 2c20 532c 2073 6361 6c65 293b 0a0a  k1, S, scale);..
+00061410: 2020 2020 2020 2020 6966 2028 6d61 736b          if (mask
+00061420: 6564 2920 7b0a 2020 2020 2020 2020 2020  ed) {.          
+00061430: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+00061440: 203d 2050 3b20 6920 3c20 4d3b 2069 2b2b   = P; i < M; i++
+00061450: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00061460: 2020 2020 6966 2028 6920 3e20 5020 2b20      if (i > P + 
+00061470: 6971 3129 207b 0a20 2020 2020 2020 2020  iq1) {.         
+00061480: 2020 2020 2020 2020 2020 2053 5b69 5d20             S[i] 
+00061490: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
+000614a0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000614b0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000614c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000614d0: 2f2f 2073 6f66 746d 6178 0a20 2020 2020  // softmax.     
+000614e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000614f0: 2066 6c6f 6174 206d 6178 203d 202d 494e   float max = -IN
+00061500: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
+00061510: 2020 2020 6767 6d6c 5f76 6563 5f6d 6178      ggml_vec_max
+00061520: 5f66 3332 284d 2c20 266d 6178 2c20 5329  _f32(M, &max, S)
+00061530: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
+00061540: 676d 6c5f 666c 6f61 7420 7375 6d20 3d20  gml_float sum = 
+00061550: 302e 303b 0a20 2020 2020 2020 2020 2020  0.0;.           
+00061560: 207b 0a23 6966 6465 6620 4747 4d4c 5f53   {.#ifdef GGML_S
+00061570: 4f46 545f 4d41 585f 4143 4345 4c45 5241  OFT_MAX_ACCELERA
+00061580: 5445 0a20 2020 2020 2020 2020 2020 2020  TE.             
+00061590: 2020 206d 6178 203d 202d 6d61 783b 0a20     max = -max;. 
+000615a0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000615b0: 4453 505f 7673 6164 6428 532c 2031 2c20  DSP_vsadd(S, 1, 
+000615c0: 266d 6178 2c20 532c 2031 2c20 4d75 7029  &max, S, 1, Mup)
+000615d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000615e0: 2020 7676 6578 7066 2853 2c20 532c 2026    vvexpf(S, S, &
+000615f0: 4d75 7029 3b0a 2020 2020 2020 2020 2020  Mup);.          
+00061600: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+00061610: 756d 5f66 3332 284d 7570 2c20 2673 756d  um_f32(Mup, &sum
+00061620: 2c20 5329 3b0a 2365 6c73 650a 2020 2020  , S);.#else.    
+00061630: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
+00061640: 3136 5f74 2020 2073 6376 745b 4747 4d4c  16_t   scvt[GGML
+00061650: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
+00061660: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+00061670: 2020 2067 676d 6c5f 666c 6f61 7420 7375     ggml_float su
+00061680: 6d70 5b47 474d 4c5f 534f 4654 5f4d 4158  mp[GGML_SOFT_MAX
+00061690: 5f55 4e52 4f4c 4c5d 203d 207b 2030 2e30  _UNROLL] = { 0.0
+000616a0: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
+000616b0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+000616c0: 3d20 303b 2069 203c 204d 7570 3b20 6920  = 0; i < Mup; i 
+000616d0: 2b3d 2047 474d 4c5f 534f 4654 5f4d 4158  += GGML_SOFT_MAX
+000616e0: 5f55 4e52 4f4c 4c29 207b 0a20 2020 2020  _UNROLL) {.     
+000616f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00061700: 6c6f 6174 202a 2053 5320 3d20 5320 2b20  loat * SS = S + 
+00061710: 693b 0a0a 2020 2020 2020 2020 2020 2020  i;..            
+00061720: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00061730: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
+00061740: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
+00061750: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
+00061760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061770: 2069 6620 2853 535b 6a5d 203d 3d20 2d49   if (SS[j] == -I
+00061780: 4e46 494e 4954 5929 207b 0a20 2020 2020  NFINITY) {.     
 00061790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000617a0: 2020 5353 5b6a 5d20 3d20 302e 3066 3b0a    SS[j] = 0.0f;.
-000617b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000617c0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-000617d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000617e0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000617f0: 6c5f 6670 3136 5f74 2073 203d 2047 474d  l_fp16_t s = GGM
-00061800: 4c5f 4650 3332 5f54 4f5f 4650 3136 2853  L_FP32_TO_FP16(S
-00061810: 535b 6a5d 202d 206d 6178 293b 0a20 2020  S[j] - max);.   
-00061820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061830: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
-00061840: 2673 6376 745b 6a5d 2c20 2673 2c20 7369  &scvt[j], &s, si
-00061850: 7a65 6f66 2875 696e 7431 365f 7429 293b  zeof(uint16_t));
-00061860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061870: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00061880: 7374 2066 6c6f 6174 2076 616c 203d 2047  st float val = G
-00061890: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
-000618a0: 2874 6162 6c65 5f65 7870 5f66 3136 5b73  (table_exp_f16[s
-000618b0: 6376 745b 6a5d 5d29 3b0a 2020 2020 2020  cvt[j]]);.      
+000617a0: 2020 2020 2020 2053 535b 6a5d 203d 2030         SS[j] = 0
+000617b0: 2e30 663b 0a20 2020 2020 2020 2020 2020  .0f;.           
+000617c0: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+000617d0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+000617e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000617f0: 2020 6767 6d6c 5f66 7031 365f 7420 7320    ggml_fp16_t s 
+00061800: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+00061810: 5031 3628 5353 5b6a 5d20 2d20 6d61 7829  P16(SS[j] - max)
+00061820: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00061830: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00061840: 6d63 7079 2826 7363 7674 5b6a 5d2c 2026  mcpy(&scvt[j], &
+00061850: 732c 2073 697a 656f 6628 7569 6e74 3136  s, sizeof(uint16
+00061860: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
+00061870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061880: 2020 636f 6e73 7420 666c 6f61 7420 7661    const float va
+00061890: 6c20 3d20 4747 4d4c 5f46 5031 365f 544f  l = GGML_FP16_TO
+000618a0: 5f46 5033 3228 7461 626c 655f 6578 705f  _FP32(table_exp_
+000618b0: 6631 365b 7363 7674 5b6a 5d5d 293b 0a20  f16[scvt[j]]);. 
 000618c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000618d0: 2020 2020 2020 7375 6d70 5b6a 5d20 2b3d        sump[j] +=
-000618e0: 2028 6767 6d6c 5f66 6c6f 6174 2976 616c   (ggml_float)val
-000618f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00061900: 2020 2020 2020 2020 2020 2020 2020 5353                SS
-00061910: 5b6a 5d20 3d20 7661 6c3b 0a20 2020 2020  [j] = val;.     
+000618d0: 2020 2020 2020 2020 2020 2073 756d 705b             sump[
+000618e0: 6a5d 202b 3d20 2867 676d 6c5f 666c 6f61  j] += (ggml_floa
+000618f0: 7429 7661 6c3b 0a20 2020 2020 2020 2020  t)val;.         
+00061900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061910: 2020 2053 535b 6a5d 203d 2076 616c 3b0a     SS[j] = val;.
 00061920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061930: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00061940: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00061950: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00061960: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00061970: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00061980: 3c20 4747 4d4c 5f53 4f46 545f 4d41 585f  < GGML_SOFT_MAX_
-00061990: 554e 524f 4c4c 3b20 692b 2b29 207b 0a20  UNROLL; i++) {. 
-000619a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000619b0: 2020 2073 756d 202b 3d20 7375 6d70 5b69     sum += sump[i
-000619c0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-000619d0: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
-000619e0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000619f0: 2020 2020 2020 2061 7373 6572 7428 7375         assert(su
-00061a00: 6d20 3e20 302e 3029 3b0a 0a20 2020 2020  m > 0.0);..     
-00061a10: 2020 2020 2020 2073 756d 203d 2031 2e30         sum = 1.0
-00061a20: 2f73 756d 3b0a 2020 2020 2020 2020 2020  /sum;.          
-00061a30: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
-00061a40: 5f66 3332 284d 2c20 532c 2073 756d 293b  _f32(M, S, sum);
-00061a50: 0a0a 2369 666e 6465 6620 4e44 4542 5547  ..#ifndef NDEBUG
-00061a60: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00061a70: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00061a80: 204d 3b20 2b2b 6929 207b 0a20 2020 2020   M; ++i) {.     
-00061a90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00061aa0: 7428 2169 736e 616e 2853 5b69 5d29 293b  t(!isnan(S[i]));
-00061ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061ac0: 2061 7373 6572 7428 2169 7369 6e66 2853   assert(!isinf(S
-00061ad0: 5b69 5d29 293b 0a20 2020 2020 2020 2020  [i]));.         
-00061ae0: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
-00061af0: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
-00061b00: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
-00061b10: 2030 3b20 6963 203c 206e 6576 313b 202b   0; ic < nev1; +
-00061b20: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
-00061b30: 2020 202f 2f20 6473 7420 696e 6469 6365     // dst indice
-00061b40: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
-00061b50: 6e73 7420 696e 7420 6931 203d 2069 7131  nst int i1 = iq1
-00061b60: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-00061b70: 6e73 7420 696e 7420 6932 203d 2069 7132  nst int i2 = iq2
-00061b80: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
-00061b90: 6e73 7420 696e 7420 6933 203d 2069 7133  nst int i3 = iq3
-00061ba0: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
-00061bb0: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
-00061bc0: 6e65 6b31 2c0a 2020 2020 2020 2020 2020  nek1,.          
-00061bd0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00061be0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-00061bf0: 742d 3e64 6174 6120 2b20 2869 632a 6e62  t->data + (ic*nb
-00061c00: 3020 2b20 6931 2a6e 6231 2020 2b20 6932  0 + i1*nb1  + i2
-00061c10: 2a6e 6232 2020 2b20 6933 2a6e 6233 2929  *nb2  + i3*nb3))
-00061c20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00061c30: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-00061c40: 2828 6368 6172 202a 2920 762d 3e64 6174  ((char *) v->dat
-00061c50: 6120 2020 2b20 2820 2020 2020 2020 2020  a   + (         
-00061c60: 6963 2a6e 6276 3120 2b20 6932 2a6e 6276  ic*nbv1 + i2*nbv
-00061c70: 3220 2b20 6933 2a6e 6276 3329 292c 0a20  2 + i3*nbv3)),. 
-00061c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061c90: 2020 2053 293b 0a20 2020 2020 2020 207d     S);.        }
-00061ca0: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00061cb0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00061cc0: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
-00061cd0: 5f61 7474 6e5f 6631 3628 0a20 2020 2020  _attn_f16(.     
-00061ce0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00061cf0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00061d00: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00061d10: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00061d20: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00061d30: 2071 2c0a 2020 2020 2020 2020 636f 6e73   q,.        cons
-00061d40: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00061d50: 6e73 6f72 202a 206b 2c0a 2020 2020 2020  nsor * k,.      
-00061d60: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00061d70: 676d 6c5f 7465 6e73 6f72 202a 2076 2c0a  gml_tensor * v,.
-00061d80: 2020 2020 2020 2020 636f 6e73 7420 626f          const bo
-00061d90: 6f6c 206d 6173 6b65 642c 0a20 2020 2020  ol masked,.     
-00061da0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00061db0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00061dc0: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
-00061dd0: 7430 203d 2067 676d 6c5f 7065 7266 5f74  t0 = ggml_perf_t
-00061de0: 696d 655f 7573 2829 3b0a 2020 2020 554e  ime_us();.    UN
-00061df0: 5553 4544 2874 3029 3b0a 0a20 2020 2063  USED(t0);..    c
-00061e00: 6f6e 7374 2069 6e74 3634 5f74 206e 6571  onst int64_t neq
-00061e10: 3020 3d20 712d 3e6e 655b 305d 3b0a 2020  0 = q->ne[0];.  
-00061e20: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00061e30: 6e65 7131 203d 2071 2d3e 6e65 5b31 5d3b  neq1 = q->ne[1];
-00061e40: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00061e50: 5f74 206e 6571 3220 3d20 712d 3e6e 655b  _t neq2 = q->ne[
-00061e60: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
-00061e70: 7436 345f 7420 6e65 7133 203d 2071 2d3e  t64_t neq3 = q->
-00061e80: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
-00061e90: 7420 696e 7436 345f 7420 6e65 6b30 203d  t int64_t nek0 =
-00061ea0: 206b 2d3e 6e65 5b30 5d3b 0a20 2020 2063   k->ne[0];.    c
-00061eb0: 6f6e 7374 2069 6e74 3634 5f74 206e 656b  onst int64_t nek
-00061ec0: 3120 3d20 6b2d 3e6e 655b 315d 3b0a 2020  1 = k->ne[1];.  
-00061ed0: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
-00061ee0: 7420 6e65 6b32 203d 206b 2d3e 6e65 5b32  t nek2 = k->ne[2
-00061ef0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
-00061f00: 6e74 3634 5f74 206e 656b 3320 3d20 6b2d  nt64_t nek3 = k-
-00061f10: 3e6e 655b 335d 3b0a 0a20 2020 202f 2f63  >ne[3];..    //c
-00061f20: 6f6e 7374 2069 6e74 3634 5f74 206e 6576  onst int64_t nev
-00061f30: 3020 3d20 762d 3e6e 655b 305d 3b0a 2020  0 = v->ne[0];.  
-00061f40: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00061f50: 6e65 7631 203d 2076 2d3e 6e65 5b31 5d3b  nev1 = v->ne[1];
-00061f60: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
-00061f70: 3634 5f74 206e 6576 3220 3d20 762d 3e6e  64_t nev2 = v->n
-00061f80: 655b 325d 3b0a 2020 2020 2f2f 636f 6e73  e[2];.    //cons
-00061f90: 7420 696e 7436 345f 7420 6e65 7633 203d  t int64_t nev3 =
-00061fa0: 2076 2d3e 6e65 5b33 5d3b 0a0a 2020 2020   v->ne[3];..    
-00061fb0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00061fc0: 3020 203d 2064 7374 2d3e 6e65 5b30 5d3b  0  = dst->ne[0];
-00061fd0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00061fe0: 5f74 206e 6531 2020 3d20 6473 742d 3e6e  _t ne1  = dst->n
-00061ff0: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
-00062000: 7420 696e 7436 345f 7420 6e65 3220 203d  t int64_t ne2  =
-00062010: 2064 7374 2d3e 6e65 5b32 5d3b 0a20 2020   dst->ne[2];.   
-00062020: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-00062030: 206e 6533 2020 3d20 6473 742d 3e6e 655b   ne3  = dst->ne[
-00062040: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-00062050: 6e74 206e 626b 3020 3d20 6b2d 3e6e 625b  nt nbk0 = k->nb[
-00062060: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-00062070: 7420 6e62 6b31 203d 206b 2d3e 6e62 5b31  t nbk1 = k->nb[1
-00062080: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00062090: 206e 626b 3220 3d20 6b2d 3e6e 625b 325d   nbk2 = k->nb[2]
-000620a0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000620b0: 6e62 6b33 203d 206b 2d3e 6e62 5b33 5d3b  nbk3 = k->nb[3];
-000620c0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-000620d0: 6e62 7130 203d 2071 2d3e 6e62 5b30 5d3b  nbq0 = q->nb[0];
-000620e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000620f0: 6271 3120 3d20 712d 3e6e 625b 315d 3b0a  bq1 = q->nb[1];.
-00062100: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00062110: 7132 203d 2071 2d3e 6e62 5b32 5d3b 0a20  q2 = q->nb[2];. 
-00062120: 2020 2063 6f6e 7374 2069 6e74 206e 6271     const int nbq
-00062130: 3320 3d20 712d 3e6e 625b 335d 3b0a 0a20  3 = q->nb[3];.. 
-00062140: 2020 2063 6f6e 7374 2069 6e74 206e 6276     const int nbv
-00062150: 3020 3d20 762d 3e6e 625b 305d 3b0a 2020  0 = v->nb[0];.  
-00062160: 2020 636f 6e73 7420 696e 7420 6e62 7631    const int nbv1
-00062170: 203d 2076 2d3e 6e62 5b31 5d3b 0a20 2020   = v->nb[1];.   
-00062180: 2063 6f6e 7374 2069 6e74 206e 6276 3220   const int nbv2 
-00062190: 3d20 762d 3e6e 625b 325d 3b0a 2020 2020  = v->nb[2];.    
-000621a0: 636f 6e73 7420 696e 7420 6e62 7633 203d  const int nbv3 =
-000621b0: 2076 2d3e 6e62 5b33 5d3b 0a0a 2020 2020   v->nb[3];..    
-000621c0: 636f 6e73 7420 696e 7420 6e62 3020 203d  const int nb0  =
-000621d0: 2064 7374 2d3e 6e62 5b30 5d3b 0a20 2020   dst->nb[0];.   
-000621e0: 2063 6f6e 7374 2069 6e74 206e 6231 2020   const int nb1  
-000621f0: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-00062200: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
-00062210: 203d 2064 7374 2d3e 6e62 5b32 5d3b 0a20   = dst->nb[2];. 
-00062220: 2020 2063 6f6e 7374 2069 6e74 206e 6233     const int nb3
-00062230: 2020 3d20 6473 742d 3e6e 625b 335d 3b0a    = dst->nb[3];.
-00062240: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00062250: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
-00062260: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00062270: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
-00062280: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
-00062290: 7436 345f 7420 4420 3d20 6e65 7130 3b0a  t64_t D = neq0;.
-000622a0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000622b0: 7420 4e20 3d20 6e65 7131 3b0a 2020 2020  t N = neq1;.    
-000622c0: 636f 6e73 7420 696e 7436 345f 7420 5020  const int64_t P 
-000622d0: 3d20 6e65 6b31 202d 204e 3b0a 2020 2020  = nek1 - N;.    
-000622e0: 636f 6e73 7420 696e 7436 345f 7420 4d20  const int64_t M 
-000622f0: 3d20 5020 2b20 4e3b 0a0a 2020 2020 636f  = P + N;..    co
-00062300: 6e73 7420 696e 7420 4d75 7020 3d20 6767  nst int Mup = gg
-00062310: 6d6c 5f75 7028 4d2c 2047 474d 4c5f 534f  ml_up(M, GGML_SO
-00062320: 4654 5f4d 4158 5f55 4e52 4f4c 4c29 3b0a  FT_MAX_UNROLL);.
-00062330: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00062340: 286e 6530 203d 3d20 4429 3b0a 2020 2020  (ne0 == D);.    
-00062350: 4747 4d4c 5f41 5353 4552 5428 6e65 3120  GGML_ASSERT(ne1 
-00062360: 3d3d 204e 293b 0a20 2020 2047 474d 4c5f  == N);.    GGML_
-00062370: 4153 5345 5254 2850 203e 3d20 3029 3b0a  ASSERT(P >= 0);.
-00062380: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00062390: 286e 6271 3020 3d3d 2073 697a 656f 6628  (nbq0 == sizeof(
-000623a0: 6767 6d6c 5f66 7031 365f 7429 293b 0a20  ggml_fp16_t));. 
-000623b0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-000623c0: 626b 3020 3d3d 2073 697a 656f 6628 6767  bk0 == sizeof(gg
-000623d0: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
-000623e0: 2047 474d 4c5f 4153 5345 5254 286e 6276   GGML_ASSERT(nbv
-000623f0: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
-00062400: 5f66 7031 365f 7429 293b 0a0a 2020 2020  _fp16_t));..    
-00062410: 4747 4d4c 5f41 5353 4552 5428 6e65 7130  GGML_ASSERT(neq0
-00062420: 203d 3d20 4429 3b0a 2020 2020 4747 4d4c   == D);.    GGML
-00062430: 5f41 5353 4552 5428 6e65 6b30 203d 3d20  _ASSERT(nek0 == 
-00062440: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
-00062450: 4552 5428 6e65 7631 203d 3d20 4429 3b0a  ERT(nev1 == D);.
-00062460: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00062470: 286e 6571 3120 3d3d 204e 293b 0a20 2020  (neq1 == N);.   
-00062480: 2047 474d 4c5f 4153 5345 5254 286e 656b   GGML_ASSERT(nek
-00062490: 3120 3d3d 204e 202b 2050 293b 0a20 2020  1 == N + P);.   
-000624a0: 2047 474d 4c5f 4153 5345 5254 286e 6576   GGML_ASSERT(nev
-000624b0: 3120 3d3d 2044 293b 0a0a 2020 2020 2f2f  1 == D);..    //
-000624c0: 2064 7374 2063 616e 6e6f 7420 6265 2074   dst cannot be t
-000624d0: 7261 6e73 706f 7365 6420 6f72 2070 6572  ransposed or per
-000624e0: 6d75 7465 640a 2020 2020 4747 4d4c 5f41  muted.    GGML_A
-000624f0: 5353 4552 5428 6e62 3020 3d3d 2073 697a  SSERT(nb0 == siz
-00062500: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00062510: 2047 474d 4c5f 4153 5345 5254 286e 6230   GGML_ASSERT(nb0
-00062520: 203c 3d20 6e62 3129 3b0a 2020 2020 4747   <= nb1);.    GG
-00062530: 4d4c 5f41 5353 4552 5428 6e62 3120 3c3d  ML_ASSERT(nb1 <=
-00062540: 206e 6232 293b 0a20 2020 2047 474d 4c5f   nb2);.    GGML_
-00062550: 4153 5345 5254 286e 6232 203c 3d20 6e62  ASSERT(nb2 <= nb
-00062560: 3329 3b0a 0a20 2020 2069 6620 2870 6172  3);..    if (par
-00062570: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00062580: 4c5f 5441 534b 5f49 4e49 5429 207b 0a20  L_TASK_INIT) {. 
-00062590: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-000625a0: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
-000625b0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-000625c0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-000625d0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-000625e0: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
-000625f0: 2f20 7061 7261 6c6c 656c 697a 6520 6279  / parallelize by
-00062600: 2071 2072 6f77 7320 7573 696e 6720 6767   q rows using gg
-00062610: 6d6c 5f76 6563 5f64 6f74 5f66 3332 0a0a  ml_vec_dot_f32..
-00062620: 2020 2020 2f2f 2074 6f74 616c 2072 6f77      // total row
-00062630: 7320 696e 2071 0a20 2020 2063 6f6e 7374  s in q.    const
-00062640: 2069 6e74 206e 7220 3d20 6e65 7131 2a6e   int nr = neq1*n
-00062650: 6571 322a 6e65 7133 3b0a 0a20 2020 202f  eq2*neq3;..    /
-00062660: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-00062670: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-00062680: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-00062690: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-000626a0: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-000626b0: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-000626c0: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-000626d0: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-000626e0: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-000626f0: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-00062700: 2020 2063 6f6e 7374 2066 6c6f 6174 2073     const float s
-00062710: 6361 6c65 203d 2031 2e30 662f 7371 7274  cale = 1.0f/sqrt
-00062720: 6628 4429 3b0a 0a20 2020 202f 2f70 7269  f(D);..    //pri
-00062730: 6e74 6628 2250 3d25 6420 4e3d 2564 2044  ntf("P=%d N=%d D
-00062740: 3d25 6420 6972 303d 2564 2069 7231 3d25  =%d ir0=%d ir1=%
-00062750: 6420 7363 616c 6520 3d20 2566 5c6e 222c  d scale = %f\n",
-00062760: 2050 2c20 4e2c 2044 2c20 6972 302c 2069   P, N, D, ir0, i
-00062770: 7231 2c20 7363 616c 6529 3b0a 0a20 2020  r1, scale);..   
-00062780: 2066 6f72 2028 696e 7420 6972 203d 2069   for (int ir = i
-00062790: 7230 3b20 6972 203c 2069 7231 3b20 2b2b  r0; ir < ir1; ++
-000627a0: 6972 2920 7b0a 2020 2020 2020 2020 2f2f  ir) {.        //
-000627b0: 2071 2069 6e64 6963 6573 0a20 2020 2020   q indices.     
-000627c0: 2020 2063 6f6e 7374 2069 6e74 2069 7133     const int iq3
-000627d0: 203d 2069 722f 286e 6571 322a 6e65 7131   = ir/(neq2*neq1
-000627e0: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-000627f0: 2069 6e74 2069 7132 203d 2028 6972 202d   int iq2 = (ir -
-00062800: 2069 7133 2a6e 6571 322a 6e65 7131 292f   iq3*neq2*neq1)/
-00062810: 6e65 7131 3b0a 2020 2020 2020 2020 636f  neq1;.        co
-00062820: 6e73 7420 696e 7420 6971 3120 3d20 2869  nst int iq1 = (i
-00062830: 7220 2d20 6971 332a 6e65 7132 2a6e 6571  r - iq3*neq2*neq
-00062840: 3120 2d20 6971 322a 6e65 7131 293b 0a0a  1 - iq2*neq1);..
-00062850: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00062860: 5320 3d20 2866 6c6f 6174 202a 2920 7061  S = (float *) pa
-00062870: 7261 6d73 2d3e 7764 6174 6120 2b20 6974  rams->wdata + it
-00062880: 682a 2832 2a4d 7570 202b 2043 4143 4845  h*(2*Mup + CACHE
-00062890: 5f4c 494e 455f 5349 5a45 5f46 3332 293b  _LINE_SIZE_F32);
-000628a0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-000628b0: 6e74 2069 203d 204d 3b20 6920 3c20 4d75  nt i = M; i < Mu
-000628c0: 703b 202b 2b69 2920 7b0a 2020 2020 2020  p; ++i) {.      
-000628d0: 2020 2020 2020 535b 695d 203d 202d 494e        S[i] = -IN
-000628e0: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
-000628f0: 7d0a 0a20 2020 2020 2020 2069 6620 2847  }..        if (G
-00062900: 474d 4c5f 5645 435f 444f 545f 554e 524f  GML_VEC_DOT_UNRO
-00062910: 4c4c 203e 2032 207c 7c20 6e65 6b31 2025  LL > 2 || nek1 %
-00062920: 2047 474d 4c5f 5645 435f 444f 545f 554e   GGML_VEC_DOT_UN
-00062930: 524f 4c4c 2021 3d20 3029 207b 0a20 2020  ROLL != 0) {.   
-00062940: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00062950: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
-00062960: 203c 206e 656b 313b 202b 2b69 6329 207b   < nek1; ++ic) {
-00062970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00062980: 202f 2f20 6b20 696e 6469 6365 730a 2020   // k indices.  
-00062990: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000629a0: 6e73 7420 696e 7420 696b 3320 3d20 6971  nst int ik3 = iq
-000629b0: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
-000629c0: 2020 2063 6f6e 7374 2069 6e74 2069 6b32     const int ik2
-000629d0: 203d 2069 7132 3b0a 2020 2020 2020 2020   = iq2;.        
-000629e0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000629f0: 7420 696b 3120 3d20 6963 3b0a 0a20 2020  t ik1 = ic;..   
-00062a00: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00062a10: 5320 696e 6469 6365 730a 2020 2020 2020  S indices.      
-00062a20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00062a30: 696e 7420 6931 203d 2069 6b31 3b0a 0a20  int i1 = ik1;.. 
-00062a40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00062a50: 676d 6c5f 7665 635f 646f 745f 6631 3628  gml_vec_dot_f16(
-00062a60: 6e65 7130 2c0a 2020 2020 2020 2020 2020  neq0,.          
-00062a70: 2020 2020 2020 2020 2020 2020 2020 5320                S 
-00062a80: 2b20 6931 2c0a 2020 2020 2020 2020 2020  + i1,.          
-00062a90: 2020 2020 2020 2020 2020 2020 2020 2867                (g
-00062aa0: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
-00062ab0: 6368 6172 202a 2920 6b2d 3e64 6174 6120  char *) k->data 
-00062ac0: 2b20 2869 6b31 2a6e 626b 3120 2b20 696b  + (ik1*nbk1 + ik
-00062ad0: 322a 6e62 6b32 202b 2069 6b33 2a6e 626b  2*nbk2 + ik3*nbk
-00062ae0: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
-00062af0: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
-00062b00: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
-00062b10: 6861 7220 2a29 2071 2d3e 6461 7461 202b  har *) q->data +
-00062b20: 2028 6971 312a 6e62 7131 202b 2069 7132   (iq1*nbq1 + iq2
-00062b30: 2a6e 6271 3220 2b20 6971 332a 6e62 7133  *nbq2 + iq3*nbq3
-00062b40: 2929 293b 0a20 2020 2020 2020 2020 2020  )));.           
-00062b50: 207d 0a20 2020 2020 2020 207d 2065 6c73   }.        } els
-00062b60: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-00062b70: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
-00062b80: 3d20 303b 2069 6320 3c20 6e65 6b31 3b20  = 0; ic < nek1; 
-00062b90: 6963 202b 3d20 4747 4d4c 5f56 4543 5f44  ic += GGML_VEC_D
-00062ba0: 4f54 5f55 4e52 4f4c 4c29 207b 0a20 2020  OT_UNROLL) {.   
-00062bb0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00062bc0: 6b20 696e 6469 6365 730a 2020 2020 2020  k indices.      
-00062bd0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00062be0: 696e 7420 696b 3320 3d20 6971 333b 0a20  int ik3 = iq3;. 
-00062bf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00062c00: 6f6e 7374 2069 6e74 2069 6b32 203d 2069  onst int ik2 = i
-00062c10: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-00062c20: 2020 2020 636f 6e73 7420 696e 7420 696b      const int ik
-00062c30: 3120 3d20 6963 3b0a 0a20 2020 2020 2020  1 = ic;..       
-00062c40: 2020 2020 2020 2020 202f 2f20 5320 696e           // S in
-00062c50: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-00062c60: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00062c70: 6931 203d 2069 6b31 3b0a 0a20 2020 2020  i1 = ik1;..     
-00062c80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00062c90: 7665 635f 646f 745f 6631 365f 756e 726f  vec_dot_f16_unro
-00062ca0: 6c6c 286e 6571 302c 206e 626b 312c 0a20  ll(neq0, nbk1,. 
-00062cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062cc0: 2020 2020 2020 2053 202b 2069 312c 0a20         S + i1,. 
-00062cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062ce0: 2020 2020 2020 2028 2863 6861 7220 2a29         ((char *)
-00062cf0: 206b 2d3e 6461 7461 202b 2028 696b 312a   k->data + (ik1*
-00062d00: 6e62 6b31 202b 2069 6b32 2a6e 626b 3220  nbk1 + ik2*nbk2 
-00062d10: 2b20 696b 332a 6e62 6b33 2929 2c0a 2020  + ik3*nbk3)),.  
-00062d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062d30: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
-00062d40: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
-00062d50: 712d 3e64 6174 6120 2b20 2869 7131 2a6e  q->data + (iq1*n
-00062d60: 6271 3120 2b20 6971 322a 6e62 7132 202b  bq1 + iq2*nbq2 +
-00062d70: 2069 7133 2a6e 6271 3329 2929 3b0a 2020   iq3*nbq3)));.  
-00062d80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00062d90: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-00062da0: 2f20 7363 616c 650a 2020 2020 2020 2020  / scale.        
-00062db0: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
-00062dc0: 3332 286e 656b 312c 2053 2c20 7363 616c  32(nek1, S, scal
-00062dd0: 6529 3b0a 0a20 2020 2020 2020 2069 6620  e);..        if 
-00062de0: 286d 6173 6b65 6429 207b 0a20 2020 2020  (masked) {.     
-00062df0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00062e00: 345f 7420 6920 3d20 503b 2069 203c 204d  4_t i = P; i < M
-00062e10: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00062e20: 2020 2020 2020 2020 2069 6620 2869 203e           if (i >
-00062e30: 2050 202b 2069 7131 2920 7b0a 2020 2020   P + iq1) {.    
-00062e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062e50: 535b 695d 203d 202d 494e 4649 4e49 5459  S[i] = -INFINITY
-00062e60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00062e70: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00062e80: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-00062e90: 2020 2020 202f 2f20 736f 6674 6d61 780a       // softmax.
-00062ea0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00062eb0: 2020 2020 2020 666c 6f61 7420 6d61 7820        float max 
-00062ec0: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
-00062ed0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00062ee0: 635f 6d61 785f 6633 3228 4d2c 2026 6d61  c_max_f32(M, &ma
-00062ef0: 782c 2053 293b 0a0a 2020 2020 2020 2020  x, S);..        
-00062f00: 2020 2020 6767 6d6c 5f66 6c6f 6174 2073      ggml_float s
-00062f10: 756d 203d 2030 2e30 3b0a 2020 2020 2020  um = 0.0;.      
-00062f20: 2020 2020 2020 7b0a 2369 6664 6566 2047        {.#ifdef G
-00062f30: 474d 4c5f 534f 4654 5f4d 4158 5f41 4343  GML_SOFT_MAX_ACC
-00062f40: 454c 4552 4154 450a 2020 2020 2020 2020  ELERATE.        
-00062f50: 2020 2020 2020 2020 6d61 7820 3d20 2d6d          max = -m
-00062f60: 6178 3b0a 2020 2020 2020 2020 2020 2020  ax;.            
-00062f70: 2020 2020 7644 5350 5f76 7361 6464 2853      vDSP_vsadd(S
-00062f80: 2c20 312c 2026 6d61 782c 2053 2c20 312c  , 1, &max, S, 1,
-00062f90: 204d 7570 293b 0a20 2020 2020 2020 2020   Mup);.         
-00062fa0: 2020 2020 2020 2076 7665 7870 6628 532c         vvexpf(S,
-00062fb0: 2053 2c20 264d 7570 293b 0a20 2020 2020   S, &Mup);.     
-00062fc0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00062fd0: 7665 635f 7375 6d5f 6633 3228 4d75 702c  vec_sum_f32(Mup,
-00062fe0: 2026 7375 6d2c 2053 293b 0a23 656c 7365   &sum, S);.#else
-00062ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00063000: 2075 696e 7431 365f 7420 2020 7363 7674   uint16_t   scvt
-00063010: 5b47 474d 4c5f 534f 4654 5f4d 4158 5f55  [GGML_SOFT_MAX_U
-00063020: 4e52 4f4c 4c5d 3b0a 2020 2020 2020 2020  NROLL];.        
-00063030: 2020 2020 2020 2020 6767 6d6c 5f66 6c6f          ggml_flo
-00063040: 6174 2073 756d 705b 4747 4d4c 5f53 4f46  at sump[GGML_SOF
-00063050: 545f 4d41 585f 554e 524f 4c4c 5d20 3d20  T_MAX_UNROLL] = 
-00063060: 7b20 302e 3020 7d3b 0a0a 2020 2020 2020  { 0.0 };..      
-00063070: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00063080: 6e74 2069 203d 2030 3b20 6920 3c20 4d75  nt i = 0; i < Mu
-00063090: 703b 2069 202b 3d20 4747 4d4c 5f53 4f46  p; i += GGML_SOF
-000630a0: 545f 4d41 585f 554e 524f 4c4c 2920 7b0a  T_MAX_UNROLL) {.
-000630b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000630c0: 2020 2020 666c 6f61 7420 2a20 5353 203d      float * SS =
-000630d0: 2053 202b 2069 3b0a 0a20 2020 2020 2020   S + i;..       
-000630e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000630f0: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-00063100: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
-00063110: 4e52 4f4c 4c3b 202b 2b6a 2920 7b0a 2020  NROLL; ++j) {.  
-00063120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063130: 2020 2020 2020 6966 2028 5353 5b6a 5d20        if (SS[j] 
-00063140: 3d3d 202d 494e 4649 4e49 5459 2920 7b0a  == -INFINITY) {.
-00063150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063160: 2020 2020 2020 2020 2020 2020 5353 5b6a              SS[j
-00063170: 5d20 3d20 302e 3066 3b0a 2020 2020 2020  ] = 0.0f;.      
+00061930: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00061940: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00061950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061960: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00061970: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00061980: 303b 2069 203c 2047 474d 4c5f 534f 4654  0; i < GGML_SOFT
+00061990: 5f4d 4158 5f55 4e52 4f4c 4c3b 2069 2b2b  _MAX_UNROLL; i++
+000619a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000619b0: 2020 2020 2020 2020 7375 6d20 2b3d 2073          sum += s
+000619c0: 756d 705b 695d 3b0a 2020 2020 2020 2020  ump[i];.        
+000619d0: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
+000619e0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+000619f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00061a00: 7274 2873 756d 203e 2030 2e30 293b 0a0a  rt(sum > 0.0);..
+00061a10: 2020 2020 2020 2020 2020 2020 7375 6d20              sum 
+00061a20: 3d20 312e 302f 7375 6d3b 0a20 2020 2020  = 1.0/sum;.     
+00061a30: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00061a40: 7363 616c 655f 6633 3228 4d2c 2053 2c20  scale_f32(M, S, 
+00061a50: 7375 6d29 3b0a 0a23 6966 6e64 6566 204e  sum);..#ifndef N
+00061a60: 4445 4255 470a 2020 2020 2020 2020 2020  DEBUG.          
+00061a70: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00061a80: 3b20 6920 3c20 4d3b 202b 2b69 2920 7b0a  ; i < M; ++i) {.
+00061a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061aa0: 6173 7365 7274 2821 6973 6e61 6e28 535b  assert(!isnan(S[
+00061ab0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+00061ac0: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
+00061ad0: 696e 6628 535b 695d 2929 3b0a 2020 2020  inf(S[i]));.    
+00061ae0: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
+00061af0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00061b00: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00061b10: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
+00061b20: 7631 3b20 2b2b 6963 2920 7b0a 2020 2020  v1; ++ic) {.    
+00061b30: 2020 2020 2020 2020 2f2f 2064 7374 2069          // dst i
+00061b40: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+00061b50: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
+00061b60: 3d20 6971 313b 0a20 2020 2020 2020 2020  = iq1;.         
+00061b70: 2020 2063 6f6e 7374 2069 6e74 2069 3220     const int i2 
+00061b80: 3d20 6971 323b 0a20 2020 2020 2020 2020  = iq2;.         
+00061b90: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
+00061ba0: 3d20 6971 333b 0a0a 2020 2020 2020 2020  = iq3;..        
+00061bb0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00061bc0: 5f66 3332 286e 656b 312c 0a20 2020 2020  _f32(nek1,.     
+00061bd0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00061be0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+00061bf0: 2a29 2064 7374 2d3e 6461 7461 202b 2028  *) dst->data + (
+00061c00: 6963 2a6e 6230 202b 2069 312a 6e62 3120  ic*nb0 + i1*nb1 
+00061c10: 202b 2069 322a 6e62 3220 202b 2069 332a   + i2*nb2  + i3*
+00061c20: 6e62 3329 292c 0a20 2020 2020 2020 2020  nb3)),.         
+00061c30: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+00061c40: 7420 2a29 2028 2863 6861 7220 2a29 2076  t *) ((char *) v
+00061c50: 2d3e 6461 7461 2020 202b 2028 2020 2020  ->data   + (    
+00061c60: 2020 2020 2069 632a 6e62 7631 202b 2069       ic*nbv1 + i
+00061c70: 322a 6e62 7632 202b 2069 332a 6e62 7633  2*nbv2 + i3*nbv3
+00061c80: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00061c90: 2020 2020 2020 2020 5329 3b0a 2020 2020          S);.    
+00061ca0: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00061cb0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00061cc0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00061cd0: 666c 6173 685f 6174 746e 5f66 3136 280a  flash_attn_f16(.
+00061ce0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00061cf0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00061d00: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00061d10: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00061d20: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00061d30: 736f 7220 2a20 712c 0a20 2020 2020 2020  sor * q,.       
+00061d40: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00061d50: 6d6c 5f74 656e 736f 7220 2a20 6b2c 0a20  ml_tensor * k,. 
+00061d60: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00061d70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00061d80: 2a20 762c 0a20 2020 2020 2020 2063 6f6e  * v,.        con
+00061d90: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
+00061da0: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00061db0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00061dc0: 2a20 6473 7429 207b 0a20 2020 2069 6e74  * dst) {.    int
+00061dd0: 3634 5f74 2074 3020 3d20 6767 6d6c 5f70  64_t t0 = ggml_p
+00061de0: 6572 665f 7469 6d65 5f75 7328 293b 0a20  erf_time_us();. 
+00061df0: 2020 2055 4e55 5345 4428 7430 293b 0a0a     UNUSED(t0);..
+00061e00: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00061e10: 7420 6e65 7130 203d 2071 2d3e 6e65 5b30  t neq0 = q->ne[0
+00061e20: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00061e30: 3634 5f74 206e 6571 3120 3d20 712d 3e6e  64_t neq1 = q->n
+00061e40: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+00061e50: 696e 7436 345f 7420 6e65 7132 203d 2071  int64_t neq2 = q
+00061e60: 2d3e 6e65 5b32 5d3b 0a20 2020 2063 6f6e  ->ne[2];.    con
+00061e70: 7374 2069 6e74 3634 5f74 206e 6571 3320  st int64_t neq3 
+00061e80: 3d20 712d 3e6e 655b 335d 3b0a 0a20 2020  = q->ne[3];..   
+00061e90: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00061ea0: 656b 3020 3d20 6b2d 3e6e 655b 305d 3b0a  ek0 = k->ne[0];.
+00061eb0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00061ec0: 7420 6e65 6b31 203d 206b 2d3e 6e65 5b31  t nek1 = k->ne[1
+00061ed0: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00061ee0: 6e74 3634 5f74 206e 656b 3220 3d20 6b2d  nt64_t nek2 = k-
+00061ef0: 3e6e 655b 325d 3b0a 2020 2020 2f2f 636f  >ne[2];.    //co
+00061f00: 6e73 7420 696e 7436 345f 7420 6e65 6b33  nst int64_t nek3
+00061f10: 203d 206b 2d3e 6e65 5b33 5d3b 0a0a 2020   = k->ne[3];..  
+00061f20: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
+00061f30: 7420 6e65 7630 203d 2076 2d3e 6e65 5b30  t nev0 = v->ne[0
+00061f40: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00061f50: 3634 5f74 206e 6576 3120 3d20 762d 3e6e  64_t nev1 = v->n
+00061f60: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
+00061f70: 7420 696e 7436 345f 7420 6e65 7632 203d  t int64_t nev2 =
+00061f80: 2076 2d3e 6e65 5b32 5d3b 0a20 2020 202f   v->ne[2];.    /
+00061f90: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00061fa0: 6576 3320 3d20 762d 3e6e 655b 335d 3b0a  ev3 = v->ne[3];.
+00061fb0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00061fc0: 5f74 206e 6530 2020 3d20 6473 742d 3e6e  _t ne0  = dst->n
+00061fd0: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00061fe0: 696e 7436 345f 7420 6e65 3120 203d 2064  int64_t ne1  = d
+00061ff0: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 202f  st->ne[1];.    /
+00062000: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00062010: 6532 2020 3d20 6473 742d 3e6e 655b 325d  e2  = dst->ne[2]
+00062020: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00062030: 7436 345f 7420 6e65 3320 203d 2064 7374  t64_t ne3  = dst
+00062040: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+00062050: 6e73 7420 696e 7420 6e62 6b30 203d 206b  nst int nbk0 = k
+00062060: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+00062070: 7374 2069 6e74 206e 626b 3120 3d20 6b2d  st int nbk1 = k-
+00062080: 3e6e 625b 315d 3b0a 2020 2020 636f 6e73  >nb[1];.    cons
+00062090: 7420 696e 7420 6e62 6b32 203d 206b 2d3e  t int nbk2 = k->
+000620a0: 6e62 5b32 5d3b 0a20 2020 2063 6f6e 7374  nb[2];.    const
+000620b0: 2069 6e74 206e 626b 3320 3d20 6b2d 3e6e   int nbk3 = k->n
+000620c0: 625b 335d 3b0a 0a20 2020 2063 6f6e 7374  b[3];..    const
+000620d0: 2069 6e74 206e 6271 3020 3d20 712d 3e6e   int nbq0 = q->n
+000620e0: 625b 305d 3b0a 2020 2020 636f 6e73 7420  b[0];.    const 
+000620f0: 696e 7420 6e62 7131 203d 2071 2d3e 6e62  int nbq1 = q->nb
+00062100: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+00062110: 6e74 206e 6271 3220 3d20 712d 3e6e 625b  nt nbq2 = q->nb[
+00062120: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00062130: 7420 6e62 7133 203d 2071 2d3e 6e62 5b33  t nbq3 = q->nb[3
+00062140: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00062150: 7420 6e62 7630 203d 2076 2d3e 6e62 5b30  t nbv0 = v->nb[0
+00062160: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00062170: 206e 6276 3120 3d20 762d 3e6e 625b 315d   nbv1 = v->nb[1]
+00062180: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00062190: 6e62 7632 203d 2076 2d3e 6e62 5b32 5d3b  nbv2 = v->nb[2];
+000621a0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000621b0: 6276 3320 3d20 762d 3e6e 625b 335d 3b0a  bv3 = v->nb[3];.
+000621c0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000621d0: 6230 2020 3d20 6473 742d 3e6e 625b 305d  b0  = dst->nb[0]
+000621e0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000621f0: 6e62 3120 203d 2064 7374 2d3e 6e62 5b31  nb1  = dst->nb[1
+00062200: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00062210: 206e 6232 2020 3d20 6473 742d 3e6e 625b   nb2  = dst->nb[
+00062220: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00062230: 7420 6e62 3320 203d 2064 7374 2d3e 6e62  t nb3  = dst->nb
+00062240: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+00062250: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
+00062260: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
+00062270: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
+00062280: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
+00062290: 7374 2069 6e74 3634 5f74 2044 203d 206e  st int64_t D = n
+000622a0: 6571 303b 0a20 2020 2063 6f6e 7374 2069  eq0;.    const i
+000622b0: 6e74 3634 5f74 204e 203d 206e 6571 313b  nt64_t N = neq1;
+000622c0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+000622d0: 5f74 2050 203d 206e 656b 3120 2d20 4e3b  _t P = nek1 - N;
+000622e0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+000622f0: 5f74 204d 203d 2050 202b 204e 3b0a 0a20  _t M = P + N;.. 
+00062300: 2020 2063 6f6e 7374 2069 6e74 204d 7570     const int Mup
+00062310: 203d 2067 676d 6c5f 7570 284d 2c20 4747   = ggml_up(M, GG
+00062320: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
+00062330: 4c4c 293b 0a0a 2020 2020 4747 4d4c 5f41  LL);..    GGML_A
+00062340: 5353 4552 5428 6e65 3020 3d3d 2044 293b  SSERT(ne0 == D);
+00062350: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00062360: 286e 6531 203d 3d20 4e29 3b0a 2020 2020  (ne1 == N);.    
+00062370: 4747 4d4c 5f41 5353 4552 5428 5020 3e3d  GGML_ASSERT(P >=
+00062380: 2030 293b 0a0a 2020 2020 4747 4d4c 5f41   0);..    GGML_A
+00062390: 5353 4552 5428 6e62 7130 203d 3d20 7369  SSERT(nbq0 == si
+000623a0: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+000623b0: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+000623c0: 4552 5428 6e62 6b30 203d 3d20 7369 7a65  ERT(nbk0 == size
+000623d0: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+000623e0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+000623f0: 5428 6e62 7630 203d 3d20 7369 7a65 6f66  T(nbv0 == sizeof
+00062400: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
+00062410: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00062420: 286e 6571 3020 3d3d 2044 293b 0a20 2020  (neq0 == D);.   
+00062430: 2047 474d 4c5f 4153 5345 5254 286e 656b   GGML_ASSERT(nek
+00062440: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
+00062450: 4c5f 4153 5345 5254 286e 6576 3120 3d3d  L_ASSERT(nev1 ==
+00062460: 2044 293b 0a0a 2020 2020 4747 4d4c 5f41   D);..    GGML_A
+00062470: 5353 4552 5428 6e65 7131 203d 3d20 4e29  SSERT(neq1 == N)
+00062480: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00062490: 5428 6e65 6b31 203d 3d20 4e20 2b20 5029  T(nek1 == N + P)
+000624a0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+000624b0: 5428 6e65 7631 203d 3d20 4429 3b0a 0a20  T(nev1 == D);.. 
+000624c0: 2020 202f 2f20 6473 7420 6361 6e6e 6f74     // dst cannot
+000624d0: 2062 6520 7472 616e 7370 6f73 6564 206f   be transposed o
+000624e0: 7220 7065 726d 7574 6564 0a20 2020 2047  r permuted.    G
+000624f0: 474d 4c5f 4153 5345 5254 286e 6230 203d  GML_ASSERT(nb0 =
+00062500: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+00062510: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00062520: 5428 6e62 3020 3c3d 206e 6231 293b 0a20  T(nb0 <= nb1);. 
+00062530: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00062540: 6231 203c 3d20 6e62 3229 3b0a 2020 2020  b1 <= nb2);.    
+00062550: 4747 4d4c 5f41 5353 4552 5428 6e62 3220  GGML_ASSERT(nb2 
+00062560: 3c3d 206e 6233 293b 0a0a 2020 2020 6966  <= nb3);..    if
+00062570: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00062580: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00062590: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+000625a0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
+000625b0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+000625c0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+000625d0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+000625e0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+000625f0: 2020 2020 2f2f 2070 6172 616c 6c65 6c69      // paralleli
+00062600: 7a65 2062 7920 7120 726f 7773 2075 7369  ze by q rows usi
+00062610: 6e67 2067 676d 6c5f 7665 635f 646f 745f  ng ggml_vec_dot_
+00062620: 6633 320a 0a20 2020 202f 2f20 746f 7461  f32..    // tota
+00062630: 6c20 726f 7773 2069 6e20 710a 2020 2020  l rows in q.    
+00062640: 636f 6e73 7420 696e 7420 6e72 203d 206e  const int nr = n
+00062650: 6571 312a 6e65 7132 2a6e 6571 333b 0a0a  eq1*neq2*neq3;..
+00062660: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
+00062670: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+00062680: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
+00062690: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+000626a0: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+000626b0: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+000626c0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+000626d0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
+000626e0: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
+000626f0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
+00062700: 293b 0a0a 2020 2020 636f 6e73 7420 666c  );..    const fl
+00062710: 6f61 7420 7363 616c 6520 3d20 312e 3066  oat scale = 1.0f
+00062720: 2f73 7172 7466 2844 293b 0a0a 2020 2020  /sqrtf(D);..    
+00062730: 2f2f 7072 696e 7466 2822 503d 2564 204e  //printf("P=%d N
+00062740: 3d25 6420 443d 2564 2069 7230 3d25 6420  =%d D=%d ir0=%d 
+00062750: 6972 313d 2564 2073 6361 6c65 203d 2025  ir1=%d scale = %
+00062760: 665c 6e22 2c20 502c 204e 2c20 442c 2069  f\n", P, N, D, i
+00062770: 7230 2c20 6972 312c 2073 6361 6c65 293b  r0, ir1, scale);
+00062780: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00062790: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
+000627a0: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
+000627b0: 2020 202f 2f20 7120 696e 6469 6365 730a     // q indices.
+000627c0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000627d0: 7420 6971 3320 3d20 6972 2f28 6e65 7132  t iq3 = ir/(neq2
+000627e0: 2a6e 6571 3129 3b0a 2020 2020 2020 2020  *neq1);.        
+000627f0: 636f 6e73 7420 696e 7420 6971 3220 3d20  const int iq2 = 
+00062800: 2869 7220 2d20 6971 332a 6e65 7132 2a6e  (ir - iq3*neq2*n
+00062810: 6571 3129 2f6e 6571 313b 0a20 2020 2020  eq1)/neq1;.     
+00062820: 2020 2063 6f6e 7374 2069 6e74 2069 7131     const int iq1
+00062830: 203d 2028 6972 202d 2069 7133 2a6e 6571   = (ir - iq3*neq
+00062840: 322a 6e65 7131 202d 2069 7132 2a6e 6571  2*neq1 - iq2*neq
+00062850: 3129 3b0a 0a20 2020 2020 2020 2066 6c6f  1);..        flo
+00062860: 6174 202a 2053 203d 2028 666c 6f61 7420  at * S = (float 
+00062870: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
+00062880: 202b 2069 7468 2a28 322a 4d75 7020 2b20   + ith*(2*Mup + 
+00062890: 4341 4348 455f 4c49 4e45 5f53 495a 455f  CACHE_LINE_SIZE_
+000628a0: 4633 3229 3b0a 0a20 2020 2020 2020 2066  F32);..        f
+000628b0: 6f72 2028 696e 7420 6920 3d20 4d3b 2069  or (int i = M; i
+000628c0: 203c 204d 7570 3b20 2b2b 6929 207b 0a20   < Mup; ++i) {. 
+000628d0: 2020 2020 2020 2020 2020 2053 5b69 5d20             S[i] 
+000628e0: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
+000628f0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00062900: 6966 2028 4747 4d4c 5f56 4543 5f44 4f54  if (GGML_VEC_DOT
+00062910: 5f55 4e52 4f4c 4c20 3e20 3220 7c7c 206e  _UNROLL > 2 || n
+00062920: 656b 3120 2520 4747 4d4c 5f56 4543 5f44  ek1 % GGML_VEC_D
+00062930: 4f54 5f55 4e52 4f4c 4c20 213d 2030 2920  OT_UNROLL != 0) 
+00062940: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
+00062950: 7220 2869 6e74 3634 5f74 2069 6320 3d20  r (int64_t ic = 
+00062960: 303b 2069 6320 3c20 6e65 6b31 3b20 2b2b  0; ic < nek1; ++
+00062970: 6963 2920 7b0a 2020 2020 2020 2020 2020  ic) {.          
+00062980: 2020 2020 2020 2f2f 206b 2069 6e64 6963        // k indic
+00062990: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+000629a0: 2020 2063 6f6e 7374 2069 6e74 2069 6b33     const int ik3
+000629b0: 203d 2069 7133 3b0a 2020 2020 2020 2020   = iq3;.        
+000629c0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000629d0: 7420 696b 3220 3d20 6971 323b 0a20 2020  t ik2 = iq2;.   
+000629e0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000629f0: 7374 2069 6e74 2069 6b31 203d 2069 633b  st int ik1 = ic;
+00062a00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00062a10: 2020 2f2f 2053 2069 6e64 6963 6573 0a20    // S indices. 
+00062a20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00062a30: 6f6e 7374 2069 6e74 2069 3120 3d20 696b  onst int i1 = ik
+00062a40: 313b 0a0a 2020 2020 2020 2020 2020 2020  1;..            
+00062a50: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00062a60: 5f66 3136 286e 6571 302c 0a20 2020 2020  _f16(neq0,.     
+00062a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062a80: 2020 2053 202b 2069 312c 0a20 2020 2020     S + i1,.     
+00062a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062aa0: 2020 2028 6767 6d6c 5f66 7031 365f 7420     (ggml_fp16_t 
+00062ab0: 2a29 2028 2863 6861 7220 2a29 206b 2d3e  *) ((char *) k->
+00062ac0: 6461 7461 202b 2028 696b 312a 6e62 6b31  data + (ik1*nbk1
+00062ad0: 202b 2069 6b32 2a6e 626b 3220 2b20 696b   + ik2*nbk2 + ik
+00062ae0: 332a 6e62 6b33 2929 2c0a 2020 2020 2020  3*nbk3)),.      
+00062af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062b00: 2020 2867 676d 6c5f 6670 3136 5f74 202a    (ggml_fp16_t *
+00062b10: 2920 2828 6368 6172 202a 2920 712d 3e64  ) ((char *) q->d
+00062b20: 6174 6120 2b20 2869 7131 2a6e 6271 3120  ata + (iq1*nbq1 
+00062b30: 2b20 6971 322a 6e62 7132 202b 2069 7133  + iq2*nbq2 + iq3
+00062b40: 2a6e 6271 3329 2929 3b0a 2020 2020 2020  *nbq3)));.      
+00062b50: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00062b60: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00062b70: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00062b80: 7420 6963 203d 2030 3b20 6963 203c 206e  t ic = 0; ic < n
+00062b90: 656b 313b 2069 6320 2b3d 2047 474d 4c5f  ek1; ic += GGML_
+00062ba0: 5645 435f 444f 545f 554e 524f 4c4c 2920  VEC_DOT_UNROLL) 
+00062bb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00062bc0: 2020 2f2f 206b 2069 6e64 6963 6573 0a20    // k indices. 
+00062bd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00062be0: 6f6e 7374 2069 6e74 2069 6b33 203d 2069  onst int ik3 = i
+00062bf0: 7133 3b0a 2020 2020 2020 2020 2020 2020  q3;.            
+00062c00: 2020 2020 636f 6e73 7420 696e 7420 696b      const int ik
+00062c10: 3220 3d20 6971 323b 0a20 2020 2020 2020  2 = iq2;.       
+00062c20: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00062c30: 6e74 2069 6b31 203d 2069 633b 0a0a 2020  nt ik1 = ic;..  
+00062c40: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00062c50: 2053 2069 6e64 6963 6573 0a20 2020 2020   S indices.     
+00062c60: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00062c70: 2069 6e74 2069 3120 3d20 696b 313b 0a0a   int i1 = ik1;..
+00062c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062c90: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3136  ggml_vec_dot_f16
+00062ca0: 5f75 6e72 6f6c 6c28 6e65 7130 2c20 6e62  _unroll(neq0, nb
+00062cb0: 6b31 2c0a 2020 2020 2020 2020 2020 2020  k1,.            
+00062cc0: 2020 2020 2020 2020 2020 2020 5320 2b20              S + 
+00062cd0: 6931 2c0a 2020 2020 2020 2020 2020 2020  i1,.            
+00062ce0: 2020 2020 2020 2020 2020 2020 2828 6368              ((ch
+00062cf0: 6172 202a 2920 6b2d 3e64 6174 6120 2b20  ar *) k->data + 
+00062d00: 2869 6b31 2a6e 626b 3120 2b20 696b 322a  (ik1*nbk1 + ik2*
+00062d10: 6e62 6b32 202b 2069 6b33 2a6e 626b 3329  nbk2 + ik3*nbk3)
+00062d20: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00062d30: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
+00062d40: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
+00062d50: 7220 2a29 2071 2d3e 6461 7461 202b 2028  r *) q->data + (
+00062d60: 6971 312a 6e62 7131 202b 2069 7132 2a6e  iq1*nbq1 + iq2*n
+00062d70: 6271 3220 2b20 6971 332a 6e62 7133 2929  bq2 + iq3*nbq3))
+00062d80: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00062d90: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00062da0: 2020 2020 2f2f 2073 6361 6c65 0a20 2020      // scale.   
+00062db0: 2020 2020 2067 676d 6c5f 7665 635f 7363       ggml_vec_sc
+00062dc0: 616c 655f 6633 3228 6e65 6b31 2c20 532c  ale_f32(nek1, S,
+00062dd0: 2073 6361 6c65 293b 0a0a 2020 2020 2020   scale);..      
+00062de0: 2020 6966 2028 6d61 736b 6564 2920 7b0a    if (masked) {.
+00062df0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00062e00: 2869 6e74 3634 5f74 2069 203d 2050 3b20  (int64_t i = P; 
+00062e10: 6920 3c20 4d3b 2069 2b2b 2920 7b0a 2020  i < M; i++) {.  
+00062e20: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00062e30: 2028 6920 3e20 5020 2b20 6971 3129 207b   (i > P + iq1) {
+00062e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00062e50: 2020 2020 2053 5b69 5d20 3d20 2d49 4e46       S[i] = -INF
+00062e60: 494e 4954 593b 0a20 2020 2020 2020 2020  INITY;.         
+00062e70: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00062e80: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00062e90: 0a0a 2020 2020 2020 2020 2f2f 2073 6f66  ..        // sof
+00062ea0: 746d 6178 0a20 2020 2020 2020 207b 0a20  tmax.        {. 
+00062eb0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00062ec0: 206d 6178 203d 202d 494e 4649 4e49 5459   max = -INFINITY
+00062ed0: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
+00062ee0: 6d6c 5f76 6563 5f6d 6178 5f66 3332 284d  ml_vec_max_f32(M
+00062ef0: 2c20 266d 6178 2c20 5329 3b0a 0a20 2020  , &max, S);..   
+00062f00: 2020 2020 2020 2020 2067 676d 6c5f 666c           ggml_fl
+00062f10: 6f61 7420 7375 6d20 3d20 302e 303b 0a20  oat sum = 0.0;. 
+00062f20: 2020 2020 2020 2020 2020 207b 0a23 6966             {.#if
+00062f30: 6465 6620 4747 4d4c 5f53 4f46 545f 4d41  def GGML_SOFT_MA
+00062f40: 585f 4143 4345 4c45 5241 5445 0a20 2020  X_ACCELERATE.   
+00062f50: 2020 2020 2020 2020 2020 2020 206d 6178               max
+00062f60: 203d 202d 6d61 783b 0a20 2020 2020 2020   = -max;.       
+00062f70: 2020 2020 2020 2020 2076 4453 505f 7673           vDSP_vs
+00062f80: 6164 6428 532c 2031 2c20 266d 6178 2c20  add(S, 1, &max, 
+00062f90: 532c 2031 2c20 4d75 7029 3b0a 2020 2020  S, 1, Mup);.    
+00062fa0: 2020 2020 2020 2020 2020 2020 7676 6578              vvex
+00062fb0: 7066 2853 2c20 532c 2026 4d75 7029 3b0a  pf(S, S, &Mup);.
+00062fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062fd0: 6767 6d6c 5f76 6563 5f73 756d 5f66 3332  ggml_vec_sum_f32
+00062fe0: 284d 7570 2c20 2673 756d 2c20 5329 3b0a  (Mup, &sum, S);.
+00062ff0: 2365 6c73 650a 2020 2020 2020 2020 2020  #else.          
+00063000: 2020 2020 2020 7569 6e74 3136 5f74 2020        uint16_t  
+00063010: 2073 6376 745b 4747 4d4c 5f53 4f46 545f   scvt[GGML_SOFT_
+00063020: 4d41 585f 554e 524f 4c4c 5d3b 0a20 2020  MAX_UNROLL];.   
+00063030: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00063040: 6c5f 666c 6f61 7420 7375 6d70 5b47 474d  l_float sump[GGM
+00063050: 4c5f 534f 4654 5f4d 4158 5f55 4e52 4f4c  L_SOFT_MAX_UNROL
+00063060: 4c5d 203d 207b 2030 2e30 207d 3b0a 0a20  L] = { 0.0 };.. 
+00063070: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00063080: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00063090: 203c 204d 7570 3b20 6920 2b3d 2047 474d   < Mup; i += GGM
+000630a0: 4c5f 534f 4654 5f4d 4158 5f55 4e52 4f4c  L_SOFT_MAX_UNROL
+000630b0: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+000630c0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+000630d0: 2053 5320 3d20 5320 2b20 693b 0a0a 2020   SS = S + i;..  
+000630e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000630f0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
+00063100: 3b20 6a20 3c20 4747 4d4c 5f53 4f46 545f  ; j < GGML_SOFT_
+00063110: 4d41 585f 554e 524f 4c4c 3b20 2b2b 6a29  MAX_UNROLL; ++j)
+00063120: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00063130: 2020 2020 2020 2020 2020 2069 6620 2853             if (S
+00063140: 535b 6a5d 203d 3d20 2d49 4e46 494e 4954  S[j] == -INFINIT
+00063150: 5929 207b 0a20 2020 2020 2020 2020 2020  Y) {.           
+00063160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063170: 2053 535b 6a5d 203d 2030 2e30 663b 0a20   SS[j] = 0.0f;. 
 00063180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063190: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00063190: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
 000631a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000631b0: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-000631c0: 5f74 2073 203d 2047 474d 4c5f 4650 3332  _t s = GGML_FP32
-000631d0: 5f54 4f5f 4650 3136 2853 535b 6a5d 202d  _TO_FP16(SS[j] -
-000631e0: 206d 6178 293b 0a20 2020 2020 2020 2020   max);.         
+000631b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000631c0: 5f66 7031 365f 7420 7320 3d20 4747 4d4c  _fp16_t s = GGML
+000631d0: 5f46 5033 325f 544f 5f46 5031 3628 5353  _FP32_TO_FP16(SS
+000631e0: 5b6a 5d20 2d20 6d61 7829 3b0a 2020 2020  [j] - max);.    
 000631f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063200: 2020 206d 656d 6370 7928 2673 6376 745b     memcpy(&scvt[
-00063210: 6a5d 2c20 2673 2c20 7369 7a65 6f66 2875  j], &s, sizeof(u
-00063220: 696e 7431 365f 7429 293b 0a20 2020 2020  int16_t));.     
+00063200: 2020 2020 2020 2020 6d65 6d63 7079 2826          memcpy(&
+00063210: 7363 7674 5b6a 5d2c 2026 732c 2073 697a  scvt[j], &s, siz
+00063220: 656f 6628 7569 6e74 3136 5f74 2929 3b0a  eof(uint16_t));.
 00063230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063240: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-00063250: 6174 2076 616c 203d 2047 474d 4c5f 4650  at val = GGML_FP
-00063260: 3136 5f54 4f5f 4650 3332 2874 6162 6c65  16_TO_FP32(table
-00063270: 5f65 7870 5f66 3136 5b73 6376 745b 6a5d  _exp_f16[scvt[j]
-00063280: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+00063240: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00063250: 7420 666c 6f61 7420 7661 6c20 3d20 4747  t float val = GG
+00063260: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+00063270: 7461 626c 655f 6578 705f 6631 365b 7363  table_exp_f16[sc
+00063280: 7674 5b6a 5d5d 293b 0a20 2020 2020 2020  vt[j]]);.       
 00063290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000632a0: 7375 6d70 5b6a 5d20 2b3d 2028 6767 6d6c  sump[j] += (ggml
-000632b0: 5f66 6c6f 6174 2976 616c 3b0a 2020 2020  _float)val;.    
-000632c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000632d0: 2020 2020 2020 2020 5353 5b6a 5d20 3d20          SS[j] = 
-000632e0: 7661 6c3b 0a20 2020 2020 2020 2020 2020  val;.           
-000632f0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00063300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063310: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00063320: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00063330: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00063340: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
-00063350: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
-00063360: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00063370: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-00063380: 202b 3d20 7375 6d70 5b69 5d3b 0a20 2020   += sump[i];.   
-00063390: 2020 2020 2020 2020 2020 2020 207d 0a23               }.#
-000633a0: 656e 6469 660a 2020 2020 2020 2020 2020  endif.          
-000633b0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-000633c0: 2061 7373 6572 7428 7375 6d20 3e20 302e   assert(sum > 0.
-000633d0: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
-000633e0: 2073 756d 203d 2031 2e30 2f73 756d 3b0a   sum = 1.0/sum;.
-000633f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00063400: 5f76 6563 5f73 6361 6c65 5f66 3332 284d  _vec_scale_f32(M
-00063410: 2c20 532c 2073 756d 293b 0a0a 2369 666e  , S, sum);..#ifn
-00063420: 6465 6620 4e44 4542 5547 0a20 2020 2020  def NDEBUG.     
-00063430: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00063440: 6920 3d20 303b 2069 203c 204d 3b20 2b2b  i = 0; i < M; ++
-00063450: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
-00063460: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
-00063470: 616e 2853 5b69 5d29 293b 0a20 2020 2020  an(S[i]));.     
-00063480: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00063490: 7428 2169 7369 6e66 2853 5b69 5d29 293b  t(!isinf(S[i]));
-000634a0: 0a20 2020 2020 2020 2020 2020 207d 0a23  .            }.#
-000634b0: 656e 6469 660a 2020 2020 2020 2020 7d0a  endif.        }.
-000634c0: 0a20 2020 2020 2020 2067 676d 6c5f 6670  .        ggml_fp
-000634d0: 3136 5f74 202a 2053 3136 203d 2028 6767  16_t * S16 = (gg
-000634e0: 6d6c 5f66 7031 365f 7420 2a29 2028 2866  ml_fp16_t *) ((f
-000634f0: 6c6f 6174 202a 2920 7061 7261 6d73 2d3e  loat *) params->
-00063500: 7764 6174 6120 2b20 6974 682a 2832 2a4d  wdata + ith*(2*M
-00063510: 7570 202b 2043 4143 4845 5f4c 494e 455f  up + CACHE_LINE_
-00063520: 5349 5a45 5f46 3332 2920 2b20 4d75 7029  SIZE_F32) + Mup)
-00063530: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-00063540: 696e 7436 345f 7420 6920 3d20 303b 2069  int64_t i = 0; i
-00063550: 203c 204d 3b20 692b 2b29 207b 0a20 2020   < M; i++) {.   
-00063560: 2020 2020 2020 2020 2053 3136 5b69 5d20           S16[i] 
-00063570: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
-00063580: 5031 3628 535b 695d 293b 0a20 2020 2020  P16(S[i]);.     
-00063590: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-000635a0: 2028 4747 4d4c 5f56 4543 5f44 4f54 5f55   (GGML_VEC_DOT_U
-000635b0: 4e52 4f4c 4c20 3d3d 2031 207c 7c20 286e  NROLL == 1 || (n
-000635c0: 6576 3120 2520 4747 4d4c 5f56 4543 5f44  ev1 % GGML_VEC_D
-000635d0: 4f54 5f55 4e52 4f4c 4c20 213d 2030 2929  OT_UNROLL != 0))
-000635e0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-000635f0: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
-00063600: 2030 3b20 6963 203c 206e 6576 313b 202b   0; ic < nev1; +
-00063610: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
-00063620: 2020 2020 2020 202f 2f20 6473 7420 696e         // dst in
-00063630: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-00063640: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00063650: 6931 203d 2069 7131 3b0a 2020 2020 2020  i1 = iq1;.      
-00063660: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00063670: 696e 7420 6932 203d 2069 7132 3b0a 2020  int i2 = iq2;.  
-00063680: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00063690: 6e73 7420 696e 7420 6933 203d 2069 7133  nst int i3 = iq3
-000636a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000636b0: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
-000636c0: 6631 3628 6e65 6b31 2c0a 2020 2020 2020  f16(nek1,.      
+000632a0: 2020 2020 2073 756d 705b 6a5d 202b 3d20       sump[j] += 
+000632b0: 2867 676d 6c5f 666c 6f61 7429 7661 6c3b  (ggml_float)val;
+000632c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000632d0: 2020 2020 2020 2020 2020 2020 2053 535b               SS[
+000632e0: 6a5d 203d 2076 616c 3b0a 2020 2020 2020  j] = val;.      
+000632f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063300: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00063310: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00063320: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00063330: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00063340: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00063350: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
+00063360: 4e52 4f4c 4c3b 2069 2b2b 2920 7b0a 2020  NROLL; i++) {.  
+00063370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063380: 2020 7375 6d20 2b3d 2073 756d 705b 695d    sum += sump[i]
+00063390: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000633a0: 2020 7d0a 2365 6e64 6966 0a20 2020 2020    }.#endif.     
+000633b0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+000633c0: 2020 2020 2020 6173 7365 7274 2873 756d        assert(sum
+000633d0: 203e 2030 2e30 293b 0a0a 2020 2020 2020   > 0.0);..      
+000633e0: 2020 2020 2020 7375 6d20 3d20 312e 302f        sum = 1.0/
+000633f0: 7375 6d3b 0a20 2020 2020 2020 2020 2020  sum;.           
+00063400: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
+00063410: 6633 3228 4d2c 2053 2c20 7375 6d29 3b0a  f32(M, S, sum);.
+00063420: 0a23 6966 6e64 6566 204e 4445 4255 470a  .#ifndef NDEBUG.
+00063430: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00063440: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00063450: 4d3b 202b 2b69 2920 7b0a 2020 2020 2020  M; ++i) {.      
+00063460: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00063470: 2821 6973 6e61 6e28 535b 695d 2929 3b0a  (!isnan(S[i]));.
+00063480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063490: 6173 7365 7274 2821 6973 696e 6628 535b  assert(!isinf(S[
+000634a0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+000634b0: 2020 7d0a 2365 6e64 6966 0a20 2020 2020    }.#endif.     
+000634c0: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
+000634d0: 6d6c 5f66 7031 365f 7420 2a20 5331 3620  ml_fp16_t * S16 
+000634e0: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+000634f0: 2920 2828 666c 6f61 7420 2a29 2070 6172  ) ((float *) par
+00063500: 616d 732d 3e77 6461 7461 202b 2069 7468  ams->wdata + ith
+00063510: 2a28 322a 4d75 7020 2b20 4341 4348 455f  *(2*Mup + CACHE_
+00063520: 4c49 4e45 5f53 495a 455f 4633 3229 202b  LINE_SIZE_F32) +
+00063530: 204d 7570 293b 0a0a 2020 2020 2020 2020   Mup);..        
+00063540: 666f 7220 2869 6e74 3634 5f74 2069 203d  for (int64_t i =
+00063550: 2030 3b20 6920 3c20 4d3b 2069 2b2b 2920   0; i < M; i++) 
+00063560: 7b0a 2020 2020 2020 2020 2020 2020 5331  {.            S1
+00063570: 365b 695d 203d 2047 474d 4c5f 4650 3332  6[i] = GGML_FP32
+00063580: 5f54 4f5f 4650 3136 2853 5b69 5d29 3b0a  _TO_FP16(S[i]);.
+00063590: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000635a0: 2020 2069 6620 2847 474d 4c5f 5645 435f     if (GGML_VEC_
+000635b0: 444f 545f 554e 524f 4c4c 203d 3d20 3120  DOT_UNROLL == 1 
+000635c0: 7c7c 2028 6e65 7631 2025 2047 474d 4c5f  || (nev1 % GGML_
+000635d0: 5645 435f 444f 545f 554e 524f 4c4c 2021  VEC_DOT_UNROLL !
+000635e0: 3d20 3029 2920 7b0a 2020 2020 2020 2020  = 0)) {.        
+000635f0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00063600: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
+00063610: 7631 3b20 2b2b 6963 2920 7b0a 2020 2020  v1; ++ic) {.    
+00063620: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
+00063630: 7374 2069 6e64 6963 6573 0a20 2020 2020  st indices.     
+00063640: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00063650: 2069 6e74 2069 3120 3d20 6971 313b 0a20   int i1 = iq1;. 
+00063660: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00063670: 6f6e 7374 2069 6e74 2069 3220 3d20 6971  onst int i2 = iq
+00063680: 323b 0a20 2020 2020 2020 2020 2020 2020  2;.             
+00063690: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
+000636a0: 3d20 6971 333b 0a0a 2020 2020 2020 2020  = iq3;..        
+000636b0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+000636c0: 5f64 6f74 5f66 3136 286e 656b 312c 0a20  _dot_f16(nek1,. 
 000636d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000636e0: 2020 2866 6c6f 6174 202a 2920 2020 2020    (float *)     
-000636f0: 2020 2828 6368 6172 202a 2920 6473 742d    ((char *) dst-
-00063700: 3e64 6174 6120 2b20 2869 632a 6e62 3020  >data + (ic*nb0 
-00063710: 2b20 6931 2a6e 6231 2020 2b20 6932 2a6e  + i1*nb1  + i2*n
-00063720: 6232 2020 2b20 6933 2a6e 6233 2929 2c0a  b2  + i3*nb3)),.
-00063730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063740: 2020 2020 2020 2020 2867 676d 6c5f 6670          (ggml_fp
-00063750: 3136 5f74 202a 2920 2828 6368 6172 202a  16_t *) ((char *
-00063760: 2920 762d 3e64 6174 6120 2020 2b20 2820  ) v->data   + ( 
-00063770: 2020 2020 2020 2020 6963 2a6e 6276 3120          ic*nbv1 
-00063780: 2b20 6932 2a6e 6276 3220 2b20 6933 2a6e  + i2*nbv2 + i3*n
-00063790: 6276 3329 292c 0a20 2020 2020 2020 2020  bv3)),.         
-000637a0: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-000637b0: 3136 293b 0a20 2020 2020 2020 2020 2020  16);.           
-000637c0: 207d 0a20 2020 2020 2020 207d 2065 6c73   }.        } els
-000637d0: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-000637e0: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
-000637f0: 3d20 303b 2069 6320 3c20 6e65 7631 3b20  = 0; ic < nev1; 
-00063800: 6963 202b 3d20 4747 4d4c 5f56 4543 5f44  ic += GGML_VEC_D
-00063810: 4f54 5f55 4e52 4f4c 4c29 207b 0a20 2020  OT_UNROLL) {.   
-00063820: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00063830: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-00063840: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00063850: 7420 696e 7420 6931 203d 2069 7131 3b0a  t int i1 = iq1;.
-00063860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063870: 636f 6e73 7420 696e 7420 6932 203d 2069  const int i2 = i
-00063880: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-00063890: 2020 2020 636f 6e73 7420 696e 7420 6933      const int i3
-000638a0: 203d 2069 7133 3b0a 0a20 2020 2020 2020   = iq3;..       
-000638b0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-000638c0: 635f 646f 745f 6631 365f 756e 726f 6c6c  c_dot_f16_unroll
-000638d0: 286e 656b 312c 206e 6276 312c 0a20 2020  (nek1, nbv1,.   
-000638e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000638f0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-00063900: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-00063910: 7461 202b 2028 6963 2a6e 6230 202b 2069  ta + (ic*nb0 + i
-00063920: 312a 6e62 3120 202b 2069 322a 6e62 3220  1*nb1  + i2*nb2 
-00063930: 202b 2069 332a 6e62 3329 292c 0a20 2020   + i3*nb3)),.   
-00063940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063950: 2020 2020 2028 2863 6861 7220 2a29 2076       ((char *) v
-00063960: 2d3e 6461 7461 2020 202b 2028 2020 2020  ->data   + (    
-00063970: 2020 2020 2069 632a 6e62 7631 202b 2069       ic*nbv1 + i
-00063980: 322a 6e62 7632 202b 2069 332a 6e62 7633  2*nbv2 + i3*nbv3
-00063990: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-000639a0: 2020 2020 2020 2020 2020 2020 5331 3629              S16)
-000639b0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-000639c0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-000639d0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-000639e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000639f0: 6172 645f 666c 6173 685f 6174 746e 280a  ard_flash_attn(.
-00063a00: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00063a10: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00063a20: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00063a30: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00063a40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00063a50: 736f 7220 2a20 712c 0a20 2020 2020 2020  sor * q,.       
-00063a60: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00063a70: 6d6c 5f74 656e 736f 7220 2a20 6b2c 0a20  ml_tensor * k,. 
-00063a80: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00063a90: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00063aa0: 2a20 762c 0a20 2020 2020 2020 2063 6f6e  * v,.        con
-00063ab0: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
-00063ac0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00063ad0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00063ae0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-00063af0: 712d 3e74 7970 6529 207b 0a20 2020 2020  q->type) {.     
-00063b00: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00063b10: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
-00063b20: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00063b30: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00063b40: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
-00063b50: 6174 746e 5f66 3136 2870 6172 616d 732c  attn_f16(params,
-00063b60: 2071 2c20 6b2c 2076 2c20 6d61 736b 6564   q, k, v, masked
-00063b70: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-00063b80: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00063b90: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00063ba0: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-00063bb0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00063bc0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00063bd0: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
-00063be0: 685f 6174 746e 5f66 3332 2870 6172 616d  h_attn_f32(param
-00063bf0: 732c 2071 2c20 6b2c 2076 2c20 6d61 736b  s, q, k, v, mask
-00063c00: 6564 2c20 6473 7429 3b0a 2020 2020 2020  ed, dst);.      
-00063c10: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00063c20: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-00063c30: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00063c40: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00063c50: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00063c60: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00063c70: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00063c80: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-00063c90: 666f 7277 6172 645f 666c 6173 685f 6666  forward_flash_ff
-00063ca0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00063cb0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00063cc0: 7264 5f66 6c61 7368 5f66 665f 6631 3628  rd_flash_ff_f16(
-00063cd0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00063ce0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00063cf0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00063d00: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00063d10: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00063d20: 6e73 6f72 202a 2061 2c20 202f 2f20 4631  nsor * a,  // F1
-00063d30: 360a 2020 2020 2020 2020 636f 6e73 7420  6.        const 
-00063d40: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00063d50: 6f72 202a 2062 302c 202f 2f20 4631 3620  or * b0, // F16 
-00063d60: 6663 5f77 0a20 2020 2020 2020 2063 6f6e  fc_w.        con
-00063d70: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00063d80: 656e 736f 7220 2a20 6231 2c20 2f2f 2046  ensor * b1, // F
-00063d90: 3332 2066 635f 620a 2020 2020 2020 2020  32 fc_b.        
-00063da0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00063db0: 6c5f 7465 6e73 6f72 202a 2063 302c 202f  l_tensor * c0, /
-00063dc0: 2f20 4631 3620 7072 6f6a 5f77 0a20 2020  / F16 proj_w.   
-00063dd0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00063de0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00063df0: 6331 2c20 2f2f 2046 3332 2070 726f 6a5f  c1, // F32 proj_
-00063e00: 620a 2020 2020 2020 2020 7374 7275 6374  b.        struct
-00063e10: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00063e20: 7374 2920 7b0a 2020 2020 696e 7436 345f  st) {.    int64_
-00063e30: 7420 7430 203d 2067 676d 6c5f 7065 7266  t t0 = ggml_perf
-00063e40: 5f74 696d 655f 7573 2829 3b0a 2020 2020  _time_us();.    
-00063e50: 554e 5553 4544 2874 3029 3b0a 0a20 2020  UNUSED(t0);..   
-00063e60: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00063e70: 6561 3020 3d20 612d 3e6e 655b 305d 3b0a  ea0 = a->ne[0];.
-00063e80: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00063e90: 7420 6e65 6131 203d 2061 2d3e 6e65 5b31  t nea1 = a->ne[1
-00063ea0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00063eb0: 3634 5f74 206e 6561 3220 3d20 612d 3e6e  64_t nea2 = a->n
-00063ec0: 655b 325d 3b0a 2020 2020 636f 6e73 7420  e[2];.    const 
-00063ed0: 696e 7436 345f 7420 6e65 6133 203d 2061  int64_t nea3 = a
-00063ee0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
-00063ef0: 6e73 7420 696e 7436 345f 7420 6e65 6230  nst int64_t neb0
-00063f00: 3020 3d20 6230 2d3e 6e65 5b30 5d3b 0a20  0 = b0->ne[0];. 
-00063f10: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00063f20: 206e 6562 3031 203d 2062 302d 3e6e 655b   neb01 = b0->ne[
-00063f30: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
-00063f40: 696e 7436 345f 7420 6e65 6230 3220 3d20  int64_t neb02 = 
-00063f50: 6230 2d3e 6e65 5b32 5d3b 0a20 2020 202f  b0->ne[2];.    /
-00063f60: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
-00063f70: 6562 3033 203d 2062 302d 3e6e 655b 335d  eb03 = b0->ne[3]
-00063f80: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00063f90: 3634 5f74 206e 6562 3130 203d 2062 312d  64_t neb10 = b1-
-00063fa0: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-00063fb0: 7420 696e 7436 345f 7420 6e65 6231 3120  t int64_t neb11 
-00063fc0: 3d20 6231 2d3e 6e65 5b31 5d3b 0a20 2020  = b1->ne[1];.   
-00063fd0: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-00063fe0: 206e 6562 3132 203d 2062 312d 3e6e 655b   neb12 = b1->ne[
-00063ff0: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
-00064000: 696e 7436 345f 7420 6e65 6231 3320 3d20  int64_t neb13 = 
-00064010: 6231 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  b1->ne[3];..    
-00064020: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00064030: 6330 3020 3d20 6330 2d3e 6e65 5b30 5d3b  c00 = c0->ne[0];
-00064040: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00064050: 5f74 206e 6563 3031 203d 2063 302d 3e6e  _t nec01 = c0->n
-00064060: 655b 315d 3b0a 2020 2020 2f2f 636f 6e73  e[1];.    //cons
-00064070: 7420 696e 7436 345f 7420 6e65 6330 3220  t int64_t nec02 
-00064080: 3d20 6330 2d3e 6e65 5b32 5d3b 0a20 2020  = c0->ne[2];.   
-00064090: 202f 2f63 6f6e 7374 2069 6e74 3634 5f74   //const int64_t
-000640a0: 206e 6563 3033 203d 2063 302d 3e6e 655b   nec03 = c0->ne[
-000640b0: 335d 3b0a 0a20 2020 2063 6f6e 7374 2069  3];..    const i
-000640c0: 6e74 3634 5f74 206e 6563 3130 203d 2063  nt64_t nec10 = c
-000640d0: 312d 3e6e 655b 305d 3b0a 2020 2020 636f  1->ne[0];.    co
-000640e0: 6e73 7420 696e 7436 345f 7420 6e65 6331  nst int64_t nec1
-000640f0: 3120 3d20 6331 2d3e 6e65 5b31 5d3b 0a20  1 = c1->ne[1];. 
-00064100: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
-00064110: 5f74 206e 6563 3132 203d 2063 312d 3e6e  _t nec12 = c1->n
-00064120: 655b 325d 3b0a 2020 2020 2f2f 636f 6e73  e[2];.    //cons
-00064130: 7420 696e 7436 345f 7420 6e65 6331 3320  t int64_t nec13 
-00064140: 3d20 6331 2d3e 6e65 5b33 5d3b 0a0a 2020  = c1->ne[3];..  
-00064150: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00064160: 6e65 3020 3d20 6473 742d 3e6e 655b 305d  ne0 = dst->ne[0]
-00064170: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00064180: 345f 7420 6e65 3120 3d20 6473 742d 3e6e  4_t ne1 = dst->n
-00064190: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
-000641a0: 696e 7436 345f 7420 6e65 3220 3d20 6473  int64_t ne2 = ds
-000641b0: 742d 3e6e 655b 325d 3b0a 2020 2020 2f2f  t->ne[2];.    //
-000641c0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-000641d0: 3320 3d20 6473 742d 3e6e 655b 335d 3b0a  3 = dst->ne[3];.
-000641e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000641f0: 6261 3020 3d20 612d 3e6e 625b 305d 3b0a  ba0 = a->nb[0];.
-00064200: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-00064210: 6131 203d 2061 2d3e 6e62 5b31 5d3b 0a20  a1 = a->nb[1];. 
-00064220: 2020 2063 6f6e 7374 2069 6e74 206e 6261     const int nba
-00064230: 3220 3d20 612d 3e6e 625b 325d 3b0a 2020  2 = a->nb[2];.  
-00064240: 2020 636f 6e73 7420 696e 7420 6e62 6133    const int nba3
-00064250: 203d 2061 2d3e 6e62 5b33 5d3b 0a0a 2020   = a->nb[3];..  
-00064260: 2020 636f 6e73 7420 696e 7420 6e62 6230    const int nbb0
-00064270: 3020 3d20 6230 2d3e 6e62 5b30 5d3b 0a20  0 = b0->nb[0];. 
-00064280: 2020 2063 6f6e 7374 2069 6e74 206e 6262     const int nbb
-00064290: 3031 203d 2062 302d 3e6e 625b 315d 3b0a  01 = b0->nb[1];.
-000642a0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-000642b0: 6230 3220 3d20 6230 2d3e 6e62 5b32 5d3b  b02 = b0->nb[2];
-000642c0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000642d0: 6262 3033 203d 2062 302d 3e6e 625b 335d  bb03 = b0->nb[3]
-000642e0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-000642f0: 206e 6262 3130 203d 2062 312d 3e6e 625b   nbb10 = b1->nb[
-00064300: 305d 3b0a 2020 2020 2f2f 636f 6e73 7420  0];.    //const 
-00064310: 696e 7420 6e62 6231 3120 3d20 6231 2d3e  int nbb11 = b1->
-00064320: 6e62 5b31 5d3b 0a20 2020 202f 2f63 6f6e  nb[1];.    //con
-00064330: 7374 2069 6e74 206e 6262 3132 203d 2062  st int nbb12 = b
-00064340: 312d 3e6e 625b 325d 3b0a 2020 2020 2f2f  1->nb[2];.    //
-00064350: 636f 6e73 7420 696e 7420 6e62 6231 3320  const int nbb13 
-00064360: 3d20 6231 2d3e 6e62 5b33 5d3b 0a0a 2020  = b1->nb[3];..  
-00064370: 2020 636f 6e73 7420 696e 7420 6e62 6330    const int nbc0
-00064380: 3020 3d20 6330 2d3e 6e62 5b30 5d3b 0a20  0 = c0->nb[0];. 
-00064390: 2020 2063 6f6e 7374 2069 6e74 206e 6263     const int nbc
-000643a0: 3031 203d 2063 302d 3e6e 625b 315d 3b0a  01 = c0->nb[1];.
-000643b0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-000643c0: 6330 3220 3d20 6330 2d3e 6e62 5b32 5d3b  c02 = c0->nb[2];
-000643d0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000643e0: 6263 3033 203d 2063 302d 3e6e 625b 335d  bc03 = c0->nb[3]
-000643f0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00064400: 206e 6263 3130 203d 2063 312d 3e6e 625b   nbc10 = c1->nb[
-00064410: 305d 3b0a 2020 2020 2f2f 636f 6e73 7420  0];.    //const 
-00064420: 696e 7420 6e62 6331 3120 3d20 6331 2d3e  int nbc11 = c1->
-00064430: 6e62 5b31 5d3b 0a20 2020 202f 2f63 6f6e  nb[1];.    //con
-00064440: 7374 2069 6e74 206e 6263 3132 203d 2063  st int nbc12 = c
-00064450: 312d 3e6e 625b 325d 3b0a 2020 2020 2f2f  1->nb[2];.    //
-00064460: 636f 6e73 7420 696e 7420 6e62 6331 3320  const int nbc13 
-00064470: 3d20 6331 2d3e 6e62 5b33 5d3b 0a0a 2020  = c1->nb[3];..  
-00064480: 2020 636f 6e73 7420 696e 7420 6e62 3020    const int nb0 
-00064490: 3d20 6473 742d 3e6e 625b 305d 3b0a 2020  = dst->nb[0];.  
-000644a0: 2020 636f 6e73 7420 696e 7420 6e62 3120    const int nb1 
-000644b0: 3d20 6473 742d 3e6e 625b 315d 3b0a 2020  = dst->nb[1];.  
-000644c0: 2020 636f 6e73 7420 696e 7420 6e62 3220    const int nb2 
-000644d0: 3d20 6473 742d 3e6e 625b 325d 3b0a 2020  = dst->nb[2];.  
-000644e0: 2020 636f 6e73 7420 696e 7420 6e62 3320    const int nb3 
-000644f0: 3d20 6473 742d 3e6e 625b 335d 3b0a 0a20  = dst->nb[3];.. 
-00064500: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00064510: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00064520: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00064530: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-00064540: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00064550: 345f 7420 4420 3d20 6e65 6130 3b0a 2020  4_t D = nea0;.  
-00064560: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
-00064570: 7420 4e20 3d20 6e65 6131 3b0a 2020 2020  t N = nea1;.    
-00064580: 636f 6e73 7420 696e 7436 345f 7420 4d20  const int64_t M 
-00064590: 3d20 6e65 6230 313b 0a0a 2020 2020 4747  = neb01;..    GG
-000645a0: 4d4c 5f41 5353 4552 5428 6e65 3020 3d3d  ML_ASSERT(ne0 ==
-000645b0: 206e 6561 3029 3b0a 2020 2020 4747 4d4c   nea0);.    GGML
-000645c0: 5f41 5353 4552 5428 6e65 3120 3d3d 206e  _ASSERT(ne1 == n
-000645d0: 6561 3129 3b0a 2020 2020 4747 4d4c 5f41  ea1);.    GGML_A
-000645e0: 5353 4552 5428 6e65 3220 3d3d 206e 6561  SSERT(ne2 == nea
-000645f0: 3229 3b0a 0a20 2020 2047 474d 4c5f 4153  2);..    GGML_AS
-00064600: 5345 5254 286e 6261 3020 203d 3d20 7369  SERT(nba0  == si
-00064610: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
-00064620: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
-00064630: 4552 5428 6e62 6230 3020 3d3d 2073 697a  ERT(nbb00 == siz
-00064640: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-00064650: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00064660: 5254 286e 6262 3130 203d 3d20 7369 7a65  RT(nbb10 == size
-00064670: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
-00064680: 4747 4d4c 5f41 5353 4552 5428 6e62 6330  GGML_ASSERT(nbc0
-00064690: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
-000646a0: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
-000646b0: 474d 4c5f 4153 5345 5254 286e 6263 3130  GML_ASSERT(nbc10
-000646c0: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-000646d0: 2929 3b0a 0a20 2020 2047 474d 4c5f 4153  ));..    GGML_AS
-000646e0: 5345 5254 286e 6562 3030 203d 3d20 4429  SERT(neb00 == D)
-000646f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00064700: 5428 6e65 6230 3120 3d3d 204d 293b 0a20  T(neb01 == M);. 
-00064710: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00064720: 6562 3130 203d 3d20 4d29 3b0a 2020 2020  eb10 == M);.    
-00064730: 4747 4d4c 5f41 5353 4552 5428 6e65 6231  GGML_ASSERT(neb1
-00064740: 3120 3d3d 2031 293b 0a0a 2020 2020 4747  1 == 1);..    GG
-00064750: 4d4c 5f41 5353 4552 5428 6e65 6330 3020  ML_ASSERT(nec00 
-00064760: 3d3d 204d 293b 0a20 2020 2047 474d 4c5f  == M);.    GGML_
-00064770: 4153 5345 5254 286e 6563 3031 203d 3d20  ASSERT(nec01 == 
-00064780: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
-00064790: 4552 5428 6e65 6331 3020 3d3d 2044 293b  ERT(nec10 == D);
-000647a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000647b0: 286e 6563 3131 203d 3d20 3129 3b0a 0a20  (nec11 == 1);.. 
-000647c0: 2020 202f 2f20 6473 7420 6361 6e6e 6f74     // dst cannot
-000647d0: 2062 6520 7472 616e 7370 6f73 6564 206f   be transposed o
-000647e0: 7220 7065 726d 7574 6564 0a20 2020 2047  r permuted.    G
-000647f0: 474d 4c5f 4153 5345 5254 286e 6230 203d  GML_ASSERT(nb0 =
-00064800: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00064810: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00064820: 5428 6e62 3020 3c3d 206e 6231 293b 0a20  T(nb0 <= nb1);. 
-00064830: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00064840: 6231 203c 3d20 6e62 3229 3b0a 2020 2020  b1 <= nb2);.    
-00064850: 4747 4d4c 5f41 5353 4552 5428 6e62 3220  GGML_ASSERT(nb2 
-00064860: 3c3d 206e 6233 293b 0a0a 2020 2020 6966  <= nb3);..    if
-00064870: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-00064880: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-00064890: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-000648a0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
-000648b0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-000648c0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000648d0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000648e0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-000648f0: 2020 2020 2f2f 2070 6172 616c 6c65 6c69      // paralleli
-00064900: 7a65 2062 7920 6120 726f 7773 2075 7369  ze by a rows usi
-00064910: 6e67 2067 676d 6c5f 7665 635f 646f 745f  ng ggml_vec_dot_
-00064920: 6633 320a 0a20 2020 202f 2f20 746f 7461  f32..    // tota
-00064930: 6c20 726f 7773 2069 6e20 610a 2020 2020  l rows in a.    
-00064940: 636f 6e73 7420 696e 7420 6e72 203d 206e  const int nr = n
-00064950: 6561 312a 6e65 6132 2a6e 6561 333b 0a0a  ea1*nea2*nea3;..
-00064960: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
-00064970: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-00064980: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
-00064990: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
-000649a0: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
-000649b0: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
-000649c0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
-000649d0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
-000649e0: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
-000649f0: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
-00064a00: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-00064a10: 2069 7220 3d20 6972 303b 2069 7220 3c20   ir = ir0; ir < 
-00064a20: 6972 313b 202b 2b69 7229 207b 0a20 2020  ir1; ++ir) {.   
-00064a30: 2020 2020 202f 2f20 6120 696e 6469 6365       // a indice
-00064a40: 730a 2020 2020 2020 2020 636f 6e73 7420  s.        const 
-00064a50: 696e 7420 6961 3320 3d20 6972 2f28 6e65  int ia3 = ir/(ne
-00064a60: 6132 2a6e 6561 3129 3b0a 2020 2020 2020  a2*nea1);.      
-00064a70: 2020 636f 6e73 7420 696e 7420 6961 3220    const int ia2 
-00064a80: 3d20 2869 7220 2d20 6961 332a 6e65 6132  = (ir - ia3*nea2
-00064a90: 2a6e 6561 3129 2f6e 6561 313b 0a20 2020  *nea1)/nea1;.   
-00064aa0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00064ab0: 6131 203d 2028 6972 202d 2069 6133 2a6e  a1 = (ir - ia3*n
-00064ac0: 6561 322a 6e65 6131 202d 2069 6132 2a6e  ea2*nea1 - ia2*n
-00064ad0: 6561 3129 3b0a 0a20 2020 2020 2020 2066  ea1);..        f
-00064ae0: 6c6f 6174 202a 2053 203d 2028 666c 6f61  loat * S = (floa
-00064af0: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-00064b00: 7461 202b 2069 7468 2a28 322a 4d20 2b20  ta + ith*(2*M + 
-00064b10: 4341 4348 455f 4c49 4e45 5f53 495a 455f  CACHE_LINE_SIZE_
-00064b20: 4633 3229 3b0a 0a20 2020 2020 2020 2066  F32);..        f
-00064b30: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
-00064b40: 2030 3b20 6963 203c 206e 6562 3031 3b20   0; ic < neb01; 
-00064b50: 2b2b 6963 2920 7b0a 2020 2020 2020 2020  ++ic) {.        
-00064b60: 2020 2020 2f2f 2062 3020 696e 6469 6365      // b0 indice
-00064b70: 730a 2020 2020 2020 2020 2020 2020 636f  s.            co
-00064b80: 6e73 7420 696e 7420 6962 3033 203d 2069  nst int ib03 = i
-00064b90: 6133 3b0a 2020 2020 2020 2020 2020 2020  a3;.            
-00064ba0: 636f 6e73 7420 696e 7420 6962 3032 203d  const int ib02 =
-00064bb0: 2069 6132 3b0a 2020 2020 2020 2020 2020   ia2;.          
-00064bc0: 2020 636f 6e73 7420 696e 7420 6962 3031    const int ib01
-00064bd0: 203d 2069 633b 0a0a 2020 2020 2020 2020   = ic;..        
-00064be0: 2020 2020 2f2f 2053 2069 6e64 6963 6573      // S indices
-00064bf0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00064c00: 7374 2069 6e74 2069 3120 3d20 6962 3031  st int i1 = ib01
-00064c10: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
-00064c20: 676d 6c5f 7665 635f 646f 745f 6631 3628  gml_vec_dot_f16(
-00064c30: 6e65 6130 2c0a 2020 2020 2020 2020 2020  nea0,.          
-00064c40: 2020 2020 2020 2020 2020 5320 2b20 6931            S + i1
-00064c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00064c60: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
-00064c70: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
-00064c80: 6230 2d3e 6461 7461 202b 2028 6962 3031  b0->data + (ib01
-00064c90: 2a6e 6262 3031 202b 2069 6230 322a 6e62  *nbb01 + ib02*nb
-00064ca0: 6230 3220 2b20 6962 3033 2a6e 6262 3033  b02 + ib03*nbb03
-00064cb0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00064cc0: 2020 2020 2020 2020 2867 676d 6c5f 6670          (ggml_fp
-00064cd0: 3136 5f74 202a 2920 2828 6368 6172 202a  16_t *) ((char *
-00064ce0: 2920 2061 2d3e 6461 7461 202b 2028 2069  )  a->data + ( i
-00064cf0: 6131 2a6e 6261 3120 202b 2020 6961 322a  a1*nba1  +  ia2*
-00064d00: 6e62 6132 2020 2b20 2069 6133 2a6e 6261  nba2  +  ia3*nba
-00064d10: 3329 2929 3b0a 2020 2020 2020 2020 7d0a  3)));.        }.
-00064d20: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00064d30: 635f 6164 645f 6633 3228 6e65 6230 312c  c_add_f32(neb01,
-00064d40: 2053 2c20 532c 2028 666c 6f61 7420 2a29   S, S, (float *)
-00064d50: 2062 312d 3e64 6174 6129 3b0a 2020 2020   b1->data);.    
-00064d60: 2020 2020 2f2f 6767 6d6c 5f76 6563 5f67      //ggml_vec_g
-00064d70: 656c 755f 6633 3228 6e65 6230 312c 2053  elu_f32(neb01, S
-00064d80: 2c20 5329 3b0a 0a20 2020 2020 2020 2067  , S);..        g
-00064d90: 676d 6c5f 6670 3136 5f74 202a 2053 3136  gml_fp16_t * S16
-00064da0: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
-00064db0: 2a29 2028 2866 6c6f 6174 202a 2920 7061  *) ((float *) pa
-00064dc0: 7261 6d73 2d3e 7764 6174 6120 2b20 6974  rams->wdata + it
-00064dd0: 682a 2832 2a4d 202b 2043 4143 4845 5f4c  h*(2*M + CACHE_L
-00064de0: 494e 455f 5349 5a45 5f46 3332 2920 2b20  INE_SIZE_F32) + 
-00064df0: 4d29 3b0a 0a20 2020 2020 2020 2066 6f72  M);..        for
-00064e00: 2028 696e 7436 345f 7420 6920 3d20 303b   (int64_t i = 0;
-00064e10: 2069 203c 204d 3b20 692b 2b29 207b 0a20   i < M; i++) {. 
-00064e20: 2020 2020 2020 2020 2020 2053 3136 5b69             S16[i
-00064e30: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
-00064e40: 5f46 5031 3628 535b 695d 293b 0a20 2020  _FP16(S[i]);.   
-00064e50: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00064e60: 6767 6d6c 5f76 6563 5f67 656c 755f 6631  ggml_vec_gelu_f1
-00064e70: 3628 6e65 6230 312c 2053 3136 2c20 5331  6(neb01, S16, S1
-00064e80: 3629 3b0a 0a20 2020 2020 2020 207b 0a20  6);..        {. 
-00064e90: 2020 2020 2020 2020 2020 202f 2f20 6473             // ds
-00064ea0: 7420 696e 6469 6365 730a 2020 2020 2020  t indices.      
-00064eb0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00064ec0: 6931 203d 2069 6131 3b0a 2020 2020 2020  i1 = ia1;.      
-00064ed0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00064ee0: 6932 203d 2069 6132 3b0a 2020 2020 2020  i2 = ia2;.      
-00064ef0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00064f00: 6933 203d 2069 6133 3b0a 0a20 2020 2020  i3 = ia3;..     
-00064f10: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00064f20: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
-00064f30: 206e 6563 3031 3b20 2b2b 6963 2920 7b0a   nec01; ++ic) {.
-00064f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00064f50: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
-00064f60: 3628 6e65 6230 312c 0a20 2020 2020 2020  6(neb01,.       
+000636e0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+000636f0: 2020 2020 2020 2028 2863 6861 7220 2a29         ((char *)
+00063700: 2064 7374 2d3e 6461 7461 202b 2028 6963   dst->data + (ic
+00063710: 2a6e 6230 202b 2069 312a 6e62 3120 202b  *nb0 + i1*nb1  +
+00063720: 2069 322a 6e62 3220 202b 2069 332a 6e62   i2*nb2  + i3*nb
+00063730: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+00063740: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
+00063750: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
+00063760: 6861 7220 2a29 2076 2d3e 6461 7461 2020  har *) v->data  
+00063770: 202b 2028 2020 2020 2020 2020 2069 632a   + (         ic*
+00063780: 6e62 7631 202b 2069 322a 6e62 7632 202b  nbv1 + i2*nbv2 +
+00063790: 2069 332a 6e62 7633 2929 2c0a 2020 2020   i3*nbv3)),.    
+000637a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000637b0: 2020 2020 5331 3629 3b0a 2020 2020 2020      S16);.      
+000637c0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000637d0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+000637e0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+000637f0: 7420 6963 203d 2030 3b20 6963 203c 206e  t ic = 0; ic < n
+00063800: 6576 313b 2069 6320 2b3d 2047 474d 4c5f  ev1; ic += GGML_
+00063810: 5645 435f 444f 545f 554e 524f 4c4c 2920  VEC_DOT_UNROLL) 
+00063820: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00063830: 2020 2f2f 2064 7374 2069 6e64 6963 6573    // dst indices
+00063840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00063850: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
+00063860: 6971 313b 0a20 2020 2020 2020 2020 2020  iq1;.           
+00063870: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+00063880: 3220 3d20 6971 323b 0a20 2020 2020 2020  2 = iq2;.       
+00063890: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+000638a0: 6e74 2069 3320 3d20 6971 333b 0a0a 2020  nt i3 = iq3;..  
+000638b0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000638c0: 6d6c 5f76 6563 5f64 6f74 5f66 3136 5f75  ml_vec_dot_f16_u
+000638d0: 6e72 6f6c 6c28 6e65 6b31 2c20 6e62 7631  nroll(nek1, nbv1
+000638e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000638f0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+00063900: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
+00063910: 742d 3e64 6174 6120 2b20 2869 632a 6e62  t->data + (ic*nb
+00063920: 3020 2b20 6931 2a6e 6231 2020 2b20 6932  0 + i1*nb1  + i2
+00063930: 2a6e 6232 2020 2b20 6933 2a6e 6233 2929  *nb2  + i3*nb3))
+00063940: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00063950: 2020 2020 2020 2020 2020 2828 6368 6172            ((char
+00063960: 202a 2920 762d 3e64 6174 6120 2020 2b20   *) v->data   + 
+00063970: 2820 2020 2020 2020 2020 6963 2a6e 6276  (         ic*nbv
+00063980: 3120 2b20 6932 2a6e 6276 3220 2b20 6933  1 + i2*nbv2 + i3
+00063990: 2a6e 6276 3329 292c 0a20 2020 2020 2020  *nbv3)),.       
+000639a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000639b0: 2053 3136 293b 0a20 2020 2020 2020 2020   S16);.         
+000639c0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+000639d0: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+000639e0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+000639f0: 5f66 6f72 7761 7264 5f66 6c61 7368 5f61  _forward_flash_a
+00063a00: 7474 6e28 0a20 2020 2020 2020 2063 6f6e  ttn(.        con
+00063a10: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00063a20: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00063a30: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00063a40: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00063a50: 6c5f 7465 6e73 6f72 202a 2071 2c0a 2020  l_tensor * q,.  
+00063a60: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00063a70: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00063a80: 206b 2c0a 2020 2020 2020 2020 636f 6e73   k,.        cons
+00063a90: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00063aa0: 6e73 6f72 202a 2076 2c0a 2020 2020 2020  nsor * v,.      
+00063ab0: 2020 636f 6e73 7420 626f 6f6c 206d 6173    const bool mas
+00063ac0: 6b65 642c 0a20 2020 2020 2020 2073 7472  ked,.        str
+00063ad0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00063ae0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+00063af0: 7463 6820 2871 2d3e 7479 7065 2920 7b0a  tch (q->type) {.
+00063b00: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00063b10: 4c5f 5459 5045 5f46 3136 3a0a 2020 2020  L_TYPE_F16:.    
+00063b20: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00063b30: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00063b40: 6f6d 7075 7465 5f66 6f72 7761 7264 5f66  ompute_forward_f
+00063b50: 6c61 7368 5f61 7474 6e5f 6631 3628 7061  lash_attn_f16(pa
+00063b60: 7261 6d73 2c20 712c 206b 2c20 762c 206d  rams, q, k, v, m
+00063b70: 6173 6b65 642c 2064 7374 293b 0a20 2020  asked, dst);.   
+00063b80: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00063b90: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00063ba0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
+00063bb0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00063bc0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00063bd0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00063be0: 5f66 6c61 7368 5f61 7474 6e5f 6633 3228  _flash_attn_f32(
+00063bf0: 7061 7261 6d73 2c20 712c 206b 2c20 762c  params, q, k, v,
+00063c00: 206d 6173 6b65 642c 2064 7374 293b 0a20   masked, dst);. 
+00063c10: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00063c20: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
+00063c30: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+00063c40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00063c50: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00063c60: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+00063c70: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00063c80: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+00063c90: 7075 7465 5f66 6f72 7761 7264 5f66 6c61  pute_forward_fla
+00063ca0: 7368 5f66 660a 0a73 7461 7469 6320 766f  sh_ff..static vo
+00063cb0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00063cc0: 666f 7277 6172 645f 666c 6173 685f 6666  forward_flash_ff
+00063cd0: 5f66 3136 280a 2020 2020 2020 2020 636f  _f16(.        co
+00063ce0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00063cf0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00063d00: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00063d10: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00063d20: 6d6c 5f74 656e 736f 7220 2a20 612c 2020  ml_tensor * a,  
+00063d30: 2f2f 2046 3136 0a20 2020 2020 2020 2063  // F16.        c
+00063d40: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00063d50: 5f74 656e 736f 7220 2a20 6230 2c20 2f2f  _tensor * b0, //
+00063d60: 2046 3136 2066 635f 770a 2020 2020 2020   F16 fc_w.      
+00063d70: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00063d80: 676d 6c5f 7465 6e73 6f72 202a 2062 312c  gml_tensor * b1,
+00063d90: 202f 2f20 4633 3220 6663 5f62 0a20 2020   // F32 fc_b.   
+00063da0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00063db0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00063dc0: 6330 2c20 2f2f 2046 3136 2070 726f 6a5f  c0, // F16 proj_
+00063dd0: 770a 2020 2020 2020 2020 636f 6e73 7420  w.        const 
+00063de0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00063df0: 6f72 202a 2063 312c 202f 2f20 4633 3220  or * c1, // F32 
+00063e00: 7072 6f6a 5f62 0a20 2020 2020 2020 2073  proj_b.        s
+00063e10: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00063e20: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
+00063e30: 6e74 3634 5f74 2074 3020 3d20 6767 6d6c  nt64_t t0 = ggml
+00063e40: 5f70 6572 665f 7469 6d65 5f75 7328 293b  _perf_time_us();
+00063e50: 0a20 2020 2055 4e55 5345 4428 7430 293b  .    UNUSED(t0);
+00063e60: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
+00063e70: 345f 7420 6e65 6130 203d 2061 2d3e 6e65  4_t nea0 = a->ne
+00063e80: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00063e90: 6e74 3634 5f74 206e 6561 3120 3d20 612d  nt64_t nea1 = a-
+00063ea0: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
+00063eb0: 7420 696e 7436 345f 7420 6e65 6132 203d  t int64_t nea2 =
+00063ec0: 2061 2d3e 6e65 5b32 5d3b 0a20 2020 2063   a->ne[2];.    c
+00063ed0: 6f6e 7374 2069 6e74 3634 5f74 206e 6561  onst int64_t nea
+00063ee0: 3320 3d20 612d 3e6e 655b 335d 3b0a 0a20  3 = a->ne[3];.. 
+00063ef0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00063f00: 206e 6562 3030 203d 2062 302d 3e6e 655b   neb00 = b0->ne[
+00063f10: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00063f20: 7436 345f 7420 6e65 6230 3120 3d20 6230  t64_t neb01 = b0
+00063f30: 2d3e 6e65 5b31 5d3b 0a20 2020 202f 2f63  ->ne[1];.    //c
+00063f40: 6f6e 7374 2069 6e74 3634 5f74 206e 6562  onst int64_t neb
+00063f50: 3032 203d 2062 302d 3e6e 655b 325d 3b0a  02 = b0->ne[2];.
+00063f60: 2020 2020 2f2f 636f 6e73 7420 696e 7436      //const int6
+00063f70: 345f 7420 6e65 6230 3320 3d20 6230 2d3e  4_t neb03 = b0->
+00063f80: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+00063f90: 7420 696e 7436 345f 7420 6e65 6231 3020  t int64_t neb10 
+00063fa0: 3d20 6231 2d3e 6e65 5b30 5d3b 0a20 2020  = b1->ne[0];.   
+00063fb0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00063fc0: 6562 3131 203d 2062 312d 3e6e 655b 315d  eb11 = b1->ne[1]
+00063fd0: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+00063fe0: 7436 345f 7420 6e65 6231 3220 3d20 6231  t64_t neb12 = b1
+00063ff0: 2d3e 6e65 5b32 5d3b 0a20 2020 202f 2f63  ->ne[2];.    //c
+00064000: 6f6e 7374 2069 6e74 3634 5f74 206e 6562  onst int64_t neb
+00064010: 3133 203d 2062 312d 3e6e 655b 335d 3b0a  13 = b1->ne[3];.
+00064020: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00064030: 5f74 206e 6563 3030 203d 2063 302d 3e6e  _t nec00 = c0->n
+00064040: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
+00064050: 696e 7436 345f 7420 6e65 6330 3120 3d20  int64_t nec01 = 
+00064060: 6330 2d3e 6e65 5b31 5d3b 0a20 2020 202f  c0->ne[1];.    /
+00064070: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00064080: 6563 3032 203d 2063 302d 3e6e 655b 325d  ec02 = c0->ne[2]
+00064090: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
+000640a0: 7436 345f 7420 6e65 6330 3320 3d20 6330  t64_t nec03 = c0
+000640b0: 2d3e 6e65 5b33 5d3b 0a0a 2020 2020 636f  ->ne[3];..    co
+000640c0: 6e73 7420 696e 7436 345f 7420 6e65 6331  nst int64_t nec1
+000640d0: 3020 3d20 6331 2d3e 6e65 5b30 5d3b 0a20  0 = c1->ne[0];. 
+000640e0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000640f0: 206e 6563 3131 203d 2063 312d 3e6e 655b   nec11 = c1->ne[
+00064100: 315d 3b0a 2020 2020 2f2f 636f 6e73 7420  1];.    //const 
+00064110: 696e 7436 345f 7420 6e65 6331 3220 3d20  int64_t nec12 = 
+00064120: 6331 2d3e 6e65 5b32 5d3b 0a20 2020 202f  c1->ne[2];.    /
+00064130: 2f63 6f6e 7374 2069 6e74 3634 5f74 206e  /const int64_t n
+00064140: 6563 3133 203d 2063 312d 3e6e 655b 335d  ec13 = c1->ne[3]
+00064150: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00064160: 3634 5f74 206e 6530 203d 2064 7374 2d3e  64_t ne0 = dst->
+00064170: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00064180: 2069 6e74 3634 5f74 206e 6531 203d 2064   int64_t ne1 = d
+00064190: 7374 2d3e 6e65 5b31 5d3b 0a20 2020 2063  st->ne[1];.    c
+000641a0: 6f6e 7374 2069 6e74 3634 5f74 206e 6532  onst int64_t ne2
+000641b0: 203d 2064 7374 2d3e 6e65 5b32 5d3b 0a20   = dst->ne[2];. 
+000641c0: 2020 202f 2f63 6f6e 7374 2069 6e74 3634     //const int64
+000641d0: 5f74 206e 6533 203d 2064 7374 2d3e 6e65  _t ne3 = dst->ne
+000641e0: 5b33 5d3b 0a0a 2020 2020 636f 6e73 7420  [3];..    const 
+000641f0: 696e 7420 6e62 6130 203d 2061 2d3e 6e62  int nba0 = a->nb
+00064200: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00064210: 6e74 206e 6261 3120 3d20 612d 3e6e 625b  nt nba1 = a->nb[
+00064220: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+00064230: 7420 6e62 6132 203d 2061 2d3e 6e62 5b32  t nba2 = a->nb[2
+00064240: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+00064250: 206e 6261 3320 3d20 612d 3e6e 625b 335d   nba3 = a->nb[3]
+00064260: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00064270: 206e 6262 3030 203d 2062 302d 3e6e 625b   nbb00 = b0->nb[
+00064280: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00064290: 7420 6e62 6230 3120 3d20 6230 2d3e 6e62  t nbb01 = b0->nb
+000642a0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+000642b0: 6e74 206e 6262 3032 203d 2062 302d 3e6e  nt nbb02 = b0->n
+000642c0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+000642d0: 696e 7420 6e62 6230 3320 3d20 6230 2d3e  int nbb03 = b0->
+000642e0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+000642f0: 7420 696e 7420 6e62 6231 3020 3d20 6231  t int nbb10 = b1
+00064300: 2d3e 6e62 5b30 5d3b 0a20 2020 202f 2f63  ->nb[0];.    //c
+00064310: 6f6e 7374 2069 6e74 206e 6262 3131 203d  onst int nbb11 =
+00064320: 2062 312d 3e6e 625b 315d 3b0a 2020 2020   b1->nb[1];.    
+00064330: 2f2f 636f 6e73 7420 696e 7420 6e62 6231  //const int nbb1
+00064340: 3220 3d20 6231 2d3e 6e62 5b32 5d3b 0a20  2 = b1->nb[2];. 
+00064350: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00064360: 6262 3133 203d 2062 312d 3e6e 625b 335d  bb13 = b1->nb[3]
+00064370: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00064380: 206e 6263 3030 203d 2063 302d 3e6e 625b   nbc00 = c0->nb[
+00064390: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+000643a0: 7420 6e62 6330 3120 3d20 6330 2d3e 6e62  t nbc01 = c0->nb
+000643b0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+000643c0: 6e74 206e 6263 3032 203d 2063 302d 3e6e  nt nbc02 = c0->n
+000643d0: 625b 325d 3b0a 2020 2020 636f 6e73 7420  b[2];.    const 
+000643e0: 696e 7420 6e62 6330 3320 3d20 6330 2d3e  int nbc03 = c0->
+000643f0: 6e62 5b33 5d3b 0a0a 2020 2020 636f 6e73  nb[3];..    cons
+00064400: 7420 696e 7420 6e62 6331 3020 3d20 6331  t int nbc10 = c1
+00064410: 2d3e 6e62 5b30 5d3b 0a20 2020 202f 2f63  ->nb[0];.    //c
+00064420: 6f6e 7374 2069 6e74 206e 6263 3131 203d  onst int nbc11 =
+00064430: 2063 312d 3e6e 625b 315d 3b0a 2020 2020   c1->nb[1];.    
+00064440: 2f2f 636f 6e73 7420 696e 7420 6e62 6331  //const int nbc1
+00064450: 3220 3d20 6331 2d3e 6e62 5b32 5d3b 0a20  2 = c1->nb[2];. 
+00064460: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
+00064470: 6263 3133 203d 2063 312d 3e6e 625b 335d  bc13 = c1->nb[3]
+00064480: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00064490: 206e 6230 203d 2064 7374 2d3e 6e62 5b30   nb0 = dst->nb[0
+000644a0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000644b0: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
+000644c0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000644d0: 206e 6232 203d 2064 7374 2d3e 6e62 5b32   nb2 = dst->nb[2
+000644e0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000644f0: 206e 6233 203d 2064 7374 2d3e 6e62 5b33   nb3 = dst->nb[3
+00064500: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
+00064510: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+00064520: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+00064530: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+00064540: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
+00064550: 2069 6e74 3634 5f74 2044 203d 206e 6561   int64_t D = nea
+00064560: 303b 0a20 2020 202f 2f63 6f6e 7374 2069  0;.    //const i
+00064570: 6e74 3634 5f74 204e 203d 206e 6561 313b  nt64_t N = nea1;
+00064580: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00064590: 5f74 204d 203d 206e 6562 3031 3b0a 0a20  _t M = neb01;.. 
+000645a0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+000645b0: 6530 203d 3d20 6e65 6130 293b 0a20 2020  e0 == nea0);.   
+000645c0: 2047 474d 4c5f 4153 5345 5254 286e 6531   GGML_ASSERT(ne1
+000645d0: 203d 3d20 6e65 6131 293b 0a20 2020 2047   == nea1);.    G
+000645e0: 474d 4c5f 4153 5345 5254 286e 6532 203d  GML_ASSERT(ne2 =
+000645f0: 3d20 6e65 6132 293b 0a0a 2020 2020 4747  = nea2);..    GG
+00064600: 4d4c 5f41 5353 4552 5428 6e62 6130 2020  ML_ASSERT(nba0  
+00064610: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
+00064620: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
+00064630: 4c5f 4153 5345 5254 286e 6262 3030 203d  L_ASSERT(nbb00 =
+00064640: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
+00064650: 3136 5f74 2929 3b0a 2020 2020 4747 4d4c  16_t));.    GGML
+00064660: 5f41 5353 4552 5428 6e62 6231 3020 3d3d  _ASSERT(nbb10 ==
+00064670: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00064680: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00064690: 286e 6263 3030 203d 3d20 7369 7a65 6f66  (nbc00 == sizeof
+000646a0: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
+000646b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000646c0: 6e62 6331 3020 3d3d 2073 697a 656f 6628  nbc10 == sizeof(
+000646d0: 666c 6f61 7429 293b 0a0a 2020 2020 4747  float));..    GG
+000646e0: 4d4c 5f41 5353 4552 5428 6e65 6230 3020  ML_ASSERT(neb00 
+000646f0: 3d3d 2044 293b 0a20 2020 2047 474d 4c5f  == D);.    GGML_
+00064700: 4153 5345 5254 286e 6562 3031 203d 3d20  ASSERT(neb01 == 
+00064710: 4d29 3b0a 2020 2020 4747 4d4c 5f41 5353  M);.    GGML_ASS
+00064720: 4552 5428 6e65 6231 3020 3d3d 204d 293b  ERT(neb10 == M);
+00064730: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00064740: 286e 6562 3131 203d 3d20 3129 3b0a 0a20  (neb11 == 1);.. 
+00064750: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00064760: 6563 3030 203d 3d20 4d29 3b0a 2020 2020  ec00 == M);.    
+00064770: 4747 4d4c 5f41 5353 4552 5428 6e65 6330  GGML_ASSERT(nec0
+00064780: 3120 3d3d 2044 293b 0a20 2020 2047 474d  1 == D);.    GGM
+00064790: 4c5f 4153 5345 5254 286e 6563 3130 203d  L_ASSERT(nec10 =
+000647a0: 3d20 4429 3b0a 2020 2020 4747 4d4c 5f41  = D);.    GGML_A
+000647b0: 5353 4552 5428 6e65 6331 3120 3d3d 2031  SSERT(nec11 == 1
+000647c0: 293b 0a0a 2020 2020 2f2f 2064 7374 2063  );..    // dst c
+000647d0: 616e 6e6f 7420 6265 2074 7261 6e73 706f  annot be transpo
+000647e0: 7365 6420 6f72 2070 6572 6d75 7465 640a  sed or permuted.
+000647f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00064800: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
+00064810: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
+00064820: 4153 5345 5254 286e 6230 203c 3d20 6e62  ASSERT(nb0 <= nb
+00064830: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
+00064840: 4552 5428 6e62 3120 3c3d 206e 6232 293b  ERT(nb1 <= nb2);
+00064850: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00064860: 286e 6232 203c 3d20 6e62 3329 3b0a 0a20  (nb2 <= nb3);.. 
+00064870: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+00064880: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00064890: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
+000648a0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+000648b0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+000648c0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000648d0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+000648e0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+000648f0: 2020 7d0a 0a20 2020 202f 2f20 7061 7261    }..    // para
+00064900: 6c6c 656c 697a 6520 6279 2061 2072 6f77  llelize by a row
+00064910: 7320 7573 696e 6720 6767 6d6c 5f76 6563  s using ggml_vec
+00064920: 5f64 6f74 5f66 3332 0a0a 2020 2020 2f2f  _dot_f32..    //
+00064930: 2074 6f74 616c 2072 6f77 7320 696e 2061   total rows in a
+00064940: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00064950: 7220 3d20 6e65 6131 2a6e 6561 322a 6e65  r = nea1*nea2*ne
+00064960: 6133 3b0a 0a20 2020 202f 2f20 726f 7773  a3;..    // rows
+00064970: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
+00064980: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
+00064990: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
+000649a0: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
+000649b0: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
+000649c0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+000649d0: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
+000649e0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+000649f0: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
+00064a00: 722c 206e 7229 3b0a 0a20 2020 2066 6f72  r, nr);..    for
+00064a10: 2028 696e 7420 6972 203d 2069 7230 3b20   (int ir = ir0; 
+00064a20: 6972 203c 2069 7231 3b20 2b2b 6972 2920  ir < ir1; ++ir) 
+00064a30: 7b0a 2020 2020 2020 2020 2f2f 2061 2069  {.        // a i
+00064a40: 6e64 6963 6573 0a20 2020 2020 2020 2063  ndices.        c
+00064a50: 6f6e 7374 2069 6e74 2069 6133 203d 2069  onst int ia3 = i
+00064a60: 722f 286e 6561 322a 6e65 6131 293b 0a20  r/(nea2*nea1);. 
+00064a70: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00064a80: 2069 6132 203d 2028 6972 202d 2069 6133   ia2 = (ir - ia3
+00064a90: 2a6e 6561 322a 6e65 6131 292f 6e65 6131  *nea2*nea1)/nea1
+00064aa0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
+00064ab0: 696e 7420 6961 3120 3d20 2869 7220 2d20  int ia1 = (ir - 
+00064ac0: 6961 332a 6e65 6132 2a6e 6561 3120 2d20  ia3*nea2*nea1 - 
+00064ad0: 6961 322a 6e65 6131 293b 0a0a 2020 2020  ia2*nea1);..    
+00064ae0: 2020 2020 666c 6f61 7420 2a20 5320 3d20      float * S = 
+00064af0: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
+00064b00: 2d3e 7764 6174 6120 2b20 6974 682a 2832  ->wdata + ith*(2
+00064b10: 2a4d 202b 2043 4143 4845 5f4c 494e 455f  *M + CACHE_LINE_
+00064b20: 5349 5a45 5f46 3332 293b 0a0a 2020 2020  SIZE_F32);..    
+00064b30: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00064b40: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
+00064b50: 6230 313b 202b 2b69 6329 207b 0a20 2020  b01; ++ic) {.   
+00064b60: 2020 2020 2020 2020 202f 2f20 6230 2069           // b0 i
+00064b70: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+00064b80: 2020 2063 6f6e 7374 2069 6e74 2069 6230     const int ib0
+00064b90: 3320 3d20 6961 333b 0a20 2020 2020 2020  3 = ia3;.       
+00064ba0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+00064bb0: 6230 3220 3d20 6961 323b 0a20 2020 2020  b02 = ia2;.     
+00064bc0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00064bd0: 2069 6230 3120 3d20 6963 3b0a 0a20 2020   ib01 = ic;..   
+00064be0: 2020 2020 2020 2020 202f 2f20 5320 696e           // S in
+00064bf0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+00064c00: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+00064c10: 2069 6230 313b 0a0a 2020 2020 2020 2020   ib01;..        
+00064c20: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00064c30: 5f66 3136 286e 6561 302c 0a20 2020 2020  _f16(nea0,.     
+00064c40: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+00064c50: 202b 2069 312c 0a20 2020 2020 2020 2020   + i1,.         
+00064c60: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
+00064c70: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
+00064c80: 7220 2a29 2062 302d 3e64 6174 6120 2b20  r *) b0->data + 
+00064c90: 2869 6230 312a 6e62 6230 3120 2b20 6962  (ib01*nbb01 + ib
+00064ca0: 3032 2a6e 6262 3032 202b 2069 6230 332a  02*nbb02 + ib03*
+00064cb0: 6e62 6230 3329 292c 0a20 2020 2020 2020  nbb03)),.       
+00064cc0: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
+00064cd0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
+00064ce0: 6861 7220 2a29 2020 612d 3e64 6174 6120  har *)  a->data 
+00064cf0: 2b20 2820 6961 312a 6e62 6131 2020 2b20  + ( ia1*nba1  + 
+00064d00: 2069 6132 2a6e 6261 3220 202b 2020 6961   ia2*nba2  +  ia
+00064d10: 332a 6e62 6133 2929 293b 0a20 2020 2020  3*nba3)));.     
+00064d20: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
+00064d30: 6d6c 5f76 6563 5f61 6464 5f66 3332 286e  ml_vec_add_f32(n
+00064d40: 6562 3031 2c20 532c 2053 2c20 2866 6c6f  eb01, S, S, (flo
+00064d50: 6174 202a 2920 6231 2d3e 6461 7461 293b  at *) b1->data);
+00064d60: 0a20 2020 2020 2020 202f 2f67 676d 6c5f  .        //ggml_
+00064d70: 7665 635f 6765 6c75 5f66 3332 286e 6562  vec_gelu_f32(neb
+00064d80: 3031 2c20 532c 2053 293b 0a0a 2020 2020  01, S, S);..    
+00064d90: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
+00064da0: 2a20 5331 3620 3d20 2867 676d 6c5f 6670  * S16 = (ggml_fp
+00064db0: 3136 5f74 202a 2920 2828 666c 6f61 7420  16_t *) ((float 
+00064dc0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
+00064dd0: 202b 2069 7468 2a28 322a 4d20 2b20 4341   + ith*(2*M + CA
+00064de0: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
+00064df0: 3229 202b 204d 293b 0a0a 2020 2020 2020  2) + M);..      
+00064e00: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+00064e10: 203d 2030 3b20 6920 3c20 4d3b 2069 2b2b   = 0; i < M; i++
+00064e20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00064e30: 5331 365b 695d 203d 2047 474d 4c5f 4650  S16[i] = GGML_FP
+00064e40: 3332 5f54 4f5f 4650 3136 2853 5b69 5d29  32_TO_FP16(S[i])
+00064e50: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+00064e60: 2020 2020 2067 676d 6c5f 7665 635f 6765       ggml_vec_ge
+00064e70: 6c75 5f66 3136 286e 6562 3031 2c20 5331  lu_f16(neb01, S1
+00064e80: 362c 2053 3136 293b 0a0a 2020 2020 2020  6, S16);..      
+00064e90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00064ea0: 2f2f 2064 7374 2069 6e64 6963 6573 0a20  // dst indices. 
+00064eb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00064ec0: 2069 6e74 2069 3120 3d20 6961 313b 0a20   int i1 = ia1;. 
+00064ed0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00064ee0: 2069 6e74 2069 3220 3d20 6961 323b 0a20   int i2 = ia2;. 
+00064ef0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00064f00: 2069 6e74 2069 3320 3d20 6961 333b 0a0a   int i3 = ia3;..
+00064f10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00064f20: 2869 6e74 3634 5f74 2069 6320 3d20 303b  (int64_t ic = 0;
+00064f30: 2069 6320 3c20 6e65 6330 313b 202b 2b69   ic < nec01; ++i
+00064f40: 6329 207b 0a0a 2020 2020 2020 2020 2020  c) {..          
+00064f50: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+00064f60: 6f74 5f66 3136 286e 6562 3031 2c0a 2020  ot_f16(neb01,.  
 00064f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064f80: 2028 666c 6f61 7420 2a29 2020 2020 2020   (float *)      
-00064f90: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
-00064fa0: 6461 7461 202b 2028 6963 2a6e 6230 202b  data + (ic*nb0 +
-00064fb0: 2069 312a 6e62 3120 2020 2b20 6932 2a6e   i1*nb1   + i2*n
-00064fc0: 6232 2020 202b 2069 332a 6e62 3329 292c  b2   + i3*nb3)),
-00064fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00064fe0: 2020 2020 2020 2020 2028 6767 6d6c 5f66           (ggml_f
-00064ff0: 7031 365f 7420 2a29 2028 2863 6861 7220  p16_t *) ((char 
-00065000: 2a29 2063 302d 3e64 6174 6120 202b 2028  *) c0->data  + (
-00065010: 2020 2020 2020 2020 2069 632a 6e62 6330           ic*nbc0
-00065020: 3120 2b20 6932 2a6e 6263 3032 202b 2069  1 + i2*nbc02 + i
-00065030: 332a 6e62 6330 3329 292c 0a20 2020 2020  3*nbc03)),.     
+00064f80: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00064f90: 2020 2020 2020 2828 6368 6172 202a 2920        ((char *) 
+00064fa0: 6473 742d 3e64 6174 6120 2b20 2869 632a  dst->data + (ic*
+00064fb0: 6e62 3020 2b20 6931 2a6e 6231 2020 202b  nb0 + i1*nb1   +
+00064fc0: 2069 322a 6e62 3220 2020 2b20 6933 2a6e   i2*nb2   + i3*n
+00064fd0: 6233 2929 2c0a 2020 2020 2020 2020 2020  b3)),.          
+00064fe0: 2020 2020 2020 2020 2020 2020 2020 2867                (g
+00064ff0: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
+00065000: 6368 6172 202a 2920 6330 2d3e 6461 7461  char *) c0->data
+00065010: 2020 2b20 2820 2020 2020 2020 2020 6963    + (         ic
+00065020: 2a6e 6263 3031 202b 2069 322a 6e62 6330  *nbc01 + i2*nbc0
+00065030: 3220 2b20 6933 2a6e 6263 3033 2929 2c0a  2 + i3*nbc03)),.
 00065040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065050: 2020 2053 3136 293b 0a20 2020 2020 2020     S16);.       
-00065060: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00065070: 2020 2020 6767 6d6c 5f76 6563 5f61 6464      ggml_vec_add
-00065080: 5f66 3332 286e 6563 3031 2c0a 2020 2020  _f32(nec01,.    
-00065090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000650a0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-000650b0: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
-000650c0: 2869 312a 6e62 3120 2b20 6932 2a6e 6232  (i1*nb1 + i2*nb2
-000650d0: 202b 2069 332a 6e62 3329 292c 0a20 2020   + i3*nb3)),.   
-000650e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000650f0: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
-00065100: 7220 2a29 2064 7374 2d3e 6461 7461 202b  r *) dst->data +
-00065110: 2028 6931 2a6e 6231 202b 2069 322a 6e62   (i1*nb1 + i2*nb
-00065120: 3220 2b20 6933 2a6e 6233 2929 2c0a 2020  2 + i3*nb3)),.  
-00065130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065140: 2020 2866 6c6f 6174 202a 2920 6331 2d3e    (float *) c1->
-00065150: 6461 7461 293b 0a20 2020 2020 2020 207d  data);.        }
-00065160: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00065170: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00065180: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
-00065190: 5f66 6628 0a20 2020 2020 2020 2063 6f6e  _ff(.        con
-000651a0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-000651b0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000651c0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000651d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000651e0: 6c5f 7465 6e73 6f72 202a 2061 2c0a 2020  l_tensor * a,.  
-000651f0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00065200: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00065210: 2062 302c 0a20 2020 2020 2020 2063 6f6e   b0,.        con
-00065220: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00065230: 656e 736f 7220 2a20 6231 2c0a 2020 2020  ensor * b1,.    
-00065240: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00065250: 2067 676d 6c5f 7465 6e73 6f72 202a 2063   ggml_tensor * c
-00065260: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00065270: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00065280: 736f 7220 2a20 6331 2c0a 2020 2020 2020  sor * c1,.      
-00065290: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000652a0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-000652b0: 2020 7377 6974 6368 2028 6230 2d3e 7479    switch (b0->ty
-000652c0: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-000652d0: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
-000652e0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000652f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065300: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00065310: 7761 7264 5f66 6c61 7368 5f66 665f 6631  ward_flash_ff_f1
-00065320: 3628 7061 7261 6d73 2c20 612c 2062 302c  6(params, a, b0,
-00065330: 2062 312c 2063 302c 2063 312c 2064 7374   b1, c0, c1, dst
-00065340: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00065350: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00065360: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00065370: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-00065380: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00065390: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-000653a0: 6c73 6529 3b20 2f2f 2054 4f44 4f0a 2020  lse); // TODO.  
-000653b0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000653c0: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
-000653d0: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-000653e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000653f0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00065400: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
-00065410: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
-00065420: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
-00065430: 7574 655f 666f 7277 6172 645f 7769 6e5f  ute_forward_win_
-00065440: 7061 7274 0a0a 7374 6174 6963 2076 6f69  part..static voi
-00065450: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00065460: 6f72 7761 7264 5f77 696e 5f70 6172 745f  orward_win_part_
-00065470: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
-00065480: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00065490: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
-000654a0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
-000654b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000654c0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
-000654d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000654e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000654f0: 7220 2a20 6f70 7430 2c0a 2020 2020 2020  r * opt0,.      
-00065500: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00065510: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00065520: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00065530: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00065540: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-00065550: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00065560: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-00065570: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00065580: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
-00065590: 6e74 3634 5f74 206e 6530 3020 3d20 7372  nt64_t ne00 = sr
-000655a0: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-000655b0: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-000655c0: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
-000655d0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-000655e0: 5f74 206e 6530 3220 3d20 7372 6330 2d3e  _t ne02 = src0->
-000655f0: 6e65 5b32 5d3b 0a20 2020 202f 2f63 6f6e  ne[2];.    //con
-00065600: 7374 2069 6e74 3634 5f74 206e 6530 3320  st int64_t ne03 
-00065610: 3d20 7372 6330 2d3e 6e65 5b33 5d3b 0a20  = src0->ne[3];. 
-00065620: 2020 2055 4e55 5345 4428 6e65 3030 293b     UNUSED(ne00);
-00065630: 0a0a 2020 2020 636f 6e73 7420 696e 7436  ..    const int6
-00065640: 345f 7420 6e65 3020 3d20 6473 742d 3e6e  4_t ne0 = dst->n
-00065650: 655b 305d 3b0a 2020 2020 636f 6e73 7420  e[0];.    const 
-00065660: 696e 7436 345f 7420 6e65 3120 3d20 6473  int64_t ne1 = ds
-00065670: 742d 3e6e 655b 315d 3b0a 2020 2020 636f  t->ne[1];.    co
-00065680: 6e73 7420 696e 7436 345f 7420 6e65 3220  nst int64_t ne2 
-00065690: 3d20 6473 742d 3e6e 655b 325d 3b0a 2020  = dst->ne[2];.  
-000656a0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000656b0: 6e65 3320 3d20 6473 742d 3e6e 655b 335d  ne3 = dst->ne[3]
-000656c0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-000656d0: 3332 5f74 206e 6570 3020 3d20 2828 636f  32_t nep0 = ((co
-000656e0: 6e73 7420 696e 7433 325f 7420 2a29 286f  nst int32_t *)(o
-000656f0: 7074 302d 3e64 6174 6129 295b 305d 3b0a  pt0->data))[0];.
-00065700: 2020 2020 636f 6e73 7420 696e 7433 325f      const int32_
-00065710: 7420 6e65 7031 203d 2028 2863 6f6e 7374  t nep1 = ((const
-00065720: 2069 6e74 3332 5f74 202a 2928 6f70 7430   int32_t *)(opt0
-00065730: 2d3e 6461 7461 2929 5b31 5d3b 0a20 2020  ->data))[1];.   
-00065740: 2063 6f6e 7374 2069 6e74 3332 5f74 2077   const int32_t w
-00065750: 2020 2020 3d20 2828 636f 6e73 7420 696e      = ((const in
-00065760: 7433 325f 7420 2a29 286f 7074 302d 3e64  t32_t *)(opt0->d
-00065770: 6174 6129 295b 325d 3b0a 0a20 2020 2061  ata))[2];..    a
-00065780: 7373 6572 7428 6e65 3030 203d 3d20 6e65  ssert(ne00 == ne
-00065790: 3029 3b0a 2020 2020 6173 7365 7274 286e  0);.    assert(n
-000657a0: 6533 2020 3d3d 206e 6570 302a 6e65 7031  e3  == nep0*nep1
-000657b0: 293b 0a0a 2020 2020 2f2f 2054 4f44 4f3a  );..    // TODO:
-000657c0: 206f 7074 696d 697a 6520 2f20 6d75 6c74   optimize / mult
-000657d0: 692d 7468 7265 6164 0a20 2020 2066 6f72  i-thread.    for
-000657e0: 2028 696e 7420 7079 203d 2030 3b20 7079   (int py = 0; py
-000657f0: 203c 206e 6570 313b 202b 2b70 7929 207b   < nep1; ++py) {
-00065800: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-00065810: 7420 7078 203d 2030 3b20 7078 203c 206e  t px = 0; px < n
-00065820: 6570 303b 202b 2b70 7829 207b 0a20 2020  ep0; ++px) {.   
-00065830: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00065840: 6e74 3634 5f74 2069 3320 3d20 7079 2a6e  nt64_t i3 = py*n
-00065850: 6570 3020 2b20 7078 3b0a 2020 2020 2020  ep0 + px;.      
-00065860: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00065870: 5f74 2069 3220 3d20 303b 2069 3220 3c20  _t i2 = 0; i2 < 
-00065880: 6e65 323b 202b 2b69 3229 207b 0a20 2020  ne2; ++i2) {.   
-00065890: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000658a0: 2028 696e 7436 345f 7420 6931 203d 2030   (int64_t i1 = 0
-000658b0: 3b20 6931 203c 206e 6531 3b20 2b2b 6931  ; i1 < ne1; ++i1
-000658c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000658d0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-000658e0: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-000658f0: 3c20 6e65 303b 202b 2b69 3029 207b 0a20  < ne0; ++i0) {. 
-00065900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065910: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00065920: 3634 5f74 2069 3032 203d 2070 792a 7720  64_t i02 = py*w 
-00065930: 2b20 6932 3b0a 2020 2020 2020 2020 2020  + i2;.          
-00065940: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00065950: 6e73 7420 696e 7436 345f 7420 6930 3120  nst int64_t i01 
-00065960: 3d20 7078 2a77 202b 2069 313b 0a20 2020  = px*w + i1;.   
-00065970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065980: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-00065990: 5f74 2069 3030 203d 2069 303b 0a0a 2020  _t i00 = i0;..  
-000659a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000659b0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-000659c0: 345f 7420 6920 3d20 6933 2a6e 6532 2a6e  4_t i = i3*ne2*n
-000659d0: 6531 2a6e 6530 202b 2069 322a 6e65 312a  e1*ne0 + i2*ne1*
-000659e0: 6e65 3020 2020 202b 2069 312a 6e65 3020  ne0    + i1*ne0 
-000659f0: 2020 2b20 6930 3b0a 2020 2020 2020 2020    + i0;.        
+00065050: 2020 2020 2020 2020 5331 3629 3b0a 2020          S16);.  
+00065060: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00065070: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00065080: 635f 6164 645f 6633 3228 6e65 6330 312c  c_add_f32(nec01,
+00065090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000650a0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+000650b0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
+000650c0: 7461 202b 2028 6931 2a6e 6231 202b 2069  ta + (i1*nb1 + i
+000650d0: 322a 6e62 3220 2b20 6933 2a6e 6233 2929  2*nb2 + i3*nb3))
+000650e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000650f0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00065100: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
+00065110: 6174 6120 2b20 2869 312a 6e62 3120 2b20  ata + (i1*nb1 + 
+00065120: 6932 2a6e 6232 202b 2069 332a 6e62 3329  i2*nb2 + i3*nb3)
+00065130: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00065140: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+00065150: 2063 312d 3e64 6174 6129 3b0a 2020 2020   c1->data);.    
+00065160: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00065170: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00065180: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00065190: 666c 6173 685f 6666 280a 2020 2020 2020  flash_ff(.      
+000651a0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000651b0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000651c0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000651d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000651e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000651f0: 612c 0a20 2020 2020 2020 2063 6f6e 7374  a,.        const
+00065200: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00065210: 736f 7220 2a20 6230 2c0a 2020 2020 2020  sor * b0,.      
+00065220: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00065230: 676d 6c5f 7465 6e73 6f72 202a 2062 312c  gml_tensor * b1,
+00065240: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00065250: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00065260: 7220 2a20 6330 2c0a 2020 2020 2020 2020  r * c0,.        
+00065270: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00065280: 6c5f 7465 6e73 6f72 202a 2063 312c 0a20  l_tensor * c1,. 
+00065290: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000652a0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+000652b0: 207b 0a20 2020 2073 7769 7463 6820 2862   {.    switch (b
+000652c0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
+000652d0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+000652e0: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
+000652f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00065300: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00065310: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
+00065320: 6666 5f66 3136 2870 6172 616d 732c 2061  ff_f16(params, a
+00065330: 2c20 6230 2c20 6231 2c20 6330 2c20 6331  , b0, b1, c0, c1
+00065340: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+00065350: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00065360: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00065370: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00065380: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00065390: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+000653a0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+000653b0: 444f 0a20 2020 2020 2020 2020 2020 207d  DO.            }
+000653c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000653d0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+000653e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000653f0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00065400: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00065410: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00065420: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
+00065430: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00065440: 5f77 696e 5f70 6172 740a 0a73 7461 7469  _win_part..stati
+00065450: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00065460: 7574 655f 666f 7277 6172 645f 7769 6e5f  ute_forward_win_
+00065470: 7061 7274 5f66 3332 280a 2020 2020 2020  part_f32(.      
+00065480: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00065490: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000654a0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000654b0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000654c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000654d0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+000654e0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000654f0: 7465 6e73 6f72 202a 206f 7074 302c 0a20  tensor * opt0,. 
+00065500: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00065510: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00065520: 207b 0a20 2020 2069 6620 2870 6172 616d   {.    if (param
+00065530: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00065540: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+00065550: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00065560: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+00065570: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+00065580: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
+00065590: 6e73 7420 696e 7436 345f 7420 6e65 3030  nst int64_t ne00
+000655a0: 203d 2073 7263 302d 3e6e 655b 305d 3b0a   = src0->ne[0];.
+000655b0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000655c0: 7420 6e65 3031 203d 2073 7263 302d 3e6e  t ne01 = src0->n
+000655d0: 655b 315d 3b0a 2020 2020 636f 6e73 7420  e[1];.    const 
+000655e0: 696e 7436 345f 7420 6e65 3032 203d 2073  int64_t ne02 = s
+000655f0: 7263 302d 3e6e 655b 325d 3b0a 2020 2020  rc0->ne[2];.    
+00065600: 2f2f 636f 6e73 7420 696e 7436 345f 7420  //const int64_t 
+00065610: 6e65 3033 203d 2073 7263 302d 3e6e 655b  ne03 = src0->ne[
+00065620: 335d 3b0a 2020 2020 554e 5553 4544 286e  3];.    UNUSED(n
+00065630: 6530 3029 3b0a 0a20 2020 2063 6f6e 7374  e00);..    const
+00065640: 2069 6e74 3634 5f74 206e 6530 203d 2064   int64_t ne0 = d
+00065650: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
+00065660: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
+00065670: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
+00065680: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00065690: 206e 6532 203d 2064 7374 2d3e 6e65 5b32   ne2 = dst->ne[2
+000656a0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+000656b0: 3634 5f74 206e 6533 203d 2064 7374 2d3e  64_t ne3 = dst->
+000656c0: 6e65 5b33 5d3b 0a0a 2020 2020 636f 6e73  ne[3];..    cons
+000656d0: 7420 696e 7433 325f 7420 6e65 7030 203d  t int32_t nep0 =
+000656e0: 2028 2863 6f6e 7374 2069 6e74 3332 5f74   ((const int32_t
+000656f0: 202a 2928 6f70 7430 2d3e 6461 7461 2929   *)(opt0->data))
+00065700: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00065710: 6e74 3332 5f74 206e 6570 3120 3d20 2828  nt32_t nep1 = ((
+00065720: 636f 6e73 7420 696e 7433 325f 7420 2a29  const int32_t *)
+00065730: 286f 7074 302d 3e64 6174 6129 295b 315d  (opt0->data))[1]
+00065740: 3b0a 2020 2020 636f 6e73 7420 696e 7433  ;.    const int3
+00065750: 325f 7420 7720 2020 203d 2028 2863 6f6e  2_t w    = ((con
+00065760: 7374 2069 6e74 3332 5f74 202a 2928 6f70  st int32_t *)(op
+00065770: 7430 2d3e 6461 7461 2929 5b32 5d3b 0a0a  t0->data))[2];..
+00065780: 2020 2020 6173 7365 7274 286e 6530 3020      assert(ne00 
+00065790: 3d3d 206e 6530 293b 0a20 2020 2061 7373  == ne0);.    ass
+000657a0: 6572 7428 6e65 3320 203d 3d20 6e65 7030  ert(ne3  == nep0
+000657b0: 2a6e 6570 3129 3b0a 0a20 2020 202f 2f20  *nep1);..    // 
+000657c0: 544f 444f 3a20 6f70 7469 6d69 7a65 202f  TODO: optimize /
+000657d0: 206d 756c 7469 2d74 6872 6561 640a 2020   multi-thread.  
+000657e0: 2020 666f 7220 2869 6e74 2070 7920 3d20    for (int py = 
+000657f0: 303b 2070 7920 3c20 6e65 7031 3b20 2b2b  0; py < nep1; ++
+00065800: 7079 2920 7b0a 2020 2020 2020 2020 666f  py) {.        fo
+00065810: 7220 2869 6e74 2070 7820 3d20 303b 2070  r (int px = 0; p
+00065820: 7820 3c20 6e65 7030 3b20 2b2b 7078 2920  x < nep0; ++px) 
+00065830: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
+00065840: 6e73 7420 696e 7436 345f 7420 6933 203d  nst int64_t i3 =
+00065850: 2070 792a 6e65 7030 202b 2070 783b 0a20   py*nep0 + px;. 
+00065860: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00065870: 696e 7436 345f 7420 6932 203d 2030 3b20  int64_t i2 = 0; 
+00065880: 6932 203c 206e 6532 3b20 2b2b 6932 2920  i2 < ne2; ++i2) 
+00065890: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000658a0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+000658b0: 3120 3d20 303b 2069 3120 3c20 6e65 313b  1 = 0; i1 < ne1;
+000658c0: 202b 2b69 3129 207b 0a20 2020 2020 2020   ++i1) {.       
+000658d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000658e0: 2028 696e 7436 345f 7420 6930 203d 2030   (int64_t i0 = 0
+000658f0: 3b20 6930 203c 206e 6530 3b20 2b2b 6930  ; i0 < ne0; ++i0
+00065900: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00065910: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00065920: 7420 696e 7436 345f 7420 6930 3220 3d20  t int64_t i02 = 
+00065930: 7079 2a77 202b 2069 323b 0a20 2020 2020  py*w + i2;.     
+00065940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065950: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00065960: 2069 3031 203d 2070 782a 7720 2b20 6931   i01 = px*w + i1
+00065970: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00065980: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00065990: 696e 7436 345f 7420 6930 3020 3d20 6930  int64_t i00 = i0
+000659a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000659b0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000659c0: 2069 6e74 3634 5f74 2069 203d 2069 332a   int64_t i = i3*
+000659d0: 6e65 322a 6e65 312a 6e65 3020 2b20 6932  ne2*ne1*ne0 + i2
+000659e0: 2a6e 6531 2a6e 6530 2020 2020 2b20 6931  *ne1*ne0    + i1
+000659f0: 2a6e 6530 2020 202b 2069 303b 0a20 2020  *ne0   + i0;.   
 00065a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065a10: 636f 6e73 7420 696e 7436 345f 7420 6a20  const int64_t j 
-00065a20: 3d20 2020 2020 2020 2020 2020 2020 2020  =               
-00065a30: 2020 2069 3032 2a6e 6530 312a 6e65 3030     i02*ne01*ne00
-00065a40: 202b 2069 3031 2a6e 6530 3020 2b20 6930   + i01*ne00 + i0
-00065a50: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
-00065a60: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00065a70: 7079 2a77 202b 2069 3220 3e3d 206e 6530  py*w + i2 >= ne0
-00065a80: 3220 7c7c 2070 782a 7720 2b20 6931 203e  2 || px*w + i1 >
-00065a90: 3d20 6e65 3031 2920 7b0a 2020 2020 2020  = ne01) {.      
+00065a10: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+00065a20: 5f74 206a 203d 2020 2020 2020 2020 2020  _t j =          
+00065a30: 2020 2020 2020 2020 6930 322a 6e65 3031          i02*ne01
+00065a40: 2a6e 6530 3020 2b20 6930 312a 6e65 3030  *ne00 + i01*ne00
+00065a50: 202b 2069 3030 3b0a 0a20 2020 2020 2020   + i00;..       
+00065a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065a70: 2069 6620 2870 792a 7720 2b20 6932 203e   if (py*w + i2 >
+00065a80: 3d20 6e65 3032 207c 7c20 7078 2a77 202b  = ne02 || px*w +
+00065a90: 2069 3120 3e3d 206e 6530 3129 207b 0a20   i1 >= ne01) {. 
 00065aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065ab0: 2020 2020 2020 2828 666c 6f61 7420 2a29        ((float *)
-00065ac0: 2064 7374 2d3e 6461 7461 295b 695d 203d   dst->data)[i] =
-00065ad0: 2030 2e30 663b 0a20 2020 2020 2020 2020   0.0f;.         
-00065ae0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00065af0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+00065ab0: 2020 2020 2020 2020 2020 2028 2866 6c6f             ((flo
+00065ac0: 6174 202a 2920 6473 742d 3e64 6174 6129  at *) dst->data)
+00065ad0: 5b69 5d20 3d20 302e 3066 3b0a 2020 2020  [i] = 0.0f;.    
+00065ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065af0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
 00065b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065b10: 2020 2020 2828 666c 6f61 7420 2a29 2064      ((float *) d
-00065b20: 7374 2d3e 6461 7461 295b 695d 203d 2028  st->data)[i] = (
-00065b30: 2866 6c6f 6174 202a 2920 7372 6330 2d3e  (float *) src0->
-00065b40: 6461 7461 295b 6a5d 3b0a 2020 2020 2020  data)[j];.      
+00065b10: 2020 2020 2020 2020 2028 2866 6c6f 6174           ((float
+00065b20: 202a 2920 6473 742d 3e64 6174 6129 5b69   *) dst->data)[i
+00065b30: 5d20 3d20 2828 666c 6f61 7420 2a29 2073  ] = ((float *) s
+00065b40: 7263 302d 3e64 6174 6129 5b6a 5d3b 0a20  rc0->data)[j];. 
 00065b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065b60: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00065b70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00065b80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00065b90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00065ba0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-00065bb0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00065bc0: 6d70 7574 655f 666f 7277 6172 645f 7769  mpute_forward_wi
-00065bd0: 6e5f 7061 7274 280a 2020 2020 2020 2020  n_part(.        
-00065be0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00065bf0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00065c00: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00065c10: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00065c20: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00065c30: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-00065c40: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00065c50: 6e73 6f72 202a 206f 7074 302c 0a20 2020  nsor * opt0,.   
-00065c60: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00065c70: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00065c80: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00065c90: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00065ca0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00065cb0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00065cc0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00065cd0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00065ce0: 655f 666f 7277 6172 645f 7769 6e5f 7061  e_forward_win_pa
-00065cf0: 7274 5f66 3332 2870 6172 616d 732c 2073  rt_f32(params, s
-00065d00: 7263 302c 206f 7074 302c 2064 7374 293b  rc0, opt0, dst);
-00065d10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00065d20: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
-00065d30: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-00065d40: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00065d50: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00065d60: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00065d70: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00065d80: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00065d90: 6f6d 7075 7465 5f66 6f72 7761 7264 5f77  ompute_forward_w
-00065da0: 696e 5f75 6e70 6172 740a 0a73 7461 7469  in_unpart..stati
-00065db0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00065dc0: 7574 655f 666f 7277 6172 645f 7769 6e5f  ute_forward_win_
-00065dd0: 756e 7061 7274 5f66 3332 280a 2020 2020  unpart_f32(.    
-00065de0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00065df0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00065e00: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00065e10: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00065e20: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00065e30: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00065e40: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00065e50: 6c5f 7465 6e73 6f72 202a 206f 7074 302c  l_tensor * opt0,
-00065e60: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00065e70: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00065e80: 7429 207b 0a20 2020 2069 6620 2870 6172  t) {.    if (par
-00065e90: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00065ea0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-00065eb0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-00065ec0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00065ed0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00065ee0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00065ef0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00065f00: 3030 203d 2073 7263 302d 3e6e 655b 305d  00 = src0->ne[0]
-00065f10: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00065f20: 345f 7420 6e65 3031 203d 2073 7263 302d  4_t ne01 = src0-
-00065f30: 3e6e 655b 315d 3b0a 2020 2020 636f 6e73  >ne[1];.    cons
-00065f40: 7420 696e 7436 345f 7420 6e65 3032 203d  t int64_t ne02 =
-00065f50: 2073 7263 302d 3e6e 655b 325d 3b0a 2020   src0->ne[2];.  
-00065f60: 2020 2f2f 636f 6e73 7420 696e 7436 345f    //const int64_
-00065f70: 7420 6e65 3033 203d 2073 7263 302d 3e6e  t ne03 = src0->n
-00065f80: 655b 335d 3b0a 0a20 2020 2063 6f6e 7374  e[3];..    const
-00065f90: 2069 6e74 3634 5f74 206e 6530 203d 2064   int64_t ne0 = d
-00065fa0: 7374 2d3e 6e65 5b30 5d3b 0a20 2020 2063  st->ne[0];.    c
-00065fb0: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-00065fc0: 203d 2064 7374 2d3e 6e65 5b31 5d3b 0a20   = dst->ne[1];. 
-00065fd0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00065fe0: 206e 6532 203d 2064 7374 2d3e 6e65 5b32   ne2 = dst->ne[2
-00065ff0: 5d3b 0a0a 2020 2020 636f 6e73 7420 696e  ];..    const in
-00066000: 7433 325f 7420 7720 3d20 2828 636f 6e73  t32_t w = ((cons
-00066010: 7420 696e 7433 325f 7420 2a29 286f 7074  t int32_t *)(opt
-00066020: 302d 3e64 6174 6129 295b 305d 3b0a 0a20  0->data))[0];.. 
-00066030: 2020 202f 2f20 7061 6464 696e 670a 2020     // padding.  
-00066040: 2020 636f 6e73 7420 696e 7420 7078 203d    const int px =
-00066050: 2028 7720 2d20 6e65 3125 7729 2577 3b0a   (w - ne1%w)%w;.
-00066060: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-00066070: 7079 203d 2028 7720 2d20 6e65 3225 7729  py = (w - ne2%w)
-00066080: 2577 3b0a 0a20 2020 2063 6f6e 7374 2069  %w;..    const i
-00066090: 6e74 206e 7078 203d 2028 7078 202b 206e  nt npx = (px + n
-000660a0: 6531 292f 773b 0a20 2020 202f 2f63 6f6e  e1)/w;.    //con
-000660b0: 7374 2069 6e74 206e 7079 203d 2028 7079  st int npy = (py
-000660c0: 202b 206e 6532 292f 773b 0a0a 2020 2020   + ne2)/w;..    
-000660d0: 6173 7365 7274 286e 6530 203d 3d20 6e65  assert(ne0 == ne
-000660e0: 3030 293b 0a0a 2020 2020 2f2f 2054 4f44  00);..    // TOD
-000660f0: 4f3a 206f 7074 696d 697a 6520 2f20 6d75  O: optimize / mu
-00066100: 6c74 692d 7468 7265 6164 0a20 2020 2066  lti-thread.    f
-00066110: 6f72 2028 696e 7436 345f 7420 6932 203d  or (int64_t i2 =
-00066120: 2030 3b20 6932 203c 206e 6532 3b20 2b2b   0; i2 < ne2; ++
-00066130: 6932 2920 7b0a 2020 2020 2020 2020 666f  i2) {.        fo
-00066140: 7220 2869 6e74 3634 5f74 2069 3120 3d20  r (int64_t i1 = 
-00066150: 303b 2069 3120 3c20 6e65 313b 202b 2b69  0; i1 < ne1; ++i
-00066160: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00066170: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
-00066180: 203d 2030 3b20 6930 203c 206e 6530 3b20   = 0; i0 < ne0; 
-00066190: 2b2b 6930 2920 7b0a 2020 2020 2020 2020  ++i0) {.        
-000661a0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000661b0: 7420 6970 3220 3d20 6932 2f77 3b0a 2020  t ip2 = i2/w;.  
-000661c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000661d0: 6e73 7420 696e 7420 6970 3120 3d20 6931  nst int ip1 = i1
-000661e0: 2f77 3b0a 0a20 2020 2020 2020 2020 2020  /w;..           
-000661f0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-00066200: 5f74 2069 3032 203d 2069 3225 773b 0a20  _t i02 = i2%w;. 
-00066210: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00066220: 6f6e 7374 2069 6e74 3634 5f74 2069 3031  onst int64_t i01
-00066230: 203d 2069 3125 773b 0a20 2020 2020 2020   = i1%w;.       
-00066240: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00066250: 6e74 3634 5f74 2069 3030 203d 2069 303b  nt64_t i00 = i0;
-00066260: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00066270: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00066280: 6920 3d20 2869 7032 2a6e 7078 202b 2069  i = (ip2*npx + i
-00066290: 7031 292a 6e65 3032 2a6e 6530 312a 6e65  p1)*ne02*ne01*ne
-000662a0: 3030 202b 2069 3032 2a6e 6530 312a 6e65  00 + i02*ne01*ne
-000662b0: 3030 202b 2069 3031 2a6e 6530 3020 2b20  00 + i01*ne00 + 
-000662c0: 6930 303b 0a20 2020 2020 2020 2020 2020  i00;.           
-000662d0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-000662e0: 5f74 206a 203d 2020 2020 2020 2020 2020  _t j =          
+00065b60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00065b70: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00065b80: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00065b90: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00065ba0: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00065bb0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00065bc0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00065bd0: 7264 5f77 696e 5f70 6172 7428 0a20 2020  rd_win_part(.   
+00065be0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00065bf0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00065c00: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00065c10: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00065c20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00065c30: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00065c40: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00065c50: 6d6c 5f74 656e 736f 7220 2a20 6f70 7430  ml_tensor * opt0
+00065c60: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00065c70: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00065c80: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
+00065c90: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
+00065ca0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00065cb0: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00065cc0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00065cd0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00065ce0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f77  ompute_forward_w
+00065cf0: 696e 5f70 6172 745f 6633 3228 7061 7261  in_part_f32(para
+00065d00: 6d73 2c20 7372 6330 2c20 6f70 7430 2c20  ms, src0, opt0, 
+00065d10: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+00065d20: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00065d30: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00065d40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00065d50: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00065d60: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00065d70: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00065d80: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00065d90: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00065da0: 6172 645f 7769 6e5f 756e 7061 7274 0a0a  ard_win_unpart..
+00065db0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00065dc0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00065dd0: 5f77 696e 5f75 6e70 6172 745f 6633 3228  _win_unpart_f32(
+00065de0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00065df0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00065e00: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00065e10: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00065e20: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00065e30: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00065e40: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00065e50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00065e60: 6f70 7430 2c0a 2020 2020 2020 2020 7374  opt0,.        st
+00065e70: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00065e80: 202a 2064 7374 2920 7b0a 2020 2020 6966   * dst) {.    if
+00065e90: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00065ea0: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00065eb0: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00065ec0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00065ed0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00065ee0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00065ef0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00065f00: 5f74 206e 6530 3020 3d20 7372 6330 2d3e  _t ne00 = src0->
+00065f10: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00065f20: 2069 6e74 3634 5f74 206e 6530 3120 3d20   int64_t ne01 = 
+00065f30: 7372 6330 2d3e 6e65 5b31 5d3b 0a20 2020  src0->ne[1];.   
+00065f40: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+00065f50: 6530 3220 3d20 7372 6330 2d3e 6e65 5b32  e02 = src0->ne[2
+00065f60: 5d3b 0a20 2020 202f 2f63 6f6e 7374 2069  ];.    //const i
+00065f70: 6e74 3634 5f74 206e 6530 3320 3d20 7372  nt64_t ne03 = sr
+00065f80: 6330 2d3e 6e65 5b33 5d3b 0a0a 2020 2020  c0->ne[3];..    
+00065f90: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00065fa0: 3020 3d20 6473 742d 3e6e 655b 305d 3b0a  0 = dst->ne[0];.
+00065fb0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00065fc0: 7420 6e65 3120 3d20 6473 742d 3e6e 655b  t ne1 = dst->ne[
+00065fd0: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+00065fe0: 7436 345f 7420 6e65 3220 3d20 6473 742d  t64_t ne2 = dst-
+00065ff0: 3e6e 655b 325d 3b0a 0a20 2020 2063 6f6e  >ne[2];..    con
+00066000: 7374 2069 6e74 3332 5f74 2077 203d 2028  st int32_t w = (
+00066010: 2863 6f6e 7374 2069 6e74 3332 5f74 202a  (const int32_t *
+00066020: 2928 6f70 7430 2d3e 6461 7461 2929 5b30  )(opt0->data))[0
+00066030: 5d3b 0a0a 2020 2020 2f2f 2070 6164 6469  ];..    // paddi
+00066040: 6e67 0a20 2020 2063 6f6e 7374 2069 6e74  ng.    const int
+00066050: 2070 7820 3d20 2877 202d 206e 6531 2577   px = (w - ne1%w
+00066060: 2925 773b 0a20 2020 202f 2f63 6f6e 7374  )%w;.    //const
+00066070: 2069 6e74 2070 7920 3d20 2877 202d 206e   int py = (w - n
+00066080: 6532 2577 2925 773b 0a0a 2020 2020 636f  e2%w)%w;..    co
+00066090: 6e73 7420 696e 7420 6e70 7820 3d20 2870  nst int npx = (p
+000660a0: 7820 2b20 6e65 3129 2f77 3b0a 2020 2020  x + ne1)/w;.    
+000660b0: 2f2f 636f 6e73 7420 696e 7420 6e70 7920  //const int npy 
+000660c0: 3d20 2870 7920 2b20 6e65 3229 2f77 3b0a  = (py + ne2)/w;.
+000660d0: 0a20 2020 2061 7373 6572 7428 6e65 3020  .    assert(ne0 
+000660e0: 3d3d 206e 6530 3029 3b0a 0a20 2020 202f  == ne00);..    /
+000660f0: 2f20 544f 444f 3a20 6f70 7469 6d69 7a65  / TODO: optimize
+00066100: 202f 206d 756c 7469 2d74 6872 6561 640a   / multi-thread.
+00066110: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00066120: 2069 3220 3d20 303b 2069 3220 3c20 6e65   i2 = 0; i2 < ne
+00066130: 323b 202b 2b69 3229 207b 0a20 2020 2020  2; ++i2) {.     
+00066140: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+00066150: 6931 203d 2030 3b20 6931 203c 206e 6531  i1 = 0; i1 < ne1
+00066160: 3b20 2b2b 6931 2920 7b0a 2020 2020 2020  ; ++i1) {.      
+00066170: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+00066180: 5f74 2069 3020 3d20 303b 2069 3020 3c20  _t i0 = 0; i0 < 
+00066190: 6e65 303b 202b 2b69 3029 207b 0a20 2020  ne0; ++i0) {.   
+000661a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000661b0: 7374 2069 6e74 2069 7032 203d 2069 322f  st int ip2 = i2/
+000661c0: 773b 0a20 2020 2020 2020 2020 2020 2020  w;.             
+000661d0: 2020 2063 6f6e 7374 2069 6e74 2069 7031     const int ip1
+000661e0: 203d 2069 312f 773b 0a0a 2020 2020 2020   = i1/w;..      
+000661f0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00066200: 696e 7436 345f 7420 6930 3220 3d20 6932  int64_t i02 = i2
+00066210: 2577 3b0a 2020 2020 2020 2020 2020 2020  %w;.            
+00066220: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00066230: 7420 6930 3120 3d20 6931 2577 3b0a 2020  t i01 = i1%w;.  
+00066240: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00066250: 6e73 7420 696e 7436 345f 7420 6930 3020  nst int64_t i00 
+00066260: 3d20 6930 3b0a 0a20 2020 2020 2020 2020  = i0;..         
+00066270: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00066280: 3634 5f74 2069 203d 2028 6970 322a 6e70  64_t i = (ip2*np
+00066290: 7820 2b20 6970 3129 2a6e 6530 322a 6e65  x + ip1)*ne02*ne
+000662a0: 3031 2a6e 6530 3020 2b20 6930 322a 6e65  01*ne00 + i02*ne
+000662b0: 3031 2a6e 6530 3020 2b20 6930 312a 6e65  01*ne00 + i01*ne
+000662c0: 3030 202b 2069 3030 3b0a 2020 2020 2020  00 + i00;.      
+000662d0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+000662e0: 696e 7436 345f 7420 6a20 3d20 2020 2020  int64_t j =     
 000662f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066300: 2020 2020 2020 2020 6932 2a6e 6531 2a6e          i2*ne1*n
-00066310: 6530 2020 2020 2b20 6931 2a6e 6530 2020  e0    + i1*ne0  
-00066320: 202b 2069 303b 0a0a 2020 2020 2020 2020   + i0;..        
-00066330: 2020 2020 2020 2020 2828 666c 6f61 7420          ((float 
-00066340: 2a29 2064 7374 2d3e 6461 7461 295b 6a5d  *) dst->data)[j]
-00066350: 203d 2028 2866 6c6f 6174 202a 2920 7372   = ((float *) sr
-00066360: 6330 2d3e 6461 7461 295b 695d 3b0a 2020  c0->data)[i];.  
-00066370: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00066380: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-00066390: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-000663a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000663b0: 7769 6e5f 756e 7061 7274 280a 2020 2020  win_unpart(.    
-000663c0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-000663d0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-000663e0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-000663f0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00066400: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00066410: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00066420: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00066430: 6c5f 7465 6e73 6f72 202a 206f 7074 302c  l_tensor * opt0,
-00066440: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00066450: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00066460: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00066470: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00066480: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00066490: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000664a0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000664b0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000664c0: 6d70 7574 655f 666f 7277 6172 645f 7769  mpute_forward_wi
-000664d0: 6e5f 756e 7061 7274 5f66 3332 2870 6172  n_unpart_f32(par
-000664e0: 616d 732c 2073 7263 302c 206f 7074 302c  ams, src0, opt0,
-000664f0: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00066500: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00066510: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-00066520: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00066530: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00066540: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-00066550: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00066560: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-00066570: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00066580: 7761 7264 5f6d 6170 5f75 6e61 7279 0a0a  ward_map_unary..
-00066590: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-000665a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000665b0: 5f6d 6170 5f75 6e61 7279 5f66 3332 280a  _map_unary_f32(.
-000665c0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000665d0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000665e0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-000665f0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00066600: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00066610: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00066620: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00066630: 7465 6e73 6f72 202a 2064 7374 2c0a 2020  tensor * dst,.  
-00066640: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
-00066650: 5f75 6e61 7279 5f6f 705f 6633 325f 7420  _unary_op_f32_t 
-00066660: 6675 6e29 207b 0a20 2020 2047 474d 4c5f  fun) {.    GGML_
-00066670: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
-00066680: 7361 6d65 5f73 6861 7065 2873 7263 302c  same_shape(src0,
-00066690: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
-000666a0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-000666b0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-000666c0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-000666d0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000666e0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000666f0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00066700: 2020 2020 636f 6e73 7420 696e 7420 6e20      const int n 
-00066710: 203d 2067 676d 6c5f 6e72 6f77 7328 7372   = ggml_nrows(sr
-00066720: 6330 293b 0a20 2020 2063 6f6e 7374 2069  c0);.    const i
-00066730: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
-00066740: 5b30 5d3b 0a0a 2020 2020 6173 7365 7274  [0];..    assert
-00066750: 2820 6473 742d 3e6e 625b 305d 203d 3d20  ( dst->nb[0] == 
-00066760: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00066770: 2020 2020 6173 7365 7274 2873 7263 302d      assert(src0-
-00066780: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00066790: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-000667a0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-000667b0: 203c 206e 3b20 692b 2b29 207b 0a20 2020   < n; i++) {.   
-000667c0: 2020 2020 2066 756e 286e 632c 0a20 2020       fun(nc,.   
-000667d0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-000667e0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-000667f0: 2064 7374 2d3e 6461 7461 2020 2b20 692a   dst->data  + i*
-00066800: 2820 6473 742d 3e6e 625b 315d 2929 2c0a  ( dst->nb[1])),.
-00066810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066820: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-00066830: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-00066840: 2069 2a28 7372 6330 2d3e 6e62 5b31 5d29   i*(src0->nb[1])
-00066850: 2929 3b0a 2020 2020 7d0a 7d0a 0a0a 7374  ));.    }.}...st
-00066860: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00066870: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-00066880: 6170 5f75 6e61 7279 280a 2020 2020 2020  ap_unary(.      
-00066890: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000668a0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-000668b0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-000668c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000668d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000668e0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-000668f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00066900: 202a 2064 7374 2c0a 2020 2020 2020 2020   * dst,.        
-00066910: 636f 6e73 7420 6767 6d6c 5f75 6e61 7279  const ggml_unary
-00066920: 5f6f 705f 6633 325f 7420 6675 6e29 207b  _op_f32_t fun) {
-00066930: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00066940: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00066950: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00066960: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00066970: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00066980: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00066990: 655f 666f 7277 6172 645f 6d61 705f 756e  e_forward_map_un
-000669a0: 6172 795f 6633 3228 7061 7261 6d73 2c20  ary_f32(params, 
-000669b0: 7372 6330 2c20 6473 742c 2066 756e 293b  src0, dst, fun);
-000669c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000669d0: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
-000669e0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-000669f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00066a00: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00066a10: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-00066a20: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00066a30: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-00066a40: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
-00066a50: 6170 5f62 696e 6172 790a 0a73 7461 7469  ap_binary..stati
-00066a60: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00066a70: 7574 655f 666f 7277 6172 645f 6d61 705f  ute_forward_map_
-00066a80: 6269 6e61 7279 5f66 3332 280a 2020 2020  binary_f32(.    
-00066a90: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00066aa0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00066ab0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00066ac0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00066ad0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00066ae0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00066af0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00066b00: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-00066b10: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00066b20: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00066b30: 742c 0a20 2020 2020 2020 2063 6f6e 7374  t,.        const
-00066b40: 2067 676d 6c5f 6269 6e61 7279 5f6f 705f   ggml_binary_op_
-00066b50: 6633 325f 7420 6675 6e29 207b 0a20 2020  f32_t fun) {.   
-00066b60: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
-00066b70: 6974 6820 3d3d 2030 293b 0a20 2020 2061  ith == 0);.    a
-00066b80: 7373 6572 7428 6767 6d6c 5f61 7265 5f73  ssert(ggml_are_s
-00066b90: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-00066ba0: 7372 6331 2920 2626 2067 676d 6c5f 6172  src1) && ggml_ar
-00066bb0: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
-00066bc0: 302c 2064 7374 2929 3b0a 0a20 2020 2069  0, dst));..    i
-00066bd0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00066be0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00066bf0: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-00066c00: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00066c10: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00066c20: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00066c30: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00066c40: 6e20 203d 2067 676d 6c5f 6e72 6f77 7328  n  = ggml_nrows(
-00066c50: 7372 6330 293b 0a20 2020 2063 6f6e 7374  src0);.    const
-00066c60: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
-00066c70: 6e65 5b30 5d3b 0a0a 2020 2020 6173 7365  ne[0];..    asse
-00066c80: 7274 2820 6473 742d 3e6e 625b 305d 203d  rt( dst->nb[0] =
-00066c90: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-00066ca0: 3b0a 2020 2020 6173 7365 7274 2873 7263  ;.    assert(src
-00066cb0: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
-00066cc0: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
-00066cd0: 6173 7365 7274 2873 7263 312d 3e6e 625b  assert(src1->nb[
-00066ce0: 305d 203d 3d20 7369 7a65 6f66 2866 6c6f  0] == sizeof(flo
-00066cf0: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
-00066d00: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-00066d10: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00066d20: 2066 756e 286e 632c 0a20 2020 2020 2020   fun(nc,.       
-00066d30: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00066d40: 2a29 2028 2863 6861 7220 2a29 2064 7374  *) ((char *) dst
-00066d50: 2d3e 6461 7461 2020 2b20 692a 2820 6473  ->data  + i*( ds
-00066d60: 742d 3e6e 625b 315d 2929 2c0a 2020 2020  t->nb[1])),.    
-00066d70: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-00066d80: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-00066d90: 7372 6330 2d3e 6461 7461 202b 2069 2a28  src0->data + i*(
-00066da0: 7372 6330 2d3e 6e62 5b31 5d29 292c 0a20  src0->nb[1])),. 
-00066db0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00066dc0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00066dd0: 2a29 2073 7263 312d 3e64 6174 6120 2b20  *) src1->data + 
-00066de0: 692a 2873 7263 312d 3e6e 625b 315d 2929  i*(src1->nb[1]))
-00066df0: 293b 0a20 2020 207d 0a7d 0a0a 0a73 7461  );.    }.}...sta
-00066e00: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00066e10: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
-00066e20: 705f 6269 6e61 7279 280a 2020 2020 2020  p_binary(.      
-00066e30: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00066e40: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00066e50: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00066e60: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00066e70: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00066e80: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00066e90: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00066ea0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00066eb0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00066ec0: 6d6c 5f74 656e 736f 7220 2a20 6473 742c  ml_tensor * dst,
-00066ed0: 0a20 2020 2020 2020 2063 6f6e 7374 2067  .        const g
-00066ee0: 676d 6c5f 6269 6e61 7279 5f6f 705f 6633  gml_binary_op_f3
-00066ef0: 325f 7420 6675 6e29 207b 0a20 2020 2073  2_t fun) {.    s
-00066f00: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
-00066f10: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
-00066f20: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-00066f30: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00066f40: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00066f50: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00066f60: 6172 645f 6d61 705f 6269 6e61 7279 5f66  ard_map_binary_f
-00066f70: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00066f80: 2073 7263 312c 2064 7374 2c20 6675 6e29   src1, dst, fun)
-00066f90: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00066fa0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-00066fb0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-00066fc0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00066fd0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00066fe0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00066ff0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00067000: 2020 207d 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f     }.}..////////
+00066300: 2020 2020 2020 2020 2020 2020 2069 322a               i2*
+00066310: 6e65 312a 6e65 3020 2020 202b 2069 312a  ne1*ne0    + i1*
+00066320: 6e65 3020 2020 2b20 6930 3b0a 0a20 2020  ne0   + i0;..   
+00066330: 2020 2020 2020 2020 2020 2020 2028 2866               ((f
+00066340: 6c6f 6174 202a 2920 6473 742d 3e64 6174  loat *) dst->dat
+00066350: 6129 5b6a 5d20 3d20 2828 666c 6f61 7420  a)[j] = ((float 
+00066360: 2a29 2073 7263 302d 3e64 6174 6129 5b69  *) src0->data)[i
+00066370: 5d3b 0a20 2020 2020 2020 2020 2020 207d  ];.            }
+00066380: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00066390: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
+000663a0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000663b0: 7761 7264 5f77 696e 5f75 6e70 6172 7428  ward_win_unpart(
+000663c0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000663d0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+000663e0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+000663f0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00066400: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00066410: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00066420: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00066430: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00066440: 6f70 7430 2c0a 2020 2020 2020 2020 7374  opt0,.        st
+00066450: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00066460: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
+00066470: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
+00066480: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+00066490: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+000664a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000664b0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000664c0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000664d0: 7264 5f77 696e 5f75 6e70 6172 745f 6633  rd_win_unpart_f3
+000664e0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+000664f0: 6f70 7430 2c20 6473 7429 3b0a 2020 2020  opt0, dst);.    
+00066500: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00066510: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+00066520: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00066530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066540: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00066550: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00066560: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+00066570: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+00066580: 655f 666f 7277 6172 645f 6d61 705f 756e  e_forward_map_un
+00066590: 6172 790a 0a73 7461 7469 6320 766f 6964  ary..static void
+000665a0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000665b0: 7277 6172 645f 6d61 705f 756e 6172 795f  rward_map_unary_
+000665c0: 6633 3228 0a20 2020 2020 2020 2063 6f6e  f32(.        con
+000665d0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+000665e0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+000665f0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00066600: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00066610: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00066620: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00066630: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00066640: 742c 0a20 2020 2020 2020 2063 6f6e 7374  t,.        const
+00066650: 2067 676d 6c5f 756e 6172 795f 6f70 5f66   ggml_unary_op_f
+00066660: 3332 5f74 2066 756e 2920 7b0a 2020 2020  32_t fun) {.    
+00066670: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+00066680: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
+00066690: 7372 6330 2c20 6473 7429 293b 0a0a 2020  src0, dst));..  
+000666a0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+000666b0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000666c0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+000666d0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000666e0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+000666f0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+00066700: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+00066710: 6e74 206e 2020 3d20 6767 6d6c 5f6e 726f  nt n  = ggml_nro
+00066720: 7773 2873 7263 3029 3b0a 2020 2020 636f  ws(src0);.    co
+00066730: 6e73 7420 696e 7420 6e63 203d 2073 7263  nst int nc = src
+00066740: 302d 3e6e 655b 305d 3b0a 0a20 2020 2061  0->ne[0];..    a
+00066750: 7373 6572 7428 2064 7374 2d3e 6e62 5b30  ssert( dst->nb[0
+00066760: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00066770: 7429 293b 0a20 2020 2061 7373 6572 7428  t));.    assert(
+00066780: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2073  src0->nb[0] == s
+00066790: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+000667a0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+000667b0: 2030 3b20 6920 3c20 6e3b 2069 2b2b 2920   0; i < n; i++) 
+000667c0: 7b0a 2020 2020 2020 2020 6675 6e28 6e63  {.        fun(nc
+000667d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000667e0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+000667f0: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
+00066800: 202b 2069 2a28 2064 7374 2d3e 6e62 5b31   + i*( dst->nb[1
+00066810: 5d29 292c 0a20 2020 2020 2020 2020 2020  ])),.           
+00066820: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00066830: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
+00066840: 6174 6120 2b20 692a 2873 7263 302d 3e6e  ata + i*(src0->n
+00066850: 625b 315d 2929 293b 0a20 2020 207d 0a7d  b[1])));.    }.}
+00066860: 0a0a 0a73 7461 7469 6320 766f 6964 2067  ...static void g
+00066870: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00066880: 6172 645f 6d61 705f 756e 6172 7928 0a20  ard_map_unary(. 
+00066890: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+000668a0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+000668b0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+000668c0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+000668d0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000668e0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+000668f0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00066900: 656e 736f 7220 2a20 6473 742c 0a20 2020  ensor * dst,.   
+00066910: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
+00066920: 756e 6172 795f 6f70 5f66 3332 5f74 2066  unary_op_f32_t f
+00066930: 756e 2920 7b0a 2020 2020 7377 6974 6368  un) {.    switch
+00066940: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
+00066950: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00066960: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00066970: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00066980: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00066990: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+000669a0: 6170 5f75 6e61 7279 5f66 3332 2870 6172  ap_unary_f32(par
+000669b0: 616d 732c 2073 7263 302c 2064 7374 2c20  ams, src0, dst, 
+000669c0: 6675 6e29 3b0a 2020 2020 2020 2020 2020  fun);.          
+000669d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000669e0: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+000669f0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00066a00: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00066a10: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+00066a20: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00066a30: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+00066a40: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00066a50: 6172 645f 6d61 705f 6269 6e61 7279 0a0a  ard_map_binary..
+00066a60: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00066a70: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00066a80: 5f6d 6170 5f62 696e 6172 795f 6633 3228  _map_binary_f32(
+00066a90: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00066aa0: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00066ab0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00066ac0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00066ad0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00066ae0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00066af0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00066b00: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00066b10: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
+00066b20: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00066b30: 202a 2064 7374 2c0a 2020 2020 2020 2020   * dst,.        
+00066b40: 636f 6e73 7420 6767 6d6c 5f62 696e 6172  const ggml_binar
+00066b50: 795f 6f70 5f66 3332 5f74 2066 756e 2920  y_op_f32_t fun) 
+00066b60: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
+00066b70: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
+00066b80: 2020 2020 6173 7365 7274 2867 676d 6c5f      assert(ggml_
+00066b90: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
+00066ba0: 7263 302c 2073 7263 3129 2026 2620 6767  rc0, src1) && gg
+00066bb0: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
+00066bc0: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
+00066bd0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00066be0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00066bf0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00066c00: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00066c10: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00066c20: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00066c30: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00066c40: 2069 6e74 206e 2020 3d20 6767 6d6c 5f6e   int n  = ggml_n
+00066c50: 726f 7773 2873 7263 3029 3b0a 2020 2020  rows(src0);.    
+00066c60: 636f 6e73 7420 696e 7420 6e63 203d 2073  const int nc = s
+00066c70: 7263 302d 3e6e 655b 305d 3b0a 0a20 2020  rc0->ne[0];..   
+00066c80: 2061 7373 6572 7428 2064 7374 2d3e 6e62   assert( dst->nb
+00066c90: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+00066ca0: 6f61 7429 293b 0a20 2020 2061 7373 6572  oat));.    asser
+00066cb0: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
+00066cc0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00066cd0: 0a20 2020 2061 7373 6572 7428 7372 6331  .    assert(src1
+00066ce0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00066cf0: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00066d00: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+00066d10: 6920 3c20 6e3b 2069 2b2b 2920 7b0a 2020  i < n; i++) {.  
+00066d20: 2020 2020 2020 6675 6e28 6e63 2c0a 2020        fun(nc,.  
+00066d30: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00066d40: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00066d50: 2920 6473 742d 3e64 6174 6120 202b 2069  ) dst->data  + i
+00066d60: 2a28 2064 7374 2d3e 6e62 5b31 5d29 292c  *( dst->nb[1])),
+00066d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00066d80: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00066d90: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+00066da0: 2b20 692a 2873 7263 302d 3e6e 625b 315d  + i*(src0->nb[1]
+00066db0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00066dc0: 2020 2020 2866 6c6f 6174 202a 2920 2828      (float *) ((
+00066dd0: 6368 6172 202a 2920 7372 6331 2d3e 6461  char *) src1->da
+00066de0: 7461 202b 2069 2a28 7372 6331 2d3e 6e62  ta + i*(src1->nb
+00066df0: 5b31 5d29 2929 3b0a 2020 2020 7d0a 7d0a  [1])));.    }.}.
+00066e00: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00066e10: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00066e20: 7264 5f6d 6170 5f62 696e 6172 7928 0a20  rd_map_binary(. 
+00066e30: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00066e40: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00066e50: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00066e60: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00066e70: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00066e80: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00066e90: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00066ea0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00066eb0: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+00066ec0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00066ed0: 2064 7374 2c0a 2020 2020 2020 2020 636f   dst,.        co
+00066ee0: 6e73 7420 6767 6d6c 5f62 696e 6172 795f  nst ggml_binary_
+00066ef0: 6f70 5f66 3332 5f74 2066 756e 2920 7b0a  op_f32_t fun) {.
+00066f00: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+00066f10: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00066f20: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00066f30: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+00066f40: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00066f50: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00066f60: 5f66 6f72 7761 7264 5f6d 6170 5f62 696e  _forward_map_bin
+00066f70: 6172 795f 6633 3228 7061 7261 6d73 2c20  ary_f32(params, 
+00066f80: 7372 6330 2c20 7372 6331 2c20 6473 742c  src0, src1, dst,
+00066f90: 2066 756e 293b 0a20 2020 2020 2020 2020   fun);.         
+00066fa0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00066fb0: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
+00066fc0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00066fd0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00066fe0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00066ff0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00067000: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f2f  ak;.    }.}..///
 00067010: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00067020: 2f2f 2f2f 2f2f 2f2f 2f0a 0a73 7461 7469  /////////..stati
-00067030: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00067040: 7574 655f 666f 7277 6172 6428 7374 7275  ute_forward(stru
-00067050: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00067060: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00067070: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00067080: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
-00067090: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000670a0: 7061 7261 6d73 293b 0a0a 2020 2020 7377  params);..    sw
-000670b0: 6974 6368 2028 7465 6e73 6f72 2d3e 6f70  itch (tensor->op
-000670c0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-000670d0: 2047 474d 4c5f 4f50 5f44 5550 3a0a 2020   GGML_OP_DUP:.  
-000670e0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000670f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00067100: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00067110: 5f64 7570 2870 6172 616d 732c 2074 656e  _dup(params, ten
-00067120: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00067130: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00067140: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00067150: 2063 6173 6520 4747 4d4c 5f4f 505f 4144   case GGML_OP_AD
-00067160: 443a 0a20 2020 2020 2020 2020 2020 207b  D:.            {
-00067170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067180: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00067190: 7277 6172 645f 6164 6428 7061 7261 6d73  rward_add(params
-000671a0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-000671b0: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
-000671c0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-000671d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000671e0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000671f0: 5f41 4444 313a 0a20 2020 2020 2020 2020  _ADD1:.         
-00067200: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00067210: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00067220: 655f 666f 7277 6172 645f 6164 6431 2870  e_forward_add1(p
-00067230: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00067240: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
-00067250: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
-00067260: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00067270: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00067280: 4d4c 5f4f 505f 4143 433a 0a20 2020 2020  ML_OP_ACC:.     
-00067290: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000672a0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000672b0: 6d70 7574 655f 666f 7277 6172 645f 6163  mpute_forward_ac
-000672c0: 6328 7061 7261 6d73 2c20 7465 6e73 6f72  c(params, tensor
-000672d0: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
-000672e0: 7372 6331 2c20 7465 6e73 6f72 2d3e 6f70  src1, tensor->op
-000672f0: 745b 305d 2c20 7465 6e73 6f72 293b 0a20  t[0], tensor);. 
-00067300: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00067310: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00067320: 2047 474d 4c5f 4f50 5f53 5542 3a0a 2020   GGML_OP_SUB:.  
-00067330: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00067340: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00067350: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00067360: 5f73 7562 2870 6172 616d 732c 2074 656e  _sub(params, ten
-00067370: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00067380: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-00067390: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000673a0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000673b0: 6173 6520 4747 4d4c 5f4f 505f 4d55 4c3a  ase GGML_OP_MUL:
-000673c0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000673d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000673e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000673f0: 6172 645f 6d75 6c28 7061 7261 6d73 2c20  ard_mul(params, 
-00067400: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00067410: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-00067420: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00067430: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00067440: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-00067450: 4956 3a0a 2020 2020 2020 2020 2020 2020  IV:.            
-00067460: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00067470: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00067480: 6f72 7761 7264 5f64 6976 2870 6172 616d  orward_div(param
-00067490: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-000674a0: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
-000674b0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-000674c0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-000674d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000674e0: 505f 5351 523a 0a20 2020 2020 2020 2020  P_SQR:.         
-000674f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00067500: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00067510: 655f 666f 7277 6172 645f 7371 7228 7061  e_forward_sqr(pa
-00067520: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00067530: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
-00067540: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00067550: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00067560: 474d 4c5f 4f50 5f53 5152 543a 0a20 2020  GML_OP_SQRT:.   
-00067570: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00067580: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00067590: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000675a0: 7371 7274 2870 6172 616d 732c 2074 656e  sqrt(params, ten
-000675b0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-000675c0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-000675d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000675e0: 2063 6173 6520 4747 4d4c 5f4f 505f 4c4f   case GGML_OP_LO
-000675f0: 473a 0a20 2020 2020 2020 2020 2020 207b  G:.            {
-00067600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067610: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00067620: 7277 6172 645f 6c6f 6728 7061 7261 6d73  rward_log(params
-00067630: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00067640: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00067650: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00067660: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00067670: 4f50 5f53 554d 3a0a 2020 2020 2020 2020  OP_SUM:.        
-00067680: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00067690: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-000676a0: 7465 5f66 6f72 7761 7264 5f73 756d 2870  te_forward_sum(p
-000676b0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-000676c0: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
-000676d0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000676e0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000676f0: 4747 4d4c 5f4f 505f 5355 4d5f 524f 5753  GGML_OP_SUM_ROWS
-00067700: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00067710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067720: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00067730: 7761 7264 5f73 756d 5f72 6f77 7328 7061  ward_sum_rows(pa
-00067740: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00067750: 6330 2c20 7465 6e73 6f72 293b 0a20 2020  c0, tensor);.   
-00067760: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00067770: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00067780: 474d 4c5f 4f50 5f4d 4541 4e3a 0a20 2020  GML_OP_MEAN:.   
-00067790: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000677a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000677b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000677c0: 6d65 616e 2870 6172 616d 732c 2074 656e  mean(params, ten
-000677d0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-000677e0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-000677f0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00067800: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
-00067810: 5045 4154 3a0a 2020 2020 2020 2020 2020  PEAT:.          
-00067820: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00067830: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00067840: 5f66 6f72 7761 7264 5f72 6570 6561 7428  _forward_repeat(
-00067850: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00067860: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00067870: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00067880: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00067890: 2047 474d 4c5f 4f50 5f41 4253 3a0a 2020   GGML_OP_ABS:.  
-000678a0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000678b0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000678c0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000678d0: 5f61 6273 2870 6172 616d 732c 2074 656e  _abs(params, ten
-000678e0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-000678f0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00067900: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00067910: 2063 6173 6520 4747 4d4c 5f4f 505f 5347   case GGML_OP_SG
-00067920: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
-00067930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067940: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00067950: 7277 6172 645f 7367 6e28 7061 7261 6d73  rward_sgn(params
-00067960: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
-00067970: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00067980: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00067990: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000679a0: 4f50 5f4e 4547 3a0a 2020 2020 2020 2020  OP_NEG:.        
-000679b0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000679c0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-000679d0: 7465 5f66 6f72 7761 7264 5f6e 6567 2870  te_forward_neg(p
-000679e0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-000679f0: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
-00067a00: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00067a10: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00067a20: 4747 4d4c 5f4f 505f 5354 4550 3a0a 2020  GGML_OP_STEP:.  
-00067a30: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00067a40: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00067a50: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00067a60: 5f73 7465 7028 7061 7261 6d73 2c20 7465  _step(params, te
-00067a70: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-00067a80: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00067a90: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00067aa0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00067ab0: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
-00067ac0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00067ad0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00067ae0: 666f 7277 6172 645f 7265 6c75 2870 6172  forward_relu(par
-00067af0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00067b00: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-00067b10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00067b20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00067b30: 4d4c 5f4f 505f 4745 4c55 3a0a 2020 2020  ML_OP_GELU:.    
-00067b40: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00067b50: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00067b60: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
-00067b70: 656c 7528 7061 7261 6d73 2c20 7465 6e73  elu(params, tens
-00067b80: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00067b90: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00067ba0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00067bb0: 6361 7365 2047 474d 4c5f 4f50 5f53 494c  case GGML_OP_SIL
-00067bc0: 553a 0a20 2020 2020 2020 2020 2020 207b  U:.            {
-00067bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067be0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00067bf0: 7277 6172 645f 7369 6c75 2870 6172 616d  rward_silu(param
-00067c00: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00067c10: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00067c20: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00067c30: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00067c40: 5f4f 505f 5349 4c55 5f42 4143 4b3a 0a20  _OP_SILU_BACK:. 
-00067c50: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00067c60: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00067c70: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00067c80: 645f 7369 6c75 5f62 6163 6b28 7061 7261  d_silu_back(para
-00067c90: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00067ca0: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-00067cb0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00067cc0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00067cd0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00067ce0: 4f50 5f4e 4f52 4d3a 0a20 2020 2020 2020  OP_NORM:.       
-00067cf0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00067d00: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00067d10: 7574 655f 666f 7277 6172 645f 6e6f 726d  ute_forward_norm
-00067d20: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00067d30: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-00067d40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00067d50: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00067d60: 6520 4747 4d4c 5f4f 505f 524d 535f 4e4f  e GGML_OP_RMS_NO
-00067d70: 524d 3a0a 2020 2020 2020 2020 2020 2020  RM:.            
-00067d80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00067d90: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00067da0: 6f72 7761 7264 5f72 6d73 5f6e 6f72 6d28  orward_rms_norm(
-00067db0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00067dc0: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
-00067dd0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00067de0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00067df0: 2047 474d 4c5f 4f50 5f52 4d53 5f4e 4f52   GGML_OP_RMS_NOR
-00067e00: 4d5f 4241 434b 3a0a 2020 2020 2020 2020  M_BACK:.        
-00067e10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00067e20: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00067e30: 7465 5f66 6f72 7761 7264 5f72 6d73 5f6e  te_forward_rms_n
-00067e40: 6f72 6d5f 6261 636b 2870 6172 616d 732c  orm_back(params,
-00067e50: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00067e60: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
-00067e70: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00067e80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00067e90: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00067ea0: 4d55 4c5f 4d41 543a 0a20 2020 2020 2020  MUL_MAT:.       
-00067eb0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00067ec0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00067ed0: 7574 655f 666f 7277 6172 645f 6d75 6c5f  ute_forward_mul_
-00067ee0: 6d61 7428 7061 7261 6d73 2c20 7465 6e73  mat(params, tens
-00067ef0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
-00067f00: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
-00067f10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00067f20: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00067f30: 7365 2047 474d 4c5f 4f50 5f53 4341 4c45  se GGML_OP_SCALE
-00067f40: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00067f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067f60: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00067f70: 7761 7264 5f73 6361 6c65 2870 6172 616d  ward_scale(param
-00067f80: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
-00067f90: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
-00067fa0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00067fb0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00067fc0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00067fd0: 505f 5345 543a 0a20 2020 2020 2020 2020  P_SET:.         
-00067fe0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00067ff0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00068000: 655f 666f 7277 6172 645f 7365 7428 7061  e_forward_set(pa
-00068010: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00068020: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-00068030: 2c20 7465 6e73 6f72 2d3e 6f70 745b 305d  , tensor->opt[0]
-00068040: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00068050: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00068060: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00068070: 4c5f 4f50 5f43 5059 3a0a 2020 2020 2020  L_OP_CPY:.      
-00068080: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00068090: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-000680a0: 7075 7465 5f66 6f72 7761 7264 5f63 7079  pute_forward_cpy
-000680b0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-000680c0: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
-000680d0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000680e0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000680f0: 6520 4747 4d4c 5f4f 505f 434f 4e54 3a0a  e GGML_OP_CONT:.
-00068100: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00068110: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00068120: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00068130: 7264 5f63 6f6e 7428 7061 7261 6d73 2c20  rd_cont(params, 
-00068140: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-00068150: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00068160: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00068170: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00068180: 5f52 4553 4841 5045 3a0a 2020 2020 2020  _RESHAPE:.      
-00068190: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000681a0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-000681b0: 7075 7465 5f66 6f72 7761 7264 5f72 6573  pute_forward_res
-000681c0: 6861 7065 2870 6172 616d 732c 2074 656e  hape(params, ten
-000681d0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-000681e0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-000681f0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00068200: 2063 6173 6520 4747 4d4c 5f4f 505f 5649   case GGML_OP_VI
-00068210: 4557 3a0a 2020 2020 2020 2020 2020 2020  EW:.            
-00068220: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00068230: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00068240: 6f72 7761 7264 5f76 6965 7728 7061 7261  orward_view(para
-00068250: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00068260: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00068270: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00068280: 6361 7365 2047 474d 4c5f 4f50 5f50 4552  case GGML_OP_PER
-00068290: 4d55 5445 3a0a 2020 2020 2020 2020 2020  MUTE:.          
-000682a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000682b0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-000682c0: 5f66 6f72 7761 7264 5f70 6572 6d75 7465  _forward_permute
-000682d0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-000682e0: 3e73 7263 3029 3b0a 2020 2020 2020 2020  >src0);.        
-000682f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00068300: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00068310: 505f 5452 414e 5350 4f53 453a 0a20 2020  P_TRANSPOSE:.   
-00068320: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00068330: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00068340: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00068350: 7472 616e 7370 6f73 6528 7061 7261 6d73  transpose(params
-00068360: 2c20 7465 6e73 6f72 2d3e 7372 6330 293b  , tensor->src0);
-00068370: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00068380: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00068390: 7365 2047 474d 4c5f 4f50 5f47 4554 5f52  se GGML_OP_GET_R
-000683a0: 4f57 533a 0a20 2020 2020 2020 2020 2020  OWS:.           
-000683b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000683c0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-000683d0: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
-000683e0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-000683f0: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
-00068400: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
-00068410: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00068420: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00068430: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-00068440: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
-00068450: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00068460: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00068470: 655f 666f 7277 6172 645f 6765 745f 726f  e_forward_get_ro
-00068480: 7773 5f62 6163 6b28 7061 7261 6d73 2c20  ws_back(params, 
-00068490: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
-000684a0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
-000684b0: 6f72 2d3e 6f70 745b 305d 2c20 7465 6e73  or->opt[0], tens
-000684c0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-000684d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000684e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-000684f0: 4941 473a 0a20 2020 2020 2020 2020 2020  IAG:.           
-00068500: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00068510: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00068520: 666f 7277 6172 645f 6469 6167 2870 6172  forward_diag(par
-00068530: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00068540: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
-00068550: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00068560: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00068570: 4d4c 5f4f 505f 4449 4147 5f4d 4153 4b5f  ML_OP_DIAG_MASK_
-00068580: 494e 463a 0a20 2020 2020 2020 2020 2020  INF:.           
-00068590: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000685a0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-000685b0: 666f 7277 6172 645f 6469 6167 5f6d 6173  forward_diag_mas
-000685c0: 6b5f 696e 6628 7061 7261 6d73 2c20 7465  k_inf(params, te
-000685d0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
-000685e0: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
-000685f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00068600: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00068610: 6361 7365 2047 474d 4c5f 4f50 5f44 4941  case GGML_OP_DIA
-00068620: 475f 4d41 534b 5f5a 4552 4f3a 0a20 2020  G_MASK_ZERO:.   
-00068630: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00068640: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00068650: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00068660: 6469 6167 5f6d 6173 6b5f 7a65 726f 2870  diag_mask_zero(p
-00068670: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00068680: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
-00068690: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
-000686a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000686b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000686c0: 4d4c 5f4f 505f 534f 4654 5f4d 4158 3a0a  ML_OP_SOFT_MAX:.
-000686d0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000686e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000686f0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00068700: 7264 5f73 6f66 745f 6d61 7828 7061 7261  rd_soft_max(para
-00068710: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00068720: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00068730: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00068740: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00068750: 4c5f 4f50 5f52 4f50 453a 0a20 2020 2020  L_OP_ROPE:.     
-00068760: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00068770: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00068780: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
-00068790: 7065 2870 6172 616d 732c 2074 656e 736f  pe(params, tenso
-000687a0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-000687b0: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
-000687c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000687d0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-000687e0: 6520 4747 4d4c 5f4f 505f 524f 5045 5f42  e GGML_OP_ROPE_B
-000687f0: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
-00068800: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00068810: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00068820: 666f 7277 6172 645f 726f 7065 5f62 6163  forward_rope_bac
-00068830: 6b28 7061 7261 6d73 2c20 7465 6e73 6f72  k(params, tensor
-00068840: 2d3e 7372 6330 2c20 7465 6e73 6f72 2d3e  ->src0, tensor->
-00068850: 7372 6331 2c20 7465 6e73 6f72 293b 0a20  src1, tensor);. 
-00068860: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00068870: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00068880: 2047 474d 4c5f 4f50 5f41 4c49 4249 3a0a   GGML_OP_ALIBI:.
-00068890: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-000688a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-000688b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000688c0: 7264 5f61 6c69 6269 2870 6172 616d 732c  rd_alibi(params,
-000688d0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-000688e0: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
-000688f0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00068900: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00068910: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00068920: 434c 414d 503a 0a20 2020 2020 2020 2020  CLAMP:.         
-00068930: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00068940: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00068950: 655f 666f 7277 6172 645f 636c 616d 7028  e_forward_clamp(
-00068960: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00068970: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
-00068980: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
-00068990: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000689a0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000689b0: 474d 4c5f 4f50 5f43 4f4e 565f 3144 5f53  GML_OP_CONV_1D_S
-000689c0: 315f 5048 3a0a 2020 2020 2020 2020 2020  1_PH:.          
-000689d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000689e0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-000689f0: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
-00068a00: 5f73 315f 7068 2870 6172 616d 732c 2074  _s1_ph(params, t
-00068a10: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-00068a20: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
-00068a30: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00068a40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00068a50: 2063 6173 6520 4747 4d4c 5f4f 505f 434f   case GGML_OP_CO
-00068a60: 4e56 5f31 445f 5332 5f50 483a 0a20 2020  NV_1D_S2_PH:.   
-00068a70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00068a80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00068a90: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00068aa0: 636f 6e76 5f31 645f 7332 5f70 6828 7061  conv_1d_s2_ph(pa
-00068ab0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00068ac0: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
-00068ad0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00068ae0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00068af0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00068b00: 4c5f 4f50 5f43 4f4e 565f 3244 5f53 4b5f  L_OP_CONV_2D_SK_
-00068b10: 5030 3a0a 2020 2020 2020 2020 2020 2020  P0:.            
-00068b20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00068b30: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00068b40: 6f72 7761 7264 5f63 6f6e 765f 3264 5f73  orward_conv_2d_s
-00068b50: 6b5f 7030 2870 6172 616d 732c 2074 656e  k_p0(params, ten
-00068b60: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
-00068b70: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
-00068b80: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00068b90: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00068ba0: 6173 6520 4747 4d4c 5f4f 505f 464c 4153  ase GGML_OP_FLAS
-00068bb0: 485f 4154 544e 3a0a 2020 2020 2020 2020  H_ATTN:.        
-00068bc0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00068bd0: 2020 2020 2020 636f 6e73 7420 696e 7433        const int3
-00068be0: 325f 7420 7420 3d20 6767 6d6c 5f67 6574  2_t t = ggml_get
-00068bf0: 5f69 3332 5f31 6428 7465 6e73 6f72 2d3e  _i32_1d(tensor->
-00068c00: 6f70 745b 315d 2c20 3029 3b0a 2020 2020  opt[1], 0);.    
-00068c10: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00068c20: 5f41 5353 4552 5428 7420 3d3d 2030 207c  _ASSERT(t == 0 |
-00068c30: 7c20 7420 3d3d 2031 293b 0a20 2020 2020  | t == 1);.     
-00068c40: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00068c50: 2062 6f6f 6c20 6d61 736b 6564 203d 2074   bool masked = t
-00068c60: 2021 3d20 303b 0a20 2020 2020 2020 2020   != 0;.         
-00068c70: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00068c80: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
-00068c90: 685f 6174 746e 2870 6172 616d 732c 2074  h_attn(params, t
-00068ca0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
-00068cb0: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
-00068cc0: 722d 3e6f 7074 5b30 5d2c 206d 6173 6b65  r->opt[0], maske
-00068cd0: 642c 2074 656e 736f 7229 3b0a 2020 2020  d, tensor);.    
-00068ce0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00068cf0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00068d00: 4d4c 5f4f 505f 464c 4153 485f 4646 3a0a  ML_OP_FLASH_FF:.
-00068d10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00068d20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00068d30: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00068d40: 7264 5f66 6c61 7368 5f66 6628 7061 7261  rd_flash_ff(para
-00068d50: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00068d60: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
-00068d70: 7465 6e73 6f72 2d3e 6f70 745b 305d 2c20  tensor->opt[0], 
-00068d80: 7465 6e73 6f72 2d3e 6f70 745b 315d 2c20  tensor->opt[1], 
-00068d90: 7465 6e73 6f72 2d3e 6f70 745b 325d 2c20  tensor->opt[2], 
-00068da0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00068db0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00068dc0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00068dd0: 4f50 5f57 494e 5f50 4152 543a 0a20 2020  OP_WIN_PART:.   
-00068de0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00068df0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00068e00: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00068e10: 7769 6e5f 7061 7274 2870 6172 616d 732c  win_part(params,
-00068e20: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
-00068e30: 656e 736f 722d 3e6f 7074 5b30 5d2c 2074  ensor->opt[0], t
-00068e40: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00068e50: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00068e60: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00068e70: 505f 5749 4e5f 554e 5041 5254 3a0a 2020  P_WIN_UNPART:.  
-00068e80: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00068e90: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00068ea0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00068eb0: 5f77 696e 5f75 6e70 6172 7428 7061 7261  _win_unpart(para
-00068ec0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
-00068ed0: 2c20 7465 6e73 6f72 2d3e 6f70 745b 305d  , tensor->opt[0]
-00068ee0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00068ef0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00068f00: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00068f10: 4c5f 4f50 5f4d 4150 5f55 4e41 5259 3a0a  L_OP_MAP_UNARY:.
-00068f20: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00068f30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00068f40: 6e73 7420 6767 6d6c 5f75 6e61 7279 5f6f  nst ggml_unary_o
-00068f50: 705f 6633 325f 7420 6675 6e20 3d20 2a28  p_f32_t fun = *(
-00068f60: 2867 676d 6c5f 756e 6172 795f 6f70 5f66  (ggml_unary_op_f
-00068f70: 3332 5f74 202a 2974 656e 736f 722d 3e6f  32_t *)tensor->o
-00068f80: 7074 5b30 5d2d 3e64 6174 6129 3b0a 2020  pt[0]->data);.  
-00068f90: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00068fa0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00068fb0: 7264 5f6d 6170 5f75 6e61 7279 2870 6172  rd_map_unary(par
-00068fc0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00068fd0: 302c 2074 656e 736f 722c 2066 756e 293b  0, tensor, fun);
-00068fe0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00068ff0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00069000: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00069010: 474d 4c5f 4f50 5f4d 4150 5f42 494e 4152  GML_OP_MAP_BINAR
-00069020: 593a 0a20 2020 2020 2020 2020 2020 207b  Y:.            {
-00069030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00069040: 2063 6f6e 7374 2067 676d 6c5f 6269 6e61   const ggml_bina
-00069050: 7279 5f6f 705f 6633 325f 7420 6675 6e20  ry_op_f32_t fun 
-00069060: 3d20 2a28 2867 676d 6c5f 6269 6e61 7279  = *((ggml_binary
-00069070: 5f6f 705f 6633 325f 7420 2a29 7465 6e73  _op_f32_t *)tens
-00069080: 6f72 2d3e 6f70 745b 305d 2d3e 6461 7461  or->opt[0]->data
-00069090: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000690a0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-000690b0: 666f 7277 6172 645f 6d61 705f 6269 6e61  forward_map_bina
-000690c0: 7279 2870 6172 616d 732c 2074 656e 736f  ry(params, tenso
-000690d0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
-000690e0: 3e73 7263 312c 2074 656e 736f 722c 2066  >src1, tensor, f
-000690f0: 756e 293b 0a20 2020 2020 2020 2020 2020  un);.           
-00069100: 207d 0a20 2020 2020 2020 2020 2020 2062   }.            b
-00069110: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00069120: 7365 2047 474d 4c5f 4f50 5f4e 4f4e 453a  se GGML_OP_NONE:
-00069130: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00069140: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00069150: 2f20 6e6f 700a 2020 2020 2020 2020 2020  / nop.          
-00069160: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00069170: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00069180: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
-00069190: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000691a0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-000691b0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-000691c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000691d0: 2020 7d0a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f    }.}../////////
+00067020: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a  //////////////..
+00067030: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00067040: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00067050: 2873 7472 7563 7420 6767 6d6c 5f63 6f6d  (struct ggml_com
+00067060: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00067070: 7261 6d73 2c20 7374 7275 6374 2067 676d  rams, struct ggm
+00067080: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
+00067090: 7229 207b 0a20 2020 2047 474d 4c5f 4153  r) {.    GGML_AS
+000670a0: 5345 5254 2870 6172 616d 7329 3b0a 0a20  SERT(params);.. 
+000670b0: 2020 2073 7769 7463 6820 2874 656e 736f     switch (tenso
+000670c0: 722d 3e6f 7029 207b 0a20 2020 2020 2020  r->op) {.       
+000670d0: 2063 6173 6520 4747 4d4c 5f4f 505f 4455   case GGML_OP_DU
+000670e0: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
+000670f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00067100: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00067110: 7277 6172 645f 6475 7028 7061 7261 6d73  rward_dup(params
+00067120: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+00067130: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00067140: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00067150: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00067160: 4f50 5f41 4444 3a0a 2020 2020 2020 2020  OP_ADD:.        
+00067170: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00067180: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00067190: 7465 5f66 6f72 7761 7264 5f61 6464 2870  te_forward_add(p
+000671a0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+000671b0: 7263 302c 2074 656e 736f 722d 3e73 7263  rc0, tensor->src
+000671c0: 312c 2074 656e 736f 7229 3b0a 2020 2020  1, tensor);.    
+000671d0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000671e0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000671f0: 4d4c 5f4f 505f 4144 4431 3a0a 2020 2020  ML_OP_ADD1:.    
+00067200: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00067210: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00067220: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
+00067230: 6464 3128 7061 7261 6d73 2c20 7465 6e73  dd1(params, tens
+00067240: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00067250: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
+00067260: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00067270: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00067280: 7365 2047 474d 4c5f 4f50 5f41 4343 3a0a  se GGML_OP_ACC:.
+00067290: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000672a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000672b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000672c0: 7264 5f61 6363 2870 6172 616d 732c 2074  rd_acc(params, t
+000672d0: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+000672e0: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+000672f0: 722d 3e6f 7074 5b30 5d2c 2074 656e 736f  r->opt[0], tenso
+00067300: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00067310: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00067320: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
+00067330: 423a 0a20 2020 2020 2020 2020 2020 207b  B:.            {
+00067340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00067350: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00067360: 7277 6172 645f 7375 6228 7061 7261 6d73  rward_sub(params
+00067370: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+00067380: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
+00067390: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+000673a0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000673b0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000673c0: 5f4d 554c 3a0a 2020 2020 2020 2020 2020  _MUL:.          
+000673d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+000673e0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+000673f0: 5f66 6f72 7761 7264 5f6d 756c 2870 6172  _forward_mul(par
+00067400: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00067410: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
+00067420: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00067430: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00067440: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00067450: 5f4f 505f 4449 563a 0a20 2020 2020 2020  _OP_DIV:.       
+00067460: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00067470: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00067480: 7574 655f 666f 7277 6172 645f 6469 7628  ute_forward_div(
+00067490: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+000674a0: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+000674b0: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+000674c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000674d0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000674e0: 474d 4c5f 4f50 5f53 5152 3a0a 2020 2020  GML_OP_SQR:.    
+000674f0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00067500: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00067510: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00067520: 7172 2870 6172 616d 732c 2074 656e 736f  qr(params, tenso
+00067530: 722d 3e73 7263 302c 2074 656e 736f 7229  r->src0, tensor)
+00067540: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00067550: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00067560: 6173 6520 4747 4d4c 5f4f 505f 5351 5254  ase GGML_OP_SQRT
+00067570: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00067580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067590: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000675a0: 7761 7264 5f73 7172 7428 7061 7261 6d73  ward_sqrt(params
+000675b0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+000675c0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+000675d0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000675e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000675f0: 4f50 5f4c 4f47 3a0a 2020 2020 2020 2020  OP_LOG:.        
+00067600: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00067610: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00067620: 7465 5f66 6f72 7761 7264 5f6c 6f67 2870  te_forward_log(p
+00067630: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00067640: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
+00067650: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00067660: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00067670: 4747 4d4c 5f4f 505f 5355 4d3a 0a20 2020  GGML_OP_SUM:.   
+00067680: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00067690: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000676a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000676b0: 7375 6d28 7061 7261 6d73 2c20 7465 6e73  sum(params, tens
+000676c0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+000676d0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000676e0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000676f0: 6361 7365 2047 474d 4c5f 4f50 5f53 554d  case GGML_OP_SUM
+00067700: 5f52 4f57 533a 0a20 2020 2020 2020 2020  _ROWS:.         
+00067710: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00067720: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00067730: 655f 666f 7277 6172 645f 7375 6d5f 726f  e_forward_sum_ro
+00067740: 7773 2870 6172 616d 732c 2074 656e 736f  ws(params, tenso
+00067750: 722d 3e73 7263 302c 2074 656e 736f 7229  r->src0, tensor)
+00067760: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00067770: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00067780: 6173 6520 4747 4d4c 5f4f 505f 4d45 414e  ase GGML_OP_MEAN
+00067790: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000677a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000677b0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000677c0: 7761 7264 5f6d 6561 6e28 7061 7261 6d73  ward_mean(params
+000677d0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+000677e0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+000677f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00067800: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00067810: 4f50 5f52 4550 4541 543a 0a20 2020 2020  OP_REPEAT:.     
+00067820: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00067830: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00067840: 6d70 7574 655f 666f 7277 6172 645f 7265  mpute_forward_re
+00067850: 7065 6174 2870 6172 616d 732c 2074 656e  peat(params, ten
+00067860: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+00067870: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00067880: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00067890: 2063 6173 6520 4747 4d4c 5f4f 505f 4142   case GGML_OP_AB
+000678a0: 533a 0a20 2020 2020 2020 2020 2020 207b  S:.            {
+000678b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000678c0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000678d0: 7277 6172 645f 6162 7328 7061 7261 6d73  rward_abs(params
+000678e0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+000678f0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00067900: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00067910: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00067920: 4f50 5f53 474e 3a0a 2020 2020 2020 2020  OP_SGN:.        
+00067930: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00067940: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00067950: 7465 5f66 6f72 7761 7264 5f73 676e 2870  te_forward_sgn(p
+00067960: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00067970: 7263 302c 2074 656e 736f 7229 3b0a 2020  rc0, tensor);.  
+00067980: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00067990: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+000679a0: 4747 4d4c 5f4f 505f 4e45 473a 0a20 2020  GGML_OP_NEG:.   
+000679b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000679c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000679d0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000679e0: 6e65 6728 7061 7261 6d73 2c20 7465 6e73  neg(params, tens
+000679f0: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00067a00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00067a10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00067a20: 6361 7365 2047 474d 4c5f 4f50 5f53 5445  case GGML_OP_STE
+00067a30: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
+00067a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00067a50: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00067a60: 7277 6172 645f 7374 6570 2870 6172 616d  rward_step(param
+00067a70: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+00067a80: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00067a90: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00067aa0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00067ab0: 5f4f 505f 5245 4c55 3a0a 2020 2020 2020  _OP_RELU:.      
+00067ac0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00067ad0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00067ae0: 7075 7465 5f66 6f72 7761 7264 5f72 656c  pute_forward_rel
+00067af0: 7528 7061 7261 6d73 2c20 7465 6e73 6f72  u(params, tensor
+00067b00: 2d3e 7372 6330 2c20 7465 6e73 6f72 293b  ->src0, tensor);
+00067b10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00067b20: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00067b30: 7365 2047 474d 4c5f 4f50 5f47 454c 553a  se GGML_OP_GELU:
+00067b40: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00067b50: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00067b60: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00067b70: 6172 645f 6765 6c75 2870 6172 616d 732c  ard_gelu(params,
+00067b80: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+00067b90: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00067ba0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00067bb0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00067bc0: 505f 5349 4c55 3a0a 2020 2020 2020 2020  P_SILU:.        
+00067bd0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00067be0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00067bf0: 7465 5f66 6f72 7761 7264 5f73 696c 7528  te_forward_silu(
+00067c00: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00067c10: 7372 6330 2c20 7465 6e73 6f72 293b 0a20  src0, tensor);. 
+00067c20: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00067c30: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00067c40: 2047 474d 4c5f 4f50 5f53 494c 555f 4241   GGML_OP_SILU_BA
+00067c50: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+00067c60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00067c70: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00067c80: 6f72 7761 7264 5f73 696c 755f 6261 636b  orward_silu_back
+00067c90: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00067ca0: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
+00067cb0: 7263 312c 2074 656e 736f 7229 3b0a 2020  rc1, tensor);.  
+00067cc0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00067cd0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00067ce0: 4747 4d4c 5f4f 505f 4e4f 524d 3a0a 2020  GGML_OP_NORM:.  
+00067cf0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00067d00: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00067d10: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00067d20: 5f6e 6f72 6d28 7061 7261 6d73 2c20 7465  _norm(params, te
+00067d30: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+00067d40: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00067d50: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00067d60: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+00067d70: 4d53 5f4e 4f52 4d3a 0a20 2020 2020 2020  MS_NORM:.       
+00067d80: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00067d90: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00067da0: 7574 655f 666f 7277 6172 645f 726d 735f  ute_forward_rms_
+00067db0: 6e6f 726d 2870 6172 616d 732c 2074 656e  norm(params, ten
+00067dc0: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+00067dd0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00067de0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00067df0: 2063 6173 6520 4747 4d4c 5f4f 505f 524d   case GGML_OP_RM
+00067e00: 535f 4e4f 524d 5f42 4143 4b3a 0a20 2020  S_NORM_BACK:.   
+00067e10: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00067e20: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00067e30: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00067e40: 726d 735f 6e6f 726d 5f62 6163 6b28 7061  rms_norm_back(pa
+00067e50: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00067e60: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
+00067e70: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00067e80: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00067e90: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00067ea0: 4c5f 4f50 5f4d 554c 5f4d 4154 3a0a 2020  L_OP_MUL_MAT:.  
+00067eb0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00067ec0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00067ed0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00067ee0: 5f6d 756c 5f6d 6174 2870 6172 616d 732c  _mul_mat(params,
+00067ef0: 2074 656e 736f 722d 3e73 7263 302c 2074   tensor->src0, t
+00067f00: 656e 736f 722d 3e73 7263 312c 2074 656e  ensor->src1, ten
+00067f10: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+00067f20: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00067f30: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00067f40: 5343 414c 453a 0a20 2020 2020 2020 2020  SCALE:.         
+00067f50: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00067f60: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00067f70: 655f 666f 7277 6172 645f 7363 616c 6528  e_forward_scale(
+00067f80: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00067f90: 7372 6330 2c20 7465 6e73 6f72 2d3e 7372  src0, tensor->sr
+00067fa0: 6331 2c20 7465 6e73 6f72 293b 0a20 2020  c1, tensor);.   
+00067fb0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00067fc0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00067fd0: 474d 4c5f 4f50 5f53 4554 3a0a 2020 2020  GML_OP_SET:.    
+00067fe0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00067ff0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00068000: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00068010: 6574 2870 6172 616d 732c 2074 656e 736f  et(params, tenso
+00068020: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+00068030: 3e73 7263 312c 2074 656e 736f 722d 3e6f  >src1, tensor->o
+00068040: 7074 5b30 5d2c 2074 656e 736f 7229 3b0a  pt[0], tensor);.
+00068050: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00068060: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00068070: 6520 4747 4d4c 5f4f 505f 4350 593a 0a20  e GGML_OP_CPY:. 
+00068080: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00068090: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000680a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000680b0: 645f 6370 7928 7061 7261 6d73 2c20 7465  d_cpy(params, te
+000680c0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+000680d0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+000680e0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+000680f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+00068100: 4f4e 543a 0a20 2020 2020 2020 2020 2020  ONT:.           
+00068110: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00068120: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00068130: 666f 7277 6172 645f 636f 6e74 2870 6172  forward_cont(par
+00068140: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00068150: 302c 2074 656e 736f 7229 3b0a 2020 2020  0, tensor);.    
+00068160: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00068170: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00068180: 4d4c 5f4f 505f 5245 5348 4150 453a 0a20  ML_OP_RESHAPE:. 
+00068190: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000681a0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000681b0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000681c0: 645f 7265 7368 6170 6528 7061 7261 6d73  d_reshape(params
+000681d0: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+000681e0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+000681f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00068200: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00068210: 4f50 5f56 4945 573a 0a20 2020 2020 2020  OP_VIEW:.       
+00068220: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00068230: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00068240: 7574 655f 666f 7277 6172 645f 7669 6577  ute_forward_view
+00068250: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00068260: 3e73 7263 3029 3b0a 2020 2020 2020 2020  >src0);.        
+00068270: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00068280: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00068290: 505f 5045 524d 5554 453a 0a20 2020 2020  P_PERMUTE:.     
+000682a0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000682b0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+000682c0: 6d70 7574 655f 666f 7277 6172 645f 7065  mpute_forward_pe
+000682d0: 726d 7574 6528 7061 7261 6d73 2c20 7465  rmute(params, te
+000682e0: 6e73 6f72 2d3e 7372 6330 293b 0a20 2020  nsor->src0);.   
+000682f0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00068300: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00068310: 474d 4c5f 4f50 5f54 5241 4e53 504f 5345  GML_OP_TRANSPOSE
+00068320: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00068330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068340: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00068350: 7761 7264 5f74 7261 6e73 706f 7365 2870  ward_transpose(p
+00068360: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00068370: 7263 3029 3b0a 2020 2020 2020 2020 2020  rc0);.          
+00068380: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00068390: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+000683a0: 4745 545f 524f 5753 3a0a 2020 2020 2020  GET_ROWS:.      
+000683b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000683c0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+000683d0: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
+000683e0: 5f72 6f77 7328 7061 7261 6d73 2c20 7465  _rows(params, te
+000683f0: 6e73 6f72 2d3e 7372 6330 2c20 7465 6e73  nsor->src0, tens
+00068400: 6f72 2d3e 7372 6331 2c20 7465 6e73 6f72  or->src1, tensor
+00068410: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00068420: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00068430: 6361 7365 2047 474d 4c5f 4f50 5f47 4554  case GGML_OP_GET
+00068440: 5f52 4f57 535f 4241 434b 3a0a 2020 2020  _ROWS_BACK:.    
+00068450: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00068460: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00068470: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
+00068480: 6574 5f72 6f77 735f 6261 636b 2870 6172  et_rows_back(par
+00068490: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+000684a0: 302c 2074 656e 736f 722d 3e73 7263 312c  0, tensor->src1,
+000684b0: 2074 656e 736f 722d 3e6f 7074 5b30 5d2c   tensor->opt[0],
+000684c0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+000684d0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000684e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000684f0: 5f4f 505f 4449 4147 3a0a 2020 2020 2020  _OP_DIAG:.      
+00068500: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00068510: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00068520: 7075 7465 5f66 6f72 7761 7264 5f64 6961  pute_forward_dia
+00068530: 6728 7061 7261 6d73 2c20 7465 6e73 6f72  g(params, tensor
+00068540: 2d3e 7372 6330 2c20 7465 6e73 6f72 293b  ->src0, tensor);
+00068550: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00068560: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00068570: 7365 2047 474d 4c5f 4f50 5f44 4941 475f  se GGML_OP_DIAG_
+00068580: 4d41 534b 5f49 4e46 3a0a 2020 2020 2020  MASK_INF:.      
+00068590: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000685a0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+000685b0: 7075 7465 5f66 6f72 7761 7264 5f64 6961  pute_forward_dia
+000685c0: 675f 6d61 736b 5f69 6e66 2870 6172 616d  g_mask_inf(param
+000685d0: 732c 2074 656e 736f 722d 3e73 7263 302c  s, tensor->src0,
+000685e0: 2074 656e 736f 722d 3e73 7263 312c 2074   tensor->src1, t
+000685f0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00068600: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00068610: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00068620: 505f 4449 4147 5f4d 4153 4b5f 5a45 524f  P_DIAG_MASK_ZERO
+00068630: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00068640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068650: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00068660: 7761 7264 5f64 6961 675f 6d61 736b 5f7a  ward_diag_mask_z
+00068670: 6572 6f28 7061 7261 6d73 2c20 7465 6e73  ero(params, tens
+00068680: 6f72 2d3e 7372 6330 2c20 7465 6e73 6f72  or->src0, tensor
+00068690: 2d3e 7372 6331 2c20 7465 6e73 6f72 293b  ->src1, tensor);
+000686a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000686b0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000686c0: 7365 2047 474d 4c5f 4f50 5f53 4f46 545f  se GGML_OP_SOFT_
+000686d0: 4d41 583a 0a20 2020 2020 2020 2020 2020  MAX:.           
+000686e0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000686f0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00068700: 666f 7277 6172 645f 736f 6674 5f6d 6178  forward_soft_max
+00068710: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00068720: 3e73 7263 302c 2074 656e 736f 7229 3b0a  >src0, tensor);.
+00068730: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00068740: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00068750: 6520 4747 4d4c 5f4f 505f 524f 5045 3a0a  e GGML_OP_ROPE:.
+00068760: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00068770: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00068780: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00068790: 7264 5f72 6f70 6528 7061 7261 6d73 2c20  rd_rope(params, 
+000687a0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+000687b0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+000687c0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+000687d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+000687e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+000687f0: 4f50 455f 4241 434b 3a0a 2020 2020 2020  OPE_BACK:.      
+00068800: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00068810: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00068820: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
+00068830: 655f 6261 636b 2870 6172 616d 732c 2074  e_back(params, t
+00068840: 656e 736f 722d 3e73 7263 302c 2074 656e  ensor->src0, ten
+00068850: 736f 722d 3e73 7263 312c 2074 656e 736f  sor->src1, tenso
+00068860: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00068870: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00068880: 2063 6173 6520 4747 4d4c 5f4f 505f 414c   case GGML_OP_AL
+00068890: 4942 493a 0a20 2020 2020 2020 2020 2020  IBI:.           
+000688a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000688b0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+000688c0: 666f 7277 6172 645f 616c 6962 6928 7061  forward_alibi(pa
+000688d0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+000688e0: 6330 2c20 7465 6e73 6f72 2d3e 7372 6331  c0, tensor->src1
+000688f0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00068900: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00068910: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00068920: 4c5f 4f50 5f43 4c41 4d50 3a0a 2020 2020  L_OP_CLAMP:.    
+00068930: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00068940: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00068950: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00068960: 6c61 6d70 2870 6172 616d 732c 2074 656e  lamp(params, ten
+00068970: 736f 722d 3e73 7263 302c 2074 656e 736f  sor->src0, tenso
+00068980: 722d 3e73 7263 312c 2074 656e 736f 7229  r->src1, tensor)
+00068990: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+000689a0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+000689b0: 6173 6520 4747 4d4c 5f4f 505f 434f 4e56  ase GGML_OP_CONV
+000689c0: 5f31 445f 5331 5f50 483a 0a20 2020 2020  _1D_S1_PH:.     
+000689d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000689e0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+000689f0: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
+00068a00: 6e76 5f31 645f 7331 5f70 6828 7061 7261  nv_1d_s1_ph(para
+00068a10: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00068a20: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+00068a30: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00068a40: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00068a50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00068a60: 4f50 5f43 4f4e 565f 3144 5f53 325f 5048  OP_CONV_1D_S2_PH
+00068a70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00068a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068a90: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00068aa0: 7761 7264 5f63 6f6e 765f 3164 5f73 325f  ward_conv_1d_s2_
+00068ab0: 7068 2870 6172 616d 732c 2074 656e 736f  ph(params, tenso
+00068ac0: 722d 3e73 7263 302c 2074 656e 736f 722d  r->src0, tensor-
+00068ad0: 3e73 7263 312c 2074 656e 736f 7229 3b0a  >src1, tensor);.
+00068ae0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00068af0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00068b00: 6520 4747 4d4c 5f4f 505f 434f 4e56 5f32  e GGML_OP_CONV_2
+00068b10: 445f 534b 5f50 303a 0a20 2020 2020 2020  D_SK_P0:.       
+00068b20: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00068b30: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00068b40: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
+00068b50: 5f32 645f 736b 5f70 3028 7061 7261 6d73  _2d_sk_p0(params
+00068b60: 2c20 7465 6e73 6f72 2d3e 7372 6330 2c20  , tensor->src0, 
+00068b70: 7465 6e73 6f72 2d3e 7372 6331 2c20 7465  tensor->src1, te
+00068b80: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+00068b90: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00068ba0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00068bb0: 5f46 4c41 5348 5f41 5454 4e3a 0a20 2020  _FLASH_ATTN:.   
+00068bc0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00068bd0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00068be0: 2069 6e74 3332 5f74 2074 203d 2067 676d   int32_t t = ggm
+00068bf0: 6c5f 6765 745f 6933 325f 3164 2874 656e  l_get_i32_1d(ten
+00068c00: 736f 722d 3e6f 7074 5b31 5d2c 2030 293b  sor->opt[1], 0);
+00068c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00068c20: 2047 474d 4c5f 4153 5345 5254 2874 203d   GGML_ASSERT(t =
+00068c30: 3d20 3020 7c7c 2074 203d 3d20 3129 3b0a  = 0 || t == 1);.
+00068c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068c50: 636f 6e73 7420 626f 6f6c 206d 6173 6b65  const bool maske
+00068c60: 6420 3d20 7420 213d 2030 3b0a 2020 2020  d = t != 0;.    
+00068c70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00068c80: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00068c90: 5f66 6c61 7368 5f61 7474 6e28 7061 7261  _flash_attn(para
+00068ca0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 6330  ms, tensor->src0
+00068cb0: 2c20 7465 6e73 6f72 2d3e 7372 6331 2c20  , tensor->src1, 
+00068cc0: 7465 6e73 6f72 2d3e 6f70 745b 305d 2c20  tensor->opt[0], 
+00068cd0: 6d61 736b 6564 2c20 7465 6e73 6f72 293b  masked, tensor);
+00068ce0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00068cf0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00068d00: 7365 2047 474d 4c5f 4f50 5f46 4c41 5348  se GGML_OP_FLASH
+00068d10: 5f46 463a 0a20 2020 2020 2020 2020 2020  _FF:.           
+00068d20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00068d30: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00068d40: 666f 7277 6172 645f 666c 6173 685f 6666  forward_flash_ff
+00068d50: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00068d60: 3e73 7263 302c 2074 656e 736f 722d 3e73  >src0, tensor->s
+00068d70: 7263 312c 2074 656e 736f 722d 3e6f 7074  rc1, tensor->opt
+00068d80: 5b30 5d2c 2074 656e 736f 722d 3e6f 7074  [0], tensor->opt
+00068d90: 5b31 5d2c 2074 656e 736f 722d 3e6f 7074  [1], tensor->opt
+00068da0: 5b32 5d2c 2074 656e 736f 7229 3b0a 2020  [2], tensor);.  
+00068db0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00068dc0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00068dd0: 4747 4d4c 5f4f 505f 5749 4e5f 5041 5254  GGML_OP_WIN_PART
+00068de0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00068df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068e00: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00068e10: 7761 7264 5f77 696e 5f70 6172 7428 7061  ward_win_part(pa
+00068e20: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00068e30: 6330 2c20 7465 6e73 6f72 2d3e 6f70 745b  c0, tensor->opt[
+00068e40: 305d 2c20 7465 6e73 6f72 293b 0a20 2020  0], tensor);.   
+00068e50: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00068e60: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00068e70: 474d 4c5f 4f50 5f57 494e 5f55 4e50 4152  GML_OP_WIN_UNPAR
+00068e80: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+00068e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00068ea0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00068eb0: 7277 6172 645f 7769 6e5f 756e 7061 7274  rward_win_unpart
+00068ec0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00068ed0: 3e73 7263 302c 2074 656e 736f 722d 3e6f  >src0, tensor->o
+00068ee0: 7074 5b30 5d2c 2074 656e 736f 7229 3b0a  pt[0], tensor);.
+00068ef0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00068f00: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00068f10: 6520 4747 4d4c 5f4f 505f 4d41 505f 554e  e GGML_OP_MAP_UN
+00068f20: 4152 593a 0a20 2020 2020 2020 2020 2020  ARY:.           
+00068f30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00068f40: 2020 2063 6f6e 7374 2067 676d 6c5f 756e     const ggml_un
+00068f50: 6172 795f 6f70 5f66 3332 5f74 2066 756e  ary_op_f32_t fun
+00068f60: 203d 202a 2828 6767 6d6c 5f75 6e61 7279   = *((ggml_unary
+00068f70: 5f6f 705f 6633 325f 7420 2a29 7465 6e73  _op_f32_t *)tens
+00068f80: 6f72 2d3e 6f70 745b 305d 2d3e 6461 7461  or->opt[0]->data
+00068f90: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00068fa0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00068fb0: 666f 7277 6172 645f 6d61 705f 756e 6172  forward_map_unar
+00068fc0: 7928 7061 7261 6d73 2c20 7465 6e73 6f72  y(params, tensor
+00068fd0: 2d3e 7372 6330 2c20 7465 6e73 6f72 2c20  ->src0, tensor, 
+00068fe0: 6675 6e29 3b0a 2020 2020 2020 2020 2020  fun);.          
+00068ff0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00069000: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00069010: 6173 6520 4747 4d4c 5f4f 505f 4d41 505f  ase GGML_OP_MAP_
+00069020: 4249 4e41 5259 3a0a 2020 2020 2020 2020  BINARY:.        
+00069030: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00069040: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
+00069050: 5f62 696e 6172 795f 6f70 5f66 3332 5f74  _binary_op_f32_t
+00069060: 2066 756e 203d 202a 2828 6767 6d6c 5f62   fun = *((ggml_b
+00069070: 696e 6172 795f 6f70 5f66 3332 5f74 202a  inary_op_f32_t *
+00069080: 2974 656e 736f 722d 3e6f 7074 5b30 5d2d  )tensor->opt[0]-
+00069090: 3e64 6174 6129 3b0a 2020 2020 2020 2020  >data);.        
+000690a0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+000690b0: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
+000690c0: 5f62 696e 6172 7928 7061 7261 6d73 2c20  _binary(params, 
+000690d0: 7465 6e73 6f72 2d3e 7372 6330 2c20 7465  tensor->src0, te
+000690e0: 6e73 6f72 2d3e 7372 6331 2c20 7465 6e73  nsor->src1, tens
+000690f0: 6f72 2c20 6675 6e29 3b0a 2020 2020 2020  or, fun);.      
+00069100: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00069110: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
+00069120: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00069130: 4e4f 4e45 3a0a 2020 2020 2020 2020 2020  NONE:.          
+00069140: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00069150: 2020 2020 2f2f 206e 6f70 0a20 2020 2020      // nop.     
+00069160: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00069170: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00069180: 4c5f 4f50 5f43 4f55 4e54 3a0a 2020 2020  L_OP_COUNT:.    
+00069190: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000691a0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+000691b0: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+000691c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000691d0: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2f2f  k;.    }.}..////
 000691e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 000691f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00069200: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00069210: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00069220: 2f2f 2f2f 2f2f 2f0a 0a73 7461 7469 6320  ///////..static 
-00069230: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-00069240: 655f 6261 636b 7761 7264 2873 7472 7563  e_backward(struc
-00069250: 7420 6767 6d6c 5f63 6f6e 7465 7874 202a  t ggml_context *
-00069260: 2063 7478 2c20 7374 7275 6374 2067 676d   ctx, struct ggm
-00069270: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
-00069280: 722c 2062 6f6f 6c20 696e 706c 6163 6529  r, bool inplace)
-00069290: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
-000692a0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-000692b0: 203d 2074 656e 736f 722d 3e73 7263 303b   = tensor->src0;
-000692c0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-000692d0: 5f74 656e 736f 7220 2a20 7372 6331 203d  _tensor * src1 =
-000692e0: 2074 656e 736f 722d 3e73 7263 313b 0a0a   tensor->src1;..
-000692f0: 2020 2020 7377 6974 6368 2028 7465 6e73      switch (tens
-00069300: 6f72 2d3e 6f70 2920 7b0a 2020 2020 2020  or->op) {.      
-00069310: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-00069320: 5550 3a0a 2020 2020 2020 2020 2020 2020  UP:.            
-00069330: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00069340: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00069350: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00069360: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00069370: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
-00069380: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
-00069390: 6164 2c20 7465 6e73 6f72 2d3e 6772 6164  ad, tensor->grad
-000693a0: 2c20 696e 706c 6163 6529 3b0a 2020 2020  , inplace);.    
-000693b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000693c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000693d0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000693e0: 4747 4d4c 5f4f 505f 4144 443a 0a20 2020  GGML_OP_ADD:.   
-000693f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00069400: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-00069410: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-00069420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069430: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
-00069440: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-00069450: 2073 7263 302d 3e67 7261 642c 2074 656e   src0->grad, ten
-00069460: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
-00069470: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00069480: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00069490: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-000694a0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-000694b0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-000694c0: 312d 3e67 7261 6420 3d20 6767 6d6c 5f61  1->grad = ggml_a
-000694d0: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
-000694e0: 312d 3e67 7261 642c 2074 656e 736f 722d  1->grad, tensor-
-000694f0: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
-00069500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00069510: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-00069520: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00069530: 6361 7365 2047 474d 4c5f 4f50 5f41 4444  case GGML_OP_ADD
-00069540: 313a 0a20 2020 2020 2020 2020 2020 207b  1:.            {
-00069550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00069560: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-00069570: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00069580: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-00069590: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
-000695a0: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
-000695b0: 642c 2074 656e 736f 722d 3e67 7261 642c  d, tensor->grad,
-000695c0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-000695d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000695e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000695f0: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
-00069600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069610: 2020 2073 7263 312d 3e67 7261 6420 3d20     src1->grad = 
-00069620: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-00069630: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00069640: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-00069650: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-00069660: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00069670: 676d 6c5f 6d65 616e 2863 7478 2c20 7465  gml_mean(ctx, te
-00069680: 6e73 6f72 2d3e 6772 6164 292c 202f 2f20  nsor->grad), // 
-00069690: 544f 444f 3a20 7368 6f75 6c64 2070 726f  TODO: should pro
-000696a0: 6261 626c 7920 6265 2073 756d 2069 6e73  bably be sum ins
-000696b0: 7465 6164 206f 6620 6d65 616e 0a20 2020  tead of mean.   
-000696c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000696d0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-000696e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000696f0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00069700: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00069710: 7365 2047 474d 4c5f 4f50 5f41 4343 3a0a  se GGML_OP_ACC:.
-00069720: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00069730: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00069740: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-00069750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069760: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-00069770: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-00069780: 7478 2c20 7372 6330 2d3e 6772 6164 2c20  tx, src0->grad, 
-00069790: 7465 6e73 6f72 2d3e 6772 6164 2c20 696e  tensor->grad, in
-000697a0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-000697b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000697c0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000697d0: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-000697e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000697f0: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-00069800: 5f6e 656c 656d 656e 7473 2874 656e 736f  _nelements(tenso
-00069810: 722d 3e6f 7074 5b30 5d29 203d 3d20 3529  r->opt[0]) == 5)
-00069820: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00069830: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00069840: 5428 7465 6e73 6f72 2d3e 6f70 745b 305d  T(tensor->opt[0]
-00069850: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00069860: 5950 455f 4933 3229 3b0a 2020 2020 2020  YPE_I32);.      
-00069870: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00069880: 6e73 7420 7369 7a65 5f74 206e 6231 2020  nst size_t nb1  
-00069890: 2020 203d 2028 2820 696e 7433 325f 7420     = (( int32_t 
-000698a0: 2a20 2920 7465 6e73 6f72 2d3e 6f70 745b  * ) tensor->opt[
-000698b0: 305d 2d3e 6461 7461 295b 305d 3b0a 2020  0]->data)[0];.  
-000698c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000698d0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
-000698e0: 6232 2020 2020 203d 2028 2820 696e 7433  b2     = (( int3
-000698f0: 325f 7420 2a20 2920 7465 6e73 6f72 2d3e  2_t * ) tensor->
-00069900: 6f70 745b 305d 2d3e 6461 7461 295b 315d  opt[0]->data)[1]
-00069910: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00069920: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-00069930: 5f74 206e 6233 2020 2020 203d 2028 2820  _t nb3     = (( 
-00069940: 696e 7433 325f 7420 2a20 2920 7465 6e73  int32_t * ) tens
-00069950: 6f72 2d3e 6f70 745b 305d 2d3e 6461 7461  or->opt[0]->data
-00069960: 295b 325d 3b0a 2020 2020 2020 2020 2020  )[2];.          
-00069970: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00069980: 7369 7a65 5f74 206f 6666 7365 7420 203d  size_t offset  =
-00069990: 2028 2820 696e 7433 325f 7420 2a20 2920   (( int32_t * ) 
-000699a0: 7465 6e73 6f72 2d3e 6f70 745b 305d 2d3e  tensor->opt[0]->
-000699b0: 6461 7461 295b 335d 3b0a 0a20 2020 2020  data)[3];..     
-000699c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000699d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000699e0: 7220 2a20 7465 6e73 6f72 5f67 7261 645f  r * tensor_grad_
-000699f0: 7669 6577 203d 2067 676d 6c5f 7669 6577  view = ggml_view
-00069a00: 5f34 6428 6374 782c 0a20 2020 2020 2020  _4d(ctx,.       
+00069220: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a 7374  ////////////..st
+00069230: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00069240: 6f6d 7075 7465 5f62 6163 6b77 6172 6428  ompute_backward(
+00069250: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
+00069260: 6578 7420 2a20 6374 782c 2073 7472 7563  ext * ctx, struc
+00069270: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00069280: 7465 6e73 6f72 2c20 626f 6f6c 2069 6e70  tensor, bool inp
+00069290: 6c61 6365 2920 7b0a 2020 2020 7374 7275  lace) {.    stru
+000692a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000692b0: 2073 7263 3020 3d20 7465 6e73 6f72 2d3e   src0 = tensor->
+000692c0: 7372 6330 3b0a 2020 2020 7374 7275 6374  src0;.    struct
+000692d0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+000692e0: 7263 3120 3d20 7465 6e73 6f72 2d3e 7372  rc1 = tensor->sr
+000692f0: 6331 3b0a 0a20 2020 2073 7769 7463 6820  c1;..    switch 
+00069300: 2874 656e 736f 722d 3e6f 7029 207b 0a20  (tensor->op) {. 
+00069310: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00069320: 5f4f 505f 4455 503a 0a20 2020 2020 2020  _OP_DUP:.       
+00069330: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00069340: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+00069350: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+00069360: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00069370: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
+00069380: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
+00069390: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
+000693a0: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
+000693b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000693c0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+000693d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000693e0: 6361 7365 2047 474d 4c5f 4f50 5f41 4444  case GGML_OP_ADD
+000693f0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00069400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069410: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+00069420: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00069430: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+00069440: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
+00069450: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
+00069460: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
+00069470: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+00069480: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00069490: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000694a0: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
+000694b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000694c0: 2020 7372 6331 2d3e 6772 6164 203d 2067    src1->grad = g
+000694d0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+000694e0: 2c20 7372 6331 2d3e 6772 6164 2c20 7465  , src1->grad, te
+000694f0: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
+00069500: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00069510: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00069520: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00069530: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00069540: 505f 4144 4431 3a0a 2020 2020 2020 2020  P_ADD1:.        
+00069550: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00069560: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00069570: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00069580: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00069590: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
+000695a0: 645f 696d 706c 2863 7478 2c20 7372 6330  d_impl(ctx, src0
+000695b0: 2d3e 6772 6164 2c20 7465 6e73 6f72 2d3e  ->grad, tensor->
+000695c0: 6772 6164 2c20 696e 706c 6163 6529 3b0a  grad, inplace);.
+000695d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000695e0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+000695f0: 2020 6966 2028 7372 6331 2d3e 6772 6164    if (src1->grad
+00069600: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00069610: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+00069620: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+00069630: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+00069640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069650: 7372 6331 2d3e 6772 6164 2c0a 2020 2020  src1->grad,.    
+00069660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069670: 2020 2020 6767 6d6c 5f6d 6561 6e28 6374      ggml_mean(ct
+00069680: 782c 2074 656e 736f 722d 3e67 7261 6429  x, tensor->grad)
+00069690: 2c20 2f2f 2054 4f44 4f3a 2073 686f 756c  , // TODO: shoul
+000696a0: 6420 7072 6f62 6162 6c79 2062 6520 7375  d probably be su
+000696b0: 6d20 696e 7374 6561 6420 6f66 206d 6561  m instead of mea
+000696c0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+000696d0: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
+000696e0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000696f0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00069700: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00069710: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00069720: 4143 433a 0a20 2020 2020 2020 2020 2020  ACC:.           
+00069730: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00069740: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+00069750: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00069760: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+00069770: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+00069780: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
+00069790: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+000697a0: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+000697b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000697c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000697d0: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
+000697e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000697f0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00069800: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
+00069810: 7465 6e73 6f72 2d3e 6f70 745b 305d 2920  tensor->opt[0]) 
+00069820: 3d3d 2035 293b 0a20 2020 2020 2020 2020  == 5);.         
+00069830: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00069840: 4153 5345 5254 2874 656e 736f 722d 3e6f  ASSERT(tensor->o
+00069850: 7074 5b30 5d2d 3e74 7970 6520 3d3d 2047  pt[0]->type == G
+00069860: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
+00069870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069880: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+00069890: 6e62 3120 2020 2020 3d20 2828 2069 6e74  nb1     = (( int
+000698a0: 3332 5f74 202a 2029 2074 656e 736f 722d  32_t * ) tensor-
+000698b0: 3e6f 7074 5b30 5d2d 3e64 6174 6129 5b30  >opt[0]->data)[0
+000698c0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+000698d0: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
+000698e0: 655f 7420 6e62 3220 2020 2020 3d20 2828  e_t nb2     = ((
+000698f0: 2069 6e74 3332 5f74 202a 2029 2074 656e   int32_t * ) ten
+00069900: 736f 722d 3e6f 7074 5b30 5d2d 3e64 6174  sor->opt[0]->dat
+00069910: 6129 5b31 5d3b 0a20 2020 2020 2020 2020  a)[1];.         
+00069920: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00069930: 2073 697a 655f 7420 6e62 3320 2020 2020   size_t nb3     
+00069940: 3d20 2828 2069 6e74 3332 5f74 202a 2029  = (( int32_t * )
+00069950: 2074 656e 736f 722d 3e6f 7074 5b30 5d2d   tensor->opt[0]-
+00069960: 3e64 6174 6129 5b32 5d3b 0a20 2020 2020  >data)[2];.     
+00069970: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00069980: 6f6e 7374 2073 697a 655f 7420 6f66 6673  onst size_t offs
+00069990: 6574 2020 3d20 2828 2069 6e74 3332 5f74  et  = (( int32_t
+000699a0: 202a 2029 2074 656e 736f 722d 3e6f 7074   * ) tensor->opt
+000699b0: 5b30 5d2d 3e64 6174 6129 5b33 5d3b 0a0a  [0]->data)[3];..
+000699c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000699d0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000699e0: 7465 6e73 6f72 202a 2074 656e 736f 725f  tensor * tensor_
+000699f0: 6772 6164 5f76 6965 7720 3d20 6767 6d6c  grad_view = ggml
+00069a00: 5f76 6965 775f 3464 2863 7478 2c0a 2020  _view_4d(ctx,.  
 00069a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069a20: 2074 656e 736f 722d 3e67 7261 642c 0a20   tensor->grad,. 
-00069a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069a40: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
-00069a50: 642d 3e6e 655b 305d 2c0a 2020 2020 2020  d->ne[0],.      
+00069a20: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
+00069a30: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00069a40: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00069a50: 2d3e 6772 6164 2d3e 6e65 5b30 5d2c 0a20  ->grad->ne[0],. 
 00069a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069a70: 2020 7372 6331 2d3e 6772 6164 2d3e 6e65    src1->grad->ne
-00069a80: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-00069a90: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00069aa0: 312d 3e67 7261 642d 3e6e 655b 325d 2c0a  1->grad->ne[2],.
-00069ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069ac0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-00069ad0: 6164 2d3e 6e65 5b33 5d2c 0a20 2020 2020  ad->ne[3],.     
+00069a70: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+00069a80: 642d 3e6e 655b 315d 2c0a 2020 2020 2020  d->ne[1],.      
+00069a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069aa0: 2020 7372 6331 2d3e 6772 6164 2d3e 6e65    src1->grad->ne
+00069ab0: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+00069ac0: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00069ad0: 312d 3e67 7261 642d 3e6e 655b 335d 2c0a  1->grad->ne[3],.
 00069ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069af0: 2020 206e 6231 2c20 6e62 322c 206e 6233     nb1, nb2, nb3
-00069b00: 2c20 6f66 6673 6574 293b 0a0a 2020 2020  , offset);..    
-00069b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069b20: 7372 6331 2d3e 6772 6164 203d 0a20 2020  src1->grad =.   
-00069b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069b40: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
-00069b50: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+00069af0: 2020 2020 2020 2020 6e62 312c 206e 6232          nb1, nb2
+00069b00: 2c20 6e62 332c 206f 6666 7365 7429 3b0a  , nb3, offset);.
+00069b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00069b20: 2020 2020 2073 7263 312d 3e67 7261 6420       src1->grad 
+00069b30: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
+00069b40: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
+00069b50: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
 00069b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069b70: 2020 2020 7372 6331 2d3e 6772 6164 2c0a      src1->grad,.
-00069b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069b90: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00069ba0: 5f72 6573 6861 7065 2863 7478 2c0a 2020  _reshape(ctx,.  
-00069bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069bc0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00069bd0: 6d6c 5f63 6f6e 7428 6374 782c 2074 656e  ml_cont(ctx, ten
-00069be0: 736f 725f 6772 6164 5f76 6965 7729 2c0a  sor_grad_view),.
-00069bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069b70: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
+00069b80: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+00069b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069ba0: 2067 676d 6c5f 7265 7368 6170 6528 6374   ggml_reshape(ct
+00069bb0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00069bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069bd0: 2020 2067 676d 6c5f 636f 6e74 2863 7478     ggml_cont(ctx
+00069be0: 2c20 7465 6e73 6f72 5f67 7261 645f 7669  , tensor_grad_vi
+00069bf0: 6577 292c 0a20 2020 2020 2020 2020 2020  ew),.           
 00069c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069c10: 7372 6331 2d3e 6772 6164 292c 0a20 2020  src1->grad),.   
-00069c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069c30: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-00069c40: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00069c50: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00069c60: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00069c70: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-00069c80: 5542 3a0a 2020 2020 2020 2020 2020 2020  UB:.            
-00069c90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00069ca0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00069cb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00069cc0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00069cd0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
-00069ce0: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
-00069cf0: 6164 2c20 7465 6e73 6f72 2d3e 6772 6164  ad, tensor->grad
-00069d00: 2c20 696e 706c 6163 6529 3b0a 2020 2020  , inplace);.    
-00069d10: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00069d20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00069d30: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
-00069d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069d50: 2020 2020 7372 6331 2d3e 6772 6164 203d      src1->grad =
-00069d60: 2067 676d 6c5f 7375 625f 696d 706c 2863   ggml_sub_impl(c
-00069d70: 7478 2c20 7372 6331 2d3e 6772 6164 2c20  tx, src1->grad, 
-00069d80: 7465 6e73 6f72 2d3e 6772 6164 2c20 696e  tensor->grad, in
-00069d90: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-00069da0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00069db0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00069dc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00069dd0: 5f4f 505f 4d55 4c3a 0a20 2020 2020 2020  _OP_MUL:.       
-00069de0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00069df0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-00069e00: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00069e10: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00069e20: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
+00069c10: 2020 2020 2073 7263 312d 3e67 7261 6429       src1->grad)
+00069c20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00069c30: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00069c40: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+00069c50: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00069c60: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00069c70: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00069c80: 5f4f 505f 5355 423a 0a20 2020 2020 2020  _OP_SUB:.       
+00069c90: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00069ca0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+00069cb0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+00069cc0: 2020 2020 2020 2020 2020 2020 2073 7263               src
+00069cd0: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
+00069ce0: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
+00069cf0: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
+00069d00: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
+00069d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00069d20: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00069d30: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
+00069d40: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00069d50: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
+00069d60: 7261 6420 3d20 6767 6d6c 5f73 7562 5f69  rad = ggml_sub_i
+00069d70: 6d70 6c28 6374 782c 2073 7263 312d 3e67  mpl(ctx, src1->g
+00069d80: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
+00069d90: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
+00069da0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00069db0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00069dc0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00069dd0: 2047 474d 4c5f 4f50 5f4d 554c 3a0a 2020   GGML_OP_MUL:.  
+00069de0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00069df0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00069e00: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+00069e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069e20: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
 00069e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069e40: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-00069e50: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+00069e40: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
+00069e50: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
 00069e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069e70: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
-00069e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00069e70: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00069e80: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
 00069e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069ea0: 2067 676d 6c5f 6d75 6c28 6374 782c 2073   ggml_mul(ctx, s
-00069eb0: 7263 312c 2074 656e 736f 722d 3e67 7261  rc1, tensor->gra
-00069ec0: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+00069ea0: 2020 2020 2020 6767 6d6c 5f6d 756c 2863        ggml_mul(c
+00069eb0: 7478 2c20 7372 6331 2c20 7465 6e73 6f72  tx, src1, tensor
+00069ec0: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
 00069ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069ee0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-00069ef0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00069f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069f10: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
-00069f20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00069f30: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-00069f40: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-00069f50: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00069f60: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-00069f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069f80: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00069f90: 6331 2d3e 6772 6164 2c0a 2020 2020 2020  c1->grad,.      
+00069ee0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+00069ef0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00069f00: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00069f10: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
+00069f20: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+00069f30: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+00069f40: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+00069f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069f60: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+00069f70: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00069f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069f90: 2020 2073 7263 312d 3e67 7261 642c 0a20     src1->grad,. 
 00069fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069fb0: 2020 2020 2020 2020 2020 6767 6d6c 5f6d            ggml_m
-00069fc0: 756c 2863 7478 2c20 7372 6330 2c20 7465  ul(ctx, src0, te
-00069fd0: 6e73 6f72 2d3e 6772 6164 292c 0a20 2020  nsor->grad),.   
-00069fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069ff0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-0006a000: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-0006a010: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0006a020: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0006a030: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0006a040: 4f50 5f44 4956 3a0a 2020 2020 2020 2020  OP_DIV:.        
-0006a050: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0006a060: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0006a070: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0006a080: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0006a090: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+00069fb0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00069fc0: 676d 6c5f 6d75 6c28 6374 782c 2073 7263  gml_mul(ctx, src
+00069fd0: 302c 2074 656e 736f 722d 3e67 7261 6429  0, tensor->grad)
+00069fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00069ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a000: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
+0006a010: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0006a020: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0006a030: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0006a040: 4747 4d4c 5f4f 505f 4449 563a 0a20 2020  GGML_OP_DIV:.   
+0006a050: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0006a060: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0006a070: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+0006a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a090: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
 0006a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a0b0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0006a0c0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0006a0b0: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
+0006a0c0: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
 0006a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a0e0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-0006a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a0e0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0006a0f0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
 0006a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a110: 6767 6d6c 5f64 6976 2863 7478 2c20 7465  ggml_div(ctx, te
-0006a120: 6e73 6f72 2d3e 6772 6164 2c20 7372 6331  nsor->grad, src1
-0006a130: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0006a110: 2020 2020 2067 676d 6c5f 6469 7628 6374       ggml_div(ct
+0006a120: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
+0006a130: 2073 7263 3129 2c0a 2020 2020 2020 2020   src1),.        
 0006a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a150: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-0006a160: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0006a170: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006a180: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
-0006a190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a1a0: 2020 2020 2073 7263 312d 3e67 7261 6420       src1->grad 
-0006a1b0: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-0006a1c0: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
-0006a1d0: 7562 5f69 6d70 6c28 6374 782c 0a20 2020  ub_impl(ctx,.   
-0006a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a1f0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0006a200: 312d 3e67 7261 642c 0a20 2020 2020 2020  1->grad,.       
+0006a150: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0006a160: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006a170: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006a180: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
+0006a190: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+0006a1a0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+0006a1b0: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
+0006a1c0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006a1d0: 676d 6c5f 7375 625f 696d 706c 2863 7478  gml_sub_impl(ctx
+0006a1e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a200: 2020 7372 6331 2d3e 6772 6164 2c0a 2020    src1->grad,.  
 0006a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a220: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
-0006a230: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0006a220: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006a230: 6d6c 5f6d 756c 2863 7478 2c0a 2020 2020  ml_mul(ctx,.    
 0006a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a250: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0006a260: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
+0006a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a260: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
 0006a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a280: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006a290: 6c5f 6469 7628 6374 782c 2074 656e 736f  l_div(ctx, tenso
-0006a2a0: 722c 2073 7263 3129 292c 0a20 2020 2020  r, src1)),.     
+0006a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a290: 2020 6767 6d6c 5f64 6976 2863 7478 2c20    ggml_div(ctx, 
+0006a2a0: 7465 6e73 6f72 2c20 7372 6331 2929 2c0a  tensor, src1)),.
 0006a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a2c0: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0006a2d0: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0006a2e0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006a2f0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0006a300: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0006a310: 5f53 5152 3a0a 2020 2020 2020 2020 2020  _SQR:.          
-0006a320: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006a330: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0006a340: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0006a350: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0006a360: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-0006a370: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0006a380: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-0006a390: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a2d0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+0006a2e0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0006a2f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0006a300: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0006a310: 4d4c 5f4f 505f 5351 523a 0a20 2020 2020  ML_OP_SQR:.     
+0006a320: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006a330: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0006a340: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0006a350: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006a360: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0006a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a380: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0006a390: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
 0006a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a3b0: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
-0006a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a3d0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006a3e0: 6d6c 5f73 6361 6c65 2863 7478 2c0a 2020  ml_scale(ctx,.  
-0006a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a3b0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0006a3c0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0006a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a3e0: 2020 2067 676d 6c5f 7363 616c 6528 6374     ggml_scale(ct
+0006a3f0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
 0006a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a410: 2020 6767 6d6c 5f6d 756c 2863 7478 2c20    ggml_mul(ctx, 
-0006a420: 7372 6330 2c20 7465 6e73 6f72 2d3e 6772  src0, tensor->gr
-0006a430: 6164 292c 0a20 2020 2020 2020 2020 2020  ad),.           
+0006a410: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
+0006a420: 6374 782c 2073 7263 302c 2074 656e 736f  ctx, src0, tenso
+0006a430: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
 0006a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a450: 2020 2020 2020 2020 2067 676d 6c5f 6e65           ggml_ne
-0006a460: 775f 6633 3228 6374 782c 2032 2e30 6629  w_f32(ctx, 2.0f)
-0006a470: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0006a450: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006a460: 6d6c 5f6e 6577 5f66 3332 2863 7478 2c20  ml_new_f32(ctx, 
+0006a470: 322e 3066 2929 2c0a 2020 2020 2020 2020  2.0f)),.        
 0006a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a490: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-0006a4a0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0006a4b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0006a4c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0006a4d0: 2047 474d 4c5f 4f50 5f53 5152 543a 0a20   GGML_OP_SQRT:. 
-0006a4e0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0006a4f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0006a500: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-0006a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a520: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
-0006a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a540: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-0006a550: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+0006a490: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0006a4a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006a4b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006a4c0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0006a4d0: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
+0006a4e0: 5254 3a0a 2020 2020 2020 2020 2020 2020  RT:.            
+0006a4f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006a500: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0006a510: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0006a520: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0006a530: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+0006a540: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006a550: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
 0006a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a570: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-0006a580: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0006a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a580: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
 0006a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a5a0: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
-0006a5b0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006a5a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006a5b0: 5f6d 756c 2863 7478 2c0a 2020 2020 2020  _mul(ctx,.      
 0006a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a5d0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-0006a5e0: 3e67 7261 642c 202f 2f20 7468 6973 2077  >grad, // this w
-0006a5f0: 6173 206e 6f74 2063 6174 6368 6564 2062  as not catched b
-0006a600: 7920 7465 7374 5f67 7261 6420 6265 6361  y test_grad beca
-0006a610: 7573 6520 696e 2074 6573 745f 6772 6164  use in test_grad
-0006a620: 2074 656e 736f 722d 3e67 7261 6420 6973   tensor->grad is
-0006a630: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+0006a5d0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0006a5e0: 6e73 6f72 2d3e 6772 6164 2c20 2f2f 2074  nsor->grad, // t
+0006a5f0: 6869 7320 7761 7320 6e6f 7420 6361 7463  his was not catc
+0006a600: 6865 6420 6279 2074 6573 745f 6772 6164  hed by test_grad
+0006a610: 2062 6563 6175 7365 2069 6e20 7465 7374   because in test
+0006a620: 5f67 7261 6420 7465 6e73 6f72 2d3e 6772  _grad tensor->gr
+0006a630: 6164 2069 7320 310a 2020 2020 2020 2020  ad is 1.        
 0006a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a650: 2020 2020 2020 2067 676d 6c5f 6469 7628         ggml_div(
-0006a660: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006a650: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006a660: 5f64 6976 2863 7478 2c0a 2020 2020 2020  _div(ctx,.      
 0006a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a680: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006a690: 6c5f 7265 7065 6174 2863 7478 2c20 6767  l_repeat(ctx, gg
-0006a6a0: 6d6c 5f6e 6577 5f66 3332 2863 7478 2c20  ml_new_f32(ctx, 
-0006a6b0: 302e 3566 292c 2074 656e 736f 7229 2c0a  0.5f), tensor),.
-0006a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a690: 2020 6767 6d6c 5f72 6570 6561 7428 6374    ggml_repeat(ct
+0006a6a0: 782c 2067 676d 6c5f 6e65 775f 6633 3228  x, ggml_new_f32(
+0006a6b0: 6374 782c 2030 2e35 6629 2c20 7465 6e73  ctx, 0.5f), tens
+0006a6c0: 6f72 292c 0a20 2020 2020 2020 2020 2020  or),.           
 0006a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a6e0: 2020 2020 2020 2020 7465 6e73 6f72 2929          tensor))
-0006a6f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006a6e0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0006a6f0: 736f 7229 292c 0a20 2020 2020 2020 2020  sor)),.         
 0006a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a710: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0006a720: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0006a730: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0006a740: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0006a750: 4747 4d4c 5f4f 505f 4c4f 473a 0a20 2020  GGML_OP_LOG:.   
-0006a760: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0006a770: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0006a780: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0006a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a7a0: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
-0006a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a7c0: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
-0006a7d0: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
+0006a710: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0006a720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006a730: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0006a740: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0006a750: 6361 7365 2047 474d 4c5f 4f50 5f4c 4f47  case GGML_OP_LOG
+0006a760: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0006a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a780: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0006a790: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006a7a0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0006a7b0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
+0006a7c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006a7d0: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
 0006a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a7f0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0006a800: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0006a7f0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0006a800: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
 0006a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a820: 2020 2020 2067 676d 6c5f 6469 7628 6374       ggml_div(ct
-0006a830: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0006a820: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
+0006a830: 6976 2863 7478 2c0a 2020 2020 2020 2020  iv(ctx,.        
 0006a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a850: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-0006a860: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0006a850: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0006a860: 6f72 2d3e 6772 6164 2c0a 2020 2020 2020  or->grad,.      
 0006a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a880: 2020 2020 2020 2020 2073 7263 3029 2c0a           src0),.
-0006a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a880: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0006a890: 6330 292c 0a20 2020 2020 2020 2020 2020  c0),.           
 0006a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a8b0: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0006a8c0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0006a8d0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0006a8e0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006a8f0: 4d4c 5f4f 505f 5355 4d3a 0a20 2020 2020  ML_OP_SUM:.     
-0006a900: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0006a910: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0006a920: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0006a930: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006a940: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
-0006a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a960: 2020 2020 6767 6d6c 5f61 6464 315f 696d      ggml_add1_im
-0006a970: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0006a8b0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+0006a8c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0006a8d0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006a8e0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0006a8f0: 7365 2047 474d 4c5f 4f50 5f53 554d 3a0a  se GGML_OP_SUM:.
+0006a900: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0006a910: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006a920: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
+0006a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a940: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+0006a950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006a960: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+0006a970: 6431 5f69 6d70 6c28 6374 782c 0a20 2020  d1_impl(ctx,.   
 0006a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a990: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-0006a9a0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0006a990: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0006a9a0: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
 0006a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a9c0: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
-0006a9d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006a9c0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+0006a9d0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
 0006a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a9f0: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0006aa00: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0006aa10: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0006aa20: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0006aa30: 4747 4d4c 5f4f 505f 5355 4d5f 524f 5753  GGML_OP_SUM_ROWS
-0006aa40: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0006aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006aa60: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-0006aa70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0006aa80: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0006aa90: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-0006aaa0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006aab0: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-0006aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006aad0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0006aae0: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+0006a9f0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0006aa00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006aa10: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0006aa20: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0006aa30: 6361 7365 2047 474d 4c5f 4f50 5f53 554d  case GGML_OP_SUM
+0006aa40: 5f52 4f57 533a 0a20 2020 2020 2020 2020  _ROWS:.         
+0006aa50: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0006aa60: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+0006aa70: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0006aa80: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0006aa90: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+0006aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aab0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+0006aac0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0006aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aae0: 2020 2073 7263 302d 3e67 7261 642c 0a20     src0->grad,. 
 0006aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab00: 2020 2020 2020 2020 2020 6767 6d6c 5f72            ggml_r
-0006ab10: 6570 6561 7428 6374 782c 0a20 2020 2020  epeat(ctx,.     
+0006ab00: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006ab10: 676d 6c5f 7265 7065 6174 2863 7478 2c0a  gml_repeat(ctx,.
 0006ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0006ab40: 656e 736f 722d 3e67 7261 642c 0a20 2020  ensor->grad,.   
-0006ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ab40: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
+0006ab50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0006ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab70: 2073 7263 302d 3e67 7261 6429 2c0a 2020   src0->grad),.  
-0006ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ab90: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0006aba0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-0006abb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0006abc0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0006abd0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0006abe0: 5f4f 505f 4d45 414e 3a0a 2020 2020 2020  _OP_MEAN:.      
-0006abf0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0006ac00: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0006ac10: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-0006ac20: 4f44 4f3a 2069 6d70 6c65 6d65 6e74 0a20  ODO: implement. 
-0006ac30: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0006ac40: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0006ac50: 2047 474d 4c5f 4f50 5f52 4550 4541 543a   GGML_OP_REPEAT:
-0006ac60: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0006ac70: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006ac80: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
-0006ac90: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
-0006aca0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0006acb0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0006acc0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0006acd0: 5f41 5353 4552 5428 7372 6330 2d3e 6e5f  _ASSERT(src0->n_
-0006ace0: 6469 6d73 203d 3d20 3120 7c7c 2073 7263  dims == 1 || src
-0006acf0: 302d 3e6e 5f64 696d 7320 3d3d 2032 293b  0->n_dims == 2);
-0006ad00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ad10: 2020 2020 2063 6f6e 7374 2069 6e74 206e       const int n
-0006ad20: 6320 203d 2074 656e 736f 722d 3e6e 655b  c  = tensor->ne[
-0006ad30: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-0006ad40: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0006ad50: 7420 6e72 2020 3d20 7465 6e73 6f72 2d3e  t nr  = tensor->
-0006ad60: 6e65 5b31 5d3b 0a20 2020 2020 2020 2020  ne[1];.         
-0006ad70: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006ad80: 2069 6e74 206e 6330 203d 2073 7263 302d   int nc0 = src0-
-0006ad90: 3e6e 655b 305d 3b0a 2020 2020 2020 2020  >ne[0];.        
-0006ada0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006adb0: 7420 696e 7420 6e72 3020 3d20 7372 6330  t int nr0 = src0
-0006adc0: 2d3e 6e65 5b31 5d3b 0a20 2020 2020 2020  ->ne[1];.       
-0006add0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0006ade0: 7374 2069 6e74 206e 6372 203d 206e 632f  st int ncr = nc/
-0006adf0: 6e63 303b 202f 2f20 6775 6172 616e 7465  nc0; // guarante
-0006ae00: 6564 2074 6f20 6265 2061 6e20 696e 7465  ed to be an inte
-0006ae10: 6765 7220 6475 6520 746f 2074 6865 2063  ger due to the c
-0006ae20: 6865 636b 2069 6e20 6767 6d6c 5f63 616e  heck in ggml_can
-0006ae30: 5f72 6570 6561 740a 2020 2020 2020 2020  _repeat.        
-0006ae40: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006ae50: 7420 696e 7420 6e72 7220 3d20 6e72 2f6e  t int nrr = nr/n
-0006ae60: 7230 3b20 2f2f 2067 7561 7261 6e74 6565  r0; // guarantee
-0006ae70: 6420 746f 2062 6520 616e 2069 6e74 6567  d to be an integ
-0006ae80: 6572 2064 7565 2074 6f20 7468 6520 6368  er due to the ch
-0006ae90: 6563 6b20 696e 2067 676d 6c5f 6361 6e5f  eck in ggml_can_
-0006aea0: 7265 7065 6174 0a20 2020 2020 2020 2020  repeat.         
-0006aeb0: 2020 2020 2020 2020 2020 202f 2f20 7465             // te
-0006aec0: 6e73 6f72 2d3e 6772 6164 205b 6e63 2c6e  nsor->grad [nc,n
-0006aed0: 722c 312c 315d 0a20 2020 2020 2020 2020  r,1,1].         
-0006aee0: 2020 2020 2020 2020 2020 202f 2f20 7265             // re
-0006aef0: 7368 6170 6520 2020 2020 205b 6e63 302c  shape      [nc0,
-0006af00: 6e63 2f6e 6330 2c6e 7230 2c6e 722f 6e72  nc/nc0,nr0,nr/nr
-0006af10: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-0006af20: 2020 2020 2020 202f 2f20 7065 726d 7574         // permut
-0006af30: 6520 2020 2020 205b 6e63 302c 6e72 302c  e      [nc0,nr0,
-0006af40: 6e63 2f6e 6330 2c6e 722f 6e72 305d 0a20  nc/nc0,nr/nr0]. 
-0006af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006af60: 2020 202f 2f20 7375 6273 7469 7475 7465     // substitute
-0006af70: 2020 205b 6e63 302c 6e72 302c 6e63 722c     [nc0,nr0,ncr,
-0006af80: 6e72 725d 0a20 2020 2020 2020 2020 2020  nrr].           
-0006af90: 2020 2020 2020 2020 202f 2f20 7265 7368           // resh
-0006afa0: 6170 6520 2020 2020 205b 6e63 302a 6e72  ape      [nc0*nr
-0006afb0: 302c 6e63 722a 6e72 722c 312c 315d 0a20  0,ncr*nrr,1,1]. 
-0006afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006afd0: 2020 202f 2f20 7472 616e 7370 6f73 6520     // transpose 
-0006afe0: 2020 205b 6e63 722a 6e72 722c 6e63 302a     [ncr*nrr,nc0*
-0006aff0: 6e72 302c 312c 315d 0a20 2020 2020 2020  nr0,1,1].       
-0006b000: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006b010: 7375 6d20 726f 7773 2020 2020 205b 312c  sum rows     [1,
-0006b020: 6e63 302a 6e72 302c 312c 315d 0a20 2020  nc0*nr0,1,1].   
-0006b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b040: 202f 2f20 7472 616e 7370 6f73 6520 2020   // transpose   
-0006b050: 205b 6e63 302a 6e72 302c 312c 315d 0a20   [nc0*nr0,1,1]. 
-0006b060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b070: 2020 202f 2f20 7265 7368 6170 6520 2020     // reshape   
-0006b080: 2020 205b 6e63 302c 6e72 302c 312c 315d     [nc0,nr0,1,1]
-0006b090: 2072 6573 6861 7065 5f31 6420 6f72 2072   reshape_1d or r
-0006b0a0: 6573 6861 7065 5f32 640a 2020 2020 2020  eshape_2d.      
-0006b0b0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006b0c0: 2061 6464 2074 6f20 7372 6330 2d3e 6772   add to src0->gr
-0006b0d0: 6164 0a0a 2020 2020 2020 2020 2020 2020  ad..            
-0006b0e0: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
-0006b0f0: 6e65 5b34 5d20 203d 207b 6e63 302c 6e63  ne[4]  = {nc0,nc
-0006b100: 722c 6e72 302c 6e72 727d 3b0a 0a20 2020  r,nr0,nrr};..   
-0006b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b120: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0006b130: 736f 722a 2046 3030 203d 2074 656e 736f  sor* F00 = tenso
-0006b140: 722d 3e67 7261 643b 0a20 2020 2020 2020  r->grad;.       
-0006b150: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0006b160: 7563 7420 6767 6d6c 5f74 656e 736f 722a  uct ggml_tensor*
-0006b170: 2046 3031 203d 2067 676d 6c5f 7265 7368   F01 = ggml_resh
-0006b180: 6170 6520 2020 2863 7478 2c20 4630 302c  ape   (ctx, F00,
-0006b190: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-0006b1a0: 2863 7478 2c74 656e 736f 722d 3e67 7261  (ctx,tensor->gra
-0006b1b0: 642d 3e74 7970 652c 342c 6e65 2929 3b0a  d->type,4,ne));.
-0006b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b1d0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0006b1e0: 7465 6e73 6f72 2a20 4630 3220 3d20 6767  tensor* F02 = gg
-0006b1f0: 6d6c 5f70 6572 6d75 7465 2020 2028 6374  ml_permute   (ct
-0006b200: 782c 2046 3031 2c20 302c 322c 312c 3329  x, F01, 0,2,1,3)
-0006b210: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006b220: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0006b230: 6c5f 7465 6e73 6f72 2a20 4630 3320 3d20  l_tensor* F03 = 
-0006b240: 6767 6d6c 5f63 6f6e 7420 2020 2020 2028  ggml_cont      (
-0006b250: 6374 782c 2046 3032 293b 0a20 2020 2020  ctx, F02);.     
-0006b260: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006b270: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0006b280: 722a 2046 3034 203d 2067 676d 6c5f 7265  r* F04 = ggml_re
-0006b290: 7368 6170 655f 3264 2863 7478 2c20 4630  shape_2d(ctx, F0
-0006b2a0: 332c 206e 6330 2a6e 7230 2c20 6e63 722a  3, nc0*nr0, ncr*
-0006b2b0: 6e72 7229 3b0a 2020 2020 2020 2020 2020  nrr);.          
-0006b2c0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0006b2d0: 2067 676d 6c5f 7465 6e73 6f72 2a20 4630   ggml_tensor* F0
-0006b2e0: 3520 3d20 6767 6d6c 5f74 7261 6e73 706f  5 = ggml_transpo
-0006b2f0: 7365 2028 6374 782c 2046 3034 293b 0a20  se (ctx, F04);. 
-0006b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b310: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0006b320: 656e 736f 722a 2046 3036 203d 2067 676d  ensor* F06 = ggm
-0006b330: 6c5f 636f 6e74 2020 2020 2020 2863 7478  l_cont      (ctx
-0006b340: 2c20 4630 3529 3b0a 2020 2020 2020 2020  , F05);.        
-0006b350: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-0006b360: 6374 2067 676d 6c5f 7465 6e73 6f72 2a20  ct ggml_tensor* 
-0006b370: 4630 3720 3d20 6767 6d6c 5f73 756d 5f72  F07 = ggml_sum_r
-0006b380: 6f77 7320 2028 6374 782c 2046 3036 293b  ows  (ctx, F06);
-0006b390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b3a0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0006b3b0: 5f74 656e 736f 722a 2046 3038 203d 2067  _tensor* F08 = g
-0006b3c0: 676d 6c5f 7472 616e 7370 6f73 6520 2863  gml_transpose (c
-0006b3d0: 7478 2c20 4630 3729 3b0a 2020 2020 2020  tx, F07);.      
-0006b3e0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0006b3f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0006b400: 2a20 4630 3920 3d20 6767 6d6c 5f63 6f6e  * F09 = ggml_con
-0006b410: 7420 2020 2020 2028 6374 782c 2046 3038  t      (ctx, F08
-0006b420: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0006b430: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0006b440: 6d6c 5f74 656e 736f 722a 2046 3130 203d  ml_tensor* F10 =
-0006b450: 2067 676d 6c5f 7265 7368 6170 6520 2020   ggml_reshape   
-0006b460: 2863 7478 2c20 4630 392c 2073 7263 302d  (ctx, F09, src0-
-0006b470: 3e67 7261 6429 3b0a 0a20 2020 2020 2020  >grad);..       
-0006b480: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0006b490: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
+0006ab70: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0006ab80: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0006ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aba0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+0006abb0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0006abc0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0006abd0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0006abe0: 2047 474d 4c5f 4f50 5f4d 4541 4e3a 0a20   GGML_OP_MEAN:. 
+0006abf0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0006ac00: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+0006ac10: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+0006ac20: 202f 2f20 544f 444f 3a20 696d 706c 656d   // TODO: implem
+0006ac30: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0006ac40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0006ac50: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
+0006ac60: 5045 4154 3a0a 2020 2020 2020 2020 2020  PEAT:.          
+0006ac70: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0006ac80: 2020 2020 2f2f 206e 6563 6573 7361 7279      // necessary
+0006ac90: 2066 6f72 206c 6c61 6d61 0a20 2020 2020   for llama.     
+0006aca0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0006acb0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+0006acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006acd0: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+0006ace0: 302d 3e6e 5f64 696d 7320 3d3d 2031 207c  0->n_dims == 1 |
+0006acf0: 7c20 7372 6330 2d3e 6e5f 6469 6d73 203d  | src0->n_dims =
+0006ad00: 3d20 3229 3b0a 2020 2020 2020 2020 2020  = 2);.          
+0006ad10: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006ad20: 696e 7420 6e63 2020 3d20 7465 6e73 6f72  int nc  = tensor
+0006ad30: 2d3e 6e65 5b30 5d3b 0a20 2020 2020 2020  ->ne[0];.       
+0006ad40: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006ad50: 7374 2069 6e74 206e 7220 203d 2074 656e  st int nr  = ten
+0006ad60: 736f 722d 3e6e 655b 315d 3b0a 2020 2020  sor->ne[1];.    
+0006ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ad80: 636f 6e73 7420 696e 7420 6e63 3020 3d20  const int nc0 = 
+0006ad90: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+0006ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006adb0: 2063 6f6e 7374 2069 6e74 206e 7230 203d   const int nr0 =
+0006adc0: 2073 7263 302d 3e6e 655b 315d 3b0a 2020   src0->ne[1];.  
+0006add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ade0: 2020 636f 6e73 7420 696e 7420 6e63 7220    const int ncr 
+0006adf0: 3d20 6e63 2f6e 6330 3b20 2f2f 2067 7561  = nc/nc0; // gua
+0006ae00: 7261 6e74 6565 6420 746f 2062 6520 616e  ranteed to be an
+0006ae10: 2069 6e74 6567 6572 2064 7565 2074 6f20   integer due to 
+0006ae20: 7468 6520 6368 6563 6b20 696e 2067 676d  the check in ggm
+0006ae30: 6c5f 6361 6e5f 7265 7065 6174 0a20 2020  l_can_repeat.   
+0006ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ae50: 2063 6f6e 7374 2069 6e74 206e 7272 203d   const int nrr =
+0006ae60: 206e 722f 6e72 303b 202f 2f20 6775 6172   nr/nr0; // guar
+0006ae70: 616e 7465 6564 2074 6f20 6265 2061 6e20  anteed to be an 
+0006ae80: 696e 7465 6765 7220 6475 6520 746f 2074  integer due to t
+0006ae90: 6865 2063 6865 636b 2069 6e20 6767 6d6c  he check in ggml
+0006aea0: 5f63 616e 5f72 6570 6561 740a 2020 2020  _can_repeat.    
+0006aeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aec0: 2f2f 2074 656e 736f 722d 3e67 7261 6420  // tensor->grad 
+0006aed0: 5b6e 632c 6e72 2c31 2c31 5d0a 2020 2020  [nc,nr,1,1].    
+0006aee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aef0: 2f2f 2072 6573 6861 7065 2020 2020 2020  // reshape      
+0006af00: 5b6e 6330 2c6e 632f 6e63 302c 6e72 302c  [nc0,nc/nc0,nr0,
+0006af10: 6e72 2f6e 7230 5d0a 2020 2020 2020 2020  nr/nr0].        
+0006af20: 2020 2020 2020 2020 2020 2020 2f2f 2070              // p
+0006af30: 6572 6d75 7465 2020 2020 2020 5b6e 6330  ermute      [nc0
+0006af40: 2c6e 7230 2c6e 632f 6e63 302c 6e72 2f6e  ,nr0,nc/nc0,nr/n
+0006af50: 7230 5d0a 2020 2020 2020 2020 2020 2020  r0].            
+0006af60: 2020 2020 2020 2020 2f2f 2073 7562 7374          // subst
+0006af70: 6974 7574 6520 2020 5b6e 6330 2c6e 7230  itute   [nc0,nr0
+0006af80: 2c6e 6372 2c6e 7272 5d0a 2020 2020 2020  ,ncr,nrr].      
+0006af90: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006afa0: 2072 6573 6861 7065 2020 2020 2020 5b6e   reshape      [n
+0006afb0: 6330 2a6e 7230 2c6e 6372 2a6e 7272 2c31  c0*nr0,ncr*nrr,1
+0006afc0: 2c31 5d0a 2020 2020 2020 2020 2020 2020  ,1].            
+0006afd0: 2020 2020 2020 2020 2f2f 2074 7261 6e73          // trans
+0006afe0: 706f 7365 2020 2020 5b6e 6372 2a6e 7272  pose    [ncr*nrr
+0006aff0: 2c6e 6330 2a6e 7230 2c31 2c31 5d0a 2020  ,nc0*nr0,1,1].  
+0006b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b010: 2020 2f2f 2073 756d 2072 6f77 7320 2020    // sum rows   
+0006b020: 2020 5b31 2c6e 6330 2a6e 7230 2c31 2c31    [1,nc0*nr0,1,1
+0006b030: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0006b040: 2020 2020 2020 2f2f 2074 7261 6e73 706f        // transpo
+0006b050: 7365 2020 2020 5b6e 6330 2a6e 7230 2c31  se    [nc0*nr0,1
+0006b060: 2c31 5d0a 2020 2020 2020 2020 2020 2020  ,1].            
+0006b070: 2020 2020 2020 2020 2f2f 2072 6573 6861          // resha
+0006b080: 7065 2020 2020 2020 5b6e 6330 2c6e 7230  pe      [nc0,nr0
+0006b090: 2c31 2c31 5d20 7265 7368 6170 655f 3164  ,1,1] reshape_1d
+0006b0a0: 206f 7220 7265 7368 6170 655f 3264 0a20   or reshape_2d. 
+0006b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b0c0: 2020 202f 2f20 6164 6420 746f 2073 7263     // add to src
+0006b0d0: 302d 3e67 7261 640a 0a20 2020 2020 2020  0->grad..       
+0006b0e0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0006b0f0: 3634 5f74 206e 655b 345d 2020 3d20 7b6e  64_t ne[4]  = {n
+0006b100: 6330 2c6e 6372 2c6e 7230 2c6e 7272 7d3b  c0,ncr,nr0,nrr};
+0006b110: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0006b120: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0006b130: 6c5f 7465 6e73 6f72 2a20 4630 3020 3d20  l_tensor* F00 = 
+0006b140: 7465 6e73 6f72 2d3e 6772 6164 3b0a 2020  tensor->grad;.  
+0006b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b160: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0006b170: 6e73 6f72 2a20 4630 3120 3d20 6767 6d6c  nsor* F01 = ggml
+0006b180: 5f72 6573 6861 7065 2020 2028 6374 782c  _reshape   (ctx,
+0006b190: 2046 3030 2c20 6767 6d6c 5f6e 6577 5f74   F00, ggml_new_t
+0006b1a0: 656e 736f 7228 6374 782c 7465 6e73 6f72  ensor(ctx,tensor
+0006b1b0: 2d3e 6772 6164 2d3e 7479 7065 2c34 2c6e  ->grad->type,4,n
+0006b1c0: 6529 293b 0a20 2020 2020 2020 2020 2020  e));.           
+0006b1d0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+0006b1e0: 6767 6d6c 5f74 656e 736f 722a 2046 3032  ggml_tensor* F02
+0006b1f0: 203d 2067 676d 6c5f 7065 726d 7574 6520   = ggml_permute 
+0006b200: 2020 2863 7478 2c20 4630 312c 2030 2c32    (ctx, F01, 0,2
+0006b210: 2c31 2c33 293b 0a20 2020 2020 2020 2020  ,1,3);.         
+0006b220: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+0006b230: 7420 6767 6d6c 5f74 656e 736f 722a 2046  t ggml_tensor* F
+0006b240: 3033 203d 2067 676d 6c5f 636f 6e74 2020  03 = ggml_cont  
+0006b250: 2020 2020 2863 7478 2c20 4630 3229 3b0a      (ctx, F02);.
+0006b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b270: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0006b280: 7465 6e73 6f72 2a20 4630 3420 3d20 6767  tensor* F04 = gg
+0006b290: 6d6c 5f72 6573 6861 7065 5f32 6428 6374  ml_reshape_2d(ct
+0006b2a0: 782c 2046 3033 2c20 6e63 302a 6e72 302c  x, F03, nc0*nr0,
+0006b2b0: 206e 6372 2a6e 7272 293b 0a20 2020 2020   ncr*nrr);.     
+0006b2c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006b2d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0006b2e0: 722a 2046 3035 203d 2067 676d 6c5f 7472  r* F05 = ggml_tr
+0006b2f0: 616e 7370 6f73 6520 2863 7478 2c20 4630  anspose (ctx, F0
+0006b300: 3429 3b0a 2020 2020 2020 2020 2020 2020  4);.            
+0006b310: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0006b320: 676d 6c5f 7465 6e73 6f72 2a20 4630 3620  gml_tensor* F06 
+0006b330: 3d20 6767 6d6c 5f63 6f6e 7420 2020 2020  = ggml_cont     
+0006b340: 2028 6374 782c 2046 3035 293b 0a20 2020   (ctx, F05);.   
+0006b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b360: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0006b370: 736f 722a 2046 3037 203d 2067 676d 6c5f  sor* F07 = ggml_
+0006b380: 7375 6d5f 726f 7773 2020 2863 7478 2c20  sum_rows  (ctx, 
+0006b390: 4630 3629 3b0a 2020 2020 2020 2020 2020  F06);.          
+0006b3a0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+0006b3b0: 2067 676d 6c5f 7465 6e73 6f72 2a20 4630   ggml_tensor* F0
+0006b3c0: 3820 3d20 6767 6d6c 5f74 7261 6e73 706f  8 = ggml_transpo
+0006b3d0: 7365 2028 6374 782c 2046 3037 293b 0a20  se (ctx, F07);. 
+0006b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b3f0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0006b400: 656e 736f 722a 2046 3039 203d 2067 676d  ensor* F09 = ggm
+0006b410: 6c5f 636f 6e74 2020 2020 2020 2863 7478  l_cont      (ctx
+0006b420: 2c20 4630 3829 3b0a 2020 2020 2020 2020  , F08);.        
+0006b430: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+0006b440: 6374 2067 676d 6c5f 7465 6e73 6f72 2a20  ct ggml_tensor* 
+0006b450: 4631 3020 3d20 6767 6d6c 5f72 6573 6861  F10 = ggml_resha
+0006b460: 7065 2020 2028 6374 782c 2046 3039 2c20  pe   (ctx, F09, 
+0006b470: 7372 6330 2d3e 6772 6164 293b 0a0a 2020  src0->grad);..  
+0006b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b490: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
 0006b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b4b0: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-0006b4c0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006b4b0: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
+0006b4c0: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
 0006b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b4e0: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
-0006b4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b4e0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+0006b4f0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
 0006b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b510: 2046 3130 2c0a 2020 2020 2020 2020 2020   F10,.          
+0006b510: 2020 2020 2020 4631 302c 0a20 2020 2020        F10,.     
 0006b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b530: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-0006b540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b550: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-0006b560: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0006b570: 6173 6520 4747 4d4c 5f4f 505f 4142 533a  ase GGML_OP_ABS:
-0006b580: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0006b590: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006b5a0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-0006b5b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b5c0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0006b5d0: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-0006b5e0: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
-0006b5f0: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
-0006b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b610: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0006b620: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
+0006b530: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+0006b540: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0006b550: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0006b560: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0006b570: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0006b580: 5f41 4253 3a0a 2020 2020 2020 2020 2020  _ABS:.          
+0006b590: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0006b5a0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+0006b5b0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+0006b5c0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+0006b5d0: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
+0006b5e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006b5f0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+0006b600: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b620: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
 0006b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b640: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
-0006b650: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0006b640: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006b650: 6d6c 5f6d 756c 2863 7478 2c0a 2020 2020  ml_mul(ctx,.    
 0006b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b670: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006b680: 7367 6e28 6374 782c 2073 7263 3029 2c0a  sgn(ctx, src0),.
-0006b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b680: 6767 6d6c 5f73 676e 2863 7478 2c20 7372  ggml_sgn(ctx, sr
+0006b690: 6330 292c 0a20 2020 2020 2020 2020 2020  c0),.           
 0006b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b6b0: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
-0006b6c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0006b6b0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+0006b6c0: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
 0006b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b6e0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-0006b6f0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0006b700: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0006b710: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0006b720: 2047 474d 4c5f 4f50 5f53 474e 3a0a 2020   GGML_OP_SGN:.  
-0006b730: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0006b740: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0006b750: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-0006b760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b770: 2020 2f2f 206e 6f6f 700a 2020 2020 2020    // noop.      
-0006b780: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0006b790: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0006b7a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006b7b0: 4d4c 5f4f 505f 4e45 473a 0a20 2020 2020  ML_OP_NEG:.     
-0006b7c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0006b7d0: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0006b7e0: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0006b7f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006b800: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
-0006b810: 5f73 7562 5f69 6d70 6c28 6374 782c 2073  _sub_impl(ctx, s
-0006b820: 7263 302d 3e67 7261 642c 2074 656e 736f  rc0->grad, tenso
-0006b830: 722d 3e67 7261 642c 2069 6e70 6c61 6365  r->grad, inplace
-0006b840: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0006b850: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0006b860: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0006b870: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-0006b880: 5445 503a 0a20 2020 2020 2020 2020 2020  TEP:.           
-0006b890: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006b8a0: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-0006b8b0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0006b8c0: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
-0006b8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b8e0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0006b8f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0006b900: 6361 7365 2047 474d 4c5f 4f50 5f52 454c  case GGML_OP_REL
-0006b910: 553a 0a20 2020 2020 2020 2020 2020 207b  U:.            {
-0006b920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006b930: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-0006b940: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006b950: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0006b960: 6420 3d20 6767 6d6c 5f73 7562 5f69 6d70  d = ggml_sub_imp
-0006b970: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+0006b6e0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0006b6f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006b700: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006b710: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0006b720: 2063 6173 6520 4747 4d4c 5f4f 505f 5347   case GGML_OP_SG
+0006b730: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
+0006b740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006b750: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+0006b760: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006b770: 2020 2020 2020 202f 2f20 6e6f 6f70 0a20         // noop. 
+0006b780: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0006b790: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006b7a0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0006b7b0: 7365 2047 474d 4c5f 4f50 5f4e 4547 3a0a  se GGML_OP_NEG:.
+0006b7c0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0006b7d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006b7e0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
+0006b7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b800: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+0006b810: 2067 676d 6c5f 7375 625f 696d 706c 2863   ggml_sub_impl(c
+0006b820: 7478 2c20 7372 6330 2d3e 6772 6164 2c20  tx, src0->grad, 
+0006b830: 7465 6e73 6f72 2d3e 6772 6164 2c20 696e  tensor->grad, in
+0006b840: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0006b850: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0006b860: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0006b870: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0006b880: 5f4f 505f 5354 4550 3a0a 2020 2020 2020  _OP_STEP:.      
+0006b890: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0006b8a0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0006b8b0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0006b8c0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006b8d0: 206e 6f6f 700a 2020 2020 2020 2020 2020   noop.          
+0006b8e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0006b8f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0006b900: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0006b910: 505f 5245 4c55 3a0a 2020 2020 2020 2020  P_RELU:.        
+0006b920: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0006b930: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+0006b940: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0006b950: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0006b960: 2d3e 6772 6164 203d 2067 676d 6c5f 7375  ->grad = ggml_su
+0006b970: 625f 696d 706c 2863 7478 2c0a 2020 2020  b_impl(ctx,.    
 0006b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b990: 2020 2073 7263 302d 3e67 7261 642c 0a20     src0->grad,. 
-0006b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b9b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006b9c0: 6d75 6c28 6374 782c 0a20 2020 2020 2020  mul(ctx,.       
+0006b990: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0006b9a0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0006b9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006b9c0: 6767 6d6c 5f6d 756c 2863 7478 2c0a 2020  ggml_mul(ctx,.  
 0006b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006b9e0: 2020 2020 2020 2020 2067 676d 6c5f 7374           ggml_st
-0006b9f0: 6570 2863 7478 2c20 7372 6330 292c 0a20  ep(ctx, src0),. 
-0006ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ba10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0006ba20: 656e 736f 722d 3e67 7261 6429 2c0a 2020  ensor->grad),.  
-0006ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ba40: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-0006ba50: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0006ba60: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0006ba70: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0006ba80: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0006ba90: 4745 4c55 3a0a 2020 2020 2020 2020 2020  GELU:.          
-0006baa0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006bab0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006bac0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-0006bad0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-0006bae0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0006baf0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0006bb00: 7365 2047 474d 4c5f 4f50 5f41 4c49 4249  se GGML_OP_ALIBI
-0006bb10: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0006bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bb30: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0006bb40: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-0006bb50: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-0006bb60: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0006bb70: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0006bb80: 474d 4c5f 4f50 5f43 4c41 4d50 3a0a 2020  GML_OP_CLAMP:.  
-0006bb90: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0006bba0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0006bbb0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-0006bbc0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
-0006bbd0: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
-0006bbe0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0006bbf0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0006bc00: 4f50 5f53 494c 553a 0a20 2020 2020 2020  OP_SILU:.       
-0006bc10: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006bc20: 2020 2020 2020 202f 2f20 6e65 6365 7373         // necess
-0006bc30: 6172 7920 666f 7220 6c6c 616d 610a 2020  ary for llama.  
-0006bc40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006bc50: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-0006bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bc70: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-0006bc80: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0006bc90: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0006b9e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006b9f0: 6d6c 5f73 7465 7028 6374 782c 2073 7263  ml_step(ctx, src
+0006ba00: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
+0006ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ba20: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
+0006ba30: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0006ba40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006ba50: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0006ba60: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006ba70: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0006ba80: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0006ba90: 4c5f 4f50 5f47 454c 553a 0a20 2020 2020  L_OP_GELU:.     
+0006baa0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006bab0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0006bac0: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+0006bad0: 544f 444f 3a20 6e6f 7420 696d 706c 656d  TODO: not implem
+0006bae0: 656e 7465 640a 2020 2020 2020 2020 2020  ented.          
+0006baf0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0006bb00: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0006bb10: 414c 4942 493a 0a20 2020 2020 2020 2020  ALIBI:.         
+0006bb20: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0006bb30: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0006bb40: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
+0006bb50: 3a20 6e6f 7420 696d 706c 656d 656e 7465  : not implemente
+0006bb60: 640a 2020 2020 2020 2020 2020 2020 7d20  d.            } 
+0006bb70: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0006bb80: 6173 6520 4747 4d4c 5f4f 505f 434c 414d  ase GGML_OP_CLAM
+0006bb90: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
+0006bba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006bbb0: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+0006bbc0: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
+0006bbd0: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
+0006bbe0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0006bbf0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0006bc00: 4747 4d4c 5f4f 505f 5349 4c55 3a0a 2020  GGML_OP_SILU:.  
+0006bc10: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0006bc20: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+0006bc30: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
+0006bc40: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
+0006bc50: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0006bc60: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0006bc70: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0006bc80: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
+0006bc90: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
 0006bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bcb0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
-0006bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bcd0: 2020 2020 2020 2020 6767 6d6c 5f73 696c          ggml_sil
-0006bce0: 755f 6261 636b 2863 7478 2c20 7372 6330  u_back(ctx, src0
-0006bcf0: 2c20 7465 6e73 6f72 2d3e 6772 6164 292c  , tensor->grad),
-0006bd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bd10: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-0006bd20: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-0006bd30: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0006bd40: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0006bd50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0006bd60: 4f50 5f53 494c 555f 4241 434b 3a0a 2020  OP_SILU_BACK:.  
-0006bd70: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0006bd80: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0006bd90: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-0006bda0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
-0006bdb0: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
-0006bdc0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0006bdd0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0006bde0: 4f50 5f4e 4f52 4d3a 0a20 2020 2020 2020  OP_NORM:.       
-0006bdf0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006be00: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0006be10: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-0006be20: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
-0006be30: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0006be40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0006be50: 2063 6173 6520 4747 4d4c 5f4f 505f 524d   case GGML_OP_RM
-0006be60: 535f 4e4f 524d 3a0a 2020 2020 2020 2020  S_NORM:.        
-0006be70: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0006be80: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
-0006be90: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
-0006bea0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0006beb0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-0006bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bed0: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
-0006bee0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-0006bef0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0006bf00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006bf10: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+0006bcb0: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
+0006bcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006bcd0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006bce0: 6c5f 7369 6c75 5f62 6163 6b28 6374 782c  l_silu_back(ctx,
+0006bcf0: 2073 7263 302c 2074 656e 736f 722d 3e67   src0, tensor->g
+0006bd00: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
+0006bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bd20: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
+0006bd30: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0006bd40: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0006bd50: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0006bd60: 4747 4d4c 5f4f 505f 5349 4c55 5f42 4143  GGML_OP_SILU_BAC
+0006bd70: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
+0006bd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006bd90: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+0006bda0: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
+0006bdb0: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
+0006bdc0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0006bdd0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0006bde0: 4747 4d4c 5f4f 505f 4e4f 524d 3a0a 2020  GGML_OP_NORM:.  
+0006bdf0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0006be00: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0006be10: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+0006be20: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
+0006be30: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
+0006be40: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0006be50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0006be60: 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20 2020  OP_RMS_NORM:.   
+0006be70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0006be80: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+0006be90: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+0006bea0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0006beb0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0006bec0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0006bed0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0006bee0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+0006bef0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0006bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bf10: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
 0006bf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bf30: 2020 2020 2020 2067 676d 6c5f 726d 735f         ggml_rms_
-0006bf40: 6e6f 726d 5f62 6163 6b28 6374 782c 2073  norm_back(ctx, s
-0006bf50: 7263 302c 2074 656e 736f 722d 3e67 7261  rc0, tensor->gra
-0006bf60: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+0006bf30: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006bf40: 5f72 6d73 5f6e 6f72 6d5f 6261 636b 2863  _rms_norm_back(c
+0006bf50: 7478 2c20 7372 6330 2c20 7465 6e73 6f72  tx, src0, tensor
+0006bf60: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
 0006bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bf80: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-0006bf90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0006bfa0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0006bfb0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006bfc0: 4d4c 5f4f 505f 524d 535f 4e4f 524d 5f42  ML_OP_RMS_NORM_B
-0006bfd0: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
-0006bfe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006bff0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0006c000: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
-0006c010: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
-0006c020: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0006c030: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0006c040: 6520 4747 4d4c 5f4f 505f 4d55 4c5f 4d41  e GGML_OP_MUL_MA
-0006c050: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
-0006c060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c070: 202f 2f20 6874 7470 733a 2f2f 6373 3233   // https://cs23
-0006c080: 316e 2e67 6974 6875 622e 696f 2f6f 7074  1n.github.io/opt
-0006c090: 696d 697a 6174 696f 6e2d 322f 2373 7461  imization-2/#sta
-0006c0a0: 6765 640a 2020 2020 2020 2020 2020 2020  ged.            
-0006c0b0: 2020 2020 2f2f 2023 2066 6f72 7761 7264      // # forward
-0006c0c0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-0006c0d0: 2020 2020 2020 2f2f 2073 3020 3d20 6e70        // s0 = np
-0006c0e0: 2e72 616e 646f 6d2e 7261 6e64 6e28 352c  .random.randn(5,
-0006c0f0: 2031 3029 0a20 2020 2020 2020 2020 2020   10).           
-0006c100: 2020 2020 202f 2f20 7331 203d 206e 702e       // s1 = np.
-0006c110: 7261 6e64 6f6d 2e72 616e 646e 2831 302c  random.randn(10,
-0006c120: 2033 290a 2020 2020 2020 2020 2020 2020   3).            
-0006c130: 2020 2020 2f2f 2074 203d 2073 302e 646f      // t = s0.do
-0006c140: 7428 7331 290a 0a20 2020 2020 2020 2020  t(s1)..         
-0006c150: 2020 2020 2020 202f 2f20 2320 6e6f 7720         // # now 
-0006c160: 7375 7070 6f73 6520 7765 2068 6164 2074  suppose we had t
-0006c170: 6865 2067 7261 6469 656e 7420 6f6e 2074  he gradient on t
-0006c180: 2066 726f 6d20 6162 6f76 6520 696e 2074   from above in t
-0006c190: 6865 2063 6972 6375 6974 0a20 2020 2020  he circuit.     
-0006c1a0: 2020 2020 2020 2020 2020 202f 2f20 6474             // dt
-0006c1b0: 203d 206e 702e 7261 6e64 6f6d 2e72 616e   = np.random.ran
-0006c1c0: 646e 282a 742e 7368 6170 6529 2023 2073  dn(*t.shape) # s
-0006c1d0: 616d 6520 7368 6170 6520 6173 2074 0a20  ame shape as t. 
-0006c1e0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006c1f0: 2f20 6473 3020 3d20 6474 2e64 6f74 2873  / ds0 = dt.dot(s
-0006c200: 312e 5429 2023 2e54 2067 6976 6573 2074  1.T) #.T gives t
-0006c210: 6865 2074 7261 6e73 706f 7365 206f 6620  he transpose of 
-0006c220: 7468 6520 6d61 7472 6978 0a20 2020 2020  the matrix.     
-0006c230: 2020 2020 2020 2020 2020 202f 2f20 6473             // ds
-0006c240: 3120 3d20 742e 542e 646f 7428 6474 290a  1 = t.T.dot(dt).
-0006c250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c260: 202f 2f20 7465 6e73 6f72 2e73 6861 7065   // tensor.shape
-0006c270: 205b 6d2c 705d 0a20 2020 2020 2020 2020   [m,p].         
-0006c280: 2020 2020 2020 202f 2f20 7372 6330 2e73         // src0.s
-0006c290: 6861 7065 2020 205b 6e2c 6d5d 0a20 2020  hape   [n,m].   
-0006c2a0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006c2b0: 7372 6331 2e73 6861 7065 2020 205b 6e2c  src1.shape   [n,
-0006c2c0: 705d 0a0a 2020 2020 2020 2020 2020 2020  p]..            
-0006c2d0: 2020 2020 2f2f 206e 6563 6573 7361 7279      // necessary
-0006c2e0: 2066 6f72 206c 6c61 6d61 0a20 2020 2020   for llama.     
-0006c2f0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0006c300: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0006c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c320: 202f 2f20 544f 444f 3a20 7468 6973 2072   // TODO: this r
-0006c330: 6571 7569 7265 7320 6f75 7465 7220 7072  equires outer pr
-0006c340: 6f64 7563 7420 2d20 6767 6d6c 5f6f 7574  oduct - ggml_out
-0006c350: 5f70 726f 6428 6374 782c 2073 7263 312c  _prod(ctx, src1,
-0006c360: 2074 656e 736f 722d 3e67 7261 6429 3b0a   tensor->grad);.
-0006c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c380: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-0006c390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c3a0: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
-0006c3b0: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
-0006c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c3d0: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0006c3e0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0006bf80: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+0006bf90: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0006bfa0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006bfb0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0006bfc0: 7365 2047 474d 4c5f 4f50 5f52 4d53 5f4e  se GGML_OP_RMS_N
+0006bfd0: 4f52 4d5f 4241 434b 3a0a 2020 2020 2020  ORM_BACK:.      
+0006bfe0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0006bff0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0006c000: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
+0006c010: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
+0006c020: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
+0006c030: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0006c040: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+0006c050: 554c 5f4d 4154 3a0a 2020 2020 2020 2020  UL_MAT:.        
+0006c060: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0006c070: 2020 2020 2020 2f2f 2068 7474 7073 3a2f        // https:/
+0006c080: 2f63 7332 3331 6e2e 6769 7468 7562 2e69  /cs231n.github.i
+0006c090: 6f2f 6f70 7469 6d69 7a61 7469 6f6e 2d32  o/optimization-2
+0006c0a0: 2f23 7374 6167 6564 0a20 2020 2020 2020  /#staged.       
+0006c0b0: 2020 2020 2020 2020 202f 2f20 2320 666f           // # fo
+0006c0c0: 7277 6172 6420 7061 7373 0a20 2020 2020  rward pass.     
+0006c0d0: 2020 2020 2020 2020 2020 202f 2f20 7330             // s0
+0006c0e0: 203d 206e 702e 7261 6e64 6f6d 2e72 616e   = np.random.ran
+0006c0f0: 646e 2835 2c20 3130 290a 2020 2020 2020  dn(5, 10).      
+0006c100: 2020 2020 2020 2020 2020 2f2f 2073 3120            // s1 
+0006c110: 3d20 6e70 2e72 616e 646f 6d2e 7261 6e64  = np.random.rand
+0006c120: 6e28 3130 2c20 3329 0a20 2020 2020 2020  n(10, 3).       
+0006c130: 2020 2020 2020 2020 202f 2f20 7420 3d20           // t = 
+0006c140: 7330 2e64 6f74 2873 3129 0a0a 2020 2020  s0.dot(s1)..    
+0006c150: 2020 2020 2020 2020 2020 2020 2f2f 2023              // #
+0006c160: 206e 6f77 2073 7570 706f 7365 2077 6520   now suppose we 
+0006c170: 6861 6420 7468 6520 6772 6164 6965 6e74  had the gradient
+0006c180: 206f 6e20 7420 6672 6f6d 2061 626f 7665   on t from above
+0006c190: 2069 6e20 7468 6520 6369 7263 7569 740a   in the circuit.
+0006c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c1b0: 2f2f 2064 7420 3d20 6e70 2e72 616e 646f  // dt = np.rando
+0006c1c0: 6d2e 7261 6e64 6e28 2a74 2e73 6861 7065  m.randn(*t.shape
+0006c1d0: 2920 2320 7361 6d65 2073 6861 7065 2061  ) # same shape a
+0006c1e0: 7320 740a 2020 2020 2020 2020 2020 2020  s t.            
+0006c1f0: 2020 2020 2f2f 2064 7330 203d 2064 742e      // ds0 = dt.
+0006c200: 646f 7428 7331 2e54 2920 232e 5420 6769  dot(s1.T) #.T gi
+0006c210: 7665 7320 7468 6520 7472 616e 7370 6f73  ves the transpos
+0006c220: 6520 6f66 2074 6865 206d 6174 7269 780a  e of the matrix.
+0006c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c240: 2f2f 2064 7331 203d 2074 2e54 2e64 6f74  // ds1 = t.T.dot
+0006c250: 2864 7429 0a0a 2020 2020 2020 2020 2020  (dt)..          
+0006c260: 2020 2020 2020 2f2f 2074 656e 736f 722e        // tensor.
+0006c270: 7368 6170 6520 5b6d 2c70 5d0a 2020 2020  shape [m,p].    
+0006c280: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+0006c290: 7263 302e 7368 6170 6520 2020 5b6e 2c6d  rc0.shape   [n,m
+0006c2a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0006c2b0: 2020 2f2f 2073 7263 312e 7368 6170 6520    // src1.shape 
+0006c2c0: 2020 5b6e 2c70 5d0a 0a20 2020 2020 2020    [n,p]..       
+0006c2d0: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
+0006c2e0: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
+0006c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c300: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0006c310: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006c320: 2020 2020 2020 2f2f 2054 4f44 4f3a 2074        // TODO: t
+0006c330: 6869 7320 7265 7175 6972 6573 206f 7574  his requires out
+0006c340: 6572 2070 726f 6475 6374 202d 2067 676d  er product - ggm
+0006c350: 6c5f 6f75 745f 7072 6f64 2863 7478 2c20  l_out_prod(ctx, 
+0006c360: 7372 6331 2c20 7465 6e73 6f72 2d3e 6772  src1, tensor->gr
+0006c370: 6164 293b 0a20 2020 2020 2020 2020 2020  ad);.           
+0006c380: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0006c390: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
+0006c3a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006c3b0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+0006c3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c3e0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
 0006c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c400: 2020 2020 2020 2020 2f2f 2064 7330 203d          // ds0 =
-0006c410: 2064 742e 646f 7428 7331 2e54 290a 2020   dt.dot(s1.T).  
-0006c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c430: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006c440: 2067 676d 6c5f 6f75 745f 7072 6f64 2863   ggml_out_prod(c
-0006c450: 7478 2c20 2f2f 205b 6e2c 6d5d 0a20 2020  tx, // [n,m].   
-0006c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c470: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006c480: 2020 2020 7372 6331 2c20 2020 2020 2020      src1,       
-0006c490: 2020 202f 2f20 5b6e 2c70 5d0a 2020 2020     // [n,p].    
-0006c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c4b0: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-0006c4c0: 2020 2074 656e 736f 722d 3e67 7261 6429     tensor->grad)
-0006c4d0: 2c20 2f2f 205b 6d2c 705d 0a20 2020 2020  , // [m,p].     
+0006c400: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006c410: 6473 3020 3d20 6474 2e64 6f74 2873 312e  ds0 = dt.dot(s1.
+0006c420: 5429 0a20 2020 2020 2020 2020 2020 2020  T).             
+0006c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c440: 2020 202f 2f20 6767 6d6c 5f6f 7574 5f70     // ggml_out_p
+0006c450: 726f 6428 6374 782c 202f 2f20 5b6e 2c6d  rod(ctx, // [n,m
+0006c460: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0006c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c480: 2020 2f2f 2020 2020 2073 7263 312c 2020    //     src1,  
+0006c490: 2020 2020 2020 2020 2f2f 205b 6e2c 705d          // [n,p]
+0006c4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c4c0: 202f 2f20 2020 2020 7465 6e73 6f72 2d3e   //     tensor->
+0006c4d0: 6772 6164 292c 202f 2f20 5b6d 2c70 5d0a  grad), // [m,p].
 0006c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c4f0: 2020 2020 2020 2020 2020 202f 2f20 666f             // fo
-0006c500: 7220 6e6f 7720 6a75 7374 2075 7369 6e67  r now just using
-0006c510: 2041 2a42 3d3d 2842 2e54 2a41 2e54 292e   A*B==(B.T*A.T).
-0006c520: 540a 2020 2020 2020 2020 2020 2020 2020  T.              
+0006c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c500: 2f2f 2066 6f72 206e 6f77 206a 7573 7420  // for now just 
+0006c510: 7573 696e 6720 412a 423d 3d28 422e 542a  using A*B==(B.T*
+0006c520: 412e 5429 2e54 0a20 2020 2020 2020 2020  A.T).T.         
 0006c530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c540: 2020 6767 6d6c 5f63 6f6e 7428 6374 782c    ggml_cont(ctx,
-0006c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c560: 2020 2020 2020 2f2f 205b 6e2c 6d5d 0a20        // [n,m]. 
-0006c570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c540: 2020 2020 2020 2067 676d 6c5f 636f 6e74         ggml_cont
+0006c550: 2863 7478 2c20 2020 2020 2020 2020 2020  (ctx,           
+0006c560: 2020 2020 2020 2020 2020 202f 2f20 5b6e             // [n
+0006c570: 2c6d 5d0a 2020 2020 2020 2020 2020 2020  ,m].            
 0006c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c590: 2020 2067 676d 6c5f 7472 616e 7370 6f73     ggml_transpos
-0006c5a0: 6528 6374 782c 2020 2020 2020 2020 2020  e(ctx,          
-0006c5b0: 2020 202f 2f20 5b6e 2c6d 5d0a 2020 2020     // [n,m].    
-0006c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c590: 2020 2020 2020 2020 6767 6d6c 5f74 7261          ggml_tra
+0006c5a0: 6e73 706f 7365 2863 7478 2c20 2020 2020  nspose(ctx,     
+0006c5b0: 2020 2020 2020 2020 2f2f 205b 6e2c 6d5d          // [n,m]
+0006c5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0006c5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c5e0: 2020 2020 6767 6d6c 5f6d 756c 5f6d 6174      ggml_mul_mat
-0006c5f0: 2863 7478 2c20 2020 2020 2020 2020 2020  (ctx,           
-0006c600: 2f2f 205b 6d2c 6e5d 0a20 2020 2020 2020  // [m,n].       
+0006c5e0: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
+0006c5f0: 6c5f 6d61 7428 6374 782c 2020 2020 2020  l_mat(ctx,      
+0006c600: 2020 2020 202f 2f20 5b6d 2c6e 5d0a 2020       // [m,n].  
 0006c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0006c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c630: 2020 2020 2067 676d 6c5f 636f 6e74 2863       ggml_cont(c
-0006c640: 7478 2c20 2020 2020 2020 2020 202f 2f20  tx,          // 
-0006c650: 5b70 2c6d 5d0a 2020 2020 2020 2020 2020  [p,m].          
+0006c630: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0006c640: 6f6e 7428 6374 782c 2020 2020 2020 2020  ont(ctx,        
+0006c650: 2020 2f2f 205b 702c 6d5d 0a20 2020 2020    // [p,m].     
 0006c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0006c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c680: 2020 2020 2020 6767 6d6c 5f74 7261 6e73        ggml_trans
-0006c690: 706f 7365 2863 7478 2c20 2f2f 205b 702c  pose(ctx, // [p,
-0006c6a0: 6d5d 0a20 2020 2020 2020 2020 2020 2020  m].             
+0006c680: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006c690: 7472 616e 7370 6f73 6528 6374 782c 202f  transpose(ctx, /
+0006c6a0: 2f20 5b70 2c6d 5d0a 2020 2020 2020 2020  / [p,m].        
 0006c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0006c6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c6d0: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-0006c6e0: 7261 6429 292c 202f 2f20 5b6d 2c70 5d0a  rad)), // [m,p].
-0006c6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c6d0: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0006c6e0: 6f72 2d3e 6772 6164 2929 2c20 2f2f 205b  or->grad)), // [
+0006c6f0: 6d2c 705d 0a20 2020 2020 2020 2020 2020  m,p].           
 0006c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c710: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006c720: 5f63 6f6e 7428 6374 782c 2020 2020 2020  _cont(ctx,      
-0006c730: 2020 2020 2f2f 205b 702c 6e5d 0a20 2020      // [p,n].   
-0006c740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c720: 2067 676d 6c5f 636f 6e74 2863 7478 2c20   ggml_cont(ctx, 
+0006c730: 2020 2020 2020 2020 202f 2f20 5b70 2c6e           // [p,n
+0006c740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
 0006c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c760: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006c770: 6c5f 7472 616e 7370 6f73 6528 6374 782c  l_transpose(ctx,
-0006c780: 202f 2f20 5b70 2c6e 5d0a 2020 2020 2020   // [p,n].      
+0006c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c770: 2020 6767 6d6c 5f74 7261 6e73 706f 7365    ggml_transpose
+0006c780: 2863 7478 2c20 2f2f 205b 702c 6e5d 0a20  (ctx, // [p,n]. 
 0006c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0006c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c7b0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0006c7c0: 6331 2929 2929 292c 2020 2020 2020 2f2f  c1))))),      //
-0006c7d0: 205b 6e2c 705d 0a20 2020 2020 2020 2020   [n,p].         
+0006c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c7c0: 2020 2073 7263 3129 2929 2929 2c20 2020     src1))))),   
+0006c7d0: 2020 202f 2f20 5b6e 2c70 5d0a 2020 2020     // [n,p].    
 0006c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c7f0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-0006c800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006c810: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0006c820: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
-0006c830: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0006c840: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
-0006c850: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
-0006c860: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006c870: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-0006c880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c7f0: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+0006c800: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0006c810: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0006c820: 2020 2020 2020 2020 6966 2028 7372 6331          if (src1
+0006c830: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0006c840: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0006c850: 6331 2d3e 6772 6164 203d 0a20 2020 2020  c1->grad =.     
+0006c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c870: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
+0006c880: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
 0006c890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c8a0: 2073 7263 312d 3e67 7261 642c 0a20 2020   src1->grad,.   
-0006c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c8c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006c8d0: 6473 3120 3d20 7330 2e54 2e64 6f74 2864  ds1 = s0.T.dot(d
-0006c8e0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0006c8a0: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
+0006c8b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c8d0: 2020 2f2f 2064 7331 203d 2073 302e 542e    // ds1 = s0.T.
+0006c8e0: 646f 7428 6474 293a 0a20 2020 2020 2020  dot(dt):.       
 0006c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c900: 2020 2020 6767 6d6c 5f6d 756c 5f6d 6174      ggml_mul_mat
-0006c910: 2863 7478 2c20 2020 2020 2020 2020 2020  (ctx,           
-0006c920: 2020 2020 2020 2020 2f2f 205b 6e2c 705d          // [n,p]
-0006c930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006c900: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
+0006c910: 6c5f 6d61 7428 6374 782c 2020 2020 2020  l_mat(ctx,      
+0006c920: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006c930: 5b6e 2c70 5d0a 2020 2020 2020 2020 2020  [n,p].          
 0006c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c950: 2020 2020 2067 676d 6c5f 636f 6e74 2863       ggml_cont(c
-0006c960: 7478 2c20 2020 2020 2020 2020 2020 2020  tx,             
-0006c970: 2020 2020 202f 2f20 5b6d 2c6e 5d0a 2020       // [m,n].  
-0006c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c950: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+0006c960: 6f6e 7428 6374 782c 2020 2020 2020 2020  ont(ctx,        
+0006c970: 2020 2020 2020 2020 2020 2f2f 205b 6d2c            // [m,
+0006c980: 6e5d 0a20 2020 2020 2020 2020 2020 2020  n].             
 0006c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c9a0: 2020 2020 2020 6767 6d6c 5f74 7261 6e73        ggml_trans
-0006c9b0: 706f 7365 2863 7478 2c20 7372 6330 2929  pose(ctx, src0))
-0006c9c0: 2c20 2f2f 205b 6d2c 6e5d 0a20 2020 2020  , // [m,n].     
+0006c9a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006c9b0: 7472 616e 7370 6f73 6528 6374 782c 2073  transpose(ctx, s
+0006c9c0: 7263 3029 292c 202f 2f20 5b6d 2c6e 5d0a  rc0)), // [m,n].
 0006c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006c9e0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0006c9f0: 656e 736f 722d 3e67 7261 6429 2c20 2020  ensor->grad),   
-0006ca00: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006ca10: 2f20 5b6d 2c70 5d0a 2020 2020 2020 2020  / [m,p].        
+0006c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006c9f0: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
+0006ca00: 292c 2020 2020 2020 2020 2020 2020 2020  ),              
+0006ca10: 2020 2020 2f2f 205b 6d2c 705d 0a20 2020      // [m,p].   
 0006ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ca30: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-0006ca40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006ca50: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0006ca60: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0006ca70: 2063 6173 6520 4747 4d4c 5f4f 505f 5343   case GGML_OP_SC
-0006ca80: 414c 453a 0a20 2020 2020 2020 2020 2020  ALE:.           
-0006ca90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006caa0: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
-0006cab0: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
-0006cac0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0006cad0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-0006cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006caf0: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
-0006cb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cb10: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
-0006cb20: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0006ca30: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+0006ca40: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+0006ca50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0006ca60: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0006ca70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0006ca80: 4f50 5f53 4341 4c45 3a0a 2020 2020 2020  OP_SCALE:.      
+0006ca90: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0006caa0: 2020 2020 2020 2020 2f2f 206e 6563 6573          // neces
+0006cab0: 7361 7279 2066 6f72 206c 6c61 6d61 0a20  sary for llama. 
+0006cac0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006cad0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+0006cae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006caf0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+0006cb00: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
+0006cb10: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
+0006cb20: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
 0006cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cb40: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-0006cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cb60: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006cb70: 5f73 6361 6c65 5f69 6d70 6c28 6374 782c  _scale_impl(ctx,
-0006cb80: 2074 656e 736f 722d 3e67 7261 642c 2073   tensor->grad, s
-0006cb90: 7263 312c 2066 616c 7365 292c 0a20 2020  rc1, false),.   
-0006cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cbb0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-0006cbc0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0006cbd0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0006cbe0: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
-0006cbf0: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-0006cc00: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-0006cc10: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+0006cb40: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0006cb50: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0006cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cb70: 2067 676d 6c5f 7363 616c 655f 696d 706c   ggml_scale_impl
+0006cb80: 2863 7478 2c20 7465 6e73 6f72 2d3e 6772  (ctx, tensor->gr
+0006cb90: 6164 2c20 7372 6331 2c20 6661 6c73 6529  ad, src1, false)
+0006cba0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006cbb0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0006cbc0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0006cbd0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0006cbe0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+0006cbf0: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
+0006cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cc10: 7372 6331 2d3e 6772 6164 203d 0a20 2020  src1->grad =.   
 0006cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cc30: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-0006cc40: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0006cc50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006cc60: 7263 312d 3e67 7261 642c 0a20 2020 2020  rc1->grad,.     
+0006cc30: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+0006cc40: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0006cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cc60: 2020 2020 7372 6331 2d3e 6772 6164 2c0a      src1->grad,.
 0006cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cc80: 2020 2020 2020 2067 676d 6c5f 7375 6d28         ggml_sum(
-0006cc90: 6374 782c 2067 676d 6c5f 6d75 6c5f 696d  ctx, ggml_mul_im
-0006cca0: 706c 2863 7478 2c20 7465 6e73 6f72 2d3e  pl(ctx, tensor->
-0006ccb0: 6772 6164 2c20 7372 6330 2c20 6661 6c73  grad, src0, fals
-0006ccc0: 6529 292c 0a20 2020 2020 2020 2020 2020  e)),.           
+0006cc80: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006cc90: 5f73 756d 2863 7478 2c20 6767 6d6c 5f6d  _sum(ctx, ggml_m
+0006cca0: 756c 5f69 6d70 6c28 6374 782c 2074 656e  ul_impl(ctx, ten
+0006ccb0: 736f 722d 3e67 7261 642c 2073 7263 302c  sor->grad, src0,
+0006ccc0: 2066 616c 7365 2929 2c0a 2020 2020 2020   false)),.      
 0006ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cce0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-0006ccf0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0006cd00: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0006cd10: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0006cd20: 474d 4c5f 4f50 5f53 4554 3a0a 2020 2020  GML_OP_SET:.    
-0006cd30: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0006cd40: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0006cd50: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
-0006cd60: 656e 7473 2874 656e 736f 722d 3e6f 7074  ents(tensor->opt
-0006cd70: 5b30 5d29 203d 3d20 3529 3b0a 2020 2020  [0]) == 5);.    
-0006cd80: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0006cd90: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-0006cda0: 6f70 745b 305d 2d3e 7479 7065 203d 3d20  opt[0]->type == 
-0006cdb0: 4747 4d4c 5f54 5950 455f 4933 3229 3b0a  GGML_TYPE_I32);.
-0006cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cdd0: 636f 6e73 7420 7369 7a65 5f74 206e 6231  const size_t nb1
-0006cde0: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
-0006cdf0: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
-0006ce00: 745b 305d 2d3e 6461 7461 295b 305d 3b0a  t[0]->data)[0];.
-0006ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ce20: 636f 6e73 7420 7369 7a65 5f74 206e 6232  const size_t nb2
-0006ce30: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
-0006ce40: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
-0006ce50: 745b 305d 2d3e 6461 7461 295b 315d 3b0a  t[0]->data)[1];.
-0006ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ce70: 636f 6e73 7420 7369 7a65 5f74 206e 6233  const size_t nb3
-0006ce80: 2020 2020 203d 2028 2820 696e 7433 325f       = (( int32_
-0006ce90: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
-0006cea0: 745b 305d 2d3e 6461 7461 295b 325d 3b0a  t[0]->data)[2];.
-0006ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cec0: 636f 6e73 7420 7369 7a65 5f74 206f 6666  const size_t off
-0006ced0: 7365 7420 203d 2028 2820 696e 7433 325f  set  = (( int32_
-0006cee0: 7420 2a20 2920 7465 6e73 6f72 2d3e 6f70  t * ) tensor->op
-0006cef0: 745b 305d 2d3e 6461 7461 295b 335d 3b0a  t[0]->data)[3];.
-0006cf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006cf10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0006cf20: 736f 7220 2a20 7465 6e73 6f72 5f67 7261  sor * tensor_gra
-0006cf30: 645f 7669 6577 203d 204e 554c 4c3b 0a0a  d_view = NULL;..
-0006cf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cf50: 6966 2028 7372 6330 2d3e 6772 6164 207c  if (src0->grad |
-0006cf60: 7c20 7372 6331 2d3e 6772 6164 2920 7b0a  | src1->grad) {.
-0006cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cf80: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006cf90: 7372 6330 2d3e 7479 7065 203d 3d20 7465  src0->type == te
-0006cfa0: 6e73 6f72 2d3e 7479 7065 293b 0a20 2020  nsor->type);.   
-0006cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cfc0: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
-0006cfd0: 736f 722d 3e67 7261 642d 3e74 7970 6520  sor->grad->type 
-0006cfe0: 3d3d 2074 656e 736f 722d 3e74 7970 6529  == tensor->type)
-0006cff0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006d000: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0006d010: 5428 7465 6e73 6f72 2d3e 6772 6164 2d3e  T(tensor->grad->
-0006d020: 7479 7065 203d 3d20 7372 6331 2d3e 6772  type == src1->gr
-0006d030: 6164 2d3e 7479 7065 293b 0a0a 2020 2020  ad->type);..    
-0006d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d050: 7465 6e73 6f72 5f67 7261 645f 7669 6577  tensor_grad_view
-0006d060: 203d 2067 676d 6c5f 7669 6577 5f34 6428   = ggml_view_4d(
-0006d070: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-0006d080: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-0006d090: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
+0006cce0: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
+0006ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cd00: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
+0006cd10: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0006cd20: 6173 6520 4747 4d4c 5f4f 505f 5345 543a  ase GGML_OP_SET:
+0006cd30: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0006cd40: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0006cd50: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+0006cd60: 6e65 6c65 6d65 6e74 7328 7465 6e73 6f72  nelements(tensor
+0006cd70: 2d3e 6f70 745b 305d 2920 3d3d 2035 293b  ->opt[0]) == 5);
+0006cd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006cd90: 2047 474d 4c5f 4153 5345 5254 2874 656e   GGML_ASSERT(ten
+0006cda0: 736f 722d 3e6f 7074 5b30 5d2d 3e74 7970  sor->opt[0]->typ
+0006cdb0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
+0006cdc0: 3332 293b 0a20 2020 2020 2020 2020 2020  32);.           
+0006cdd0: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0006cde0: 7420 6e62 3120 2020 2020 3d20 2828 2069  t nb1     = (( i
+0006cdf0: 6e74 3332 5f74 202a 2029 2074 656e 736f  nt32_t * ) tenso
+0006ce00: 722d 3e6f 7074 5b30 5d2d 3e64 6174 6129  r->opt[0]->data)
+0006ce10: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
+0006ce20: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0006ce30: 7420 6e62 3220 2020 2020 3d20 2828 2069  t nb2     = (( i
+0006ce40: 6e74 3332 5f74 202a 2029 2074 656e 736f  nt32_t * ) tenso
+0006ce50: 722d 3e6f 7074 5b30 5d2d 3e64 6174 6129  r->opt[0]->data)
+0006ce60: 5b31 5d3b 0a20 2020 2020 2020 2020 2020  [1];.           
+0006ce70: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0006ce80: 7420 6e62 3320 2020 2020 3d20 2828 2069  t nb3     = (( i
+0006ce90: 6e74 3332 5f74 202a 2029 2074 656e 736f  nt32_t * ) tenso
+0006cea0: 722d 3e6f 7074 5b30 5d2d 3e64 6174 6129  r->opt[0]->data)
+0006ceb0: 5b32 5d3b 0a20 2020 2020 2020 2020 2020  [2];.           
+0006cec0: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0006ced0: 7420 6f66 6673 6574 2020 3d20 2828 2069  t offset  = (( i
+0006cee0: 6e74 3332 5f74 202a 2029 2074 656e 736f  nt32_t * ) tenso
+0006cef0: 722d 3e6f 7074 5b30 5d2d 3e64 6174 6129  r->opt[0]->data)
+0006cf00: 5b33 5d3b 0a0a 2020 2020 2020 2020 2020  [3];..          
+0006cf10: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0006cf20: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
+0006cf30: 725f 6772 6164 5f76 6965 7720 3d20 4e55  r_grad_view = NU
+0006cf40: 4c4c 3b0a 0a20 2020 2020 2020 2020 2020  LL;..           
+0006cf50: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+0006cf60: 7261 6420 7c7c 2073 7263 312d 3e67 7261  rad || src1->gra
+0006cf70: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0006cf80: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0006cf90: 5345 5254 2873 7263 302d 3e74 7970 6520  SERT(src0->type 
+0006cfa0: 3d3d 2074 656e 736f 722d 3e74 7970 6529  == tensor->type)
+0006cfb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006cfc0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0006cfd0: 5428 7465 6e73 6f72 2d3e 6772 6164 2d3e  T(tensor->grad->
+0006cfe0: 7479 7065 203d 3d20 7465 6e73 6f72 2d3e  type == tensor->
+0006cff0: 7479 7065 293b 0a20 2020 2020 2020 2020  type);.         
+0006d000: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+0006d010: 4153 5345 5254 2874 656e 736f 722d 3e67  ASSERT(tensor->g
+0006d020: 7261 642d 3e74 7970 6520 3d3d 2073 7263  rad->type == src
+0006d030: 312d 3e67 7261 642d 3e74 7970 6529 3b0a  1->grad->type);.
+0006d040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d050: 2020 2020 2074 656e 736f 725f 6772 6164       tensor_grad
+0006d060: 5f76 6965 7720 3d20 6767 6d6c 5f76 6965  _view = ggml_vie
+0006d070: 775f 3464 2863 7478 2c0a 2020 2020 2020  w_4d(ctx,.      
+0006d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d090: 2020 7465 6e73 6f72 2d3e 6772 6164 2c0a    tensor->grad,.
 0006d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d0b0: 2020 2073 7263 312d 3e67 7261 642d 3e6e     src1->grad->n
-0006d0c0: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
-0006d0d0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0006d0e0: 6331 2d3e 6772 6164 2d3e 6e65 5b31 5d2c  c1->grad->ne[1],
-0006d0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d100: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
-0006d110: 7261 642d 3e6e 655b 325d 2c0a 2020 2020  rad->ne[2],.    
-0006d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d130: 2020 2020 7372 6331 2d3e 6772 6164 2d3e      src1->grad->
-0006d140: 6e65 5b33 5d2c 0a20 2020 2020 2020 2020  ne[3],.         
-0006d150: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0006d160: 6231 2c20 6e62 322c 206e 6233 2c20 6f66  b1, nb2, nb3, of
-0006d170: 6673 6574 293b 0a20 2020 2020 2020 2020  fset);.         
-0006d180: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0006d190: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0006d1a0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-0006d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d1c0: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
-0006d1d0: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-0006d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d1f0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-0006d200: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-0006d210: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006d220: 5f61 6363 5f69 6d70 6c28 6374 782c 0a20  _acc_impl(ctx,. 
-0006d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d240: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0006d250: 722d 3e67 7261 642c 0a20 2020 2020 2020  r->grad,.       
+0006d0b0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+0006d0c0: 6164 2d3e 6e65 5b30 5d2c 0a20 2020 2020  ad->ne[0],.     
+0006d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d0e0: 2020 2073 7263 312d 3e67 7261 642d 3e6e     src1->grad->n
+0006d0f0: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
+0006d100: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0006d110: 6331 2d3e 6772 6164 2d3e 6e65 5b32 5d2c  c1->grad->ne[2],
+0006d120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d130: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
+0006d140: 7261 642d 3e6e 655b 335d 2c0a 2020 2020  rad->ne[3],.    
+0006d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d160: 2020 2020 6e62 312c 206e 6232 2c20 6e62      nb1, nb2, nb
+0006d170: 332c 206f 6666 7365 7429 3b0a 2020 2020  3, offset);.    
+0006d180: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0006d190: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006d1a0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+0006d1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d1c0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+0006d1d0: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
+0006d1e0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006d1f0: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0006d200: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
+0006d210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d220: 2067 676d 6c5f 6163 635f 696d 706c 2863   ggml_acc_impl(c
+0006d230: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0006d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d250: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
 0006d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d270: 2020 2020 2067 676d 6c5f 6e65 6728 6374       ggml_neg(ct
-0006d280: 782c 2074 656e 736f 725f 6772 6164 5f76  x, tensor_grad_v
-0006d290: 6965 7729 2c0a 2020 2020 2020 2020 2020  iew),.          
+0006d270: 2020 2020 2020 2020 2020 6767 6d6c 5f6e            ggml_n
+0006d280: 6567 2863 7478 2c20 7465 6e73 6f72 5f67  eg(ctx, tensor_g
+0006d290: 7261 645f 7669 6577 292c 0a20 2020 2020  rad_view),.     
 0006d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d2b0: 2020 6e62 312c 206e 6232 2c20 6e62 332c    nb1, nb2, nb3,
-0006d2c0: 206f 6666 7365 742c 2066 616c 7365 292c   offset, false),
-0006d2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d2e0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-0006d2f0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0006d300: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0006d310: 2020 2020 2020 6966 2028 7372 6331 2d3e        if (src1->
-0006d320: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-0006d330: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-0006d340: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+0006d2b0: 2020 2020 2020 206e 6231 2c20 6e62 322c         nb1, nb2,
+0006d2c0: 206e 6233 2c20 6f66 6673 6574 2c20 6661   nb3, offset, fa
+0006d2d0: 6c73 6529 2c0a 2020 2020 2020 2020 2020  lse),.          
+0006d2e0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0006d2f0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0006d300: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0006d310: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0006d320: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
+0006d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d340: 2073 7263 312d 3e67 7261 6420 3d0a 2020   src1->grad =.  
 0006d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d360: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0006d370: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0006d360: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
+0006d370: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
 0006d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d390: 7372 6331 2d3e 6772 6164 2c0a 2020 2020  src1->grad,.    
-0006d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d3b0: 2020 2020 2020 2020 6767 6d6c 5f72 6573          ggml_res
-0006d3c0: 6861 7065 2863 7478 2c0a 2020 2020 2020  hape(ctx,.      
+0006d390: 2020 2020 2073 7263 312d 3e67 7261 642c       src1->grad,
+0006d3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d3b0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006d3c0: 6c5f 7265 7368 6170 6528 6374 782c 0a20  l_reshape(ctx,. 
 0006d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d3e0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-0006d3f0: 6f6e 7428 6374 782c 2074 656e 736f 725f  ont(ctx, tensor_
-0006d400: 6772 6164 5f76 6965 7729 2c0a 2020 2020  grad_view),.    
-0006d410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d420: 2020 2020 2020 2020 2020 2020 7372 6331              src1
-0006d430: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
+0006d3e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006d3f0: 676d 6c5f 636f 6e74 2863 7478 2c20 7465  gml_cont(ctx, te
+0006d400: 6e73 6f72 5f67 7261 645f 7669 6577 292c  nsor_grad_view),
+0006d410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d430: 2073 7263 312d 3e67 7261 6429 2c0a 2020   src1->grad),.  
 0006d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d450: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0006d460: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0006d470: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0006d480: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0006d490: 7365 2047 474d 4c5f 4f50 5f43 5059 3a0a  se GGML_OP_CPY:.
-0006d4a0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0006d4b0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006d4c0: 206e 6563 6573 7361 7279 2066 6f72 206c   necessary for l
-0006d4d0: 6c61 6d61 0a20 2020 2020 2020 2020 2020  lama.           
-0006d4e0: 2020 2020 202f 2f20 6370 7920 6f76 6572       // cpy over
-0006d4f0: 7772 6974 6573 2076 616c 7565 206f 6620  writes value of 
-0006d500: 7372 6331 2062 7920 7372 6330 2061 6e64  src1 by src0 and
-0006d510: 2072 6574 7572 6e73 2076 6965 7728 7372   returns view(sr
-0006d520: 6331 290a 2020 2020 2020 2020 2020 2020  c1).            
-0006d530: 2020 2020 2f2f 2074 6865 206f 7665 7277      // the overw
-0006d540: 7269 7469 6e67 2069 7320 6d61 7468 656d  riting is mathem
-0006d550: 6174 6963 616c 6c79 2065 7175 6976 616c  atically equival
-0006d560: 656e 7420 746f 3a0a 2020 2020 2020 2020  ent to:.        
-0006d570: 2020 2020 2020 2020 2f2f 2074 656e 736f          // tenso
-0006d580: 7220 3d20 7372 6330 202a 2031 202b 2073  r = src0 * 1 + s
-0006d590: 7263 3120 2a20 300a 2020 2020 2020 2020  rc1 * 0.        
-0006d5a0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-0006d5b0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-0006d5c0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006d5d0: 2064 7372 6330 203d 2064 7465 6e73 6f72   dsrc0 = dtensor
-0006d5e0: 202a 2031 0a20 2020 2020 2020 2020 2020   * 1.           
-0006d5f0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0006d600: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
-0006d610: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-0006d620: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
-0006d630: 642c 2069 6e70 6c61 6365 293b 0a20 2020  d, inplace);.   
-0006d640: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0006d650: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006d660: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
-0006d670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d680: 2020 2020 202f 2f20 6473 7263 3120 3d20       // dsrc1 = 
-0006d690: 6474 656e 736f 7220 2a20 3020 2d3e 206e  dtensor * 0 -> n
-0006d6a0: 6f6f 700a 2020 2020 2020 2020 2020 2020  oop.            
-0006d6b0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0006d6c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0006d6d0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0006d6e0: 434f 4e54 3a0a 2020 2020 2020 2020 2020  CONT:.          
-0006d6f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006d700: 2020 2020 2f2f 2073 616d 6520 6173 2063      // same as c
-0006d710: 7079 0a20 2020 2020 2020 2020 2020 2020  py.             
-0006d720: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-0006d730: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0006d740: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0006d750: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
-0006d760: 7469 6775 6f75 7328 7372 6330 2d3e 6772  tiguous(src0->gr
-0006d770: 6164 2929 3b0a 2020 2020 2020 2020 2020  ad));.          
-0006d780: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0006d790: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
-0006d7a0: 6e74 6967 756f 7573 2874 656e 736f 722d  ntiguous(tensor-
-0006d7b0: 3e67 7261 6429 293b 0a20 2020 2020 2020  >grad));.       
-0006d7c0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0006d7d0: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
-0006d7e0: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
-0006d7f0: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
-0006d800: 3e67 7261 642c 2069 6e70 6c61 6365 293b  >grad, inplace);
-0006d810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d820: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0006d830: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0006d840: 6361 7365 2047 474d 4c5f 4f50 5f52 4553  case GGML_OP_RES
-0006d850: 4841 5045 3a0a 2020 2020 2020 2020 2020  HAPE:.          
-0006d860: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006d870: 2020 2020 2f2f 206e 6563 6573 7361 7279      // necessary
-0006d880: 2066 6f72 206c 6c61 6d61 0a20 2020 2020   for llama.     
-0006d890: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0006d8a0: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0006d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d8c0: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
-0006d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d8e0: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
-0006d8f0: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-0006d900: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0006d450: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
+0006d460: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0006d470: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0006d480: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0006d490: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0006d4a0: 4350 593a 0a20 2020 2020 2020 2020 2020  CPY:.           
+0006d4b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006d4c0: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
+0006d4d0: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
+0006d4e0: 2020 2020 2020 2020 2020 2f2f 2063 7079            // cpy
+0006d4f0: 206f 7665 7277 7269 7465 7320 7661 6c75   overwrites valu
+0006d500: 6520 6f66 2073 7263 3120 6279 2073 7263  e of src1 by src
+0006d510: 3020 616e 6420 7265 7475 726e 7320 7669  0 and returns vi
+0006d520: 6577 2873 7263 3129 0a20 2020 2020 2020  ew(src1).       
+0006d530: 2020 2020 2020 2020 202f 2f20 7468 6520           // the 
+0006d540: 6f76 6572 7772 6974 696e 6720 6973 206d  overwriting is m
+0006d550: 6174 6865 6d61 7469 6361 6c6c 7920 6571  athematically eq
+0006d560: 7569 7661 6c65 6e74 2074 6f3a 0a20 2020  uivalent to:.   
+0006d570: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006d580: 7465 6e73 6f72 203d 2073 7263 3020 2a20  tensor = src0 * 
+0006d590: 3120 2b20 7372 6331 202a 2030 0a20 2020  1 + src1 * 0.   
+0006d5a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0006d5b0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0006d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d5d0: 2020 202f 2f20 6473 7263 3020 3d20 6474     // dsrc0 = dt
+0006d5e0: 656e 736f 7220 2a20 310a 2020 2020 2020  ensor * 1.      
+0006d5f0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0006d600: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
+0006d610: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
+0006d620: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
+0006d630: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
+0006d640: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006d650: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006d660: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
+0006d670: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+0006d680: 2020 2020 2020 2020 2020 2f2f 2064 7372            // dsr
+0006d690: 6331 203d 2064 7465 6e73 6f72 202a 2030  c1 = dtensor * 0
+0006d6a0: 202d 3e20 6e6f 6f70 0a20 2020 2020 2020   -> noop.       
+0006d6b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006d6c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0006d6d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0006d6e0: 4c5f 4f50 5f43 4f4e 543a 0a20 2020 2020  L_OP_CONT:.     
+0006d6f0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006d700: 2020 2020 2020 2020 202f 2f20 7361 6d65           // same
+0006d710: 2061 7320 6370 790a 2020 2020 2020 2020   as cpy.        
+0006d720: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0006d730: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+0006d740: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0006d750: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+0006d760: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
+0006d770: 302d 3e67 7261 6429 293b 0a20 2020 2020  0->grad));.     
+0006d780: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0006d790: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+0006d7a0: 6973 5f63 6f6e 7469 6775 6f75 7328 7465  is_contiguous(te
+0006d7b0: 6e73 6f72 2d3e 6772 6164 2929 3b0a 2020  nsor->grad));.  
+0006d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d7d0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+0006d7e0: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+0006d7f0: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
+0006d800: 6e73 6f72 2d3e 6772 6164 2c20 696e 706c  nsor->grad, inpl
+0006d810: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0006d820: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0006d830: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0006d840: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0006d850: 505f 5245 5348 4150 453a 0a20 2020 2020  P_RESHAPE:.     
+0006d860: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006d870: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
+0006d880: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
+0006d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d8a0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0006d8b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006d8c0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0006d8d0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
+0006d8e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006d8f0: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
+0006d900: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
 0006d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d920: 2067 676d 6c5f 7265 7368 6170 6528 6374   ggml_reshape(ct
-0006d930: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
-0006d940: 2073 7263 302d 3e67 7261 6429 2c0a 2020   src0->grad),.  
-0006d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d960: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-0006d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d980: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-0006d990: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0006d9a0: 6173 6520 4747 4d4c 5f4f 505f 5649 4557  ase GGML_OP_VIEW
-0006d9b0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0006d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d9d0: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
-0006d9e0: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
-0006d9f0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-0006da00: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0006da10: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-0006da20: 655f 7420 6f66 6673 6574 3b0a 2020 2020  e_t offset;.    
-0006da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006da40: 6d65 6d63 7079 2826 6f66 6673 6574 2c20  memcpy(&offset, 
-0006da50: 7465 6e73 6f72 2d3e 7061 6464 696e 672c  tensor->padding,
-0006da60: 2073 697a 656f 6628 6f66 6673 6574 2929   sizeof(offset))
-0006da70: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0006da80: 2020 2020 2020 2073 697a 655f 7420 6e62         size_t nb
-0006da90: 3120 2020 2020 3d20 7465 6e73 6f72 2d3e  1     = tensor->
-0006daa0: 6e62 5b31 5d3b 0a20 2020 2020 2020 2020  nb[1];.         
-0006dab0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-0006dac0: 7420 6e62 3220 2020 2020 3d20 7465 6e73  t nb2     = tens
-0006dad0: 6f72 2d3e 6e62 5b32 5d3b 0a20 2020 2020  or->nb[2];.     
-0006dae0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006daf0: 697a 655f 7420 6e62 3320 2020 2020 3d20  ize_t nb3     = 
-0006db00: 7465 6e73 6f72 2d3e 6e62 5b33 5d3b 0a0a  tensor->nb[3];..
-0006db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006db20: 2020 2020 6966 2028 7372 6330 2d3e 7479      if (src0->ty
-0006db30: 7065 2021 3d20 7372 6330 2d3e 6772 6164  pe != src0->grad
-0006db40: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+0006d920: 2020 2020 2020 6767 6d6c 5f72 6573 6861        ggml_resha
+0006d930: 7065 2863 7478 2c20 7465 6e73 6f72 2d3e  pe(ctx, tensor->
+0006d940: 6772 6164 2c20 7372 6330 2d3e 6772 6164  grad, src0->grad
+0006d950: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0006d960: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+0006d970: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0006d980: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0006d990: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0006d9a0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0006d9b0: 5f56 4945 573a 0a20 2020 2020 2020 2020  _VIEW:.         
+0006d9c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0006d9d0: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
+0006d9e0: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
+0006d9f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0006da00: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+0006da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006da20: 2020 7369 7a65 5f74 206f 6666 7365 743b    size_t offset;
+0006da30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006da40: 2020 2020 206d 656d 6370 7928 266f 6666       memcpy(&off
+0006da50: 7365 742c 2074 656e 736f 722d 3e70 6164  set, tensor->pad
+0006da60: 6469 6e67 2c20 7369 7a65 6f66 286f 6666  ding, sizeof(off
+0006da70: 7365 7429 293b 0a0a 2020 2020 2020 2020  set));..        
+0006da80: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+0006da90: 5f74 206e 6231 2020 2020 203d 2074 656e  _t nb1     = ten
+0006daa0: 736f 722d 3e6e 625b 315d 3b0a 2020 2020  sor->nb[1];.    
+0006dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dac0: 7369 7a65 5f74 206e 6232 2020 2020 203d  size_t nb2     =
+0006dad0: 2074 656e 736f 722d 3e6e 625b 325d 3b0a   tensor->nb[2];.
+0006dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006daf0: 2020 2020 7369 7a65 5f74 206e 6233 2020      size_t nb3  
+0006db00: 2020 203d 2074 656e 736f 722d 3e6e 625b     = tensor->nb[
+0006db10: 335d 3b0a 0a20 2020 2020 2020 2020 2020  3];..           
+0006db20: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0006db30: 302d 3e74 7970 6520 213d 2073 7263 302d  0->type != src0-
+0006db40: 3e67 7261 642d 3e74 7970 6529 207b 0a20  >grad->type) {. 
 0006db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006db60: 2020 2f2f 2067 7261 6469 656e 7420 6973    // gradient is
-0006db70: 2074 7970 6963 616c 6c79 2046 3332 2c20   typically F32, 
-0006db80: 6275 7420 7372 6330 2063 6f75 6c64 2062  but src0 could b
-0006db90: 6520 6f74 6865 7220 7479 7065 0a20 2020  e other type.   
-0006dba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dbb0: 2020 2020 2073 697a 655f 7420 6e67 203d       size_t ng =
-0006dbc0: 2067 676d 6c5f 656c 656d 656e 745f 7369   ggml_element_si
-0006dbd0: 7a65 2873 7263 302d 3e67 7261 6429 3b0a  ze(src0->grad);.
-0006dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dbf0: 2020 2020 2020 2020 7369 7a65 5f74 206e          size_t n
-0006dc00: 3020 3d20 6767 6d6c 5f65 6c65 6d65 6e74  0 = ggml_element
-0006dc10: 5f73 697a 6528 7372 6330 293b 0a20 2020  _size(src0);.   
-0006dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dc30: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0006dc40: 286f 6666 7365 7420 2520 6e30 203d 3d20  (offset % n0 == 
-0006dc50: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-0006dc60: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0006dc70: 5f41 5353 4552 5428 6e62 3120 2520 6e30  _ASSERT(nb1 % n0
-0006dc80: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
+0006db60: 2020 2020 2020 202f 2f20 6772 6164 6965         // gradie
+0006db70: 6e74 2069 7320 7479 7069 6361 6c6c 7920  nt is typically 
+0006db80: 4633 322c 2062 7574 2073 7263 3020 636f  F32, but src0 co
+0006db90: 756c 6420 6265 206f 7468 6572 2074 7970  uld be other typ
+0006dba0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0006dbb0: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
+0006dbc0: 206e 6720 3d20 6767 6d6c 5f65 6c65 6d65   ng = ggml_eleme
+0006dbd0: 6e74 5f73 697a 6528 7372 6330 2d3e 6772  nt_size(src0->gr
+0006dbe0: 6164 293b 0a20 2020 2020 2020 2020 2020  ad);.           
+0006dbf0: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+0006dc00: 655f 7420 6e30 203d 2067 676d 6c5f 656c  e_t n0 = ggml_el
+0006dc10: 656d 656e 745f 7369 7a65 2873 7263 3029  ement_size(src0)
+0006dc20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006dc30: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0006dc40: 5353 4552 5428 6f66 6673 6574 2025 206e  SSERT(offset % n
+0006dc50: 3020 3d3d 2030 293b 0a20 2020 2020 2020  0 == 0);.       
+0006dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dc70: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
+0006dc80: 2025 206e 3020 3d3d 2030 293b 0a20 2020   % n0 == 0);.   
 0006dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dca0: 4747 4d4c 5f41 5353 4552 5428 6e62 3220  GGML_ASSERT(nb2 
-0006dcb0: 2520 6e30 203d 3d20 3029 3b0a 2020 2020  % n0 == 0);.    
-0006dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dcd0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006dce0: 6e62 3320 2520 6e30 203d 3d20 3029 3b0a  nb3 % n0 == 0);.
-0006dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dd00: 2020 2020 2020 2020 6f66 6673 6574 203d          offset =
-0006dd10: 2028 6f66 6673 6574 202f 206e 3029 202a   (offset / n0) *
-0006dd20: 206e 673b 0a20 2020 2020 2020 2020 2020   ng;.           
-0006dd30: 2020 2020 2020 2020 2020 2020 206e 6231               nb1
-0006dd40: 203d 2028 6e62 3120 2f20 6e30 2920 2a20   = (nb1 / n0) * 
-0006dd50: 6e67 3b0a 2020 2020 2020 2020 2020 2020  ng;.            
-0006dd60: 2020 2020 2020 2020 2020 2020 6e62 3220              nb2 
-0006dd70: 3d20 286e 6232 202f 206e 3029 202a 206e  = (nb2 / n0) * n
-0006dd80: 673b 0a20 2020 2020 2020 2020 2020 2020  g;.             
-0006dd90: 2020 2020 2020 2020 2020 206e 6233 203d             nb3 =
-0006dda0: 2028 6e62 3320 2f20 6e30 2920 2a20 6e67   (nb3 / n0) * ng
-0006ddb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006ddc0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0006ddd0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0006dde0: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
-0006ddf0: 6363 5f69 6d70 6c28 6374 782c 2073 7263  cc_impl(ctx, src
-0006de00: 302d 3e67 7261 642c 2074 656e 736f 722d  0->grad, tensor-
-0006de10: 3e67 7261 642c 206e 6231 2c20 6e62 322c  >grad, nb1, nb2,
-0006de20: 206e 6233 2c20 6f66 6673 6574 2c20 696e   nb3, offset, in
-0006de30: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-0006de40: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0006de50: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0006de60: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0006de70: 5f4f 505f 5045 524d 5554 453a 0a20 2020  _OP_PERMUTE:.   
-0006de80: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0006de90: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
-0006dea0: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
-0006deb0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-0006dec0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-0006ded0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0006dee0: 2020 2020 2020 2020 696e 7420 6178 6973          int axis
-0006def0: 3020 3d20 7465 6e73 6f72 2d3e 7061 6464  0 = tensor->padd
-0006df00: 696e 675b 305d 2026 2030 7833 3b0a 2020  ing[0] & 0x3;.  
-0006df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006df20: 2020 696e 7420 6178 6973 3120 3d20 7465    int axis1 = te
-0006df30: 6e73 6f72 2d3e 7061 6464 696e 675b 315d  nsor->padding[1]
-0006df40: 2026 2030 7833 3b0a 2020 2020 2020 2020   & 0x3;.        
-0006df50: 2020 2020 2020 2020 2020 2020 696e 7420              int 
-0006df60: 6178 6973 3220 3d20 7465 6e73 6f72 2d3e  axis2 = tensor->
-0006df70: 7061 6464 696e 675b 325d 2026 2030 7833  padding[2] & 0x3
-0006df80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006df90: 2020 2020 2020 696e 7420 6178 6973 3320        int axis3 
-0006dfa0: 3d20 7465 6e73 6f72 2d3e 7061 6464 696e  = tensor->paddin
-0006dfb0: 675b 335d 2026 2030 7833 3b0a 2020 2020  g[3] & 0x3;.    
-0006dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006dfd0: 696e 7420 6178 6573 5f62 6163 6b77 6172  int axes_backwar
-0006dfe0: 645b 345d 203d 207b 302c 302c 302c 307d  d[4] = {0,0,0,0}
-0006dff0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006e000: 2020 2020 2020 6178 6573 5f62 6163 6b77        axes_backw
-0006e010: 6172 645b 6178 6973 305d 203d 2030 3b0a  ard[axis0] = 0;.
-0006e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e030: 2020 2020 6178 6573 5f62 6163 6b77 6172      axes_backwar
-0006e040: 645b 6178 6973 315d 203d 2031 3b0a 2020  d[axis1] = 1;.  
-0006e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e060: 2020 6178 6573 5f62 6163 6b77 6172 645b    axes_backward[
-0006e070: 6178 6973 325d 203d 2032 3b0a 2020 2020  axis2] = 2;.    
-0006e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e090: 6178 6573 5f62 6163 6b77 6172 645b 6178  axes_backward[ax
-0006e0a0: 6973 335d 203d 2033 3b0a 2020 2020 2020  is3] = 3;.      
-0006e0b0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0006e0c0: 6330 2d3e 6772 6164 203d 0a20 2020 2020  c0->grad =.     
+0006dca0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0006dcb0: 286e 6232 2025 206e 3020 3d3d 2030 293b  (nb2 % n0 == 0);
+0006dcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006dcd0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0006dce0: 5345 5254 286e 6233 2025 206e 3020 3d3d  SERT(nb3 % n0 ==
+0006dcf0: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
+0006dd00: 2020 2020 2020 2020 2020 2020 206f 6666               off
+0006dd10: 7365 7420 3d20 286f 6666 7365 7420 2f20  set = (offset / 
+0006dd20: 6e30 2920 2a20 6e67 3b0a 2020 2020 2020  n0) * ng;.      
+0006dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dd40: 2020 6e62 3120 3d20 286e 6231 202f 206e    nb1 = (nb1 / n
+0006dd50: 3029 202a 206e 673b 0a20 2020 2020 2020  0) * ng;.       
+0006dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dd70: 206e 6232 203d 2028 6e62 3220 2f20 6e30   nb2 = (nb2 / n0
+0006dd80: 2920 2a20 6e67 3b0a 2020 2020 2020 2020  ) * ng;.        
+0006dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dda0: 6e62 3320 3d20 286e 6233 202f 206e 3029  nb3 = (nb3 / n0)
+0006ddb0: 202a 206e 673b 0a20 2020 2020 2020 2020   * ng;.         
+0006ddc0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+0006ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dde0: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
+0006ddf0: 676d 6c5f 6163 635f 696d 706c 2863 7478  gml_acc_impl(ctx
+0006de00: 2c20 7372 6330 2d3e 6772 6164 2c20 7465  , src0->grad, te
+0006de10: 6e73 6f72 2d3e 6772 6164 2c20 6e62 312c  nsor->grad, nb1,
+0006de20: 206e 6232 2c20 6e62 332c 206f 6666 7365   nb2, nb3, offse
+0006de30: 742c 2069 6e70 6c61 6365 293b 0a20 2020  t, inplace);.   
+0006de40: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0006de50: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0006de60: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0006de70: 2047 474d 4c5f 4f50 5f50 4552 4d55 5445   GGML_OP_PERMUTE
+0006de80: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0006de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dea0: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
+0006deb0: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
+0006dec0: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
+0006ded0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0006dee0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0006def0: 2061 7869 7330 203d 2074 656e 736f 722d   axis0 = tensor-
+0006df00: 3e70 6164 6469 6e67 5b30 5d20 2620 3078  >padding[0] & 0x
+0006df10: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
+0006df20: 2020 2020 2020 2069 6e74 2061 7869 7331         int axis1
+0006df30: 203d 2074 656e 736f 722d 3e70 6164 6469   = tensor->paddi
+0006df40: 6e67 5b31 5d20 2620 3078 333b 0a20 2020  ng[1] & 0x3;.   
+0006df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006df60: 2069 6e74 2061 7869 7332 203d 2074 656e   int axis2 = ten
+0006df70: 736f 722d 3e70 6164 6469 6e67 5b32 5d20  sor->padding[2] 
+0006df80: 2620 3078 333b 0a20 2020 2020 2020 2020  & 0x3;.         
+0006df90: 2020 2020 2020 2020 2020 2069 6e74 2061             int a
+0006dfa0: 7869 7333 203d 2074 656e 736f 722d 3e70  xis3 = tensor->p
+0006dfb0: 6164 6469 6e67 5b33 5d20 2620 3078 333b  adding[3] & 0x3;
+0006dfc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006dfd0: 2020 2020 2069 6e74 2061 7865 735f 6261       int axes_ba
+0006dfe0: 636b 7761 7264 5b34 5d20 3d20 7b30 2c30  ckward[4] = {0,0
+0006dff0: 2c30 2c30 7d3b 0a20 2020 2020 2020 2020  ,0,0};.         
+0006e000: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
+0006e010: 6261 636b 7761 7264 5b61 7869 7330 5d20  backward[axis0] 
+0006e020: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
+0006e030: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
+0006e040: 636b 7761 7264 5b61 7869 7331 5d20 3d20  ckward[axis1] = 
+0006e050: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+0006e060: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
+0006e070: 7761 7264 5b61 7869 7332 5d20 3d20 323b  ward[axis2] = 2;
+0006e080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e090: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
+0006e0a0: 7264 5b61 7869 7333 5d20 3d20 333b 0a20  rd[axis3] = 3;. 
+0006e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e0c0: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
 0006e0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e0e0: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
-0006e0f0: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
-0006e100: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006e110: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006e120: 6d6c 5f70 6572 6d75 7465 2863 7478 2c0a  ml_permute(ctx,.
-0006e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e0e0: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0006e0f0: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+0006e100: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0006e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e120: 2020 2067 676d 6c5f 7065 726d 7574 6528     ggml_permute(
+0006e130: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
 0006e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e150: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
-0006e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e170: 2020 2020 2020 2020 2020 2020 2020 6178                ax
-0006e180: 6573 5f62 6163 6b77 6172 645b 305d 2c0a  es_backward[0],.
-0006e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e150: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+0006e160: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0006e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e180: 2020 2061 7865 735f 6261 636b 7761 7264     axes_backward
+0006e190: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
 0006e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e1b0: 6178 6573 5f62 6163 6b77 6172 645b 315d  axes_backward[1]
-0006e1c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006e1b0: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
+0006e1c0: 7264 5b31 5d2c 0a20 2020 2020 2020 2020  rd[1],.         
 0006e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e1e0: 2020 6178 6573 5f62 6163 6b77 6172 645b    axes_backward[
-0006e1f0: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
+0006e1e0: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
+0006e1f0: 7761 7264 5b32 5d2c 0a20 2020 2020 2020  ward[2],.       
 0006e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e210: 2020 2020 6178 6573 5f62 6163 6b77 6172      axes_backwar
-0006e220: 645b 335d 292c 0a20 2020 2020 2020 2020  d[3]),.         
+0006e210: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
+0006e220: 636b 7761 7264 5b33 5d29 2c0a 2020 2020  ckward[3]),.    
 0006e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e240: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-0006e250: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0006e260: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0006e270: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0006e280: 2047 474d 4c5f 4f50 5f54 5241 4e53 504f   GGML_OP_TRANSPO
-0006e290: 5345 3a0a 2020 2020 2020 2020 2020 2020  SE:.            
-0006e2a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0006e2b0: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
-0006e2c0: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
-0006e2d0: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0006e2e0: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0006e2f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0006e300: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
-0006e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e320: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
-0006e330: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
-0006e340: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0006e350: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0006e360: 676d 6c5f 7472 616e 7370 6f73 6528 6374  gml_transpose(ct
-0006e370: 782c 2074 656e 736f 722d 3e67 7261 6429  x, tensor->grad)
-0006e380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006e390: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-0006e3a0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0006e3b0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0006e3c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0006e3d0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0006e3e0: 4745 545f 524f 5753 3a0a 2020 2020 2020  GET_ROWS:.      
-0006e3f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0006e400: 2020 2020 2020 2020 2f2f 206e 6563 6573          // neces
-0006e410: 7361 7279 2066 6f72 206c 6c61 6d61 2028  sary for llama (
-0006e420: 6f6e 6c79 2066 6f72 2074 6f6b 656e 697a  only for tokeniz
-0006e430: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-0006e440: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0006e450: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0006e460: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0006e470: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-0006e480: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0006e490: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-0006e4a0: 2c20 7372 6330 2d3e 6772 6164 2c0a 2020  , src0->grad,.  
-0006e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e4c0: 2020 2020 2020 2020 2020 6767 6d6c 5f67            ggml_g
-0006e4d0: 6574 5f72 6f77 735f 6261 636b 2863 7478  et_rows_back(ctx
-0006e4e0: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
-0006e4f0: 7372 6331 2c20 7372 6330 2d3e 6772 6164  src1, src0->grad
-0006e500: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0006e510: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0006e520: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0006e530: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006e540: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-0006e550: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0006e560: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006e570: 6e6f 6f70 0a20 2020 2020 2020 2020 2020  noop.           
-0006e580: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006e590: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0006e5a0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0006e5b0: 5f47 4554 5f52 4f57 535f 4241 434b 3a0a  _GET_ROWS_BACK:.
-0006e5c0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0006e5d0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0006e5e0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-0006e5f0: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
-0006e600: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
-0006e610: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0006e620: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0006e630: 4c5f 4f50 5f44 4941 473a 0a20 2020 2020  L_OP_DIAG:.     
-0006e640: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0006e650: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0006e660: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
-0006e670: 544f 444f 3a20 6e6f 7420 696d 706c 656d  TODO: not implem
-0006e680: 656e 7465 640a 2020 2020 2020 2020 2020  ented.          
-0006e690: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0006e6a0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0006e6b0: 4449 4147 5f4d 4153 4b5f 494e 463a 0a20  DIAG_MASK_INF:. 
-0006e6c0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0006e6d0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006e6e0: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
-0006e6f0: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
-0006e700: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0006e710: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0006e720: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0006e730: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-0006e740: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
-0006e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e760: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
-0006e770: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
-0006e780: 3d20 3229 3b0a 2020 2020 2020 2020 2020  = 2);.          
-0006e790: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006e7a0: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
-0006e7b0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-0006e7c0: 6461 7461 295b 305d 3b0a 2020 2020 2020  data)[0];.      
-0006e7d0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0006e7e0: 6330 2d3e 6772 6164 203d 0a20 2020 2020  c0->grad =.     
+0006e240: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0006e250: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006e260: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006e270: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0006e280: 2063 6173 6520 4747 4d4c 5f4f 505f 5452   case GGML_OP_TR
+0006e290: 414e 5350 4f53 453a 0a20 2020 2020 2020  ANSPOSE:.       
+0006e2a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0006e2b0: 2020 2020 2020 202f 2f20 6e65 6365 7373         // necess
+0006e2c0: 6172 7920 666f 7220 6c6c 616d 610a 2020  ary for llama.  
+0006e2d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006e2e0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
+0006e2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e300: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+0006e310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e320: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+0006e330: 645f 696d 706c 2863 7478 2c20 7372 6330  d_impl(ctx, src0
+0006e340: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0006e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e360: 2020 2020 6767 6d6c 5f74 7261 6e73 706f      ggml_transpo
+0006e370: 7365 2863 7478 2c20 7465 6e73 6f72 2d3e  se(ctx, tensor->
+0006e380: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+0006e390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0006e3a0: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0006e3b0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006e3c0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0006e3d0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0006e3e0: 4c5f 4f50 5f47 4554 5f52 4f57 533a 0a20  L_OP_GET_ROWS:. 
+0006e3f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0006e400: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006e410: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
+0006e420: 616d 6120 286f 6e6c 7920 666f 7220 746f  ama (only for to
+0006e430: 6b65 6e69 7a65 7229 0a20 2020 2020 2020  kenizer).       
+0006e440: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0006e450: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0006e460: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006e470: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0006e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e490: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0006e4a0: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+0006e4b0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0006e4c0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006e4d0: 676d 6c5f 6765 745f 726f 7773 5f62 6163  gml_get_rows_bac
+0006e4e0: 6b28 6374 782c 2074 656e 736f 722d 3e67  k(ctx, tensor->g
+0006e4f0: 7261 642c 2073 7263 312c 2073 7263 302d  rad, src1, src0-
+0006e500: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+0006e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e520: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+0006e530: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0006e540: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0006e550: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
+0006e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e570: 2020 2f2f 206e 6f6f 700a 2020 2020 2020    // noop.      
+0006e580: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0006e590: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0006e5a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0006e5b0: 4d4c 5f4f 505f 4745 545f 524f 5753 5f42  ML_OP_GET_ROWS_B
+0006e5c0: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
+0006e5d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006e5e0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+0006e5f0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+0006e600: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+0006e610: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0006e620: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0006e630: 6520 4747 4d4c 5f4f 505f 4449 4147 3a0a  e GGML_OP_DIAG:.
+0006e640: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0006e650: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0006e660: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+0006e670: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
+0006e680: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+0006e690: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0006e6a0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0006e6b0: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f49  L_OP_DIAG_MASK_I
+0006e6c0: 4e46 3a0a 2020 2020 2020 2020 2020 2020  NF:.            
+0006e6d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006e6e0: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
+0006e6f0: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
+0006e700: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0006e710: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0006e720: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0006e730: 7373 6572 7428 7372 6331 2d3e 7479 7065  ssert(src1->type
+0006e740: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
+0006e750: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
+0006e760: 2020 2020 2020 2020 6173 7365 7274 2867          assert(g
+0006e770: 676d 6c5f 6e65 6c65 6d65 6e74 7328 7372  gml_nelements(sr
+0006e780: 6331 2920 3d3d 2032 293b 0a20 2020 2020  c1) == 2);.     
+0006e790: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0006e7a0: 6f6e 7374 2069 6e74 206e 5f70 6173 7420  onst int n_past 
+0006e7b0: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+0006e7c0: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
+0006e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e7e0: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
 0006e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e800: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
-0006e810: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
-0006e820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006e830: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006e840: 6d6c 5f64 6961 675f 6d61 736b 5f7a 6572  ml_diag_mask_zer
-0006e850: 6f5f 696d 706c 2863 7478 2c20 7465 6e73  o_impl(ctx, tens
-0006e860: 6f72 2d3e 6772 6164 2c20 6e5f 7061 7374  or->grad, n_past
-0006e870: 2c20 6661 6c73 6529 2c0a 2020 2020 2020  , false),.      
+0006e800: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0006e810: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+0006e820: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0006e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e840: 2020 2067 676d 6c5f 6469 6167 5f6d 6173     ggml_diag_mas
+0006e850: 6b5f 7a65 726f 5f69 6d70 6c28 6374 782c  k_zero_impl(ctx,
+0006e860: 2074 656e 736f 722d 3e67 7261 642c 206e   tensor->grad, n
+0006e870: 5f70 6173 742c 2066 616c 7365 292c 0a20  _past, false),. 
 0006e880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e890: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0006e8a0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0006e8b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006e8c0: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
-0006e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e8e0: 2020 2020 2f2f 206e 6f6f 700a 2020 2020      // noop.    
-0006e8f0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0006e900: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0006e910: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0006e920: 4747 4d4c 5f4f 505f 4449 4147 5f4d 4153  GGML_OP_DIAG_MAS
-0006e930: 4b5f 5a45 524f 3a0a 2020 2020 2020 2020  K_ZERO:.        
-0006e940: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0006e950: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
-0006e960: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
-0006e970: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0006e980: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-0006e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e9a0: 2020 2061 7373 6572 7428 7372 6331 2d3e     assert(src1->
-0006e9b0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0006e9c0: 455f 4933 3229 3b0a 2020 2020 2020 2020  E_I32);.        
-0006e9d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0006e9e0: 7274 2867 676d 6c5f 6e65 6c65 6d65 6e74  rt(ggml_nelement
-0006e9f0: 7328 7372 6331 2920 3d3d 2032 293b 0a20  s(src1) == 2);. 
-0006ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ea10: 2020 2063 6f6e 7374 2069 6e74 206e 5f70     const int n_p
-0006ea20: 6173 7420 3d20 2828 696e 7433 325f 7420  ast = ((int32_t 
-0006ea30: 2a29 2073 7263 312d 3e64 6174 6129 5b30  *) src1->data)[0
-0006ea40: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0006ea50: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0006ea60: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
-0006ea70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006ea80: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
-0006ea90: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+0006e890: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0006e8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e8b0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0006e8c0: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
+0006e8d0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0006e8e0: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
+0006e8f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006e900: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0006e910: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0006e920: 6361 7365 2047 474d 4c5f 4f50 5f44 4941  case GGML_OP_DIA
+0006e930: 475f 4d41 534b 5f5a 4552 4f3a 0a20 2020  G_MASK_ZERO:.   
+0006e940: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0006e950: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+0006e960: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+0006e970: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0006e980: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0006e990: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0006e9a0: 2020 2020 2020 2020 6173 7365 7274 2873          assert(s
+0006e9b0: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+0006e9c0: 4c5f 5459 5045 5f49 3332 293b 0a20 2020  L_TYPE_I32);.   
+0006e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e9e0: 2061 7373 6572 7428 6767 6d6c 5f6e 656c   assert(ggml_nel
+0006e9f0: 656d 656e 7473 2873 7263 3129 203d 3d20  ements(src1) == 
+0006ea00: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
+0006ea10: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0006ea20: 7420 6e5f 7061 7374 203d 2028 2869 6e74  t n_past = ((int
+0006ea30: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
+0006ea40: 7461 295b 305d 3b0a 2020 2020 2020 2020  ta)[0];.        
+0006ea50: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0006ea60: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+0006ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ea80: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+0006ea90: 7478 2c20 7372 6330 2d3e 6772 6164 2c0a  tx, src0->grad,.
 0006eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006eab0: 2020 2020 2020 2067 676d 6c5f 6469 6167         ggml_diag
-0006eac0: 5f6d 6173 6b5f 7a65 726f 5f69 6d70 6c28  _mask_zero_impl(
-0006ead0: 6374 782c 2074 656e 736f 722d 3e67 7261  ctx, tensor->gra
-0006eae0: 642c 206e 5f70 6173 742c 2066 616c 7365  d, n_past, false
-0006eaf0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0006eb00: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0006eb10: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0006eb20: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006eb30: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-0006eb40: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0006eb50: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006eb60: 6e6f 6f70 0a20 2020 2020 2020 2020 2020  noop.           
-0006eb70: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006eb80: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0006eb90: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0006eba0: 5f53 4f46 545f 4d41 583a 0a20 2020 2020  _SOFT_MAX:.     
-0006ebb0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0006ebc0: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
-0006ebd0: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
-0006ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ebf0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-0006ec00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0006ec10: 2020 2020 2020 2f2f 2079 203d 2073 6f66        // y = sof
-0006ec20: 746d 6178 2878 290a 2020 2020 2020 2020  tmax(x).        
-0006ec30: 2020 2020 2020 2020 2020 2020 2f2f 0a20              //. 
-0006ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ec50: 2020 202f 2f20 4a69 6920 3d20 7969 202d     // Jii = yi -
-0006ec60: 2079 692a 7969 0a20 2020 2020 2020 2020   yi*yi.         
-0006ec70: 2020 2020 2020 2020 2020 202f 2f20 4a69             // Ji
-0006ec80: 6a20 3d20 2d79 692a 796a 0a20 2020 2020  j = -yi*yj.     
-0006ec90: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006eca0: 2f20 4a20 3d20 6469 6167 2879 292d 792e  / J = diag(y)-y.
-0006ecb0: 2a79 0a20 2020 2020 2020 2020 2020 2020  *y.             
-0006ecc0: 2020 2020 2020 202f 2f20 6478 203d 204a         // dx = J
-0006ecd0: 202a 2064 790a 2020 2020 2020 2020 2020   * dy.          
-0006ece0: 2020 2020 2020 2020 2020 2f2f 2064 786b            // dxk
-0006ecf0: 203d 2073 756d 284a 6b6a 202a 2064 796b   = sum(Jkj * dyk
-0006ed00: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0006ed10: 2020 2020 2020 2069 6e74 3634 5f74 206e         int64_t n
-0006ed20: 6532 5b34 5d20 3d20 7b0a 2020 2020 2020  e2[4] = {.      
+0006eab0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006eac0: 5f64 6961 675f 6d61 736b 5f7a 6572 6f5f  _diag_mask_zero_
+0006ead0: 696d 706c 2863 7478 2c20 7465 6e73 6f72  impl(ctx, tensor
+0006eae0: 2d3e 6772 6164 2c20 6e5f 7061 7374 2c20  ->grad, n_past, 
+0006eaf0: 6661 6c73 6529 2c0a 2020 2020 2020 2020  false),.        
+0006eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006eb10: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+0006eb20: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0006eb30: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0006eb40: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
+0006eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006eb60: 2020 2f2f 206e 6f6f 700a 2020 2020 2020    // noop.      
+0006eb70: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0006eb80: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0006eb90: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0006eba0: 4d4c 5f4f 505f 534f 4654 5f4d 4158 3a0a  ML_OP_SOFT_MAX:.
+0006ebb0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0006ebc0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006ebd0: 206e 6563 6573 7361 7279 2066 6f72 206c   necessary for l
+0006ebe0: 6c61 6d61 0a20 2020 2020 2020 2020 2020  lama.           
+0006ebf0: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+0006ec00: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0006ec10: 2020 2020 2020 2020 2020 202f 2f20 7920             // y 
+0006ec20: 3d20 736f 6674 6d61 7828 7829 0a20 2020  = softmax(x).   
+0006ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ec40: 202f 2f0a 2020 2020 2020 2020 2020 2020   //.            
+0006ec50: 2020 2020 2020 2020 2f2f 204a 6969 203d          // Jii =
+0006ec60: 2079 6920 2d20 7969 2a79 690a 2020 2020   yi - yi*yi.    
+0006ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ec80: 2f2f 204a 696a 203d 202d 7969 2a79 6a0a  // Jij = -yi*yj.
+0006ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006eca0: 2020 2020 2f2f 204a 203d 2064 6961 6728      // J = diag(
+0006ecb0: 7929 2d79 2e2a 790a 2020 2020 2020 2020  y)-y.*y.        
+0006ecc0: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
+0006ecd0: 7820 3d20 4a20 2a20 6479 0a20 2020 2020  x = J * dy.     
+0006ece0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006ecf0: 2f20 6478 6b20 3d20 7375 6d28 4a6b 6a20  / dxk = sum(Jkj 
+0006ed00: 2a20 6479 6b29 0a0a 2020 2020 2020 2020  * dyk)..        
+0006ed10: 2020 2020 2020 2020 2020 2020 696e 7436              int6
+0006ed20: 345f 7420 6e65 325b 345d 203d 207b 0a20  4_t ne2[4] = {. 
 0006ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ed40: 2020 7465 6e73 6f72 2d3e 6e65 5b30 5d2c    tensor->ne[0],
-0006ed50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ed60: 2020 2020 2020 2020 2031 2c0a 2020 2020           1,.    
-0006ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ed80: 2020 2020 7465 6e73 6f72 2d3e 6e65 5b31      tensor->ne[1
-0006ed90: 5d2a 7465 6e73 6f72 2d3e 6e65 5b32 5d2c  ]*tensor->ne[2],
-0006eda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006edb0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-0006edc0: 3e6e 655b 335d 0a20 2020 2020 2020 2020  >ne[3].         
-0006edd0: 2020 2020 2020 2020 2020 207d 3b0a 2020             };.  
-0006ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006edf0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0006ee00: 6e73 6f72 202a 2074 656e 736f 7232 203d  nsor * tensor2 =
-0006ee10: 2067 676d 6c5f 636f 6e74 2863 7478 2c0a   ggml_cont(ctx,.
-0006ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ee30: 2020 2020 2020 2020 6767 6d6c 5f72 6573          ggml_res
-0006ee40: 6861 7065 5f34 6428 6374 782c 0a20 2020  hape_4d(ctx,.   
-0006ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ee60: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-0006ee70: 6e74 2863 7478 2c20 7465 6e73 6f72 292c  nt(ctx, tensor),
-0006ee80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ee90: 2020 2020 2020 2020 2020 2020 206e 6532               ne2
-0006eea0: 5b30 5d2c 206e 6532 5b31 5d2c 206e 6532  [0], ne2[1], ne2
-0006eeb0: 5b32 5d2c 206e 6532 5b33 5d29 293b 0a0a  [2], ne2[3]));..
-0006eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006eed0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0006eee0: 7465 6e73 6f72 202a 2067 7261 6432 203d  tensor * grad2 =
-0006eef0: 2067 676d 6c5f 636f 6e74 2863 7478 2c0a   ggml_cont(ctx,.
-0006ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ef10: 2020 2020 2020 2020 6767 6d6c 5f72 6573          ggml_res
-0006ef20: 6861 7065 5f34 6428 6374 782c 0a20 2020  hape_4d(ctx,.   
-0006ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ef40: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-0006ef50: 6e74 2863 7478 2c20 7465 6e73 6f72 2d3e  nt(ctx, tensor->
-0006ef60: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+0006ed40: 2020 2020 2020 2074 656e 736f 722d 3e6e         tensor->n
+0006ed50: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+0006ed60: 2020 2020 2020 2020 2020 2020 2020 312c                1,
+0006ed70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006ed80: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+0006ed90: 3e6e 655b 315d 2a74 656e 736f 722d 3e6e  >ne[1]*tensor->n
+0006eda0: 655b 325d 2c0a 2020 2020 2020 2020 2020  e[2],.          
+0006edb0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0006edc0: 6e73 6f72 2d3e 6e65 5b33 5d0a 2020 2020  nsor->ne[3].    
+0006edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ede0: 7d3b 0a20 2020 2020 2020 2020 2020 2020  };.             
+0006edf0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0006ee00: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+0006ee10: 6f72 3220 3d20 6767 6d6c 5f63 6f6e 7428  or2 = ggml_cont(
+0006ee20: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006ee30: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006ee40: 6c5f 7265 7368 6170 655f 3464 2863 7478  l_reshape_4d(ctx
+0006ee50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006ee60: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006ee70: 6d6c 5f63 6f6e 7428 6374 782c 2074 656e  ml_cont(ctx, ten
+0006ee80: 736f 7229 2c0a 2020 2020 2020 2020 2020  sor),.          
+0006ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006eea0: 2020 6e65 325b 305d 2c20 6e65 325b 315d    ne2[0], ne2[1]
+0006eeb0: 2c20 6e65 325b 325d 2c20 6e65 325b 335d  , ne2[2], ne2[3]
+0006eec0: 2929 3b0a 0a20 2020 2020 2020 2020 2020  ));..           
+0006eed0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+0006eee0: 6767 6d6c 5f74 656e 736f 7220 2a20 6772  ggml_tensor * gr
+0006eef0: 6164 3220 3d20 6767 6d6c 5f63 6f6e 7428  ad2 = ggml_cont(
+0006ef00: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006ef10: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006ef20: 6c5f 7265 7368 6170 655f 3464 2863 7478  l_reshape_4d(ctx
+0006ef30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006ef40: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006ef50: 6d6c 5f63 6f6e 7428 6374 782c 2074 656e  ml_cont(ctx, ten
+0006ef60: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
 0006ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ef80: 2020 206e 6532 5b30 5d2c 206e 6532 5b31     ne2[0], ne2[1
-0006ef90: 5d2c 206e 6532 5b32 5d2c 206e 6532 5b33  ], ne2[2], ne2[3
-0006efa0: 5d29 293b 0a0a 2020 2020 2020 2020 2020  ]));..          
-0006efb0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0006efc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
-0006efd0: 656e 736f 7232 5f74 203d 2067 676d 6c5f  ensor2_t = ggml_
-0006efe0: 636f 6e74 2863 7478 2c20 2f2f 205b 312c  cont(ctx, // [1,
-0006eff0: 6e65 302c 6e65 312a 6e65 322c 6e65 335d  ne0,ne1*ne2,ne3]
-0006f000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006f010: 2020 2020 2020 2020 2067 676d 6c5f 7065           ggml_pe
-0006f020: 726d 7574 6528 6374 782c 2020 2020 2020  rmute(ctx,      
+0006ef80: 2020 2020 2020 2020 6e65 325b 305d 2c20          ne2[0], 
+0006ef90: 6e65 325b 315d 2c20 6e65 325b 325d 2c20  ne2[1], ne2[2], 
+0006efa0: 6e65 325b 335d 2929 3b0a 0a20 2020 2020  ne2[3]));..     
+0006efb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006efc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0006efd0: 7220 2a20 7465 6e73 6f72 325f 7420 3d20  r * tensor2_t = 
+0006efe0: 6767 6d6c 5f63 6f6e 7428 6374 782c 202f  ggml_cont(ctx, /
+0006eff0: 2f20 5b31 2c6e 6530 2c6e 6531 2a6e 6532  / [1,ne0,ne1*ne2
+0006f000: 2c6e 6533 5d0a 2020 2020 2020 2020 2020  ,ne3].          
+0006f010: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006f020: 6d6c 5f70 6572 6d75 7465 2863 7478 2c20  ml_permute(ctx, 
 0006f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f040: 2020 2020 202f 2f20 5b31 2c6e 6530 2c6e       // [1,ne0,n
-0006f050: 6531 2a6e 6532 2c6e 6533 5d0a 2020 2020  e1*ne2,ne3].    
-0006f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f070: 2020 2020 2020 2020 7465 6e73 6f72 322c          tensor2,
-0006f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f040: 2020 2020 2020 2020 2020 2f2f 205b 312c            // [1,
+0006f050: 6e65 302c 6e65 312a 6e65 322c 6e65 335d  ne0,ne1*ne2,ne3]
+0006f060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f070: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0006f080: 736f 7232 2c20 2020 2020 2020 2020 2020  sor2,           
 0006f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f0a0: 2f2f 205b 6e65 302c 312c 6e65 312a 6e65  // [ne0,1,ne1*ne
-0006f0b0: 322c 6e65 335d 0a20 2020 2020 2020 2020  2,ne3].         
+0006f0a0: 2020 2020 202f 2f20 5b6e 6530 2c31 2c6e       // [ne0,1,n
+0006f0b0: 6531 2a6e 6532 2c6e 6533 5d0a 2020 2020  e1*ne2,ne3].    
 0006f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f0d0: 2020 2031 2c20 302c 2032 2c20 3329 293b     1, 0, 2, 3));
-0006f0e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0006f0f0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0006f100: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-0006f110: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006f120: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-0006f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f140: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0006f150: 6772 6164 2c20 2020 2020 2020 2020 2020  grad,           
-0006f160: 2020 2020 2020 2020 2f2f 205b 6e65 302c          // [ne0,
-0006f170: 6e65 312c 6e65 322c 6e65 335d 0a20 2020  ne1,ne2,ne3].   
-0006f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f190: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
-0006f1a0: 7368 6170 6528 6374 782c 2020 2020 2020  shape(ctx,      
-0006f1b0: 2020 2020 2020 202f 2f20 5b6e 6530 2c6e         // [ne0,n
-0006f1c0: 6531 2c6e 6532 2c6e 6533 5d0a 2020 2020  e1,ne2,ne3].    
-0006f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f1e0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006f1f0: 5f6d 756c 5f6d 6174 2863 7478 2c20 2020  _mul_mat(ctx,   
-0006f200: 2020 2020 2020 2f2f 205b 6e65 302c 312c        // [ne0,1,
-0006f210: 6e65 312a 6e65 322c 6e65 335d 0a20 2020  ne1*ne2,ne3].   
-0006f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f0d0: 2020 2020 2020 2020 312c 2030 2c20 322c          1, 0, 2,
+0006f0e0: 2033 2929 3b0a 0a20 2020 2020 2020 2020   3));..         
+0006f0f0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0006f100: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+0006f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f120: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+0006f130: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0006f140: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006f150: 7263 302d 3e67 7261 642c 2020 2020 2020  rc0->grad,      
+0006f160: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0006f170: 5b6e 6530 2c6e 6531 2c6e 6532 2c6e 6533  [ne0,ne1,ne2,ne3
+0006f180: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0006f190: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006f1a0: 6d6c 5f72 6573 6861 7065 2863 7478 2c20  ml_reshape(ctx, 
+0006f1b0: 2020 2020 2020 2020 2020 2020 2f2f 205b              // [
+0006f1c0: 6e65 302c 6e65 312c 6e65 322c 6e65 335d  ne0,ne1,ne2,ne3]
+0006f1d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f1f0: 2067 676d 6c5f 6d75 6c5f 6d61 7428 6374   ggml_mul_mat(ct
+0006f200: 782c 2020 2020 2020 2020 202f 2f20 5b6e  x,         // [n
+0006f210: 6530 2c31 2c6e 6531 2a6e 6532 2c6e 6533  e0,1,ne1*ne2,ne3
+0006f220: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
 0006f230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f240: 2067 676d 6c5f 7375 6228 6374 782c 2020   ggml_sub(ctx,  
-0006f250: 2020 2020 2020 202f 2f20 5b6e 6530 2c6e         // [ne0,n
-0006f260: 6530 2c6e 6531 2a6e 6532 2c6e 6533 5d0a  e0,ne1*ne2,ne3].
-0006f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f240: 2020 2020 2020 6767 6d6c 5f73 7562 2863        ggml_sub(c
+0006f250: 7478 2c20 2020 2020 2020 2020 2f2f 205b  tx,         // [
+0006f260: 6e65 302c 6e65 302c 6e65 312a 6e65 322c  ne0,ne0,ne1*ne2,
+0006f270: 6e65 335d 0a20 2020 2020 2020 2020 2020  ne3].           
 0006f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f290: 2020 2020 2020 2020 6767 6d6c 5f64 6961          ggml_dia
-0006f2a0: 6728 6374 782c 2020 2020 2f2f 205b 6e65  g(ctx,    // [ne
-0006f2b0: 302c 6e65 302c 6e65 312a 6e65 322c 6e65  0,ne0,ne1*ne2,ne
-0006f2c0: 335d 0a20 2020 2020 2020 2020 2020 2020  3].             
+0006f290: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006f2a0: 6c5f 6469 6167 2863 7478 2c20 2020 202f  l_diag(ctx,    /
+0006f2b0: 2f20 5b6e 6530 2c6e 6530 2c6e 6531 2a6e  / [ne0,ne0,ne1*n
+0006f2c0: 6532 2c6e 6533 5d0a 2020 2020 2020 2020  e2,ne3].        
 0006f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f2e0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0006f2f0: 656e 736f 7232 292c 2020 2020 202f 2f20  ensor2),     // 
-0006f300: 5b6e 6530 2c31 2c6e 6531 2a6e 6532 2c6e  [ne0,1,ne1*ne2,n
-0006f310: 6533 5d0a 2020 2020 2020 2020 2020 2020  e3].            
+0006f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f2f0: 2020 2020 7465 6e73 6f72 3229 2c20 2020      tensor2),   
+0006f300: 2020 2f2f 205b 6e65 302c 312c 6e65 312a    // [ne0,1,ne1*
+0006f310: 6e65 322c 6e65 335d 0a20 2020 2020 2020  ne2,ne3].       
 0006f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f330: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006f340: 5f6d 756c 5f6d 6174 2863 7478 2c20 2f2f  _mul_mat(ctx, //
-0006f350: 205b 6e65 302c 6e65 302c 6e65 312a 6e65   [ne0,ne0,ne1*ne
-0006f360: 322c 6e65 335d 0a20 2020 2020 2020 2020  2,ne3].         
+0006f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f340: 2067 676d 6c5f 6d75 6c5f 6d61 7428 6374   ggml_mul_mat(ct
+0006f350: 782c 202f 2f20 5b6e 6530 2c6e 6530 2c6e  x, // [ne0,ne0,n
+0006f360: 6531 2a6e 6532 2c6e 6533 5d0a 2020 2020  e1*ne2,ne3].    
 0006f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0006f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f390: 2020 2074 656e 736f 7232 5f74 2c20 2020     tensor2_t,   
-0006f3a0: 202f 2f20 5b31 2c6e 6530 2c6e 6531 2a6e   // [1,ne0,ne1*n
-0006f3b0: 6532 2c6e 6533 5d0a 2020 2020 2020 2020  e2,ne3].        
+0006f390: 2020 2020 2020 2020 7465 6e73 6f72 325f          tensor2_
+0006f3a0: 742c 2020 2020 2f2f 205b 312c 6e65 302c  t,    // [1,ne0,
+0006f3b0: 6e65 312a 6e65 322c 6e65 335d 0a20 2020  ne1*ne2,ne3].   
 0006f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0006f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f3e0: 2020 2020 7465 6e73 6f72 325f 7429 292c      tensor2_t)),
-0006f3f0: 2020 2f2f 205b 312c 6e65 302c 6e65 312a    // [1,ne0,ne1*
-0006f400: 6e65 322c 6e65 335d 0a20 2020 2020 2020  ne2,ne3].       
+0006f3e0: 2020 2020 2020 2020 2074 656e 736f 7232           tensor2
+0006f3f0: 5f74 2929 2c20 202f 2f20 5b31 2c6e 6530  _t)),  // [1,ne0
+0006f400: 2c6e 6531 2a6e 6532 2c6e 6533 5d0a 2020  ,ne1*ne2,ne3].  
 0006f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f420: 2020 2020 2020 2020 2020 2020 2067 7261               gra
-0006f430: 6432 292c 2020 2020 2020 2020 2020 2020  d2),            
-0006f440: 2020 202f 2f20 5b6e 6530 2c31 2c6e 6531     // [ne0,1,ne1
-0006f450: 2a6e 6532 2c6e 6533 5d0a 2020 2020 2020  *ne2,ne3].      
+0006f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f430: 2020 6772 6164 3229 2c20 2020 2020 2020    grad2),       
+0006f440: 2020 2020 2020 2020 2f2f 205b 6e65 302c          // [ne0,
+0006f450: 312c 6e65 312a 6e65 322c 6e65 335d 0a20  1,ne1*ne2,ne3]. 
 0006f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f470: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0006f480: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+0006f470: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0006f480: 7263 302d 3e67 7261 6429 2c0a 2020 2020  rc0->grad),.    
 0006f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f4a0: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-0006f4b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0006f4c0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0006f4d0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-0006f4e0: 2047 474d 4c5f 4f50 5f52 4f50 453a 0a20   GGML_OP_ROPE:. 
-0006f4f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0006f500: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006f510: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
-0006f520: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
-0006f530: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0006f540: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0006f550: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0006f560: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-0006f570: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
-0006f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f590: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
-0006f5a0: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
-0006f5b0: 3d20 3329 3b0a 2020 2020 2020 2020 2020  = 3);.          
-0006f5c0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006f5d0: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
-0006f5e0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-0006f5f0: 6461 7461 295b 305d 3b0a 2020 2020 2020  data)[0];.      
-0006f600: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0006f610: 6e73 7420 696e 7420 6e5f 6469 6d73 203d  nst int n_dims =
-0006f620: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-0006f630: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
-0006f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f650: 2020 636f 6e73 7420 696e 7420 6d6f 6465    const int mode
-0006f660: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
-0006f670: 2920 7372 6331 2d3e 6461 7461 295b 325d  ) src1->data)[2]
-0006f680: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006f690: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0006f6a0: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
-0006f6b0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+0006f4a0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+0006f4b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006f4c0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0006f4d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0006f4e0: 2063 6173 6520 4747 4d4c 5f4f 505f 524f   case GGML_OP_RO
+0006f4f0: 5045 3a0a 2020 2020 2020 2020 2020 2020  PE:.            
+0006f500: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006f510: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
+0006f520: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
+0006f530: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0006f540: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0006f550: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0006f560: 7373 6572 7428 7372 6331 2d3e 7479 7065  ssert(src1->type
+0006f570: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
+0006f580: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
+0006f590: 2020 2020 2020 2020 6173 7365 7274 2867          assert(g
+0006f5a0: 676d 6c5f 6e65 6c65 6d65 6e74 7328 7372  gml_nelements(sr
+0006f5b0: 6331 2920 3d3d 2033 293b 0a20 2020 2020  c1) == 3);.     
+0006f5c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0006f5d0: 6f6e 7374 2069 6e74 206e 5f70 6173 7420  onst int n_past 
+0006f5e0: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+0006f5f0: 7263 312d 3e64 6174 6129 5b30 5d3b 0a20  rc1->data)[0];. 
+0006f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f610: 2020 2063 6f6e 7374 2069 6e74 206e 5f64     const int n_d
+0006f620: 696d 7320 3d20 2828 696e 7433 325f 7420  ims = ((int32_t 
+0006f630: 2a29 2073 7263 312d 3e64 6174 6129 5b31  *) src1->data)[1
+0006f640: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+0006f650: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0006f660: 206d 6f64 6520 2020 3d20 2828 696e 7433   mode   = ((int3
+0006f670: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+0006f680: 6129 5b32 5d3b 0a20 2020 2020 2020 2020  a)[2];.         
+0006f690: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0006f6a0: 3e67 7261 6420 3d20 6767 6d6c 5f61 6464  >grad = ggml_add
+0006f6b0: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
 0006f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f6d0: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
-0006f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f6f0: 2020 2020 2020 2020 2020 6767 6d6c 5f72            ggml_r
-0006f700: 6f70 655f 6261 636b 2863 7478 2c0a 2020  ope_back(ctx,.  
-0006f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f720: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0006f730: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
-0006f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f750: 2020 2020 2020 2020 2020 2020 6e5f 7061              n_pa
-0006f760: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+0006f6d0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0006f6e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0006f6f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006f700: 676d 6c5f 726f 7065 5f62 6163 6b28 6374  gml_rope_back(ct
+0006f710: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0006f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f730: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
+0006f740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f760: 206e 5f70 6173 742c 0a20 2020 2020 2020   n_past,.       
 0006f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f780: 2020 2020 6e5f 6469 6d73 2c0a 2020 2020      n_dims,.    
-0006f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f7a0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0006f7b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0006f7c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006f7d0: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0006f7e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0006f7f0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0006f800: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
-0006f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f820: 202f 2f20 6e6f 6f70 0a20 2020 2020 2020   // noop.       
-0006f830: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0006f840: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0006f850: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0006f860: 4c5f 4f50 5f52 4f50 455f 4241 434b 3a0a  L_OP_ROPE_BACK:.
-0006f870: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0006f880: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006f890: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-0006f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f8b0: 2020 2020 6173 7365 7274 2873 7263 312d      assert(src1-
-0006f8c0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-0006f8d0: 5045 5f49 3332 293b 0a20 2020 2020 2020  PE_I32);.       
-0006f8e0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0006f8f0: 6572 7428 6767 6d6c 5f6e 656c 656d 656e  ert(ggml_nelemen
-0006f900: 7473 2873 7263 3129 203d 3d20 3329 3b0a  ts(src1) == 3);.
-0006f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f920: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-0006f930: 7061 7374 203d 2028 2869 6e74 3332 5f74  past = ((int32_t
-0006f940: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0006f950: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-0006f960: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0006f970: 7420 6e5f 6469 6d73 203d 2028 2869 6e74  t n_dims = ((int
-0006f980: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-0006f990: 7461 295b 315d 3b0a 2020 2020 2020 2020  ta)[1];.        
-0006f9a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006f9b0: 7420 696e 7420 6d6f 6465 2020 203d 2028  t int mode   = (
-0006f9c0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-0006f9d0: 2d3e 6461 7461 295b 325d 3b0a 2020 2020  ->data)[2];.    
-0006f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f9f0: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
-0006fa00: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-0006fa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fa20: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0006fa30: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0006f780: 2020 2020 2020 2020 206e 5f64 696d 732c           n_dims,
+0006f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f7b0: 206d 6f64 6529 2c0a 2020 2020 2020 2020   mode),.        
+0006f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f7d0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0006f7e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0006f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f800: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+0006f810: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006f820: 2020 2020 2020 2f2f 206e 6f6f 700a 2020        // noop.  
+0006f830: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0006f840: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0006f850: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0006f860: 6520 4747 4d4c 5f4f 505f 524f 5045 5f42  e GGML_OP_ROPE_B
+0006f870: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
+0006f880: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006f890: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0006f8a0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0006f8b0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+0006f8c0: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
+0006f8d0: 4d4c 5f54 5950 455f 4933 3229 3b0a 2020  ML_TYPE_I32);.  
+0006f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f8f0: 2020 6173 7365 7274 2867 676d 6c5f 6e65    assert(ggml_ne
+0006f900: 6c65 6d65 6e74 7328 7372 6331 2920 3d3d  lements(src1) ==
+0006f910: 2033 293b 0a20 2020 2020 2020 2020 2020   3);.           
+0006f920: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0006f930: 6e74 206e 5f70 6173 7420 3d20 2828 696e  nt n_past = ((in
+0006f940: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
+0006f950: 6174 6129 5b30 5d3b 0a20 2020 2020 2020  ata)[0];.       
+0006f960: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006f970: 7374 2069 6e74 206e 5f64 696d 7320 3d20  st int n_dims = 
+0006f980: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+0006f990: 312d 3e64 6174 6129 5b31 5d3b 0a20 2020  1->data)[1];.   
+0006f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f9b0: 2063 6f6e 7374 2069 6e74 206d 6f64 6520   const int mode 
+0006f9c0: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
+0006f9d0: 2073 7263 312d 3e64 6174 6129 5b32 5d3b   src1->data)[2];
+0006f9e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f9f0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+0006fa00: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
+0006fa10: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0006fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fa30: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
 0006fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fa50: 2020 2020 6767 6d6c 5f72 6f70 6528 6374      ggml_rope(ct
-0006fa60: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0006fa50: 2020 2020 2020 2020 2067 676d 6c5f 726f           ggml_ro
+0006fa60: 7065 2863 7478 2c0a 2020 2020 2020 2020  pe(ctx,.        
 0006fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fa80: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
-0006fa90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006fa80: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
+0006fa90: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
 0006faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fab0: 206e 5f70 6173 742c 0a20 2020 2020 2020   n_past,.       
+0006fab0: 2020 2020 2020 6e5f 7061 7374 2c0a 2020        n_past,.  
 0006fac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fad0: 2020 2020 2020 2020 206e 5f64 696d 732c           n_dims,
-0006fae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006fad0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+0006fae0: 6469 6d73 2c0a 2020 2020 2020 2020 2020  dims,.          
 0006faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fb00: 206d 6f64 6529 2c0a 2020 2020 2020 2020   mode),.        
+0006fb00: 2020 2020 2020 6d6f 6465 292c 0a20 2020        mode),.   
 0006fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fb20: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-0006fb30: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0006fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fb50: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
-0006fb60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0006fb70: 2020 2020 2020 2f2f 206e 6f6f 700a 2020        // noop.  
-0006fb80: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0006fb90: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0006fba0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0006fbb0: 6520 4747 4d4c 5f4f 505f 434f 4e56 5f31  e GGML_OP_CONV_1
-0006fbc0: 445f 5331 5f50 483a 0a20 2020 2020 2020  D_S1_PH:.       
-0006fbd0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006fbe0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0006fbf0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-0006fc00: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
-0006fc10: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-0006fc20: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0006fc30: 2063 6173 6520 4747 4d4c 5f4f 505f 434f   case GGML_OP_CO
-0006fc40: 4e56 5f31 445f 5332 5f50 483a 0a20 2020  NV_1D_S2_PH:.   
-0006fc50: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0006fc60: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0006fc70: 4153 5345 5254 2866 616c 7365 293b 202f  ASSERT(false); /
-0006fc80: 2f20 544f 444f 3a20 6e6f 7420 696d 706c  / TODO: not impl
-0006fc90: 656d 656e 7465 640a 2020 2020 2020 2020  emented.        
-0006fca0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0006fcb0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0006fcc0: 505f 434f 4e56 5f32 445f 534b 5f50 303a  P_CONV_2D_SK_P0:
-0006fcd0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0006fce0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0006fcf0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0006fd00: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
-0006fd10: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
-0006fd20: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0006fd30: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006fd40: 4d4c 5f4f 505f 464c 4153 485f 4154 544e  ML_OP_FLASH_ATTN
-0006fd50: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0006fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fd70: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0006fd80: 6529 3b20 2f2f 206e 6f74 2073 7570 706f  e); // not suppo
-0006fd90: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
-0006fda0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0006fdb0: 2020 6361 7365 2047 474d 4c5f 4f50 5f46    case GGML_OP_F
-0006fdc0: 4c41 5348 5f46 463a 0a20 2020 2020 2020  LASH_FF:.       
-0006fdd0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006fde0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0006fdf0: 5254 2866 616c 7365 293b 202f 2f20 6e6f  RT(false); // no
-0006fe00: 7420 7375 7070 6f72 7465 640a 2020 2020  t supported.    
-0006fe10: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0006fe20: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006fe30: 4d4c 5f4f 505f 5749 4e5f 5041 5254 3a0a  ML_OP_WIN_PART:.
-0006fe40: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0006fe50: 4c5f 4f50 5f57 494e 5f55 4e50 4152 543a  L_OP_WIN_UNPART:
-0006fe60: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006fe70: 4d4c 5f4f 505f 4d41 505f 554e 4152 593a  ML_OP_MAP_UNARY:
-0006fe80: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006fe90: 4d4c 5f4f 505f 4d41 505f 4249 4e41 5259  ML_OP_MAP_BINARY
-0006fea0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0006feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fec0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0006fed0: 6529 3b20 2f2f 206e 6f74 2073 7570 706f  e); // not suppo
-0006fee0: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
-0006fef0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0006ff00: 2020 6361 7365 2047 474d 4c5f 4f50 5f4e    case GGML_OP_N
-0006ff10: 4f4e 453a 0a20 2020 2020 2020 2020 2020  ONE:.           
-0006ff20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006ff30: 2020 202f 2f20 6e6f 700a 2020 2020 2020     // nop.      
-0006ff40: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0006ff50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0006ff60: 5f4f 505f 434f 554e 543a 0a20 2020 2020  _OP_COUNT:.     
-0006ff70: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0006ff80: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-0006ff90: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-0006ffa0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0006ffb0: 3b0a 2020 2020 7d0a 7d0a 0a73 7461 7469  ;.    }.}..stati
-0006ffc0: 6320 766f 6964 2067 676d 6c5f 7669 7369  c void ggml_visi
-0006ffd0: 745f 7061 7265 6e74 7328 7374 7275 6374  t_parents(struct
-0006ffe0: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
-0006fff0: 6772 6170 682c 2073 7472 7563 7420 6767  graph, struct gg
-00070000: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
-00070010: 2920 7b0a 2020 2020 6966 2028 6e6f 6465  ) {.    if (node
-00070020: 2d3e 6772 6164 203d 3d20 4e55 4c4c 2920  ->grad == NULL) 
-00070030: 7b0a 2020 2020 2020 2020 2f2f 2074 6869  {.        // thi
-00070040: 7320 7573 7561 6c6c 7920 6861 7070 656e  s usually happen
-00070050: 7320 7768 656e 2077 6520 6765 6e65 7261  s when we genera
-00070060: 7465 2069 6e74 6572 6d65 6469 6174 6520  te intermediate 
-00070070: 6e6f 6465 7320 6672 6f6d 2063 6f6e 7374  nodes from const
-00070080: 616e 7473 2069 6e20 7468 6520 6261 636b  ants in the back
-00070090: 7761 7264 2070 6173 730a 2020 2020 2020  ward pass.      
-000700a0: 2020 2f2f 2069 7420 6361 6e20 616c 736f    // it can also
-000700b0: 2068 6170 7065 6e20 6475 7269 6e67 2066   happen during f
-000700c0: 6f72 7761 7264 2070 6173 732c 2069 6620  orward pass, if 
-000700d0: 7468 6520 7573 6572 2070 6572 666f 726d  the user perform
-000700e0: 7320 636f 6d70 7574 6174 696f 6e73 2077  s computations w
-000700f0: 6974 6820 636f 6e73 7461 6e74 730a 2020  ith constants.  
-00070100: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
-00070110: 6f70 2021 3d20 4747 4d4c 5f4f 505f 4e4f  op != GGML_OP_NO
-00070120: 4e45 2920 7b0a 2020 2020 2020 2020 2020  NE) {.          
-00070130: 2020 2f2f 4747 4d4c 5f50 5249 4e54 5f44    //GGML_PRINT_D
-00070140: 4542 5547 2822 2573 3a20 7761 726e 696e  EBUG("%s: warnin
-00070150: 673a 206e 6f64 6520 2570 2068 6173 206e  g: node %p has n
-00070160: 6f20 6772 6164 2c20 6275 7420 6f70 2025  o grad, but op %
-00070170: 645c 6e22 2c20 5f5f 6675 6e63 5f5f 2c20  d\n", __func__, 
-00070180: 2876 6f69 6420 2a29 206e 6f64 652c 206e  (void *) node, n
-00070190: 6f64 652d 3e6f 7029 3b0a 2020 2020 2020  ode->op);.      
-000701a0: 2020 7d0a 2020 2020 7d0a 0a20 2020 202f    }.    }..    /
-000701b0: 2f20 6368 6563 6b20 6966 2061 6c72 6561  / check if alrea
-000701c0: 6479 2076 6973 6974 6564 0a20 2020 2066  dy visited.    f
-000701d0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-000701e0: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
-000701f0: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
-00070200: 2020 2069 6620 2863 6772 6170 682d 3e6e     if (cgraph->n
-00070210: 6f64 6573 5b69 5d20 3d3d 206e 6f64 6529  odes[i] == node)
-00070220: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
-00070230: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
-00070240: 0a20 2020 207d 0a0a 2020 2020 666f 7220  .    }..    for 
-00070250: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00070260: 6367 7261 7068 2d3e 6e5f 6c65 6166 733b  cgraph->n_leafs;
-00070270: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-00070280: 6966 2028 6367 7261 7068 2d3e 6c65 6166  if (cgraph->leaf
-00070290: 735b 695d 203d 3d20 6e6f 6465 2920 7b0a  s[i] == node) {.
-000702a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000702b0: 726e 3b0a 2020 2020 2020 2020 7d0a 2020  rn;.        }.  
-000702c0: 2020 7d0a 0a20 2020 2069 6620 286e 6f64    }..    if (nod
-000702d0: 652d 3e73 7263 3029 207b 0a20 2020 2020  e->src0) {.     
-000702e0: 2020 2067 676d 6c5f 7669 7369 745f 7061     ggml_visit_pa
-000702f0: 7265 6e74 7328 6367 7261 7068 2c20 6e6f  rents(cgraph, no
-00070300: 6465 2d3e 7372 6330 293b 0a20 2020 207d  de->src0);.    }
-00070310: 0a0a 2020 2020 6966 2028 6e6f 6465 2d3e  ..    if (node->
-00070320: 7372 6331 2920 7b0a 2020 2020 2020 2020  src1) {.        
-00070330: 6767 6d6c 5f76 6973 6974 5f70 6172 656e  ggml_visit_paren
-00070340: 7473 2863 6772 6170 682c 206e 6f64 652d  ts(cgraph, node-
-00070350: 3e73 7263 3129 3b0a 2020 2020 7d0a 0a20  >src1);.    }.. 
-00070360: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00070370: 303b 2069 203c 2047 474d 4c5f 4d41 585f  0; i < GGML_MAX_
-00070380: 4f50 543b 202b 2b69 2920 7b0a 2020 2020  OPT; ++i) {.    
-00070390: 2020 2020 6966 2028 6e6f 6465 2d3e 6f70      if (node->op
-000703a0: 745b 695d 2920 7b0a 2020 2020 2020 2020  t[i]) {.        
-000703b0: 2020 2020 6767 6d6c 5f76 6973 6974 5f70      ggml_visit_p
-000703c0: 6172 656e 7473 2863 6772 6170 682c 206e  arents(cgraph, n
-000703d0: 6f64 652d 3e6f 7074 5b69 5d29 3b0a 2020  ode->opt[i]);.  
-000703e0: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-000703f0: 2020 2069 6620 286e 6f64 652d 3e6f 7020     if (node->op 
-00070400: 3d3d 2047 474d 4c5f 4f50 5f4e 4f4e 4520  == GGML_OP_NONE 
-00070410: 2626 206e 6f64 652d 3e67 7261 6420 3d3d  && node->grad ==
-00070420: 204e 554c 4c29 207b 0a20 2020 2020 2020   NULL) {.       
-00070430: 202f 2f20 7265 6163 6865 6420 6120 6c65   // reached a le
-00070440: 6166 206e 6f64 652c 206e 6f74 2070 6172  af node, not par
-00070450: 7420 6f66 2074 6865 2067 7261 6469 656e  t of the gradien
-00070460: 7420 6772 6170 6820 2865 2e67 2e20 6120  t graph (e.g. a 
-00070470: 636f 6e73 7461 6e74 290a 2020 2020 2020  constant).      
-00070480: 2020 4747 4d4c 5f41 5353 4552 5428 6367    GGML_ASSERT(cg
-00070490: 7261 7068 2d3e 6e5f 6c65 6166 7320 3c20  raph->n_leafs < 
-000704a0: 4747 4d4c 5f4d 4158 5f4e 4f44 4553 293b  GGML_MAX_NODES);
-000704b0: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
-000704c0: 726c 656e 286e 6f64 652d 3e6e 616d 6529  rlen(node->name)
-000704d0: 203d 3d20 3029 207b 0a20 2020 2020 2020   == 0) {.       
-000704e0: 2020 2020 2073 6e70 7269 6e74 6628 6e6f       snprintf(no
-000704f0: 6465 2d3e 6e61 6d65 2c20 7369 7a65 6f66  de->name, sizeof
-00070500: 286e 6f64 652d 3e6e 616d 6529 2c20 226c  (node->name), "l
-00070510: 6561 665f 2564 222c 2063 6772 6170 682d  eaf_%d", cgraph-
-00070520: 3e6e 5f6c 6561 6673 293b 0a20 2020 2020  >n_leafs);.     
-00070530: 2020 207d 0a0a 2020 2020 2020 2020 6367     }..        cg
-00070540: 7261 7068 2d3e 6c65 6166 735b 6367 7261  raph->leafs[cgra
-00070550: 7068 2d3e 6e5f 6c65 6166 735d 203d 206e  ph->n_leafs] = n
-00070560: 6f64 653b 0a20 2020 2020 2020 2063 6772  ode;.        cgr
-00070570: 6170 682d 3e6e 5f6c 6561 6673 2b2b 3b0a  aph->n_leafs++;.
-00070580: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00070590: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-000705a0: 2863 6772 6170 682d 3e6e 5f6e 6f64 6573  (cgraph->n_nodes
-000705b0: 203c 2047 474d 4c5f 4d41 585f 4e4f 4445   < GGML_MAX_NODE
-000705c0: 5329 3b0a 0a20 2020 2020 2020 2069 6620  S);..        if 
-000705d0: 2873 7472 6c65 6e28 6e6f 6465 2d3e 6e61  (strlen(node->na
-000705e0: 6d65 2920 3d3d 2030 2920 7b0a 2020 2020  me) == 0) {.    
-000705f0: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
-00070600: 286e 6f64 652d 3e6e 616d 652c 2073 697a  (node->name, siz
-00070610: 656f 6628 6e6f 6465 2d3e 6e61 6d65 292c  eof(node->name),
-00070620: 2022 6e6f 6465 5f25 6422 2c20 6367 7261   "node_%d", cgra
-00070630: 7068 2d3e 6e5f 6e6f 6465 7329 3b0a 2020  ph->n_nodes);.  
-00070640: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00070650: 2063 6772 6170 682d 3e6e 6f64 6573 5b63   cgraph->nodes[c
-00070660: 6772 6170 682d 3e6e 5f6e 6f64 6573 5d20  graph->n_nodes] 
-00070670: 3d20 6e6f 6465 3b0a 2020 2020 2020 2020  = node;.        
-00070680: 6367 7261 7068 2d3e 6772 6164 735b 6367  cgraph->grads[cg
-00070690: 7261 7068 2d3e 6e5f 6e6f 6465 735d 203d  raph->n_nodes] =
-000706a0: 206e 6f64 652d 3e67 7261 643b 0a20 2020   node->grad;.   
-000706b0: 2020 2020 2063 6772 6170 682d 3e6e 5f6e       cgraph->n_n
-000706c0: 6f64 6573 2b2b 3b0a 2020 2020 7d0a 7d0a  odes++;.    }.}.
-000706d0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000706e0: 6c5f 6275 696c 645f 666f 7277 6172 645f  l_build_forward_
-000706f0: 696d 706c 2873 7472 7563 7420 6767 6d6c  impl(struct ggml
-00070700: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-00070710: 2c20 7374 7275 6374 2067 676d 6c5f 7465  , struct ggml_te
-00070720: 6e73 6f72 202a 2074 656e 736f 722c 2062  nsor * tensor, b
-00070730: 6f6f 6c20 6578 7061 6e64 2920 7b0a 2020  ool expand) {.  
-00070740: 2020 6966 2028 2165 7870 616e 6429 207b    if (!expand) {
-00070750: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
-00070760: 3e6e 5f6e 6f64 6573 203d 2030 3b0a 2020  >n_nodes = 0;.  
-00070770: 2020 2020 2020 6367 7261 7068 2d3e 6e5f        cgraph->n_
-00070780: 6c65 6166 7320 3d20 303b 0a20 2020 207d  leafs = 0;.    }
-00070790: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-000707a0: 6e30 203d 2063 6772 6170 682d 3e6e 5f6e  n0 = cgraph->n_n
-000707b0: 6f64 6573 3b0a 2020 2020 554e 5553 4544  odes;.    UNUSED
-000707c0: 286e 3029 3b0a 0a20 2020 2067 676d 6c5f  (n0);..    ggml_
-000707d0: 7669 7369 745f 7061 7265 6e74 7328 6367  visit_parents(cg
-000707e0: 7261 7068 2c20 7465 6e73 6f72 293b 0a0a  raph, tensor);..
-000707f0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-00070800: 6e65 7720 3d20 6367 7261 7068 2d3e 6e5f  new = cgraph->n_
-00070810: 6e6f 6465 7320 2d20 6e30 3b0a 2020 2020  nodes - n0;.    
-00070820: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-00070830: 2822 2573 3a20 7669 7369 7465 6420 2564  ("%s: visited %d
-00070840: 206e 6577 206e 6f64 6573 5c6e 222c 205f   new nodes\n", _
-00070850: 5f66 756e 635f 5f2c 206e 5f6e 6577 293b  _func__, n_new);
-00070860: 0a0a 2020 2020 6966 2028 6e5f 6e65 7720  ..    if (n_new 
-00070870: 3e20 3029 207b 0a20 2020 2020 2020 202f  > 0) {.        /
-00070880: 2f20 7468 6520 6c61 7374 2061 6464 6564  / the last added
-00070890: 206e 6f64 6520 7368 6f75 6c64 2061 6c77   node should alw
-000708a0: 6179 7320 6265 2073 7461 7274 696e 6720  ays be starting 
-000708b0: 706f 696e 740a 2020 2020 2020 2020 4747  point.        GG
-000708c0: 4d4c 5f41 5353 4552 5428 6367 7261 7068  ML_ASSERT(cgraph
-000708d0: 2d3e 6e6f 6465 735b 6367 7261 7068 2d3e  ->nodes[cgraph->
-000708e0: 6e5f 6e6f 6465 7320 2d20 315d 203d 3d20  n_nodes - 1] == 
-000708f0: 7465 6e73 6f72 293b 0a20 2020 207d 0a7d  tensor);.    }.}
-00070900: 0a0a 766f 6964 2067 676d 6c5f 6275 696c  ..void ggml_buil
-00070910: 645f 666f 7277 6172 645f 6578 7061 6e64  d_forward_expand
-00070920: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
-00070930: 6170 6820 2a20 6367 7261 7068 2c20 7374  aph * cgraph, st
-00070940: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00070950: 202a 2074 656e 736f 7229 207b 0a20 2020   * tensor) {.   
-00070960: 2067 676d 6c5f 6275 696c 645f 666f 7277   ggml_build_forw
-00070970: 6172 645f 696d 706c 2863 6772 6170 682c  ard_impl(cgraph,
-00070980: 2074 656e 736f 722c 2074 7275 6529 3b0a   tensor, true);.
-00070990: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f63  }..struct ggml_c
-000709a0: 6772 6170 6820 6767 6d6c 5f62 7569 6c64  graph ggml_build
-000709b0: 5f66 6f72 7761 7264 2873 7472 7563 7420  _forward(struct 
-000709c0: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-000709d0: 6e73 6f72 2920 7b0a 2020 2020 7374 7275  nsor) {.    stru
-000709e0: 6374 2067 676d 6c5f 6367 7261 7068 2072  ct ggml_cgraph r
-000709f0: 6573 756c 7420 3d20 7b0a 2020 2020 2020  esult = {.      
-00070a00: 2020 2f2a 2e6e 5f6e 6f64 6573 2020 2020    /*.n_nodes    
-00070a10: 2020 3d2a 2f20 302c 0a20 2020 2020 2020    =*/ 0,.       
-00070a20: 202f 2a2e 6e5f 6c65 6166 7320 2020 2020   /*.n_leafs     
-00070a30: 203d 2a2f 2030 2c0a 2020 2020 2020 2020   =*/ 0,.        
-00070a40: 2f2a 2e6e 5f74 6872 6561 6473 2020 2020  /*.n_threads    
-00070a50: 3d2a 2f20 4747 4d4c 5f44 4546 4155 4c54  =*/ GGML_DEFAULT
-00070a60: 5f4e 5f54 4852 4541 4453 2c0a 2020 2020  _N_THREADS,.    
-00070a70: 2020 2020 2f2a 2e77 6f72 6b5f 7369 7a65      /*.work_size
-00070a80: 2020 2020 3d2a 2f20 302c 0a20 2020 2020      =*/ 0,.     
-00070a90: 2020 202f 2a2e 776f 726b 2020 2020 2020     /*.work      
-00070aa0: 2020 203d 2a2f 204e 554c 4c2c 0a20 2020     =*/ NULL,.   
-00070ab0: 2020 2020 202f 2a2e 6e6f 6465 7320 2020       /*.nodes   
-00070ac0: 2020 2020 203d 2a2f 207b 204e 554c 4c20       =*/ { NULL 
-00070ad0: 7d2c 0a20 2020 2020 2020 202f 2a2e 6772  },.        /*.gr
-00070ae0: 6164 7320 2020 2020 2020 203d 2a2f 207b  ads        =*/ {
-00070af0: 204e 554c 4c20 7d2c 0a20 2020 2020 2020   NULL },.       
-00070b00: 202f 2a2e 6c65 6166 7320 2020 2020 2020   /*.leafs       
-00070b10: 203d 2a2f 207b 204e 554c 4c20 7d2c 0a20   =*/ { NULL },. 
-00070b20: 2020 2020 2020 202f 2a2e 7065 7266 5f72         /*.perf_r
-00070b30: 756e 7320 2020 203d 2a2f 2030 2c0a 2020  uns    =*/ 0,.  
-00070b40: 2020 2020 2020 2f2a 2e70 6572 665f 6379        /*.perf_cy
-00070b50: 636c 6573 2020 3d2a 2f20 302c 0a20 2020  cles  =*/ 0,.   
-00070b60: 2020 2020 202f 2a2e 7065 7266 5f74 696d       /*.perf_tim
-00070b70: 655f 7573 203d 2a2f 2030 2c0a 2020 2020  e_us =*/ 0,.    
-00070b80: 7d3b 0a0a 2020 2020 6767 6d6c 5f62 7569  };..    ggml_bui
-00070b90: 6c64 5f66 6f72 7761 7264 5f69 6d70 6c28  ld_forward_impl(
-00070ba0: 2672 6573 756c 742c 2074 656e 736f 722c  &result, tensor,
-00070bb0: 2066 616c 7365 293b 0a0a 2020 2020 7265   false);..    re
-00070bc0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-00070bd0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-00070be0: 7068 2067 676d 6c5f 6275 696c 645f 6261  ph ggml_build_ba
-00070bf0: 636b 7761 7264 2873 7472 7563 7420 6767  ckward(struct gg
-00070c00: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00070c10: 2c20 7374 7275 6374 2067 676d 6c5f 6367  , struct ggml_cg
-00070c20: 7261 7068 202a 2067 662c 2062 6f6f 6c20  raph * gf, bool 
-00070c30: 6b65 6570 2920 7b0a 2020 2020 7374 7275  keep) {.    stru
-00070c40: 6374 2067 676d 6c5f 6367 7261 7068 2072  ct ggml_cgraph r
-00070c50: 6573 756c 7420 3d20 2a67 663b 0a0a 2020  esult = *gf;..  
-00070c60: 2020 4747 4d4c 5f41 5353 4552 5428 6766    GGML_ASSERT(gf
-00070c70: 2d3e 6e5f 6e6f 6465 7320 3e20 3029 3b0a  ->n_nodes > 0);.
-00070c80: 0a20 2020 202f 2f20 6966 2077 6520 6172  .    // if we ar
-00070c90: 6520 6b65 6570 696e 6720 7468 6520 6772  e keeping the gr
-00070ca0: 6164 6965 6e74 2067 7261 7068 2c20 7765  adient graph, we
-00070cb0: 2068 6176 6520 746f 2064 6574 6163 6820   have to detach 
-00070cc0: 7468 6520 6772 6164 6965 6e74 206e 6f64  the gradient nod
-00070cd0: 6573 2066 726f 6d20 7468 6520 6f72 6967  es from the orig
-00070ce0: 696e 616c 2067 7261 7068 0a20 2020 2069  inal graph.    i
-00070cf0: 6620 286b 6565 7029 207b 0a20 2020 2020  f (keep) {.     
-00070d00: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00070d10: 303b 2069 203c 2067 662d 3e6e 5f6e 6f64  0; i < gf->n_nod
-00070d20: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
-00070d30: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00070d40: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
-00070d50: 203d 2067 662d 3e6e 6f64 6573 5b69 5d3b   = gf->nodes[i];
-00070d60: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00070d70: 2028 6e6f 6465 2d3e 6772 6164 2920 7b0a   (node->grad) {.
-00070d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070d90: 6e6f 6465 2d3e 6772 6164 203d 2067 676d  node->grad = ggm
-00070da0: 6c5f 6475 705f 7465 6e73 6f72 2863 7478  l_dup_tensor(ctx
-00070db0: 2c20 6e6f 6465 293b 0a20 2020 2020 2020  , node);.       
-00070dc0: 2020 2020 2020 2020 2067 662d 3e67 7261           gf->gra
-00070dd0: 6473 5b69 5d20 3d20 6e6f 6465 2d3e 6772  ds[i] = node->gr
-00070de0: 6164 3b0a 2020 2020 2020 2020 2020 2020  ad;.            
-00070df0: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-00070e00: 7d0a 0a20 2020 2066 6f72 2028 696e 7420  }..    for (int 
-00070e10: 6920 3d20 6766 2d3e 6e5f 6e6f 6465 7320  i = gf->n_nodes 
-00070e20: 2d20 313b 2069 203e 3d20 303b 2069 2d2d  - 1; i >= 0; i--
-00070e30: 2920 7b0a 2020 2020 2020 2020 7374 7275  ) {.        stru
-00070e40: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00070e50: 206e 6f64 6520 3d20 6766 2d3e 6e6f 6465   node = gf->node
-00070e60: 735b 695d 3b0a 0a20 2020 2020 2020 202f  s[i];..        /
-00070e70: 2f20 6265 6361 7573 6520 7765 2064 6574  / because we det
-00070e80: 6163 6865 6420 7468 6520 6772 6164 206e  ached the grad n
-00070e90: 6f64 6573 2066 726f 6d20 7468 6520 6f72  odes from the or
-00070ea0: 6967 696e 616c 2067 7261 7068 2c20 7765  iginal graph, we
-00070eb0: 2063 616e 2061 6666 6f72 6420 696e 706c   can afford inpl
-00070ec0: 6163 6520 6f70 6572 6174 696f 6e73 0a20  ace operations. 
-00070ed0: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
-00070ee0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00070ef0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00070f00: 655f 6261 636b 7761 7264 2863 7478 2c20  e_backward(ctx, 
-00070f10: 6e6f 6465 2c20 6b65 6570 293b 0a20 2020  node, keep);.   
-00070f20: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-00070f30: 2020 666f 7220 2869 6e74 2069 203d 2067    for (int i = g
-00070f40: 662d 3e6e 5f6e 6f64 6573 202d 2031 3b20  f->n_nodes - 1; 
-00070f50: 6920 3e3d 2030 3b20 692d 2d29 207b 0a20  i >= 0; i--) {. 
-00070f60: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00070f70: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
-00070f80: 203d 2067 662d 3e6e 6f64 6573 5b69 5d3b   = gf->nodes[i];
-00070f90: 0a0a 2020 2020 2020 2020 6966 2028 6e6f  ..        if (no
-00070fa0: 6465 2d3e 6973 5f70 6172 616d 2920 7b0a  de->is_param) {.
-00070fb0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00070fc0: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
-00070fd0: 3a20 666f 756e 6420 726f 6f74 206e 6f64  : found root nod
-00070fe0: 6520 2570 5c6e 222c 205f 5f66 756e 635f  e %p\n", __func_
-00070ff0: 5f2c 2028 766f 6964 202a 2920 6e6f 6465  _, (void *) node
-00071000: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
-00071010: 676d 6c5f 6275 696c 645f 666f 7277 6172  gml_build_forwar
-00071020: 645f 696d 706c 2826 7265 7375 6c74 2c20  d_impl(&result, 
-00071030: 6e6f 6465 2d3e 6772 6164 2c20 7472 7565  node->grad, true
-00071040: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
-00071050: 207d 0a0a 2020 2020 7265 7475 726e 2072   }..    return r
-00071060: 6573 756c 743b 0a7d 0a0a 2f2f 0a2f 2f20  esult;.}..//.// 
-00071070: 7468 7265 6164 2064 6174 610a 2f2f 0a2f  thread data.//./
-00071080: 2f20 7379 6e63 6872 6f6e 697a 6174 696f  / synchronizatio
-00071090: 6e20 6973 2064 6f6e 6520 7669 6120 6275  n is done via bu
-000710a0: 7379 206c 6f6f 7073 0a2f 2f20 4920 7472  sy loops.// I tr
-000710b0: 6965 6420 7573 696e 6720 7370 696e 206c  ied using spin l
-000710c0: 6f63 6b73 2c20 6275 7420 6e6f 7420 7375  ocks, but not su
-000710d0: 7265 2068 6f77 2074 6f20 7573 6520 7468  re how to use th
-000710e0: 656d 2063 6f72 7265 6374 6c79 202d 2074  em correctly - t
-000710f0: 6865 2074 6869 6e67 7320 4920 7472 6965  he things I trie
-00071100: 6420 7765 7265 2073 6c6f 7765 7220 7468  d were slower th
-00071110: 616e 2062 7573 7920 6c6f 6f70 730a 2f2f  an busy loops.//
-00071120: 0a0a 2369 6664 6566 205f 5f41 5050 4c45  ..#ifdef __APPLE
-00071130: 5f5f 0a0a 2f2f 2369 6e63 6c75 6465 203c  __..//#include <
-00071140: 6f73 2f6c 6f63 6b2e 683e 0a2f 2f0a 2f2f  os/lock.h>.//.//
-00071150: 7479 7065 6465 6620 6f73 5f75 6e66 6169  typedef os_unfai
-00071160: 725f 6c6f 636b 2067 676d 6c5f 6c6f 636b  r_lock ggml_lock
-00071170: 5f74 3b0a 2f2f 0a2f 2f23 6465 6669 6e65  _t;.//.//#define
-00071180: 2067 676d 6c5f 6c6f 636b 5f69 6e69 7428   ggml_lock_init(
-00071190: 7829 2020 2020 554e 5553 4544 2878 290a  x)    UNUSED(x).
-000711a0: 2f2f 2364 6566 696e 6520 6767 6d6c 5f6c  //#define ggml_l
-000711b0: 6f63 6b5f 6465 7374 726f 7928 7829 2055  ock_destroy(x) U
-000711c0: 4e55 5345 4428 7829 0a2f 2f23 6465 6669  NUSED(x).//#defi
-000711d0: 6e65 2067 676d 6c5f 6c6f 636b 5f6c 6f63  ne ggml_lock_loc
-000711e0: 6b20 2020 2020 2020 6f73 5f75 6e66 6169  k       os_unfai
-000711f0: 725f 6c6f 636b 5f6c 6f63 6b0a 2f2f 2364  r_lock_lock.//#d
-00071200: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00071210: 756e 6c6f 636b 2020 2020 206f 735f 756e  unlock     os_un
-00071220: 6661 6972 5f6c 6f63 6b5f 756e 6c6f 636b  fair_lock_unlock
-00071230: 0a2f 2f0a 2f2f 2364 6566 696e 6520 4747  .//.//#define GG
-00071240: 4d4c 5f4c 4f43 4b5f 494e 4954 4941 4c49  ML_LOCK_INITIALI
-00071250: 5a45 5220 4f53 5f55 4e46 4149 525f 4c4f  ZER OS_UNFAIR_LO
-00071260: 434b 5f49 4e49 540a 0a74 7970 6564 6566  CK_INIT..typedef
-00071270: 2069 6e74 2067 676d 6c5f 6c6f 636b 5f74   int ggml_lock_t
-00071280: 3b0a 0a23 6465 6669 6e65 2067 676d 6c5f  ;..#define ggml_
-00071290: 6c6f 636b 5f69 6e69 7428 7829 2020 2020  lock_init(x)    
-000712a0: 554e 5553 4544 2878 290a 2364 6566 696e  UNUSED(x).#defin
-000712b0: 6520 6767 6d6c 5f6c 6f63 6b5f 6465 7374  e ggml_lock_dest
-000712c0: 726f 7928 7829 2055 4e55 5345 4428 7829  roy(x) UNUSED(x)
-000712d0: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
-000712e0: 636b 5f6c 6f63 6b28 7829 2020 2020 554e  ck_lock(x)    UN
-000712f0: 5553 4544 2878 290a 2364 6566 696e 6520  USED(x).#define 
-00071300: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
-00071310: 2878 2920 2055 4e55 5345 4428 7829 0a0a  (x)  UNUSED(x)..
-00071320: 2364 6566 696e 6520 4747 4d4c 5f4c 4f43  #define GGML_LOC
-00071330: 4b5f 494e 4954 4941 4c49 5a45 5220 300a  K_INITIALIZER 0.
-00071340: 0a74 7970 6564 6566 2070 7468 7265 6164  .typedef pthread
-00071350: 5f74 2067 676d 6c5f 7468 7265 6164 5f74  _t ggml_thread_t
-00071360: 3b0a 0a23 6465 6669 6e65 2067 676d 6c5f  ;..#define ggml_
-00071370: 7468 7265 6164 5f63 7265 6174 6520 7074  thread_create pt
-00071380: 6872 6561 645f 6372 6561 7465 0a23 6465  hread_create.#de
-00071390: 6669 6e65 2067 676d 6c5f 7468 7265 6164  fine ggml_thread
-000713a0: 5f6a 6f69 6e20 2020 7074 6872 6561 645f  _join   pthread_
-000713b0: 6a6f 696e 0a0a 2365 6c73 650a 0a2f 2f74  join..#else..//t
-000713c0: 7970 6564 6566 2070 7468 7265 6164 5f73  ypedef pthread_s
-000713d0: 7069 6e6c 6f63 6b5f 7420 6767 6d6c 5f6c  pinlock_t ggml_l
-000713e0: 6f63 6b5f 743b 0a0a 2f2f 2364 6566 696e  ock_t;..//#defin
-000713f0: 6520 6767 6d6c 5f6c 6f63 6b5f 696e 6974  e ggml_lock_init
-00071400: 2878 2920 7074 6872 6561 645f 7370 696e  (x) pthread_spin
-00071410: 5f69 6e69 7428 782c 2050 5448 5245 4144  _init(x, PTHREAD
-00071420: 5f50 524f 4345 5353 5f50 5249 5641 5445  _PROCESS_PRIVATE
-00071430: 290a 2f2f 2364 6566 696e 6520 6767 6d6c  ).//#define ggml
-00071440: 5f6c 6f63 6b5f 6465 7374 726f 7920 7074  _lock_destroy pt
-00071450: 6872 6561 645f 7370 696e 5f64 6573 7472  hread_spin_destr
-00071460: 6f79 0a2f 2f23 6465 6669 6e65 2067 676d  oy.//#define ggm
-00071470: 6c5f 6c6f 636b 5f6c 6f63 6b20 2020 2070  l_lock_lock    p
-00071480: 7468 7265 6164 5f73 7069 6e5f 6c6f 636b  thread_spin_lock
-00071490: 0a2f 2f23 6465 6669 6e65 2067 676d 6c5f  .//#define ggml_
-000714a0: 6c6f 636b 5f75 6e6c 6f63 6b20 2070 7468  lock_unlock  pth
-000714b0: 7265 6164 5f73 7069 6e5f 756e 6c6f 636b  read_spin_unlock
-000714c0: 0a0a 7479 7065 6465 6620 696e 7420 6767  ..typedef int gg
-000714d0: 6d6c 5f6c 6f63 6b5f 743b 0a0a 2364 6566  ml_lock_t;..#def
-000714e0: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 696e  ine ggml_lock_in
-000714f0: 6974 2878 2920 2020 2055 4e55 5345 4428  it(x)    UNUSED(
-00071500: 7829 0a23 6465 6669 6e65 2067 676d 6c5f  x).#define ggml_
-00071510: 6c6f 636b 5f64 6573 7472 6f79 2878 2920  lock_destroy(x) 
-00071520: 554e 5553 4544 2878 290a 2369 6620 6465  UNUSED(x).#if de
-00071530: 6669 6e65 6428 5f5f 7838 365f 3634 5f5f  fined(__x86_64__
-00071540: 2920 7c7c 2028 6465 6669 6e65 6428 5f4d  ) || (defined(_M
-00071550: 5343 5f56 4552 2920 2626 2064 6566 696e  SC_VER) && defin
-00071560: 6564 285f 4d5f 414d 4436 3429 290a 2364  ed(_M_AMD64)).#d
-00071570: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00071580: 6c6f 636b 2878 2920 2020 205f 6d6d 5f70  lock(x)    _mm_p
-00071590: 6175 7365 2829 0a23 656c 7365 0a23 6465  ause().#else.#de
-000715a0: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f6c  fine ggml_lock_l
-000715b0: 6f63 6b28 7829 2020 2020 554e 5553 4544  ock(x)    UNUSED
-000715c0: 2878 290a 2365 6e64 6966 0a23 6465 6669  (x).#endif.#defi
-000715d0: 6e65 2067 676d 6c5f 6c6f 636b 5f75 6e6c  ne ggml_lock_unl
-000715e0: 6f63 6b28 7829 2020 554e 5553 4544 2878  ock(x)  UNUSED(x
-000715f0: 290a 0a23 6465 6669 6e65 2047 474d 4c5f  )..#define GGML_
-00071600: 4c4f 434b 5f49 4e49 5449 414c 495a 4552  LOCK_INITIALIZER
-00071610: 2030 0a0a 7479 7065 6465 6620 7074 6872   0..typedef pthr
-00071620: 6561 645f 7420 6767 6d6c 5f74 6872 6561  ead_t ggml_threa
-00071630: 645f 743b 0a0a 2364 6566 696e 6520 6767  d_t;..#define gg
-00071640: 6d6c 5f74 6872 6561 645f 6372 6561 7465  ml_thread_create
-00071650: 2070 7468 7265 6164 5f63 7265 6174 650a   pthread_create.
-00071660: 2364 6566 696e 6520 6767 6d6c 5f74 6872  #define ggml_thr
-00071670: 6561 645f 6a6f 696e 2020 2070 7468 7265  ead_join   pthre
-00071680: 6164 5f6a 6f69 6e0a 0a23 656e 6469 660a  ad_join..#endif.
-00071690: 0a73 7472 7563 7420 6767 6d6c 5f63 6f6d  .struct ggml_com
-000716a0: 7075 7465 5f73 7461 7465 5f73 6861 7265  pute_state_share
-000716b0: 6420 7b0a 2020 2020 6767 6d6c 5f6c 6f63  d {.    ggml_loc
-000716c0: 6b5f 7420 7370 696e 3b0a 0a20 2020 2069  k_t spin;..    i
-000716d0: 6e74 206e 5f74 6872 6561 6473 3b0a 0a20  nt n_threads;.. 
-000716e0: 2020 202f 2f20 7379 6e63 6872 6f6e 697a     // synchroniz
-000716f0: 6174 696f 6e20 7072 696d 6974 6976 6573  ation primitives
-00071700: 0a20 2020 2061 746f 6d69 635f 696e 7420  .    atomic_int 
-00071710: 206e 5f72 6561 6479 3b0a 2020 2020 6174   n_ready;.    at
-00071720: 6f6d 6963 5f62 6f6f 6c20 6861 735f 776f  omic_bool has_wo
-00071730: 726b 3b0a 2020 2020 6174 6f6d 6963 5f62  rk;.    atomic_b
-00071740: 6f6f 6c20 7374 6f70 3b20 2f2f 2073 746f  ool stop; // sto
-00071750: 7020 616c 6c20 7468 7265 6164 730a 7d3b  p all threads.};
-00071760: 0a0a 7374 7275 6374 2067 676d 6c5f 636f  ..struct ggml_co
-00071770: 6d70 7574 655f 7374 6174 6520 7b0a 2020  mpute_state {.  
-00071780: 2020 6767 6d6c 5f74 6872 6561 645f 7420    ggml_thread_t 
-00071790: 7468 7264 3b0a 0a20 2020 2073 7472 7563  thrd;..    struc
-000717a0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-000717b0: 6172 616d 7320 7061 7261 6d73 3b0a 2020  arams params;.  
-000717c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000717d0: 6e73 6f72 202a 206e 6f64 653b 0a0a 2020  nsor * node;..  
-000717e0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-000717f0: 6d70 7574 655f 7374 6174 655f 7368 6172  mpute_state_shar
-00071800: 6564 202a 2073 6861 7265 643b 0a7d 3b0a  ed * shared;.};.
-00071810: 0a73 7461 7469 6320 7468 7265 6164 5f72  .static thread_r
-00071820: 6574 5f74 2067 676d 6c5f 6772 6170 685f  et_t ggml_graph_
-00071830: 636f 6d70 7574 655f 7468 7265 6164 2876  compute_thread(v
-00071840: 6f69 6420 2a20 6461 7461 2920 7b0a 2020  oid * data) {.  
-00071850: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-00071860: 6d70 7574 655f 7374 6174 6520 2a20 7374  mpute_state * st
-00071870: 6174 6520 3d20 2873 7472 7563 7420 6767  ate = (struct gg
-00071880: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
-00071890: 202a 2920 6461 7461 3b0a 0a20 2020 2063   *) data;..    c
-000718a0: 6f6e 7374 2069 6e74 206e 5f74 6872 6561  onst int n_threa
-000718b0: 6473 203d 2073 7461 7465 2d3e 7368 6172  ds = state->shar
-000718c0: 6564 2d3e 6e5f 7468 7265 6164 733b 0a0a  ed->n_threads;..
-000718d0: 2020 2020 7768 696c 6520 2874 7275 6529      while (true)
-000718e0: 207b 0a20 2020 2020 2020 2069 6620 2861   {.        if (a
-000718f0: 746f 6d69 635f 6665 7463 685f 6164 6428  tomic_fetch_add(
-00071900: 2673 7461 7465 2d3e 7368 6172 6564 2d3e  &state->shared->
-00071910: 6e5f 7265 6164 792c 2031 2920 3d3d 206e  n_ready, 1) == n
-00071920: 5f74 6872 6561 6473 202d 2031 2920 7b0a  _threads - 1) {.
-00071930: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
-00071940: 6963 5f73 746f 7265 2826 7374 6174 652d  ic_store(&state-
-00071950: 3e73 6861 7265 642d 3e68 6173 5f77 6f72  >shared->has_wor
-00071960: 6b2c 2066 616c 7365 293b 0a20 2020 2020  k, false);.     
-00071970: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-00071980: 2020 2020 2020 2020 7768 696c 6520 2861          while (a
-00071990: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
-000719a0: 652d 3e73 6861 7265 642d 3e68 6173 5f77  e->shared->has_w
-000719b0: 6f72 6b29 2920 7b0a 2020 2020 2020 2020  ork)) {.        
-000719c0: 2020 2020 2020 2020 6966 2028 6174 6f6d          if (atom
-000719d0: 6963 5f6c 6f61 6428 2673 7461 7465 2d3e  ic_load(&state->
-000719e0: 7368 6172 6564 2d3e 7374 6f70 2929 207b  shared->stop)) {
-000719f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071a00: 2020 2020 2072 6574 7572 6e20 303b 0a20       return 0;. 
-00071a10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00071a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071a30: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
-00071a40: 2028 2673 7461 7465 2d3e 7368 6172 6564   (&state->shared
-00071a50: 2d3e 7370 696e 293b 0a20 2020 2020 2020  ->spin);.       
-00071a60: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
-00071a70: 636b 5f75 6e6c 6f63 6b28 2673 7461 7465  ck_unlock(&state
-00071a80: 2d3e 7368 6172 6564 2d3e 7370 696e 293b  ->shared->spin);
-00071a90: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00071aa0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00071ab0: 2020 6174 6f6d 6963 5f66 6574 6368 5f73    atomic_fetch_s
-00071ac0: 7562 2826 7374 6174 652d 3e73 6861 7265  ub(&state->share
-00071ad0: 642d 3e6e 5f72 6561 6479 2c20 3129 3b0a  d->n_ready, 1);.
-00071ae0: 0a20 2020 2020 2020 202f 2f20 7761 6974  .        // wait
-00071af0: 2066 6f72 2077 6f72 6b0a 2020 2020 2020   for work.      
-00071b00: 2020 7768 696c 6520 2821 6174 6f6d 6963    while (!atomic
-00071b10: 5f6c 6f61 6428 2673 7461 7465 2d3e 7368  _load(&state->sh
-00071b20: 6172 6564 2d3e 6861 735f 776f 726b 2929  ared->has_work))
-00071b30: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
-00071b40: 6620 2861 746f 6d69 635f 6c6f 6164 2826  f (atomic_load(&
-00071b50: 7374 6174 652d 3e73 6861 7265 642d 3e73  state->shared->s
-00071b60: 746f 7029 2920 7b0a 2020 2020 2020 2020  top)) {.        
-00071b70: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
-00071b80: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00071b90: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00071ba0: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
-00071bb0: 6174 652d 3e73 6861 7265 642d 3e73 7069  ate->shared->spi
-00071bc0: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-00071bd0: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
-00071be0: 2826 7374 6174 652d 3e73 6861 7265 642d  (&state->shared-
-00071bf0: 3e73 7069 6e29 3b0a 2020 2020 2020 2020  >spin);.        
-00071c00: 7d0a 0a20 2020 2020 2020 202f 2f20 6368  }..        // ch
-00071c10: 6563 6b20 6966 2077 6520 7368 6f75 6c64  eck if we should
-00071c20: 2073 746f 700a 2020 2020 2020 2020 6966   stop.        if
-00071c30: 2028 6174 6f6d 6963 5f6c 6f61 6428 2673   (atomic_load(&s
-00071c40: 7461 7465 2d3e 7368 6172 6564 2d3e 7374  tate->shared->st
-00071c50: 6f70 2929 207b 0a20 2020 2020 2020 2020  op)) {.         
-00071c60: 2020 2062 7265 616b 3b0a 2020 2020 2020     break;.      
-00071c70: 2020 7d0a 0a20 2020 2020 2020 2069 6620    }..        if 
-00071c80: 2873 7461 7465 2d3e 6e6f 6465 2920 7b0a  (state->node) {.
-00071c90: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00071ca0: 7374 6174 652d 3e70 6172 616d 732e 6974  state->params.it
-00071cb0: 6820 3c20 7374 6174 652d 3e70 6172 616d  h < state->param
-00071cc0: 732e 6e74 6829 207b 0a20 2020 2020 2020  s.nth) {.       
-00071cd0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00071ce0: 6d70 7574 655f 666f 7277 6172 6428 2673  mpute_forward(&s
-00071cf0: 7461 7465 2d3e 7061 7261 6d73 2c20 7374  tate->params, st
-00071d00: 6174 652d 3e6e 6f64 6529 3b0a 2020 2020  ate->node);.    
-00071d10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00071d20: 2020 2020 2020 2073 7461 7465 2d3e 6e6f         state->no
-00071d30: 6465 203d 204e 554c 4c3b 0a20 2020 2020  de = NULL;.     
-00071d40: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-00071d50: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-00071d60: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-00071d70: 2020 2020 7265 7475 726e 2030 3b0a 7d0a      return 0;.}.
-00071d80: 0a76 6f69 6420 6767 6d6c 5f67 7261 7068  .void ggml_graph
-00071d90: 5f63 6f6d 7075 7465 2873 7472 7563 7420  _compute(struct 
-00071da0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00071db0: 7478 2c20 7374 7275 6374 2067 676d 6c5f  tx, struct ggml_
-00071dc0: 6367 7261 7068 202a 2063 6772 6170 6829  cgraph * cgraph)
-00071dd0: 207b 0a20 2020 2063 6f6e 7374 2069 6e74   {.    const int
-00071de0: 206e 5f74 6872 6561 6473 203d 2063 6772   n_threads = cgr
-00071df0: 6170 682d 3e6e 5f74 6872 6561 6473 3b0a  aph->n_threads;.
-00071e00: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-00071e10: 5f63 6f6d 7075 7465 5f73 7461 7465 5f73  _compute_state_s
-00071e20: 6861 7265 6420 7374 6174 655f 7368 6172  hared state_shar
-00071e30: 6564 203d 207b 0a20 2020 2020 2020 202f  ed = {.        /
-00071e40: 2a2e 7370 696e 2020 2020 2020 3d2a 2f20  *.spin      =*/ 
-00071e50: 4747 4d4c 5f4c 4f43 4b5f 494e 4954 4941  GGML_LOCK_INITIA
-00071e60: 4c49 5a45 522c 0a20 2020 2020 2020 202f  LIZER,.        /
-00071e70: 2a2e 6e5f 7468 7265 6164 7320 3d2a 2f20  *.n_threads =*/ 
-00071e80: 6e5f 7468 7265 6164 732c 0a20 2020 2020  n_threads,.     
-00071e90: 2020 202f 2a2e 6e5f 7265 6164 7920 2020     /*.n_ready   
-00071ea0: 3d2a 2f20 302c 0a20 2020 2020 2020 202f  =*/ 0,.        /
-00071eb0: 2a2e 6861 735f 776f 726b 2020 3d2a 2f20  *.has_work  =*/ 
-00071ec0: 6661 6c73 652c 0a20 2020 2020 2020 202f  false,.        /
-00071ed0: 2a2e 7374 6f70 2020 2020 2020 3d2a 2f20  *.stop      =*/ 
-00071ee0: 6661 6c73 652c 0a20 2020 207d 3b0a 2020  false,.    };.  
-00071ef0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
-00071f00: 6d70 7574 655f 7374 6174 6520 2a20 776f  mpute_state * wo
-00071f10: 726b 6572 7320 3d20 6e5f 7468 7265 6164  rkers = n_thread
-00071f20: 7320 3e20 3120 3f20 616c 6c6f 6361 2873  s > 1 ? alloca(s
-00071f30: 697a 656f 6628 7374 7275 6374 2067 676d  izeof(struct ggm
-00071f40: 6c5f 636f 6d70 7574 655f 7374 6174 6529  l_compute_state)
-00071f50: 2a28 6e5f 7468 7265 6164 7320 2d20 3129  *(n_threads - 1)
-00071f60: 2920 3a20 4e55 4c4c 3b0a 0a20 2020 202f  ) : NULL;..    /
-00071f70: 2f20 6372 6561 7465 2074 6872 6561 6420  / create thread 
-00071f80: 706f 6f6c 0a20 2020 2069 6620 286e 5f74  pool.    if (n_t
-00071f90: 6872 6561 6473 203e 2031 2920 7b0a 2020  hreads > 1) {.  
-00071fa0: 2020 2020 2020 6767 6d6c 5f6c 6f63 6b5f        ggml_lock_
-00071fb0: 696e 6974 2826 7374 6174 655f 7368 6172  init(&state_shar
-00071fc0: 6564 2e73 7069 6e29 3b0a 0a20 2020 2020  ed.spin);..     
-00071fd0: 2020 2061 746f 6d69 635f 7374 6f72 6528     atomic_store(
-00071fe0: 2673 7461 7465 5f73 6861 7265 642e 6861  &state_shared.ha
-00071ff0: 735f 776f 726b 2c20 7472 7565 293b 0a0a  s_work, true);..
-00072000: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00072010: 206a 203d 2030 3b20 6a20 3c20 6e5f 7468   j = 0; j < n_th
-00072020: 7265 6164 7320 2d20 313b 206a 2b2b 2920  reads - 1; j++) 
-00072030: 7b0a 2020 2020 2020 2020 2020 2020 776f  {.            wo
-00072040: 726b 6572 735b 6a5d 203d 2028 7374 7275  rkers[j] = (stru
-00072050: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00072060: 7374 6174 6529 207b 0a20 2020 2020 2020  state) {.       
-00072070: 2020 2020 2020 2020 202e 7468 7264 2020           .thrd  
-00072080: 203d 2030 2c0a 2020 2020 2020 2020 2020   = 0,.          
-00072090: 2020 2020 2020 2e70 6172 616d 7320 3d20        .params = 
-000720a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000720b0: 2020 2020 2020 2e74 7970 6520 203d 2047        .type  = G
-000720c0: 474d 4c5f 5441 534b 5f43 4f4d 5055 5445  GML_TASK_COMPUTE
-000720d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000720e0: 2020 2020 2020 2e69 7468 2020 203d 206a        .ith   = j
-000720f0: 202b 2031 2c0a 2020 2020 2020 2020 2020   + 1,.          
-00072100: 2020 2020 2020 2020 2020 2e6e 7468 2020            .nth  
-00072110: 203d 206e 5f74 6872 6561 6473 2c0a 2020   = n_threads,.  
-00072120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072130: 2020 2e77 7369 7a65 203d 2063 6772 6170    .wsize = cgrap
-00072140: 682d 3e77 6f72 6b20 3f20 6767 6d6c 5f6e  h->work ? ggml_n
-00072150: 6279 7465 7328 6367 7261 7068 2d3e 776f  bytes(cgraph->wo
-00072160: 726b 2920 3a20 302c 0a20 2020 2020 2020  rk) : 0,.       
-00072170: 2020 2020 2020 2020 2020 2020 202e 7764               .wd
-00072180: 6174 6120 3d20 6367 7261 7068 2d3e 776f  ata = cgraph->wo
-00072190: 726b 203f 2063 6772 6170 682d 3e77 6f72  rk ? cgraph->wor
-000721a0: 6b2d 3e64 6174 6120 3a20 4e55 4c4c 2c0a  k->data : NULL,.
-000721b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000721c0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-000721d0: 2020 202e 6e6f 6465 2020 203d 204e 554c     .node   = NUL
-000721e0: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-000721f0: 2020 202e 7368 6172 6564 203d 2026 7374     .shared = &st
-00072200: 6174 655f 7368 6172 6564 2c0a 2020 2020  ate_shared,.    
-00072210: 2020 2020 2020 2020 7d3b 0a0a 2020 2020          };..    
-00072220: 2020 2020 2020 2020 696e 7420 7263 203d          int rc =
-00072230: 2067 676d 6c5f 7468 7265 6164 5f63 7265   ggml_thread_cre
-00072240: 6174 6528 2677 6f72 6b65 7273 5b6a 5d2e  ate(&workers[j].
-00072250: 7468 7264 2c20 4e55 4c4c 2c20 6767 6d6c  thrd, NULL, ggml
-00072260: 5f67 7261 7068 5f63 6f6d 7075 7465 5f74  _graph_compute_t
-00072270: 6872 6561 642c 2026 776f 726b 6572 735b  hread, &workers[
-00072280: 6a5d 293b 0a20 2020 2020 2020 2020 2020  j]);.           
-00072290: 2047 474d 4c5f 4153 5345 5254 2872 6320   GGML_ASSERT(rc 
-000722a0: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
-000722b0: 2020 2055 4e55 5345 4428 7263 293b 0a20     UNUSED(rc);. 
-000722c0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-000722d0: 2020 2020 2f2f 2069 6e69 7469 616c 697a      // initializ
-000722e0: 6520 7461 736b 7320 2b20 776f 726b 2062  e tasks + work b
-000722f0: 7566 6665 720a 2020 2020 7b0a 2020 2020  uffer.    {.    
-00072300: 2020 2020 7369 7a65 5f74 2077 6f72 6b5f      size_t work_
-00072310: 7369 7a65 203d 2030 3b0a 0a20 2020 2020  size = 0;..     
-00072320: 2020 202f 2f20 7468 7265 6164 2073 6368     // thread sch
-00072330: 6564 756c 696e 6720 666f 7220 7468 6520  eduling for the 
-00072340: 6469 6666 6572 656e 7420 6f70 6572 6174  different operat
-00072350: 696f 6e73 0a20 2020 2020 2020 2066 6f72  ions.        for
-00072360: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00072370: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
-00072380: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00072390: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000723a0: 5f74 656e 736f 7220 2a20 6e6f 6465 203d  _tensor * node =
-000723b0: 2063 6772 6170 682d 3e6e 6f64 6573 5b69   cgraph->nodes[i
-000723c0: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
-000723d0: 7377 6974 6368 2028 6e6f 6465 2d3e 6f70  switch (node->op
-000723e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000723f0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00072400: 5f43 5059 3a0a 2020 2020 2020 2020 2020  _CPY:.          
-00072410: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00072420: 4f50 5f44 5550 3a0a 2020 2020 2020 2020  OP_DUP:.        
-00072430: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00072440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072450: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-00072460: 736b 7320 3d20 6e5f 7468 7265 6164 733b  sks = n_threads;
-00072470: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00072480: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
-00072490: 2063 7572 203d 2030 3b0a 2020 2020 2020   cur = 0;.      
+0006fb20: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+0006fb30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0006fb40: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0006fb50: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
+0006fb60: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0006fb70: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
+0006fb80: 6f70 0a20 2020 2020 2020 2020 2020 2020  op.             
+0006fb90: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0006fba0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0006fbb0: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+0006fbc0: 4f4e 565f 3144 5f53 315f 5048 3a0a 2020  ONV_1D_S1_PH:.  
+0006fbd0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0006fbe0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0006fbf0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+0006fc00: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
+0006fc10: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
+0006fc20: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0006fc30: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0006fc40: 4f50 5f43 4f4e 565f 3144 5f53 325f 5048  OP_CONV_1D_S2_PH
+0006fc50: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0006fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fc70: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0006fc80: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
+0006fc90: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
+0006fca0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0006fcb0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0006fcc0: 474d 4c5f 4f50 5f43 4f4e 565f 3244 5f53  GML_OP_CONV_2D_S
+0006fcd0: 4b5f 5030 3a0a 2020 2020 2020 2020 2020  K_P0:.          
+0006fce0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0006fcf0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0006fd00: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
+0006fd10: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+0006fd20: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006fd30: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0006fd40: 7365 2047 474d 4c5f 4f50 5f46 4c41 5348  se GGML_OP_FLASH
+0006fd50: 5f41 5454 4e3a 0a20 2020 2020 2020 2020  _ATTN:.         
+0006fd60: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0006fd70: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0006fd80: 2866 616c 7365 293b 202f 2f20 6e6f 7420  (false); // not 
+0006fd90: 7375 7070 6f72 7465 640a 2020 2020 2020  supported.      
+0006fda0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0006fdb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0006fdc0: 5f4f 505f 464c 4153 485f 4646 3a0a 2020  _OP_FLASH_FF:.  
+0006fdd0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0006fde0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0006fdf0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+0006fe00: 2f2f 206e 6f74 2073 7570 706f 7274 6564  // not supported
+0006fe10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006fe20: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+0006fe30: 7365 2047 474d 4c5f 4f50 5f57 494e 5f50  se GGML_OP_WIN_P
+0006fe40: 4152 543a 0a20 2020 2020 2020 2063 6173  ART:.        cas
+0006fe50: 6520 4747 4d4c 5f4f 505f 5749 4e5f 554e  e GGML_OP_WIN_UN
+0006fe60: 5041 5254 3a0a 2020 2020 2020 2020 6361  PART:.        ca
+0006fe70: 7365 2047 474d 4c5f 4f50 5f4d 4150 5f55  se GGML_OP_MAP_U
+0006fe80: 4e41 5259 3a0a 2020 2020 2020 2020 6361  NARY:.        ca
+0006fe90: 7365 2047 474d 4c5f 4f50 5f4d 4150 5f42  se GGML_OP_MAP_B
+0006fea0: 494e 4152 593a 0a20 2020 2020 2020 2020  INARY:.         
+0006feb0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0006fec0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0006fed0: 2866 616c 7365 293b 202f 2f20 6e6f 7420  (false); // not 
+0006fee0: 7375 7070 6f72 7465 640a 2020 2020 2020  supported.      
+0006fef0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0006ff00: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0006ff10: 5f4f 505f 4e4f 4e45 3a0a 2020 2020 2020  _OP_NONE:.      
+0006ff20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0006ff30: 2020 2020 2020 2020 2f2f 206e 6f70 0a20          // nop. 
+0006ff40: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0006ff50: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0006ff60: 2047 474d 4c5f 4f50 5f43 4f55 4e54 3a0a   GGML_OP_COUNT:.
+0006ff70: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0006ff80: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0006ff90: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+0006ffa0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0006ffb0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
+0006ffc0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0006ffd0: 5f76 6973 6974 5f70 6172 656e 7473 2873  _visit_parents(s
+0006ffe0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+0006fff0: 6820 2a20 6367 7261 7068 2c20 7374 7275  h * cgraph, stru
+00070000: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070010: 206e 6f64 6529 207b 0a20 2020 2069 6620   node) {.    if 
+00070020: 286e 6f64 652d 3e67 7261 6420 3d3d 204e  (node->grad == N
+00070030: 554c 4c29 207b 0a20 2020 2020 2020 202f  ULL) {.        /
+00070040: 2f20 7468 6973 2075 7375 616c 6c79 2068  / this usually h
+00070050: 6170 7065 6e73 2077 6865 6e20 7765 2067  appens when we g
+00070060: 656e 6572 6174 6520 696e 7465 726d 6564  enerate intermed
+00070070: 6961 7465 206e 6f64 6573 2066 726f 6d20  iate nodes from 
+00070080: 636f 6e73 7461 6e74 7320 696e 2074 6865  constants in the
+00070090: 2062 6163 6b77 6172 6420 7061 7373 0a20   backward pass. 
+000700a0: 2020 2020 2020 202f 2f20 6974 2063 616e         // it can
+000700b0: 2061 6c73 6f20 6861 7070 656e 2064 7572   also happen dur
+000700c0: 696e 6720 666f 7277 6172 6420 7061 7373  ing forward pass
+000700d0: 2c20 6966 2074 6865 2075 7365 7220 7065  , if the user pe
+000700e0: 7266 6f72 6d73 2063 6f6d 7075 7461 7469  rforms computati
+000700f0: 6f6e 7320 7769 7468 2063 6f6e 7374 616e  ons with constan
+00070100: 7473 0a20 2020 2020 2020 2069 6620 286e  ts.        if (n
+00070110: 6f64 652d 3e6f 7020 213d 2047 474d 4c5f  ode->op != GGML_
+00070120: 4f50 5f4e 4f4e 4529 207b 0a20 2020 2020  OP_NONE) {.     
+00070130: 2020 2020 2020 202f 2f47 474d 4c5f 5052         //GGML_PR
+00070140: 494e 545f 4445 4255 4728 2225 733a 2077  INT_DEBUG("%s: w
+00070150: 6172 6e69 6e67 3a20 6e6f 6465 2025 7020  arning: node %p 
+00070160: 6861 7320 6e6f 2067 7261 642c 2062 7574  has no grad, but
+00070170: 206f 7020 2564 5c6e 222c 205f 5f66 756e   op %d\n", __fun
+00070180: 635f 5f2c 2028 766f 6964 202a 2920 6e6f  c__, (void *) no
+00070190: 6465 2c20 6e6f 6465 2d3e 6f70 293b 0a20  de, node->op);. 
+000701a0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+000701b0: 2020 2020 2f2f 2063 6865 636b 2069 6620      // check if 
+000701c0: 616c 7265 6164 7920 7669 7369 7465 640a  already visited.
+000701d0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+000701e0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
+000701f0: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
+00070200: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
+00070210: 7068 2d3e 6e6f 6465 735b 695d 203d 3d20  ph->nodes[i] == 
+00070220: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
+00070230: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00070240: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+00070250: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00070260: 2069 203c 2063 6772 6170 682d 3e6e 5f6c   i < cgraph->n_l
+00070270: 6561 6673 3b20 692b 2b29 207b 0a20 2020  eafs; i++) {.   
+00070280: 2020 2020 2069 6620 2863 6772 6170 682d       if (cgraph-
+00070290: 3e6c 6561 6673 5b69 5d20 3d3d 206e 6f64  >leafs[i] == nod
+000702a0: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
+000702b0: 2072 6574 7572 6e3b 0a20 2020 2020 2020   return;.       
+000702c0: 207d 0a20 2020 207d 0a0a 2020 2020 6966   }.    }..    if
+000702d0: 2028 6e6f 6465 2d3e 7372 6330 2920 7b0a   (node->src0) {.
+000702e0: 2020 2020 2020 2020 6767 6d6c 5f76 6973          ggml_vis
+000702f0: 6974 5f70 6172 656e 7473 2863 6772 6170  it_parents(cgrap
+00070300: 682c 206e 6f64 652d 3e73 7263 3029 3b0a  h, node->src0);.
+00070310: 2020 2020 7d0a 0a20 2020 2069 6620 286e      }..    if (n
+00070320: 6f64 652d 3e73 7263 3129 207b 0a20 2020  ode->src1) {.   
+00070330: 2020 2020 2067 676d 6c5f 7669 7369 745f       ggml_visit_
+00070340: 7061 7265 6e74 7328 6367 7261 7068 2c20  parents(cgraph, 
+00070350: 6e6f 6465 2d3e 7372 6331 293b 0a20 2020  node->src1);.   
+00070360: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
+00070370: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
+00070380: 5f4d 4158 5f4f 5054 3b20 2b2b 6929 207b  _MAX_OPT; ++i) {
+00070390: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
+000703a0: 652d 3e6f 7074 5b69 5d29 207b 0a20 2020  e->opt[i]) {.   
+000703b0: 2020 2020 2020 2020 2067 676d 6c5f 7669           ggml_vi
+000703c0: 7369 745f 7061 7265 6e74 7328 6367 7261  sit_parents(cgra
+000703d0: 7068 2c20 6e6f 6465 2d3e 6f70 745b 695d  ph, node->opt[i]
+000703e0: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
+000703f0: 207d 0a0a 2020 2020 6966 2028 6e6f 6465   }..    if (node
+00070400: 2d3e 6f70 203d 3d20 4747 4d4c 5f4f 505f  ->op == GGML_OP_
+00070410: 4e4f 4e45 2026 2620 6e6f 6465 2d3e 6772  NONE && node->gr
+00070420: 6164 203d 3d20 4e55 4c4c 2920 7b0a 2020  ad == NULL) {.  
+00070430: 2020 2020 2020 2f2f 2072 6561 6368 6564        // reached
+00070440: 2061 206c 6561 6620 6e6f 6465 2c20 6e6f   a leaf node, no
+00070450: 7420 7061 7274 206f 6620 7468 6520 6772  t part of the gr
+00070460: 6164 6965 6e74 2067 7261 7068 2028 652e  adient graph (e.
+00070470: 672e 2061 2063 6f6e 7374 616e 7429 0a20  g. a constant). 
+00070480: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00070490: 5254 2863 6772 6170 682d 3e6e 5f6c 6561  RT(cgraph->n_lea
+000704a0: 6673 203c 2047 474d 4c5f 4d41 585f 4e4f  fs < GGML_MAX_NO
+000704b0: 4445 5329 3b0a 0a20 2020 2020 2020 2069  DES);..        i
+000704c0: 6620 2873 7472 6c65 6e28 6e6f 6465 2d3e  f (strlen(node->
+000704d0: 6e61 6d65 2920 3d3d 2030 2920 7b0a 2020  name) == 0) {.  
+000704e0: 2020 2020 2020 2020 2020 736e 7072 696e            snprin
+000704f0: 7466 286e 6f64 652d 3e6e 616d 652c 2073  tf(node->name, s
+00070500: 697a 656f 6628 6e6f 6465 2d3e 6e61 6d65  izeof(node->name
+00070510: 292c 2022 6c65 6166 5f25 6422 2c20 6367  ), "leaf_%d", cg
+00070520: 7261 7068 2d3e 6e5f 6c65 6166 7329 3b0a  raph->n_leafs);.
+00070530: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00070540: 2020 2063 6772 6170 682d 3e6c 6561 6673     cgraph->leafs
+00070550: 5b63 6772 6170 682d 3e6e 5f6c 6561 6673  [cgraph->n_leafs
+00070560: 5d20 3d20 6e6f 6465 3b0a 2020 2020 2020  ] = node;.      
+00070570: 2020 6367 7261 7068 2d3e 6e5f 6c65 6166    cgraph->n_leaf
+00070580: 732b 2b3b 0a20 2020 207d 2065 6c73 6520  s++;.    } else 
+00070590: 7b0a 2020 2020 2020 2020 4747 4d4c 5f41  {.        GGML_A
+000705a0: 5353 4552 5428 6367 7261 7068 2d3e 6e5f  SSERT(cgraph->n_
+000705b0: 6e6f 6465 7320 3c20 4747 4d4c 5f4d 4158  nodes < GGML_MAX
+000705c0: 5f4e 4f44 4553 293b 0a0a 2020 2020 2020  _NODES);..      
+000705d0: 2020 6966 2028 7374 726c 656e 286e 6f64    if (strlen(nod
+000705e0: 652d 3e6e 616d 6529 203d 3d20 3029 207b  e->name) == 0) {
+000705f0: 0a20 2020 2020 2020 2020 2020 2073 6e70  .            snp
+00070600: 7269 6e74 6628 6e6f 6465 2d3e 6e61 6d65  rintf(node->name
+00070610: 2c20 7369 7a65 6f66 286e 6f64 652d 3e6e  , sizeof(node->n
+00070620: 616d 6529 2c20 226e 6f64 655f 2564 222c  ame), "node_%d",
+00070630: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
+00070640: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
+00070650: 2020 2020 2020 6367 7261 7068 2d3e 6e6f        cgraph->no
+00070660: 6465 735b 6367 7261 7068 2d3e 6e5f 6e6f  des[cgraph->n_no
+00070670: 6465 735d 203d 206e 6f64 653b 0a20 2020  des] = node;.   
+00070680: 2020 2020 2063 6772 6170 682d 3e67 7261       cgraph->gra
+00070690: 6473 5b63 6772 6170 682d 3e6e 5f6e 6f64  ds[cgraph->n_nod
+000706a0: 6573 5d20 3d20 6e6f 6465 2d3e 6772 6164  es] = node->grad
+000706b0: 3b0a 2020 2020 2020 2020 6367 7261 7068  ;.        cgraph
+000706c0: 2d3e 6e5f 6e6f 6465 732b 2b3b 0a20 2020  ->n_nodes++;.   
+000706d0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+000706e0: 6420 6767 6d6c 5f62 7569 6c64 5f66 6f72  d ggml_build_for
+000706f0: 7761 7264 5f69 6d70 6c28 7374 7275 6374  ward_impl(struct
+00070700: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
+00070710: 6772 6170 682c 2073 7472 7563 7420 6767  graph, struct gg
+00070720: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
+00070730: 6f72 2c20 626f 6f6c 2065 7870 616e 6429  or, bool expand)
+00070740: 207b 0a20 2020 2069 6620 2821 6578 7061   {.    if (!expa
+00070750: 6e64 2920 7b0a 2020 2020 2020 2020 6367  nd) {.        cg
+00070760: 7261 7068 2d3e 6e5f 6e6f 6465 7320 3d20  raph->n_nodes = 
+00070770: 303b 0a20 2020 2020 2020 2063 6772 6170  0;.        cgrap
+00070780: 682d 3e6e 5f6c 6561 6673 203d 2030 3b0a  h->n_leafs = 0;.
+00070790: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+000707a0: 2069 6e74 206e 3020 3d20 6367 7261 7068   int n0 = cgraph
+000707b0: 2d3e 6e5f 6e6f 6465 733b 0a20 2020 2055  ->n_nodes;.    U
+000707c0: 4e55 5345 4428 6e30 293b 0a0a 2020 2020  NUSED(n0);..    
+000707d0: 6767 6d6c 5f76 6973 6974 5f70 6172 656e  ggml_visit_paren
+000707e0: 7473 2863 6772 6170 682c 2074 656e 736f  ts(cgraph, tenso
+000707f0: 7229 3b0a 0a20 2020 2063 6f6e 7374 2069  r);..    const i
+00070800: 6e74 206e 5f6e 6577 203d 2063 6772 6170  nt n_new = cgrap
+00070810: 682d 3e6e 5f6e 6f64 6573 202d 206e 303b  h->n_nodes - n0;
+00070820: 0a20 2020 2047 474d 4c5f 5052 494e 545f  .    GGML_PRINT_
+00070830: 4445 4255 4728 2225 733a 2076 6973 6974  DEBUG("%s: visit
+00070840: 6564 2025 6420 6e65 7720 6e6f 6465 735c  ed %d new nodes\
+00070850: 6e22 2c20 5f5f 6675 6e63 5f5f 2c20 6e5f  n", __func__, n_
+00070860: 6e65 7729 3b0a 0a20 2020 2069 6620 286e  new);..    if (n
+00070870: 5f6e 6577 203e 2030 2920 7b0a 2020 2020  _new > 0) {.    
+00070880: 2020 2020 2f2f 2074 6865 206c 6173 7420      // the last 
+00070890: 6164 6465 6420 6e6f 6465 2073 686f 756c  added node shoul
+000708a0: 6420 616c 7761 7973 2062 6520 7374 6172  d always be star
+000708b0: 7469 6e67 2070 6f69 6e74 0a20 2020 2020  ting point.     
+000708c0: 2020 2047 474d 4c5f 4153 5345 5254 2863     GGML_ASSERT(c
+000708d0: 6772 6170 682d 3e6e 6f64 6573 5b63 6772  graph->nodes[cgr
+000708e0: 6170 682d 3e6e 5f6e 6f64 6573 202d 2031  aph->n_nodes - 1
+000708f0: 5d20 3d3d 2074 656e 736f 7229 3b0a 2020  ] == tensor);.  
+00070900: 2020 7d0a 7d0a 0a76 6f69 6420 6767 6d6c    }.}..void ggml
+00070910: 5f62 7569 6c64 5f66 6f72 7761 7264 5f65  _build_forward_e
+00070920: 7870 616e 6428 7374 7275 6374 2067 676d  xpand(struct ggm
+00070930: 6c5f 6367 7261 7068 202a 2063 6772 6170  l_cgraph * cgrap
+00070940: 682c 2073 7472 7563 7420 6767 6d6c 5f74  h, struct ggml_t
+00070950: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
+00070960: 7b0a 2020 2020 6767 6d6c 5f62 7569 6c64  {.    ggml_build
+00070970: 5f66 6f72 7761 7264 5f69 6d70 6c28 6367  _forward_impl(cg
+00070980: 7261 7068 2c20 7465 6e73 6f72 2c20 7472  raph, tensor, tr
+00070990: 7565 293b 0a7d 0a0a 7374 7275 6374 2067  ue);.}..struct g
+000709a0: 676d 6c5f 6367 7261 7068 2067 676d 6c5f  gml_cgraph ggml_
+000709b0: 6275 696c 645f 666f 7277 6172 6428 7374  build_forward(st
+000709c0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000709d0: 202a 2074 656e 736f 7229 207b 0a20 2020   * tensor) {.   
+000709e0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+000709f0: 6170 6820 7265 7375 6c74 203d 207b 0a20  aph result = {. 
+00070a00: 2020 2020 2020 202f 2a2e 6e5f 6e6f 6465         /*.n_node
+00070a10: 7320 2020 2020 203d 2a2f 2030 2c0a 2020  s      =*/ 0,.  
+00070a20: 2020 2020 2020 2f2a 2e6e 5f6c 6561 6673        /*.n_leafs
+00070a30: 2020 2020 2020 3d2a 2f20 302c 0a20 2020        =*/ 0,.   
+00070a40: 2020 2020 202f 2a2e 6e5f 7468 7265 6164       /*.n_thread
+00070a50: 7320 2020 203d 2a2f 2047 474d 4c5f 4445  s    =*/ GGML_DE
+00070a60: 4641 554c 545f 4e5f 5448 5245 4144 532c  FAULT_N_THREADS,
+00070a70: 0a20 2020 2020 2020 202f 2a2e 776f 726b  .        /*.work
+00070a80: 5f73 697a 6520 2020 203d 2a2f 2030 2c0a  _size    =*/ 0,.
+00070a90: 2020 2020 2020 2020 2f2a 2e77 6f72 6b20          /*.work 
+00070aa0: 2020 2020 2020 2020 3d2a 2f20 4e55 4c4c          =*/ NULL
+00070ab0: 2c0a 2020 2020 2020 2020 2f2a 2e6e 6f64  ,.        /*.nod
+00070ac0: 6573 2020 2020 2020 2020 3d2a 2f20 7b20  es        =*/ { 
+00070ad0: 4e55 4c4c 207d 2c0a 2020 2020 2020 2020  NULL },.        
+00070ae0: 2f2a 2e67 7261 6473 2020 2020 2020 2020  /*.grads        
+00070af0: 3d2a 2f20 7b20 4e55 4c4c 207d 2c0a 2020  =*/ { NULL },.  
+00070b00: 2020 2020 2020 2f2a 2e6c 6561 6673 2020        /*.leafs  
+00070b10: 2020 2020 2020 3d2a 2f20 7b20 4e55 4c4c        =*/ { NULL
+00070b20: 207d 2c0a 2020 2020 2020 2020 2f2a 2e70   },.        /*.p
+00070b30: 6572 665f 7275 6e73 2020 2020 3d2a 2f20  erf_runs    =*/ 
+00070b40: 302c 0a20 2020 2020 2020 202f 2a2e 7065  0,.        /*.pe
+00070b50: 7266 5f63 7963 6c65 7320 203d 2a2f 2030  rf_cycles  =*/ 0
+00070b60: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
+00070b70: 665f 7469 6d65 5f75 7320 3d2a 2f20 302c  f_time_us =*/ 0,
+00070b80: 0a20 2020 207d 3b0a 0a20 2020 2067 676d  .    };..    ggm
+00070b90: 6c5f 6275 696c 645f 666f 7277 6172 645f  l_build_forward_
+00070ba0: 696d 706c 2826 7265 7375 6c74 2c20 7465  impl(&result, te
+00070bb0: 6e73 6f72 2c20 6661 6c73 6529 3b0a 0a20  nsor, false);.. 
+00070bc0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00070bd0: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+00070be0: 5f63 6772 6170 6820 6767 6d6c 5f62 7569  _cgraph ggml_bui
+00070bf0: 6c64 5f62 6163 6b77 6172 6428 7374 7275  ld_backward(stru
+00070c00: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+00070c10: 2a20 6374 782c 2073 7472 7563 7420 6767  * ctx, struct gg
+00070c20: 6d6c 5f63 6772 6170 6820 2a20 6766 2c20  ml_cgraph * gf, 
+00070c30: 626f 6f6c 206b 6565 7029 207b 0a20 2020  bool keep) {.   
+00070c40: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+00070c50: 6170 6820 7265 7375 6c74 203d 202a 6766  aph result = *gf
+00070c60: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00070c70: 5254 2867 662d 3e6e 5f6e 6f64 6573 203e  RT(gf->n_nodes >
+00070c80: 2030 293b 0a0a 2020 2020 2f2f 2069 6620   0);..    // if 
+00070c90: 7765 2061 7265 206b 6565 7069 6e67 2074  we are keeping t
+00070ca0: 6865 2067 7261 6469 656e 7420 6772 6170  he gradient grap
+00070cb0: 682c 2077 6520 6861 7665 2074 6f20 6465  h, we have to de
+00070cc0: 7461 6368 2074 6865 2067 7261 6469 656e  tach the gradien
+00070cd0: 7420 6e6f 6465 7320 6672 6f6d 2074 6865  t nodes from the
+00070ce0: 206f 7269 6769 6e61 6c20 6772 6170 680a   original graph.
+00070cf0: 2020 2020 6966 2028 6b65 6570 2920 7b0a      if (keep) {.
+00070d00: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00070d10: 2069 203d 2030 3b20 6920 3c20 6766 2d3e   i = 0; i < gf->
+00070d20: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
+00070d30: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00070d40: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070d50: 206e 6f64 6520 3d20 6766 2d3e 6e6f 6465   node = gf->node
+00070d60: 735b 695d 3b0a 0a20 2020 2020 2020 2020  s[i];..         
+00070d70: 2020 2069 6620 286e 6f64 652d 3e67 7261     if (node->gra
+00070d80: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00070d90: 2020 2020 206e 6f64 652d 3e67 7261 6420       node->grad 
+00070da0: 3d20 6767 6d6c 5f64 7570 5f74 656e 736f  = ggml_dup_tenso
+00070db0: 7228 6374 782c 206e 6f64 6529 3b0a 2020  r(ctx, node);.  
+00070dc0: 2020 2020 2020 2020 2020 2020 2020 6766                gf
+00070dd0: 2d3e 6772 6164 735b 695d 203d 206e 6f64  ->grads[i] = nod
+00070de0: 652d 3e67 7261 643b 0a20 2020 2020 2020  e->grad;.       
+00070df0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00070e00: 0a20 2020 207d 0a0a 2020 2020 666f 7220  .    }..    for 
+00070e10: 2869 6e74 2069 203d 2067 662d 3e6e 5f6e  (int i = gf->n_n
+00070e20: 6f64 6573 202d 2031 3b20 6920 3e3d 2030  odes - 1; i >= 0
+00070e30: 3b20 692d 2d29 207b 0a20 2020 2020 2020  ; i--) {.       
+00070e40: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00070e50: 736f 7220 2a20 6e6f 6465 203d 2067 662d  sor * node = gf-
+00070e60: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
+00070e70: 2020 2020 2f2f 2062 6563 6175 7365 2077      // because w
+00070e80: 6520 6465 7461 6368 6564 2074 6865 2067  e detached the g
+00070e90: 7261 6420 6e6f 6465 7320 6672 6f6d 2074  rad nodes from t
+00070ea0: 6865 206f 7269 6769 6e61 6c20 6772 6170  he original grap
+00070eb0: 682c 2077 6520 6361 6e20 6166 666f 7264  h, we can afford
+00070ec0: 2069 6e70 6c61 6365 206f 7065 7261 7469   inplace operati
+00070ed0: 6f6e 730a 2020 2020 2020 2020 6966 2028  ons.        if (
+00070ee0: 6e6f 6465 2d3e 6772 6164 2920 7b0a 2020  node->grad) {.  
+00070ef0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00070f00: 6f6d 7075 7465 5f62 6163 6b77 6172 6428  ompute_backward(
+00070f10: 6374 782c 206e 6f64 652c 206b 6565 7029  ctx, node, keep)
+00070f20: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+00070f30: 7d0a 0a20 2020 2066 6f72 2028 696e 7420  }..    for (int 
+00070f40: 6920 3d20 6766 2d3e 6e5f 6e6f 6465 7320  i = gf->n_nodes 
+00070f50: 2d20 313b 2069 203e 3d20 303b 2069 2d2d  - 1; i >= 0; i--
+00070f60: 2920 7b0a 2020 2020 2020 2020 7374 7275  ) {.        stru
+00070f70: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070f80: 206e 6f64 6520 3d20 6766 2d3e 6e6f 6465   node = gf->node
+00070f90: 735b 695d 3b0a 0a20 2020 2020 2020 2069  s[i];..        i
+00070fa0: 6620 286e 6f64 652d 3e69 735f 7061 7261  f (node->is_para
+00070fb0: 6d29 207b 0a20 2020 2020 2020 2020 2020  m) {.           
+00070fc0: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+00070fd0: 4728 2225 733a 2066 6f75 6e64 2072 6f6f  G("%s: found roo
+00070fe0: 7420 6e6f 6465 2025 705c 6e22 2c20 5f5f  t node %p\n", __
+00070ff0: 6675 6e63 5f5f 2c20 2876 6f69 6420 2a29  func__, (void *)
+00071000: 206e 6f64 6529 3b0a 2020 2020 2020 2020   node);.        
+00071010: 2020 2020 6767 6d6c 5f62 7569 6c64 5f66      ggml_build_f
+00071020: 6f72 7761 7264 5f69 6d70 6c28 2672 6573  orward_impl(&res
+00071030: 756c 742c 206e 6f64 652d 3e67 7261 642c  ult, node->grad,
+00071040: 2074 7275 6529 3b0a 2020 2020 2020 2020   true);.        
+00071050: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+00071060: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+00071070: 2f0a 2f2f 2074 6872 6561 6420 6461 7461  /.// thread data
+00071080: 0a2f 2f0a 2f2f 2073 796e 6368 726f 6e69  .//.// synchroni
+00071090: 7a61 7469 6f6e 2069 7320 646f 6e65 2076  zation is done v
+000710a0: 6961 2062 7573 7920 6c6f 6f70 730a 2f2f  ia busy loops.//
+000710b0: 2049 2074 7269 6564 2075 7369 6e67 2073   I tried using s
+000710c0: 7069 6e20 6c6f 636b 732c 2062 7574 206e  pin locks, but n
+000710d0: 6f74 2073 7572 6520 686f 7720 746f 2075  ot sure how to u
+000710e0: 7365 2074 6865 6d20 636f 7272 6563 746c  se them correctl
+000710f0: 7920 2d20 7468 6520 7468 696e 6773 2049  y - the things I
+00071100: 2074 7269 6564 2077 6572 6520 736c 6f77   tried were slow
+00071110: 6572 2074 6861 6e20 6275 7379 206c 6f6f  er than busy loo
+00071120: 7073 0a2f 2f0a 0a23 6966 6465 6620 5f5f  ps.//..#ifdef __
+00071130: 4150 504c 455f 5f0a 0a2f 2f23 696e 636c  APPLE__..//#incl
+00071140: 7564 6520 3c6f 732f 6c6f 636b 2e68 3e0a  ude <os/lock.h>.
+00071150: 2f2f 0a2f 2f74 7970 6564 6566 206f 735f  //.//typedef os_
+00071160: 756e 6661 6972 5f6c 6f63 6b20 6767 6d6c  unfair_lock ggml
+00071170: 5f6c 6f63 6b5f 743b 0a2f 2f0a 2f2f 2364  _lock_t;.//.//#d
+00071180: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
+00071190: 696e 6974 2878 2920 2020 2055 4e55 5345  init(x)    UNUSE
+000711a0: 4428 7829 0a2f 2f23 6465 6669 6e65 2067  D(x).//#define g
+000711b0: 676d 6c5f 6c6f 636b 5f64 6573 7472 6f79  gml_lock_destroy
+000711c0: 2878 2920 554e 5553 4544 2878 290a 2f2f  (x) UNUSED(x).//
+000711d0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+000711e0: 6b5f 6c6f 636b 2020 2020 2020 206f 735f  k_lock       os_
+000711f0: 756e 6661 6972 5f6c 6f63 6b5f 6c6f 636b  unfair_lock_lock
+00071200: 0a2f 2f23 6465 6669 6e65 2067 676d 6c5f  .//#define ggml_
+00071210: 6c6f 636b 5f75 6e6c 6f63 6b20 2020 2020  lock_unlock     
+00071220: 6f73 5f75 6e66 6169 725f 6c6f 636b 5f75  os_unfair_lock_u
+00071230: 6e6c 6f63 6b0a 2f2f 0a2f 2f23 6465 6669  nlock.//.//#defi
+00071240: 6e65 2047 474d 4c5f 4c4f 434b 5f49 4e49  ne GGML_LOCK_INI
+00071250: 5449 414c 495a 4552 204f 535f 554e 4641  TIALIZER OS_UNFA
+00071260: 4952 5f4c 4f43 4b5f 494e 4954 0a0a 7479  IR_LOCK_INIT..ty
+00071270: 7065 6465 6620 696e 7420 6767 6d6c 5f6c  pedef int ggml_l
+00071280: 6f63 6b5f 743b 0a0a 2364 6566 696e 6520  ock_t;..#define 
+00071290: 6767 6d6c 5f6c 6f63 6b5f 696e 6974 2878  ggml_lock_init(x
+000712a0: 2920 2020 2055 4e55 5345 4428 7829 0a23  )    UNUSED(x).#
+000712b0: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
+000712c0: 5f64 6573 7472 6f79 2878 2920 554e 5553  _destroy(x) UNUS
+000712d0: 4544 2878 290a 2364 6566 696e 6520 6767  ED(x).#define gg
+000712e0: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2878 2920  ml_lock_lock(x) 
+000712f0: 2020 2055 4e55 5345 4428 7829 0a23 6465     UNUSED(x).#de
+00071300: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f75  fine ggml_lock_u
+00071310: 6e6c 6f63 6b28 7829 2020 554e 5553 4544  nlock(x)  UNUSED
+00071320: 2878 290a 0a23 6465 6669 6e65 2047 474d  (x)..#define GGM
+00071330: 4c5f 4c4f 434b 5f49 4e49 5449 414c 495a  L_LOCK_INITIALIZ
+00071340: 4552 2030 0a0a 7479 7065 6465 6620 7074  ER 0..typedef pt
+00071350: 6872 6561 645f 7420 6767 6d6c 5f74 6872  hread_t ggml_thr
+00071360: 6561 645f 743b 0a0a 2364 6566 696e 6520  ead_t;..#define 
+00071370: 6767 6d6c 5f74 6872 6561 645f 6372 6561  ggml_thread_crea
+00071380: 7465 2070 7468 7265 6164 5f63 7265 6174  te pthread_creat
+00071390: 650a 2364 6566 696e 6520 6767 6d6c 5f74  e.#define ggml_t
+000713a0: 6872 6561 645f 6a6f 696e 2020 2070 7468  hread_join   pth
+000713b0: 7265 6164 5f6a 6f69 6e0a 0a23 656c 7365  read_join..#else
+000713c0: 0a0a 2f2f 7479 7065 6465 6620 7074 6872  ..//typedef pthr
+000713d0: 6561 645f 7370 696e 6c6f 636b 5f74 2067  ead_spinlock_t g
+000713e0: 676d 6c5f 6c6f 636b 5f74 3b0a 0a2f 2f23  gml_lock_t;..//#
+000713f0: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
+00071400: 5f69 6e69 7428 7829 2070 7468 7265 6164  _init(x) pthread
+00071410: 5f73 7069 6e5f 696e 6974 2878 2c20 5054  _spin_init(x, PT
+00071420: 4852 4541 445f 5052 4f43 4553 535f 5052  HREAD_PROCESS_PR
+00071430: 4956 4154 4529 0a2f 2f23 6465 6669 6e65  IVATE).//#define
+00071440: 2067 676d 6c5f 6c6f 636b 5f64 6573 7472   ggml_lock_destr
+00071450: 6f79 2070 7468 7265 6164 5f73 7069 6e5f  oy pthread_spin_
+00071460: 6465 7374 726f 790a 2f2f 2364 6566 696e  destroy.//#defin
+00071470: 6520 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b  e ggml_lock_lock
+00071480: 2020 2020 7074 6872 6561 645f 7370 696e      pthread_spin
+00071490: 5f6c 6f63 6b0a 2f2f 2364 6566 696e 6520  _lock.//#define 
+000714a0: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
+000714b0: 2020 7074 6872 6561 645f 7370 696e 5f75    pthread_spin_u
+000714c0: 6e6c 6f63 6b0a 0a74 7970 6564 6566 2069  nlock..typedef i
+000714d0: 6e74 2067 676d 6c5f 6c6f 636b 5f74 3b0a  nt ggml_lock_t;.
+000714e0: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
+000714f0: 636b 5f69 6e69 7428 7829 2020 2020 554e  ck_init(x)    UN
+00071500: 5553 4544 2878 290a 2364 6566 696e 6520  USED(x).#define 
+00071510: 6767 6d6c 5f6c 6f63 6b5f 6465 7374 726f  ggml_lock_destro
+00071520: 7928 7829 2055 4e55 5345 4428 7829 0a23  y(x) UNUSED(x).#
+00071530: 6966 2064 6566 696e 6564 285f 5f78 3836  if defined(__x86
+00071540: 5f36 345f 5f29 207c 7c20 2864 6566 696e  _64__) || (defin
+00071550: 6564 285f 4d53 435f 5645 5229 2026 2620  ed(_MSC_VER) && 
+00071560: 6465 6669 6e65 6428 5f4d 5f41 4d44 3634  defined(_M_AMD64
+00071570: 2929 0a23 6465 6669 6e65 2067 676d 6c5f  )).#define ggml_
+00071580: 6c6f 636b 5f6c 6f63 6b28 7829 2020 2020  lock_lock(x)    
+00071590: 5f6d 6d5f 7061 7573 6528 290a 2365 6c73  _mm_pause().#els
+000715a0: 650a 2364 6566 696e 6520 6767 6d6c 5f6c  e.#define ggml_l
+000715b0: 6f63 6b5f 6c6f 636b 2878 2920 2020 2055  ock_lock(x)    U
+000715c0: 4e55 5345 4428 7829 0a23 656e 6469 660a  NUSED(x).#endif.
+000715d0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+000715e0: 6b5f 756e 6c6f 636b 2878 2920 2055 4e55  k_unlock(x)  UNU
+000715f0: 5345 4428 7829 0a0a 2364 6566 696e 6520  SED(x)..#define 
+00071600: 4747 4d4c 5f4c 4f43 4b5f 494e 4954 4941  GGML_LOCK_INITIA
+00071610: 4c49 5a45 5220 300a 0a74 7970 6564 6566  LIZER 0..typedef
+00071620: 2070 7468 7265 6164 5f74 2067 676d 6c5f   pthread_t ggml_
+00071630: 7468 7265 6164 5f74 3b0a 0a23 6465 6669  thread_t;..#defi
+00071640: 6e65 2067 676d 6c5f 7468 7265 6164 5f63  ne ggml_thread_c
+00071650: 7265 6174 6520 7074 6872 6561 645f 6372  reate pthread_cr
+00071660: 6561 7465 0a23 6465 6669 6e65 2067 676d  eate.#define ggm
+00071670: 6c5f 7468 7265 6164 5f6a 6f69 6e20 2020  l_thread_join   
+00071680: 7074 6872 6561 645f 6a6f 696e 0a0a 2365  pthread_join..#e
+00071690: 6e64 6966 0a0a 7374 7275 6374 2067 676d  ndif..struct ggm
+000716a0: 6c5f 636f 6d70 7574 655f 7374 6174 655f  l_compute_state_
+000716b0: 7368 6172 6564 207b 0a20 2020 2067 676d  shared {.    ggm
+000716c0: 6c5f 6c6f 636b 5f74 2073 7069 6e3b 0a0a  l_lock_t spin;..
+000716d0: 2020 2020 696e 7420 6e5f 7468 7265 6164      int n_thread
+000716e0: 733b 0a0a 2020 2020 2f2f 2073 796e 6368  s;..    // synch
+000716f0: 726f 6e69 7a61 7469 6f6e 2070 7269 6d69  ronization primi
+00071700: 7469 7665 730a 2020 2020 6174 6f6d 6963  tives.    atomic
+00071710: 5f69 6e74 2020 6e5f 7265 6164 793b 0a20  _int  n_ready;. 
+00071720: 2020 2061 746f 6d69 635f 626f 6f6c 2068     atomic_bool h
+00071730: 6173 5f77 6f72 6b3b 0a20 2020 2061 746f  as_work;.    ato
+00071740: 6d69 635f 626f 6f6c 2073 746f 703b 202f  mic_bool stop; /
+00071750: 2f20 7374 6f70 2061 6c6c 2074 6872 6561  / stop all threa
+00071760: 6473 0a7d 3b0a 0a73 7472 7563 7420 6767  ds.};..struct gg
+00071770: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
+00071780: 207b 0a20 2020 2067 676d 6c5f 7468 7265   {.    ggml_thre
+00071790: 6164 5f74 2074 6872 643b 0a0a 2020 2020  ad_t thrd;..    
+000717a0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+000717b0: 7574 655f 7061 7261 6d73 2070 6172 616d  ute_params param
+000717c0: 733b 0a20 2020 2073 7472 7563 7420 6767  s;.    struct gg
+000717d0: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
+000717e0: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+000717f0: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
+00071800: 5f73 6861 7265 6420 2a20 7368 6172 6564  _shared * shared
+00071810: 3b0a 7d3b 0a0a 7374 6174 6963 2074 6872  ;.};..static thr
+00071820: 6561 645f 7265 745f 7420 6767 6d6c 5f67  ead_ret_t ggml_g
+00071830: 7261 7068 5f63 6f6d 7075 7465 5f74 6872  raph_compute_thr
+00071840: 6561 6428 766f 6964 202a 2064 6174 6129  ead(void * data)
+00071850: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
+00071860: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
+00071870: 202a 2073 7461 7465 203d 2028 7374 7275   * state = (stru
+00071880: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00071890: 7374 6174 6520 2a29 2064 6174 613b 0a0a  state *) data;..
+000718a0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
+000718b0: 7468 7265 6164 7320 3d20 7374 6174 652d  threads = state-
+000718c0: 3e73 6861 7265 642d 3e6e 5f74 6872 6561  >shared->n_threa
+000718d0: 6473 3b0a 0a20 2020 2077 6869 6c65 2028  ds;..    while (
+000718e0: 7472 7565 2920 7b0a 2020 2020 2020 2020  true) {.        
+000718f0: 6966 2028 6174 6f6d 6963 5f66 6574 6368  if (atomic_fetch
+00071900: 5f61 6464 2826 7374 6174 652d 3e73 6861  _add(&state->sha
+00071910: 7265 642d 3e6e 5f72 6561 6479 2c20 3129  red->n_ready, 1)
+00071920: 203d 3d20 6e5f 7468 7265 6164 7320 2d20   == n_threads - 
+00071930: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
+00071940: 2061 746f 6d69 635f 7374 6f72 6528 2673   atomic_store(&s
+00071950: 7461 7465 2d3e 7368 6172 6564 2d3e 6861  tate->shared->ha
+00071960: 735f 776f 726b 2c20 6661 6c73 6529 3b0a  s_work, false);.
+00071970: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+00071980: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
+00071990: 6c65 2028 6174 6f6d 6963 5f6c 6f61 6428  le (atomic_load(
+000719a0: 2673 7461 7465 2d3e 7368 6172 6564 2d3e  &state->shared->
+000719b0: 6861 735f 776f 726b 2929 207b 0a20 2020  has_work)) {.   
+000719c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000719d0: 2861 746f 6d69 635f 6c6f 6164 2826 7374  (atomic_load(&st
+000719e0: 6174 652d 3e73 6861 7265 642d 3e73 746f  ate->shared->sto
+000719f0: 7029 2920 7b0a 2020 2020 2020 2020 2020  p)) {.          
+00071a00: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00071a10: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00071a20: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00071a30: 2020 2020 2020 6767 6d6c 5f6c 6f63 6b5f        ggml_lock_
+00071a40: 6c6f 636b 2020 2826 7374 6174 652d 3e73  lock  (&state->s
+00071a50: 6861 7265 642d 3e73 7069 6e29 3b0a 2020  hared->spin);.  
+00071a60: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00071a70: 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b 2826  ml_lock_unlock(&
+00071a80: 7374 6174 652d 3e73 6861 7265 642d 3e73  state->shared->s
+00071a90: 7069 6e29 3b0a 2020 2020 2020 2020 2020  pin);.          
+00071aa0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+00071ab0: 2020 2020 2020 2061 746f 6d69 635f 6665         atomic_fe
+00071ac0: 7463 685f 7375 6228 2673 7461 7465 2d3e  tch_sub(&state->
+00071ad0: 7368 6172 6564 2d3e 6e5f 7265 6164 792c  shared->n_ready,
+00071ae0: 2031 293b 0a0a 2020 2020 2020 2020 2f2f   1);..        //
+00071af0: 2077 6169 7420 666f 7220 776f 726b 0a20   wait for work. 
+00071b00: 2020 2020 2020 2077 6869 6c65 2028 2161         while (!a
+00071b10: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
+00071b20: 652d 3e73 6861 7265 642d 3e68 6173 5f77  e->shared->has_w
+00071b30: 6f72 6b29 2920 7b0a 2020 2020 2020 2020  ork)) {.        
+00071b40: 2020 2020 6966 2028 6174 6f6d 6963 5f6c      if (atomic_l
+00071b50: 6f61 6428 2673 7461 7465 2d3e 7368 6172  oad(&state->shar
+00071b60: 6564 2d3e 7374 6f70 2929 207b 0a20 2020  ed->stop)) {.   
+00071b70: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00071b80: 7572 6e20 303b 0a20 2020 2020 2020 2020  urn 0;.         
+00071b90: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00071ba0: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
+00071bb0: 2028 2673 7461 7465 2d3e 7368 6172 6564   (&state->shared
+00071bc0: 2d3e 7370 696e 293b 0a20 2020 2020 2020  ->spin);.       
+00071bd0: 2020 2020 2067 676d 6c5f 6c6f 636b 5f75       ggml_lock_u
+00071be0: 6e6c 6f63 6b28 2673 7461 7465 2d3e 7368  nlock(&state->sh
+00071bf0: 6172 6564 2d3e 7370 696e 293b 0a20 2020  ared->spin);.   
+00071c00: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00071c10: 2f2f 2063 6865 636b 2069 6620 7765 2073  // check if we s
+00071c20: 686f 756c 6420 7374 6f70 0a20 2020 2020  hould stop.     
+00071c30: 2020 2069 6620 2861 746f 6d69 635f 6c6f     if (atomic_lo
+00071c40: 6164 2826 7374 6174 652d 3e73 6861 7265  ad(&state->share
+00071c50: 642d 3e73 746f 7029 2920 7b0a 2020 2020  d->stop)) {.    
+00071c60: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
+00071c70: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00071c80: 2020 6966 2028 7374 6174 652d 3e6e 6f64    if (state->nod
+00071c90: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
+00071ca0: 2069 6620 2873 7461 7465 2d3e 7061 7261   if (state->para
+00071cb0: 6d73 2e69 7468 203c 2073 7461 7465 2d3e  ms.ith < state->
+00071cc0: 7061 7261 6d73 2e6e 7468 2920 7b0a 2020  params.nth) {.  
+00071cd0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00071ce0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00071cf0: 7264 2826 7374 6174 652d 3e70 6172 616d  rd(&state->param
+00071d00: 732c 2073 7461 7465 2d3e 6e6f 6465 293b  s, state->node);
+00071d10: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00071d20: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+00071d30: 652d 3e6e 6f64 6520 3d20 4e55 4c4c 3b0a  e->node = NULL;.
+00071d40: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+00071d50: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
+00071d60: 616b 3b0a 2020 2020 2020 2020 7d0a 2020  ak;.        }.  
+00071d70: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
+00071d80: 303b 0a7d 0a0a 766f 6964 2067 676d 6c5f  0;.}..void ggml_
+00071d90: 6772 6170 685f 636f 6d70 7574 6528 7374  graph_compute(st
+00071da0: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00071db0: 7420 2a20 6374 782c 2073 7472 7563 7420  t * ctx, struct 
+00071dc0: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
+00071dd0: 7261 7068 2920 7b0a 2020 2020 636f 6e73  raph) {.    cons
+00071de0: 7420 696e 7420 6e5f 7468 7265 6164 7320  t int n_threads 
+00071df0: 3d20 6367 7261 7068 2d3e 6e5f 7468 7265  = cgraph->n_thre
+00071e00: 6164 733b 0a0a 2020 2020 7374 7275 6374  ads;..    struct
+00071e10: 2067 676d 6c5f 636f 6d70 7574 655f 7374   ggml_compute_st
+00071e20: 6174 655f 7368 6172 6564 2073 7461 7465  ate_shared state
+00071e30: 5f73 6861 7265 6420 3d20 7b0a 2020 2020  _shared = {.    
+00071e40: 2020 2020 2f2a 2e73 7069 6e20 2020 2020      /*.spin     
+00071e50: 203d 2a2f 2047 474d 4c5f 4c4f 434b 5f49   =*/ GGML_LOCK_I
+00071e60: 4e49 5449 414c 495a 4552 2c0a 2020 2020  NITIALIZER,.    
+00071e70: 2020 2020 2f2a 2e6e 5f74 6872 6561 6473      /*.n_threads
+00071e80: 203d 2a2f 206e 5f74 6872 6561 6473 2c0a   =*/ n_threads,.
+00071e90: 2020 2020 2020 2020 2f2a 2e6e 5f72 6561          /*.n_rea
+00071ea0: 6479 2020 203d 2a2f 2030 2c0a 2020 2020  dy   =*/ 0,.    
+00071eb0: 2020 2020 2f2a 2e68 6173 5f77 6f72 6b20      /*.has_work 
+00071ec0: 203d 2a2f 2066 616c 7365 2c0a 2020 2020   =*/ false,.    
+00071ed0: 2020 2020 2f2a 2e73 746f 7020 2020 2020      /*.stop     
+00071ee0: 203d 2a2f 2066 616c 7365 2c0a 2020 2020   =*/ false,.    
+00071ef0: 7d3b 0a20 2020 2073 7472 7563 7420 6767  };.    struct gg
+00071f00: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
+00071f10: 202a 2077 6f72 6b65 7273 203d 206e 5f74   * workers = n_t
+00071f20: 6872 6561 6473 203e 2031 203f 2061 6c6c  hreads > 1 ? all
+00071f30: 6f63 6128 7369 7a65 6f66 2873 7472 7563  oca(sizeof(struc
+00071f40: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+00071f50: 7461 7465 292a 286e 5f74 6872 6561 6473  tate)*(n_threads
+00071f60: 202d 2031 2929 203a 204e 554c 4c3b 0a0a   - 1)) : NULL;..
+00071f70: 2020 2020 2f2f 2063 7265 6174 6520 7468      // create th
+00071f80: 7265 6164 2070 6f6f 6c0a 2020 2020 6966  read pool.    if
+00071f90: 2028 6e5f 7468 7265 6164 7320 3e20 3129   (n_threads > 1)
+00071fa0: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
+00071fb0: 6c6f 636b 5f69 6e69 7428 2673 7461 7465  lock_init(&state
+00071fc0: 5f73 6861 7265 642e 7370 696e 293b 0a0a  _shared.spin);..
+00071fd0: 2020 2020 2020 2020 6174 6f6d 6963 5f73          atomic_s
+00071fe0: 746f 7265 2826 7374 6174 655f 7368 6172  tore(&state_shar
+00071ff0: 6564 2e68 6173 5f77 6f72 6b2c 2074 7275  ed.has_work, tru
+00072000: 6529 3b0a 0a20 2020 2020 2020 2066 6f72  e);..        for
+00072010: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+00072020: 206e 5f74 6872 6561 6473 202d 2031 3b20   n_threads - 1; 
+00072030: 6a2b 2b29 207b 0a20 2020 2020 2020 2020  j++) {.         
+00072040: 2020 2077 6f72 6b65 7273 5b6a 5d20 3d20     workers[j] = 
+00072050: 2873 7472 7563 7420 6767 6d6c 5f63 6f6d  (struct ggml_com
+00072060: 7075 7465 5f73 7461 7465 2920 7b0a 2020  pute_state) {.  
+00072070: 2020 2020 2020 2020 2020 2020 2020 2e74                .t
+00072080: 6872 6420 2020 3d20 302c 0a20 2020 2020  hrd   = 0,.     
+00072090: 2020 2020 2020 2020 2020 202e 7061 7261             .para
+000720a0: 6d73 203d 207b 0a20 2020 2020 2020 2020  ms = {.         
+000720b0: 2020 2020 2020 2020 2020 202e 7479 7065             .type
+000720c0: 2020 3d20 4747 4d4c 5f54 4153 4b5f 434f    = GGML_TASK_CO
+000720d0: 4d50 5554 452c 0a20 2020 2020 2020 2020  MPUTE,.         
+000720e0: 2020 2020 2020 2020 2020 202e 6974 6820             .ith 
+000720f0: 2020 3d20 6a20 2b20 312c 0a20 2020 2020    = j + 1,.     
+00072100: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00072110: 6e74 6820 2020 3d20 6e5f 7468 7265 6164  nth   = n_thread
+00072120: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00072130: 2020 2020 2020 202e 7773 697a 6520 3d20         .wsize = 
+00072140: 6367 7261 7068 2d3e 776f 726b 203f 2067  cgraph->work ? g
+00072150: 676d 6c5f 6e62 7974 6573 2863 6772 6170  gml_nbytes(cgrap
+00072160: 682d 3e77 6f72 6b29 203a 2030 2c0a 2020  h->work) : 0,.  
+00072170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072180: 2020 2e77 6461 7461 203d 2063 6772 6170    .wdata = cgrap
+00072190: 682d 3e77 6f72 6b20 3f20 6367 7261 7068  h->work ? cgraph
+000721a0: 2d3e 776f 726b 2d3e 6461 7461 203a 204e  ->work->data : N
+000721b0: 554c 4c2c 0a20 2020 2020 2020 2020 2020  ULL,.           
+000721c0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000721d0: 2020 2020 2020 2020 2e6e 6f64 6520 2020          .node   
+000721e0: 3d20 4e55 4c4c 2c0a 2020 2020 2020 2020  = NULL,.        
+000721f0: 2020 2020 2020 2020 2e73 6861 7265 6420          .shared 
+00072200: 3d20 2673 7461 7465 5f73 6861 7265 642c  = &state_shared,
+00072210: 0a20 2020 2020 2020 2020 2020 207d 3b0a  .            };.
+00072220: 0a20 2020 2020 2020 2020 2020 2069 6e74  .            int
+00072230: 2072 6320 3d20 6767 6d6c 5f74 6872 6561   rc = ggml_threa
+00072240: 645f 6372 6561 7465 2826 776f 726b 6572  d_create(&worker
+00072250: 735b 6a5d 2e74 6872 642c 204e 554c 4c2c  s[j].thrd, NULL,
+00072260: 2067 676d 6c5f 6772 6170 685f 636f 6d70   ggml_graph_comp
+00072270: 7574 655f 7468 7265 6164 2c20 2677 6f72  ute_thread, &wor
+00072280: 6b65 7273 5b6a 5d29 3b0a 2020 2020 2020  kers[j]);.      
+00072290: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+000722a0: 5428 7263 203d 3d20 3029 3b0a 2020 2020  T(rc == 0);.    
+000722b0: 2020 2020 2020 2020 554e 5553 4544 2872          UNUSED(r
+000722c0: 6329 3b0a 2020 2020 2020 2020 7d0a 2020  c);.        }.  
+000722d0: 2020 7d0a 0a20 2020 202f 2f20 696e 6974    }..    // init
+000722e0: 6961 6c69 7a65 2074 6173 6b73 202b 2077  ialize tasks + w
+000722f0: 6f72 6b20 6275 6666 6572 0a20 2020 207b  ork buffer.    {
+00072300: 0a20 2020 2020 2020 2073 697a 655f 7420  .        size_t 
+00072310: 776f 726b 5f73 697a 6520 3d20 303b 0a0a  work_size = 0;..
+00072320: 2020 2020 2020 2020 2f2f 2074 6872 6561          // threa
+00072330: 6420 7363 6865 6475 6c69 6e67 2066 6f72  d scheduling for
+00072340: 2074 6865 2064 6966 6665 7265 6e74 206f   the different o
+00072350: 7065 7261 7469 6f6e 730a 2020 2020 2020  perations.      
+00072360: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00072370: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+00072380: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+00072390: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+000723a0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+000723b0: 6f64 6520 3d20 6367 7261 7068 2d3e 6e6f  ode = cgraph->no
+000723c0: 6465 735b 695d 3b0a 0a20 2020 2020 2020  des[i];..       
+000723d0: 2020 2020 2073 7769 7463 6820 286e 6f64       switch (nod
+000723e0: 652d 3e6f 7029 207b 0a20 2020 2020 2020  e->op) {.       
+000723f0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00072400: 4d4c 5f4f 505f 4350 593a 0a20 2020 2020  ML_OP_CPY:.     
+00072410: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00072420: 4747 4d4c 5f4f 505f 4455 503a 0a20 2020  GGML_OP_DUP:.   
+00072430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072440: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00072450: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+00072460: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
+00072470: 6561 6473 3b0a 0a20 2020 2020 2020 2020  eads;..         
+00072480: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00072490: 697a 655f 7420 6375 7220 3d20 303b 0a20  ize_t cur = 0;. 
 000724a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000724b0: 2020 6966 2028 6767 6d6c 5f69 735f 7175    if (ggml_is_qu
-000724c0: 616e 7469 7a65 6428 6e6f 6465 2d3e 7479  antized(node->ty
-000724d0: 7065 2929 207b 0a20 2020 2020 2020 2020  pe)) {.         
+000724b0: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
+000724c0: 6973 5f71 7561 6e74 697a 6564 286e 6f64  is_quantized(nod
+000724d0: 652d 3e74 7970 6529 2920 7b0a 2020 2020  e->type)) {.    
 000724e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000724f0: 2020 2063 7572 203d 2047 474d 4c5f 5459     cur = GGML_TY
-00072500: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
-00072510: 455f 4633 325d 202a 206e 6f64 652d 3e6e  E_F32] * node->n
-00072520: 655b 305d 202a 206e 5f74 6872 6561 6473  e[0] * n_threads
-00072530: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00072540: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00072550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072560: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
-00072570: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
-00072580: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
-00072590: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000725a0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-000725b0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000725c0: 4144 443a 0a20 2020 2020 2020 2020 2020  ADD:.           
-000725d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000725e0: 505f 4144 4431 3a0a 2020 2020 2020 2020  P_ADD1:.        
-000725f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00072600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072610: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-00072620: 736b 7320 3d20 6e5f 7468 7265 6164 733b  sks = n_threads;
-00072630: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00072640: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
-00072650: 2063 7572 203d 2030 3b0a 0a20 2020 2020   cur = 0;..     
+000724f0: 2020 2020 2020 2020 6375 7220 3d20 4747          cur = GG
+00072500: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
+00072510: 4c5f 5459 5045 5f46 3332 5d20 2a20 6e6f  L_TYPE_F32] * no
+00072520: 6465 2d3e 6e65 5b30 5d20 2a20 6e5f 7468  de->ne[0] * n_th
+00072530: 7265 6164 733b 0a20 2020 2020 2020 2020  reads;.         
+00072540: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00072550: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00072560: 2020 2020 2020 2020 2020 776f 726b 5f73            work_s
+00072570: 697a 6520 3d20 4d41 5828 776f 726b 5f73  ize = MAX(work_s
+00072580: 697a 652c 2063 7572 293b 0a20 2020 2020  ize, cur);.     
+00072590: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000725a0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000725b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000725c0: 4c5f 4f50 5f41 4444 3a0a 2020 2020 2020  L_OP_ADD:.      
+000725d0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+000725e0: 474d 4c5f 4f50 5f41 4444 313a 0a20 2020  GML_OP_ADD1:.   
+000725f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072600: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00072610: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+00072620: 3e6e 5f74 6173 6b73 203d 206e 5f74 6872  >n_tasks = n_thr
+00072630: 6561 6473 3b0a 0a20 2020 2020 2020 2020  eads;..         
+00072640: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00072650: 697a 655f 7420 6375 7220 3d20 303b 0a0a  ize_t cur = 0;..
 00072660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072670: 2020 2069 6620 2867 676d 6c5f 6973 5f71     if (ggml_is_q
-00072680: 7561 6e74 697a 6564 286e 6f64 652d 3e73  uantized(node->s
-00072690: 7263 302d 3e74 7970 6529 2920 7b0a 2020  rc0->type)) {.  
-000726a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000726b0: 2020 2020 2020 2020 2020 6375 7220 3d20            cur = 
-000726c0: 4747 4d4c 5f54 5950 455f 5349 5a45 5b47  GGML_TYPE_SIZE[G
-000726d0: 474d 4c5f 5459 5045 5f46 3332 5d20 2a20  GML_TYPE_F32] * 
-000726e0: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b30  node->src0->ne[0
-000726f0: 5d20 2a20 6e5f 7468 7265 6164 733b 0a20  ] * n_threads;. 
-00072700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072710: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00072670: 2020 2020 2020 2020 6966 2028 6767 6d6c          if (ggml
+00072680: 5f69 735f 7175 616e 7469 7a65 6428 6e6f  _is_quantized(no
+00072690: 6465 2d3e 7372 6330 2d3e 7479 7065 2929  de->src0->type))
+000726a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000726b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000726c0: 7572 203d 2047 474d 4c5f 5459 5045 5f53  ur = GGML_TYPE_S
+000726d0: 495a 455b 4747 4d4c 5f54 5950 455f 4633  IZE[GGML_TYPE_F3
+000726e0: 325d 202a 206e 6f64 652d 3e73 7263 302d  2] * node->src0-
+000726f0: 3e6e 655b 305d 202a 206e 5f74 6872 6561  >ne[0] * n_threa
+00072700: 6473 3b0a 2020 2020 2020 2020 2020 2020  ds;.            
+00072710: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
 00072720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072730: 2020 776f 726b 5f73 697a 6520 3d20 4d41    work_size = MA
-00072740: 5828 776f 726b 5f73 697a 652c 2063 7572  X(work_size, cur
-00072750: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00072760: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00072770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072780: 6361 7365 2047 474d 4c5f 4f50 5f41 4343  case GGML_OP_ACC
-00072790: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000727a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00072730: 2020 2020 2020 2077 6f72 6b5f 7369 7a65         work_size
+00072740: 203d 204d 4158 2877 6f72 6b5f 7369 7a65   = MAX(work_size
+00072750: 2c20 6375 7229 3b0a 2020 2020 2020 2020  , cur);.        
+00072760: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00072770: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00072780: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00072790: 505f 4143 433a 0a20 2020 2020 2020 2020  P_ACC:.         
+000727a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
 000727b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000727c0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-000727d0: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
-000727e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000727f0: 2020 2020 7369 7a65 5f74 2063 7572 203d      size_t cur =
-00072800: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
-00072810: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00072820: 2867 676d 6c5f 6973 5f71 7561 6e74 697a  (ggml_is_quantiz
-00072830: 6564 286e 6f64 652d 3e73 7263 302d 3e74  ed(node->src0->t
-00072840: 7970 6529 2920 7b0a 2020 2020 2020 2020  ype)) {.        
+000727c0: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
+000727d0: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
+000727e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000727f0: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+00072800: 6375 7220 3d20 303b 0a0a 2020 2020 2020  cur = 0;..      
+00072810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072820: 2020 6966 2028 6767 6d6c 5f69 735f 7175    if (ggml_is_qu
+00072830: 616e 7469 7a65 6428 6e6f 6465 2d3e 7372  antized(node->sr
+00072840: 6330 2d3e 7479 7065 2929 207b 0a20 2020  c0->type)) {.   
 00072850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072860: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
-00072870: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
-00072880: 5045 5f46 3332 5d20 2a20 6e6f 6465 2d3e  PE_F32] * node->
-00072890: 7372 6331 2d3e 6e65 5b30 5d20 2a20 6e5f  src1->ne[0] * n_
-000728a0: 7468 7265 6164 733b 0a20 2020 2020 2020  threads;.       
+00072860: 2020 2020 2020 2020 2063 7572 203d 2047           cur = G
+00072870: 474d 4c5f 5459 5045 5f53 495a 455b 4747  GML_TYPE_SIZE[GG
+00072880: 4d4c 5f54 5950 455f 4633 325d 202a 206e  ML_TYPE_F32] * n
+00072890: 6f64 652d 3e73 7263 312d 3e6e 655b 305d  ode->src1->ne[0]
+000728a0: 202a 206e 5f74 6872 6561 6473 3b0a 2020   * n_threads;.  
 000728b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000728c0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-000728d0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000728e0: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
-000728f0: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
-00072900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072910: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00072920: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00072930: 474d 4c5f 4f50 5f53 5542 3a0a 2020 2020  GML_OP_SUB:.    
-00072940: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00072950: 2047 474d 4c5f 4f50 5f44 4956 3a0a 2020   GGML_OP_DIV:.  
-00072960: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00072970: 7365 2047 474d 4c5f 4f50 5f53 5152 3a0a  se GGML_OP_SQR:.
-00072980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072990: 6361 7365 2047 474d 4c5f 4f50 5f53 5152  case GGML_OP_SQR
-000729a0: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
-000729b0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000729c0: 4c4f 473a 0a20 2020 2020 2020 2020 2020  LOG:.           
-000729d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000729e0: 505f 5355 4d3a 0a20 2020 2020 2020 2020  P_SUM:.         
-000729f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00072a00: 5f4f 505f 5355 4d5f 524f 5753 3a0a 2020  _OP_SUM_ROWS:.  
-00072a10: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00072a20: 7365 2047 474d 4c5f 4f50 5f4d 4541 4e3a  se GGML_OP_MEAN:
-00072a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072a40: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
-00072a50: 5045 4154 3a0a 2020 2020 2020 2020 2020  PEAT:.          
-00072a60: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00072a70: 4f50 5f41 4253 3a0a 2020 2020 2020 2020  OP_ABS:.        
-00072a80: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00072a90: 4c5f 4f50 5f53 474e 3a0a 2020 2020 2020  L_OP_SGN:.      
-00072aa0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00072ab0: 474d 4c5f 4f50 5f4e 4547 3a0a 2020 2020  GML_OP_NEG:.    
-00072ac0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00072ad0: 2047 474d 4c5f 4f50 5f53 5445 503a 0a20   GGML_OP_STEP:. 
-00072ae0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00072af0: 6173 6520 4747 4d4c 5f4f 505f 5245 4c55  ase GGML_OP_RELU
-00072b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00072b10: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000728c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000728d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000728e0: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
+000728f0: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
+00072900: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00072910: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00072920: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00072930: 6173 6520 4747 4d4c 5f4f 505f 5355 423a  ase GGML_OP_SUB:
+00072940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072950: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
+00072960: 563a 0a20 2020 2020 2020 2020 2020 2020  V:.             
+00072970: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00072980: 5351 523a 0a20 2020 2020 2020 2020 2020  SQR:.           
+00072990: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000729a0: 505f 5351 5254 3a0a 2020 2020 2020 2020  P_SQRT:.        
+000729b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000729c0: 4c5f 4f50 5f4c 4f47 3a0a 2020 2020 2020  L_OP_LOG:.      
+000729d0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+000729e0: 474d 4c5f 4f50 5f53 554d 3a0a 2020 2020  GML_OP_SUM:.    
+000729f0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00072a00: 2047 474d 4c5f 4f50 5f53 554d 5f52 4f57   GGML_OP_SUM_ROW
+00072a10: 533a 0a20 2020 2020 2020 2020 2020 2020  S:.             
+00072a20: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00072a30: 4d45 414e 3a0a 2020 2020 2020 2020 2020  MEAN:.          
+00072a40: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00072a50: 4f50 5f52 4550 4541 543a 0a20 2020 2020  OP_REPEAT:.     
+00072a60: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00072a70: 4747 4d4c 5f4f 505f 4142 533a 0a20 2020  GGML_OP_ABS:.   
+00072a80: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00072a90: 6520 4747 4d4c 5f4f 505f 5347 4e3a 0a20  e GGML_OP_SGN:. 
+00072aa0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00072ab0: 6173 6520 4747 4d4c 5f4f 505f 4e45 473a  ase GGML_OP_NEG:
+00072ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072ad0: 2063 6173 6520 4747 4d4c 5f4f 505f 5354   case GGML_OP_ST
+00072ae0: 4550 3a0a 2020 2020 2020 2020 2020 2020  EP:.            
+00072af0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00072b00: 5f52 454c 553a 0a20 2020 2020 2020 2020  _RELU:.         
+00072b10: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
 00072b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072b30: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-00072b40: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
-00072b50: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00072b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072b70: 6361 7365 2047 474d 4c5f 4f50 5f4d 554c  case GGML_OP_MUL
-00072b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00072b90: 2020 6361 7365 2047 474d 4c5f 4f50 5f47    case GGML_OP_G
-00072ba0: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
-00072bb0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00072bc0: 505f 5349 4c55 3a0a 2020 2020 2020 2020  P_SILU:.        
-00072bd0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00072be0: 4c5f 4f50 5f53 494c 555f 4241 434b 3a0a  L_OP_SILU_BACK:.
-00072bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072c00: 6361 7365 2047 474d 4c5f 4f50 5f4e 4f52  case GGML_OP_NOR
-00072c10: 4d3a 0a20 2020 2020 2020 2020 2020 2020  M:.             
-00072c20: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00072c30: 524d 535f 4e4f 524d 3a0a 2020 2020 2020  RMS_NORM:.      
-00072c40: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00072c50: 474d 4c5f 4f50 5f52 4d53 5f4e 4f52 4d5f  GML_OP_RMS_NORM_
-00072c60: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-00072c70: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00072c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072c90: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
-00072ca0: 7320 3d20 6e5f 7468 7265 6164 733b 0a20  s = n_threads;. 
-00072cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072cc0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00072cd0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00072ce0: 2047 474d 4c5f 4f50 5f4d 554c 5f4d 4154   GGML_OP_MUL_MAT
-00072cf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00072d00: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00072b30: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
+00072b40: 6b73 203d 2031 3b0a 2020 2020 2020 2020  ks = 1;.        
+00072b50: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00072b60: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00072b70: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00072b80: 505f 4d55 4c3a 0a20 2020 2020 2020 2020  P_MUL:.         
+00072b90: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00072ba0: 5f4f 505f 4745 4c55 3a0a 2020 2020 2020  _OP_GELU:.      
+00072bb0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00072bc0: 474d 4c5f 4f50 5f53 494c 553a 0a20 2020  GML_OP_SILU:.   
+00072bd0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00072be0: 6520 4747 4d4c 5f4f 505f 5349 4c55 5f42  e GGML_OP_SILU_B
+00072bf0: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
+00072c00: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00072c10: 505f 4e4f 524d 3a0a 2020 2020 2020 2020  P_NORM:.        
+00072c20: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00072c30: 4c5f 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20  L_OP_RMS_NORM:. 
+00072c40: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00072c50: 6173 6520 4747 4d4c 5f4f 505f 524d 535f  ase GGML_OP_RMS_
+00072c60: 4e4f 524d 5f42 4143 4b3a 0a20 2020 2020  NORM_BACK:.     
+00072c70: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00072c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072c90: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+00072ca0: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
+00072cb0: 6473 3b0a 2020 2020 2020 2020 2020 2020  ds;.            
+00072cc0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00072cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072ce0: 2063 6173 6520 4747 4d4c 5f4f 505f 4d55   case GGML_OP_MU
+00072cf0: 4c5f 4d41 543a 0a20 2020 2020 2020 2020  L_MAT:.         
+00072d00: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
 00072d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072d20: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-00072d30: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
-00072d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072d50: 2020 2020 2f2f 2054 4f44 4f3a 2075 7365      // TODO: use
-00072d60: 2064 6966 6665 7265 6e74 2073 6368 6564   different sched
-00072d70: 756c 696e 6720 666f 7220 6469 6666 6572  uling for differ
-00072d80: 656e 7420 6d61 7472 6978 2073 697a 6573  ent matrix sizes
-00072d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072da0: 2020 2020 2020 2020 202f 2f63 6f6e 7374           //const
-00072db0: 2069 6e74 206e 7230 203d 2067 676d 6c5f   int nr0 = ggml_
-00072dc0: 6e72 6f77 7328 6e6f 6465 2d3e 7372 6330  nrows(node->src0
-00072dd0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00072de0: 2020 2020 2020 2020 2020 202f 2f63 6f6e             //con
-00072df0: 7374 2069 6e74 206e 7231 203d 2067 676d  st int nr1 = ggm
-00072e00: 6c5f 6e72 6f77 7328 6e6f 6465 2d3e 7372  l_nrows(node->sr
-00072e10: 6331 293b 0a0a 2020 2020 2020 2020 2020  c1);..          
-00072e20: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00072e30: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
-00072e40: 4d49 4e28 6e5f 7468 7265 6164 732c 204d  MIN(n_threads, M
-00072e50: 4158 2831 2c20 6e72 302f 3132 3829 293b  AX(1, nr0/128));
-00072e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072e70: 2020 2020 2020 2020 202f 2f70 7269 6e74           //print
-00072e80: 6628 226e 7230 203d 2025 3864 2c20 6e72  f("nr0 = %8d, nr
-00072e90: 3120 3d20 2538 642c 206e 7230 2a6e 7231  1 = %8d, nr0*nr1
-00072ea0: 203d 2025 3864 2c20 6e5f 7461 736b 7320   = %8d, n_tasks 
-00072eb0: 3d20 2564 5c6e 222c 206e 7230 2c20 6e72  = %d\n", nr0, nr
-00072ec0: 312c 206e 7230 2a6e 7231 2c20 6e6f 6465  1, nr0*nr1, node
-00072ed0: 2d3e 6e5f 7461 736b 7329 3b0a 0a20 2020  ->n_tasks);..   
-00072ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072ef0: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
-00072f00: 3d20 303b 0a0a 2369 6620 6465 6669 6e65  = 0;..#if define
-00072f10: 6428 4747 4d4c 5f55 5345 5f43 5542 4c41  d(GGML_USE_CUBLA
-00072f20: 5329 0a20 2020 2020 2020 2020 2020 2020  S).             
-00072f30: 2020 2020 2020 2020 2020 2069 6620 2867             if (g
-00072f40: 676d 6c5f 6375 6461 5f63 616e 5f6d 756c  gml_cuda_can_mul
-00072f50: 5f6d 6174 286e 6f64 652d 3e73 7263 302c  _mat(node->src0,
-00072f60: 206e 6f64 652d 3e73 7263 312c 206e 6f64   node->src1, nod
-00072f70: 6529 2920 7b0a 2020 2020 2020 2020 2020  e)) {.          
+00072d20: 2020 2020 206e 6f64 652d 3e6e 5f74 6173       node->n_tas
+00072d30: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
+00072d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00072d50: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
+00072d60: 3a20 7573 6520 6469 6666 6572 656e 7420  : use different 
+00072d70: 7363 6865 6475 6c69 6e67 2066 6f72 2064  scheduling for d
+00072d80: 6966 6665 7265 6e74 206d 6174 7269 7820  ifferent matrix 
+00072d90: 7369 7a65 730a 2020 2020 2020 2020 2020  sizes.          
+00072da0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00072db0: 636f 6e73 7420 696e 7420 6e72 3020 3d20  const int nr0 = 
+00072dc0: 6767 6d6c 5f6e 726f 7773 286e 6f64 652d  ggml_nrows(node-
+00072dd0: 3e73 7263 3029 3b0a 2020 2020 2020 2020  >src0);.        
+00072de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072df0: 2f2f 636f 6e73 7420 696e 7420 6e72 3120  //const int nr1 
+00072e00: 3d20 6767 6d6c 5f6e 726f 7773 286e 6f64  = ggml_nrows(nod
+00072e10: 652d 3e73 7263 3129 3b0a 0a20 2020 2020  e->src1);..     
+00072e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072e30: 2020 202f 2f6e 6f64 652d 3e6e 5f74 6173     //node->n_tas
+00072e40: 6b73 203d 204d 494e 286e 5f74 6872 6561  ks = MIN(n_threa
+00072e50: 6473 2c20 4d41 5828 312c 206e 7230 2f31  ds, MAX(1, nr0/1
+00072e60: 3238 2929 3b0a 2020 2020 2020 2020 2020  28));.          
+00072e70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00072e80: 7072 696e 7466 2822 6e72 3020 3d20 2538  printf("nr0 = %8
+00072e90: 642c 206e 7231 203d 2025 3864 2c20 6e72  d, nr1 = %8d, nr
+00072ea0: 302a 6e72 3120 3d20 2538 642c 206e 5f74  0*nr1 = %8d, n_t
+00072eb0: 6173 6b73 203d 2025 645c 6e22 2c20 6e72  asks = %d\n", nr
+00072ec0: 302c 206e 7231 2c20 6e72 302a 6e72 312c  0, nr1, nr0*nr1,
+00072ed0: 206e 6f64 652d 3e6e 5f74 6173 6b73 293b   node->n_tasks);
+00072ee0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00072ef0: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
+00072f00: 2063 7572 203d 2030 3b0a 0a23 6966 2064   cur = 0;..#if d
+00072f10: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
+00072f20: 4355 424c 4153 290a 2020 2020 2020 2020  CUBLAS).        
+00072f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072f40: 6966 2028 6767 6d6c 5f63 7564 615f 6361  if (ggml_cuda_ca
+00072f50: 6e5f 6d75 6c5f 6d61 7428 6e6f 6465 2d3e  n_mul_mat(node->
+00072f60: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
+00072f70: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
 00072f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072f90: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
-00072fa0: 3d20 313b 202f 2f20 544f 444f 3a20 7468  = 1; // TODO: th
-00072fb0: 6973 2061 6374 7561 6c6c 7920 6973 2064  is actually is d
-00072fc0: 6f69 6e67 206e 6f74 6869 6e67 0a20 2020  oing nothing.   
-00072fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072f90: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+00072fa0: 6173 6b73 203d 2031 3b20 2f2f 2054 4f44  asks = 1; // TOD
+00072fb0: 4f3a 2074 6869 7320 6163 7475 616c 6c79  O: this actually
+00072fc0: 2069 7320 646f 696e 6720 6e6f 7468 696e   is doing nothin
+00072fd0: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
 00072fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072ff0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00073000: 2020 2020 2020 7468 6520 7468 7265 6164        the thread
-00073010: 7320 6172 6520 7374 696c 6c20 7370 696e  s are still spin
-00073020: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
+00072ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073000: 2020 2f2f 2020 2020 2020 2074 6865 2074    //       the t
+00073010: 6872 6561 6473 2061 7265 2073 7469 6c6c  hreads are still
+00073020: 2073 7069 6e6e 696e 670a 2020 2020 2020   spinning.      
 00073030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073040: 2063 7572 203d 2067 676d 6c5f 6375 6461   cur = ggml_cuda
-00073050: 5f6d 756c 5f6d 6174 5f67 6574 5f77 7369  _mul_mat_get_wsi
-00073060: 7a65 286e 6f64 652d 3e73 7263 302c 206e  ze(node->src0, n
-00073070: 6f64 652d 3e73 7263 312c 206e 6f64 6529  ode->src1, node)
-00073080: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00073090: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000730a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000730b0: 2020 2020 656c 7365 0a23 656c 6966 2064      else.#elif d
-000730c0: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
-000730d0: 434c 424c 4153 5429 0a20 2020 2020 2020  CLBLAST).       
+00073040: 2020 2020 2020 6375 7220 3d20 6767 6d6c        cur = ggml
+00073050: 5f63 7564 615f 6d75 6c5f 6d61 745f 6765  _cuda_mul_mat_ge
+00073060: 745f 7773 697a 6528 6e6f 6465 2d3e 7372  t_wsize(node->sr
+00073070: 6330 2c20 6e6f 6465 2d3e 7372 6331 2c20  c0, node->src1, 
+00073080: 6e6f 6465 293b 0a20 2020 2020 2020 2020  node);.         
+00073090: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000730a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000730b0: 2020 2020 2020 2020 2065 6c73 650a 2365           else.#e
+000730c0: 6c69 6620 6465 6669 6e65 6428 4747 4d4c  lif defined(GGML
+000730d0: 5f55 5345 5f43 4c42 4c41 5354 290a 2020  _USE_CLBLAST).  
 000730e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000730f0: 2069 6620 2867 676d 6c5f 636c 5f63 616e   if (ggml_cl_can
-00073100: 5f6d 756c 5f6d 6174 286e 6f64 652d 3e73  _mul_mat(node->s
-00073110: 7263 302c 206e 6f64 652d 3e73 7263 312c  rc0, node->src1,
-00073120: 206e 6f64 6529 2920 7b0a 2020 2020 2020   node)) {.      
+000730f0: 2020 2020 2020 6966 2028 6767 6d6c 5f63        if (ggml_c
+00073100: 6c5f 6361 6e5f 6d75 6c5f 6d61 7428 6e6f  l_can_mul_mat(no
+00073110: 6465 2d3e 7372 6330 2c20 6e6f 6465 2d3e  de->src0, node->
+00073120: 7372 6331 2c20 6e6f 6465 2929 207b 0a20  src1, node)) {. 
 00073130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073140: 2020 2020 2020 6e6f 6465 2d3e 6e5f 7461        node->n_ta
-00073150: 736b 7320 3d20 313b 202f 2f20 544f 444f  sks = 1; // TODO
-00073160: 3a20 7468 6973 2061 6374 7561 6c6c 7920  : this actually 
-00073170: 6973 2064 6f69 6e67 206e 6f74 6869 6e67  is doing nothing
-00073180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073140: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
+00073150: 3e6e 5f74 6173 6b73 203d 2031 3b20 2f2f  >n_tasks = 1; //
+00073160: 2054 4f44 4f3a 2074 6869 7320 6163 7475   TODO: this actu
+00073170: 616c 6c79 2069 7320 646f 696e 6720 6e6f  ally is doing no
+00073180: 7468 696e 670a 2020 2020 2020 2020 2020  thing.          
 00073190: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000731a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000731b0: 202f 2f20 2020 2020 2020 7468 6520 7468   //       the th
-000731c0: 7265 6164 7320 6172 6520 7374 696c 6c20  reads are still 
-000731d0: 7370 696e 6e69 6e67 0a20 2020 2020 2020  spinning.       
+000731b0: 2020 2020 2020 2f2f 2020 2020 2020 2074        //       t
+000731c0: 6865 2074 6872 6561 6473 2061 7265 2073  he threads are s
+000731d0: 7469 6c6c 2073 7069 6e6e 696e 670a 2020  till spinning.  
 000731e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000731f0: 2020 2020 2063 7572 203d 2067 676d 6c5f       cur = ggml_
-00073200: 636c 5f6d 756c 5f6d 6174 5f67 6574 5f77  cl_mul_mat_get_w
-00073210: 7369 7a65 286e 6f64 652d 3e73 7263 302c  size(node->src0,
-00073220: 206e 6f64 652d 3e73 7263 312c 206e 6f64   node->src1, nod
-00073230: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00073240: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00073250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073260: 2020 2020 2020 656c 7365 0a23 656e 6469        else.#endi
-00073270: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-00073280: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
-00073290: 6465 2d3e 7372 6330 2d3e 7479 7065 203d  de->src0->type =
-000732a0: 3d20 4747 4d4c 5f54 5950 455f 4631 3620  = GGML_TYPE_F16 
-000732b0: 2626 206e 6f64 652d 3e73 7263 312d 3e74  && node->src1->t
-000732c0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-000732d0: 5f46 3332 2920 7b0a 2369 6620 6465 6669  _F32) {.#if defi
-000732e0: 6e65 6428 4747 4d4c 5f55 5345 5f41 4343  ned(GGML_USE_ACC
-000732f0: 454c 4552 4154 4529 207c 7c20 6465 6669  ELERATE) || defi
-00073300: 6e65 6428 4747 4d4c 5f55 5345 5f4f 5045  ned(GGML_USE_OPE
-00073310: 4e42 4c41 5329 0a20 2020 2020 2020 2020  NBLAS).         
+000731f0: 2020 2020 2020 2020 2020 6375 7220 3d20            cur = 
+00073200: 6767 6d6c 5f63 6c5f 6d75 6c5f 6d61 745f  ggml_cl_mul_mat_
+00073210: 6765 745f 7773 697a 6528 6e6f 6465 2d3e  get_wsize(node->
+00073220: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
+00073230: 2c20 6e6f 6465 293b 0a20 2020 2020 2020  , node);.       
+00073240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073250: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00073260: 2020 2020 2020 2020 2020 2065 6c73 650a             else.
+00073270: 2365 6e64 6966 0a20 2020 2020 2020 2020  #endif.         
+00073280: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00073290: 6620 286e 6f64 652d 3e73 7263 302d 3e74  f (node->src0->t
+000732a0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+000732b0: 5f46 3136 2026 2620 6e6f 6465 2d3e 7372  _F16 && node->sr
+000732c0: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
+000732d0: 5f54 5950 455f 4633 3229 207b 0a23 6966  _TYPE_F32) {.#if
+000732e0: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+000732f0: 455f 4143 4345 4c45 5241 5445 2920 7c7c  E_ACCELERATE) ||
+00073300: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+00073310: 455f 4f50 454e 424c 4153 290a 2020 2020  E_OPENBLAS).    
 00073320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073330: 2020 2069 6620 2867 676d 6c5f 636f 6d70     if (ggml_comp
-00073340: 7574 655f 666f 7277 6172 645f 6d75 6c5f  ute_forward_mul_
-00073350: 6d61 745f 7573 655f 626c 6173 286e 6f64  mat_use_blas(nod
-00073360: 652d 3e73 7263 302c 206e 6f64 652d 3e73  e->src0, node->s
-00073370: 7263 312c 206e 6f64 6529 2920 7b0a 2020  rc1, node)) {.  
-00073380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073390: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-000733a0: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
-000733b0: 202f 2f20 544f 444f 3a20 7468 6973 2061   // TODO: this a
-000733c0: 6374 7561 6c6c 7920 6973 2064 6f69 6e67  ctually is doing
-000733d0: 206e 6f74 6869 6e67 0a20 2020 2020 2020   nothing.       
+00073330: 2020 2020 2020 2020 6966 2028 6767 6d6c          if (ggml
+00073340: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00073350: 5f6d 756c 5f6d 6174 5f75 7365 5f62 6c61  _mul_mat_use_bla
+00073360: 7328 6e6f 6465 2d3e 7372 6330 2c20 6e6f  s(node->src0, no
+00073370: 6465 2d3e 7372 6331 2c20 6e6f 6465 2929  de->src1, node))
+00073380: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00073390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000733a0: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
+000733b0: 203d 2031 3b20 2f2f 2054 4f44 4f3a 2074   = 1; // TODO: t
+000733c0: 6869 7320 6163 7475 616c 6c79 2069 7320  his actually is 
+000733d0: 646f 696e 6720 6e6f 7468 696e 670a 2020  doing nothing.  
 000733e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000733f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073400: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-00073410: 2020 2020 2074 6865 2074 6872 6561 6473       the threads
-00073420: 2061 7265 2073 7469 6c6c 2073 7069 6e6e   are still spinn
-00073430: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00073400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073410: 202f 2f20 2020 2020 2020 7468 6520 7468   //       the th
+00073420: 7265 6164 7320 6172 6520 7374 696c 6c20  reads are still 
+00073430: 7370 696e 6e69 6e67 0a20 2020 2020 2020  spinning.       
 00073440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073450: 2020 2020 2f2f 2068 6572 6520 7765 206e      // here we n
-00073460: 6565 6420 6d65 6d6f 7279 206a 7573 7420  eed memory just 
-00073470: 666f 7220 7369 6e67 6c65 2032 4420 6d61  for single 2D ma
-00073480: 7472 6978 2066 726f 6d20 7372 6330 0a20  trix from src0. 
-00073490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000734a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000734b0: 7572 203d 2047 474d 4c5f 5459 5045 5f53  ur = GGML_TYPE_S
-000734c0: 495a 455b 4747 4d4c 5f54 5950 455f 4633  IZE[GGML_TYPE_F3
-000734d0: 325d 2a28 6e6f 6465 2d3e 7372 6330 2d3e  2]*(node->src0->
-000734e0: 6e65 5b30 5d2a 6e6f 6465 2d3e 7372 6330  ne[0]*node->src0
-000734f0: 2d3e 6e65 5b31 5d29 3b0a 2020 2020 2020  ->ne[1]);.      
+00073450: 2020 2020 2020 2020 202f 2f20 6865 7265           // here
+00073460: 2077 6520 6e65 6564 206d 656d 6f72 7920   we need memory 
+00073470: 6a75 7374 2066 6f72 2073 696e 676c 6520  just for single 
+00073480: 3244 206d 6174 7269 7820 6672 6f6d 2073  2D matrix from s
+00073490: 7263 300a 2020 2020 2020 2020 2020 2020  rc0.            
+000734a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000734b0: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
+000734c0: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
+000734d0: 5045 5f46 3332 5d2a 286e 6f64 652d 3e73  PE_F32]*(node->s
+000734e0: 7263 302d 3e6e 655b 305d 2a6e 6f64 652d  rc0->ne[0]*node-
+000734f0: 3e73 7263 302d 3e6e 655b 315d 293b 0a20  >src0->ne[1]);. 
 00073500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073510: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-00073520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073530: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00073540: 7572 203d 2047 474d 4c5f 5459 5045 5f53  ur = GGML_TYPE_S
-00073550: 495a 455b 4747 4d4c 5f54 5950 455f 4631  IZE[GGML_TYPE_F1
-00073560: 365d 2a67 676d 6c5f 6e65 6c65 6d65 6e74  6]*ggml_nelement
-00073570: 7328 6e6f 6465 2d3e 7372 6331 293b 0a20  s(node->src1);. 
-00073580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073590: 2020 2020 2020 2020 2020 207d 0a23 656c             }.#el
-000735a0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-000735b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000735c0: 7572 203d 2047 474d 4c5f 5459 5045 5f53  ur = GGML_TYPE_S
-000735d0: 495a 455b 4747 4d4c 5f54 5950 455f 4631  IZE[GGML_TYPE_F1
-000735e0: 365d 2a67 676d 6c5f 6e65 6c65 6d65 6e74  6]*ggml_nelement
-000735f0: 7328 6e6f 6465 2d3e 7372 6331 293b 0a23  s(node->src1);.#
-00073600: 656e 6469 660a 2020 2020 2020 2020 2020  endif.          
-00073610: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00073620: 656c 7365 2069 6620 286e 6f64 652d 3e73  else if (node->s
-00073630: 7263 302d 3e74 7970 6520 3d3d 2047 474d  rc0->type == GGM
-00073640: 4c5f 5459 5045 5f46 3332 2026 2620 6e6f  L_TYPE_F32 && no
-00073650: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
-00073660: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-00073670: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00073680: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00073690: 7572 203d 2030 3b0a 2369 6620 6465 6669  ur = 0;.#if defi
-000736a0: 6e65 6428 4747 4d4c 5f55 5345 5f41 4343  ned(GGML_USE_ACC
-000736b0: 454c 4552 4154 4529 207c 7c20 6465 6669  ELERATE) || defi
-000736c0: 6e65 6428 4747 4d4c 5f55 5345 5f4f 5045  ned(GGML_USE_OPE
-000736d0: 4e42 4c41 5329 0a20 2020 2020 2020 2020  NBLAS).         
+00073510: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
+00073520: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+00073530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073540: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
+00073550: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
+00073560: 5045 5f46 3136 5d2a 6767 6d6c 5f6e 656c  PE_F16]*ggml_nel
+00073570: 656d 656e 7473 286e 6f64 652d 3e73 7263  ements(node->src
+00073580: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+00073590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000735a0: 7d0a 2365 6c73 650a 2020 2020 2020 2020  }.#else.        
+000735b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000735c0: 2020 2020 6375 7220 3d20 4747 4d4c 5f54      cur = GGML_T
+000735d0: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
+000735e0: 5045 5f46 3136 5d2a 6767 6d6c 5f6e 656c  PE_F16]*ggml_nel
+000735f0: 656d 656e 7473 286e 6f64 652d 3e73 7263  ements(node->src
+00073600: 3129 3b0a 2365 6e64 6966 0a20 2020 2020  1);.#endif.     
+00073610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073620: 2020 207d 2065 6c73 6520 6966 2028 6e6f     } else if (no
+00073630: 6465 2d3e 7372 6330 2d3e 7479 7065 203d  de->src0->type =
+00073640: 3d20 4747 4d4c 5f54 5950 455f 4633 3220  = GGML_TYPE_F32 
+00073650: 2626 206e 6f64 652d 3e73 7263 312d 3e74  && node->src1->t
+00073660: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00073670: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
+00073680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073690: 2020 2020 6375 7220 3d20 303b 0a23 6966      cur = 0;.#if
+000736a0: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+000736b0: 455f 4143 4345 4c45 5241 5445 2920 7c7c  E_ACCELERATE) ||
+000736c0: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
+000736d0: 455f 4f50 454e 424c 4153 290a 2020 2020  E_OPENBLAS).    
 000736e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000736f0: 2020 2069 6620 2867 676d 6c5f 636f 6d70     if (ggml_comp
-00073700: 7574 655f 666f 7277 6172 645f 6d75 6c5f  ute_forward_mul_
-00073710: 6d61 745f 7573 655f 626c 6173 286e 6f64  mat_use_blas(nod
-00073720: 652d 3e73 7263 302c 206e 6f64 652d 3e73  e->src0, node->s
-00073730: 7263 312c 206e 6f64 6529 2920 7b0a 2020  rc1, node)) {.  
-00073740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073750: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00073760: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
-00073770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073780: 2020 2020 2020 2020 2020 2020 207d 0a23               }.#
-00073790: 656e 6469 660a 2020 2020 2020 2020 2020  endif.          
-000737a0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-000737b0: 656c 7365 2069 6620 2867 676d 6c5f 6973  else if (ggml_is
-000737c0: 5f71 7561 6e74 697a 6564 286e 6f64 652d  _quantized(node-
-000737d0: 3e73 7263 302d 3e74 7970 6529 2026 2620  >src0->type) && 
-000737e0: 6e6f 6465 2d3e 7372 6331 2d3e 7479 7065  node->src1->type
-000737f0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-00073800: 3229 207b 0a23 6966 2064 6566 696e 6564  2) {.#if defined
-00073810: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
-00073820: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
-00073830: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
-00073840: 4153 290a 2020 2020 2020 2020 2020 2020  AS).            
+000736f0: 2020 2020 2020 2020 6966 2028 6767 6d6c          if (ggml
+00073700: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00073710: 5f6d 756c 5f6d 6174 5f75 7365 5f62 6c61  _mul_mat_use_bla
+00073720: 7328 6e6f 6465 2d3e 7372 6330 2c20 6e6f  s(node->src0, no
+00073730: 6465 2d3e 7372 6331 2c20 6e6f 6465 2929  de->src1, node))
+00073740: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00073750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073760: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
+00073770: 203d 2031 3b0a 2020 2020 2020 2020 2020   = 1;.          
+00073780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073790: 2020 7d0a 2365 6e64 6966 0a20 2020 2020    }.#endif.     
+000737a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000737b0: 2020 207d 2065 6c73 6520 6966 2028 6767     } else if (gg
+000737c0: 6d6c 5f69 735f 7175 616e 7469 7a65 6428  ml_is_quantized(
+000737d0: 6e6f 6465 2d3e 7372 6330 2d3e 7479 7065  node->src0->type
+000737e0: 2920 2626 206e 6f64 652d 3e73 7263 312d  ) && node->src1-
+000737f0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00073800: 5045 5f46 3332 2920 7b0a 2369 6620 6465  PE_F32) {.#if de
+00073810: 6669 6e65 6428 4747 4d4c 5f55 5345 5f41  fined(GGML_USE_A
+00073820: 4343 454c 4552 4154 4529 207c 7c20 6465  CCELERATE) || de
+00073830: 6669 6e65 6428 4747 4d4c 5f55 5345 5f4f  fined(GGML_USE_O
+00073840: 5045 4e42 4c41 5329 0a20 2020 2020 2020  PENBLAS).       
 00073850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073860: 6966 2028 6767 6d6c 5f63 6f6d 7075 7465  if (ggml_compute
-00073870: 5f66 6f72 7761 7264 5f6d 756c 5f6d 6174  _forward_mul_mat
-00073880: 5f75 7365 5f62 6c61 7328 6e6f 6465 2d3e  _use_blas(node->
-00073890: 7372 6330 2c20 6e6f 6465 2d3e 7372 6331  src0, node->src1
-000738a0: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
+00073860: 2020 2020 2069 6620 2867 676d 6c5f 636f       if (ggml_co
+00073870: 6d70 7574 655f 666f 7277 6172 645f 6d75  mpute_forward_mu
+00073880: 6c5f 6d61 745f 7573 655f 626c 6173 286e  l_mat_use_blas(n
+00073890: 6f64 652d 3e73 7263 302c 206e 6f64 652d  ode->src0, node-
+000738a0: 3e73 7263 312c 206e 6f64 6529 2920 7b0a  >src1, node)) {.
 000738b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000738c0: 2020 2020 2020 2020 2020 206e 6f64 652d             node-
-000738d0: 3e6e 5f74 6173 6b73 203d 2031 3b0a 2020  >n_tasks = 1;.  
-000738e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000738f0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00073900: 7220 3d20 4747 4d4c 5f54 5950 455f 5349  r = GGML_TYPE_SI
-00073910: 5a45 5b47 474d 4c5f 5459 5045 5f46 3332  ZE[GGML_TYPE_F32
-00073920: 5d2a 286e 6f64 652d 3e73 7263 302d 3e6e  ]*(node->src0->n
-00073930: 655b 305d 2a6e 6f64 652d 3e73 7263 302d  e[0]*node->src0-
-00073940: 3e6e 655b 315d 293b 0a20 2020 2020 2020  >ne[1]);.       
+000738c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000738d0: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3d20  node->n_tasks = 
+000738e0: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+000738f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073900: 2020 2063 7572 203d 2047 474d 4c5f 5459     cur = GGML_TY
+00073910: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
+00073920: 455f 4633 325d 2a28 6e6f 6465 2d3e 7372  E_F32]*(node->sr
+00073930: 6330 2d3e 6e65 5b30 5d2a 6e6f 6465 2d3e  c0->ne[0]*node->
+00073940: 7372 6330 2d3e 6e65 5b31 5d29 3b0a 2020  src0->ne[1]);.  
 00073950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073960: 2020 2020 207d 2065 6c73 650a 2365 6e64       } else.#end
-00073970: 6966 0a20 2020 2020 2020 2020 2020 2020  if.             
-00073980: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00073990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073960: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+00073970: 0a23 656e 6469 660a 2020 2020 2020 2020  .#endif.        
+00073980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073990: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
 000739a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000739b0: 2063 6f6e 7374 2065 6e75 6d20 6767 6d6c   const enum ggml
-000739c0: 5f74 7970 6520 7479 7065 5f71 203d 2071  _type type_q = q
-000739d0: 7561 6e74 697a 655f 666e 735b 6e6f 6465  uantize_fns[node
-000739e0: 2d3e 7372 6330 2d3e 7479 7065 5d2e 7665  ->src0->type].ve
-000739f0: 635f 646f 745f 7479 7065 3b0a 2020 2020  c_dot_type;.    
-00073a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073a10: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-00073a20: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-00073a30: 5b74 7970 655f 715d 2a67 676d 6c5f 6e65  [type_q]*ggml_ne
-00073a40: 6c65 6d65 6e74 7328 6e6f 6465 2d3e 7372  lements(node->sr
-00073a50: 6331 292f 4747 4d4c 5f42 4c43 4b5f 5349  c1)/GGML_BLCK_SI
-00073a60: 5a45 5b74 7970 655f 715d 3b0a 2020 2020  ZE[type_q];.    
-00073a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073a80: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000739b0: 2020 2020 2020 636f 6e73 7420 656e 756d        const enum
+000739c0: 2067 676d 6c5f 7479 7065 2074 7970 655f   ggml_type type_
+000739d0: 7120 3d20 7175 616e 7469 7a65 5f66 6e73  q = quantize_fns
+000739e0: 5b6e 6f64 652d 3e73 7263 302d 3e74 7970  [node->src0->typ
+000739f0: 655d 2e76 6563 5f64 6f74 5f74 7970 653b  e].vec_dot_type;
+00073a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073a20: 2063 7572 203d 2047 474d 4c5f 5459 5045   cur = GGML_TYPE
+00073a30: 5f53 495a 455b 7479 7065 5f71 5d2a 6767  _SIZE[type_q]*gg
+00073a40: 6d6c 5f6e 656c 656d 656e 7473 286e 6f64  ml_nelements(nod
+00073a50: 652d 3e73 7263 3129 2f47 474d 4c5f 424c  e->src1)/GGML_BL
+00073a60: 434b 5f53 495a 455b 7479 7065 5f71 5d3b  CK_SIZE[type_q];
+00073a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073a80: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
 00073a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073aa0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00073aa0: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
 00073ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073ac0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00073ad0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00073ac0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00073ad0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
 00073ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073af0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00073b00: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00073b10: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
-00073b20: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
-00073b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073b40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00073b50: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00073b60: 2047 474d 4c5f 4f50 5f53 4341 4c45 3a0a   GGML_OP_SCALE:.
-00073b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073b80: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00073b90: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00073ba0: 6465 2d3e 6e5f 7461 736b 7320 3d20 6e5f  de->n_tasks = n_
-00073bb0: 7468 7265 6164 733b 0a20 2020 2020 2020  threads;.       
-00073bc0: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-00073bd0: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-00073be0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00073bf0: 4f50 5f53 4554 3a0a 2020 2020 2020 2020  OP_SET:.        
-00073c00: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00073c10: 4c5f 4f50 5f43 4f4e 543a 0a20 2020 2020  L_OP_CONT:.     
-00073c20: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00073c30: 4747 4d4c 5f4f 505f 5245 5348 4150 453a  GGML_OP_RESHAPE:
-00073c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073c50: 2063 6173 6520 4747 4d4c 5f4f 505f 5649   case GGML_OP_VI
-00073c60: 4557 3a0a 2020 2020 2020 2020 2020 2020  EW:.            
-00073c70: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00073c80: 5f50 4552 4d55 5445 3a0a 2020 2020 2020  _PERMUTE:.      
-00073c90: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00073ca0: 474d 4c5f 4f50 5f54 5241 4e53 504f 5345  GML_OP_TRANSPOSE
-00073cb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00073cc0: 2020 6361 7365 2047 474d 4c5f 4f50 5f47    case GGML_OP_G
-00073cd0: 4554 5f52 4f57 533a 0a20 2020 2020 2020  ET_ROWS:.       
-00073ce0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00073cf0: 4d4c 5f4f 505f 4745 545f 524f 5753 5f42  ML_OP_GET_ROWS_B
-00073d00: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
-00073d10: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00073d20: 505f 4449 4147 3a0a 2020 2020 2020 2020  P_DIAG:.        
-00073d30: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00073d40: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f5a  L_OP_DIAG_MASK_Z
-00073d50: 4552 4f3a 0a20 2020 2020 2020 2020 2020  ERO:.           
-00073d60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00073af0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00073b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073b10: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
+00073b20: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
+00073b30: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00073b40: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00073b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073b60: 2063 6173 6520 4747 4d4c 5f4f 505f 5343   case GGML_OP_SC
+00073b70: 414c 453a 0a20 2020 2020 2020 2020 2020  ALE:.           
+00073b80: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00073b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073ba0: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
+00073bb0: 203d 206e 5f74 6872 6561 6473 3b0a 2020   = n_threads;.  
+00073bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073bd0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00073be0: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00073bf0: 4747 4d4c 5f4f 505f 5345 543a 0a20 2020  GGML_OP_SET:.   
+00073c00: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00073c10: 6520 4747 4d4c 5f4f 505f 434f 4e54 3a0a  e GGML_OP_CONT:.
+00073c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073c30: 6361 7365 2047 474d 4c5f 4f50 5f52 4553  case GGML_OP_RES
+00073c40: 4841 5045 3a0a 2020 2020 2020 2020 2020  HAPE:.          
+00073c50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00073c60: 4f50 5f56 4945 573a 0a20 2020 2020 2020  OP_VIEW:.       
+00073c70: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00073c80: 4d4c 5f4f 505f 5045 524d 5554 453a 0a20  ML_OP_PERMUTE:. 
+00073c90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00073ca0: 6173 6520 4747 4d4c 5f4f 505f 5452 414e  ase GGML_OP_TRAN
+00073cb0: 5350 4f53 453a 0a20 2020 2020 2020 2020  SPOSE:.         
+00073cc0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00073cd0: 5f4f 505f 4745 545f 524f 5753 3a0a 2020  _OP_GET_ROWS:.  
+00073ce0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00073cf0: 7365 2047 474d 4c5f 4f50 5f47 4554 5f52  se GGML_OP_GET_R
+00073d00: 4f57 535f 4241 434b 3a0a 2020 2020 2020  OWS_BACK:.      
+00073d10: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00073d20: 474d 4c5f 4f50 5f44 4941 473a 0a20 2020  GML_OP_DIAG:.   
+00073d30: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+00073d40: 6520 4747 4d4c 5f4f 505f 4449 4147 5f4d  e GGML_OP_DIAG_M
+00073d50: 4153 4b5f 5a45 524f 3a0a 2020 2020 2020  ASK_ZERO:.      
+00073d60: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00073d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073d80: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-00073d90: 203d 2031 3b0a 2020 2020 2020 2020 2020   = 1;.          
-00073da0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00073db0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00073dc0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00073dd0: 4449 4147 5f4d 4153 4b5f 494e 463a 0a20  DIAG_MASK_INF:. 
-00073de0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00073df0: 6173 6520 4747 4d4c 5f4f 505f 534f 4654  ase GGML_OP_SOFT
-00073e00: 5f4d 4158 3a0a 2020 2020 2020 2020 2020  _MAX:.          
-00073e10: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00073e20: 4f50 5f52 4f50 453a 0a20 2020 2020 2020  OP_ROPE:.       
-00073e30: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00073e40: 4d4c 5f4f 505f 524f 5045 5f42 4143 4b3a  ML_OP_ROPE_BACK:
-00073e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073e60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00073e70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00073e80: 6f64 652d 3e6e 5f74 6173 6b73 203d 206e  ode->n_tasks = n
-00073e90: 5f74 6872 6561 6473 3b0a 2020 2020 2020  _threads;.      
-00073ea0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00073eb0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00073ec0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00073ed0: 5f4f 505f 414c 4942 493a 0a20 2020 2020  _OP_ALIBI:.     
-00073ee0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00073ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00073f00: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-00073f10: 5f74 6173 6b73 203d 2031 3b20 2f2f 544f  _tasks = 1; //TO
-00073f20: 444f 0a20 2020 2020 2020 2020 2020 2020  DO.             
-00073f30: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00073f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073f50: 6361 7365 2047 474d 4c5f 4f50 5f43 4c41  case GGML_OP_CLA
-00073f60: 4d50 3a0a 2020 2020 2020 2020 2020 2020  MP:.            
-00073f70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00073d80: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+00073d90: 7461 736b 7320 3d20 313b 0a20 2020 2020  tasks = 1;.     
+00073da0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00073db0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00073dc0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00073dd0: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f49  L_OP_DIAG_MASK_I
+00073de0: 4e46 3a0a 2020 2020 2020 2020 2020 2020  NF:.            
+00073df0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00073e00: 5f53 4f46 545f 4d41 583a 0a20 2020 2020  _SOFT_MAX:.     
+00073e10: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00073e20: 4747 4d4c 5f4f 505f 524f 5045 3a0a 2020  GGML_OP_ROPE:.  
+00073e30: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00073e40: 7365 2047 474d 4c5f 4f50 5f52 4f50 455f  se GGML_OP_ROPE_
+00073e50: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
+00073e60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00073e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073e80: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
+00073e90: 7320 3d20 6e5f 7468 7265 6164 733b 0a20  s = n_threads;. 
+00073ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073eb0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00073ec0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00073ed0: 2047 474d 4c5f 4f50 5f41 4c49 4249 3a0a   GGML_OP_ALIBI:.
+00073ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073ef0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00073f00: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00073f10: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
+00073f20: 202f 2f54 4f44 4f0a 2020 2020 2020 2020   //TODO.        
+00073f30: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00073f40: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00073f50: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00073f60: 505f 434c 414d 503a 0a20 2020 2020 2020  P_CLAMP:.       
+00073f70: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
 00073f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073f90: 2020 6e6f 6465 2d3e 6e5f 7461 736b 7320    node->n_tasks 
-00073fa0: 3d20 313b 202f 2f54 4f44 4f0a 2020 2020  = 1; //TODO.    
-00073fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073fc0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00073fd0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00073fe0: 4d4c 5f4f 505f 434f 4e56 5f31 445f 5331  ML_OP_CONV_1D_S1
-00073ff0: 5f50 483a 0a20 2020 2020 2020 2020 2020  _PH:.           
-00074000: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00074010: 505f 434f 4e56 5f31 445f 5332 5f50 483a  P_CONV_1D_S2_PH:
-00074020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074030: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00074040: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00074050: 6f64 652d 3e6e 5f74 6173 6b73 203d 206e  ode->n_tasks = n
-00074060: 5f74 6872 6561 6473 3b0a 0a20 2020 2020  _threads;..     
+00073f90: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
+00073fa0: 6173 6b73 203d 2031 3b20 2f2f 544f 444f  asks = 1; //TODO
+00073fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00073fc0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00073fd0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00073fe0: 7365 2047 474d 4c5f 4f50 5f43 4f4e 565f  se GGML_OP_CONV_
+00073ff0: 3144 5f53 315f 5048 3a0a 2020 2020 2020  1D_S1_PH:.      
+00074000: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00074010: 474d 4c5f 4f50 5f43 4f4e 565f 3144 5f53  GML_OP_CONV_1D_S
+00074020: 325f 5048 3a0a 2020 2020 2020 2020 2020  2_PH:.          
+00074030: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00074040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074050: 2020 2020 6e6f 6465 2d3e 6e5f 7461 736b      node->n_task
+00074060: 7320 3d20 6e5f 7468 7265 6164 733b 0a0a  s = n_threads;..
 00074070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074080: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00074090: 6f64 652d 3e73 7263 302d 3e6e 655b 335d  ode->src0->ne[3]
-000740a0: 203d 3d20 3129 3b0a 2020 2020 2020 2020   == 1);.        
+00074080: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00074090: 4552 5428 6e6f 6465 2d3e 7372 6330 2d3e  ERT(node->src0->
+000740a0: 6e65 5b33 5d20 3d3d 2031 293b 0a20 2020  ne[3] == 1);.   
 000740b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000740c0: 4747 4d4c 5f41 5353 4552 5428 6e6f 6465  GGML_ASSERT(node
-000740d0: 2d3e 7372 6331 2d3e 6e65 5b32 5d20 3d3d  ->src1->ne[2] ==
-000740e0: 2031 293b 0a20 2020 2020 2020 2020 2020   1);.           
-000740f0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00074100: 4c5f 4153 5345 5254 286e 6f64 652d 3e73  L_ASSERT(node->s
-00074110: 7263 312d 3e6e 655b 335d 203d 3d20 3129  rc1->ne[3] == 1)
-00074120: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00074130: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-00074140: 7420 6375 7220 3d20 303b 0a20 2020 2020  t cur = 0;.     
+000740c0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+000740d0: 286e 6f64 652d 3e73 7263 312d 3e6e 655b  (node->src1->ne[
+000740e0: 325d 203d 3d20 3129 3b0a 2020 2020 2020  2] == 1);.      
+000740f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074100: 2020 4747 4d4c 5f41 5353 4552 5428 6e6f    GGML_ASSERT(no
+00074110: 6465 2d3e 7372 6331 2d3e 6e65 5b33 5d20  de->src1->ne[3] 
+00074120: 3d3d 2031 293b 0a0a 2020 2020 2020 2020  == 1);..        
+00074130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074140: 7369 7a65 5f74 2063 7572 203d 2030 3b0a  size_t cur = 0;.
 00074150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074160: 2020 2063 6f6e 7374 2069 6e74 206e 6b20     const int nk 
-00074170: 3d20 6e6f 6465 2d3e 7372 6330 2d3e 6e65  = node->src0->ne
-00074180: 5b30 5d3b 0a0a 2020 2020 2020 2020 2020  [0];..          
-00074190: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000741a0: 2028 6e6f 6465 2d3e 7372 6330 2d3e 7479   (node->src0->ty
-000741b0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-000741c0: 4631 3620 2626 0a20 2020 2020 2020 2020  F16 &&.         
+00074160: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00074170: 7420 6e6b 203d 206e 6f64 652d 3e73 7263  t nk = node->src
+00074180: 302d 3e6e 655b 305d 3b0a 0a20 2020 2020  0->ne[0];..     
+00074190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000741a0: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
+000741b0: 302d 3e74 7970 6520 3d3d 2047 474d 4c5f  0->type == GGML_
+000741c0: 5459 5045 5f46 3136 2026 260a 2020 2020  TYPE_F16 &&.    
 000741d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000741e0: 2020 206e 6f64 652d 3e73 7263 312d 3e74     node->src1->t
-000741f0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00074200: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
+000741e0: 2020 2020 2020 2020 6e6f 6465 2d3e 7372          node->sr
+000741f0: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
+00074200: 5f54 5950 455f 4633 3229 207b 0a20 2020  _TYPE_F32) {.   
 00074210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074220: 2020 2020 6375 7220 3d20 7369 7a65 6f66      cur = sizeof
-00074230: 2867 676d 6c5f 6670 3136 5f74 292a 280a  (ggml_fp16_t)*(.
-00074240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074220: 2020 2020 2020 2020 2063 7572 203d 2073           cur = s
+00074230: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+00074240: 7429 2a28 0a20 2020 2020 2020 2020 2020  t)*(.           
 00074250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074260: 2020 2020 6e6b 2a67 676d 6c5f 7570 3332      nk*ggml_up32
-00074270: 286e 6f64 652d 3e73 7263 302d 3e6e 655b  (node->src0->ne[
-00074280: 315d 292a 6e6f 6465 2d3e 7372 6330 2d3e  1])*node->src0->
-00074290: 6e65 5b32 5d20 2b0a 2020 2020 2020 2020  ne[2] +.        
+00074260: 2020 2020 2020 2020 206e 6b2a 6767 6d6c           nk*ggml
+00074270: 5f75 7033 3228 6e6f 6465 2d3e 7372 6330  _up32(node->src0
+00074280: 2d3e 6e65 5b31 5d29 2a6e 6f64 652d 3e73  ->ne[1])*node->s
+00074290: 7263 302d 3e6e 655b 325d 202b 0a20 2020  rc0->ne[2] +.   
 000742a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000742b0: 2020 2020 2020 2020 2020 2020 2820 322a              ( 2*
-000742c0: 286e 6b2f 3229 202b 206e 6f64 652d 3e73  (nk/2) + node->s
-000742d0: 7263 312d 3e6e 655b 305d 292a 6e6f 6465  rc1->ne[0])*node
-000742e0: 2d3e 7372 6331 2d3e 6e65 5b31 5d0a 2020  ->src1->ne[1].  
-000742f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000742b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000742c0: 2028 2032 2a28 6e6b 2f32 2920 2b20 6e6f   ( 2*(nk/2) + no
+000742d0: 6465 2d3e 7372 6331 2d3e 6e65 5b30 5d29  de->src1->ne[0])
+000742e0: 2a6e 6f64 652d 3e73 7263 312d 3e6e 655b  *node->src1->ne[
+000742f0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
 00074300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074310: 2020 293b 0a20 2020 2020 2020 2020 2020    );.           
-00074320: 2020 2020 2020 2020 2020 2020 207d 2065               } e
-00074330: 6c73 6520 6966 2028 6e6f 6465 2d3e 7372  lse if (node->sr
-00074340: 6330 2d3e 7479 7065 203d 3d20 4747 4d4c  c0->type == GGML
-00074350: 5f54 5950 455f 4633 3220 2626 0a20 2020  _TYPE_F32 &&.   
-00074360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074310: 2020 2020 2020 2029 3b0a 2020 2020 2020         );.      
+00074320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074330: 2020 7d20 656c 7365 2069 6620 286e 6f64    } else if (nod
+00074340: 652d 3e73 7263 302d 3e74 7970 6520 3d3d  e->src0->type ==
+00074350: 2047 474d 4c5f 5459 5045 5f46 3332 2026   GGML_TYPE_F32 &
+00074360: 260a 2020 2020 2020 2020 2020 2020 2020  &.              
 00074370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074380: 6e6f 6465 2d3e 7372 6331 2d3e 7479 7065  node->src1->type
-00074390: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
-000743a0: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
+00074380: 2020 2020 206e 6f64 652d 3e73 7263 312d       node->src1-
+00074390: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+000743a0: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
 000743b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000743c0: 2063 7572 203d 2073 697a 656f 6628 666c   cur = sizeof(fl
-000743d0: 6f61 7429 2a28 0a20 2020 2020 2020 2020  oat)*(.         
+000743c0: 2020 2020 2020 6375 7220 3d20 7369 7a65        cur = size
+000743d0: 6f66 2866 6c6f 6174 292a 280a 2020 2020  of(float)*(.    
 000743e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000743f0: 2020 2020 2020 2020 2020 206e 6b2a 6767             nk*gg
-00074400: 6d6c 5f75 7033 3228 6e6f 6465 2d3e 7372  ml_up32(node->sr
-00074410: 6330 2d3e 6e65 5b31 5d29 2a6e 6f64 652d  c0->ne[1])*node-
-00074420: 3e73 7263 302d 3e6e 655b 325d 202b 0a20  >src0->ne[2] +. 
-00074430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000743f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074400: 6e6b 2a67 676d 6c5f 7570 3332 286e 6f64  nk*ggml_up32(nod
+00074410: 652d 3e73 7263 302d 3e6e 655b 315d 292a  e->src0->ne[1])*
+00074420: 6e6f 6465 2d3e 7372 6330 2d3e 6e65 5b32  node->src0->ne[2
+00074430: 5d20 2b0a 2020 2020 2020 2020 2020 2020  ] +.            
 00074440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074450: 2020 2028 2032 2a28 6e6b 2f32 2920 2b20     ( 2*(nk/2) + 
-00074460: 6e6f 6465 2d3e 7372 6331 2d3e 6e65 5b30  node->src1->ne[0
-00074470: 5d29 2a6e 6f64 652d 3e73 7263 312d 3e6e  ])*node->src1->n
-00074480: 655b 315d 0a20 2020 2020 2020 2020 2020  e[1].           
+00074450: 2020 2020 2020 2020 2820 322a 286e 6b2f          ( 2*(nk/
+00074460: 3229 202b 206e 6f64 652d 3e73 7263 312d  2) + node->src1-
+00074470: 3e6e 655b 305d 292a 6e6f 6465 2d3e 7372  >ne[0])*node->sr
+00074480: 6331 2d3e 6e65 5b31 5d0a 2020 2020 2020  c1->ne[1].      
 00074490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000744a0: 2020 2020 2020 2020 2029 3b0a 2020 2020           );.    
-000744b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000744c0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-000744d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000744e0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-000744f0: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00074500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074510: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+000744a0: 2020 2020 2020 2020 2020 2020 2020 293b                );
+000744b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000744c0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+000744d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000744e0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+000744f0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00074500: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00074510: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
 00074520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074530: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
-00074540: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
-00074550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074560: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00074570: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00074580: 7365 2047 474d 4c5f 4f50 5f43 4f4e 565f  se GGML_OP_CONV_
-00074590: 3244 5f53 4b5f 5030 3a0a 2020 2020 2020  2D_SK_P0:.      
-000745a0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-000745b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000745c0: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
-000745d0: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
-000745e0: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-000745f0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00074600: 5f41 5353 4552 5428 6e6f 6465 2d3e 7372  _ASSERT(node->sr
-00074610: 6331 2d3e 6e65 5b33 5d20 3d3d 2031 293b  c1->ne[3] == 1);
-00074620: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00074630: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00074640: 696e 7436 345f 7420 6e65 3030 203d 206e  int64_t ne00 = n
-00074650: 6f64 652d 3e73 7263 302d 3e6e 655b 305d  ode->src0->ne[0]
-00074660: 3b20 2f2f 2057 0a20 2020 2020 2020 2020  ; // W.         
-00074670: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00074680: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
-00074690: 3120 3d20 6e6f 6465 2d3e 7372 6330 2d3e  1 = node->src0->
-000746a0: 6e65 5b31 5d3b 202f 2f20 480a 2020 2020  ne[1]; // H.    
-000746b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000746c0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000746d0: 7420 6e65 3032 203d 206e 6f64 652d 3e73  t ne02 = node->s
-000746e0: 7263 302d 3e6e 655b 325d 3b20 2f2f 2043  rc0->ne[2]; // C
-000746f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074700: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00074710: 6e74 3634 5f74 206e 6530 3320 3d20 6e6f  nt64_t ne03 = no
-00074720: 6465 2d3e 7372 6330 2d3e 6e65 5b33 5d3b  de->src0->ne[3];
-00074730: 202f 2f20 4e0a 0a20 2020 2020 2020 2020   // N..         
-00074740: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00074750: 6f6e 7374 2069 6e74 3634 5f74 206e 6531  onst int64_t ne1
-00074760: 3020 3d20 6e6f 6465 2d3e 7372 6331 2d3e  0 = node->src1->
-00074770: 6e65 5b30 5d3b 202f 2f20 570a 2020 2020  ne[0]; // W.    
-00074780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074790: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000747a0: 7420 6e65 3131 203d 206e 6f64 652d 3e73  t ne11 = node->s
-000747b0: 7263 312d 3e6e 655b 315d 3b20 2f2f 2048  rc1->ne[1]; // H
-000747c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000747d0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-000747e0: 6e74 3634 5f74 206e 6531 3220 3d20 6e6f  nt64_t ne12 = no
-000747f0: 6465 2d3e 7372 6331 2d3e 6e65 5b32 5d3b  de->src1->ne[2];
-00074800: 202f 2f20 430a 0a20 2020 2020 2020 2020   // C..         
-00074810: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00074820: 6f6e 7374 2069 6e74 3634 5f74 206e 6b20  onst int64_t nk 
-00074830: 3d20 6e65 3030 2a6e 6530 313b 0a0a 2020  = ne00*ne01;..  
-00074840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074850: 2020 2020 2020 554e 5553 4544 286e 6530        UNUSED(ne0
-00074860: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
-00074870: 2020 2020 2020 2020 2020 2020 554e 5553              UNUS
-00074880: 4544 286e 6530 3329 3b0a 2020 2020 2020  ED(ne03);.      
+00074530: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
+00074540: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
+00074550: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
+00074560: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00074570: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00074580: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00074590: 434f 4e56 5f32 445f 534b 5f50 303a 0a20  CONV_2D_SK_P0:. 
+000745a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000745b0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000745c0: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+000745d0: 652d 3e6e 5f74 6173 6b73 203d 206e 5f74  e->n_tasks = n_t
+000745e0: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
+000745f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074600: 2047 474d 4c5f 4153 5345 5254 286e 6f64   GGML_ASSERT(nod
+00074610: 652d 3e73 7263 312d 3e6e 655b 335d 203d  e->src1->ne[3] =
+00074620: 3d20 3129 3b0a 0a20 2020 2020 2020 2020  = 1);..         
+00074630: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00074640: 6f6e 7374 2069 6e74 3634 5f74 206e 6530  onst int64_t ne0
+00074650: 3020 3d20 6e6f 6465 2d3e 7372 6330 2d3e  0 = node->src0->
+00074660: 6e65 5b30 5d3b 202f 2f20 570a 2020 2020  ne[0]; // W.    
+00074670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074680: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00074690: 7420 6e65 3031 203d 206e 6f64 652d 3e73  t ne01 = node->s
+000746a0: 7263 302d 3e6e 655b 315d 3b20 2f2f 2048  rc0->ne[1]; // H
+000746b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000746c0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+000746d0: 6e74 3634 5f74 206e 6530 3220 3d20 6e6f  nt64_t ne02 = no
+000746e0: 6465 2d3e 7372 6330 2d3e 6e65 5b32 5d3b  de->src0->ne[2];
+000746f0: 202f 2f20 430a 2020 2020 2020 2020 2020   // C.          
+00074700: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00074710: 6e73 7420 696e 7436 345f 7420 6e65 3033  nst int64_t ne03
+00074720: 203d 206e 6f64 652d 3e73 7263 302d 3e6e   = node->src0->n
+00074730: 655b 335d 3b20 2f2f 204e 0a0a 2020 2020  e[3]; // N..    
+00074740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074750: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00074760: 7420 6e65 3130 203d 206e 6f64 652d 3e73  t ne10 = node->s
+00074770: 7263 312d 3e6e 655b 305d 3b20 2f2f 2057  rc1->ne[0]; // W
+00074780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074790: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+000747a0: 6e74 3634 5f74 206e 6531 3120 3d20 6e6f  nt64_t ne11 = no
+000747b0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d3b  de->src1->ne[1];
+000747c0: 202f 2f20 480a 2020 2020 2020 2020 2020   // H.          
+000747d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000747e0: 6e73 7420 696e 7436 345f 7420 6e65 3132  nst int64_t ne12
+000747f0: 203d 206e 6f64 652d 3e73 7263 312d 3e6e   = node->src1->n
+00074800: 655b 325d 3b20 2f2f 2043 0a0a 2020 2020  e[2]; // C..    
+00074810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074820: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00074830: 7420 6e6b 203d 206e 6530 302a 6e65 3031  t nk = ne00*ne01
+00074840: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00074850: 2020 2020 2020 2020 2020 2055 4e55 5345             UNUSE
+00074860: 4428 6e65 3032 293b 0a20 2020 2020 2020  D(ne02);.       
+00074870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074880: 2055 4e55 5345 4428 6e65 3033 293b 0a20   UNUSED(ne03);. 
 00074890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000748a0: 2020 554e 5553 4544 286e 6b29 3b0a 0a20    UNUSED(nk);.. 
-000748b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000748c0: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-000748d0: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
+000748a0: 2020 2020 2020 2055 4e55 5345 4428 6e6b         UNUSED(nk
+000748b0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+000748c0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+000748d0: 5f74 2063 7572 203d 2030 3b0a 0a20 2020  _t cur = 0;..   
 000748e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000748f0: 6966 2028 6e6f 6465 2d3e 7372 6330 2d3e  if (node->src0->
-00074900: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-00074910: 455f 4631 3620 2626 0a20 2020 2020 2020  E_F16 &&.       
+000748f0: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
+00074900: 7263 302d 3e74 7970 6520 3d3d 2047 474d  rc0->type == GGM
+00074910: 4c5f 5459 5045 5f46 3136 2026 260a 2020  L_TYPE_F16 &&.  
 00074920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074930: 2020 2020 206e 6f64 652d 3e73 7263 312d       node->src1-
-00074940: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00074950: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
+00074930: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
+00074940: 7372 6331 2d3e 7479 7065 203d 3d20 4747  src1->type == GG
+00074950: 4d4c 5f54 5950 455f 4633 3229 207b 0a20  ML_TYPE_F32) {. 
 00074960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074970: 2020 2020 2020 6375 7220 3d20 7369 7a65        cur = size
-00074980: 6f66 2867 676d 6c5f 6670 3136 5f74 292a  of(ggml_fp16_t)*
-00074990: 286e 6531 302a 6e65 3131 2a6e 6531 3229  (ne10*ne11*ne12)
-000749a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000749b0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-000749c0: 2069 6620 286e 6f64 652d 3e73 7263 302d   if (node->src0-
-000749d0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-000749e0: 5045 5f46 3332 2026 260a 2020 2020 2020  PE_F32 &&.      
+00074970: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
+00074980: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
+00074990: 365f 7429 2a28 6e65 3130 2a6e 6531 312a  6_t)*(ne10*ne11*
+000749a0: 6e65 3132 293b 0a20 2020 2020 2020 2020  ne12);.         
+000749b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000749c0: 2065 6c73 6520 6966 2028 6e6f 6465 2d3e   else if (node->
+000749d0: 7372 6330 2d3e 7479 7065 203d 3d20 4747  src0->type == GG
+000749e0: 4d4c 5f54 5950 455f 4633 3220 2626 0a20  ML_TYPE_F32 &&. 
 000749f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074a00: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00074a10: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
-00074a20: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
-00074a30: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00074a40: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00074a50: 7220 3d20 7369 7a65 6f66 2866 6c6f 6174  r = sizeof(float
-00074a60: 292a 2020 2020 2020 286e 6531 302a 6e65  )*      (ne10*ne
-00074a70: 3131 2a6e 6531 3229 3b0a 2020 2020 2020  11*ne12);.      
+00074a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074a10: 2020 6e6f 6465 2d3e 7372 6331 2d3e 7479    node->src1->ty
+00074a20: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00074a30: 4633 3229 207b 0a20 2020 2020 2020 2020  F32) {.         
+00074a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074a50: 2020 2063 7572 203d 2073 697a 656f 6628     cur = sizeof(
+00074a60: 666c 6f61 7429 2a20 2020 2020 2028 6e65  float)*      (ne
+00074a70: 3130 2a6e 6531 312a 6e65 3132 293b 0a20  10*ne11*ne12);. 
 00074a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074a90: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00074a90: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
 00074aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074ab0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00074ac0: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+00074ab0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00074ac0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
 00074ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074ae0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00074af0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00074b00: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
-00074b10: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
-00074b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074b30: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00074b40: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00074b50: 2047 474d 4c5f 4f50 5f46 4c41 5348 5f41   GGML_OP_FLASH_A
-00074b60: 5454 4e3a 0a20 2020 2020 2020 2020 2020  TTN:.           
-00074b70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00074ae0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00074af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074b00: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
+00074b10: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
+00074b20: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00074b30: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00074b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074b50: 2063 6173 6520 4747 4d4c 5f4f 505f 464c   case GGML_OP_FL
+00074b60: 4153 485f 4154 544e 3a0a 2020 2020 2020  ASH_ATTN:.      
+00074b70: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00074b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074b90: 2020 206e 6f64 652d 3e6e 5f74 6173 6b73     node->n_tasks
-00074ba0: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
-00074bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074bc0: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-00074bd0: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
+00074b90: 2020 2020 2020 2020 6e6f 6465 2d3e 6e5f          node->n_
+00074ba0: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
+00074bb0: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
+00074bc0: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+00074bd0: 5f74 2063 7572 203d 2030 3b0a 0a20 2020  _t cur = 0;..   
 00074be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074bf0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
-00074c00: 3131 203d 2067 676d 6c5f 7570 286e 6f64  11 = ggml_up(nod
-00074c10: 652d 3e73 7263 312d 3e6e 655b 315d 2c20  e->src1->ne[1], 
-00074c20: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
-00074c30: 524f 4c4c 293b 0a0a 2020 2020 2020 2020  ROLL);..        
+00074bf0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+00074c00: 5f74 206e 6531 3120 3d20 6767 6d6c 5f75  _t ne11 = ggml_u
+00074c10: 7028 6e6f 6465 2d3e 7372 6331 2d3e 6e65  p(node->src1->ne
+00074c20: 5b31 5d2c 2047 474d 4c5f 534f 4654 5f4d  [1], GGML_SOFT_M
+00074c30: 4158 5f55 4e52 4f4c 4c29 3b0a 0a20 2020  AX_UNROLL);..   
 00074c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074c50: 6966 2028 6e6f 6465 2d3e 7372 6331 2d3e  if (node->src1->
-00074c60: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-00074c70: 455f 4633 3229 207b 0a20 2020 2020 2020  E_F32) {.       
+00074c50: 2020 2020 2069 6620 286e 6f64 652d 3e73       if (node->s
+00074c60: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
+00074c70: 4c5f 5459 5045 5f46 3332 2920 7b0a 2020  L_TYPE_F32) {.  
 00074c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074c90: 2020 2020 2063 7572 2020 3d20 7369 7a65       cur  = size
-00074ca0: 6f66 2866 6c6f 6174 292a 6e65 3131 2a6e  of(float)*ne11*n
-00074cb0: 6f64 652d 3e6e 5f74 6173 6b73 3b20 2f2f  ode->n_tasks; //
-00074cc0: 2054 4f44 4f3a 2074 6869 7320 6361 6e20   TODO: this can 
-00074cd0: 6265 636f 6d65 2028 6e5f 7461 736b 732d  become (n_tasks-
-00074ce0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
-00074cf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00074d00: 7572 202b 3d20 7369 7a65 6f66 2866 6c6f  ur += sizeof(flo
-00074d10: 6174 292a 6e65 3131 2a6e 6f64 652d 3e6e  at)*ne11*node->n
-00074d20: 5f74 6173 6b73 3b20 2f2f 2074 6869 7320  _tasks; // this 
-00074d30: 6973 206f 7665 7265 7374 696d 6174 6564  is overestimated
-00074d40: 2062 7920 7832 0a20 2020 2020 2020 2020   by x2.         
-00074d50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00074d60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00074d70: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
-00074d80: 6465 2d3e 7372 6331 2d3e 7479 7065 203d  de->src1->type =
-00074d90: 3d20 4747 4d4c 5f54 5950 455f 4631 3629  = GGML_TYPE_F16)
-00074da0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00074db0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00074dc0: 7572 2020 3d20 7369 7a65 6f66 2866 6c6f  ur  = sizeof(flo
-00074dd0: 6174 292a 6e65 3131 2a6e 6f64 652d 3e6e  at)*ne11*node->n
-00074de0: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
-00074df0: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
-00074e00: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
-00074e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074e20: 2020 2020 2020 2020 2063 7572 202b 3d20           cur += 
-00074e30: 7369 7a65 6f66 2866 6c6f 6174 292a 6e65  sizeof(float)*ne
-00074e40: 3131 2a6e 6f64 652d 3e6e 5f74 6173 6b73  11*node->n_tasks
-00074e50: 3b20 2f2f 2074 6869 7320 6973 206f 7665  ; // this is ove
-00074e60: 7265 7374 696d 6174 6564 2062 7920 7832  restimated by x2
-00074e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074e80: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00074e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074ea0: 2020 2020 776f 726b 5f73 697a 6520 3d20      work_size = 
-00074eb0: 4d41 5828 776f 726b 5f73 697a 652c 2063  MAX(work_size, c
-00074ec0: 7572 293b 0a20 2020 2020 2020 2020 2020  ur);.           
-00074ed0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00074ee0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00074ef0: 2020 6361 7365 2047 474d 4c5f 4f50 5f46    case GGML_OP_F
-00074f00: 4c41 5348 5f46 463a 0a20 2020 2020 2020  LASH_FF:.       
-00074f10: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00074f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074f30: 2020 2020 2020 206e 6f64 652d 3e6e 5f74         node->n_t
-00074f40: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
-00074f50: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00074f60: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-00074f70: 7420 6375 7220 3d20 303b 0a0a 2020 2020  t cur = 0;..    
-00074f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074f90: 2020 2020 6966 2028 6e6f 6465 2d3e 7372      if (node->sr
-00074fa0: 6331 2d3e 7479 7065 203d 3d20 4747 4d4c  c1->type == GGML
-00074fb0: 5f54 5950 455f 4633 3229 207b 0a20 2020  _TYPE_F32) {.   
-00074fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074fd0: 2020 2020 2020 2020 2063 7572 2020 3d20           cur  = 
-00074fe0: 7369 7a65 6f66 2866 6c6f 6174 292a 6e6f  sizeof(float)*no
-00074ff0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2a  de->src1->ne[1]*
-00075000: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
-00075010: 2f20 544f 444f 3a20 7468 6973 2063 616e  / TODO: this can
-00075020: 2062 6563 6f6d 6520 286e 5f74 6173 6b73   become (n_tasks
-00075030: 2d31 290a 2020 2020 2020 2020 2020 2020  -1).            
+00074c90: 2020 2020 2020 2020 2020 6375 7220 203d            cur  =
+00074ca0: 2073 697a 656f 6628 666c 6f61 7429 2a6e   sizeof(float)*n
+00074cb0: 6531 312a 6e6f 6465 2d3e 6e5f 7461 736b  e11*node->n_task
+00074cc0: 733b 202f 2f20 544f 444f 3a20 7468 6973  s; // TODO: this
+00074cd0: 2063 616e 2062 6563 6f6d 6520 286e 5f74   can become (n_t
+00074ce0: 6173 6b73 2d31 290a 2020 2020 2020 2020  asks-1).        
+00074cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074d00: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
+00074d10: 6628 666c 6f61 7429 2a6e 6531 312a 6e6f  f(float)*ne11*no
+00074d20: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
+00074d30: 7468 6973 2069 7320 6f76 6572 6573 7469  this is overesti
+00074d40: 6d61 7465 6420 6279 2078 320a 2020 2020  mated by x2.    
+00074d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074d60: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00074d70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00074d80: 6620 286e 6f64 652d 3e73 7263 312d 3e74  f (node->src1->t
+00074d90: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00074da0: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
+00074db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074dc0: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
+00074dd0: 6628 666c 6f61 7429 2a6e 6531 312a 6e6f  f(float)*ne11*no
+00074de0: 6465 2d3e 6e5f 7461 736b 733b 202f 2f20  de->n_tasks; // 
+00074df0: 544f 444f 3a20 7468 6973 2063 616e 2062  TODO: this can b
+00074e00: 6563 6f6d 6520 286e 5f74 6173 6b73 2d31  ecome (n_tasks-1
+00074e10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00074e20: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00074e30: 7220 2b3d 2073 697a 656f 6628 666c 6f61  r += sizeof(floa
+00074e40: 7429 2a6e 6531 312a 6e6f 6465 2d3e 6e5f  t)*ne11*node->n_
+00074e50: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
+00074e60: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
+00074e70: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
+00074e80: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00074e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074ea0: 2020 2020 2020 2020 2077 6f72 6b5f 7369           work_si
+00074eb0: 7a65 203d 204d 4158 2877 6f72 6b5f 7369  ze = MAX(work_si
+00074ec0: 7a65 2c20 6375 7229 3b0a 2020 2020 2020  ze, cur);.      
+00074ed0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+00074ee0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+00074ef0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00074f00: 5f4f 505f 464c 4153 485f 4646 3a0a 2020  _OP_FLASH_FF:.  
+00074f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074f20: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00074f30: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00074f40: 2d3e 6e5f 7461 736b 7320 3d20 6e5f 7468  ->n_tasks = n_th
+00074f50: 7265 6164 733b 0a0a 2020 2020 2020 2020  reads;..        
+00074f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074f70: 7369 7a65 5f74 2063 7572 203d 2030 3b0a  size_t cur = 0;.
+00074f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00074f90: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
+00074fa0: 652d 3e73 7263 312d 3e74 7970 6520 3d3d  e->src1->type ==
+00074fb0: 2047 474d 4c5f 5459 5045 5f46 3332 2920   GGML_TYPE_F32) 
+00074fc0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00074fd0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00074fe0: 7220 203d 2073 697a 656f 6628 666c 6f61  r  = sizeof(floa
+00074ff0: 7429 2a6e 6f64 652d 3e73 7263 312d 3e6e  t)*node->src1->n
+00075000: 655b 315d 2a6e 6f64 652d 3e6e 5f74 6173  e[1]*node->n_tas
+00075010: 6b73 3b20 2f2f 2054 4f44 4f3a 2074 6869  ks; // TODO: thi
+00075020: 7320 6361 6e20 6265 636f 6d65 2028 6e5f  s can become (n_
+00075030: 7461 736b 732d 3129 0a20 2020 2020 2020  tasks-1).       
 00075040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075050: 6375 7220 2b3d 2073 697a 656f 6628 666c  cur += sizeof(fl
-00075060: 6f61 7429 2a6e 6f64 652d 3e73 7263 312d  oat)*node->src1-
-00075070: 3e6e 655b 315d 2a6e 6f64 652d 3e6e 5f74  >ne[1]*node->n_t
-00075080: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
-00075090: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
-000750a0: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
-000750b0: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-000750c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000750d0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-000750e0: 2d3e 7372 6331 2d3e 7479 7065 203d 3d20  ->src1->type == 
-000750f0: 4747 4d4c 5f54 5950 455f 4631 3629 207b  GGML_TYPE_F16) {
-00075100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075110: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00075120: 2020 3d20 7369 7a65 6f66 2866 6c6f 6174    = sizeof(float
-00075130: 292a 6e6f 6465 2d3e 7372 6331 2d3e 6e65  )*node->src1->ne
-00075140: 5b31 5d2a 6e6f 6465 2d3e 6e5f 7461 736b  [1]*node->n_task
-00075150: 733b 202f 2f20 544f 444f 3a20 7468 6973  s; // TODO: this
-00075160: 2063 616e 2062 6563 6f6d 6520 286e 5f74   can become (n_t
-00075170: 6173 6b73 2d31 290a 2020 2020 2020 2020  asks-1).        
+00075050: 2020 2020 2063 7572 202b 3d20 7369 7a65       cur += size
+00075060: 6f66 2866 6c6f 6174 292a 6e6f 6465 2d3e  of(float)*node->
+00075070: 7372 6331 2d3e 6e65 5b31 5d2a 6e6f 6465  src1->ne[1]*node
+00075080: 2d3e 6e5f 7461 736b 733b 202f 2f20 7468  ->n_tasks; // th
+00075090: 6973 2069 7320 6f76 6572 6573 7469 6d61  is is overestima
+000750a0: 7465 6420 6279 2078 320a 2020 2020 2020  ted by x2.      
+000750b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000750c0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+000750d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000750e0: 286e 6f64 652d 3e73 7263 312d 3e74 7970  (node->src1->typ
+000750f0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+00075100: 3136 2920 7b0a 2020 2020 2020 2020 2020  16) {.          
+00075110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075120: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
+00075130: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
+00075140: 312d 3e6e 655b 315d 2a6e 6f64 652d 3e6e  1->ne[1]*node->n
+00075150: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
+00075160: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
+00075170: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
 00075180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075190: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
-000751a0: 6628 666c 6f61 7429 2a6e 6f64 652d 3e73  f(float)*node->s
-000751b0: 7263 312d 3e6e 655b 315d 2a6e 6f64 652d  rc1->ne[1]*node-
-000751c0: 3e6e 5f74 6173 6b73 3b20 2f2f 2074 6869  >n_tasks; // thi
-000751d0: 7320 6973 206f 7665 7265 7374 696d 6174  s is overestimat
-000751e0: 6564 2062 7920 7832 0a20 2020 2020 2020  ed by x2.       
+00075190: 2020 2020 2020 2020 2063 7572 202b 3d20           cur += 
+000751a0: 7369 7a65 6f66 2866 6c6f 6174 292a 6e6f  sizeof(float)*no
+000751b0: 6465 2d3e 7372 6331 2d3e 6e65 5b31 5d2a  de->src1->ne[1]*
+000751c0: 6e6f 6465 2d3e 6e5f 7461 736b 733b 202f  node->n_tasks; /
+000751d0: 2f20 7468 6973 2069 7320 6f76 6572 6573  / this is overes
+000751e0: 7469 6d61 7465 6420 6279 2078 320a 2020  timated by x2.  
 000751f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075200: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00075210: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00075220: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
-00075230: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
-00075240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075250: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00075260: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00075270: 474d 4c5f 4f50 5f57 494e 5f50 4152 543a  GML_OP_WIN_PART:
-00075280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075290: 2063 6173 6520 4747 4d4c 5f4f 505f 5749   case GGML_OP_WI
-000752a0: 4e5f 554e 5041 5254 3a0a 2020 2020 2020  N_UNPART:.      
-000752b0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-000752c0: 474d 4c5f 4f50 5f4d 4150 5f55 4e41 5259  GML_OP_MAP_UNARY
-000752d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000752e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-000752f0: 4150 5f42 494e 4152 593a 0a20 2020 2020  AP_BINARY:.     
-00075300: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00075310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075320: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
-00075330: 5f74 6173 6b73 203d 2031 3b0a 2020 2020  _tasks = 1;.    
-00075340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075350: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00075360: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00075370: 4d4c 5f4f 505f 4e4f 4e45 3a0a 2020 2020  ML_OP_NONE:.    
-00075380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075390: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000753a0: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-000753b0: 6e5f 7461 736b 7320 3d20 313b 0a20 2020  n_tasks = 1;.   
-000753c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000753d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000753e0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-000753f0: 474d 4c5f 4f50 5f43 4f55 4e54 3a0a 2020  GML_OP_COUNT:.  
-00075400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075410: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00075420: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00075430: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
-00075440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075450: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00075460: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00075470: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-00075480: 2028 6367 7261 7068 2d3e 776f 726b 2021   (cgraph->work !
-00075490: 3d20 4e55 4c4c 2026 2620 776f 726b 5f73  = NULL && work_s
-000754a0: 697a 6520 3e20 6367 7261 7068 2d3e 776f  ize > cgraph->wo
-000754b0: 726b 5f73 697a 6529 207b 0a20 2020 2020  rk_size) {.     
-000754c0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-000754d0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-000754e0: 444f 3a20 6265 7474 6572 2068 616e 646c  DO: better handl
-000754f0: 696e 670a 2020 2020 2020 2020 7d0a 0a20  ing.        }.. 
-00075500: 2020 2020 2020 2069 6620 2877 6f72 6b5f         if (work_
-00075510: 7369 7a65 203e 2030 2026 2620 6367 7261  size > 0 && cgra
-00075520: 7068 2d3e 776f 726b 203d 3d20 4e55 4c4c  ph->work == NULL
-00075530: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00075540: 6367 7261 7068 2d3e 776f 726b 5f73 697a  cgraph->work_siz
-00075550: 6520 3d20 776f 726b 5f73 697a 6520 2b20  e = work_size + 
-00075560: 4341 4348 455f 4c49 4e45 5f53 495a 452a  CACHE_LINE_SIZE*
-00075570: 286e 5f74 6872 6561 6473 202d 2031 293b  (n_threads - 1);
-00075580: 0a0a 2020 2020 2020 2020 2020 2020 4747  ..            GG
-00075590: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
-000755a0: 2573 3a20 616c 6c6f 6361 7469 6e67 2077  %s: allocating w
-000755b0: 6f72 6b20 6275 6666 6572 2066 6f72 2067  ork buffer for g
-000755c0: 7261 7068 2028 257a 7520 6279 7465 7329  raph (%zu bytes)
-000755d0: 5c6e 222c 205f 5f66 756e 635f 5f2c 2063  \n", __func__, c
-000755e0: 6772 6170 682d 3e77 6f72 6b5f 7369 7a65  graph->work_size
-000755f0: 293b 0a20 2020 2020 2020 2020 2020 2063  );.            c
-00075600: 6772 6170 682d 3e77 6f72 6b20 3d20 6767  graph->work = gg
-00075610: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-00075620: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-00075630: 4938 2c20 6367 7261 7068 2d3e 776f 726b  I8, cgraph->work
-00075640: 5f73 697a 6529 3b0a 2020 2020 2020 2020  _size);.        
-00075650: 7d0a 2020 2020 7d0a 0a20 2020 2063 6f6e  }.    }..    con
-00075660: 7374 2069 6e74 3634 5f74 2070 6572 665f  st int64_t perf_
-00075670: 7374 6172 745f 6379 636c 6573 2020 3d20  start_cycles  = 
-00075680: 6767 6d6c 5f70 6572 665f 6379 636c 6573  ggml_perf_cycles
-00075690: 2829 3b0a 2020 2020 636f 6e73 7420 696e  ();.    const in
-000756a0: 7436 345f 7420 7065 7266 5f73 7461 7274  t64_t perf_start
-000756b0: 5f74 696d 655f 7573 203d 2067 676d 6c5f  _time_us = ggml_
-000756c0: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
-000756d0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-000756e0: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
-000756f0: 3e6e 5f6e 6f64 6573 3b20 692b 2b29 207b  >n_nodes; i++) {
-00075700: 0a20 2020 2020 2020 2047 474d 4c5f 5052  .        GGML_PR
-00075710: 494e 545f 4445 4255 475f 3528 2225 733a  INT_DEBUG_5("%s:
-00075720: 2025 642f 2564 5c6e 222c 205f 5f66 756e   %d/%d\n", __fun
-00075730: 635f 5f2c 2069 2c20 6367 7261 7068 2d3e  c__, i, cgraph->
-00075740: 6e5f 6e6f 6465 7329 3b0a 0a20 2020 2020  n_nodes);..     
-00075750: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00075760: 656e 736f 7220 2a20 6e6f 6465 203d 2063  ensor * node = c
-00075770: 6772 6170 682d 3e6e 6f64 6573 5b69 5d3b  graph->nodes[i];
-00075780: 0a0a 2020 2020 2020 2020 2f2f 2054 4f44  ..        // TOD
-00075790: 4f3a 2074 6869 7320 636f 756c 6420 6265  O: this could be
-000757a0: 2075 7365 6420 746f 2061 766f 6964 2075   used to avoid u
-000757b0: 6e6e 6563 6573 7361 7279 2063 6f6d 7075  nnecessary compu
-000757c0: 7461 7469 6f6e 732c 2062 7574 2069 7420  tations, but it 
-000757d0: 6e65 6564 7320 746f 2062 6520 696d 7072  needs to be impr
-000757e0: 6f76 6564 0a20 2020 2020 2020 202f 2f69  oved.        //i
-000757f0: 6620 286e 6f64 652d 3e67 7261 6420 3d3d  f (node->grad ==
-00075800: 204e 554c 4c20 2626 206e 6f64 652d 3e70   NULL && node->p
-00075810: 6572 665f 7275 6e73 203e 2030 2920 7b0a  erf_runs > 0) {.
-00075820: 2020 2020 2020 2020 2f2f 2020 2020 636f          //    co
-00075830: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
-00075840: 2f2f 7d0a 0a20 2020 2020 2020 2063 6f6e  //}..        con
-00075850: 7374 2069 6e74 3634 5f74 2070 6572 665f  st int64_t perf_
-00075860: 6e6f 6465 5f73 7461 7274 5f63 7963 6c65  node_start_cycle
-00075870: 7320 203d 2067 676d 6c5f 7065 7266 5f63  s  = ggml_perf_c
-00075880: 7963 6c65 7328 293b 0a20 2020 2020 2020  ycles();.       
-00075890: 2063 6f6e 7374 2069 6e74 3634 5f74 2070   const int64_t p
-000758a0: 6572 665f 6e6f 6465 5f73 7461 7274 5f74  erf_node_start_t
-000758b0: 696d 655f 7573 203d 2067 676d 6c5f 7065  ime_us = ggml_pe
-000758c0: 7266 5f74 696d 655f 7573 2829 3b0a 0a20  rf_time_us();.. 
-000758d0: 2020 2020 2020 202f 2f20 494e 4954 0a20         // INIT. 
-000758e0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000758f0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00075900: 7320 7061 7261 6d73 203d 207b 0a20 2020  s params = {.   
-00075910: 2020 2020 2020 2020 202f 2a2e 7479 7065           /*.type
-00075920: 2020 3d2a 2f20 4747 4d4c 5f54 4153 4b5f    =*/ GGML_TASK_
-00075930: 494e 4954 2c0a 2020 2020 2020 2020 2020  INIT,.          
-00075940: 2020 2f2a 2e69 7468 2020 203d 2a2f 2030    /*.ith   =*/ 0
-00075950: 2c0a 2020 2020 2020 2020 2020 2020 2f2a  ,.            /*
-00075960: 2e6e 7468 2020 203d 2a2f 206e 6f64 652d  .nth   =*/ node-
-00075970: 3e6e 5f74 6173 6b73 2c0a 2020 2020 2020  >n_tasks,.      
-00075980: 2020 2020 2020 2f2a 2e77 7369 7a65 203d        /*.wsize =
-00075990: 2a2f 2063 6772 6170 682d 3e77 6f72 6b20  */ cgraph->work 
-000759a0: 3f20 6767 6d6c 5f6e 6279 7465 7328 6367  ? ggml_nbytes(cg
-000759b0: 7261 7068 2d3e 776f 726b 2920 3a20 302c  raph->work) : 0,
-000759c0: 0a20 2020 2020 2020 2020 2020 202f 2a2e  .            /*.
-000759d0: 7764 6174 6120 3d2a 2f20 6367 7261 7068  wdata =*/ cgraph
-000759e0: 2d3e 776f 726b 203f 2063 6772 6170 682d  ->work ? cgraph-
-000759f0: 3e77 6f72 6b2d 3e64 6174 6120 3a20 4e55  >work->data : NU
-00075a00: 4c4c 2c0a 2020 2020 2020 2020 7d3b 0a0a  LL,.        };..
-00075a10: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00075a20: 7075 7465 5f66 6f72 7761 7264 2826 7061  pute_forward(&pa
-00075a30: 7261 6d73 2c20 6e6f 6465 293b 0a0a 2020  rams, node);..  
-00075a40: 2020 2020 2020 2f2f 2043 4f4d 5055 5445        // COMPUTE
-00075a50: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
-00075a60: 652d 3e6e 5f74 6173 6b73 203e 2031 2920  e->n_tasks > 1) 
-00075a70: 7b0a 2020 2020 2020 2020 2020 2020 6966  {.            if
-00075a80: 2028 6174 6f6d 6963 5f66 6574 6368 5f61   (atomic_fetch_a
-00075a90: 6464 2826 7374 6174 655f 7368 6172 6564  dd(&state_shared
-00075aa0: 2e6e 5f72 6561 6479 2c20 3129 203d 3d20  .n_ready, 1) == 
-00075ab0: 6e5f 7468 7265 6164 7320 2d20 3129 207b  n_threads - 1) {
-00075ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075ad0: 2061 746f 6d69 635f 7374 6f72 6528 2673   atomic_store(&s
-00075ae0: 7461 7465 5f73 6861 7265 642e 6861 735f  tate_shared.has_
-00075af0: 776f 726b 2c20 6661 6c73 6529 3b0a 2020  work, false);.  
-00075b00: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00075b10: 2020 2020 2020 2020 2077 6869 6c65 2028           while (
-00075b20: 6174 6f6d 6963 5f6c 6f61 6428 2673 7461  atomic_load(&sta
-00075b30: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
-00075b40: 726b 2929 207b 0a20 2020 2020 2020 2020  rk)) {.         
-00075b50: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
-00075b60: 5f6c 6f63 6b20 2028 2673 7461 7465 5f73  _lock  (&state_s
-00075b70: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
-00075b80: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00075b90: 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28 2673  l_lock_unlock(&s
-00075ba0: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
-00075bb0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00075bc0: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-00075bd0: 206c 6175 6e63 6820 7468 7265 6164 2070   launch thread p
-00075be0: 6f6f 6c0a 2020 2020 2020 2020 2020 2020  ool.            
-00075bf0: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-00075c00: 6a20 3c20 6e5f 7468 7265 6164 7320 2d20  j < n_threads - 
-00075c10: 313b 206a 2b2b 2920 7b0a 2020 2020 2020  1; j++) {.      
-00075c20: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00075c30: 735b 6a5d 2e70 6172 616d 7320 3d20 2873  s[j].params = (s
-00075c40: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00075c50: 7465 5f70 6172 616d 7329 207b 0a20 2020  te_params) {.   
-00075c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075c70: 202e 7479 7065 2020 3d20 4747 4d4c 5f54   .type  = GGML_T
-00075c80: 4153 4b5f 434f 4d50 5554 452c 0a20 2020  ASK_COMPUTE,.   
-00075c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075ca0: 202e 6974 6820 2020 3d20 6a20 2b20 312c   .ith   = j + 1,
-00075cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075cc0: 2020 2020 202e 6e74 6820 2020 3d20 6e6f       .nth   = no
-00075cd0: 6465 2d3e 6e5f 7461 736b 732c 0a20 2020  de->n_tasks,.   
-00075ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075cf0: 202e 7773 697a 6520 3d20 6367 7261 7068   .wsize = cgraph
-00075d00: 2d3e 776f 726b 203f 2067 676d 6c5f 6e62  ->work ? ggml_nb
-00075d10: 7974 6573 2863 6772 6170 682d 3e77 6f72  ytes(cgraph->wor
-00075d20: 6b29 203a 2030 2c0a 2020 2020 2020 2020  k) : 0,.        
-00075d30: 2020 2020 2020 2020 2020 2020 2e77 6461              .wda
-00075d40: 7461 203d 2063 6772 6170 682d 3e77 6f72  ta = cgraph->wor
-00075d50: 6b20 3f20 6367 7261 7068 2d3e 776f 726b  k ? cgraph->work
-00075d60: 2d3e 6461 7461 203a 204e 554c 4c2c 0a20  ->data : NULL,. 
-00075d70: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00075d80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00075d90: 2020 776f 726b 6572 735b 6a5d 2e6e 6f64    workers[j].nod
-00075da0: 6520 3d20 6e6f 6465 3b0a 2020 2020 2020  e = node;.      
-00075db0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00075dc0: 2020 2020 2061 746f 6d69 635f 6665 7463       atomic_fetc
-00075dd0: 685f 7375 6228 2673 7461 7465 5f73 6861  h_sub(&state_sha
-00075de0: 7265 642e 6e5f 7265 6164 792c 2031 293b  red.n_ready, 1);
-00075df0: 0a0a 2020 2020 2020 2020 2020 2020 7768  ..            wh
-00075e00: 696c 6520 2861 746f 6d69 635f 6c6f 6164  ile (atomic_load
-00075e10: 2826 7374 6174 655f 7368 6172 6564 2e6e  (&state_shared.n
-00075e20: 5f72 6561 6479 2920 3e20 3029 207b 0a20  _ready) > 0) {. 
-00075e30: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00075e40: 676d 6c5f 6c6f 636b 5f6c 6f63 6b20 2028  gml_lock_lock  (
-00075e50: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
-00075e60: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
-00075e70: 2020 2020 2067 676d 6c5f 6c6f 636b 5f75       ggml_lock_u
-00075e80: 6e6c 6f63 6b28 2673 7461 7465 5f73 6861  nlock(&state_sha
-00075e90: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
-00075ea0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00075eb0: 2020 2020 2020 6174 6f6d 6963 5f73 746f        atomic_sto
-00075ec0: 7265 2826 7374 6174 655f 7368 6172 6564  re(&state_shared
-00075ed0: 2e68 6173 5f77 6f72 6b2c 2074 7275 6529  .has_work, true)
-00075ee0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-00075ef0: 2020 2020 2070 6172 616d 732e 7479 7065       params.type
-00075f00: 203d 2047 474d 4c5f 5441 534b 5f43 4f4d   = GGML_TASK_COM
-00075f10: 5055 5445 3b0a 2020 2020 2020 2020 6767  PUTE;.        gg
-00075f20: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00075f30: 7264 2826 7061 7261 6d73 2c20 6e6f 6465  rd(&params, node
-00075f40: 293b 0a0a 2020 2020 2020 2020 2f2f 2077  );..        // w
-00075f50: 6169 7420 666f 7220 7468 7265 6164 2070  ait for thread p
-00075f60: 6f6f 6c0a 2020 2020 2020 2020 6966 2028  ool.        if (
-00075f70: 6e6f 6465 2d3e 6e5f 7461 736b 7320 3e20  node->n_tasks > 
-00075f80: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00075f90: 2069 6620 2861 746f 6d69 635f 6665 7463   if (atomic_fetc
-00075fa0: 685f 6164 6428 2673 7461 7465 5f73 6861  h_add(&state_sha
-00075fb0: 7265 642e 6e5f 7265 6164 792c 2031 2920  red.n_ready, 1) 
-00075fc0: 3d3d 206e 5f74 6872 6561 6473 202d 2031  == n_threads - 1
-00075fd0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00075fe0: 2020 2020 6174 6f6d 6963 5f73 746f 7265      atomic_store
-00075ff0: 2826 7374 6174 655f 7368 6172 6564 2e68  (&state_shared.h
-00076000: 6173 5f77 6f72 6b2c 2066 616c 7365 293b  as_work, false);
-00076010: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00076020: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-00076030: 6520 2861 746f 6d69 635f 6c6f 6164 2826  e (atomic_load(&
-00076040: 7374 6174 655f 7368 6172 6564 2e68 6173  state_shared.has
-00076050: 5f77 6f72 6b29 2920 7b0a 2020 2020 2020  _work)) {.      
-00076060: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
-00076070: 6f63 6b5f 6c6f 636b 2020 2826 7374 6174  ock_lock  (&stat
-00076080: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
-00076090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000760a0: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
-000760b0: 2826 7374 6174 655f 7368 6172 6564 2e73  (&state_shared.s
-000760c0: 7069 6e29 3b0a 2020 2020 2020 2020 2020  pin);.          
-000760d0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-000760e0: 2061 746f 6d69 635f 6665 7463 685f 7375   atomic_fetch_su
-000760f0: 6228 2673 7461 7465 5f73 6861 7265 642e  b(&state_shared.
-00076100: 6e5f 7265 6164 792c 2031 293b 0a0a 2020  n_ready, 1);..  
-00076110: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00076120: 2861 746f 6d69 635f 6c6f 6164 2826 7374  (atomic_load(&st
-00076130: 6174 655f 7368 6172 6564 2e6e 5f72 6561  ate_shared.n_rea
-00076140: 6479 2920 213d 2030 2920 7b0a 2020 2020  dy) != 0) {.    
-00076150: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00076160: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
-00076170: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
-00076180: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00076190: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
-000761a0: 636b 2826 7374 6174 655f 7368 6172 6564  ck(&state_shared
-000761b0: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
-000761c0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-000761d0: 0a20 2020 2020 2020 202f 2f20 4649 4e41  .        // FINA
-000761e0: 4c49 5a45 0a20 2020 2020 2020 2069 6620  LIZE.        if 
-000761f0: 286e 6f64 652d 3e6e 5f74 6173 6b73 203e  (node->n_tasks >
-00076200: 2031 2920 7b0a 2020 2020 2020 2020 2020   1) {.          
-00076210: 2020 6966 2028 6174 6f6d 6963 5f66 6574    if (atomic_fet
-00076220: 6368 5f61 6464 2826 7374 6174 655f 7368  ch_add(&state_sh
-00076230: 6172 6564 2e6e 5f72 6561 6479 2c20 3129  ared.n_ready, 1)
-00076240: 203d 3d20 6e5f 7468 7265 6164 7320 2d20   == n_threads - 
-00076250: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00076260: 2020 2020 2061 746f 6d69 635f 7374 6f72       atomic_stor
-00076270: 6528 2673 7461 7465 5f73 6861 7265 642e  e(&state_shared.
-00076280: 6861 735f 776f 726b 2c20 6661 6c73 6529  has_work, false)
-00076290: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-000762a0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-000762b0: 6c65 2028 6174 6f6d 6963 5f6c 6f61 6428  le (atomic_load(
-000762c0: 2673 7461 7465 5f73 6861 7265 642e 6861  &state_shared.ha
-000762d0: 735f 776f 726b 2929 207b 0a20 2020 2020  s_work)) {.     
-000762e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000762f0: 6c6f 636b 5f6c 6f63 6b20 2028 2673 7461  lock_lock  (&sta
-00076300: 7465 5f73 6861 7265 642e 7370 696e 293b  te_shared.spin);
-00076310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076320: 2067 676d 6c5f 6c6f 636b 5f75 6e6c 6f63   ggml_lock_unloc
-00076330: 6b28 2673 7461 7465 5f73 6861 7265 642e  k(&state_shared.
-00076340: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
-00076350: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00076360: 2020 2f2f 206c 6175 6e63 6820 7468 7265    // launch thre
-00076370: 6164 2070 6f6f 6c0a 2020 2020 2020 2020  ad pool.        
-00076380: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-00076390: 2030 3b20 6a20 3c20 6e5f 7468 7265 6164   0; j < n_thread
-000763a0: 7320 2d20 313b 206a 2b2b 2920 7b0a 2020  s - 1; j++) {.  
-000763b0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-000763c0: 726b 6572 735b 6a5d 2e70 6172 616d 7320  rkers[j].params 
-000763d0: 3d20 2873 7472 7563 7420 6767 6d6c 5f63  = (struct ggml_c
-000763e0: 6f6d 7075 7465 5f70 6172 616d 7329 207b  ompute_params) {
-000763f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076400: 2020 2020 202e 7479 7065 2020 3d20 4747       .type  = GG
-00076410: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-00076420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00076430: 2020 2020 2020 2e69 7468 2020 203d 206a        .ith   = j
-00076440: 202b 2031 2c0a 2020 2020 2020 2020 2020   + 1,.          
-00076450: 2020 2020 2020 2020 2020 2e6e 7468 2020            .nth  
-00076460: 203d 206e 6f64 652d 3e6e 5f74 6173 6b73   = node->n_tasks
-00076470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00076480: 2020 2020 2020 2e77 7369 7a65 203d 2063        .wsize = c
-00076490: 6772 6170 682d 3e77 6f72 6b20 3f20 6767  graph->work ? gg
-000764a0: 6d6c 5f6e 6279 7465 7328 6367 7261 7068  ml_nbytes(cgraph
-000764b0: 2d3e 776f 726b 2920 3a20 302c 0a20 2020  ->work) : 0,.   
-000764c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000764d0: 202e 7764 6174 6120 3d20 6367 7261 7068   .wdata = cgraph
-000764e0: 2d3e 776f 726b 203f 2063 6772 6170 682d  ->work ? cgraph-
-000764f0: 3e77 6f72 6b2d 3e64 6174 6120 3a20 4e55  >work->data : NU
-00076500: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
-00076510: 2020 2020 7d3b 0a20 2020 2020 2020 2020      };.         
-00076520: 2020 2020 2020 2077 6f72 6b65 7273 5b6a         workers[j
-00076530: 5d2e 6e6f 6465 203d 206e 6f64 653b 0a20  ].node = node;. 
-00076540: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00076550: 2020 2020 2020 2020 2020 6174 6f6d 6963            atomic
-00076560: 5f66 6574 6368 5f73 7562 2826 7374 6174  _fetch_sub(&stat
-00076570: 655f 7368 6172 6564 2e6e 5f72 6561 6479  e_shared.n_ready
-00076580: 2c20 3129 3b0a 0a20 2020 2020 2020 2020  , 1);..         
-00076590: 2020 2077 6869 6c65 2028 6174 6f6d 6963     while (atomic
-000765a0: 5f6c 6f61 6428 2673 7461 7465 5f73 6861  _load(&state_sha
-000765b0: 7265 642e 6e5f 7265 6164 7929 203e 2030  red.n_ready) > 0
-000765c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000765d0: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
-000765e0: 636b 2020 2826 7374 6174 655f 7368 6172  ck  (&state_shar
-000765f0: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
-00076600: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
-00076610: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
-00076620: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
-00076630: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00076640: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
-00076650: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
-00076660: 6861 7265 642e 6861 735f 776f 726b 2c20  hared.has_work, 
-00076670: 7472 7565 293b 0a20 2020 2020 2020 207d  true);.        }
-00076680: 0a0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
-00076690: 2e74 7970 6520 3d20 4747 4d4c 5f54 4153  .type = GGML_TAS
-000766a0: 4b5f 4649 4e41 4c49 5a45 3b0a 2020 2020  K_FINALIZE;.    
-000766b0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-000766c0: 5f66 6f72 7761 7264 2826 7061 7261 6d73  _forward(&params
-000766d0: 2c20 6e6f 6465 293b 0a0a 2020 2020 2020  , node);..      
-000766e0: 2020 2f2f 2077 6169 7420 666f 7220 7468    // wait for th
-000766f0: 7265 6164 2070 6f6f 6c0a 2020 2020 2020  read pool.      
-00076700: 2020 6966 2028 6e6f 6465 2d3e 6e5f 7461    if (node->n_ta
-00076710: 736b 7320 3e20 3129 207b 0a20 2020 2020  sks > 1) {.     
-00076720: 2020 2020 2020 2069 6620 2861 746f 6d69         if (atomi
-00076730: 635f 6665 7463 685f 6164 6428 2673 7461  c_fetch_add(&sta
-00076740: 7465 5f73 6861 7265 642e 6e5f 7265 6164  te_shared.n_read
-00076750: 792c 2031 2920 3d3d 206e 5f74 6872 6561  y, 1) == n_threa
-00076760: 6473 202d 2031 2920 7b0a 2020 2020 2020  ds - 1) {.      
-00076770: 2020 2020 2020 2020 2020 6174 6f6d 6963            atomic
-00076780: 5f73 746f 7265 2826 7374 6174 655f 7368  _store(&state_sh
-00076790: 6172 6564 2e68 6173 5f77 6f72 6b2c 2066  ared.has_work, f
-000767a0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-000767b0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-000767c0: 2020 7768 696c 6520 2861 746f 6d69 635f    while (atomic_
-000767d0: 6c6f 6164 2826 7374 6174 655f 7368 6172  load(&state_shar
-000767e0: 6564 2e68 6173 5f77 6f72 6b29 2920 7b0a  ed.has_work)) {.
-000767f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076800: 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020  ggml_lock_lock  
-00076810: 2826 7374 6174 655f 7368 6172 6564 2e73  (&state_shared.s
-00076820: 7069 6e29 3b0a 2020 2020 2020 2020 2020  pin);.          
-00076830: 2020 2020 2020 6767 6d6c 5f6c 6f63 6b5f        ggml_lock_
-00076840: 756e 6c6f 636b 2826 7374 6174 655f 7368  unlock(&state_sh
-00076850: 6172 6564 2e73 7069 6e29 3b0a 2020 2020  ared.spin);.    
-00076860: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00076870: 2020 2020 2020 2061 746f 6d69 635f 6665         atomic_fe
-00076880: 7463 685f 7375 6228 2673 7461 7465 5f73  tch_sub(&state_s
-00076890: 6861 7265 642e 6e5f 7265 6164 792c 2031  hared.n_ready, 1
-000768a0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-000768b0: 7768 696c 6520 2861 746f 6d69 635f 6c6f  while (atomic_lo
-000768c0: 6164 2826 7374 6174 655f 7368 6172 6564  ad(&state_shared
-000768d0: 2e6e 5f72 6561 6479 2920 213d 2030 2920  .n_ready) != 0) 
-000768e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000768f0: 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b    ggml_lock_lock
-00076900: 2020 2826 7374 6174 655f 7368 6172 6564    (&state_shared
-00076910: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
-00076920: 2020 2020 2020 2020 6767 6d6c 5f6c 6f63          ggml_loc
-00076930: 6b5f 756e 6c6f 636b 2826 7374 6174 655f  k_unlock(&state_
-00076940: 7368 6172 6564 2e73 7069 6e29 3b0a 2020  shared.spin);.  
-00076950: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00076960: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-00076970: 2f20 7065 7266 6f72 6d61 6e63 6520 7374  / performance st
-00076980: 6174 7320 286e 6f64 6529 0a20 2020 2020  ats (node).     
-00076990: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000769a0: 2069 6e74 3634 5f74 2070 6572 665f 6379   int64_t perf_cy
-000769b0: 636c 6573 5f63 7572 2020 3d20 6767 6d6c  cles_cur  = ggml
-000769c0: 5f70 6572 665f 6379 636c 6573 2829 2020  _perf_cycles()  
-000769d0: 2d20 7065 7266 5f6e 6f64 655f 7374 6172  - perf_node_star
-000769e0: 745f 6379 636c 6573 3b0a 2020 2020 2020  t_cycles;.      
-000769f0: 2020 2020 2020 696e 7436 345f 7420 7065        int64_t pe
-00076a00: 7266 5f74 696d 655f 7573 5f63 7572 203d  rf_time_us_cur =
-00076a10: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
-00076a20: 7573 2829 202d 2070 6572 665f 6e6f 6465  us() - perf_node
-00076a30: 5f73 7461 7274 5f74 696d 655f 7573 3b0a  _start_time_us;.
-00076a40: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
-00076a50: 652d 3e70 6572 665f 7275 6e73 2b2b 3b0a  e->perf_runs++;.
-00076a60: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00076a70: 2d3e 7065 7266 5f63 7963 6c65 7320 202b  ->perf_cycles  +
-00076a80: 3d20 7065 7266 5f63 7963 6c65 735f 6375  = perf_cycles_cu
-00076a90: 723b 0a20 2020 2020 2020 2020 2020 206e  r;.            n
-00076aa0: 6f64 652d 3e70 6572 665f 7469 6d65 5f75  ode->perf_time_u
-00076ab0: 7320 2b3d 2070 6572 665f 7469 6d65 5f75  s += perf_time_u
-00076ac0: 735f 6375 723b 0a20 2020 2020 2020 207d  s_cur;.        }
-00076ad0: 0a20 2020 207d 0a0a 2020 2020 2f2f 206a  .    }..    // j
-00076ae0: 6f69 6e20 7468 7265 6164 2070 6f6f 6c0a  oin thread pool.
-00076af0: 2020 2020 6966 2028 6e5f 7468 7265 6164      if (n_thread
-00076b00: 7320 3e20 3129 207b 0a20 2020 2020 2020  s > 1) {.       
-00076b10: 2061 746f 6d69 635f 7374 6f72 6528 2673   atomic_store(&s
-00076b20: 7461 7465 5f73 6861 7265 642e 7374 6f70  tate_shared.stop
-00076b30: 2c20 7472 7565 293b 0a20 2020 2020 2020  , true);.       
-00076b40: 2061 746f 6d69 635f 7374 6f72 6528 2673   atomic_store(&s
-00076b50: 7461 7465 5f73 6861 7265 642e 6861 735f  tate_shared.has_
-00076b60: 776f 726b 2c20 7472 7565 293b 0a0a 2020  work, true);..  
-00076b70: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-00076b80: 203d 2030 3b20 6a20 3c20 6e5f 7468 7265   = 0; j < n_thre
-00076b90: 6164 7320 2d20 313b 206a 2b2b 2920 7b0a  ads - 1; j++) {.
-00076ba0: 2020 2020 2020 2020 2020 2020 696e 7420              int 
-00076bb0: 7263 203d 2067 676d 6c5f 7468 7265 6164  rc = ggml_thread
-00076bc0: 5f6a 6f69 6e28 776f 726b 6572 735b 6a5d  _join(workers[j]
-00076bd0: 2e74 6872 642c 204e 554c 4c29 3b0a 2020  .thrd, NULL);.  
-00076be0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00076bf0: 5353 4552 5428 7263 203d 3d20 3029 3b0a  SSERT(rc == 0);.
-00076c00: 2020 2020 2020 2020 2020 2020 554e 5553              UNUS
-00076c10: 4544 2872 6329 3b0a 2020 2020 2020 2020  ED(rc);.        
-00076c20: 7d0a 0a20 2020 2020 2020 2067 676d 6c5f  }..        ggml_
-00076c30: 6c6f 636b 5f64 6573 7472 6f79 2826 7374  lock_destroy(&st
-00076c40: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
-00076c50: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-00076c60: 7065 7266 6f72 6d61 6e63 6520 7374 6174  performance stat
-00076c70: 7320 2867 7261 7068 290a 2020 2020 7b0a  s (graph).    {.
-00076c80: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
-00076c90: 7065 7266 5f63 7963 6c65 735f 6375 7220  perf_cycles_cur 
-00076ca0: 203d 2067 676d 6c5f 7065 7266 5f63 7963   = ggml_perf_cyc
-00076cb0: 6c65 7328 2920 202d 2070 6572 665f 7374  les()  - perf_st
-00076cc0: 6172 745f 6379 636c 6573 3b0a 2020 2020  art_cycles;.    
-00076cd0: 2020 2020 696e 7436 345f 7420 7065 7266      int64_t perf
-00076ce0: 5f74 696d 655f 7573 5f63 7572 203d 2067  _time_us_cur = g
-00076cf0: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
-00076d00: 2829 202d 2070 6572 665f 7374 6172 745f  () - perf_start_
-00076d10: 7469 6d65 5f75 733b 0a0a 2020 2020 2020  time_us;..      
-00076d20: 2020 6367 7261 7068 2d3e 7065 7266 5f72    cgraph->perf_r
-00076d30: 756e 732b 2b3b 0a20 2020 2020 2020 2063  uns++;.        c
-00076d40: 6772 6170 682d 3e70 6572 665f 6379 636c  graph->perf_cycl
-00076d50: 6573 2020 2b3d 2070 6572 665f 6379 636c  es  += perf_cycl
-00076d60: 6573 5f63 7572 3b0a 2020 2020 2020 2020  es_cur;.        
-00076d70: 6367 7261 7068 2d3e 7065 7266 5f74 696d  cgraph->perf_tim
-00076d80: 655f 7573 202b 3d20 7065 7266 5f74 696d  e_us += perf_tim
-00076d90: 655f 7573 5f63 7572 3b0a 0a20 2020 2020  e_us_cur;..     
-00076da0: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
-00076db0: 4255 4728 2225 733a 2070 6572 6620 2825  BUG("%s: perf (%
-00076dc0: 6429 202d 2063 7075 203d 2025 2e33 6620  d) - cpu = %.3f 
-00076dd0: 2f20 252e 3366 206d 732c 2077 616c 6c20  / %.3f ms, wall 
-00076de0: 3d20 252e 3366 202f 2025 2e33 6620 6d73  = %.3f / %.3f ms
-00076df0: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-00076e00: 2020 2020 205f 5f66 756e 635f 5f2c 2063       __func__, c
-00076e10: 6772 6170 682d 3e70 6572 665f 7275 6e73  graph->perf_runs
-00076e20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00076e30: 2020 2864 6f75 626c 6529 2070 6572 665f    (double) perf_
-00076e40: 6379 636c 6573 5f63 7572 2020 2020 2020  cycles_cur      
-00076e50: 2f20 2864 6f75 626c 6529 2067 676d 6c5f  / (double) ggml_
-00076e60: 6379 636c 6573 5f70 6572 5f6d 7328 292c  cycles_per_ms(),
-00076e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076e80: 2028 646f 7562 6c65 2920 6367 7261 7068   (double) cgraph
-00076e90: 2d3e 7065 7266 5f63 7963 6c65 7320 202f  ->perf_cycles  /
-00076ea0: 2028 646f 7562 6c65 2920 6767 6d6c 5f63   (double) ggml_c
-00076eb0: 7963 6c65 735f 7065 725f 6d73 2829 202f  ycles_per_ms() /
-00076ec0: 2028 646f 7562 6c65 2920 6367 7261 7068   (double) cgraph
-00076ed0: 2d3e 7065 7266 5f72 756e 732c 0a20 2020  ->perf_runs,.   
-00076ee0: 2020 2020 2020 2020 2020 2020 2028 646f               (do
-00076ef0: 7562 6c65 2920 7065 7266 5f74 696d 655f  uble) perf_time_
-00076f00: 7573 5f63 7572 2020 2020 202f 2031 3030  us_cur     / 100
-00076f10: 302e 302c 0a20 2020 2020 2020 2020 2020  0.0,.           
-00076f20: 2020 2020 2028 646f 7562 6c65 2920 6367       (double) cg
-00076f30: 7261 7068 2d3e 7065 7266 5f74 696d 655f  raph->perf_time_
-00076f40: 7573 202f 2031 3030 302e 3020 2f20 6367  us / 1000.0 / cg
-00076f50: 7261 7068 2d3e 7065 7266 5f72 756e 7329  raph->perf_runs)
-00076f60: 3b0a 2020 2020 7d0a 7d0a 0a76 6f69 6420  ;.    }.}..void 
-00076f70: 6767 6d6c 5f67 7261 7068 5f72 6573 6574  ggml_graph_reset
-00076f80: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
-00076f90: 6170 6820 2a20 6367 7261 7068 2920 7b0a  aph * cgraph) {.
-00076fa0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00076fb0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
-00076fc0: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
-00076fd0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00076fe0: 676d 6c5f 7465 6e73 6f72 202a 2067 7261  gml_tensor * gra
-00076ff0: 6420 3d20 6367 7261 7068 2d3e 6772 6164  d = cgraph->grad
-00077000: 735b 695d 3b0a 0a20 2020 2020 2020 2069  s[i];..        i
-00077010: 6620 2867 7261 6429 207b 0a20 2020 2020  f (grad) {.     
-00077020: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
-00077030: 7a65 726f 2867 7261 6429 3b0a 2020 2020  zero(grad);.    
-00077040: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-00077050: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00077060: 7220 2a20 6767 6d6c 5f67 7261 7068 5f67  r * ggml_graph_g
-00077070: 6574 5f74 656e 736f 7228 7374 7275 6374  et_tensor(struct
-00077080: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
-00077090: 6772 6170 682c 2063 6f6e 7374 2063 6861  graph, const cha
-000770a0: 7220 2a20 6e61 6d65 2920 7b0a 2020 2020  r * name) {.    
-000770b0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000770c0: 6920 3c20 6367 7261 7068 2d3e 6e5f 6c65  i < cgraph->n_le
-000770d0: 6166 733b 2069 2b2b 2920 7b0a 2020 2020  afs; i++) {.    
-000770e0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000770f0: 7465 6e73 6f72 202a 206c 6561 6620 3d20  tensor * leaf = 
-00077100: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
-00077110: 3b0a 0a20 2020 2020 2020 2069 6620 2873  ;..        if (s
-00077120: 7472 636d 7028 6c65 6166 2d3e 6e61 6d65  trcmp(leaf->name
-00077130: 2c20 6e61 6d65 2920 3d3d 2030 2920 7b0a  , name) == 0) {.
-00077140: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00077150: 726e 206c 6561 663b 0a20 2020 2020 2020  rn leaf;.       
-00077160: 207d 0a20 2020 207d 0a0a 2020 2020 666f   }.    }..    fo
-00077170: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00077180: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
-00077190: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-000771a0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000771b0: 6e73 6f72 202a 206e 6f64 6520 3d20 6367  nsor * node = cg
-000771c0: 7261 7068 2d3e 6e6f 6465 735b 695d 3b0a  raph->nodes[i];.
-000771d0: 0a20 2020 2020 2020 2069 6620 2873 7472  .        if (str
-000771e0: 636d 7028 6e6f 6465 2d3e 6e61 6d65 2c20  cmp(node->name, 
-000771f0: 6e61 6d65 2920 3d3d 2030 2920 7b0a 2020  name) == 0) {.  
-00077200: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00077210: 206e 6f64 653b 0a20 2020 2020 2020 207d   node;.        }
-00077220: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-00077230: 726e 204e 554c 4c3b 0a7d 0a0a 7374 6174  rn NULL;.}..stat
-00077240: 6963 2076 6f69 6420 6767 6d6c 5f67 7261  ic void ggml_gra
-00077250: 7068 5f65 7870 6f72 745f 6c65 6166 2863  ph_export_leaf(c
-00077260: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00077270: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-00077280: 2c20 4649 4c45 202a 2066 6f75 7429 207b  , FILE * fout) {
-00077290: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-000772a0: 5f74 202a 206e 6520 3d20 7465 6e73 6f72  _t * ne = tensor
-000772b0: 2d3e 6e65 3b0a 2020 2020 636f 6e73 7420  ->ne;.    const 
-000772c0: 7369 7a65 5f74 2020 2a20 6e62 203d 2074  size_t  * nb = t
-000772d0: 656e 736f 722d 3e6e 623b 0a0a 2020 2020  ensor->nb;..    
-000772e0: 6670 7269 6e74 6628 666f 7574 2c20 2225  fprintf(fout, "%
-000772f0: 2d36 7320 252d 3132 7320 2538 6420 2538  -6s %-12s %8d %8
-00077300: 6a64 2025 6a64 2025 6a64 2025 6a64 2025  jd %jd %jd %jd %
-00077310: 3136 7a75 2025 3136 7a75 2025 3136 7a75  16zu %16zu %16zu
-00077320: 2025 3136 7a75 2025 3136 7020 2531 3673   %16zu %16p %16s
-00077330: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-00077340: 2067 676d 6c5f 7479 7065 5f6e 616d 6528   ggml_type_name(
-00077350: 7465 6e73 6f72 2d3e 7479 7065 292c 0a20  tensor->type),. 
-00077360: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00077370: 6f70 5f6e 616d 6520 2028 7465 6e73 6f72  op_name  (tensor
-00077380: 2d3e 6f70 292c 0a20 2020 2020 2020 2020  ->op),.         
-00077390: 2020 2074 656e 736f 722d 3e6e 5f64 696d     tensor->n_dim
-000773a0: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
-000773b0: 655b 305d 2c20 6e65 5b31 5d2c 206e 655b  e[0], ne[1], ne[
-000773c0: 325d 2c20 6e65 5b33 5d2c 0a20 2020 2020  2], ne[3],.     
-000773d0: 2020 2020 2020 206e 625b 305d 2c20 6e62         nb[0], nb
-000773e0: 5b31 5d2c 206e 625b 325d 2c20 6e62 5b33  [1], nb[2], nb[3
-000773f0: 5d2c 0a20 2020 2020 2020 2020 2020 2074  ],.            t
-00077400: 656e 736f 722d 3e64 6174 612c 0a20 2020  ensor->data,.   
-00077410: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-00077420: 3e6e 616d 6529 3b0a 7d0a 0a73 7461 7469  >name);.}..stati
-00077430: 6320 766f 6964 2067 676d 6c5f 6772 6170  c void ggml_grap
-00077440: 685f 6578 706f 7274 5f6e 6f64 6528 636f  h_export_node(co
-00077450: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00077460: 7465 6e73 6f72 202a 2074 656e 736f 722c  tensor * tensor,
-00077470: 2063 6f6e 7374 2063 6861 7220 2a20 6172   const char * ar
-00077480: 672c 2046 494c 4520 2a20 666f 7574 2920  g, FILE * fout) 
-00077490: 7b0a 2020 2020 636f 6e73 7420 696e 7436  {.    const int6
-000774a0: 345f 7420 2a20 6e65 203d 2074 656e 736f  4_t * ne = tenso
-000774b0: 722d 3e6e 653b 0a20 2020 2063 6f6e 7374  r->ne;.    const
-000774c0: 2073 697a 655f 7420 202a 206e 6220 3d20   size_t  * nb = 
-000774d0: 7465 6e73 6f72 2d3e 6e62 3b0a 0a20 2020  tensor->nb;..   
-000774e0: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
-000774f0: 252d 3673 2025 2d36 7320 252d 3132 7320  %-6s %-6s %-12s 
-00077500: 2538 6420 2538 6a64 2025 386a 6420 2538  %8d %8jd %8jd %8
-00077510: 6a64 2025 386a 6420 2531 367a 7520 2531  jd %8jd %16zu %1
-00077520: 367a 7520 2531 367a 7520 2531 367a 7520  6zu %16zu %16zu 
-00077530: 2538 6420 2531 3670 2025 3136 735c 6e22  %8d %16p %16s\n"
-00077540: 2c0a 2020 2020 2020 2020 2020 2020 6172  ,.            ar
-00077550: 672c 0a20 2020 2020 2020 2020 2020 2067  g,.            g
-00077560: 676d 6c5f 7479 7065 5f6e 616d 6528 7465  gml_type_name(te
-00077570: 6e73 6f72 2d3e 7479 7065 292c 0a20 2020  nsor->type),.   
-00077580: 2020 2020 2020 2020 2067 676d 6c5f 6f70           ggml_op
-00077590: 5f6e 616d 6520 2028 7465 6e73 6f72 2d3e  _name  (tensor->
-000775a0: 6f70 292c 0a20 2020 2020 2020 2020 2020  op),.           
-000775b0: 2074 656e 736f 722d 3e6e 5f64 696d 732c   tensor->n_dims,
-000775c0: 0a20 2020 2020 2020 2020 2020 206e 655b  .            ne[
-000775d0: 305d 2c20 6e65 5b31 5d2c 206e 655b 325d  0], ne[1], ne[2]
-000775e0: 2c20 6e65 5b33 5d2c 0a20 2020 2020 2020  , ne[3],.       
-000775f0: 2020 2020 206e 625b 305d 2c20 6e62 5b31       nb[0], nb[1
-00077600: 5d2c 206e 625b 325d 2c20 6e62 5b33 5d2c  ], nb[2], nb[3],
-00077610: 0a20 2020 2020 2020 2020 2020 2074 656e  .            ten
-00077620: 736f 722d 3e6e 5f74 6173 6b73 2c0a 2020  sor->n_tasks,.  
-00077630: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00077640: 2d3e 6461 7461 2c0a 2020 2020 2020 2020  ->data,.        
-00077650: 2020 2020 7465 6e73 6f72 2d3e 6e61 6d65      tensor->name
-00077660: 293b 0a7d 0a0a 766f 6964 2067 676d 6c5f  );.}..void ggml_
-00077670: 6772 6170 685f 6578 706f 7274 2863 6f6e  graph_export(con
-00077680: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-00077690: 6772 6170 6820 2a20 6367 7261 7068 2c20  graph * cgraph, 
-000776a0: 636f 6e73 7420 6368 6172 202a 2066 6e61  const char * fna
-000776b0: 6d65 2920 7b0a 2020 2020 6173 7365 7274  me) {.    assert
-000776c0: 2863 6772 6170 682d 3e77 6f72 6b20 2020  (cgraph->work   
-000776d0: 2020 203d 3d20 4e55 4c4c 293b 0a20 2020     == NULL);.   
-000776e0: 2061 7373 6572 7428 6367 7261 7068 2d3e   assert(cgraph->
-000776f0: 776f 726b 5f73 697a 6520 3d3d 2030 293b  work_size == 0);
-00077700: 0a0a 2020 2020 7569 6e74 3634 5f74 2073  ..    uint64_t s
-00077710: 697a 655f 6576 616c 203d 2030 3b0a 0a20  ize_eval = 0;.. 
-00077720: 2020 202f 2f20 636f 6d70 7574 6520 7369     // compute si
-00077730: 7a65 206f 6620 696e 7465 726d 6564 6961  ze of intermedia
-00077740: 7465 2072 6573 756c 7473 0a20 2020 202f  te results.    /
-00077750: 2f20 544f 444f 3a20 646f 6573 206e 6f74  / TODO: does not
-00077760: 2074 616b 6520 696e 746f 2061 6363 6f75   take into accou
-00077770: 6e74 2073 6372 6174 6368 2062 7566 6665  nt scratch buffe
-00077780: 7273 2021 2121 210a 2020 2020 666f 7220  rs !!!!.    for 
-00077790: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-000777a0: 6367 7261 7068 2d3e 6e5f 6e6f 6465 733b  cgraph->n_nodes;
-000777b0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-000777c0: 7369 7a65 5f65 7661 6c20 2b3d 2067 676d  size_eval += ggm
-000777d0: 6c5f 6e62 7974 6573 2863 6772 6170 682d  l_nbytes(cgraph-
-000777e0: 3e6e 6f64 6573 5b69 5d29 3b0a 2020 2020  >nodes[i]);.    
-000777f0: 7d0a 0a20 2020 202f 2f20 7072 696e 740a  }..    // print.
-00077800: 2020 2020 7b0a 2020 2020 2020 2020 4649      {.        FI
-00077810: 4c45 202a 2066 6f75 7420 3d20 7374 646f  LE * fout = stdo
-00077820: 7574 3b0a 0a20 2020 2020 2020 2066 7072  ut;..        fpr
-00077830: 696e 7466 2866 6f75 742c 2022 5c6e 2229  intf(fout, "\n")
-00077840: 3b0a 2020 2020 2020 2020 6670 7269 6e74  ;.        fprint
-00077850: 6628 666f 7574 2c20 2225 2d31 3673 2025  f(fout, "%-16s %
-00077860: 3878 5c6e 222c 2020 226d 6167 6963 222c  8x\n",  "magic",
-00077870: 2020 2047 474d 4c5f 4649 4c45 5f4d 4147     GGML_FILE_MAG
-00077880: 4943 293b 0a20 2020 2020 2020 2066 7072  IC);.        fpr
-00077890: 696e 7466 2866 6f75 742c 2022 252d 3136  intf(fout, "%-16
-000778a0: 7320 2538 645c 6e22 2c20 2022 7665 7273  s %8d\n",  "vers
-000778b0: 696f 6e22 2c20 4747 4d4c 5f46 494c 455f  ion", GGML_FILE_
-000778c0: 5645 5253 494f 4e29 3b0a 2020 2020 2020  VERSION);.      
-000778d0: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
-000778e0: 2225 2d31 3673 2025 3864 5c6e 222c 2020  "%-16s %8d\n",  
-000778f0: 226c 6561 6673 222c 2020 2063 6772 6170  "leafs",   cgrap
-00077900: 682d 3e6e 5f6c 6561 6673 293b 0a20 2020  h->n_leafs);.   
-00077910: 2020 2020 2066 7072 696e 7466 2866 6f75       fprintf(fou
-00077920: 742c 2022 252d 3136 7320 2538 645c 6e22  t, "%-16s %8d\n"
-00077930: 2c20 2022 6e6f 6465 7322 2c20 2020 6367  ,  "nodes",   cg
-00077940: 7261 7068 2d3e 6e5f 6e6f 6465 7329 3b0a  raph->n_nodes);.
-00077950: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-00077960: 666f 7574 2c20 2225 2d31 3673 2025 386a  fout, "%-16s %8j
-00077970: 755c 6e22 2c20 2265 7661 6c22 2c20 2020  u\n", "eval",   
-00077980: 2073 697a 655f 6576 616c 293b 0a0a 2020   size_eval);..  
-00077990: 2020 2020 2020 2f2f 2068 6561 6465 720a        // header.
-000779a0: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-000779b0: 666f 7574 2c20 225c 6e22 293b 0a20 2020  fout, "\n");.   
-000779c0: 2020 2020 2066 7072 696e 7466 2866 6f75       fprintf(fou
-000779d0: 742c 2022 252d 3673 2025 2d31 3273 2025  t, "%-6s %-12s %
-000779e0: 3873 2025 3873 2025 3873 2025 3873 2025  8s %8s %8s %8s %
-000779f0: 3873 2025 3136 7320 2531 3673 2025 3136  8s %16s %16s %16
+00075200: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00075210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075220: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
+00075230: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
+00075240: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00075250: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00075260: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00075270: 6173 6520 4747 4d4c 5f4f 505f 5749 4e5f  ase GGML_OP_WIN_
+00075280: 5041 5254 3a0a 2020 2020 2020 2020 2020  PART:.          
+00075290: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000752a0: 4f50 5f57 494e 5f55 4e50 4152 543a 0a20  OP_WIN_UNPART:. 
+000752b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000752c0: 6173 6520 4747 4d4c 5f4f 505f 4d41 505f  ase GGML_OP_MAP_
+000752d0: 554e 4152 593a 0a20 2020 2020 2020 2020  UNARY:.         
+000752e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000752f0: 5f4f 505f 4d41 505f 4249 4e41 5259 3a0a  _OP_MAP_BINARY:.
+00075300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075310: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00075320: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00075330: 6465 2d3e 6e5f 7461 736b 7320 3d20 313b  de->n_tasks = 1;
+00075340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00075350: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00075360: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00075370: 7365 2047 474d 4c5f 4f50 5f4e 4f4e 453a  se GGML_OP_NONE:
+00075380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00075390: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000753a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000753b0: 6f64 652d 3e6e 5f74 6173 6b73 203d 2031  ode->n_tasks = 1
+000753c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000753d0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000753e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000753f0: 6173 6520 4747 4d4c 5f4f 505f 434f 554e  ase GGML_OP_COUN
+00075400: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
+00075410: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00075420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075430: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+00075440: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+00075450: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00075460: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+00075470: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00075480: 2020 2069 6620 2863 6772 6170 682d 3e77     if (cgraph->w
+00075490: 6f72 6b20 213d 204e 554c 4c20 2626 2077  ork != NULL && w
+000754a0: 6f72 6b5f 7369 7a65 203e 2063 6772 6170  ork_size > cgrap
+000754b0: 682d 3e77 6f72 6b5f 7369 7a65 2920 7b0a  h->work_size) {.
+000754c0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000754d0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+000754e0: 2f2f 2054 4f44 4f3a 2062 6574 7465 7220  // TODO: better 
+000754f0: 6861 6e64 6c69 6e67 0a20 2020 2020 2020  handling.       
+00075500: 207d 0a0a 2020 2020 2020 2020 6966 2028   }..        if (
+00075510: 776f 726b 5f73 697a 6520 3e20 3020 2626  work_size > 0 &&
+00075520: 2063 6772 6170 682d 3e77 6f72 6b20 3d3d   cgraph->work ==
+00075530: 204e 554c 4c29 207b 0a20 2020 2020 2020   NULL) {.       
+00075540: 2020 2020 2063 6772 6170 682d 3e77 6f72       cgraph->wor
+00075550: 6b5f 7369 7a65 203d 2077 6f72 6b5f 7369  k_size = work_si
+00075560: 7a65 202b 2043 4143 4845 5f4c 494e 455f  ze + CACHE_LINE_
+00075570: 5349 5a45 2a28 6e5f 7468 7265 6164 7320  SIZE*(n_threads 
+00075580: 2d20 3129 3b0a 0a20 2020 2020 2020 2020  - 1);..         
+00075590: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
+000755a0: 4255 4728 2225 733a 2061 6c6c 6f63 6174  BUG("%s: allocat
+000755b0: 696e 6720 776f 726b 2062 7566 6665 7220  ing work buffer 
+000755c0: 666f 7220 6772 6170 6820 2825 7a75 2062  for graph (%zu b
+000755d0: 7974 6573 295c 6e22 2c20 5f5f 6675 6e63  ytes)\n", __func
+000755e0: 5f5f 2c20 6367 7261 7068 2d3e 776f 726b  __, cgraph->work
+000755f0: 5f73 697a 6529 3b0a 2020 2020 2020 2020  _size);.        
+00075600: 2020 2020 6367 7261 7068 2d3e 776f 726b      cgraph->work
+00075610: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00075620: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+00075630: 5459 5045 5f49 382c 2063 6772 6170 682d  TYPE_I8, cgraph-
+00075640: 3e77 6f72 6b5f 7369 7a65 293b 0a20 2020  >work_size);.   
+00075650: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
+00075660: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00075670: 7065 7266 5f73 7461 7274 5f63 7963 6c65  perf_start_cycle
+00075680: 7320 203d 2067 676d 6c5f 7065 7266 5f63  s  = ggml_perf_c
+00075690: 7963 6c65 7328 293b 0a20 2020 2063 6f6e  ycles();.    con
+000756a0: 7374 2069 6e74 3634 5f74 2070 6572 665f  st int64_t perf_
+000756b0: 7374 6172 745f 7469 6d65 5f75 7320 3d20  start_time_us = 
+000756c0: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
+000756d0: 7328 293b 0a0a 2020 2020 666f 7220 2869  s();..    for (i
+000756e0: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
+000756f0: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
+00075700: 2b2b 2920 7b0a 2020 2020 2020 2020 4747  ++) {.        GG
+00075710: 4d4c 5f50 5249 4e54 5f44 4542 5547 5f35  ML_PRINT_DEBUG_5
+00075720: 2822 2573 3a20 2564 2f25 645c 6e22 2c20  ("%s: %d/%d\n", 
+00075730: 5f5f 6675 6e63 5f5f 2c20 692c 2063 6772  __func__, i, cgr
+00075740: 6170 682d 3e6e 5f6e 6f64 6573 293b 0a0a  aph->n_nodes);..
+00075750: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00075760: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
+00075770: 6520 3d20 6367 7261 7068 2d3e 6e6f 6465  e = cgraph->node
+00075780: 735b 695d 3b0a 0a20 2020 2020 2020 202f  s[i];..        /
+00075790: 2f20 544f 444f 3a20 7468 6973 2063 6f75  / TODO: this cou
+000757a0: 6c64 2062 6520 7573 6564 2074 6f20 6176  ld be used to av
+000757b0: 6f69 6420 756e 6e65 6365 7373 6172 7920  oid unnecessary 
+000757c0: 636f 6d70 7574 6174 696f 6e73 2c20 6275  computations, bu
+000757d0: 7420 6974 206e 6565 6473 2074 6f20 6265  t it needs to be
+000757e0: 2069 6d70 726f 7665 640a 2020 2020 2020   improved.      
+000757f0: 2020 2f2f 6966 2028 6e6f 6465 2d3e 6772    //if (node->gr
+00075800: 6164 203d 3d20 4e55 4c4c 2026 2620 6e6f  ad == NULL && no
+00075810: 6465 2d3e 7065 7266 5f72 756e 7320 3e20  de->perf_runs > 
+00075820: 3029 207b 0a20 2020 2020 2020 202f 2f20  0) {.        // 
+00075830: 2020 2063 6f6e 7469 6e75 653b 0a20 2020     continue;.   
+00075840: 2020 2020 202f 2f7d 0a0a 2020 2020 2020       //}..      
+00075850: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00075860: 7065 7266 5f6e 6f64 655f 7374 6172 745f  perf_node_start_
+00075870: 6379 636c 6573 2020 3d20 6767 6d6c 5f70  cycles  = ggml_p
+00075880: 6572 665f 6379 636c 6573 2829 3b0a 2020  erf_cycles();.  
+00075890: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+000758a0: 345f 7420 7065 7266 5f6e 6f64 655f 7374  4_t perf_node_st
+000758b0: 6172 745f 7469 6d65 5f75 7320 3d20 6767  art_time_us = gg
+000758c0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
+000758d0: 293b 0a0a 2020 2020 2020 2020 2f2f 2049  );..        // I
+000758e0: 4e49 540a 2020 2020 2020 2020 7374 7275  NIT.        stru
+000758f0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00075900: 7061 7261 6d73 2070 6172 616d 7320 3d20  params params = 
+00075910: 7b0a 2020 2020 2020 2020 2020 2020 2f2a  {.            /*
+00075920: 2e74 7970 6520 203d 2a2f 2047 474d 4c5f  .type  =*/ GGML_
+00075930: 5441 534b 5f49 4e49 542c 0a20 2020 2020  TASK_INIT,.     
+00075940: 2020 2020 2020 202f 2a2e 6974 6820 2020         /*.ith   
+00075950: 3d2a 2f20 302c 0a20 2020 2020 2020 2020  =*/ 0,.         
+00075960: 2020 202f 2a2e 6e74 6820 2020 3d2a 2f20     /*.nth   =*/ 
+00075970: 6e6f 6465 2d3e 6e5f 7461 736b 732c 0a20  node->n_tasks,. 
+00075980: 2020 2020 2020 2020 2020 202f 2a2e 7773             /*.ws
+00075990: 697a 6520 3d2a 2f20 6367 7261 7068 2d3e  ize =*/ cgraph->
+000759a0: 776f 726b 203f 2067 676d 6c5f 6e62 7974  work ? ggml_nbyt
+000759b0: 6573 2863 6772 6170 682d 3e77 6f72 6b29  es(cgraph->work)
+000759c0: 203a 2030 2c0a 2020 2020 2020 2020 2020   : 0,.          
+000759d0: 2020 2f2a 2e77 6461 7461 203d 2a2f 2063    /*.wdata =*/ c
+000759e0: 6772 6170 682d 3e77 6f72 6b20 3f20 6367  graph->work ? cg
+000759f0: 7261 7068 2d3e 776f 726b 2d3e 6461 7461  raph->work->data
+00075a00: 203a 204e 554c 4c2c 0a20 2020 2020 2020   : NULL,.       
+00075a10: 207d 3b0a 0a20 2020 2020 2020 2067 676d   };..        ggm
+00075a20: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00075a30: 6428 2670 6172 616d 732c 206e 6f64 6529  d(&params, node)
+00075a40: 3b0a 0a20 2020 2020 2020 202f 2f20 434f  ;..        // CO
+00075a50: 4d50 5554 450a 2020 2020 2020 2020 6966  MPUTE.        if
+00075a60: 2028 6e6f 6465 2d3e 6e5f 7461 736b 7320   (node->n_tasks 
+00075a70: 3e20 3129 207b 0a20 2020 2020 2020 2020  > 1) {.         
+00075a80: 2020 2069 6620 2861 746f 6d69 635f 6665     if (atomic_fe
+00075a90: 7463 685f 6164 6428 2673 7461 7465 5f73  tch_add(&state_s
+00075aa0: 6861 7265 642e 6e5f 7265 6164 792c 2031  hared.n_ready, 1
+00075ab0: 2920 3d3d 206e 5f74 6872 6561 6473 202d  ) == n_threads -
+00075ac0: 2031 2920 7b0a 2020 2020 2020 2020 2020   1) {.          
+00075ad0: 2020 2020 2020 6174 6f6d 6963 5f73 746f        atomic_sto
+00075ae0: 7265 2826 7374 6174 655f 7368 6172 6564  re(&state_shared
+00075af0: 2e68 6173 5f77 6f72 6b2c 2066 616c 7365  .has_work, false
+00075b00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00075b10: 0a0a 2020 2020 2020 2020 2020 2020 7768  ..            wh
+00075b20: 696c 6520 2861 746f 6d69 635f 6c6f 6164  ile (atomic_load
+00075b30: 2826 7374 6174 655f 7368 6172 6564 2e68  (&state_shared.h
+00075b40: 6173 5f77 6f72 6b29 2920 7b0a 2020 2020  as_work)) {.    
+00075b50: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00075b60: 5f6c 6f63 6b5f 6c6f 636b 2020 2826 7374  _lock_lock  (&st
+00075b70: 6174 655f 7368 6172 6564 2e73 7069 6e29  ate_shared.spin)
+00075b80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00075b90: 2020 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f    ggml_lock_unlo
+00075ba0: 636b 2826 7374 6174 655f 7368 6172 6564  ck(&state_shared
+00075bb0: 2e73 7069 6e29 3b0a 2020 2020 2020 2020  .spin);.        
+00075bc0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00075bd0: 2020 202f 2f20 6c61 756e 6368 2074 6872     // launch thr
+00075be0: 6561 6420 706f 6f6c 0a20 2020 2020 2020  ead pool.       
+00075bf0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+00075c00: 3d20 303b 206a 203c 206e 5f74 6872 6561  = 0; j < n_threa
+00075c10: 6473 202d 2031 3b20 6a2b 2b29 207b 0a20  ds - 1; j++) {. 
+00075c20: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00075c30: 6f72 6b65 7273 5b6a 5d2e 7061 7261 6d73  orkers[j].params
+00075c40: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
+00075c50: 636f 6d70 7574 655f 7061 7261 6d73 2920  compute_params) 
+00075c60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00075c70: 2020 2020 2020 2e74 7970 6520 203d 2047        .type  = G
+00075c80: 474d 4c5f 5441 534b 5f43 4f4d 5055 5445  GML_TASK_COMPUTE
+00075c90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00075ca0: 2020 2020 2020 2e69 7468 2020 203d 206a        .ith   = j
+00075cb0: 202b 2031 2c0a 2020 2020 2020 2020 2020   + 1,.          
+00075cc0: 2020 2020 2020 2020 2020 2e6e 7468 2020            .nth  
+00075cd0: 203d 206e 6f64 652d 3e6e 5f74 6173 6b73   = node->n_tasks
+00075ce0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00075cf0: 2020 2020 2020 2e77 7369 7a65 203d 2063        .wsize = c
+00075d00: 6772 6170 682d 3e77 6f72 6b20 3f20 6767  graph->work ? gg
+00075d10: 6d6c 5f6e 6279 7465 7328 6367 7261 7068  ml_nbytes(cgraph
+00075d20: 2d3e 776f 726b 2920 3a20 302c 0a20 2020  ->work) : 0,.   
+00075d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075d40: 202e 7764 6174 6120 3d20 6367 7261 7068   .wdata = cgraph
+00075d50: 2d3e 776f 726b 203f 2063 6772 6170 682d  ->work ? cgraph-
+00075d60: 3e77 6f72 6b2d 3e64 6174 6120 3a20 4e55  >work->data : NU
+00075d70: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+00075d80: 2020 2020 7d3b 0a20 2020 2020 2020 2020      };.         
+00075d90: 2020 2020 2020 2077 6f72 6b65 7273 5b6a         workers[j
+00075da0: 5d2e 6e6f 6465 203d 206e 6f64 653b 0a20  ].node = node;. 
+00075db0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+00075dc0: 2020 2020 2020 2020 2020 6174 6f6d 6963            atomic
+00075dd0: 5f66 6574 6368 5f73 7562 2826 7374 6174  _fetch_sub(&stat
+00075de0: 655f 7368 6172 6564 2e6e 5f72 6561 6479  e_shared.n_ready
+00075df0: 2c20 3129 3b0a 0a20 2020 2020 2020 2020  , 1);..         
+00075e00: 2020 2077 6869 6c65 2028 6174 6f6d 6963     while (atomic
+00075e10: 5f6c 6f61 6428 2673 7461 7465 5f73 6861  _load(&state_sha
+00075e20: 7265 642e 6e5f 7265 6164 7929 203e 2030  red.n_ready) > 0
+00075e30: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00075e40: 2020 2020 6767 6d6c 5f6c 6f63 6b5f 6c6f      ggml_lock_lo
+00075e50: 636b 2020 2826 7374 6174 655f 7368 6172  ck  (&state_shar
+00075e60: 6564 2e73 7069 6e29 3b0a 2020 2020 2020  ed.spin);.      
+00075e70: 2020 2020 2020 2020 2020 6767 6d6c 5f6c            ggml_l
+00075e80: 6f63 6b5f 756e 6c6f 636b 2826 7374 6174  ock_unlock(&stat
+00075e90: 655f 7368 6172 6564 2e73 7069 6e29 3b0a  e_shared.spin);.
+00075ea0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00075eb0: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
+00075ec0: 635f 7374 6f72 6528 2673 7461 7465 5f73  c_store(&state_s
+00075ed0: 6861 7265 642e 6861 735f 776f 726b 2c20  hared.has_work, 
+00075ee0: 7472 7565 293b 0a20 2020 2020 2020 207d  true);.        }
+00075ef0: 0a0a 2020 2020 2020 2020 7061 7261 6d73  ..        params
+00075f00: 2e74 7970 6520 3d20 4747 4d4c 5f54 4153  .type = GGML_TAS
+00075f10: 4b5f 434f 4d50 5554 453b 0a20 2020 2020  K_COMPUTE;.     
+00075f20: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00075f30: 666f 7277 6172 6428 2670 6172 616d 732c  forward(&params,
+00075f40: 206e 6f64 6529 3b0a 0a20 2020 2020 2020   node);..       
+00075f50: 202f 2f20 7761 6974 2066 6f72 2074 6872   // wait for thr
+00075f60: 6561 6420 706f 6f6c 0a20 2020 2020 2020  ead pool.       
+00075f70: 2069 6620 286e 6f64 652d 3e6e 5f74 6173   if (node->n_tas
+00075f80: 6b73 203e 2031 2920 7b0a 2020 2020 2020  ks > 1) {.      
+00075f90: 2020 2020 2020 6966 2028 6174 6f6d 6963        if (atomic
+00075fa0: 5f66 6574 6368 5f61 6464 2826 7374 6174  _fetch_add(&stat
+00075fb0: 655f 7368 6172 6564 2e6e 5f72 6561 6479  e_shared.n_ready
+00075fc0: 2c20 3129 203d 3d20 6e5f 7468 7265 6164  , 1) == n_thread
+00075fd0: 7320 2d20 3129 207b 0a20 2020 2020 2020  s - 1) {.       
+00075fe0: 2020 2020 2020 2020 2061 746f 6d69 635f           atomic_
+00075ff0: 7374 6f72 6528 2673 7461 7465 5f73 6861  store(&state_sha
+00076000: 7265 642e 6861 735f 776f 726b 2c20 6661  red.has_work, fa
+00076010: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+00076020: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00076030: 2077 6869 6c65 2028 6174 6f6d 6963 5f6c   while (atomic_l
+00076040: 6f61 6428 2673 7461 7465 5f73 6861 7265  oad(&state_share
+00076050: 642e 6861 735f 776f 726b 2929 207b 0a20  d.has_work)) {. 
+00076060: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00076070: 676d 6c5f 6c6f 636b 5f6c 6f63 6b20 2028  gml_lock_lock  (
+00076080: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
+00076090: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
+000760a0: 2020 2020 2067 676d 6c5f 6c6f 636b 5f75       ggml_lock_u
+000760b0: 6e6c 6f63 6b28 2673 7461 7465 5f73 6861  nlock(&state_sha
+000760c0: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
+000760d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+000760e0: 2020 2020 2020 6174 6f6d 6963 5f66 6574        atomic_fet
+000760f0: 6368 5f73 7562 2826 7374 6174 655f 7368  ch_sub(&state_sh
+00076100: 6172 6564 2e6e 5f72 6561 6479 2c20 3129  ared.n_ready, 1)
+00076110: 3b0a 0a20 2020 2020 2020 2020 2020 2077  ;..            w
+00076120: 6869 6c65 2028 6174 6f6d 6963 5f6c 6f61  hile (atomic_loa
+00076130: 6428 2673 7461 7465 5f73 6861 7265 642e  d(&state_shared.
+00076140: 6e5f 7265 6164 7929 2021 3d20 3029 207b  n_ready) != 0) {
+00076150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076160: 2067 676d 6c5f 6c6f 636b 5f6c 6f63 6b20   ggml_lock_lock 
+00076170: 2028 2673 7461 7465 5f73 6861 7265 642e   (&state_shared.
+00076180: 7370 696e 293b 0a20 2020 2020 2020 2020  spin);.         
+00076190: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
+000761a0: 5f75 6e6c 6f63 6b28 2673 7461 7465 5f73  _unlock(&state_s
+000761b0: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
+000761c0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000761d0: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
+000761e0: 2046 494e 414c 495a 450a 2020 2020 2020   FINALIZE.      
+000761f0: 2020 6966 2028 6e6f 6465 2d3e 6e5f 7461    if (node->n_ta
+00076200: 736b 7320 3e20 3129 207b 0a20 2020 2020  sks > 1) {.     
+00076210: 2020 2020 2020 2069 6620 2861 746f 6d69         if (atomi
+00076220: 635f 6665 7463 685f 6164 6428 2673 7461  c_fetch_add(&sta
+00076230: 7465 5f73 6861 7265 642e 6e5f 7265 6164  te_shared.n_read
+00076240: 792c 2031 2920 3d3d 206e 5f74 6872 6561  y, 1) == n_threa
+00076250: 6473 202d 2031 2920 7b0a 2020 2020 2020  ds - 1) {.      
+00076260: 2020 2020 2020 2020 2020 6174 6f6d 6963            atomic
+00076270: 5f73 746f 7265 2826 7374 6174 655f 7368  _store(&state_sh
+00076280: 6172 6564 2e68 6173 5f77 6f72 6b2c 2066  ared.has_work, f
+00076290: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+000762a0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+000762b0: 2020 7768 696c 6520 2861 746f 6d69 635f    while (atomic_
+000762c0: 6c6f 6164 2826 7374 6174 655f 7368 6172  load(&state_shar
+000762d0: 6564 2e68 6173 5f77 6f72 6b29 2920 7b0a  ed.has_work)) {.
+000762e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000762f0: 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020  ggml_lock_lock  
+00076300: 2826 7374 6174 655f 7368 6172 6564 2e73  (&state_shared.s
+00076310: 7069 6e29 3b0a 2020 2020 2020 2020 2020  pin);.          
+00076320: 2020 2020 2020 6767 6d6c 5f6c 6f63 6b5f        ggml_lock_
+00076330: 756e 6c6f 636b 2826 7374 6174 655f 7368  unlock(&state_sh
+00076340: 6172 6564 2e73 7069 6e29 3b0a 2020 2020  ared.spin);.    
+00076350: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00076360: 2020 2020 2020 202f 2f20 6c61 756e 6368         // launch
+00076370: 2074 6872 6561 6420 706f 6f6c 0a20 2020   thread pool.   
+00076380: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00076390: 7420 6a20 3d20 303b 206a 203c 206e 5f74  t j = 0; j < n_t
+000763a0: 6872 6561 6473 202d 2031 3b20 6a2b 2b29  hreads - 1; j++)
+000763b0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000763c0: 2020 2077 6f72 6b65 7273 5b6a 5d2e 7061     workers[j].pa
+000763d0: 7261 6d73 203d 2028 7374 7275 6374 2067  rams = (struct g
+000763e0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000763f0: 6d73 2920 7b0a 2020 2020 2020 2020 2020  ms) {.          
+00076400: 2020 2020 2020 2020 2020 2e74 7970 6520            .type 
+00076410: 203d 2047 474d 4c5f 5441 534b 5f46 494e   = GGML_TASK_FIN
+00076420: 414c 495a 452c 0a20 2020 2020 2020 2020  ALIZE,.         
+00076430: 2020 2020 2020 2020 2020 202e 6974 6820             .ith 
+00076440: 2020 3d20 6a20 2b20 312c 0a20 2020 2020    = j + 1,.     
+00076450: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00076460: 6e74 6820 2020 3d20 6e6f 6465 2d3e 6e5f  nth   = node->n_
+00076470: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
+00076480: 2020 2020 2020 2020 2020 202e 7773 697a             .wsiz
+00076490: 6520 3d20 6367 7261 7068 2d3e 776f 726b  e = cgraph->work
+000764a0: 203f 2067 676d 6c5f 6e62 7974 6573 2863   ? ggml_nbytes(c
+000764b0: 6772 6170 682d 3e77 6f72 6b29 203a 2030  graph->work) : 0
+000764c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000764d0: 2020 2020 2020 2e77 6461 7461 203d 2063        .wdata = c
+000764e0: 6772 6170 682d 3e77 6f72 6b20 3f20 6367  graph->work ? cg
+000764f0: 7261 7068 2d3e 776f 726b 2d3e 6461 7461  raph->work->data
+00076500: 203a 204e 554c 4c2c 0a20 2020 2020 2020   : NULL,.       
+00076510: 2020 2020 2020 2020 207d 3b0a 2020 2020           };.    
+00076520: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00076530: 6572 735b 6a5d 2e6e 6f64 6520 3d20 6e6f  ers[j].node = no
+00076540: 6465 3b0a 2020 2020 2020 2020 2020 2020  de;.            
+00076550: 7d0a 0a20 2020 2020 2020 2020 2020 2061  }..            a
+00076560: 746f 6d69 635f 6665 7463 685f 7375 6228  tomic_fetch_sub(
+00076570: 2673 7461 7465 5f73 6861 7265 642e 6e5f  &state_shared.n_
+00076580: 7265 6164 792c 2031 293b 0a0a 2020 2020  ready, 1);..    
+00076590: 2020 2020 2020 2020 7768 696c 6520 2861          while (a
+000765a0: 746f 6d69 635f 6c6f 6164 2826 7374 6174  tomic_load(&stat
+000765b0: 655f 7368 6172 6564 2e6e 5f72 6561 6479  e_shared.n_ready
+000765c0: 2920 3e20 3029 207b 0a20 2020 2020 2020  ) > 0) {.       
+000765d0: 2020 2020 2020 2020 2067 676d 6c5f 6c6f           ggml_lo
+000765e0: 636b 5f6c 6f63 6b20 2028 2673 7461 7465  ck_lock  (&state
+000765f0: 5f73 6861 7265 642e 7370 696e 293b 0a20  _shared.spin);. 
+00076600: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00076610: 676d 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28  gml_lock_unlock(
+00076620: 2673 7461 7465 5f73 6861 7265 642e 7370  &state_shared.sp
+00076630: 696e 293b 0a20 2020 2020 2020 2020 2020  in);.           
+00076640: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+00076650: 6174 6f6d 6963 5f73 746f 7265 2826 7374  atomic_store(&st
+00076660: 6174 655f 7368 6172 6564 2e68 6173 5f77  ate_shared.has_w
+00076670: 6f72 6b2c 2074 7275 6529 3b0a 2020 2020  ork, true);.    
+00076680: 2020 2020 7d0a 0a20 2020 2020 2020 2070      }..        p
+00076690: 6172 616d 732e 7479 7065 203d 2047 474d  arams.type = GGM
+000766a0: 4c5f 5441 534b 5f46 494e 414c 495a 453b  L_TASK_FINALIZE;
+000766b0: 0a20 2020 2020 2020 2067 676d 6c5f 636f  .        ggml_co
+000766c0: 6d70 7574 655f 666f 7277 6172 6428 2670  mpute_forward(&p
+000766d0: 6172 616d 732c 206e 6f64 6529 3b0a 0a20  arams, node);.. 
+000766e0: 2020 2020 2020 202f 2f20 7761 6974 2066         // wait f
+000766f0: 6f72 2074 6872 6561 6420 706f 6f6c 0a20  or thread pool. 
+00076700: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
+00076710: 3e6e 5f74 6173 6b73 203e 2031 2920 7b0a  >n_tasks > 1) {.
+00076720: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00076730: 6174 6f6d 6963 5f66 6574 6368 5f61 6464  atomic_fetch_add
+00076740: 2826 7374 6174 655f 7368 6172 6564 2e6e  (&state_shared.n
+00076750: 5f72 6561 6479 2c20 3129 203d 3d20 6e5f  _ready, 1) == n_
+00076760: 7468 7265 6164 7320 2d20 3129 207b 0a20  threads - 1) {. 
+00076770: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00076780: 746f 6d69 635f 7374 6f72 6528 2673 7461  tomic_store(&sta
+00076790: 7465 5f73 6861 7265 642e 6861 735f 776f  te_shared.has_wo
+000767a0: 726b 2c20 6661 6c73 6529 3b0a 2020 2020  rk, false);.    
+000767b0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000767c0: 2020 2020 2020 2077 6869 6c65 2028 6174         while (at
+000767d0: 6f6d 6963 5f6c 6f61 6428 2673 7461 7465  omic_load(&state
+000767e0: 5f73 6861 7265 642e 6861 735f 776f 726b  _shared.has_work
+000767f0: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
+00076800: 2020 2020 2067 676d 6c5f 6c6f 636b 5f6c       ggml_lock_l
+00076810: 6f63 6b20 2028 2673 7461 7465 5f73 6861  ock  (&state_sha
+00076820: 7265 642e 7370 696e 293b 0a20 2020 2020  red.spin);.     
+00076830: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00076840: 6c6f 636b 5f75 6e6c 6f63 6b28 2673 7461  lock_unlock(&sta
+00076850: 7465 5f73 6861 7265 642e 7370 696e 293b  te_shared.spin);
+00076860: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00076870: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
+00076880: 6963 5f66 6574 6368 5f73 7562 2826 7374  ic_fetch_sub(&st
+00076890: 6174 655f 7368 6172 6564 2e6e 5f72 6561  ate_shared.n_rea
+000768a0: 6479 2c20 3129 3b0a 0a20 2020 2020 2020  dy, 1);..       
+000768b0: 2020 2020 2077 6869 6c65 2028 6174 6f6d       while (atom
+000768c0: 6963 5f6c 6f61 6428 2673 7461 7465 5f73  ic_load(&state_s
+000768d0: 6861 7265 642e 6e5f 7265 6164 7929 2021  hared.n_ready) !
+000768e0: 3d20 3029 207b 0a20 2020 2020 2020 2020  = 0) {.         
+000768f0: 2020 2020 2020 2067 676d 6c5f 6c6f 636b         ggml_lock
+00076900: 5f6c 6f63 6b20 2028 2673 7461 7465 5f73  _lock  (&state_s
+00076910: 6861 7265 642e 7370 696e 293b 0a20 2020  hared.spin);.   
+00076920: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00076930: 6c5f 6c6f 636b 5f75 6e6c 6f63 6b28 2673  l_lock_unlock(&s
+00076940: 7461 7465 5f73 6861 7265 642e 7370 696e  tate_shared.spin
+00076950: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00076960: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00076970: 2020 2020 2f2f 2070 6572 666f 726d 616e      // performan
+00076980: 6365 2073 7461 7473 2028 6e6f 6465 290a  ce stats (node).
+00076990: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000769a0: 2020 2020 2020 696e 7436 345f 7420 7065        int64_t pe
+000769b0: 7266 5f63 7963 6c65 735f 6375 7220 203d  rf_cycles_cur  =
+000769c0: 2067 676d 6c5f 7065 7266 5f63 7963 6c65   ggml_perf_cycle
+000769d0: 7328 2920 202d 2070 6572 665f 6e6f 6465  s()  - perf_node
+000769e0: 5f73 7461 7274 5f63 7963 6c65 733b 0a20  _start_cycles;. 
+000769f0: 2020 2020 2020 2020 2020 2069 6e74 3634             int64
+00076a00: 5f74 2070 6572 665f 7469 6d65 5f75 735f  _t perf_time_us_
+00076a10: 6375 7220 3d20 6767 6d6c 5f70 6572 665f  cur = ggml_perf_
+00076a20: 7469 6d65 5f75 7328 2920 2d20 7065 7266  time_us() - perf
+00076a30: 5f6e 6f64 655f 7374 6172 745f 7469 6d65  _node_start_time
+00076a40: 5f75 733b 0a0a 2020 2020 2020 2020 2020  _us;..          
+00076a50: 2020 6e6f 6465 2d3e 7065 7266 5f72 756e    node->perf_run
+00076a60: 732b 2b3b 0a20 2020 2020 2020 2020 2020  s++;.           
+00076a70: 206e 6f64 652d 3e70 6572 665f 6379 636c   node->perf_cycl
+00076a80: 6573 2020 2b3d 2070 6572 665f 6379 636c  es  += perf_cycl
+00076a90: 6573 5f63 7572 3b0a 2020 2020 2020 2020  es_cur;.        
+00076aa0: 2020 2020 6e6f 6465 2d3e 7065 7266 5f74      node->perf_t
+00076ab0: 696d 655f 7573 202b 3d20 7065 7266 5f74  ime_us += perf_t
+00076ac0: 696d 655f 7573 5f63 7572 3b0a 2020 2020  ime_us_cur;.    
+00076ad0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+00076ae0: 202f 2f20 6a6f 696e 2074 6872 6561 6420   // join thread 
+00076af0: 706f 6f6c 0a20 2020 2069 6620 286e 5f74  pool.    if (n_t
+00076b00: 6872 6561 6473 203e 2031 2920 7b0a 2020  hreads > 1) {.  
+00076b10: 2020 2020 2020 6174 6f6d 6963 5f73 746f        atomic_sto
+00076b20: 7265 2826 7374 6174 655f 7368 6172 6564  re(&state_shared
+00076b30: 2e73 746f 702c 2074 7275 6529 3b0a 2020  .stop, true);.  
+00076b40: 2020 2020 2020 6174 6f6d 6963 5f73 746f        atomic_sto
+00076b50: 7265 2826 7374 6174 655f 7368 6172 6564  re(&state_shared
+00076b60: 2e68 6173 5f77 6f72 6b2c 2074 7275 6529  .has_work, true)
+00076b70: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
+00076b80: 696e 7420 6a20 3d20 303b 206a 203c 206e  int j = 0; j < n
+00076b90: 5f74 6872 6561 6473 202d 2031 3b20 6a2b  _threads - 1; j+
+00076ba0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00076bb0: 2069 6e74 2072 6320 3d20 6767 6d6c 5f74   int rc = ggml_t
+00076bc0: 6872 6561 645f 6a6f 696e 2877 6f72 6b65  hread_join(worke
+00076bd0: 7273 5b6a 5d2e 7468 7264 2c20 4e55 4c4c  rs[j].thrd, NULL
+00076be0: 293b 0a20 2020 2020 2020 2020 2020 2047  );.            G
+00076bf0: 474d 4c5f 4153 5345 5254 2872 6320 3d3d  GML_ASSERT(rc ==
+00076c00: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
+00076c10: 2055 4e55 5345 4428 7263 293b 0a20 2020   UNUSED(rc);.   
+00076c20: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00076c30: 6767 6d6c 5f6c 6f63 6b5f 6465 7374 726f  ggml_lock_destro
+00076c40: 7928 2673 7461 7465 5f73 6861 7265 642e  y(&state_shared.
+00076c50: 7370 696e 293b 0a20 2020 207d 0a0a 2020  spin);.    }..  
+00076c60: 2020 2f2f 2070 6572 666f 726d 616e 6365    // performance
+00076c70: 2073 7461 7473 2028 6772 6170 6829 0a20   stats (graph). 
+00076c80: 2020 207b 0a20 2020 2020 2020 2069 6e74     {.        int
+00076c90: 3634 5f74 2070 6572 665f 6379 636c 6573  64_t perf_cycles
+00076ca0: 5f63 7572 2020 3d20 6767 6d6c 5f70 6572  _cur  = ggml_per
+00076cb0: 665f 6379 636c 6573 2829 2020 2d20 7065  f_cycles()  - pe
+00076cc0: 7266 5f73 7461 7274 5f63 7963 6c65 733b  rf_start_cycles;
+00076cd0: 0a20 2020 2020 2020 2069 6e74 3634 5f74  .        int64_t
+00076ce0: 2070 6572 665f 7469 6d65 5f75 735f 6375   perf_time_us_cu
+00076cf0: 7220 3d20 6767 6d6c 5f70 6572 665f 7469  r = ggml_perf_ti
+00076d00: 6d65 5f75 7328 2920 2d20 7065 7266 5f73  me_us() - perf_s
+00076d10: 7461 7274 5f74 696d 655f 7573 3b0a 0a20  tart_time_us;.. 
+00076d20: 2020 2020 2020 2063 6772 6170 682d 3e70         cgraph->p
+00076d30: 6572 665f 7275 6e73 2b2b 3b0a 2020 2020  erf_runs++;.    
+00076d40: 2020 2020 6367 7261 7068 2d3e 7065 7266      cgraph->perf
+00076d50: 5f63 7963 6c65 7320 202b 3d20 7065 7266  _cycles  += perf
+00076d60: 5f63 7963 6c65 735f 6375 723b 0a20 2020  _cycles_cur;.   
+00076d70: 2020 2020 2063 6772 6170 682d 3e70 6572       cgraph->per
+00076d80: 665f 7469 6d65 5f75 7320 2b3d 2070 6572  f_time_us += per
+00076d90: 665f 7469 6d65 5f75 735f 6375 723b 0a0a  f_time_us_cur;..
+00076da0: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+00076db0: 4e54 5f44 4542 5547 2822 2573 3a20 7065  NT_DEBUG("%s: pe
+00076dc0: 7266 2028 2564 2920 2d20 6370 7520 3d20  rf (%d) - cpu = 
+00076dd0: 252e 3366 202f 2025 2e33 6620 6d73 2c20  %.3f / %.3f ms, 
+00076de0: 7761 6c6c 203d 2025 2e33 6620 2f20 252e  wall = %.3f / %.
+00076df0: 3366 206d 735c 6e22 2c0a 2020 2020 2020  3f ms\n",.      
+00076e00: 2020 2020 2020 2020 2020 5f5f 6675 6e63            __func
+00076e10: 5f5f 2c20 6367 7261 7068 2d3e 7065 7266  __, cgraph->perf
+00076e20: 5f72 756e 732c 0a20 2020 2020 2020 2020  _runs,.         
+00076e30: 2020 2020 2020 2028 646f 7562 6c65 2920         (double) 
+00076e40: 7065 7266 5f63 7963 6c65 735f 6375 7220  perf_cycles_cur 
+00076e50: 2020 2020 202f 2028 646f 7562 6c65 2920       / (double) 
+00076e60: 6767 6d6c 5f63 7963 6c65 735f 7065 725f  ggml_cycles_per_
+00076e70: 6d73 2829 2c0a 2020 2020 2020 2020 2020  ms(),.          
+00076e80: 2020 2020 2020 2864 6f75 626c 6529 2063        (double) c
+00076e90: 6772 6170 682d 3e70 6572 665f 6379 636c  graph->perf_cycl
+00076ea0: 6573 2020 2f20 2864 6f75 626c 6529 2067  es  / (double) g
+00076eb0: 676d 6c5f 6379 636c 6573 5f70 6572 5f6d  gml_cycles_per_m
+00076ec0: 7328 2920 2f20 2864 6f75 626c 6529 2063  s() / (double) c
+00076ed0: 6772 6170 682d 3e70 6572 665f 7275 6e73  graph->perf_runs
+00076ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00076ef0: 2020 2864 6f75 626c 6529 2070 6572 665f    (double) perf_
+00076f00: 7469 6d65 5f75 735f 6375 7220 2020 2020  time_us_cur     
+00076f10: 2f20 3130 3030 2e30 2c0a 2020 2020 2020  / 1000.0,.      
+00076f20: 2020 2020 2020 2020 2020 2864 6f75 626c            (doubl
+00076f30: 6529 2063 6772 6170 682d 3e70 6572 665f  e) cgraph->perf_
+00076f40: 7469 6d65 5f75 7320 2f20 3130 3030 2e30  time_us / 1000.0
+00076f50: 202f 2063 6772 6170 682d 3e70 6572 665f   / cgraph->perf_
+00076f60: 7275 6e73 293b 0a20 2020 207d 0a7d 0a0a  runs);.    }.}..
+00076f70: 766f 6964 2067 676d 6c5f 6772 6170 685f  void ggml_graph_
+00076f80: 7265 7365 7428 7374 7275 6374 2067 676d  reset(struct ggm
+00076f90: 6c5f 6367 7261 7068 202a 2063 6772 6170  l_cgraph * cgrap
+00076fa0: 6829 207b 0a20 2020 2066 6f72 2028 696e  h) {.    for (in
+00076fb0: 7420 6920 3d20 303b 2069 203c 2063 6772  t i = 0; i < cgr
+00076fc0: 6170 682d 3e6e 5f6e 6f64 6573 3b20 692b  aph->n_nodes; i+
+00076fd0: 2b29 207b 0a20 2020 2020 2020 2073 7472  +) {.        str
+00076fe0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00076ff0: 2a20 6772 6164 203d 2063 6772 6170 682d  * grad = cgraph-
+00077000: 3e67 7261 6473 5b69 5d3b 0a0a 2020 2020  >grads[i];..    
+00077010: 2020 2020 6966 2028 6772 6164 2920 7b0a      if (grad) {.
+00077020: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00077030: 5f73 6574 5f7a 6572 6f28 6772 6164 293b  _set_zero(grad);
+00077040: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00077050: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+00077060: 7465 6e73 6f72 202a 2067 676d 6c5f 6772  tensor * ggml_gr
+00077070: 6170 685f 6765 745f 7465 6e73 6f72 2873  aph_get_tensor(s
+00077080: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00077090: 6820 2a20 6367 7261 7068 2c20 636f 6e73  h * cgraph, cons
+000770a0: 7420 6368 6172 202a 206e 616d 6529 207b  t char * name) {
+000770b0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+000770c0: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
+000770d0: 3e6e 5f6c 6561 6673 3b20 692b 2b29 207b  >n_leafs; i++) {
+000770e0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000770f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6c65  ggml_tensor * le
+00077100: 6166 203d 2063 6772 6170 682d 3e6c 6561  af = cgraph->lea
+00077110: 6673 5b69 5d3b 0a0a 2020 2020 2020 2020  fs[i];..        
+00077120: 6966 2028 7374 7263 6d70 286c 6561 662d  if (strcmp(leaf-
+00077130: 3e6e 616d 652c 206e 616d 6529 203d 3d20  >name, name) == 
+00077140: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00077150: 2072 6574 7572 6e20 6c65 6166 3b0a 2020   return leaf;.  
+00077160: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+00077170: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00077180: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
+00077190: 5f6e 6f64 6573 3b20 692b 2b29 207b 0a20  _nodes; i++) {. 
+000771a0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000771b0: 6d6c 5f74 656e 736f 7220 2a20 6e6f 6465  ml_tensor * node
+000771c0: 203d 2063 6772 6170 682d 3e6e 6f64 6573   = cgraph->nodes
+000771d0: 5b69 5d3b 0a0a 2020 2020 2020 2020 6966  [i];..        if
+000771e0: 2028 7374 7263 6d70 286e 6f64 652d 3e6e   (strcmp(node->n
+000771f0: 616d 652c 206e 616d 6529 203d 3d20 3029  ame, name) == 0)
+00077200: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
+00077210: 6574 7572 6e20 6e6f 6465 3b0a 2020 2020  eturn node;.    
+00077220: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+00077230: 2072 6574 7572 6e20 4e55 4c4c 3b0a 7d0a   return NULL;.}.
+00077240: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00077250: 6c5f 6772 6170 685f 6578 706f 7274 5f6c  l_graph_export_l
+00077260: 6561 6628 636f 6e73 7420 7374 7275 6374  eaf(const struct
+00077270: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
+00077280: 656e 736f 722c 2046 494c 4520 2a20 666f  ensor, FILE * fo
+00077290: 7574 2920 7b0a 2020 2020 636f 6e73 7420  ut) {.    const 
+000772a0: 696e 7436 345f 7420 2a20 6e65 203d 2074  int64_t * ne = t
+000772b0: 656e 736f 722d 3e6e 653b 0a20 2020 2063  ensor->ne;.    c
+000772c0: 6f6e 7374 2073 697a 655f 7420 202a 206e  onst size_t  * n
+000772d0: 6220 3d20 7465 6e73 6f72 2d3e 6e62 3b0a  b = tensor->nb;.
+000772e0: 0a20 2020 2066 7072 696e 7466 2866 6f75  .    fprintf(fou
+000772f0: 742c 2022 252d 3673 2025 2d31 3273 2025  t, "%-6s %-12s %
+00077300: 3864 2025 386a 6420 256a 6420 256a 6420  8d %8jd %jd %jd 
+00077310: 256a 6420 2531 367a 7520 2531 367a 7520  %jd %16zu %16zu 
+00077320: 2531 367a 7520 2531 367a 7520 2531 3670  %16zu %16zu %16p
+00077330: 2025 3136 735c 6e22 2c0a 2020 2020 2020   %16s\n",.      
+00077340: 2020 2020 2020 6767 6d6c 5f74 7970 655f        ggml_type_
+00077350: 6e61 6d65 2874 656e 736f 722d 3e74 7970  name(tensor->typ
+00077360: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00077370: 6767 6d6c 5f6f 705f 6e61 6d65 2020 2874  ggml_op_name  (t
+00077380: 656e 736f 722d 3e6f 7029 2c0a 2020 2020  ensor->op),.    
+00077390: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
+000773a0: 6e5f 6469 6d73 2c0a 2020 2020 2020 2020  n_dims,.        
+000773b0: 2020 2020 6e65 5b30 5d2c 206e 655b 315d      ne[0], ne[1]
+000773c0: 2c20 6e65 5b32 5d2c 206e 655b 335d 2c0a  , ne[2], ne[3],.
+000773d0: 2020 2020 2020 2020 2020 2020 6e62 5b30              nb[0
+000773e0: 5d2c 206e 625b 315d 2c20 6e62 5b32 5d2c  ], nb[1], nb[2],
+000773f0: 206e 625b 335d 2c0a 2020 2020 2020 2020   nb[3],.        
+00077400: 2020 2020 7465 6e73 6f72 2d3e 6461 7461      tensor->data
+00077410: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
+00077420: 6e73 6f72 2d3e 6e61 6d65 293b 0a7d 0a0a  nsor->name);.}..
+00077430: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00077440: 5f67 7261 7068 5f65 7870 6f72 745f 6e6f  _graph_export_no
+00077450: 6465 2863 6f6e 7374 2073 7472 7563 7420  de(const struct 
+00077460: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+00077470: 6e73 6f72 2c20 636f 6e73 7420 6368 6172  nsor, const char
+00077480: 202a 2061 7267 2c20 4649 4c45 202a 2066   * arg, FILE * f
+00077490: 6f75 7429 207b 0a20 2020 2063 6f6e 7374  out) {.    const
+000774a0: 2069 6e74 3634 5f74 202a 206e 6520 3d20   int64_t * ne = 
+000774b0: 7465 6e73 6f72 2d3e 6e65 3b0a 2020 2020  tensor->ne;.    
+000774c0: 636f 6e73 7420 7369 7a65 5f74 2020 2a20  const size_t  * 
+000774d0: 6e62 203d 2074 656e 736f 722d 3e6e 623b  nb = tensor->nb;
+000774e0: 0a0a 2020 2020 6670 7269 6e74 6628 666f  ..    fprintf(fo
+000774f0: 7574 2c20 2225 2d36 7320 252d 3673 2025  ut, "%-6s %-6s %
+00077500: 2d31 3273 2025 3864 2025 386a 6420 2538  -12s %8d %8jd %8
+00077510: 6a64 2025 386a 6420 2538 6a64 2025 3136  jd %8jd %8jd %16
+00077520: 7a75 2025 3136 7a75 2025 3136 7a75 2025  zu %16zu %16zu %
+00077530: 3136 7a75 2025 3864 2025 3136 7020 2531  16zu %8d %16p %1
+00077540: 3673 5c6e 222c 0a20 2020 2020 2020 2020  6s\n",.         
+00077550: 2020 2061 7267 2c0a 2020 2020 2020 2020     arg,.        
+00077560: 2020 2020 6767 6d6c 5f74 7970 655f 6e61      ggml_type_na
+00077570: 6d65 2874 656e 736f 722d 3e74 7970 6529  me(tensor->type)
+00077580: 2c0a 2020 2020 2020 2020 2020 2020 6767  ,.            gg
+00077590: 6d6c 5f6f 705f 6e61 6d65 2020 2874 656e  ml_op_name  (ten
+000775a0: 736f 722d 3e6f 7029 2c0a 2020 2020 2020  sor->op),.      
+000775b0: 2020 2020 2020 7465 6e73 6f72 2d3e 6e5f        tensor->n_
+000775c0: 6469 6d73 2c0a 2020 2020 2020 2020 2020  dims,.          
+000775d0: 2020 6e65 5b30 5d2c 206e 655b 315d 2c20    ne[0], ne[1], 
+000775e0: 6e65 5b32 5d2c 206e 655b 335d 2c0a 2020  ne[2], ne[3],.  
+000775f0: 2020 2020 2020 2020 2020 6e62 5b30 5d2c            nb[0],
+00077600: 206e 625b 315d 2c20 6e62 5b32 5d2c 206e   nb[1], nb[2], n
+00077610: 625b 335d 2c0a 2020 2020 2020 2020 2020  b[3],.          
+00077620: 2020 7465 6e73 6f72 2d3e 6e5f 7461 736b    tensor->n_task
+00077630: 732c 0a20 2020 2020 2020 2020 2020 2074  s,.            t
+00077640: 656e 736f 722d 3e64 6174 612c 0a20 2020  ensor->data,.   
+00077650: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00077660: 3e6e 616d 6529 3b0a 7d0a 0a76 6f69 6420  >name);.}..void 
+00077670: 6767 6d6c 5f67 7261 7068 5f65 7870 6f72  ggml_graph_expor
+00077680: 7428 636f 6e73 7420 7374 7275 6374 2067  t(const struct g
+00077690: 676d 6c5f 6367 7261 7068 202a 2063 6772  gml_cgraph * cgr
+000776a0: 6170 682c 2063 6f6e 7374 2063 6861 7220  aph, const char 
+000776b0: 2a20 666e 616d 6529 207b 0a20 2020 2061  * fname) {.    a
+000776c0: 7373 6572 7428 6367 7261 7068 2d3e 776f  ssert(cgraph->wo
+000776d0: 726b 2020 2020 2020 3d3d 204e 554c 4c29  rk      == NULL)
+000776e0: 3b0a 2020 2020 6173 7365 7274 2863 6772  ;.    assert(cgr
+000776f0: 6170 682d 3e77 6f72 6b5f 7369 7a65 203d  aph->work_size =
+00077700: 3d20 3029 3b0a 0a20 2020 2075 696e 7436  = 0);..    uint6
+00077710: 345f 7420 7369 7a65 5f65 7661 6c20 3d20  4_t size_eval = 
+00077720: 303b 0a0a 2020 2020 2f2f 2063 6f6d 7075  0;..    // compu
+00077730: 7465 2073 697a 6520 6f66 2069 6e74 6572  te size of inter
+00077740: 6d65 6469 6174 6520 7265 7375 6c74 730a  mediate results.
+00077750: 2020 2020 2f2f 2054 4f44 4f3a 2064 6f65      // TODO: doe
+00077760: 7320 6e6f 7420 7461 6b65 2069 6e74 6f20  s not take into 
+00077770: 6163 636f 756e 7420 7363 7261 7463 6820  account scratch 
+00077780: 6275 6666 6572 7320 2121 2121 0a20 2020  buffers !!!!.   
+00077790: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+000777a0: 2069 203c 2063 6772 6170 682d 3e6e 5f6e   i < cgraph->n_n
+000777b0: 6f64 6573 3b20 2b2b 6929 207b 0a20 2020  odes; ++i) {.   
+000777c0: 2020 2020 2073 697a 655f 6576 616c 202b       size_eval +
+000777d0: 3d20 6767 6d6c 5f6e 6279 7465 7328 6367  = ggml_nbytes(cg
+000777e0: 7261 7068 2d3e 6e6f 6465 735b 695d 293b  raph->nodes[i]);
+000777f0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2070  .    }..    // p
+00077800: 7269 6e74 0a20 2020 207b 0a20 2020 2020  rint.    {.     
+00077810: 2020 2046 494c 4520 2a20 666f 7574 203d     FILE * fout =
+00077820: 2073 7464 6f75 743b 0a0a 2020 2020 2020   stdout;..      
+00077830: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
+00077840: 225c 6e22 293b 0a20 2020 2020 2020 2066  "\n");.        f
+00077850: 7072 696e 7466 2866 6f75 742c 2022 252d  printf(fout, "%-
+00077860: 3136 7320 2538 785c 6e22 2c20 2022 6d61  16s %8x\n",  "ma
+00077870: 6769 6322 2c20 2020 4747 4d4c 5f46 494c  gic",   GGML_FIL
+00077880: 455f 4d41 4749 4329 3b0a 2020 2020 2020  E_MAGIC);.      
+00077890: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
+000778a0: 2225 2d31 3673 2025 3864 5c6e 222c 2020  "%-16s %8d\n",  
+000778b0: 2276 6572 7369 6f6e 222c 2047 474d 4c5f  "version", GGML_
+000778c0: 4649 4c45 5f56 4552 5349 4f4e 293b 0a20  FILE_VERSION);. 
+000778d0: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
+000778e0: 6f75 742c 2022 252d 3136 7320 2538 645c  out, "%-16s %8d\
+000778f0: 6e22 2c20 2022 6c65 6166 7322 2c20 2020  n",  "leafs",   
+00077900: 6367 7261 7068 2d3e 6e5f 6c65 6166 7329  cgraph->n_leafs)
+00077910: 3b0a 2020 2020 2020 2020 6670 7269 6e74  ;.        fprint
+00077920: 6628 666f 7574 2c20 2225 2d31 3673 2025  f(fout, "%-16s %
+00077930: 3864 5c6e 222c 2020 226e 6f64 6573 222c  8d\n",  "nodes",
+00077940: 2020 2063 6772 6170 682d 3e6e 5f6e 6f64     cgraph->n_nod
+00077950: 6573 293b 0a20 2020 2020 2020 2066 7072  es);.        fpr
+00077960: 696e 7466 2866 6f75 742c 2022 252d 3136  intf(fout, "%-16
+00077970: 7320 2538 6a75 5c6e 222c 2022 6576 616c  s %8ju\n", "eval
+00077980: 222c 2020 2020 7369 7a65 5f65 7661 6c29  ",    size_eval)
+00077990: 3b0a 0a20 2020 2020 2020 202f 2f20 6865  ;..        // he
+000779a0: 6164 6572 0a20 2020 2020 2020 2066 7072  ader.        fpr
+000779b0: 696e 7466 2866 6f75 742c 2022 5c6e 2229  intf(fout, "\n")
+000779c0: 3b0a 2020 2020 2020 2020 6670 7269 6e74  ;.        fprint
+000779d0: 6628 666f 7574 2c20 2225 2d36 7320 252d  f(fout, "%-6s %-
+000779e0: 3132 7320 2538 7320 2538 7320 2538 7320  12s %8s %8s %8s 
+000779f0: 2538 7320 2538 7320 2531 3673 2025 3136  %8s %8s %16s %16
 00077a00: 7320 2531 3673 2025 3136 7320 2531 3673  s %16s %16s %16s
-00077a10: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-00077a20: 2020 2020 2022 5459 5045 222c 2022 4f50       "TYPE", "OP
-00077a30: 222c 2022 4e44 494d 5322 2c20 224e 4530  ", "NDIMS", "NE0
-00077a40: 222c 2022 4e45 3122 2c20 224e 4532 222c  ", "NE1", "NE2",
-00077a50: 2022 4e45 3322 2c20 224e 4230 222c 2022   "NE3", "NB0", "
-00077a60: 4e42 3122 2c20 224e 4232 222c 2022 4e42  NB1", "NB2", "NB
-00077a70: 3322 2c20 2244 4154 4122 2c20 224e 414d  3", "DATA", "NAM
-00077a80: 4522 293b 0a0a 2020 2020 2020 2020 666f  E");..        fo
-00077a90: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00077aa0: 3c20 6367 7261 7068 2d3e 6e5f 6c65 6166  < cgraph->n_leaf
-00077ab0: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
-00077ac0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-00077ad0: 5f65 7870 6f72 745f 6c65 6166 2863 6772  _export_leaf(cgr
-00077ae0: 6170 682d 3e6c 6561 6673 5b69 5d2c 2066  aph->leafs[i], f
-00077af0: 6f75 7429 3b0a 0a20 2020 2020 2020 2020  out);..         
-00077b00: 2020 2047 474d 4c5f 4153 5345 5254 2863     GGML_ASSERT(c
-00077b10: 6772 6170 682d 3e6c 6561 6673 5b69 5d2d  graph->leafs[i]-
-00077b20: 3e6f 7020 2020 3d3d 2047 474d 4c5f 4f50  >op   == GGML_OP
-00077b30: 5f4e 4f4e 4529 3b0a 2020 2020 2020 2020  _NONE);.        
-00077b40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00077b50: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
-00077b60: 2d3e 7372 6330 203d 3d20 4e55 4c4c 293b  ->src0 == NULL);
-00077b70: 0a20 2020 2020 2020 2020 2020 2047 474d  .            GGM
-00077b80: 4c5f 4153 5345 5254 2863 6772 6170 682d  L_ASSERT(cgraph-
-00077b90: 3e6c 6561 6673 5b69 5d2d 3e73 7263 3120  >leafs[i]->src1 
-00077ba0: 3d3d 204e 554c 4c29 3b0a 2020 2020 2020  == NULL);.      
-00077bb0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
-00077bc0: 6865 6164 6572 0a20 2020 2020 2020 2066  header.        f
-00077bd0: 7072 696e 7466 2866 6f75 742c 2022 5c6e  printf(fout, "\n
-00077be0: 2229 3b0a 2020 2020 2020 2020 6670 7269  ");.        fpri
-00077bf0: 6e74 6628 666f 7574 2c20 2225 2d36 7320  ntf(fout, "%-6s 
-00077c00: 252d 3673 2025 2d31 3273 2025 3873 2025  %-6s %-12s %8s %
-00077c10: 3873 2025 3873 2025 3873 2025 3873 2025  8s %8s %8s %8s %
-00077c20: 3136 7320 2531 3673 2025 3136 7320 2531  16s %16s %16s %1
-00077c30: 3673 2025 3873 2025 3136 7320 2531 3673  6s %8s %16s %16s
-00077c40: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
-00077c50: 2020 2020 2022 4152 4722 2c20 2254 5950       "ARG", "TYP
-00077c60: 4522 2c20 224f 5022 2c20 224e 4449 4d53  E", "OP", "NDIMS
-00077c70: 222c 2022 4e45 3022 2c20 224e 4531 222c  ", "NE0", "NE1",
-00077c80: 2022 4e45 3222 2c20 224e 4533 222c 2022   "NE2", "NE3", "
-00077c90: 4e42 3022 2c20 224e 4231 222c 2022 4e42  NB0", "NB1", "NB
-00077ca0: 3222 2c20 224e 4233 222c 2022 4e54 4153  2", "NB3", "NTAS
-00077cb0: 4b53 222c 2022 4441 5441 222c 2022 4e41  KS", "DATA", "NA
-00077cc0: 4d45 2229 3b0a 0a20 2020 2020 2020 2066  ME");..        f
-00077cd0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00077ce0: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
-00077cf0: 6573 3b20 2b2b 6929 207b 0a20 2020 2020  es; ++i) {.     
-00077d00: 2020 2020 2020 2067 676d 6c5f 6772 6170         ggml_grap
-00077d10: 685f 6578 706f 7274 5f6e 6f64 6528 6367  h_export_node(cg
-00077d20: 7261 7068 2d3e 6e6f 6465 735b 695d 2c20  raph->nodes[i], 
-00077d30: 2244 5354 222c 2066 6f75 7429 3b0a 0a20  "DST", fout);.. 
-00077d40: 2020 2020 2020 2020 2020 2069 6620 2863             if (c
-00077d50: 6772 6170 682d 3e6e 6f64 6573 5b69 5d2d  graph->nodes[i]-
-00077d60: 3e73 7263 3029 207b 0a20 2020 2020 2020  >src0) {.       
-00077d70: 2020 2020 2020 2020 2067 676d 6c5f 6772           ggml_gr
-00077d80: 6170 685f 6578 706f 7274 5f6e 6f64 6528  aph_export_node(
-00077d90: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
-00077da0: 2d3e 7372 6330 2c20 2253 5243 3022 2c20  ->src0, "SRC0", 
-00077db0: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-00077dc0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00077dd0: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
-00077de0: 6465 735b 695d 2d3e 7372 6331 2920 7b0a  des[i]->src1) {.
-00077df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077e00: 6767 6d6c 5f67 7261 7068 5f65 7870 6f72  ggml_graph_expor
-00077e10: 745f 6e6f 6465 2863 6772 6170 682d 3e6e  t_node(cgraph->n
-00077e20: 6f64 6573 5b69 5d2d 3e73 7263 312c 2022  odes[i]->src1, "
-00077e30: 5352 4331 222c 2066 6f75 7429 3b0a 2020  SRC1", fout);.  
-00077e40: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00077e50: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00077e60: 7420 6a20 3d20 303b 206a 203c 2047 474d  t j = 0; j < GGM
-00077e70: 4c5f 4d41 585f 4f50 543b 202b 2b6a 2920  L_MAX_OPT; ++j) 
-00077e80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00077e90: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
-00077ea0: 6465 735b 695d 2d3e 6f70 745b 6a5d 2920  des[i]->opt[j]) 
-00077eb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00077ec0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-00077ed0: 5f65 7870 6f72 745f 6e6f 6465 2863 6772  _export_node(cgr
-00077ee0: 6170 682d 3e6e 6f64 6573 5b69 5d2d 3e6f  aph->nodes[i]->o
-00077ef0: 7074 5b6a 5d2c 2022 4f50 5422 2c20 666f  pt[j], "OPT", fo
-00077f00: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00077f10: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00077f20: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00077f30: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
-00077f40: 225c 6e22 293b 0a20 2020 2020 2020 207d  "\n");.        }
-00077f50: 0a0a 2020 2020 2020 2020 6670 7269 6e74  ..        fprint
-00077f60: 6628 666f 7574 2c20 225c 6e22 293b 0a20  f(fout, "\n");. 
-00077f70: 2020 207d 0a0a 2020 2020 2f2f 2077 7269     }..    // wri
-00077f80: 7465 2062 696e 6172 7920 6461 7461 0a20  te binary data. 
-00077f90: 2020 207b 0a20 2020 2020 2020 2046 494c     {.        FIL
-00077fa0: 4520 2a20 666f 7574 203d 2066 6f70 656e  E * fout = fopen
-00077fb0: 2866 6e61 6d65 2c20 2277 6222 293b 0a0a  (fname, "wb");..
-00077fc0: 2020 2020 2020 2020 6966 2028 2166 6f75          if (!fou
-00077fd0: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
-00077fe0: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
-00077ff0: 2022 2573 3a20 6661 696c 6564 2074 6f20   "%s: failed to 
-00078000: 6f70 656e 2025 735c 6e22 2c20 5f5f 6675  open %s\n", __fu
-00078010: 6e63 5f5f 2c20 666e 616d 6529 3b0a 2020  nc__, fname);.  
-00078020: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00078030: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-00078040: 2020 2020 202f 2f20 6865 6164 6572 0a20       // header. 
-00078050: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00078060: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
-00078070: 325f 7420 6d61 6769 6320 2020 3d20 4747  2_t magic   = GG
-00078080: 4d4c 5f46 494c 455f 4d41 4749 433b 0a20  ML_FILE_MAGIC;. 
-00078090: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000780a0: 2075 696e 7433 325f 7420 7665 7273 696f   uint32_t versio
-000780b0: 6e20 3d20 4747 4d4c 5f46 494c 455f 5645  n = GGML_FILE_VE
-000780c0: 5253 494f 4e3b 0a20 2020 2020 2020 2020  RSION;.         
-000780d0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-000780e0: 7420 6e5f 6c65 6166 7320 3d20 6367 7261  t n_leafs = cgra
-000780f0: 7068 2d3e 6e5f 6c65 6166 733b 0a20 2020  ph->n_leafs;.   
-00078100: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-00078110: 696e 7433 325f 7420 6e6f 6465 7320 2020  int32_t nodes   
-00078120: 3d20 6367 7261 7068 2d3e 6e5f 6e6f 6465  = cgraph->n_node
-00078130: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-00078140: 6677 7269 7465 2826 6d61 6769 632c 2020  fwrite(&magic,  
-00078150: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
-00078160: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-00078170: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00078180: 6528 2676 6572 7369 6f6e 2c20 2020 7369  e(&version,   si
-00078190: 7a65 6f66 2875 696e 7433 325f 7429 2c20  zeof(uint32_t), 
-000781a0: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
-000781b0: 2020 2020 2020 6677 7269 7465 2826 6e5f        fwrite(&n_
-000781c0: 6c65 6166 732c 2020 2073 697a 656f 6628  leafs,   sizeof(
-000781d0: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
-000781e0: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-000781f0: 2066 7772 6974 6528 266e 6f64 6573 2c20   fwrite(&nodes, 
-00078200: 2020 2020 7369 7a65 6f66 2875 696e 7433      sizeof(uint3
-00078210: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
-00078220: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
-00078230: 7465 2826 7369 7a65 5f65 7661 6c2c 2073  te(&size_eval, s
-00078240: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
-00078250: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00078260: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-00078270: 206c 6561 6673 0a20 2020 2020 2020 207b   leafs.        {
-00078280: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00078290: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000782a0: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
-000782b0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-000782c0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-000782d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000782e0: 7220 2a20 7465 6e73 6f72 203d 2063 6772  r * tensor = cgr
-000782f0: 6170 682d 3e6c 6561 6673 5b69 5d3b 0a0a  aph->leafs[i];..
-00078300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078310: 636f 6e73 7420 7569 6e74 3332 5f74 2074  const uint32_t t
-00078320: 7970 6520 2020 3d20 7465 6e73 6f72 2d3e  ype   = tensor->
-00078330: 7479 7065 3b0a 2020 2020 2020 2020 2020  type;.          
-00078340: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-00078350: 3332 5f74 206f 7020 2020 2020 3d20 7465  32_t op     = te
-00078360: 6e73 6f72 2d3e 6f70 3b0a 2020 2020 2020  nsor->op;.      
-00078370: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00078380: 7569 6e74 3332 5f74 206e 5f64 696d 7320  uint32_t n_dims 
-00078390: 3d20 7465 6e73 6f72 2d3e 6e5f 6469 6d73  = tensor->n_dims
-000783a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000783b0: 2020 2066 7772 6974 6528 2674 7970 652c     fwrite(&type,
-000783c0: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
-000783d0: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-000783e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000783f0: 7772 6974 6528 266f 702c 2020 2020 2073  write(&op,     s
-00078400: 697a 656f 6628 7569 6e74 3332 5f74 292c  izeof(uint32_t),
-00078410: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00078420: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00078430: 6528 266e 5f64 696d 732c 2073 697a 656f  e(&n_dims, sizeo
-00078440: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
-00078450: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
-00078460: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00078470: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
-00078480: 5f4d 4158 5f44 494d 533b 202b 2b6a 2920  _MAX_DIMS; ++j) 
-00078490: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000784a0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-000784b0: 3634 5f74 206e 6520 3d20 7465 6e73 6f72  64_t ne = tensor
-000784c0: 2d3e 6e65 5b6a 5d3b 0a20 2020 2020 2020  ->ne[j];.       
-000784d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000784e0: 7374 2075 696e 7436 345f 7420 6e62 203d  st uint64_t nb =
-000784f0: 2074 656e 736f 722d 3e6e 625b 6a5d 3b0a   tensor->nb[j];.
-00078500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078510: 2020 2020 2066 7772 6974 6528 266e 652c       fwrite(&ne,
-00078520: 2073 697a 656f 6628 7569 6e74 3634 5f74   sizeof(uint64_t
-00078530: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
-00078540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078550: 2066 7772 6974 6528 266e 622c 2073 697a   fwrite(&nb, siz
-00078560: 656f 6628 7569 6e74 3634 5f74 292c 2031  eof(uint64_t), 1
-00078570: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-00078580: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00078590: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-000785a0: 746f 7265 2074 6865 2070 6f69 6e74 6572  tore the pointer
-000785b0: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-000785c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000785d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000785e0: 6f6e 7374 2075 696e 7436 345f 7420 7074  onst uint64_t pt
-000785f0: 7220 3d20 2875 696e 7436 345f 7429 2074  r = (uint64_t) t
-00078600: 656e 736f 722d 3e64 6174 613b 0a0a 2020  ensor->data;..  
-00078610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078620: 2020 6677 7269 7465 2826 7074 722c 2073    fwrite(&ptr, s
-00078630: 697a 656f 6628 7569 6e74 3634 5f74 292c  izeof(uint64_t),
-00078640: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00078650: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00078660: 2020 2020 2020 2020 2020 2020 2020 6677                fw
-00078670: 7269 7465 2874 656e 736f 722d 3e6e 616d  rite(tensor->nam
-00078680: 652c 2073 697a 656f 6628 6368 6172 292c  e, sizeof(char),
-00078690: 2047 474d 4c5f 4d41 585f 4e41 4d45 2c20   GGML_MAX_NAME, 
-000786a0: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
-000786b0: 2020 2020 2020 2020 2f2f 2064 756d 7020          // dump 
-000786c0: 7468 6520 6461 7461 0a20 2020 2020 2020  the data.       
-000786d0: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
-000786e0: 3a20 7061 6420 7468 6973 2074 6f20 3332  : pad this to 32
-000786f0: 2062 7974 6520 626f 756e 6461 7279 0a20   byte boundary. 
-00078700: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00078710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078720: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
-00078730: 7420 7369 7a65 203d 2067 676d 6c5f 6e62  t size = ggml_nb
-00078740: 7974 6573 2874 656e 736f 7229 3b0a 0a20  ytes(tensor);.. 
-00078750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078760: 2020 2066 7772 6974 6528 7465 6e73 6f72     fwrite(tensor
-00078770: 2d3e 6461 7461 2c20 7369 7a65 6f66 2863  ->data, sizeof(c
-00078780: 6861 7229 2c20 7369 7a65 2c20 666f 7574  har), size, fout
-00078790: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000787a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000787b0: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-000787c0: 2020 2020 2020 2f2f 206e 6f64 6573 0a20        // nodes. 
-000787d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000787e0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-000787f0: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
-00078800: 3e6e 5f6e 6f64 6573 3b20 2b2b 6929 207b  >n_nodes; ++i) {
-00078810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078820: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00078830: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-00078840: 6f72 203d 2063 6772 6170 682d 3e6e 6f64  or = cgraph->nod
-00078850: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
-00078860: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00078870: 6e74 3332 5f74 2074 7970 6520 2020 3d20  nt32_t type   = 
-00078880: 7465 6e73 6f72 2d3e 7479 7065 3b0a 2020  tensor->type;.  
-00078890: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000788a0: 6e73 7420 7569 6e74 3332 5f74 206f 7020  nst uint32_t op 
-000788b0: 2020 2020 3d20 7465 6e73 6f72 2d3e 6f70      = tensor->op
-000788c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000788d0: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
-000788e0: 206e 5f64 696d 7320 3d20 7465 6e73 6f72   n_dims = tensor
-000788f0: 2d3e 6e5f 6469 6d73 3b0a 0a20 2020 2020  ->n_dims;..     
-00078900: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00078910: 6528 2674 7970 652c 2020 2073 697a 656f  e(&type,   sizeo
-00078920: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
-00078930: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-00078940: 2020 2020 2020 2066 7772 6974 6528 266f         fwrite(&o
-00078950: 702c 2020 2020 2073 697a 656f 6628 7569  p,     sizeof(ui
-00078960: 6e74 3332 5f74 292c 2031 2c20 666f 7574  nt32_t), 1, fout
-00078970: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00078980: 2020 2066 7772 6974 6528 266e 5f64 696d     fwrite(&n_dim
-00078990: 732c 2073 697a 656f 6628 7569 6e74 3332  s, sizeof(uint32
-000789a0: 5f74 292c 2031 2c20 666f 7574 293b 0a0a  _t), 1, fout);..
-000789b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000789c0: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-000789d0: 6a20 3c20 4747 4d4c 5f4d 4158 5f44 494d  j < GGML_MAX_DIM
-000789e0: 533b 202b 2b6a 2920 7b0a 2020 2020 2020  S; ++j) {.      
-000789f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00078a00: 6e73 7420 7569 6e74 3634 5f74 206e 6520  nst uint64_t ne 
-00078a10: 3d20 7465 6e73 6f72 2d3e 6e65 5b6a 5d3b  = tensor->ne[j];
-00078a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078a30: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
-00078a40: 345f 7420 6e62 203d 2074 656e 736f 722d  4_t nb = tensor-
-00078a50: 3e6e 625b 6a5d 3b0a 0a20 2020 2020 2020  >nb[j];..       
-00078a60: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-00078a70: 6974 6528 266e 652c 2073 697a 656f 6628  ite(&ne, sizeof(
-00078a80: 7569 6e74 3634 5f74 292c 2031 2c20 666f  uint64_t), 1, fo
-00078a90: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00078aa0: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
-00078ab0: 266e 622c 2073 697a 656f 6628 7569 6e74  &nb, sizeof(uint
-00078ac0: 3634 5f74 292c 2031 2c20 666f 7574 293b  64_t), 1, fout);
-00078ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078ae0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-00078af0: 2020 2020 2f2f 2073 746f 7265 2074 6865      // store the
-00078b00: 2070 6f69 6e74 6572 2061 6464 7265 7373   pointer address
-00078b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078b20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00078b30: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-00078b40: 7436 345f 7420 7074 7220 3d20 2875 696e  t64_t ptr = (uin
-00078b50: 7436 345f 7429 2074 656e 736f 722d 3e64  t64_t) tensor->d
-00078b60: 6174 613b 0a0a 2020 2020 2020 2020 2020  ata;..          
-00078b70: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
-00078b80: 2826 7074 722c 2073 697a 656f 6628 7569  (&ptr, sizeof(ui
-00078b90: 6e74 3634 5f74 292c 2031 2c20 666f 7574  nt64_t), 1, fout
-00078ba0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00078bb0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-00078bc0: 2020 2020 2020 6677 7269 7465 2874 656e        fwrite(ten
-00078bd0: 736f 722d 3e6e 616d 652c 2073 697a 656f  sor->name, sizeo
-00078be0: 6628 6368 6172 292c 2047 474d 4c5f 4d41  f(char), GGML_MA
-00078bf0: 585f 4e41 4d45 2c20 666f 7574 293b 0a0a  X_NAME, fout);..
-00078c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c10: 2f2f 206f 7574 7075 7420 7468 6520 6f70  // output the op
-00078c20: 2061 7267 756d 656e 7473 0a20 2020 2020   arguments.     
-00078c30: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00078c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c50: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00078c60: 736f 7220 2a20 6172 6773 5b32 202b 2047  sor * args[2 + G
-00078c70: 474d 4c5f 4d41 585f 4f50 545d 203d 207b  GML_MAX_OPT] = {
-00078c80: 204e 554c 4c20 7d3b 0a0a 2020 2020 2020   NULL };..      
-00078c90: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-00078ca0: 6773 5b30 5d20 3d20 7465 6e73 6f72 2d3e  gs[0] = tensor->
-00078cb0: 7372 6330 3b0a 2020 2020 2020 2020 2020  src0;.          
-00078cc0: 2020 2020 2020 2020 2020 6172 6773 5b31            args[1
-00078cd0: 5d20 3d20 7465 6e73 6f72 2d3e 7372 6331  ] = tensor->src1
-00078ce0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00078cf0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00078d00: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
-00078d10: 4d41 585f 4f50 543b 202b 2b6a 2920 7b0a  MAX_OPT; ++j) {.
-00078d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d30: 2020 2020 2020 2020 6172 6773 5b32 202b          args[2 +
-00078d40: 206a 5d20 3d20 7465 6e73 6f72 2d3e 6f70   j] = tensor->op
-00078d50: 745b 6a5d 3b0a 2020 2020 2020 2020 2020  t[j];.          
-00078d60: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00078d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d80: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-00078d90: 206a 203c 2032 202b 2047 474d 4c5f 4d41   j < 2 + GGML_MA
-00078da0: 585f 4f50 543b 202b 2b6a 2920 7b0a 2020  X_OPT; ++j) {.  
-00078db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078dc0: 2020 2020 2020 6966 2028 6172 6773 5b6a        if (args[j
-00078dd0: 5d29 207b 0a20 2020 2020 2020 2020 2020  ]) {.           
+00077a10: 2025 3136 735c 6e22 2c0a 2020 2020 2020   %16s\n",.      
+00077a20: 2020 2020 2020 2020 2020 2254 5950 4522            "TYPE"
+00077a30: 2c20 224f 5022 2c20 224e 4449 4d53 222c  , "OP", "NDIMS",
+00077a40: 2022 4e45 3022 2c20 224e 4531 222c 2022   "NE0", "NE1", "
+00077a50: 4e45 3222 2c20 224e 4533 222c 2022 4e42  NE2", "NE3", "NB
+00077a60: 3022 2c20 224e 4231 222c 2022 4e42 3222  0", "NB1", "NB2"
+00077a70: 2c20 224e 4233 222c 2022 4441 5441 222c  , "NB3", "DATA",
+00077a80: 2022 4e41 4d45 2229 3b0a 0a20 2020 2020   "NAME");..     
+00077a90: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00077aa0: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
+00077ab0: 5f6c 6561 6673 3b20 2b2b 6929 207b 0a20  _leafs; ++i) {. 
+00077ac0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00077ad0: 6772 6170 685f 6578 706f 7274 5f6c 6561  graph_export_lea
+00077ae0: 6628 6367 7261 7068 2d3e 6c65 6166 735b  f(cgraph->leafs[
+00077af0: 695d 2c20 666f 7574 293b 0a0a 2020 2020  i], fout);..    
+00077b00: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00077b10: 4552 5428 6367 7261 7068 2d3e 6c65 6166  ERT(cgraph->leaf
+00077b20: 735b 695d 2d3e 6f70 2020 203d 3d20 4747  s[i]->op   == GG
+00077b30: 4d4c 5f4f 505f 4e4f 4e45 293b 0a20 2020  ML_OP_NONE);.   
+00077b40: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00077b50: 5345 5254 2863 6772 6170 682d 3e6c 6561  SERT(cgraph->lea
+00077b60: 6673 5b69 5d2d 3e73 7263 3020 3d3d 204e  fs[i]->src0 == N
+00077b70: 554c 4c29 3b0a 2020 2020 2020 2020 2020  ULL);.          
+00077b80: 2020 4747 4d4c 5f41 5353 4552 5428 6367    GGML_ASSERT(cg
+00077b90: 7261 7068 2d3e 6c65 6166 735b 695d 2d3e  raph->leafs[i]->
+00077ba0: 7372 6331 203d 3d20 4e55 4c4c 293b 0a20  src1 == NULL);. 
+00077bb0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00077bc0: 2020 2f2f 2068 6561 6465 720a 2020 2020    // header.    
+00077bd0: 2020 2020 6670 7269 6e74 6628 666f 7574      fprintf(fout
+00077be0: 2c20 225c 6e22 293b 0a20 2020 2020 2020  , "\n");.       
+00077bf0: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
+00077c00: 252d 3673 2025 2d36 7320 252d 3132 7320  %-6s %-6s %-12s 
+00077c10: 2538 7320 2538 7320 2538 7320 2538 7320  %8s %8s %8s %8s 
+00077c20: 2538 7320 2531 3673 2025 3136 7320 2531  %8s %16s %16s %1
+00077c30: 3673 2025 3136 7320 2538 7320 2531 3673  6s %16s %8s %16s
+00077c40: 2025 3136 735c 6e22 2c0a 2020 2020 2020   %16s\n",.      
+00077c50: 2020 2020 2020 2020 2020 2241 5247 222c            "ARG",
+00077c60: 2022 5459 5045 222c 2022 4f50 222c 2022   "TYPE", "OP", "
+00077c70: 4e44 494d 5322 2c20 224e 4530 222c 2022  NDIMS", "NE0", "
+00077c80: 4e45 3122 2c20 224e 4532 222c 2022 4e45  NE1", "NE2", "NE
+00077c90: 3322 2c20 224e 4230 222c 2022 4e42 3122  3", "NB0", "NB1"
+00077ca0: 2c20 224e 4232 222c 2022 4e42 3322 2c20  , "NB2", "NB3", 
+00077cb0: 224e 5441 534b 5322 2c20 2244 4154 4122  "NTASKS", "DATA"
+00077cc0: 2c20 224e 414d 4522 293b 0a0a 2020 2020  , "NAME");..    
+00077cd0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00077ce0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
+00077cf0: 6e5f 6e6f 6465 733b 202b 2b69 2920 7b0a  n_nodes; ++i) {.
+00077d00: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00077d10: 5f67 7261 7068 5f65 7870 6f72 745f 6e6f  _graph_export_no
+00077d20: 6465 2863 6772 6170 682d 3e6e 6f64 6573  de(cgraph->nodes
+00077d30: 5b69 5d2c 2022 4453 5422 2c20 666f 7574  [i], "DST", fout
+00077d40: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00077d50: 6966 2028 6367 7261 7068 2d3e 6e6f 6465  if (cgraph->node
+00077d60: 735b 695d 2d3e 7372 6330 2920 7b0a 2020  s[i]->src0) {.  
+00077d70: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00077d80: 6d6c 5f67 7261 7068 5f65 7870 6f72 745f  ml_graph_export_
+00077d90: 6e6f 6465 2863 6772 6170 682d 3e6e 6f64  node(cgraph->nod
+00077da0: 6573 5b69 5d2d 3e73 7263 302c 2022 5352  es[i]->src0, "SR
+00077db0: 4330 222c 2066 6f75 7429 3b0a 2020 2020  C0", fout);.    
+00077dc0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00077dd0: 2020 2020 2020 2069 6620 2863 6772 6170         if (cgrap
+00077de0: 682d 3e6e 6f64 6573 5b69 5d2d 3e73 7263  h->nodes[i]->src
+00077df0: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
+00077e00: 2020 2020 2067 676d 6c5f 6772 6170 685f       ggml_graph_
+00077e10: 6578 706f 7274 5f6e 6f64 6528 6367 7261  export_node(cgra
+00077e20: 7068 2d3e 6e6f 6465 735b 695d 2d3e 7372  ph->nodes[i]->sr
+00077e30: 6331 2c20 2253 5243 3122 2c20 666f 7574  c1, "SRC1", fout
+00077e40: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00077e50: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00077e60: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+00077e70: 3c20 4747 4d4c 5f4d 4158 5f4f 5054 3b20  < GGML_MAX_OPT; 
+00077e80: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
+00077e90: 2020 2020 2020 2069 6620 2863 6772 6170         if (cgrap
+00077ea0: 682d 3e6e 6f64 6573 5b69 5d2d 3e6f 7074  h->nodes[i]->opt
+00077eb0: 5b6a 5d29 207b 0a20 2020 2020 2020 2020  [j]) {.         
+00077ec0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00077ed0: 6772 6170 685f 6578 706f 7274 5f6e 6f64  graph_export_nod
+00077ee0: 6528 6367 7261 7068 2d3e 6e6f 6465 735b  e(cgraph->nodes[
+00077ef0: 695d 2d3e 6f70 745b 6a5d 2c20 224f 5054  i]->opt[j], "OPT
+00077f00: 222c 2066 6f75 7429 3b0a 2020 2020 2020  ", fout);.      
+00077f10: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00077f20: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00077f30: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
+00077f40: 6f75 742c 2022 5c6e 2229 3b0a 2020 2020  out, "\n");.    
+00077f50: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
+00077f60: 7072 696e 7466 2866 6f75 742c 2022 5c6e  printf(fout, "\n
+00077f70: 2229 3b0a 2020 2020 7d0a 0a20 2020 202f  ");.    }..    /
+00077f80: 2f20 7772 6974 6520 6269 6e61 7279 2064  / write binary d
+00077f90: 6174 610a 2020 2020 7b0a 2020 2020 2020  ata.    {.      
+00077fa0: 2020 4649 4c45 202a 2066 6f75 7420 3d20    FILE * fout = 
+00077fb0: 666f 7065 6e28 666e 616d 652c 2022 7762  fopen(fname, "wb
+00077fc0: 2229 3b0a 0a20 2020 2020 2020 2069 6620  ");..        if 
+00077fd0: 2821 666f 7574 2920 7b0a 2020 2020 2020  (!fout) {.      
+00077fe0: 2020 2020 2020 6670 7269 6e74 6628 7374        fprintf(st
+00077ff0: 6465 7272 2c20 2225 733a 2066 6169 6c65  derr, "%s: faile
+00078000: 6420 746f 206f 7065 6e20 2573 5c6e 222c  d to open %s\n",
+00078010: 205f 5f66 756e 635f 5f2c 2066 6e61 6d65   __func__, fname
+00078020: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
+00078030: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
+00078040: 0a0a 2020 2020 2020 2020 2f2f 2068 6561  ..        // hea
+00078050: 6465 720a 2020 2020 2020 2020 7b0a 2020  der.        {.  
+00078060: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00078070: 7569 6e74 3332 5f74 206d 6167 6963 2020  uint32_t magic  
+00078080: 203d 2047 474d 4c5f 4649 4c45 5f4d 4147   = GGML_FILE_MAG
+00078090: 4943 3b0a 2020 2020 2020 2020 2020 2020  IC;.            
+000780a0: 636f 6e73 7420 7569 6e74 3332 5f74 2076  const uint32_t v
+000780b0: 6572 7369 6f6e 203d 2047 474d 4c5f 4649  ersion = GGML_FI
+000780c0: 4c45 5f56 4552 5349 4f4e 3b0a 2020 2020  LE_VERSION;.    
+000780d0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
+000780e0: 6e74 3332 5f74 206e 5f6c 6561 6673 203d  nt32_t n_leafs =
+000780f0: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
+00078100: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00078110: 6e73 7420 7569 6e74 3332 5f74 206e 6f64  nst uint32_t nod
+00078120: 6573 2020 203d 2063 6772 6170 682d 3e6e  es   = cgraph->n
+00078130: 5f6e 6f64 6573 3b0a 0a20 2020 2020 2020  _nodes;..       
+00078140: 2020 2020 2066 7772 6974 6528 266d 6167       fwrite(&mag
+00078150: 6963 2c20 2020 2020 7369 7a65 6f66 2875  ic,     sizeof(u
+00078160: 696e 7433 325f 7429 2c20 312c 2066 6f75  int32_t), 1, fou
+00078170: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00078180: 6677 7269 7465 2826 7665 7273 696f 6e2c  fwrite(&version,
+00078190: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
+000781a0: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
+000781b0: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+000781c0: 6528 266e 5f6c 6561 6673 2c20 2020 7369  e(&n_leafs,   si
+000781d0: 7a65 6f66 2875 696e 7433 325f 7429 2c20  zeof(uint32_t), 
+000781e0: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
+000781f0: 2020 2020 2020 6677 7269 7465 2826 6e6f        fwrite(&no
+00078200: 6465 732c 2020 2020 2073 697a 656f 6628  des,     sizeof(
+00078210: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
+00078220: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+00078230: 2066 7772 6974 6528 2673 697a 655f 6576   fwrite(&size_ev
+00078240: 616c 2c20 7369 7a65 6f66 2875 696e 7436  al, sizeof(uint6
+00078250: 345f 7429 2c20 312c 2066 6f75 7429 3b0a  4_t), 1, fout);.
+00078260: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00078270: 2020 202f 2f20 6c65 6166 730a 2020 2020     // leafs.    
+00078280: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00078290: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+000782a0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+000782b0: 6c65 6166 733b 202b 2b69 2920 7b0a 2020  leafs; ++i) {.  
+000782c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000782d0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000782e0: 7465 6e73 6f72 202a 2074 656e 736f 7220  tensor * tensor 
+000782f0: 3d20 6367 7261 7068 2d3e 6c65 6166 735b  = cgraph->leafs[
+00078300: 695d 3b0a 0a20 2020 2020 2020 2020 2020  i];..           
+00078310: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
+00078320: 325f 7420 7479 7065 2020 203d 2074 656e  2_t type   = ten
+00078330: 736f 722d 3e74 7970 653b 0a20 2020 2020  sor->type;.     
+00078340: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00078350: 2075 696e 7433 325f 7420 6f70 2020 2020   uint32_t op    
+00078360: 203d 2074 656e 736f 722d 3e6f 703b 0a20   = tensor->op;. 
+00078370: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00078380: 6f6e 7374 2075 696e 7433 325f 7420 6e5f  onst uint32_t n_
+00078390: 6469 6d73 203d 2074 656e 736f 722d 3e6e  dims = tensor->n
+000783a0: 5f64 696d 733b 0a0a 2020 2020 2020 2020  _dims;..        
+000783b0: 2020 2020 2020 2020 6677 7269 7465 2826          fwrite(&
+000783c0: 7479 7065 2c20 2020 7369 7a65 6f66 2875  type,   sizeof(u
+000783d0: 696e 7433 325f 7429 2c20 312c 2066 6f75  int32_t), 1, fou
+000783e0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+000783f0: 2020 2020 6677 7269 7465 2826 6f70 2c20      fwrite(&op, 
+00078400: 2020 2020 7369 7a65 6f66 2875 696e 7433      sizeof(uint3
+00078410: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
+00078420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078430: 6677 7269 7465 2826 6e5f 6469 6d73 2c20  fwrite(&n_dims, 
+00078440: 7369 7a65 6f66 2875 696e 7433 325f 7429  sizeof(uint32_t)
+00078450: 2c20 312c 2066 6f75 7429 3b0a 0a20 2020  , 1, fout);..   
+00078460: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00078470: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+00078480: 2047 474d 4c5f 4d41 585f 4449 4d53 3b20   GGML_MAX_DIMS; 
+00078490: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
+000784a0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000784b0: 2075 696e 7436 345f 7420 6e65 203d 2074   uint64_t ne = t
+000784c0: 656e 736f 722d 3e6e 655b 6a5d 3b0a 2020  ensor->ne[j];.  
+000784d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000784e0: 2020 636f 6e73 7420 7569 6e74 3634 5f74    const uint64_t
+000784f0: 206e 6220 3d20 7465 6e73 6f72 2d3e 6e62   nb = tensor->nb
+00078500: 5b6a 5d3b 0a0a 2020 2020 2020 2020 2020  [j];..          
+00078510: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
+00078520: 2826 6e65 2c20 7369 7a65 6f66 2875 696e  (&ne, sizeof(uin
+00078530: 7436 345f 7429 2c20 312c 2066 6f75 7429  t64_t), 1, fout)
+00078540: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00078550: 2020 2020 2020 6677 7269 7465 2826 6e62        fwrite(&nb
+00078560: 2c20 7369 7a65 6f66 2875 696e 7436 345f  , sizeof(uint64_
+00078570: 7429 2c20 312c 2066 6f75 7429 3b0a 2020  t), 1, fout);.  
+00078580: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00078590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000785a0: 202f 2f20 7374 6f72 6520 7468 6520 706f   // store the po
+000785b0: 696e 7465 7220 6164 6472 6573 730a 2020  inter address.  
+000785c0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000785d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000785e0: 2020 2020 636f 6e73 7420 7569 6e74 3634      const uint64
+000785f0: 5f74 2070 7472 203d 2028 7569 6e74 3634  _t ptr = (uint64
+00078600: 5f74 2920 7465 6e73 6f72 2d3e 6461 7461  _t) tensor->data
+00078610: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00078620: 2020 2020 2020 2066 7772 6974 6528 2670         fwrite(&p
+00078630: 7472 2c20 7369 7a65 6f66 2875 696e 7436  tr, sizeof(uint6
+00078640: 345f 7429 2c20 312c 2066 6f75 7429 3b0a  4_t), 1, fout);.
+00078650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078660: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00078670: 2020 2066 7772 6974 6528 7465 6e73 6f72     fwrite(tensor
+00078680: 2d3e 6e61 6d65 2c20 7369 7a65 6f66 2863  ->name, sizeof(c
+00078690: 6861 7229 2c20 4747 4d4c 5f4d 4158 5f4e  har), GGML_MAX_N
+000786a0: 414d 452c 2066 6f75 7429 3b0a 0a20 2020  AME, fout);..   
+000786b0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+000786c0: 6475 6d70 2074 6865 2064 6174 610a 2020  dump the data.  
+000786d0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+000786e0: 2054 4f44 4f3a 2070 6164 2074 6869 7320   TODO: pad this 
+000786f0: 746f 2033 3220 6279 7465 2062 6f75 6e64  to 32 byte bound
+00078700: 6172 790a 2020 2020 2020 2020 2020 2020  ary.            
+00078710: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00078720: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00078730: 7369 7a65 5f74 2073 697a 6520 3d20 6767  size_t size = gg
+00078740: 6d6c 5f6e 6279 7465 7328 7465 6e73 6f72  ml_nbytes(tensor
+00078750: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00078760: 2020 2020 2020 2020 6677 7269 7465 2874          fwrite(t
+00078770: 656e 736f 722d 3e64 6174 612c 2073 697a  ensor->data, siz
+00078780: 656f 6628 6368 6172 292c 2073 697a 652c  eof(char), size,
+00078790: 2066 6f75 7429 3b0a 2020 2020 2020 2020   fout);.        
+000787a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000787b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000787c0: 7d0a 0a20 2020 2020 2020 202f 2f20 6e6f  }..        // no
+000787d0: 6465 730a 2020 2020 2020 2020 7b0a 2020  des.        {.  
+000787e0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+000787f0: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
+00078800: 7261 7068 2d3e 6e5f 6e6f 6465 733b 202b  raph->n_nodes; +
+00078810: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
+00078820: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00078830: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00078840: 2074 656e 736f 7220 3d20 6367 7261 7068   tensor = cgraph
+00078850: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+00078860: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00078870: 7374 2075 696e 7433 325f 7420 7479 7065  st uint32_t type
+00078880: 2020 203d 2074 656e 736f 722d 3e74 7970     = tensor->typ
+00078890: 653b 0a20 2020 2020 2020 2020 2020 2020  e;.             
+000788a0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
+000788b0: 7420 6f70 2020 2020 203d 2074 656e 736f  t op     = tenso
+000788c0: 722d 3e6f 703b 0a20 2020 2020 2020 2020  r->op;.         
+000788d0: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
+000788e0: 7433 325f 7420 6e5f 6469 6d73 203d 2074  t32_t n_dims = t
+000788f0: 656e 736f 722d 3e6e 5f64 696d 733b 0a0a  ensor->n_dims;..
+00078900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078910: 6677 7269 7465 2826 7479 7065 2c20 2020  fwrite(&type,   
+00078920: 7369 7a65 6f66 2875 696e 7433 325f 7429  sizeof(uint32_t)
+00078930: 2c20 312c 2066 6f75 7429 3b0a 2020 2020  , 1, fout);.    
+00078940: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
+00078950: 7465 2826 6f70 2c20 2020 2020 7369 7a65  te(&op,     size
+00078960: 6f66 2875 696e 7433 325f 7429 2c20 312c  of(uint32_t), 1,
+00078970: 2066 6f75 7429 3b0a 2020 2020 2020 2020   fout);.        
+00078980: 2020 2020 2020 2020 6677 7269 7465 2826          fwrite(&
+00078990: 6e5f 6469 6d73 2c20 7369 7a65 6f66 2875  n_dims, sizeof(u
+000789a0: 696e 7433 325f 7429 2c20 312c 2066 6f75  int32_t), 1, fou
+000789b0: 7429 3b0a 0a20 2020 2020 2020 2020 2020  t);..           
+000789c0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+000789d0: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
+000789e0: 585f 4449 4d53 3b20 2b2b 6a29 207b 0a20  X_DIMS; ++j) {. 
+000789f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078a00: 2020 2063 6f6e 7374 2075 696e 7436 345f     const uint64_
+00078a10: 7420 6e65 203d 2074 656e 736f 722d 3e6e  t ne = tensor->n
+00078a20: 655b 6a5d 3b0a 2020 2020 2020 2020 2020  e[j];.          
+00078a30: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00078a40: 7569 6e74 3634 5f74 206e 6220 3d20 7465  uint64_t nb = te
+00078a50: 6e73 6f72 2d3e 6e62 5b6a 5d3b 0a0a 2020  nsor->nb[j];..  
+00078a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078a70: 2020 6677 7269 7465 2826 6e65 2c20 7369    fwrite(&ne, si
+00078a80: 7a65 6f66 2875 696e 7436 345f 7429 2c20  zeof(uint64_t), 
+00078a90: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
+00078aa0: 2020 2020 2020 2020 2020 2020 2020 6677                fw
+00078ab0: 7269 7465 2826 6e62 2c20 7369 7a65 6f66  rite(&nb, sizeof
+00078ac0: 2875 696e 7436 345f 7429 2c20 312c 2066  (uint64_t), 1, f
+00078ad0: 6f75 7429 3b0a 2020 2020 2020 2020 2020  out);.          
+00078ae0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00078af0: 2020 2020 2020 2020 202f 2f20 7374 6f72           // stor
+00078b00: 6520 7468 6520 706f 696e 7465 7220 6164  e the pointer ad
+00078b10: 6472 6573 730a 2020 2020 2020 2020 2020  dress.          
+00078b20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00078b30: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00078b40: 7420 7569 6e74 3634 5f74 2070 7472 203d  t uint64_t ptr =
+00078b50: 2028 7569 6e74 3634 5f74 2920 7465 6e73   (uint64_t) tens
+00078b60: 6f72 2d3e 6461 7461 3b0a 0a20 2020 2020  or->data;..     
+00078b70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00078b80: 7772 6974 6528 2670 7472 2c20 7369 7a65  write(&ptr, size
+00078b90: 6f66 2875 696e 7436 345f 7429 2c20 312c  of(uint64_t), 1,
+00078ba0: 2066 6f75 7429 3b0a 2020 2020 2020 2020   fout);.        
+00078bb0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00078bc0: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+00078bd0: 6528 7465 6e73 6f72 2d3e 6e61 6d65 2c20  e(tensor->name, 
+00078be0: 7369 7a65 6f66 2863 6861 7229 2c20 4747  sizeof(char), GG
+00078bf0: 4d4c 5f4d 4158 5f4e 414d 452c 2066 6f75  ML_MAX_NAME, fou
+00078c00: 7429 3b0a 0a20 2020 2020 2020 2020 2020  t);..           
+00078c10: 2020 2020 202f 2f20 6f75 7470 7574 2074       // output t
+00078c20: 6865 206f 7020 6172 6775 6d65 6e74 730a  he op arguments.
+00078c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c40: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00078c50: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00078c60: 6c5f 7465 6e73 6f72 202a 2061 7267 735b  l_tensor * args[
+00078c70: 3220 2b20 4747 4d4c 5f4d 4158 5f4f 5054  2 + GGML_MAX_OPT
+00078c80: 5d20 3d20 7b20 4e55 4c4c 207d 3b0a 0a20  ] = { NULL };.. 
+00078c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078ca0: 2020 2061 7267 735b 305d 203d 2074 656e     args[0] = ten
+00078cb0: 736f 722d 3e73 7263 303b 0a20 2020 2020  sor->src0;.     
+00078cc0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00078cd0: 7267 735b 315d 203d 2074 656e 736f 722d  rgs[1] = tensor-
+00078ce0: 3e73 7263 313b 0a0a 2020 2020 2020 2020  >src1;..        
+00078cf0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00078d00: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
+00078d10: 4747 4d4c 5f4d 4158 5f4f 5054 3b20 2b2b  GGML_MAX_OPT; ++
+00078d20: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
+00078d30: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+00078d40: 735b 3220 2b20 6a5d 203d 2074 656e 736f  s[2 + j] = tenso
+00078d50: 722d 3e6f 7074 5b6a 5d3b 0a20 2020 2020  r->opt[j];.     
+00078d60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00078d70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00078d80: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00078d90: 203d 2030 3b20 6a20 3c20 3220 2b20 4747   = 0; j < 2 + GG
+00078da0: 4d4c 5f4d 4158 5f4f 5054 3b20 2b2b 6a29  ML_MAX_OPT; ++j)
+00078db0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00078dc0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
+00078dd0: 7267 735b 6a5d 2920 7b0a 2020 2020 2020  rgs[j]) {.      
 00078de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078df0: 2069 6e74 3332 5f74 2069 6478 203d 202d   int32_t idx = -
-00078e00: 313b 0a0a 2020 2020 2020 2020 2020 2020  1;..            
+00078df0: 2020 2020 2020 696e 7433 325f 7420 6964        int32_t id
+00078e00: 7820 3d20 2d31 3b0a 0a20 2020 2020 2020  x = -1;..       
 00078e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078e20: 2f2f 2063 6865 636b 2069 6620 6c65 6166  // check if leaf
-00078e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078e40: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00078e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078e60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00078e70: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
-00078e80: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
-00078e90: 6673 3b20 2b2b 6b29 207b 0a20 2020 2020  fs; ++k) {.     
+00078e20: 2020 2020 202f 2f20 6368 6563 6b20 6966       // check if
+00078e30: 206c 6561 660a 2020 2020 2020 2020 2020   leaf.          
+00078e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078e50: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00078e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078e70: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
+00078e80: 2030 3b20 6b20 3c20 6367 7261 7068 2d3e   0; k < cgraph->
+00078e90: 6e5f 6c65 6166 733b 202b 2b6b 2920 7b0a  n_leafs; ++k) {.
 00078ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078eb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00078ec0: 6620 2861 7267 735b 6a5d 203d 3d20 6367  f (args[j] == cg
-00078ed0: 7261 7068 2d3e 6c65 6166 735b 6b5d 2920  raph->leafs[k]) 
-00078ee0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00078eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078ec0: 2020 2020 6966 2028 6172 6773 5b6a 5d20      if (args[j] 
+00078ed0: 3d3d 2063 6772 6170 682d 3e6c 6561 6673  == cgraph->leafs
+00078ee0: 5b6b 5d29 207b 0a20 2020 2020 2020 2020  [k]) {.         
 00078ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f00: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
-00078f10: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00078f00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00078f10: 6478 203d 206b 3b0a 2020 2020 2020 2020  dx = k;.        
 00078f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f30: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00078f40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00078f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078f40: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
 00078f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f60: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00078f60: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 00078f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f80: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00078f80: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
 00078f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078fa0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00078fa0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
 00078fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078fc0: 2020 2020 202f 2f20 6368 6563 6b20 6966       // check if
-00078fd0: 206e 6f64 650a 2020 2020 2020 2020 2020   node.          
+00078fc0: 2020 2020 2020 2020 2020 2f2f 2063 6865            // che
+00078fd0: 636b 2069 6620 6e6f 6465 0a20 2020 2020  ck if node.     
 00078fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ff0: 2020 6966 2028 6964 7820 3d3d 202d 3129    if (idx == -1)
-00079000: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00078ff0: 2020 2020 2020 2069 6620 2869 6478 203d         if (idx =
+00079000: 3d20 2d31 2920 7b0a 2020 2020 2020 2020  = -1) {.        
 00079010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079020: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
-00079030: 303b 206b 203c 2063 6772 6170 682d 3e6e  0; k < cgraph->n
-00079040: 5f6e 6f64 6573 3b20 2b2b 6b29 207b 0a20  _nodes; ++k) {. 
-00079050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079020: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00079030: 206b 203d 2030 3b20 6b20 3c20 6367 7261   k = 0; k < cgra
+00079040: 7068 2d3e 6e5f 6e6f 6465 733b 202b 2b6b  ph->n_nodes; ++k
+00079050: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
 00079060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079070: 2020 2069 6620 2861 7267 735b 6a5d 203d     if (args[j] =
-00079080: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
-00079090: 6b5d 2920 7b0a 2020 2020 2020 2020 2020  k]) {.          
+00079070: 2020 2020 2020 2020 6966 2028 6172 6773          if (args
+00079080: 5b6a 5d20 3d3d 2063 6772 6170 682d 3e6e  [j] == cgraph->n
+00079090: 6f64 6573 5b6b 5d29 207b 0a20 2020 2020  odes[k]) {.     
 000790a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000790b0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-000790c0: 7820 3d20 4747 4d4c 5f4d 4158 5f4e 4f44  x = GGML_MAX_NOD
-000790d0: 4553 202b 206b 3b0a 2020 2020 2020 2020  ES + k;.        
+000790b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000790c0: 2020 2069 6478 203d 2047 474d 4c5f 4d41     idx = GGML_MA
+000790d0: 585f 4e4f 4445 5320 2b20 6b3b 0a20 2020  X_NODES + k;.   
 000790e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000790f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079100: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+00079100: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
 00079110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079120: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00079130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079140: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00079150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079160: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00079170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079180: 2020 2020 2020 2020 2020 6966 2028 6964            if (id
-00079190: 7820 3d3d 202d 3129 207b 0a20 2020 2020  x == -1) {.     
+00079120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079130: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00079140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079150: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00079160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079170: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00079180: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00079190: 6620 2869 6478 203d 3d20 2d31 2920 7b0a  f (idx == -1) {.
 000791a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000791b0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-000791c0: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
-000791d0: 6661 696c 6564 2074 6f20 6669 6e64 2074  failed to find t
-000791e0: 656e 736f 722c 2061 7267 203d 2025 642c  ensor, arg = %d,
-000791f0: 206e 6f64 6520 3d20 2564 5c6e 222c 205f   node = %d\n", _
-00079200: 5f66 756e 635f 5f2c 206a 2c20 6929 3b0a  _func__, j, i);.
-00079210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000791b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000791c0: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
+000791d0: 2225 733a 2066 6169 6c65 6420 746f 2066  "%s: failed to f
+000791e0: 696e 6420 7465 6e73 6f72 2c20 6172 6720  ind tensor, arg 
+000791f0: 3d20 2564 2c20 6e6f 6465 203d 2025 645c  = %d, node = %d\
+00079200: 6e22 2c20 5f5f 6675 6e63 5f5f 2c20 6a2c  n", __func__, j,
+00079210: 2069 293b 0a20 2020 2020 2020 2020 2020   i);.           
 00079220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079230: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
+00079230: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
 00079240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079250: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00079250: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
 00079260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079270: 2020 2066 7772 6974 6528 2669 6478 2c20     fwrite(&idx, 
-00079280: 7369 7a65 6f66 2869 6e74 3332 5f74 292c  sizeof(int32_t),
-00079290: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+00079270: 2020 2020 2020 2020 6677 7269 7465 2826          fwrite(&
+00079280: 6964 782c 2073 697a 656f 6628 696e 7433  idx, sizeof(int3
+00079290: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
 000792a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792b0: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
-000792c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792d0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000792e0: 7433 325f 7420 6e75 6c20 3d20 2d31 3b0a  t32_t nul = -1;.
-000792f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079300: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-00079310: 6974 6528 266e 756c 2c20 7369 7a65 6f66  ite(&nul, sizeof
-00079320: 2869 6e74 3332 5f74 292c 2031 2c20 666f  (int32_t), 1, fo
-00079330: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00079340: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00079350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079360: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00079370: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00079380: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
-00079390: 2020 2020 2020 2020 6663 6c6f 7365 2866          fclose(f
-000793a0: 6f75 7429 3b0a 2020 2020 7d0a 7d0a 0a73  out);.    }.}..s
-000793b0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-000793c0: 6820 6767 6d6c 5f67 7261 7068 5f69 6d70  h ggml_graph_imp
-000793d0: 6f72 7428 636f 6e73 7420 6368 6172 202a  ort(const char *
-000793e0: 2066 6e61 6d65 2c20 7374 7275 6374 2067   fname, struct g
-000793f0: 676d 6c5f 636f 6e74 6578 7420 2a2a 2063  gml_context ** c
-00079400: 7478 5f64 6174 612c 2073 7472 7563 7420  tx_data, struct 
-00079410: 6767 6d6c 5f63 6f6e 7465 7874 202a 2a20  ggml_context ** 
-00079420: 6374 785f 6576 616c 2920 7b0a 2020 2020  ctx_eval) {.    
-00079430: 6173 7365 7274 282a 6374 785f 6461 7461  assert(*ctx_data
-00079440: 203d 3d20 4e55 4c4c 293b 0a20 2020 2061   == NULL);.    a
-00079450: 7373 6572 7428 2a63 7478 5f65 7661 6c20  ssert(*ctx_eval 
-00079460: 3d3d 204e 554c 4c29 3b0a 0a20 2020 2073  == NULL);..    s
-00079470: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-00079480: 6820 7265 7375 6c74 203d 207b 2030 207d  h result = { 0 }
-00079490: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
-000794a0: 6d6c 5f74 656e 736f 7220 2a20 6461 7461  ml_tensor * data
-000794b0: 203d 204e 554c 4c3b 0a0a 2020 2020 2f2f   = NULL;..    //
-000794c0: 2072 6561 6420 6669 6c65 2069 6e74 6f20   read file into 
-000794d0: 6461 7461 0a20 2020 207b 0a20 2020 2020  data.    {.     
-000794e0: 2020 2046 494c 4520 2a20 6669 6e20 3d20     FILE * fin = 
-000794f0: 666f 7065 6e28 666e 616d 652c 2022 7262  fopen(fname, "rb
-00079500: 2229 3b0a 0a20 2020 2020 2020 2069 6620  ");..        if 
-00079510: 2821 6669 6e29 207b 0a20 2020 2020 2020  (!fin) {.       
-00079520: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
-00079530: 6572 722c 2022 2573 3a20 6661 696c 6564  err, "%s: failed
-00079540: 2074 6f20 6f70 656e 2025 735c 6e22 2c20   to open %s\n", 
-00079550: 5f5f 6675 6e63 5f5f 2c20 666e 616d 6529  __func__, fname)
-00079560: 3b0a 2020 2020 2020 2020 2020 2020 7265  ;.            re
-00079570: 7475 726e 2072 6573 756c 743b 0a20 2020  turn result;.   
-00079580: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00079590: 7369 7a65 5f74 2066 7369 7a65 203d 2030  size_t fsize = 0
-000795a0: 3b0a 0a20 2020 2020 2020 2066 7365 656b  ;..        fseek
-000795b0: 2866 696e 2c20 302c 2053 4545 4b5f 454e  (fin, 0, SEEK_EN
-000795c0: 4429 3b0a 2020 2020 2020 2020 6673 697a  D);.        fsiz
-000795d0: 6520 3d20 6674 656c 6c28 6669 6e29 3b0a  e = ftell(fin);.
-000795e0: 2020 2020 2020 2020 6673 6565 6b28 6669          fseek(fi
-000795f0: 6e2c 2030 2c20 5345 454b 5f53 4554 293b  n, 0, SEEK_SET);
-00079600: 0a0a 2020 2020 2020 2020 2f2f 2063 7265  ..        // cre
-00079610: 6174 6520 7468 6520 6461 7461 2063 6f6e  ate the data con
-00079620: 7465 7874 0a20 2020 2020 2020 207b 0a20  text.        {. 
-00079630: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00079640: 2073 697a 655f 7420 6f76 6572 6865 6164   size_t overhead
-00079650: 203d 2031 2a67 676d 6c5f 7465 6e73 6f72   = 1*ggml_tensor
-00079660: 5f6f 7665 7268 6561 6428 293b 0a0a 2020  _overhead();..  
-00079670: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00079680: 2067 676d 6c5f 696e 6974 5f70 6172 616d   ggml_init_param
-00079690: 7320 7061 7261 6d73 203d 207b 0a20 2020  s params = {.   
-000796a0: 2020 2020 2020 2020 2020 2020 202e 6d65               .me
-000796b0: 6d5f 7369 7a65 2020 203d 2066 7369 7a65  m_size   = fsize
-000796c0: 202b 206f 7665 7268 6561 642c 0a20 2020   + overhead,.   
-000796d0: 2020 2020 2020 2020 2020 2020 202e 6d65               .me
-000796e0: 6d5f 6275 6666 6572 203d 204e 554c 4c2c  m_buffer = NULL,
-000796f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079700: 202e 6e6f 5f61 6c6c 6f63 2020 203d 2066   .no_alloc   = f
-00079710: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00079720: 2020 7d3b 0a0a 2020 2020 2020 2020 2020    };..          
-00079730: 2020 2a63 7478 5f64 6174 6120 3d20 6767    *ctx_data = gg
-00079740: 6d6c 5f69 6e69 7428 7061 7261 6d73 293b  ml_init(params);
-00079750: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00079760: 2028 212a 6374 785f 6461 7461 2920 7b0a   (!*ctx_data) {.
-00079770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079780: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
-00079790: 2225 733a 2066 6169 6c65 6420 746f 2063  "%s: failed to c
-000797a0: 7265 6174 6520 6767 6d6c 2063 6f6e 7465  reate ggml conte
-000797b0: 7874 5c6e 222c 205f 5f66 756e 635f 5f29  xt\n", __func__)
-000797c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000797d0: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-000797e0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-000797f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00079800: 2020 6461 7461 203d 2067 676d 6c5f 6e65    data = ggml_ne
-00079810: 775f 7465 6e73 6f72 5f31 6428 2a63 7478  w_tensor_1d(*ctx
-00079820: 5f64 6174 612c 2047 474d 4c5f 5459 5045  _data, GGML_TYPE
-00079830: 5f49 382c 2066 7369 7a65 293b 0a0a 2020  _I8, fsize);..  
-00079840: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079850: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-00079860: 2072 6574 203d 2066 7265 6164 2864 6174   ret = fread(dat
-00079870: 612d 3e64 6174 612c 2073 697a 656f 6628  a->data, sizeof(
-00079880: 6368 6172 292c 2066 7369 7a65 2c20 6669  char), fsize, fi
-00079890: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
-000798a0: 6966 2028 7265 7420 213d 2066 7369 7a65  if (ret != fsize
-000798b0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000798c0: 2020 2020 6670 7269 6e74 6628 7374 6465      fprintf(stde
-000798d0: 7272 2c20 2225 733a 2066 6169 6c65 6420  rr, "%s: failed 
-000798e0: 746f 2072 6561 6420 2573 5c6e 222c 205f  to read %s\n", _
-000798f0: 5f66 756e 635f 5f2c 2066 6e61 6d65 293b  _func__, fname);
-00079900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079910: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-00079920: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00079930: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00079940: 2066 636c 6f73 6528 6669 6e29 3b0a 2020   fclose(fin);.  
-00079950: 2020 7d0a 0a20 2020 202f 2f20 706f 7075    }..    // popu
-00079960: 6c61 7465 2072 6573 756c 740a 2020 2020  late result.    
-00079970: 7b0a 2020 2020 2020 2020 6368 6172 202a  {.        char *
-00079980: 2070 7472 203d 2028 6368 6172 202a 2920   ptr = (char *) 
-00079990: 6461 7461 2d3e 6461 7461 3b0a 0a20 2020  data->data;..   
-000799a0: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
-000799b0: 325f 7420 6d61 6769 6320 3d20 2a28 636f  2_t magic = *(co
-000799c0: 6e73 7420 7569 6e74 3332 5f74 202a 2920  nst uint32_t *) 
-000799d0: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
-000799e0: 6f66 286d 6167 6963 293b 0a0a 2020 2020  of(magic);..    
-000799f0: 2020 2020 6966 2028 6d61 6769 6320 213d      if (magic !=
-00079a00: 2047 474d 4c5f 4649 4c45 5f4d 4147 4943   GGML_FILE_MAGIC
-00079a10: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00079a20: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
-00079a30: 2225 733a 2069 6e76 616c 6964 206d 6167  "%s: invalid mag
-00079a40: 6963 206e 756d 6265 722c 2067 6f74 2025  ic number, got %
-00079a50: 3038 785c 6e22 2c20 5f5f 6675 6e63 5f5f  08x\n", __func__
-00079a60: 2c20 6d61 6769 6329 3b0a 2020 2020 2020  , magic);.      
-00079a70: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00079a80: 756c 743b 0a20 2020 2020 2020 207d 0a0a  ult;.        }..
-00079a90: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00079aa0: 6e74 3332 5f74 2076 6572 7369 6f6e 203d  nt32_t version =
-00079ab0: 202a 2863 6f6e 7374 2075 696e 7433 325f   *(const uint32_
-00079ac0: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
-00079ad0: 2073 697a 656f 6628 7665 7273 696f 6e29   sizeof(version)
-00079ae0: 3b0a 0a20 2020 2020 2020 2069 6620 2876  ;..        if (v
-00079af0: 6572 7369 6f6e 2021 3d20 4747 4d4c 5f46  ersion != GGML_F
-00079b00: 494c 455f 5645 5253 494f 4e29 207b 0a20  ILE_VERSION) {. 
-00079b10: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-00079b20: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
-00079b30: 696e 7661 6c69 6420 7665 7273 696f 6e20  invalid version 
-00079b40: 6e75 6d62 6572 5c6e 222c 205f 5f66 756e  number\n", __fun
-00079b50: 635f 5f29 3b0a 2020 2020 2020 2020 2020  c__);.          
-00079b60: 2020 7265 7475 726e 2072 6573 756c 743b    return result;
-00079b70: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00079b80: 2020 2020 636f 6e73 7420 7569 6e74 3332      const uint32
-00079b90: 5f74 206e 5f6c 6561 6673 2020 203d 202a  _t n_leafs   = *
-00079ba0: 2863 6f6e 7374 2075 696e 7433 325f 7420  (const uint32_t 
-00079bb0: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
-00079bc0: 697a 656f 6628 6e5f 6c65 6166 7329 3b0a  izeof(n_leafs);.
-00079bd0: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00079be0: 6e74 3332 5f74 206e 5f6e 6f64 6573 2020  nt32_t n_nodes  
-00079bf0: 203d 202a 2863 6f6e 7374 2075 696e 7433   = *(const uint3
-00079c00: 325f 7420 2a29 2070 7472 3b20 7074 7220  2_t *) ptr; ptr 
-00079c10: 2b3d 2073 697a 656f 6628 6e5f 6e6f 6465  += sizeof(n_node
-00079c20: 7329 3b0a 2020 2020 2020 2020 636f 6e73  s);.        cons
-00079c30: 7420 7569 6e74 3634 5f74 2073 697a 655f  t uint64_t size_
-00079c40: 6576 616c 203d 202a 2863 6f6e 7374 2075  eval = *(const u
-00079c50: 696e 7436 345f 7420 2a29 2070 7472 3b20  int64_t *) ptr; 
-00079c60: 7074 7220 2b3d 2073 697a 656f 6628 7369  ptr += sizeof(si
-00079c70: 7a65 5f65 7661 6c29 3b0a 0a20 2020 2020  ze_eval);..     
-00079c80: 2020 2072 6573 756c 742e 6e5f 6c65 6166     result.n_leaf
-00079c90: 7320 3d20 6e5f 6c65 6166 733b 0a20 2020  s = n_leafs;.   
-00079ca0: 2020 2020 2072 6573 756c 742e 6e5f 6e6f       result.n_no
-00079cb0: 6465 7320 3d20 6e5f 6e6f 6465 733b 0a0a  des = n_nodes;..
-00079cc0: 2020 2020 2020 2020 2f2f 2063 7265 6174          // creat
-00079cd0: 6520 7468 6520 6461 7461 2063 6f6e 7465  e the data conte
-00079ce0: 7874 0a20 2020 2020 2020 207b 0a20 2020  xt.        {.   
-00079cf0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-00079d00: 697a 655f 7420 6f76 6572 6865 6164 203d  ize_t overhead =
-00079d10: 2028 6e5f 6c65 6166 7320 2b20 6e5f 6e6f   (n_leafs + n_no
-00079d20: 6465 7329 2a67 676d 6c5f 7465 6e73 6f72  des)*ggml_tensor
-00079d30: 5f6f 7665 7268 6561 6428 293b 0a0a 2020  _overhead();..  
-00079d40: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00079d50: 2067 676d 6c5f 696e 6974 5f70 6172 616d   ggml_init_param
-00079d60: 7320 7061 7261 6d73 203d 207b 0a20 2020  s params = {.   
-00079d70: 2020 2020 2020 2020 2020 2020 202e 6d65               .me
-00079d80: 6d5f 7369 7a65 2020 203d 2073 697a 655f  m_size   = size_
-00079d90: 6576 616c 202b 206f 7665 7268 6561 642c  eval + overhead,
-00079da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079db0: 202e 6d65 6d5f 6275 6666 6572 203d 204e   .mem_buffer = N
-00079dc0: 554c 4c2c 0a20 2020 2020 2020 2020 2020  ULL,.           
-00079dd0: 2020 2020 202e 6e6f 5f61 6c6c 6f63 2020       .no_alloc  
-00079de0: 203d 2074 7275 652c 0a20 2020 2020 2020   = true,.       
-00079df0: 2020 2020 207d 3b0a 0a20 2020 2020 2020       };..       
-00079e00: 2020 2020 202a 6374 785f 6576 616c 203d       *ctx_eval =
-00079e10: 2067 676d 6c5f 696e 6974 2870 6172 616d   ggml_init(param
-00079e20: 7329 3b0a 0a20 2020 2020 2020 2020 2020  s);..           
-00079e30: 2069 6620 2821 2a63 7478 5f65 7661 6c29   if (!*ctx_eval)
-00079e40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00079e50: 2020 2066 7072 696e 7466 2873 7464 6572     fprintf(stder
-00079e60: 722c 2022 2573 3a20 6661 696c 6564 2074  r, "%s: failed t
-00079e70: 6f20 6372 6561 7465 2067 676d 6c20 636f  o create ggml co
-00079e80: 6e74 6578 745c 6e22 2c20 5f5f 6675 6e63  ntext\n", __func
-00079e90: 5f5f 293b 0a20 2020 2020 2020 2020 2020  __);.           
-00079ea0: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-00079eb0: 6c74 3b0a 2020 2020 2020 2020 2020 2020  lt;.            
-00079ec0: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-00079ed0: 2020 2020 202f 2f20 6c65 6166 730a 2020       // leafs.  
-00079ee0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079ef0: 2020 2020 7569 6e74 3332 5f74 2074 7970      uint32_t typ
-00079f00: 653b 0a20 2020 2020 2020 2020 2020 2075  e;.            u
-00079f10: 696e 7433 325f 7420 6f70 3b0a 2020 2020  int32_t op;.    
-00079f20: 2020 2020 2020 2020 7569 6e74 3332 5f74          uint32_t
-00079f30: 206e 5f64 696d 733b 0a0a 2020 2020 2020   n_dims;..      
-00079f40: 2020 2020 2020 666f 7220 2875 696e 7433        for (uint3
-00079f50: 325f 7420 6920 3d20 303b 2069 203c 206e  2_t i = 0; i < n
-00079f60: 5f6c 6561 6673 3b20 2b2b 6929 207b 0a20  _leafs; ++i) {. 
-00079f70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00079f80: 7970 6520 2020 3d20 2a28 636f 6e73 7420  ype   = *(const 
-00079f90: 7569 6e74 3332 5f74 202a 2920 7074 723b  uint32_t *) ptr;
-00079fa0: 2070 7472 202b 3d20 7369 7a65 6f66 2874   ptr += sizeof(t
-00079fb0: 7970 6529 3b0a 2020 2020 2020 2020 2020  ype);.          
-00079fc0: 2020 2020 2020 6f70 2020 2020 203d 202a        op     = *
-00079fd0: 2863 6f6e 7374 2075 696e 7433 325f 7420  (const uint32_t 
-00079fe0: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
-00079ff0: 697a 656f 6628 6f70 293b 0a20 2020 2020  izeof(op);.     
-0007a000: 2020 2020 2020 2020 2020 206e 5f64 696d             n_dim
-0007a010: 7320 3d20 2a28 636f 6e73 7420 7569 6e74  s = *(const uint
-0007a020: 3332 5f74 202a 2920 7074 723b 2070 7472  32_t *) ptr; ptr
-0007a030: 202b 3d20 7369 7a65 6f66 286e 5f64 696d   += sizeof(n_dim
-0007a040: 7329 3b0a 0a20 2020 2020 2020 2020 2020  s);..           
-0007a050: 2020 2020 2069 6e74 3634 5f74 206e 655b       int64_t ne[
-0007a060: 4747 4d4c 5f4d 4158 5f44 494d 535d 3b0a  GGML_MAX_DIMS];.
-0007a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a080: 7369 7a65 5f74 2020 6e62 5b47 474d 4c5f  size_t  nb[GGML_
-0007a090: 4d41 585f 4449 4d53 5d3b 0a0a 2020 2020  MAX_DIMS];..    
-0007a0a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0007a0b0: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
-0007a0c0: 4747 4d4c 5f4d 4158 5f44 494d 533b 202b  GGML_MAX_DIMS; +
-0007a0d0: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
-0007a0e0: 2020 2020 2020 2020 2020 7569 6e74 3634            uint64
-0007a0f0: 5f74 206e 655f 6375 723b 0a20 2020 2020  _t ne_cur;.     
-0007a100: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-0007a110: 696e 7436 345f 7420 6e62 5f63 7572 3b0a  int64_t nb_cur;.
-0007a120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007a130: 2020 2020 206e 655f 6375 7220 3d20 2a28       ne_cur = *(
-0007a140: 636f 6e73 7420 7569 6e74 3634 5f74 202a  const uint64_t *
-0007a150: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
-0007a160: 7a65 6f66 286e 655f 6375 7229 3b0a 2020  zeof(ne_cur);.  
-0007a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a180: 2020 6e62 5f63 7572 203d 202a 2863 6f6e    nb_cur = *(con
-0007a190: 7374 2075 696e 7436 345f 7420 2a29 2070  st uint64_t *) p
-0007a1a0: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
-0007a1b0: 6628 6e62 5f63 7572 293b 0a0a 2020 2020  f(nb_cur);..    
-0007a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a1d0: 6e65 5b6a 5d20 3d20 6e65 5f63 7572 3b0a  ne[j] = ne_cur;.
-0007a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a1f0: 2020 2020 6e62 5b6a 5d20 3d20 6e62 5f63      nb[j] = nb_c
-0007a200: 7572 3b0a 2020 2020 2020 2020 2020 2020  ur;.            
-0007a210: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0007a220: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0007a230: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-0007a240: 6f72 203d 2067 676d 6c5f 6e65 775f 7465  or = ggml_new_te
-0007a250: 6e73 6f72 282a 6374 785f 6576 616c 2c20  nsor(*ctx_eval, 
-0007a260: 2865 6e75 6d20 6767 6d6c 5f74 7970 6529  (enum ggml_type)
-0007a270: 2074 7970 652c 206e 5f64 696d 732c 206e   type, n_dims, n
-0007a280: 6529 3b0a 0a20 2020 2020 2020 2020 2020  e);..           
-0007a290: 2020 2020 2074 656e 736f 722d 3e6f 7020       tensor->op 
-0007a2a0: 3d20 2865 6e75 6d20 6767 6d6c 5f6f 7029  = (enum ggml_op)
-0007a2b0: 206f 703b 0a0a 2020 2020 2020 2020 2020   op;..          
-0007a2c0: 2020 2020 2020 7569 6e74 3634 5f74 2070        uint64_t p
-0007a2d0: 7472 5f63 7572 203d 202a 2863 6f6e 7374  tr_cur = *(const
-0007a2e0: 2075 696e 7436 345f 7420 2a29 2070 7472   uint64_t *) ptr
-0007a2f0: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
-0007a300: 7074 725f 6375 7229 3b0a 0a20 2020 2020  ptr_cur);..     
-0007a310: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
-0007a320: 7928 7465 6e73 6f72 2d3e 6e61 6d65 2c20  y(tensor->name, 
-0007a330: 7074 722c 2047 474d 4c5f 4d41 585f 4e41  ptr, GGML_MAX_NA
-0007a340: 4d45 293b 2070 7472 202b 3d20 4747 4d4c  ME); ptr += GGML
-0007a350: 5f4d 4158 5f4e 414d 453b 0a0a 2020 2020  _MAX_NAME;..    
-0007a360: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
-0007a370: 6f72 2d3e 6461 7461 203d 2028 766f 6964  or->data = (void
-0007a380: 202a 2920 7074 723b 0a0a 2020 2020 2020   *) ptr;..      
-0007a390: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0007a3a0: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
-0007a3b0: 4d4c 5f4d 4158 5f44 494d 533b 202b 2b6a  ML_MAX_DIMS; ++j
-0007a3c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007a3d0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-0007a3e0: 6e62 5b6a 5d20 3d20 6e62 5b6a 5d3b 0a20  nb[j] = nb[j];. 
-0007a3f0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007a400: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007a410: 2020 7265 7375 6c74 2e6c 6561 6673 5b69    result.leafs[i
-0007a420: 5d20 3d20 7465 6e73 6f72 3b0a 0a20 2020  ] = tensor;..   
-0007a430: 2020 2020 2020 2020 2020 2020 2070 7472               ptr
-0007a440: 202b 3d20 6767 6d6c 5f6e 6279 7465 7328   += ggml_nbytes(
-0007a450: 7465 6e73 6f72 293b 0a0a 2020 2020 2020  tensor);..      
-0007a460: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
-0007a470: 6628 7374 6465 7272 2c20 2225 733a 206c  f(stderr, "%s: l
-0007a480: 6f61 6465 6420 6c65 6166 2025 643a 2027  oaded leaf %d: '
-0007a490: 2531 3673 272c 2025 3364 2064 696d 732c  %16s', %3d dims,
-0007a4a0: 2025 397a 7520 6279 7465 735c 6e22 2c20   %9zu bytes\n", 
-0007a4b0: 5f5f 6675 6e63 5f5f 2c20 692c 2074 656e  __func__, i, ten
-0007a4c0: 736f 722d 3e6e 616d 652c 206e 5f64 696d  sor->name, n_dim
-0007a4d0: 732c 2067 676d 6c5f 6e62 7974 6573 2874  s, ggml_nbytes(t
-0007a4e0: 656e 736f 7229 293b 0a20 2020 2020 2020  ensor));.       
-0007a4f0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-0007a500: 0a0a 2020 2020 2020 2020 6767 6d6c 5f73  ..        ggml_s
-0007a510: 6574 5f6e 6f5f 616c 6c6f 6328 2a63 7478  et_no_alloc(*ctx
-0007a520: 5f65 7661 6c2c 2066 616c 7365 293b 0a0a  _eval, false);..
-0007a530: 2020 2020 2020 2020 2f2f 206e 6f64 6573          // nodes
-0007a540: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-0007a550: 2020 2020 2020 2075 696e 7433 325f 7420         uint32_t 
-0007a560: 7479 7065 3b0a 2020 2020 2020 2020 2020  type;.          
-0007a570: 2020 7569 6e74 3332 5f74 206f 703b 0a20    uint32_t op;. 
-0007a580: 2020 2020 2020 2020 2020 2075 696e 7433             uint3
-0007a590: 325f 7420 6e5f 6469 6d73 3b0a 0a20 2020  2_t n_dims;..   
-0007a5a0: 2020 2020 2020 2020 2066 6f72 2028 7569           for (ui
-0007a5b0: 6e74 3332 5f74 2069 203d 2030 3b20 6920  nt32_t i = 0; i 
-0007a5c0: 3c20 6e5f 6e6f 6465 733b 202b 2b69 2920  < n_nodes; ++i) 
-0007a5d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007a5e0: 2020 7479 7065 2020 203d 202a 2863 6f6e    type   = *(con
-0007a5f0: 7374 2075 696e 7433 325f 7420 2a29 2070  st uint32_t *) p
-0007a600: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
-0007a610: 6628 7479 7065 293b 0a20 2020 2020 2020  f(type);.       
-0007a620: 2020 2020 2020 2020 206f 7020 2020 2020           op     
-0007a630: 3d20 2a28 636f 6e73 7420 7569 6e74 3332  = *(const uint32
-0007a640: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
-0007a650: 3d20 7369 7a65 6f66 286f 7029 3b0a 2020  = sizeof(op);.  
-0007a660: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-0007a670: 6469 6d73 203d 202a 2863 6f6e 7374 2075  dims = *(const u
-0007a680: 696e 7433 325f 7420 2a29 2070 7472 3b20  int32_t *) ptr; 
-0007a690: 7074 7220 2b3d 2073 697a 656f 6628 6e5f  ptr += sizeof(n_
-0007a6a0: 6469 6d73 293b 0a0a 2020 2020 2020 2020  dims);..        
-0007a6b0: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
-0007a6c0: 6e65 5b47 474d 4c5f 4d41 585f 4449 4d53  ne[GGML_MAX_DIMS
-0007a6d0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0007a6e0: 2020 2073 697a 655f 7420 206e 625b 4747     size_t  nb[GG
-0007a6f0: 4d4c 5f4d 4158 5f44 494d 535d 3b0a 0a20  ML_MAX_DIMS];.. 
-0007a700: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0007a710: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-0007a720: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
-0007a730: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
-0007a740: 2020 2020 2020 2020 2020 2020 2075 696e               uin
-0007a750: 7436 345f 7420 6e65 5f63 7572 3b0a 2020  t64_t ne_cur;.  
-0007a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a770: 2020 7569 6e74 3634 5f74 206e 625f 6375    uint64_t nb_cu
-0007a780: 723b 0a0a 2020 2020 2020 2020 2020 2020  r;..            
-0007a790: 2020 2020 2020 2020 6e65 5f63 7572 203d          ne_cur =
-0007a7a0: 202a 2863 6f6e 7374 2075 696e 7436 345f   *(const uint64_
-0007a7b0: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
-0007a7c0: 2073 697a 656f 6628 6e65 5f63 7572 293b   sizeof(ne_cur);
-0007a7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007a7e0: 2020 2020 206e 625f 6375 7220 3d20 2a28       nb_cur = *(
-0007a7f0: 636f 6e73 7420 7569 6e74 3634 5f74 202a  const uint64_t *
-0007a800: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
-0007a810: 7a65 6f66 286e 625f 6375 7229 3b0a 0a20  zeof(nb_cur);.. 
-0007a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a830: 2020 206e 655b 6a5d 203d 206e 655f 6375     ne[j] = ne_cu
-0007a840: 723b 0a20 2020 2020 2020 2020 2020 2020  r;.             
-0007a850: 2020 2020 2020 206e 625b 6a5d 203d 206e         nb[j] = n
-0007a860: 625f 6375 723b 0a20 2020 2020 2020 2020  b_cur;.         
-0007a870: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0007a880: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-0007a890: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
-0007a8a0: 656e 736f 7220 3d20 6767 6d6c 5f6e 6577  ensor = ggml_new
-0007a8b0: 5f74 656e 736f 7228 2a63 7478 5f65 7661  _tensor(*ctx_eva
-0007a8c0: 6c2c 2028 656e 756d 2067 676d 6c5f 7479  l, (enum ggml_ty
-0007a8d0: 7065 2920 7479 7065 2c20 6e5f 6469 6d73  pe) type, n_dims
-0007a8e0: 2c20 6e65 293b 0a0a 2020 2020 2020 2020  , ne);..        
-0007a8f0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-0007a900: 6f70 203d 2028 656e 756d 2067 676d 6c5f  op = (enum ggml_
-0007a910: 6f70 2920 6f70 3b0a 0a20 2020 2020 2020  op) op;..       
-0007a920: 2020 2020 2020 2020 2075 696e 7436 345f           uint64_
-0007a930: 7420 7074 725f 6375 7220 3d20 2a28 636f  t ptr_cur = *(co
-0007a940: 6e73 7420 7569 6e74 3634 5f74 202a 2920  nst uint64_t *) 
-0007a950: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
-0007a960: 6f66 2870 7472 5f63 7572 293b 0a0a 2020  of(ptr_cur);..  
-0007a970: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0007a980: 6d63 7079 2874 656e 736f 722d 3e6e 616d  mcpy(tensor->nam
-0007a990: 652c 2070 7472 2c20 4747 4d4c 5f4d 4158  e, ptr, GGML_MAX
-0007a9a0: 5f4e 414d 4529 3b20 7074 7220 2b3d 2047  _NAME); ptr += G
-0007a9b0: 474d 4c5f 4d41 585f 4e41 4d45 3b0a 0a20  GML_MAX_NAME;.. 
-0007a9c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0007a9d0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-0007a9e0: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
-0007a9f0: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
-0007aa00: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-0007aa10: 736f 722d 3e6e 625b 6a5d 203d 206e 625b  sor->nb[j] = nb[
-0007aa20: 6a5d 3b0a 2020 2020 2020 2020 2020 2020  j];.            
-0007aa30: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0007aa40: 2020 2020 2020 202f 2f20 7061 7273 6520         // parse 
-0007aa50: 6172 6773 0a20 2020 2020 2020 2020 2020  args.           
-0007aa60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0007aa70: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-0007aa80: 7420 6767 6d6c 5f74 656e 736f 7220 2a2a  t ggml_tensor **
-0007aa90: 2061 7267 735b 3220 2b20 4747 4d4c 5f4d   args[2 + GGML_M
-0007aaa0: 4158 5f4f 5054 5d20 3d20 7b0a 2020 2020  AX_OPT] = {.    
-0007aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007aac0: 2020 2020 2674 656e 736f 722d 3e73 7263      &tensor->src
-0007aad0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0007aae0: 2020 2020 2020 2020 2020 2026 7465 6e73             &tens
-0007aaf0: 6f72 2d3e 7372 6331 2c0a 2020 2020 2020  or->src1,.      
-0007ab00: 2020 2020 2020 2020 2020 2020 2020 7d3b                };
-0007ab10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007ab20: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-0007ab30: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f4d   = 0; j < GGML_M
-0007ab40: 4158 5f4f 5054 3b20 2b2b 6a29 207b 0a20  AX_OPT; ++j) {. 
-0007ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ab60: 2020 2020 2020 2061 7267 735b 3220 2b20         args[2 + 
-0007ab70: 6a5d 203d 2026 7465 6e73 6f72 2d3e 6f70  j] = &tensor->op
-0007ab80: 745b 6a5d 3b0a 2020 2020 2020 2020 2020  t[j];.          
-0007ab90: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0007aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007abb0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-0007abc0: 206a 203c 2032 202b 2047 474d 4c5f 4d41   j < 2 + GGML_MA
-0007abd0: 585f 4f50 543b 202b 2b6a 2920 7b0a 2020  X_OPT; ++j) {.  
-0007abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007abf0: 2020 2020 2020 636f 6e73 7420 696e 7433        const int3
-0007ac00: 325f 7420 6172 675f 6964 7820 3d20 2a28  2_t arg_idx = *(
-0007ac10: 636f 6e73 7420 696e 7433 325f 7420 2a29  const int32_t *)
-0007ac20: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
-0007ac30: 656f 6628 6172 675f 6964 7829 3b0a 0a20  eof(arg_idx);.. 
-0007ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ac50: 2020 2020 2020 2069 6620 2861 7267 5f69         if (arg_i
-0007ac60: 6478 203d 3d20 2d31 2920 7b0a 2020 2020  dx == -1) {.    
-0007ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ac80: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0007ac90: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007aca0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0007acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007acc0: 2020 2020 2069 6620 2861 7267 5f69 6478       if (arg_idx
-0007acd0: 203c 2047 474d 4c5f 4d41 585f 4e4f 4445   < GGML_MAX_NODE
-0007ace0: 5329 207b 0a20 2020 2020 2020 2020 2020  S) {.           
+000792b0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+000792c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000792d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000792e0: 7374 2069 6e74 3332 5f74 206e 756c 203d  st int32_t nul =
+000792f0: 202d 313b 0a0a 2020 2020 2020 2020 2020   -1;..          
+00079300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079310: 2020 6677 7269 7465 2826 6e75 6c2c 2073    fwrite(&nul, s
+00079320: 697a 656f 6628 696e 7433 325f 7429 2c20  izeof(int32_t), 
+00079330: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
+00079340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079350: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00079360: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00079370: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00079380: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00079390: 2020 7d0a 0a20 2020 2020 2020 2066 636c    }..        fcl
+000793a0: 6f73 6528 666f 7574 293b 0a20 2020 207d  ose(fout);.    }
+000793b0: 0a7d 0a0a 7374 7275 6374 2067 676d 6c5f  .}..struct ggml_
+000793c0: 6367 7261 7068 2067 676d 6c5f 6772 6170  cgraph ggml_grap
+000793d0: 685f 696d 706f 7274 2863 6f6e 7374 2063  h_import(const c
+000793e0: 6861 7220 2a20 666e 616d 652c 2073 7472  har * fname, str
+000793f0: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00079400: 202a 2a20 6374 785f 6461 7461 2c20 7374   ** ctx_data, st
+00079410: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
+00079420: 7420 2a2a 2063 7478 5f65 7661 6c29 207b  t ** ctx_eval) {
+00079430: 0a20 2020 2061 7373 6572 7428 2a63 7478  .    assert(*ctx
+00079440: 5f64 6174 6120 3d3d 204e 554c 4c29 3b0a  _data == NULL);.
+00079450: 2020 2020 6173 7365 7274 282a 6374 785f      assert(*ctx_
+00079460: 6576 616c 203d 3d20 4e55 4c4c 293b 0a0a  eval == NULL);..
+00079470: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00079480: 6367 7261 7068 2072 6573 756c 7420 3d20  cgraph result = 
+00079490: 7b20 3020 7d3b 0a0a 2020 2020 7374 7275  { 0 };..    stru
+000794a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000794b0: 2064 6174 6120 3d20 4e55 4c4c 3b0a 0a20   data = NULL;.. 
+000794c0: 2020 202f 2f20 7265 6164 2066 696c 6520     // read file 
+000794d0: 696e 746f 2064 6174 610a 2020 2020 7b0a  into data.    {.
+000794e0: 2020 2020 2020 2020 4649 4c45 202a 2066          FILE * f
+000794f0: 696e 203d 2066 6f70 656e 2866 6e61 6d65  in = fopen(fname
+00079500: 2c20 2272 6222 293b 0a0a 2020 2020 2020  , "rb");..      
+00079510: 2020 6966 2028 2166 696e 2920 7b0a 2020    if (!fin) {.  
+00079520: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+00079530: 6628 7374 6465 7272 2c20 2225 733a 2066  f(stderr, "%s: f
+00079540: 6169 6c65 6420 746f 206f 7065 6e20 2573  ailed to open %s
+00079550: 5c6e 222c 205f 5f66 756e 635f 5f2c 2066  \n", __func__, f
+00079560: 6e61 6d65 293b 0a20 2020 2020 2020 2020  name);.         
+00079570: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00079580: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+00079590: 2020 2020 2073 697a 655f 7420 6673 697a       size_t fsiz
+000795a0: 6520 3d20 303b 0a0a 2020 2020 2020 2020  e = 0;..        
+000795b0: 6673 6565 6b28 6669 6e2c 2030 2c20 5345  fseek(fin, 0, SE
+000795c0: 454b 5f45 4e44 293b 0a20 2020 2020 2020  EK_END);.       
+000795d0: 2066 7369 7a65 203d 2066 7465 6c6c 2866   fsize = ftell(f
+000795e0: 696e 293b 0a20 2020 2020 2020 2066 7365  in);.        fse
+000795f0: 656b 2866 696e 2c20 302c 2053 4545 4b5f  ek(fin, 0, SEEK_
+00079600: 5345 5429 3b0a 0a20 2020 2020 2020 202f  SET);..        /
+00079610: 2f20 6372 6561 7465 2074 6865 2064 6174  / create the dat
+00079620: 6120 636f 6e74 6578 740a 2020 2020 2020  a context.      
+00079630: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00079640: 636f 6e73 7420 7369 7a65 5f74 206f 7665  const size_t ove
+00079650: 7268 6561 6420 3d20 312a 6767 6d6c 5f74  rhead = 1*ggml_t
+00079660: 656e 736f 725f 6f76 6572 6865 6164 2829  ensor_overhead()
+00079670: 3b0a 0a20 2020 2020 2020 2020 2020 2073  ;..            s
+00079680: 7472 7563 7420 6767 6d6c 5f69 6e69 745f  truct ggml_init_
+00079690: 7061 7261 6d73 2070 6172 616d 7320 3d20  params params = 
+000796a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000796b0: 2020 2e6d 656d 5f73 697a 6520 2020 3d20    .mem_size   = 
+000796c0: 6673 697a 6520 2b20 6f76 6572 6865 6164  fsize + overhead
+000796d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000796e0: 2020 2e6d 656d 5f62 7566 6665 7220 3d20    .mem_buffer = 
+000796f0: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
+00079700: 2020 2020 2020 2e6e 6f5f 616c 6c6f 6320        .no_alloc 
+00079710: 2020 3d20 6661 6c73 652c 0a20 2020 2020    = false,.     
+00079720: 2020 2020 2020 207d 3b0a 0a20 2020 2020         };..     
+00079730: 2020 2020 2020 202a 6374 785f 6461 7461         *ctx_data
+00079740: 203d 2067 676d 6c5f 696e 6974 2870 6172   = ggml_init(par
+00079750: 616d 7329 3b0a 0a20 2020 2020 2020 2020  ams);..         
+00079760: 2020 2069 6620 2821 2a63 7478 5f64 6174     if (!*ctx_dat
+00079770: 6129 207b 0a20 2020 2020 2020 2020 2020  a) {.           
+00079780: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
+00079790: 6572 722c 2022 2573 3a20 6661 696c 6564  err, "%s: failed
+000797a0: 2074 6f20 6372 6561 7465 2067 676d 6c20   to create ggml 
+000797b0: 636f 6e74 6578 745c 6e22 2c20 5f5f 6675  context\n", __fu
+000797c0: 6e63 5f5f 293b 0a20 2020 2020 2020 2020  nc__);.         
+000797d0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+000797e0: 7375 6c74 3b0a 2020 2020 2020 2020 2020  sult;.          
+000797f0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+00079800: 2020 2020 2020 2064 6174 6120 3d20 6767         data = gg
+00079810: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+00079820: 282a 6374 785f 6461 7461 2c20 4747 4d4c  (*ctx_data, GGML
+00079830: 5f54 5950 455f 4938 2c20 6673 697a 6529  _TYPE_I8, fsize)
+00079840: 3b0a 0a20 2020 2020 2020 207b 0a20 2020  ;..        {.   
+00079850: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
+00079860: 697a 655f 7420 7265 7420 3d20 6672 6561  ize_t ret = frea
+00079870: 6428 6461 7461 2d3e 6461 7461 2c20 7369  d(data->data, si
+00079880: 7a65 6f66 2863 6861 7229 2c20 6673 697a  zeof(char), fsiz
+00079890: 652c 2066 696e 293b 0a20 2020 2020 2020  e, fin);.       
+000798a0: 2020 2020 2069 6620 2872 6574 2021 3d20       if (ret != 
+000798b0: 6673 697a 6529 207b 0a20 2020 2020 2020  fsize) {.       
+000798c0: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
+000798d0: 2873 7464 6572 722c 2022 2573 3a20 6661  (stderr, "%s: fa
+000798e0: 696c 6564 2074 6f20 7265 6164 2025 735c  iled to read %s\
+000798f0: 6e22 2c20 5f5f 6675 6e63 5f5f 2c20 666e  n", __func__, fn
+00079900: 616d 6529 3b0a 2020 2020 2020 2020 2020  ame);.          
+00079910: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00079920: 756c 743b 0a20 2020 2020 2020 2020 2020  ult;.           
+00079930: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+00079940: 2020 2020 2020 6663 6c6f 7365 2866 696e        fclose(fin
+00079950: 293b 0a20 2020 207d 0a0a 2020 2020 2f2f  );.    }..    //
+00079960: 2070 6f70 756c 6174 6520 7265 7375 6c74   populate result
+00079970: 0a20 2020 207b 0a20 2020 2020 2020 2063  .    {.        c
+00079980: 6861 7220 2a20 7074 7220 3d20 2863 6861  har * ptr = (cha
+00079990: 7220 2a29 2064 6174 612d 3e64 6174 613b  r *) data->data;
+000799a0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+000799b0: 7569 6e74 3332 5f74 206d 6167 6963 203d  uint32_t magic =
+000799c0: 202a 2863 6f6e 7374 2075 696e 7433 325f   *(const uint32_
+000799d0: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
+000799e0: 2073 697a 656f 6628 6d61 6769 6329 3b0a   sizeof(magic);.
+000799f0: 0a20 2020 2020 2020 2069 6620 286d 6167  .        if (mag
+00079a00: 6963 2021 3d20 4747 4d4c 5f46 494c 455f  ic != GGML_FILE_
+00079a10: 4d41 4749 4329 207b 0a20 2020 2020 2020  MAGIC) {.       
+00079a20: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
+00079a30: 6572 722c 2022 2573 3a20 696e 7661 6c69  err, "%s: invali
+00079a40: 6420 6d61 6769 6320 6e75 6d62 6572 2c20  d magic number, 
+00079a50: 676f 7420 2530 3878 5c6e 222c 205f 5f66  got %08x\n", __f
+00079a60: 756e 635f 5f2c 206d 6167 6963 293b 0a20  unc__, magic);. 
+00079a70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00079a80: 6e20 7265 7375 6c74 3b0a 2020 2020 2020  n result;.      
+00079a90: 2020 7d0a 0a20 2020 2020 2020 2063 6f6e    }..        con
+00079aa0: 7374 2075 696e 7433 325f 7420 7665 7273  st uint32_t vers
+00079ab0: 696f 6e20 3d20 2a28 636f 6e73 7420 7569  ion = *(const ui
+00079ac0: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
+00079ad0: 7472 202b 3d20 7369 7a65 6f66 2876 6572  tr += sizeof(ver
+00079ae0: 7369 6f6e 293b 0a0a 2020 2020 2020 2020  sion);..        
+00079af0: 6966 2028 7665 7273 696f 6e20 213d 2047  if (version != G
+00079b00: 474d 4c5f 4649 4c45 5f56 4552 5349 4f4e  GML_FILE_VERSION
+00079b10: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00079b20: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
+00079b30: 2225 733a 2069 6e76 616c 6964 2076 6572  "%s: invalid ver
+00079b40: 7369 6f6e 206e 756d 6265 725c 6e22 2c20  sion number\n", 
+00079b50: 5f5f 6675 6e63 5f5f 293b 0a20 2020 2020  __func__);.     
+00079b60: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00079b70: 7375 6c74 3b0a 2020 2020 2020 2020 7d0a  sult;.        }.
+00079b80: 0a20 2020 2020 2020 2063 6f6e 7374 2075  .        const u
+00079b90: 696e 7433 325f 7420 6e5f 6c65 6166 7320  int32_t n_leafs 
+00079ba0: 2020 3d20 2a28 636f 6e73 7420 7569 6e74    = *(const uint
+00079bb0: 3332 5f74 202a 2920 7074 723b 2070 7472  32_t *) ptr; ptr
+00079bc0: 202b 3d20 7369 7a65 6f66 286e 5f6c 6561   += sizeof(n_lea
+00079bd0: 6673 293b 0a20 2020 2020 2020 2063 6f6e  fs);.        con
+00079be0: 7374 2075 696e 7433 325f 7420 6e5f 6e6f  st uint32_t n_no
+00079bf0: 6465 7320 2020 3d20 2a28 636f 6e73 7420  des   = *(const 
+00079c00: 7569 6e74 3332 5f74 202a 2920 7074 723b  uint32_t *) ptr;
+00079c10: 2070 7472 202b 3d20 7369 7a65 6f66 286e   ptr += sizeof(n
+00079c20: 5f6e 6f64 6573 293b 0a20 2020 2020 2020  _nodes);.       
+00079c30: 2063 6f6e 7374 2075 696e 7436 345f 7420   const uint64_t 
+00079c40: 7369 7a65 5f65 7661 6c20 3d20 2a28 636f  size_eval = *(co
+00079c50: 6e73 7420 7569 6e74 3634 5f74 202a 2920  nst uint64_t *) 
+00079c60: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
+00079c70: 6f66 2873 697a 655f 6576 616c 293b 0a0a  of(size_eval);..
+00079c80: 2020 2020 2020 2020 7265 7375 6c74 2e6e          result.n
+00079c90: 5f6c 6561 6673 203d 206e 5f6c 6561 6673  _leafs = n_leafs
+00079ca0: 3b0a 2020 2020 2020 2020 7265 7375 6c74  ;.        result
+00079cb0: 2e6e 5f6e 6f64 6573 203d 206e 5f6e 6f64  .n_nodes = n_nod
+00079cc0: 6573 3b0a 0a20 2020 2020 2020 202f 2f20  es;..        // 
+00079cd0: 6372 6561 7465 2074 6865 2064 6174 6120  create the data 
+00079ce0: 636f 6e74 6578 740a 2020 2020 2020 2020  context.        
+00079cf0: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
+00079d00: 6e73 7420 7369 7a65 5f74 206f 7665 7268  nst size_t overh
+00079d10: 6561 6420 3d20 286e 5f6c 6561 6673 202b  ead = (n_leafs +
+00079d20: 206e 5f6e 6f64 6573 292a 6767 6d6c 5f74   n_nodes)*ggml_t
+00079d30: 656e 736f 725f 6f76 6572 6865 6164 2829  ensor_overhead()
+00079d40: 3b0a 0a20 2020 2020 2020 2020 2020 2073  ;..            s
+00079d50: 7472 7563 7420 6767 6d6c 5f69 6e69 745f  truct ggml_init_
+00079d60: 7061 7261 6d73 2070 6172 616d 7320 3d20  params params = 
+00079d70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00079d80: 2020 2e6d 656d 5f73 697a 6520 2020 3d20    .mem_size   = 
+00079d90: 7369 7a65 5f65 7661 6c20 2b20 6f76 6572  size_eval + over
+00079da0: 6865 6164 2c0a 2020 2020 2020 2020 2020  head,.          
+00079db0: 2020 2020 2020 2e6d 656d 5f62 7566 6665        .mem_buffe
+00079dc0: 7220 3d20 4e55 4c4c 2c0a 2020 2020 2020  r = NULL,.      
+00079dd0: 2020 2020 2020 2020 2020 2e6e 6f5f 616c            .no_al
+00079de0: 6c6f 6320 2020 3d20 7472 7565 2c0a 2020  loc   = true,.  
+00079df0: 2020 2020 2020 2020 2020 7d3b 0a0a 2020            };..  
+00079e00: 2020 2020 2020 2020 2020 2a63 7478 5f65            *ctx_e
+00079e10: 7661 6c20 3d20 6767 6d6c 5f69 6e69 7428  val = ggml_init(
+00079e20: 7061 7261 6d73 293b 0a0a 2020 2020 2020  params);..      
+00079e30: 2020 2020 2020 6966 2028 212a 6374 785f        if (!*ctx_
+00079e40: 6576 616c 2920 7b0a 2020 2020 2020 2020  eval) {.        
+00079e50: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+00079e60: 7374 6465 7272 2c20 2225 733a 2066 6169  stderr, "%s: fai
+00079e70: 6c65 6420 746f 2063 7265 6174 6520 6767  led to create gg
+00079e80: 6d6c 2063 6f6e 7465 7874 5c6e 222c 205f  ml context\n", _
+00079e90: 5f66 756e 635f 5f29 3b0a 2020 2020 2020  _func__);.      
+00079ea0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00079eb0: 2072 6573 756c 743b 0a20 2020 2020 2020   result;.       
+00079ec0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00079ed0: 0a0a 2020 2020 2020 2020 2f2f 206c 6561  ..        // lea
+00079ee0: 6673 0a20 2020 2020 2020 207b 0a20 2020  fs.        {.   
+00079ef0: 2020 2020 2020 2020 2075 696e 7433 325f           uint32_
+00079f00: 7420 7479 7065 3b0a 2020 2020 2020 2020  t type;.        
+00079f10: 2020 2020 7569 6e74 3332 5f74 206f 703b      uint32_t op;
+00079f20: 0a20 2020 2020 2020 2020 2020 2075 696e  .            uin
+00079f30: 7433 325f 7420 6e5f 6469 6d73 3b0a 0a20  t32_t n_dims;.. 
+00079f40: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00079f50: 7569 6e74 3332 5f74 2069 203d 2030 3b20  uint32_t i = 0; 
+00079f60: 6920 3c20 6e5f 6c65 6166 733b 202b 2b69  i < n_leafs; ++i
+00079f70: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00079f80: 2020 2020 7479 7065 2020 203d 202a 2863      type   = *(c
+00079f90: 6f6e 7374 2075 696e 7433 325f 7420 2a29  onst uint32_t *)
+00079fa0: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
+00079fb0: 656f 6628 7479 7065 293b 0a20 2020 2020  eof(type);.     
+00079fc0: 2020 2020 2020 2020 2020 206f 7020 2020             op   
+00079fd0: 2020 3d20 2a28 636f 6e73 7420 7569 6e74    = *(const uint
+00079fe0: 3332 5f74 202a 2920 7074 723b 2070 7472  32_t *) ptr; ptr
+00079ff0: 202b 3d20 7369 7a65 6f66 286f 7029 3b0a   += sizeof(op);.
+0007a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a010: 6e5f 6469 6d73 203d 202a 2863 6f6e 7374  n_dims = *(const
+0007a020: 2075 696e 7433 325f 7420 2a29 2070 7472   uint32_t *) ptr
+0007a030: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
+0007a040: 6e5f 6469 6d73 293b 0a0a 2020 2020 2020  n_dims);..      
+0007a050: 2020 2020 2020 2020 2020 696e 7436 345f            int64_
+0007a060: 7420 6e65 5b47 474d 4c5f 4d41 585f 4449  t ne[GGML_MAX_DI
+0007a070: 4d53 5d3b 0a20 2020 2020 2020 2020 2020  MS];.           
+0007a080: 2020 2020 2073 697a 655f 7420 206e 625b       size_t  nb[
+0007a090: 4747 4d4c 5f4d 4158 5f44 494d 535d 3b0a  GGML_MAX_DIMS];.
+0007a0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a0b0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+0007a0c0: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
+0007a0d0: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
+0007a0e0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0007a0f0: 696e 7436 345f 7420 6e65 5f63 7572 3b0a  int64_t ne_cur;.
+0007a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a110: 2020 2020 7569 6e74 3634 5f74 206e 625f      uint64_t nb_
+0007a120: 6375 723b 0a0a 2020 2020 2020 2020 2020  cur;..          
+0007a130: 2020 2020 2020 2020 2020 6e65 5f63 7572            ne_cur
+0007a140: 203d 202a 2863 6f6e 7374 2075 696e 7436   = *(const uint6
+0007a150: 345f 7420 2a29 2070 7472 3b20 7074 7220  4_t *) ptr; ptr 
+0007a160: 2b3d 2073 697a 656f 6628 6e65 5f63 7572  += sizeof(ne_cur
+0007a170: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007a180: 2020 2020 2020 206e 625f 6375 7220 3d20         nb_cur = 
+0007a190: 2a28 636f 6e73 7420 7569 6e74 3634 5f74  *(const uint64_t
+0007a1a0: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
+0007a1b0: 7369 7a65 6f66 286e 625f 6375 7229 3b0a  sizeof(nb_cur);.
+0007a1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a1d0: 2020 2020 206e 655b 6a5d 203d 206e 655f       ne[j] = ne_
+0007a1e0: 6375 723b 0a20 2020 2020 2020 2020 2020  cur;.           
+0007a1f0: 2020 2020 2020 2020 206e 625b 6a5d 203d           nb[j] =
+0007a200: 206e 625f 6375 723b 0a20 2020 2020 2020   nb_cur;.       
+0007a210: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0007a220: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+0007a230: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0007a240: 2074 656e 736f 7220 3d20 6767 6d6c 5f6e   tensor = ggml_n
+0007a250: 6577 5f74 656e 736f 7228 2a63 7478 5f65  ew_tensor(*ctx_e
+0007a260: 7661 6c2c 2028 656e 756d 2067 676d 6c5f  val, (enum ggml_
+0007a270: 7479 7065 2920 7479 7065 2c20 6e5f 6469  type) type, n_di
+0007a280: 6d73 2c20 6e65 293b 0a0a 2020 2020 2020  ms, ne);..      
+0007a290: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+0007a2a0: 2d3e 6f70 203d 2028 656e 756d 2067 676d  ->op = (enum ggm
+0007a2b0: 6c5f 6f70 2920 6f70 3b0a 0a20 2020 2020  l_op) op;..     
+0007a2c0: 2020 2020 2020 2020 2020 2075 696e 7436             uint6
+0007a2d0: 345f 7420 7074 725f 6375 7220 3d20 2a28  4_t ptr_cur = *(
+0007a2e0: 636f 6e73 7420 7569 6e74 3634 5f74 202a  const uint64_t *
+0007a2f0: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
+0007a300: 7a65 6f66 2870 7472 5f63 7572 293b 0a0a  zeof(ptr_cur);..
+0007a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a320: 6d65 6d63 7079 2874 656e 736f 722d 3e6e  memcpy(tensor->n
+0007a330: 616d 652c 2070 7472 2c20 4747 4d4c 5f4d  ame, ptr, GGML_M
+0007a340: 4158 5f4e 414d 4529 3b20 7074 7220 2b3d  AX_NAME); ptr +=
+0007a350: 2047 474d 4c5f 4d41 585f 4e41 4d45 3b0a   GGML_MAX_NAME;.
+0007a360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a370: 2074 656e 736f 722d 3e64 6174 6120 3d20   tensor->data = 
+0007a380: 2876 6f69 6420 2a29 2070 7472 3b0a 0a20  (void *) ptr;.. 
+0007a390: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0007a3a0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+0007a3b0: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
+0007a3c0: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
+0007a3d0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0007a3e0: 736f 722d 3e6e 625b 6a5d 203d 206e 625b  sor->nb[j] = nb[
+0007a3f0: 6a5d 3b0a 2020 2020 2020 2020 2020 2020  j];.            
+0007a400: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0007a410: 2020 2020 2020 2072 6573 756c 742e 6c65         result.le
+0007a420: 6166 735b 695d 203d 2074 656e 736f 723b  afs[i] = tensor;
+0007a430: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0007a440: 2020 7074 7220 2b3d 2067 676d 6c5f 6e62    ptr += ggml_nb
+0007a450: 7974 6573 2874 656e 736f 7229 3b0a 0a20  ytes(tensor);.. 
+0007a460: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0007a470: 7072 696e 7466 2873 7464 6572 722c 2022  printf(stderr, "
+0007a480: 2573 3a20 6c6f 6164 6564 206c 6561 6620  %s: loaded leaf 
+0007a490: 2564 3a20 2725 3136 7327 2c20 2533 6420  %d: '%16s', %3d 
+0007a4a0: 6469 6d73 2c20 2539 7a75 2062 7974 6573  dims, %9zu bytes
+0007a4b0: 5c6e 222c 205f 5f66 756e 635f 5f2c 2069  \n", __func__, i
+0007a4c0: 2c20 7465 6e73 6f72 2d3e 6e61 6d65 2c20  , tensor->name, 
+0007a4d0: 6e5f 6469 6d73 2c20 6767 6d6c 5f6e 6279  n_dims, ggml_nby
+0007a4e0: 7465 7328 7465 6e73 6f72 2929 3b0a 2020  tes(tensor));.  
+0007a4f0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0007a500: 2020 2020 7d0a 0a20 2020 2020 2020 2067      }..        g
+0007a510: 676d 6c5f 7365 745f 6e6f 5f61 6c6c 6f63  gml_set_no_alloc
+0007a520: 282a 6374 785f 6576 616c 2c20 6661 6c73  (*ctx_eval, fals
+0007a530: 6529 3b0a 0a20 2020 2020 2020 202f 2f20  e);..        // 
+0007a540: 6e6f 6465 730a 2020 2020 2020 2020 7b0a  nodes.        {.
+0007a550: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
+0007a560: 3332 5f74 2074 7970 653b 0a20 2020 2020  32_t type;.     
+0007a570: 2020 2020 2020 2075 696e 7433 325f 7420         uint32_t 
+0007a580: 6f70 3b0a 2020 2020 2020 2020 2020 2020  op;.            
+0007a590: 7569 6e74 3332 5f74 206e 5f64 696d 733b  uint32_t n_dims;
+0007a5a0: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0007a5b0: 7220 2875 696e 7433 325f 7420 6920 3d20  r (uint32_t i = 
+0007a5c0: 303b 2069 203c 206e 5f6e 6f64 6573 3b20  0; i < n_nodes; 
+0007a5d0: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
+0007a5e0: 2020 2020 2020 2074 7970 6520 2020 3d20         type   = 
+0007a5f0: 2a28 636f 6e73 7420 7569 6e74 3332 5f74  *(const uint32_t
+0007a600: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
+0007a610: 7369 7a65 6f66 2874 7970 6529 3b0a 2020  sizeof(type);.  
+0007a620: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0007a630: 2020 2020 203d 202a 2863 6f6e 7374 2075       = *(const u
+0007a640: 696e 7433 325f 7420 2a29 2070 7472 3b20  int32_t *) ptr; 
+0007a650: 7074 7220 2b3d 2073 697a 656f 6628 6f70  ptr += sizeof(op
+0007a660: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007a670: 2020 206e 5f64 696d 7320 3d20 2a28 636f     n_dims = *(co
+0007a680: 6e73 7420 7569 6e74 3332 5f74 202a 2920  nst uint32_t *) 
+0007a690: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
+0007a6a0: 6f66 286e 5f64 696d 7329 3b0a 0a20 2020  of(n_dims);..   
+0007a6b0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0007a6c0: 3634 5f74 206e 655b 4747 4d4c 5f4d 4158  64_t ne[GGML_MAX
+0007a6d0: 5f44 494d 535d 3b0a 2020 2020 2020 2020  _DIMS];.        
+0007a6e0: 2020 2020 2020 2020 7369 7a65 5f74 2020          size_t  
+0007a6f0: 6e62 5b47 474d 4c5f 4d41 585f 4449 4d53  nb[GGML_MAX_DIMS
+0007a700: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
+0007a710: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+0007a720: 2030 3b20 6a20 3c20 4747 4d4c 5f4d 4158   0; j < GGML_MAX
+0007a730: 5f44 494d 533b 202b 2b6a 2920 7b0a 2020  _DIMS; ++j) {.  
+0007a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a750: 2020 7569 6e74 3634 5f74 206e 655f 6375    uint64_t ne_cu
+0007a760: 723b 0a20 2020 2020 2020 2020 2020 2020  r;.             
+0007a770: 2020 2020 2020 2075 696e 7436 345f 7420         uint64_t 
+0007a780: 6e62 5f63 7572 3b0a 0a20 2020 2020 2020  nb_cur;..       
+0007a790: 2020 2020 2020 2020 2020 2020 206e 655f               ne_
+0007a7a0: 6375 7220 3d20 2a28 636f 6e73 7420 7569  cur = *(const ui
+0007a7b0: 6e74 3634 5f74 202a 2920 7074 723b 2070  nt64_t *) ptr; p
+0007a7c0: 7472 202b 3d20 7369 7a65 6f66 286e 655f  tr += sizeof(ne_
+0007a7d0: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
+0007a7e0: 2020 2020 2020 2020 2020 6e62 5f63 7572            nb_cur
+0007a7f0: 203d 202a 2863 6f6e 7374 2075 696e 7436   = *(const uint6
+0007a800: 345f 7420 2a29 2070 7472 3b20 7074 7220  4_t *) ptr; ptr 
+0007a810: 2b3d 2073 697a 656f 6628 6e62 5f63 7572  += sizeof(nb_cur
+0007a820: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0007a830: 2020 2020 2020 2020 6e65 5b6a 5d20 3d20          ne[j] = 
+0007a840: 6e65 5f63 7572 3b0a 2020 2020 2020 2020  ne_cur;.        
+0007a850: 2020 2020 2020 2020 2020 2020 6e62 5b6a              nb[j
+0007a860: 5d20 3d20 6e62 5f63 7572 3b0a 2020 2020  ] = nb_cur;.    
+0007a870: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0007a880: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007a890: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0007a8a0: 7220 2a20 7465 6e73 6f72 203d 2067 676d  r * tensor = ggm
+0007a8b0: 6c5f 6e65 775f 7465 6e73 6f72 282a 6374  l_new_tensor(*ct
+0007a8c0: 785f 6576 616c 2c20 2865 6e75 6d20 6767  x_eval, (enum gg
+0007a8d0: 6d6c 5f74 7970 6529 2074 7970 652c 206e  ml_type) type, n
+0007a8e0: 5f64 696d 732c 206e 6529 3b0a 0a20 2020  _dims, ne);..   
+0007a8f0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0007a900: 736f 722d 3e6f 7020 3d20 2865 6e75 6d20  sor->op = (enum 
+0007a910: 6767 6d6c 5f6f 7029 206f 703b 0a0a 2020  ggml_op) op;..  
+0007a920: 2020 2020 2020 2020 2020 2020 2020 7569                ui
+0007a930: 6e74 3634 5f74 2070 7472 5f63 7572 203d  nt64_t ptr_cur =
+0007a940: 202a 2863 6f6e 7374 2075 696e 7436 345f   *(const uint64_
+0007a950: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
+0007a960: 2073 697a 656f 6628 7074 725f 6375 7229   sizeof(ptr_cur)
+0007a970: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0007a980: 2020 206d 656d 6370 7928 7465 6e73 6f72     memcpy(tensor
+0007a990: 2d3e 6e61 6d65 2c20 7074 722c 2047 474d  ->name, ptr, GGM
+0007a9a0: 4c5f 4d41 585f 4e41 4d45 293b 2070 7472  L_MAX_NAME); ptr
+0007a9b0: 202b 3d20 4747 4d4c 5f4d 4158 5f4e 414d   += GGML_MAX_NAM
+0007a9c0: 453b 0a0a 2020 2020 2020 2020 2020 2020  E;..            
+0007a9d0: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+0007a9e0: 2030 3b20 6a20 3c20 4747 4d4c 5f4d 4158   0; j < GGML_MAX
+0007a9f0: 5f44 494d 533b 202b 2b6a 2920 7b0a 2020  _DIMS; ++j) {.  
+0007aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007aa10: 2020 7465 6e73 6f72 2d3e 6e62 5b6a 5d20    tensor->nb[j] 
+0007aa20: 3d20 6e62 5b6a 5d3b 0a20 2020 2020 2020  = nb[j];.       
+0007aa30: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+0007aa40: 2020 2020 2020 2020 2020 2020 2f2f 2070              // p
+0007aa50: 6172 7365 2061 7267 730a 2020 2020 2020  arse args.      
+0007aa60: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007aa80: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007aa90: 6f72 202a 2a20 6172 6773 5b32 202b 2047  or ** args[2 + G
+0007aaa0: 474d 4c5f 4d41 585f 4f50 545d 203d 207b  GML_MAX_OPT] = {
+0007aab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007aac0: 2020 2020 2020 2020 2026 7465 6e73 6f72           &tensor
+0007aad0: 2d3e 7372 6330 2c0a 2020 2020 2020 2020  ->src0,.        
+0007aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007aaf0: 2674 656e 736f 722d 3e73 7263 312c 0a20  &tensor->src1,. 
+0007ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ab10: 2020 207d 3b0a 0a20 2020 2020 2020 2020     };..         
+0007ab20: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0007ab30: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
+0007ab40: 474d 4c5f 4d41 585f 4f50 543b 202b 2b6a  GML_MAX_OPT; ++j
+0007ab50: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007ab60: 2020 2020 2020 2020 2020 2020 6172 6773              args
+0007ab70: 5b32 202b 206a 5d20 3d20 2674 656e 736f  [2 + j] = &tenso
+0007ab80: 722d 3e6f 7074 5b6a 5d3b 0a20 2020 2020  r->opt[j];.     
+0007ab90: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007aba0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0007abb0: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+0007abc0: 203d 2030 3b20 6a20 3c20 3220 2b20 4747   = 0; j < 2 + GG
+0007abd0: 4d4c 5f4d 4158 5f4f 5054 3b20 2b2b 6a29  ML_MAX_OPT; ++j)
+0007abe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007abf0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0007ac00: 2069 6e74 3332 5f74 2061 7267 5f69 6478   int32_t arg_idx
+0007ac10: 203d 202a 2863 6f6e 7374 2069 6e74 3332   = *(const int32
+0007ac20: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
+0007ac30: 3d20 7369 7a65 6f66 2861 7267 5f69 6478  = sizeof(arg_idx
+0007ac40: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0007ac50: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0007ac60: 6172 675f 6964 7820 3d3d 202d 3129 207b  arg_idx == -1) {
+0007ac70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ac80: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0007ac90: 7469 6e75 653b 0a20 2020 2020 2020 2020  tinue;.         
+0007aca0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007acb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0007acc0: 2020 2020 2020 2020 2020 6966 2028 6172            if (ar
+0007acd0: 675f 6964 7820 3c20 4747 4d4c 5f4d 4158  g_idx < GGML_MAX
+0007ace0: 5f4e 4f44 4553 2920 7b0a 2020 2020 2020  _NODES) {.      
 0007acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ad00: 202a 6172 6773 5b6a 5d20 3d20 7265 7375   *args[j] = resu
-0007ad10: 6c74 2e6c 6561 6673 5b61 7267 5f69 6478  lt.leafs[arg_idx
-0007ad20: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0007ad30: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-0007ad40: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+0007ad00: 2020 2020 2020 2a61 7267 735b 6a5d 203d        *args[j] =
+0007ad10: 2072 6573 756c 742e 6c65 6166 735b 6172   result.leafs[ar
+0007ad20: 675f 6964 785d 3b0a 2020 2020 2020 2020  g_idx];.        
+0007ad30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ad40: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
 0007ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ad60: 2a61 7267 735b 6a5d 203d 2072 6573 756c  *args[j] = resul
-0007ad70: 742e 6e6f 6465 735b 6172 675f 6964 7820  t.nodes[arg_idx 
-0007ad80: 2d20 4747 4d4c 5f4d 4158 5f4e 4f44 4553  - GGML_MAX_NODES
-0007ad90: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0007ada0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0007adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007adc0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-0007add0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0007ade0: 2020 2020 2020 7265 7375 6c74 2e6e 6f64        result.nod
-0007adf0: 6573 5b69 5d20 3d20 7465 6e73 6f72 3b0a  es[i] = tensor;.
-0007ae00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ae10: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
-0007ae20: 2022 2573 3a20 6c6f 6164 6564 206e 6f64   "%s: loaded nod
-0007ae30: 6520 2564 3a20 2725 3136 7327 2c20 2533  e %d: '%16s', %3
-0007ae40: 6420 6469 6d73 2c20 2539 7a75 2062 7974  d dims, %9zu byt
-0007ae50: 6573 5c6e 222c 205f 5f66 756e 635f 5f2c  es\n", __func__,
-0007ae60: 2069 2c20 7465 6e73 6f72 2d3e 6e61 6d65   i, tensor->name
-0007ae70: 2c20 6e5f 6469 6d73 2c20 6767 6d6c 5f6e  , n_dims, ggml_n
-0007ae80: 6279 7465 7328 7465 6e73 6f72 2929 3b0a  bytes(tensor));.
-0007ae90: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007aea0: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-0007aeb0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-0007aec0: 3b0a 7d0a 0a76 6f69 6420 6767 6d6c 5f67  ;.}..void ggml_g
-0007aed0: 7261 7068 5f70 7269 6e74 2863 6f6e 7374  raph_print(const
-0007aee0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-0007aef0: 6170 6820 2a20 6367 7261 7068 2920 7b0a  aph * cgraph) {.
-0007af00: 2020 2020 696e 7436 345f 7420 7065 7266      int64_t perf
-0007af10: 5f74 6f74 616c 5f70 6572 5f6f 705f 7573  _total_per_op_us
-0007af20: 5b47 474d 4c5f 4f50 5f43 4f55 4e54 5d20  [GGML_OP_COUNT] 
-0007af30: 3d20 7b30 7d3b 0a0a 2020 2020 4747 4d4c  = {0};..    GGML
-0007af40: 5f50 5249 4e54 2822 3d3d 3d20 4752 4150  _PRINT("=== GRAP
-0007af50: 4820 3d3d 3d5c 6e22 293b 0a0a 2020 2020  H ===\n");..    
-0007af60: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
-0007af70: 2822 6e5f 7468 7265 6164 7320 2020 2020  ("n_threads     
-0007af80: 2020 3d20 2564 5c6e 222c 2020 2020 2020    = %d\n",      
-0007af90: 2020 6367 7261 7068 2d3e 6e5f 7468 7265    cgraph->n_thre
-0007afa0: 6164 7329 3b0a 2020 2020 4747 4d4c 5f50  ads);.    GGML_P
-0007afb0: 5249 4e54 5f44 4542 5547 2822 746f 7461  RINT_DEBUG("tota
-0007afc0: 6c20 776f 726b 2073 697a 6520 3d20 257a  l work size = %z
-0007afd0: 7520 6279 7465 735c 6e22 2c20 6367 7261  u bytes\n", cgra
-0007afe0: 7068 2d3e 776f 726b 5f73 697a 6529 3b0a  ph->work_size);.
-0007aff0: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
-0007b000: 226e 5f6e 6f64 6573 203d 2025 645c 6e22  "n_nodes = %d\n"
-0007b010: 2c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  , cgraph->n_node
-0007b020: 7329 3b0a 2020 2020 666f 7220 2869 6e74  s);.    for (int
-0007b030: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
-0007b040: 7068 2d3e 6e5f 6e6f 6465 733b 2069 2b2b  ph->n_nodes; i++
-0007b050: 2920 7b0a 2020 2020 2020 2020 7374 7275  ) {.        stru
-0007b060: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0007b070: 206e 6f64 6520 3d20 6367 7261 7068 2d3e   node = cgraph->
-0007b080: 6e6f 6465 735b 695d 3b0a 0a20 2020 2020  nodes[i];..     
-0007b090: 2020 2070 6572 665f 746f 7461 6c5f 7065     perf_total_pe
-0007b0a0: 725f 6f70 5f75 735b 6e6f 6465 2d3e 6f70  r_op_us[node->op
-0007b0b0: 5d20 2b3d 204d 4158 2831 2c20 6e6f 6465  ] += MAX(1, node
-0007b0c0: 2d3e 7065 7266 5f74 696d 655f 7573 293b  ->perf_time_us);
-0007b0d0: 0a0a 2020 2020 2020 2020 4747 4d4c 5f50  ..        GGML_P
-0007b0e0: 5249 4e54 2822 202d 2025 3364 3a20 5b20  RINT(" - %3d: [ 
-0007b0f0: 2535 6a64 2c20 2535 6a64 2c20 2535 6a64  %5jd, %5jd, %5jd
-0007b100: 5d20 2531 3673 2025 7320 2825 3364 2920  ] %16s %s (%3d) 
-0007b110: 6370 7520 3d20 2537 2e33 6620 2f20 2537  cpu = %7.3f / %7
-0007b120: 2e33 6620 6d73 2c20 7761 6c6c 203d 2025  .3f ms, wall = %
-0007b130: 372e 3366 202f 2025 372e 3366 206d 735c  7.3f / %7.3f ms\
-0007b140: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-0007b150: 2020 2020 692c 0a20 2020 2020 2020 2020      i,.         
-0007b160: 2020 2020 2020 206e 6f64 652d 3e6e 655b         node->ne[
-0007b170: 305d 2c20 6e6f 6465 2d3e 6e65 5b31 5d2c  0], node->ne[1],
-0007b180: 206e 6f64 652d 3e6e 655b 325d 2c0a 2020   node->ne[2],.  
-0007b190: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0007b1a0: 4d4c 5f4f 505f 4e41 4d45 5b6e 6f64 652d  ML_OP_NAME[node-
-0007b1b0: 3e6f 705d 2c20 6e6f 6465 2d3e 6973 5f70  >op], node->is_p
-0007b1c0: 6172 616d 203f 2022 7822 203a 206e 6f64  aram ? "x" : nod
-0007b1d0: 652d 3e67 7261 6420 3f20 2267 2220 3a20  e->grad ? "g" : 
-0007b1e0: 2220 222c 206e 6f64 652d 3e70 6572 665f  " ", node->perf_
-0007b1f0: 7275 6e73 2c0a 2020 2020 2020 2020 2020  runs,.          
-0007b200: 2020 2020 2020 2864 6f75 626c 6529 206e        (double) n
-0007b210: 6f64 652d 3e70 6572 665f 6379 636c 6573  ode->perf_cycles
-0007b220: 2020 2f20 2864 6f75 626c 6529 2067 676d    / (double) ggm
-0007b230: 6c5f 6379 636c 6573 5f70 6572 5f6d 7328  l_cycles_per_ms(
-0007b240: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0007b250: 2020 2028 646f 7562 6c65 2920 6e6f 6465     (double) node
-0007b260: 2d3e 7065 7266 5f63 7963 6c65 7320 202f  ->perf_cycles  /
-0007b270: 2028 646f 7562 6c65 2920 6767 6d6c 5f63   (double) ggml_c
-0007b280: 7963 6c65 735f 7065 725f 6d73 2829 202f  ycles_per_ms() /
-0007b290: 2028 646f 7562 6c65 2920 6e6f 6465 2d3e   (double) node->
-0007b2a0: 7065 7266 5f72 756e 732c 0a20 2020 2020  perf_runs,.     
-0007b2b0: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
-0007b2c0: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f74  le) node->perf_t
-0007b2d0: 696d 655f 7573 202f 2031 3030 302e 302c  ime_us / 1000.0,
-0007b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007b2f0: 2028 646f 7562 6c65 2920 6e6f 6465 2d3e   (double) node->
-0007b300: 7065 7266 5f74 696d 655f 7573 202f 2031  perf_time_us / 1
-0007b310: 3030 302e 3020 2f20 6e6f 6465 2d3e 7065  000.0 / node->pe
-0007b320: 7266 5f72 756e 7329 3b0a 2020 2020 7d0a  rf_runs);.    }.
-0007b330: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
-0007b340: 226e 5f6c 6561 6673 203d 2025 645c 6e22  "n_leafs = %d\n"
-0007b350: 2c20 6367 7261 7068 2d3e 6e5f 6c65 6166  , cgraph->n_leaf
-0007b360: 7329 3b0a 2020 2020 666f 7220 2869 6e74  s);.    for (int
-0007b370: 2069 203d 2030 3b20 6920 3c20 6367 7261   i = 0; i < cgra
-0007b380: 7068 2d3e 6e5f 6c65 6166 733b 2069 2b2b  ph->n_leafs; i++
-0007b390: 2920 7b0a 2020 2020 2020 2020 7374 7275  ) {.        stru
-0007b3a0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0007b3b0: 206e 6f64 6520 3d20 6367 7261 7068 2d3e   node = cgraph->
-0007b3c0: 6c65 6166 735b 695d 3b0a 0a20 2020 2020  leafs[i];..     
-0007b3d0: 2020 2047 474d 4c5f 5052 494e 5428 2220     GGML_PRINT(" 
-0007b3e0: 2d20 2533 643a 205b 2025 356a 642c 2025  - %3d: [ %5jd, %
-0007b3f0: 356a 645d 2025 3873 5c6e 222c 0a20 2020  5jd] %8s\n",.   
-0007b400: 2020 2020 2020 2020 2020 2020 2069 2c0a               i,.
-0007b410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b420: 6e6f 6465 2d3e 6e65 5b30 5d2c 206e 6f64  node->ne[0], nod
-0007b430: 652d 3e6e 655b 315d 2c0a 2020 2020 2020  e->ne[1],.      
-0007b440: 2020 2020 2020 2020 2020 4747 4d4c 5f4f            GGML_O
-0007b450: 505f 4e41 4d45 5b6e 6f64 652d 3e6f 705d  P_NAME[node->op]
-0007b460: 293b 0a20 2020 207d 0a0a 2020 2020 666f  );.    }..    fo
-0007b470: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0007b480: 3c20 4747 4d4c 5f4f 505f 434f 554e 543b  < GGML_OP_COUNT;
-0007b490: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-0007b4a0: 6966 2028 7065 7266 5f74 6f74 616c 5f70  if (perf_total_p
-0007b4b0: 6572 5f6f 705f 7573 5b69 5d20 3d3d 2030  er_op_us[i] == 0
-0007b4c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007b4d0: 636f 6e74 696e 7565 3b0a 2020 2020 2020  continue;.      
-0007b4e0: 2020 7d0a 0a20 2020 2020 2020 2047 474d    }..        GGM
-0007b4f0: 4c5f 5052 494e 5428 2270 6572 665f 746f  L_PRINT("perf_to
-0007b500: 7461 6c5f 7065 725f 6f70 5f75 735b 2531  tal_per_op_us[%1
-0007b510: 3673 5d20 3d20 2537 2e33 6620 6d73 5c6e  6s] = %7.3f ms\n
-0007b520: 222c 2047 474d 4c5f 4f50 5f4e 414d 455b  ", GGML_OP_NAME[
-0007b530: 695d 2c20 2864 6f75 626c 6529 2070 6572  i], (double) per
-0007b540: 665f 746f 7461 6c5f 7065 725f 6f70 5f75  f_total_per_op_u
-0007b550: 735b 695d 202f 2031 3030 302e 3029 3b0a  s[i] / 1000.0);.
-0007b560: 2020 2020 7d0a 0a20 2020 2047 474d 4c5f      }..    GGML_
-0007b570: 5052 494e 5428 223d 3d3d 3d3d 3d3d 3d3d  PRINT("=========
+0007ad60: 2020 2020 202a 6172 6773 5b6a 5d20 3d20       *args[j] = 
+0007ad70: 7265 7375 6c74 2e6e 6f64 6573 5b61 7267  result.nodes[arg
+0007ad80: 5f69 6478 202d 2047 474d 4c5f 4d41 585f  _idx - GGML_MAX_
+0007ad90: 4e4f 4445 535d 3b0a 2020 2020 2020 2020  NODES];.        
+0007ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007adb0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0007adc0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007add0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0007ade0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+0007adf0: 742e 6e6f 6465 735b 695d 203d 2074 656e  t.nodes[i] = ten
+0007ae00: 736f 723b 0a0a 2020 2020 2020 2020 2020  sor;..          
+0007ae10: 2020 2020 2020 6670 7269 6e74 6628 7374        fprintf(st
+0007ae20: 6465 7272 2c20 2225 733a 206c 6f61 6465  derr, "%s: loade
+0007ae30: 6420 6e6f 6465 2025 643a 2027 2531 3673  d node %d: '%16s
+0007ae40: 272c 2025 3364 2064 696d 732c 2025 397a  ', %3d dims, %9z
+0007ae50: 7520 6279 7465 735c 6e22 2c20 5f5f 6675  u bytes\n", __fu
+0007ae60: 6e63 5f5f 2c20 692c 2074 656e 736f 722d  nc__, i, tensor-
+0007ae70: 3e6e 616d 652c 206e 5f64 696d 732c 2067  >name, n_dims, g
+0007ae80: 676d 6c5f 6e62 7974 6573 2874 656e 736f  gml_nbytes(tenso
+0007ae90: 7229 293b 0a20 2020 2020 2020 2020 2020  r));.           
+0007aea0: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+0007aeb0: 207d 0a0a 2020 2020 7265 7475 726e 2072   }..    return r
+0007aec0: 6573 756c 743b 0a7d 0a0a 766f 6964 2067  esult;.}..void g
+0007aed0: 676d 6c5f 6772 6170 685f 7072 696e 7428  gml_graph_print(
+0007aee0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0007aef0: 6c5f 6367 7261 7068 202a 2063 6772 6170  l_cgraph * cgrap
+0007af00: 6829 207b 0a20 2020 2069 6e74 3634 5f74  h) {.    int64_t
+0007af10: 2070 6572 665f 746f 7461 6c5f 7065 725f   perf_total_per_
+0007af20: 6f70 5f75 735b 4747 4d4c 5f4f 505f 434f  op_us[GGML_OP_CO
+0007af30: 554e 545d 203d 207b 307d 3b0a 0a20 2020  UNT] = {0};..   
+0007af40: 2047 474d 4c5f 5052 494e 5428 223d 3d3d   GGML_PRINT("===
+0007af50: 2047 5241 5048 203d 3d3d 5c6e 2229 3b0a   GRAPH ===\n");.
+0007af60: 0a20 2020 2047 474d 4c5f 5052 494e 545f  .    GGML_PRINT_
+0007af70: 4445 4255 4728 226e 5f74 6872 6561 6473  DEBUG("n_threads
+0007af80: 2020 2020 2020 203d 2025 645c 6e22 2c20         = %d\n", 
+0007af90: 2020 2020 2020 2063 6772 6170 682d 3e6e         cgraph->n
+0007afa0: 5f74 6872 6561 6473 293b 0a20 2020 2047  _threads);.    G
+0007afb0: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
+0007afc0: 2274 6f74 616c 2077 6f72 6b20 7369 7a65  "total work size
+0007afd0: 203d 2025 7a75 2062 7974 6573 5c6e 222c   = %zu bytes\n",
+0007afe0: 2063 6772 6170 682d 3e77 6f72 6b5f 7369   cgraph->work_si
+0007aff0: 7a65 293b 0a0a 2020 2020 4747 4d4c 5f50  ze);..    GGML_P
+0007b000: 5249 4e54 2822 6e5f 6e6f 6465 7320 3d20  RINT("n_nodes = 
+0007b010: 2564 5c6e 222c 2063 6772 6170 682d 3e6e  %d\n", cgraph->n
+0007b020: 5f6e 6f64 6573 293b 0a20 2020 2066 6f72  _nodes);.    for
+0007b030: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0007b040: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
+0007b050: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0007b060: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0007b070: 736f 7220 2a20 6e6f 6465 203d 2063 6772  sor * node = cgr
+0007b080: 6170 682d 3e6e 6f64 6573 5b69 5d3b 0a0a  aph->nodes[i];..
+0007b090: 2020 2020 2020 2020 7065 7266 5f74 6f74          perf_tot
+0007b0a0: 616c 5f70 6572 5f6f 705f 7573 5b6e 6f64  al_per_op_us[nod
+0007b0b0: 652d 3e6f 705d 202b 3d20 4d41 5828 312c  e->op] += MAX(1,
+0007b0c0: 206e 6f64 652d 3e70 6572 665f 7469 6d65   node->perf_time
+0007b0d0: 5f75 7329 3b0a 0a20 2020 2020 2020 2047  _us);..        G
+0007b0e0: 474d 4c5f 5052 494e 5428 2220 2d20 2533  GML_PRINT(" - %3
+0007b0f0: 643a 205b 2025 356a 642c 2025 356a 642c  d: [ %5jd, %5jd,
+0007b100: 2025 356a 645d 2025 3136 7320 2573 2028   %5jd] %16s %s (
+0007b110: 2533 6429 2063 7075 203d 2025 372e 3366  %3d) cpu = %7.3f
+0007b120: 202f 2025 372e 3366 206d 732c 2077 616c   / %7.3f ms, wal
+0007b130: 6c20 3d20 2537 2e33 6620 2f20 2537 2e33  l = %7.3f / %7.3
+0007b140: 6620 6d73 5c6e 222c 0a20 2020 2020 2020  f ms\n",.       
+0007b150: 2020 2020 2020 2020 2069 2c0a 2020 2020           i,.    
+0007b160: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+0007b170: 2d3e 6e65 5b30 5d2c 206e 6f64 652d 3e6e  ->ne[0], node->n
+0007b180: 655b 315d 2c20 6e6f 6465 2d3e 6e65 5b32  e[1], node->ne[2
+0007b190: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0007b1a0: 2020 2047 474d 4c5f 4f50 5f4e 414d 455b     GGML_OP_NAME[
+0007b1b0: 6e6f 6465 2d3e 6f70 5d2c 206e 6f64 652d  node->op], node-
+0007b1c0: 3e69 735f 7061 7261 6d20 3f20 2278 2220  >is_param ? "x" 
+0007b1d0: 3a20 6e6f 6465 2d3e 6772 6164 203f 2022  : node->grad ? "
+0007b1e0: 6722 203a 2022 2022 2c20 6e6f 6465 2d3e  g" : " ", node->
+0007b1f0: 7065 7266 5f72 756e 732c 0a20 2020 2020  perf_runs,.     
+0007b200: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
+0007b210: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f63  le) node->perf_c
+0007b220: 7963 6c65 7320 202f 2028 646f 7562 6c65  ycles  / (double
+0007b230: 2920 6767 6d6c 5f63 7963 6c65 735f 7065  ) ggml_cycles_pe
+0007b240: 725f 6d73 2829 2c0a 2020 2020 2020 2020  r_ms(),.        
+0007b250: 2020 2020 2020 2020 2864 6f75 626c 6529          (double)
+0007b260: 206e 6f64 652d 3e70 6572 665f 6379 636c   node->perf_cycl
+0007b270: 6573 2020 2f20 2864 6f75 626c 6529 2067  es  / (double) g
+0007b280: 676d 6c5f 6379 636c 6573 5f70 6572 5f6d  gml_cycles_per_m
+0007b290: 7328 2920 2f20 2864 6f75 626c 6529 206e  s() / (double) n
+0007b2a0: 6f64 652d 3e70 6572 665f 7275 6e73 2c0a  ode->perf_runs,.
+0007b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b2c0: 2864 6f75 626c 6529 206e 6f64 652d 3e70  (double) node->p
+0007b2d0: 6572 665f 7469 6d65 5f75 7320 2f20 3130  erf_time_us / 10
+0007b2e0: 3030 2e30 2c0a 2020 2020 2020 2020 2020  00.0,.          
+0007b2f0: 2020 2020 2020 2864 6f75 626c 6529 206e        (double) n
+0007b300: 6f64 652d 3e70 6572 665f 7469 6d65 5f75  ode->perf_time_u
+0007b310: 7320 2f20 3130 3030 2e30 202f 206e 6f64  s / 1000.0 / nod
+0007b320: 652d 3e70 6572 665f 7275 6e73 293b 0a20  e->perf_runs);. 
+0007b330: 2020 207d 0a0a 2020 2020 4747 4d4c 5f50     }..    GGML_P
+0007b340: 5249 4e54 2822 6e5f 6c65 6166 7320 3d20  RINT("n_leafs = 
+0007b350: 2564 5c6e 222c 2063 6772 6170 682d 3e6e  %d\n", cgraph->n
+0007b360: 5f6c 6561 6673 293b 0a20 2020 2066 6f72  _leafs);.    for
+0007b370: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0007b380: 2063 6772 6170 682d 3e6e 5f6c 6561 6673   cgraph->n_leafs
+0007b390: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0007b3a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0007b3b0: 736f 7220 2a20 6e6f 6465 203d 2063 6772  sor * node = cgr
+0007b3c0: 6170 682d 3e6c 6561 6673 5b69 5d3b 0a0a  aph->leafs[i];..
+0007b3d0: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+0007b3e0: 4e54 2822 202d 2025 3364 3a20 5b20 2535  NT(" - %3d: [ %5
+0007b3f0: 6a64 2c20 2535 6a64 5d20 2538 735c 6e22  jd, %5jd] %8s\n"
+0007b400: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007b410: 2020 692c 0a20 2020 2020 2020 2020 2020    i,.           
+0007b420: 2020 2020 206e 6f64 652d 3e6e 655b 305d       node->ne[0]
+0007b430: 2c20 6e6f 6465 2d3e 6e65 5b31 5d2c 0a20  , node->ne[1],. 
+0007b440: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0007b450: 474d 4c5f 4f50 5f4e 414d 455b 6e6f 6465  GML_OP_NAME[node
+0007b460: 2d3e 6f70 5d29 3b0a 2020 2020 7d0a 0a20  ->op]);.    }.. 
+0007b470: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+0007b480: 303b 2069 203c 2047 474d 4c5f 4f50 5f43  0; i < GGML_OP_C
+0007b490: 4f55 4e54 3b20 692b 2b29 207b 0a20 2020  OUNT; i++) {.   
+0007b4a0: 2020 2020 2069 6620 2870 6572 665f 746f       if (perf_to
+0007b4b0: 7461 6c5f 7065 725f 6f70 5f75 735b 695d  tal_per_op_us[i]
+0007b4c0: 203d 3d20 3029 207b 0a20 2020 2020 2020   == 0) {.       
+0007b4d0: 2020 2020 2063 6f6e 7469 6e75 653b 0a20       continue;. 
+0007b4e0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0007b4f0: 2020 4747 4d4c 5f50 5249 4e54 2822 7065    GGML_PRINT("pe
+0007b500: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
+0007b510: 7573 5b25 3136 735d 203d 2025 372e 3366  us[%16s] = %7.3f
+0007b520: 206d 735c 6e22 2c20 4747 4d4c 5f4f 505f   ms\n", GGML_OP_
+0007b530: 4e41 4d45 5b69 5d2c 2028 646f 7562 6c65  NAME[i], (double
+0007b540: 2920 7065 7266 5f74 6f74 616c 5f70 6572  ) perf_total_per
+0007b550: 5f6f 705f 7573 5b69 5d20 2f20 3130 3030  _op_us[i] / 1000
+0007b560: 2e30 293b 0a20 2020 207d 0a0a 2020 2020  .0);.    }..    
+0007b570: 4747 4d4c 5f50 5249 4e54 2822 3d3d 3d3d  GGML_PRINT("====
 0007b580: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0007b590: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d5c  ===============\
-0007b5a0: 6e22 293b 0a7d 0a0a 2f2f 2063 6865 636b  n");.}..// check
-0007b5b0: 2069 6620 6e6f 6465 2069 7320 7061 7274   if node is part
-0007b5c0: 206f 6620 7468 6520 6772 6170 680a 7374   of the graph.st
-0007b5d0: 6174 6963 2062 6f6f 6c20 6767 6d6c 5f67  atic bool ggml_g
-0007b5e0: 7261 7068 5f66 696e 6428 636f 6e73 7420  raph_find(const 
-0007b5f0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-0007b600: 7068 202a 2063 6772 6170 682c 2063 6f6e  ph * cgraph, con
-0007b610: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0007b620: 656e 736f 7220 2a20 6e6f 6465 2920 7b0a  ensor * node) {.
-0007b630: 2020 2020 6966 2028 6367 7261 7068 203d      if (cgraph =
-0007b640: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-0007b650: 2020 7265 7475 726e 2074 7275 653b 0a20    return true;. 
-0007b660: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
-0007b670: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
-0007b680: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
-0007b690: 2b2b 2920 7b0a 2020 2020 2020 2020 6966  ++) {.        if
-0007b6a0: 2028 6367 7261 7068 2d3e 6e6f 6465 735b   (cgraph->nodes[
-0007b6b0: 695d 203d 3d20 6e6f 6465 2920 7b0a 2020  i] == node) {.  
-0007b6c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0007b6d0: 2074 7275 653b 0a20 2020 2020 2020 207d   true;.        }
-0007b6e0: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-0007b6f0: 726e 2066 616c 7365 3b0a 7d0a 0a73 7461  rn false;.}..sta
-0007b700: 7469 6320 7374 7275 6374 2067 676d 6c5f  tic struct ggml_
-0007b710: 7465 6e73 6f72 202a 2067 676d 6c5f 6772  tensor * ggml_gr
-0007b720: 6170 685f 6765 745f 7061 7265 6e74 2863  aph_get_parent(c
-0007b730: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0007b740: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-0007b750: 2c20 636f 6e73 7420 7374 7275 6374 2067  , const struct g
-0007b760: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
-0007b770: 6529 207b 0a20 2020 2066 6f72 2028 696e  e) {.    for (in
-0007b780: 7420 6920 3d20 303b 2069 203c 2063 6772  t i = 0; i < cgr
-0007b790: 6170 682d 3e6e 5f6e 6f64 6573 3b20 692b  aph->n_nodes; i+
-0007b7a0: 2b29 207b 0a20 2020 2020 2020 2073 7472  +) {.        str
-0007b7b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0007b7c0: 2a20 7061 7265 6e74 203d 2063 6772 6170  * parent = cgrap
-0007b7d0: 682d 3e6e 6f64 6573 5b69 5d3b 0a0a 2020  h->nodes[i];..  
-0007b7e0: 2020 2020 2020 6966 2028 7061 7265 6e74        if (parent
-0007b7f0: 2d3e 6772 6164 203d 3d20 6e6f 6465 2920  ->grad == node) 
-0007b800: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-0007b810: 7475 726e 2070 6172 656e 743b 0a20 2020  turn parent;.   
-0007b820: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0007b830: 2020 7265 7475 726e 204e 554c 4c3b 0a7d    return NULL;.}
-0007b840: 0a0a 766f 6964 2067 676d 6c5f 6772 6170  ..void ggml_grap
-0007b850: 685f 6475 6d70 5f64 6f74 2863 6f6e 7374  h_dump_dot(const
-0007b860: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-0007b870: 6170 6820 2a20 6762 2c20 636f 6e73 7420  aph * gb, const 
-0007b880: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-0007b890: 7068 202a 2067 662c 2063 6f6e 7374 2063  ph * gf, const c
-0007b8a0: 6861 7220 2a20 6669 6c65 6e61 6d65 2920  har * filename) 
-0007b8b0: 7b0a 2020 2020 6368 6172 2063 6f6c 6f72  {.    char color
-0007b8c0: 5b31 365d 3b0a 0a20 2020 2046 494c 4520  [16];..    FILE 
-0007b8d0: 2a20 6670 203d 2066 6f70 656e 2866 696c  * fp = fopen(fil
-0007b8e0: 656e 616d 652c 2022 7722 293b 0a20 2020  ename, "w");.   
-0007b8f0: 2047 474d 4c5f 4153 5345 5254 2866 7029   GGML_ASSERT(fp)
-0007b900: 3b0a 0a20 2020 2066 7072 696e 7466 2866  ;..    fprintf(f
-0007b910: 702c 2022 6469 6772 6170 6820 4720 7b5c  p, "digraph G {\
-0007b920: 6e22 293b 0a20 2020 2066 7072 696e 7466  n");.    fprintf
-0007b930: 2866 702c 2022 2020 6e65 7772 616e 6b20  (fp, "  newrank 
-0007b940: 3d20 7472 7565 3b5c 6e22 293b 0a20 2020  = true;\n");.   
-0007b950: 2066 7072 696e 7466 2866 702c 2022 2020   fprintf(fp, "  
-0007b960: 7261 6e6b 6469 7220 3d20 4c52 3b5c 6e22  rankdir = LR;\n"
-0007b970: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-0007b980: 2069 203d 2030 3b20 6920 3c20 6762 2d3e   i = 0; i < gb->
-0007b990: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
-0007b9a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0007b9b0: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
-0007b9c0: 6520 3d20 6762 2d3e 6e6f 6465 735b 695d  e = gb->nodes[i]
-0007b9d0: 3b0a 0a20 2020 2020 2020 2069 6620 2867  ;..        if (g
-0007b9e0: 676d 6c5f 6772 6170 685f 6765 745f 7061  gml_graph_get_pa
-0007b9f0: 7265 6e74 2867 622c 206e 6f64 6529 2021  rent(gb, node) !
-0007ba00: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
-0007ba10: 2020 2020 2020 636f 6e74 696e 7565 3b0a        continue;.
-0007ba20: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0007ba30: 2020 2069 6620 286e 6f64 652d 3e69 735f     if (node->is_
-0007ba40: 7061 7261 6d29 207b 0a20 2020 2020 2020  param) {.       
-0007ba50: 2020 2020 2073 6e70 7269 6e74 6628 636f       snprintf(co
-0007ba60: 6c6f 722c 2073 697a 656f 6628 636f 6c6f  lor, sizeof(colo
-0007ba70: 7229 2c20 2279 656c 6c6f 7722 293b 0a20  r), "yellow");. 
-0007ba80: 2020 2020 2020 207d 2065 6c73 6520 6966         } else if
-0007ba90: 2028 6e6f 6465 2d3e 6772 6164 2920 7b0a   (node->grad) {.
-0007baa0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0007bab0: 6767 6d6c 5f67 7261 7068 5f66 696e 6428  ggml_graph_find(
-0007bac0: 6766 2c20 6e6f 6465 2929 207b 0a20 2020  gf, node)) {.   
-0007bad0: 2020 2020 2020 2020 2020 2020 2073 6e70               snp
-0007bae0: 7269 6e74 6628 636f 6c6f 722c 2073 697a  rintf(color, siz
-0007baf0: 656f 6628 636f 6c6f 7229 2c20 2267 7265  eof(color), "gre
-0007bb00: 656e 2229 3b0a 2020 2020 2020 2020 2020  en");.          
-0007bb10: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0007bb20: 2020 2020 2020 2020 2020 2073 6e70 7269             snpri
-0007bb30: 6e74 6628 636f 6c6f 722c 2073 697a 656f  ntf(color, sizeo
-0007bb40: 6628 636f 6c6f 7229 2c20 226c 6967 6874  f(color), "light
-0007bb50: 626c 7565 2229 3b0a 2020 2020 2020 2020  blue");.        
-0007bb60: 2020 2020 7d0a 2020 2020 2020 2020 7d20      }.        } 
-0007bb70: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-0007bb80: 2020 2073 6e70 7269 6e74 6628 636f 6c6f     snprintf(colo
-0007bb90: 722c 2073 697a 656f 6628 636f 6c6f 7229  r, sizeof(color)
-0007bba0: 2c20 2277 6869 7465 2229 3b0a 2020 2020  , "white");.    
-0007bbb0: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
-0007bbc0: 7072 696e 7466 2866 702c 2022 2020 5c22  printf(fp, "  \"
-0007bbd0: 2570 5c22 205b 2022 0a20 2020 2020 2020  %p\" [ ".       
-0007bbe0: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-0007bbf0: 796c 6520 3d20 6669 6c6c 6564 3b20 6669  yle = filled; fi
-0007bc00: 6c6c 636f 6c6f 7220 3d20 2573 3b20 7368  llcolor = %s; sh
-0007bc10: 6170 6520 3d20 7265 636f 7264 3b20 220a  ape = record; ".
-0007bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bc30: 2020 2020 226c 6162 656c 3d5c 2222 2c0a      "label=\"",.
-0007bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bc50: 2876 6f69 6420 2a29 206e 6f64 652c 2063  (void *) node, c
-0007bc60: 6f6c 6f72 293b 0a0a 2020 2020 2020 2020  olor);..        
-0007bc70: 6966 2028 7374 726c 656e 286e 6f64 652d  if (strlen(node-
-0007bc80: 3e6e 616d 6529 203e 2030 2920 7b0a 2020  >name) > 0) {.  
-0007bc90: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
-0007bca0: 6628 6670 2c20 2225 7320 7c22 2c20 6e6f  f(fp, "%s |", no
-0007bcb0: 6465 2d3e 6e61 6d65 293b 0a20 2020 2020  de->name);.     
-0007bcc0: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-0007bcd0: 2028 6e6f 6465 2d3e 6e5f 6469 6d73 203d   (node->n_dims =
-0007bce0: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
-0007bcf0: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
-0007bd00: 2564 205b 256a 642c 2025 6a64 5d20 7c20  %d [%jd, %jd] | 
-0007bd10: 3c78 3e25 7322 2c20 692c 206e 6f64 652d  <x>%s", i, node-
-0007bd20: 3e6e 655b 305d 2c20 6e6f 6465 2d3e 6e65  >ne[0], node->ne
-0007bd30: 5b31 5d2c 2047 474d 4c5f 4f50 5f53 594d  [1], GGML_OP_SYM
-0007bd40: 424f 4c5b 6e6f 6465 2d3e 6f70 5d29 3b0a  BOL[node->op]);.
-0007bd50: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-0007bd60: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
-0007bd70: 696e 7466 2866 702c 2022 2564 205b 256a  intf(fp, "%d [%j
-0007bd80: 642c 2025 6a64 2c20 256a 645d 207c 203c  d, %jd, %jd] | <
-0007bd90: 783e 2573 222c 2069 2c20 6e6f 6465 2d3e  x>%s", i, node->
-0007bda0: 6e65 5b30 5d2c 206e 6f64 652d 3e6e 655b  ne[0], node->ne[
-0007bdb0: 315d 2c20 6e6f 6465 2d3e 6e65 5b32 5d2c  1], node->ne[2],
-0007bdc0: 2047 474d 4c5f 4f50 5f53 594d 424f 4c5b   GGML_OP_SYMBOL[
-0007bdd0: 6e6f 6465 2d3e 6f70 5d29 3b0a 2020 2020  node->op]);.    
-0007bde0: 2020 2020 7d0a 0a0a 2020 2020 2020 2020      }...        
-0007bdf0: 6966 2028 6e6f 6465 2d3e 6772 6164 2920  if (node->grad) 
-0007be00: 7b0a 2020 2020 2020 2020 2020 2020 6670  {.            fp
-0007be10: 7269 6e74 6628 6670 2c20 2220 7c20 3c67  rintf(fp, " | <g
-0007be20: 3e25 735c 223b 205d 5c6e 222c 2047 474d  >%s\"; ]\n", GGM
-0007be30: 4c5f 4f50 5f53 594d 424f 4c5b 6e6f 6465  L_OP_SYMBOL[node
-0007be40: 2d3e 6772 6164 2d3e 6f70 5d29 3b0a 2020  ->grad->op]);.  
-0007be50: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0007be60: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-0007be70: 7466 2866 702c 2022 5c22 3b20 5d5c 6e22  tf(fp, "\"; ]\n"
-0007be80: 293b 0a20 2020 2020 2020 207d 0a20 2020  );.        }.   
-0007be90: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
-0007bea0: 2069 203d 2030 3b20 6920 3c20 6762 2d3e   i = 0; i < gb->
-0007beb0: 6e5f 6c65 6166 733b 2069 2b2b 2920 7b0a  n_leafs; i++) {.
-0007bec0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0007bed0: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
-0007bee0: 6520 3d20 6762 2d3e 6c65 6166 735b 695d  e = gb->leafs[i]
-0007bef0: 3b0a 0a20 2020 2020 2020 2073 6e70 7269  ;..        snpri
-0007bf00: 6e74 6628 636f 6c6f 722c 2073 697a 656f  ntf(color, sizeo
-0007bf10: 6628 636f 6c6f 7229 2c20 2270 696e 6b22  f(color), "pink"
-0007bf20: 293b 0a0a 2020 2020 2020 2020 6670 7269  );..        fpri
-0007bf30: 6e74 6628 6670 2c20 2220 205c 2225 705c  ntf(fp, "  \"%p\
-0007bf40: 2220 5b20 220a 2020 2020 2020 2020 2020  " [ ".          
-0007bf50: 2020 2020 2020 2020 2020 2273 7479 6c65            "style
-0007bf60: 203d 2066 696c 6c65 643b 2066 696c 6c63   = filled; fillc
-0007bf70: 6f6c 6f72 203d 2025 733b 2073 6861 7065  olor = %s; shape
-0007bf80: 203d 2072 6563 6f72 643b 2022 0a20 2020   = record; ".   
-0007bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bfa0: 2022 6c61 6265 6c3d 5c22 3c78 3e22 2c0a   "label=\"<x>",.
-0007bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bfc0: 2876 6f69 6420 2a29 206e 6f64 652c 2063  (void *) node, c
-0007bfd0: 6f6c 6f72 293b 0a0a 2020 2020 2020 2020  olor);..        
-0007bfe0: 6966 2028 7374 726c 656e 286e 6f64 652d  if (strlen(node-
-0007bff0: 3e6e 616d 6529 203e 2030 2920 7b0a 2020  >name) > 0) {.  
-0007c000: 2020 2020 2020 2020 2020 2020 2020 6670                fp
-0007c010: 7269 6e74 6628 6670 2c20 2225 7320 7c20  rintf(fp, "%s | 
-0007c020: 222c 206e 6f64 652d 3e6e 616d 6529 3b0a  ", node->name);.
-0007c030: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0007c040: 2020 6966 2028 6767 6d6c 5f6e 656c 656d    if (ggml_nelem
-0007c050: 656e 7473 286e 6f64 6529 203d 3d20 3129  ents(node) == 1)
-0007c060: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
-0007c070: 6620 286e 6f64 652d 3e74 7970 6520 3d3d  f (node->type ==
-0007c080: 2047 474d 4c5f 5459 5045 5f49 3820 7c7c   GGML_TYPE_I8 ||
-0007c090: 206e 6f64 652d 3e74 7970 6520 3d3d 2047   node->type == G
-0007c0a0: 474d 4c5f 5459 5045 5f49 3136 207c 7c20  GML_TYPE_I16 || 
-0007c0b0: 6e6f 6465 2d3e 7479 7065 203d 3d20 4747  node->type == GG
-0007c0c0: 4d4c 5f54 5950 455f 4933 3229 207b 0a20  ML_TYPE_I32) {. 
-0007c0d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0007c0e0: 7072 696e 7466 2866 702c 2022 2564 222c  printf(fp, "%d",
-0007c0f0: 2067 676d 6c5f 6765 745f 6933 325f 3164   ggml_get_i32_1d
-0007c100: 286e 6f64 652c 2030 2929 3b0a 2020 2020  (node, 0));.    
-0007c110: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0007c120: 2020 2020 2020 656c 7365 207b 0a20 2020        else {.   
-0007c130: 2020 2020 2020 2020 2020 2020 2066 7072               fpr
-0007c140: 696e 7466 2866 702c 2022 252e 3165 222c  intf(fp, "%.1e",
-0007c150: 2028 646f 7562 6c65 2967 676d 6c5f 6765   (double)ggml_ge
-0007c160: 745f 6633 325f 3164 286e 6f64 652c 2030  t_f32_1d(node, 0
-0007c170: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-0007c180: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-0007c190: 2020 2020 656c 7365 207b 0a20 2020 2020      else {.     
-0007c1a0: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
-0007c1b0: 702c 2022 434f 4e53 5420 2564 205b 256a  p, "CONST %d [%j
-0007c1c0: 642c 2025 6a64 5d22 2c20 692c 206e 6f64  d, %jd]", i, nod
-0007c1d0: 652d 3e6e 655b 305d 2c20 6e6f 6465 2d3e  e->ne[0], node->
-0007c1e0: 6e65 5b31 5d29 3b0a 2020 2020 2020 2020  ne[1]);.        
-0007c1f0: 7d0a 2020 2020 2020 2020 6670 7269 6e74  }.        fprint
-0007c200: 6628 6670 2c20 225c 223b 205d 5c6e 2229  f(fp, "\"; ]\n")
-0007c210: 3b0a 2020 2020 7d0a 0a20 2020 2066 6f72  ;.    }..    for
-0007c220: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-0007c230: 2067 622d 3e6e 5f6e 6f64 6573 3b20 692b   gb->n_nodes; i+
-0007c240: 2b29 207b 0a20 2020 2020 2020 2073 7472  +) {.        str
-0007c250: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0007c260: 2a20 6e6f 6465 203d 2067 622d 3e6e 6f64  * node = gb->nod
-0007c270: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
-0007c280: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0007c290: 6f72 202a 2070 6172 656e 7420 3d20 6767  or * parent = gg
-0007c2a0: 6d6c 5f67 7261 7068 5f67 6574 5f70 6172  ml_graph_get_par
-0007c2b0: 656e 7428 6762 2c20 6e6f 6465 293b 0a0a  ent(gb, node);..
-0007c2c0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-0007c2d0: 2d3e 7372 6330 2920 7b0a 2020 2020 2020  ->src0) {.      
-0007c2e0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0007c2f0: 6c5f 7465 6e73 6f72 202a 2070 6172 656e  l_tensor * paren
-0007c300: 7430 203d 2067 676d 6c5f 6772 6170 685f  t0 = ggml_graph_
-0007c310: 6765 745f 7061 7265 6e74 2867 622c 206e  get_parent(gb, n
-0007c320: 6f64 652d 3e73 7263 3029 3b0a 0a20 2020  ode->src0);..   
-0007c330: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
-0007c340: 2866 702c 2022 2020 5c22 2570 5c22 3a25  (fp, "  \"%p\":%
-0007c350: 7320 2d3e 205c 2225 705c 223a 2573 205b  s -> \"%p\":%s [
-0007c360: 2061 7272 6f77 6865 6164 203d 2025 733b   arrowhead = %s;
-0007c370: 2073 7479 6c65 203d 2025 733b 206c 6162   style = %s; lab
-0007c380: 656c 203d 205c 2278 5c22 3b20 5d5c 6e22  el = \"x\"; ]\n"
-0007c390: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007c3a0: 2020 2020 2020 7061 7265 6e74 3020 3f20        parent0 ? 
-0007c3b0: 2876 6f69 6420 2a29 2070 6172 656e 7430  (void *) parent0
-0007c3c0: 203a 2028 766f 6964 202a 2920 6e6f 6465   : (void *) node
-0007c3d0: 2d3e 7372 6330 2c0a 2020 2020 2020 2020  ->src0,.        
-0007c3e0: 2020 2020 2020 2020 2020 2020 7061 7265              pare
-0007c3f0: 6e74 3020 3f20 2267 2220 3a20 2278 222c  nt0 ? "g" : "x",
-0007c400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c410: 2020 2020 2070 6172 656e 7420 3f20 2876       parent ? (v
-0007c420: 6f69 6420 2a29 2070 6172 656e 7420 3a20  oid *) parent : 
-0007c430: 2876 6f69 6420 2a29 206e 6f64 652c 0a20  (void *) node,. 
-0007c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c450: 2020 2070 6172 656e 7420 3f20 2267 2220     parent ? "g" 
-0007c460: 3a20 2278 222c 0a20 2020 2020 2020 2020  : "x",.         
-0007c470: 2020 2020 2020 2020 2020 2070 6172 656e             paren
-0007c480: 7420 3f20 2265 6d70 7479 2220 3a20 2276  t ? "empty" : "v
-0007c490: 6565 222c 0a20 2020 2020 2020 2020 2020  ee",.           
-0007c4a0: 2020 2020 2020 2020 2070 6172 656e 7420           parent 
-0007c4b0: 3f20 2264 6173 6865 6422 203a 2022 736f  ? "dashed" : "so
-0007c4c0: 6c69 6422 293b 0a20 2020 2020 2020 207d  lid");.        }
-0007c4d0: 0a0a 2020 2020 2020 2020 6966 2028 6e6f  ..        if (no
-0007c4e0: 6465 2d3e 7372 6331 2920 7b0a 2020 2020  de->src1) {.    
-0007c4f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0007c500: 676d 6c5f 7465 6e73 6f72 202a 2070 6172  gml_tensor * par
-0007c510: 656e 7431 203d 2067 676d 6c5f 6772 6170  ent1 = ggml_grap
-0007c520: 685f 6765 745f 7061 7265 6e74 2867 622c  h_get_parent(gb,
-0007c530: 206e 6f64 652d 3e73 7263 3129 3b0a 0a20   node->src1);.. 
-0007c540: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-0007c550: 7466 2866 702c 2022 2020 5c22 2570 5c22  tf(fp, "  \"%p\"
-0007c560: 3a25 7320 2d3e 205c 2225 705c 223a 2573  :%s -> \"%p\":%s
-0007c570: 205b 2061 7272 6f77 6865 6164 203d 2025   [ arrowhead = %
-0007c580: 733b 2073 7479 6c65 203d 2025 733b 206c  s; style = %s; l
-0007c590: 6162 656c 203d 205c 2279 5c22 3b20 5d5c  abel = \"y\"; ]\
-0007c5a0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-0007c5b0: 2020 2020 2020 2020 7061 7265 6e74 3120          parent1 
-0007c5c0: 3f20 2876 6f69 6420 2a29 2070 6172 656e  ? (void *) paren
-0007c5d0: 7431 203a 2028 766f 6964 202a 2920 6e6f  t1 : (void *) no
-0007c5e0: 6465 2d3e 7372 6331 2c0a 2020 2020 2020  de->src1,.      
-0007c5f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0007c600: 7265 6e74 3120 3f20 2267 2220 3a20 2278  rent1 ? "g" : "x
-0007c610: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0007c620: 2020 2020 2020 2070 6172 656e 7420 3f20         parent ? 
-0007c630: 2876 6f69 6420 2a29 2070 6172 656e 7420  (void *) parent 
-0007c640: 3a20 2876 6f69 6420 2a29 206e 6f64 652c  : (void *) node,
-0007c650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c660: 2020 2020 2070 6172 656e 7420 3f20 2267       parent ? "g
-0007c670: 2220 3a20 2278 222c 0a20 2020 2020 2020  " : "x",.       
-0007c680: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0007c690: 656e 7420 3f20 2265 6d70 7479 2220 3a20  ent ? "empty" : 
-0007c6a0: 2276 6565 222c 0a20 2020 2020 2020 2020  "vee",.         
-0007c6b0: 2020 2020 2020 2020 2020 2070 6172 656e             paren
-0007c6c0: 7420 3f20 2264 6173 6865 6422 203a 2022  t ? "dashed" : "
-0007c6d0: 736f 6c69 6422 293b 0a20 2020 2020 2020  solid");.       
-0007c6e0: 207d 0a20 2020 207d 0a0a 2020 2020 666f   }.    }..    fo
-0007c6f0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0007c700: 3c20 6762 2d3e 6e5f 6c65 6166 733b 2069  < gb->n_leafs; i
-0007c710: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
-0007c720: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0007c730: 202a 206e 6f64 6520 3d20 6762 2d3e 6c65   * node = gb->le
-0007c740: 6166 735b 695d 3b0a 0a20 2020 2020 2020  afs[i];..       
-0007c750: 2069 6620 286e 6f64 652d 3e73 7263 3029   if (node->src0)
-0007c760: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-0007c770: 7072 696e 7466 2866 702c 2022 2020 5c22  printf(fp, "  \"
-0007c780: 2570 5c22 3a25 7320 2d3e 205c 2225 705c  %p\":%s -> \"%p\
-0007c790: 223a 2573 205b 206c 6162 656c 203d 205c  ":%s [ label = \
-0007c7a0: 2278 5c22 3b20 5d5c 6e22 2c0a 2020 2020  "x\"; ]\n",.    
-0007c7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c7c0: 2876 6f69 6420 2a29 206e 6f64 652d 3e73  (void *) node->s
-0007c7d0: 7263 302c 2022 7822 2c0a 2020 2020 2020  rc0, "x",.      
-0007c7e0: 2020 2020 2020 2020 2020 2020 2020 2876                (v
-0007c7f0: 6f69 6420 2a29 206e 6f64 652c 2022 7822  oid *) node, "x"
-0007c800: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
-0007c810: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
-0007c820: 7372 6331 2920 7b0a 2020 2020 2020 2020  src1) {.        
-0007c830: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-0007c840: 2220 205c 2225 705c 223a 2573 202d 3e20  "  \"%p\":%s -> 
-0007c850: 5c22 2570 5c22 3a25 7320 5b20 6c61 6265  \"%p\":%s [ labe
-0007c860: 6c20 3d20 5c22 795c 223b 205d 5c6e 222c  l = \"y\"; ]\n",
-0007c870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c880: 2020 2020 2028 766f 6964 202a 2920 6e6f       (void *) no
-0007c890: 6465 2d3e 7372 6331 2c20 2278 222c 0a20  de->src1, "x",. 
-0007c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c8b0: 2020 2028 766f 6964 202a 2920 6e6f 6465     (void *) node
-0007c8c0: 2c20 2278 2229 3b0a 2020 2020 2020 2020  , "x");.        
-0007c8d0: 7d0a 2020 2020 7d0a 0a20 2020 2066 7072  }.    }..    fpr
-0007c8e0: 696e 7466 2866 702c 2022 7d5c 6e22 293b  intf(fp, "}\n");
-0007c8f0: 0a0a 2020 2020 6663 6c6f 7365 2866 7029  ..    fclose(fp)
-0007c900: 3b0a 0a20 2020 2047 474d 4c5f 5052 494e  ;..    GGML_PRIN
-0007c910: 5428 2225 733a 2064 6f74 202d 5470 6e67  T("%s: dot -Tpng
-0007c920: 2025 7320 2d6f 2025 732e 706e 6720 2626   %s -o %s.png &&
-0007c930: 206f 7065 6e20 2573 2e70 6e67 5c6e 222c   open %s.png\n",
-0007c940: 205f 5f66 756e 635f 5f2c 2066 696c 656e   __func__, filen
-0007c950: 616d 652c 2066 696c 656e 616d 652c 2066  ame, filename, f
-0007c960: 696c 656e 616d 6529 3b0a 7d0a 0a2f 2f2f  ilename);.}..///
-0007c970: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0007b590: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0007b5a0: 3d3d 3d3d 5c6e 2229 3b0a 7d0a 0a2f 2f20  ====\n");.}..// 
+0007b5b0: 6368 6563 6b20 6966 206e 6f64 6520 6973  check if node is
+0007b5c0: 2070 6172 7420 6f66 2074 6865 2067 7261   part of the gra
+0007b5d0: 7068 0a73 7461 7469 6320 626f 6f6c 2067  ph.static bool g
+0007b5e0: 676d 6c5f 6772 6170 685f 6669 6e64 2863  gml_graph_find(c
+0007b5f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0007b600: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
+0007b610: 2c20 636f 6e73 7420 7374 7275 6374 2067  , const struct g
+0007b620: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
+0007b630: 6529 207b 0a20 2020 2069 6620 2863 6772  e) {.    if (cgr
+0007b640: 6170 6820 3d3d 204e 554c 4c29 207b 0a20  aph == NULL) {. 
+0007b650: 2020 2020 2020 2072 6574 7572 6e20 7472         return tr
+0007b660: 7565 3b0a 2020 2020 7d0a 0a20 2020 2066  ue;.    }..    f
+0007b670: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0007b680: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
+0007b690: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
+0007b6a0: 2020 2069 6620 2863 6772 6170 682d 3e6e     if (cgraph->n
+0007b6b0: 6f64 6573 5b69 5d20 3d3d 206e 6f64 6529  odes[i] == node)
+0007b6c0: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
+0007b6d0: 6574 7572 6e20 7472 7565 3b0a 2020 2020  eturn true;.    
+0007b6e0: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+0007b6f0: 2072 6574 7572 6e20 6661 6c73 653b 0a7d   return false;.}
+0007b700: 0a0a 7374 6174 6963 2073 7472 7563 7420  ..static struct 
+0007b710: 6767 6d6c 5f74 656e 736f 7220 2a20 6767  ggml_tensor * gg
+0007b720: 6d6c 5f67 7261 7068 5f67 6574 5f70 6172  ml_graph_get_par
+0007b730: 656e 7428 636f 6e73 7420 7374 7275 6374  ent(const struct
+0007b740: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
+0007b750: 6772 6170 682c 2063 6f6e 7374 2073 7472  graph, const str
+0007b760: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0007b770: 2a20 6e6f 6465 2920 7b0a 2020 2020 666f  * node) {.    fo
+0007b780: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0007b790: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
+0007b7a0: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
+0007b7b0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0007b7c0: 6e73 6f72 202a 2070 6172 656e 7420 3d20  nsor * parent = 
+0007b7d0: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
+0007b7e0: 3b0a 0a20 2020 2020 2020 2069 6620 2870  ;..        if (p
+0007b7f0: 6172 656e 742d 3e67 7261 6420 3d3d 206e  arent->grad == n
+0007b800: 6f64 6529 207b 0a20 2020 2020 2020 2020  ode) {.         
+0007b810: 2020 2072 6574 7572 6e20 7061 7265 6e74     return parent
+0007b820: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+0007b830: 7d0a 0a20 2020 2072 6574 7572 6e20 4e55  }..    return NU
+0007b840: 4c4c 3b0a 7d0a 0a76 6f69 6420 6767 6d6c  LL;.}..void ggml
+0007b850: 5f67 7261 7068 5f64 756d 705f 646f 7428  _graph_dump_dot(
+0007b860: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0007b870: 6c5f 6367 7261 7068 202a 2067 622c 2063  l_cgraph * gb, c
+0007b880: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0007b890: 5f63 6772 6170 6820 2a20 6766 2c20 636f  _cgraph * gf, co
+0007b8a0: 6e73 7420 6368 6172 202a 2066 696c 656e  nst char * filen
+0007b8b0: 616d 6529 207b 0a20 2020 2063 6861 7220  ame) {.    char 
+0007b8c0: 636f 6c6f 725b 3136 5d3b 0a0a 2020 2020  color[16];..    
+0007b8d0: 4649 4c45 202a 2066 7020 3d20 666f 7065  FILE * fp = fope
+0007b8e0: 6e28 6669 6c65 6e61 6d65 2c20 2277 2229  n(filename, "w")
+0007b8f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0007b900: 5428 6670 293b 0a0a 2020 2020 6670 7269  T(fp);..    fpri
+0007b910: 6e74 6628 6670 2c20 2264 6967 7261 7068  ntf(fp, "digraph
+0007b920: 2047 207b 5c6e 2229 3b0a 2020 2020 6670   G {\n");.    fp
+0007b930: 7269 6e74 6628 6670 2c20 2220 206e 6577  rintf(fp, "  new
+0007b940: 7261 6e6b 203d 2074 7275 653b 5c6e 2229  rank = true;\n")
+0007b950: 3b0a 2020 2020 6670 7269 6e74 6628 6670  ;.    fprintf(fp
+0007b960: 2c20 2220 2072 616e 6b64 6972 203d 204c  , "  rankdir = L
+0007b970: 523b 5c6e 2229 3b0a 0a20 2020 2066 6f72  R;\n");..    for
+0007b980: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0007b990: 2067 622d 3e6e 5f6e 6f64 6573 3b20 692b   gb->n_nodes; i+
+0007b9a0: 2b29 207b 0a20 2020 2020 2020 2073 7472  +) {.        str
+0007b9b0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0007b9c0: 2a20 6e6f 6465 203d 2067 622d 3e6e 6f64  * node = gb->nod
+0007b9d0: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
+0007b9e0: 6966 2028 6767 6d6c 5f67 7261 7068 5f67  if (ggml_graph_g
+0007b9f0: 6574 5f70 6172 656e 7428 6762 2c20 6e6f  et_parent(gb, no
+0007ba00: 6465 2920 213d 204e 554c 4c29 207b 0a20  de) != NULL) {. 
+0007ba10: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0007ba20: 6e75 653b 0a20 2020 2020 2020 207d 0a0a  nue;.        }..
+0007ba30: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
+0007ba40: 2d3e 6973 5f70 6172 616d 2920 7b0a 2020  ->is_param) {.  
+0007ba50: 2020 2020 2020 2020 2020 736e 7072 696e            snprin
+0007ba60: 7466 2863 6f6c 6f72 2c20 7369 7a65 6f66  tf(color, sizeof
+0007ba70: 2863 6f6c 6f72 292c 2022 7965 6c6c 6f77  (color), "yellow
+0007ba80: 2229 3b0a 2020 2020 2020 2020 7d20 656c  ");.        } el
+0007ba90: 7365 2069 6620 286e 6f64 652d 3e67 7261  se if (node->gra
+0007baa0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007bab0: 2069 6620 2867 676d 6c5f 6772 6170 685f   if (ggml_graph_
+0007bac0: 6669 6e64 2867 662c 206e 6f64 6529 2920  find(gf, node)) 
+0007bad0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007bae0: 2020 736e 7072 696e 7466 2863 6f6c 6f72    snprintf(color
+0007baf0: 2c20 7369 7a65 6f66 2863 6f6c 6f72 292c  , sizeof(color),
+0007bb00: 2022 6772 6565 6e22 293b 0a20 2020 2020   "green");.     
+0007bb10: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+0007bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bb30: 736e 7072 696e 7466 2863 6f6c 6f72 2c20  snprintf(color, 
+0007bb40: 7369 7a65 6f66 2863 6f6c 6f72 292c 2022  sizeof(color), "
+0007bb50: 6c69 6768 7462 6c75 6522 293b 0a20 2020  lightblue");.   
+0007bb60: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007bb70: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0007bb80: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
+0007bb90: 2863 6f6c 6f72 2c20 7369 7a65 6f66 2863  (color, sizeof(c
+0007bba0: 6f6c 6f72 292c 2022 7768 6974 6522 293b  olor), "white");
+0007bbb0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0007bbc0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0007bbd0: 2220 205c 2225 705c 2220 5b20 220a 2020  "  \"%p\" [ ".  
+0007bbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bbf0: 2020 2273 7479 6c65 203d 2066 696c 6c65    "style = fille
+0007bc00: 643b 2066 696c 6c63 6f6c 6f72 203d 2025  d; fillcolor = %
+0007bc10: 733b 2073 6861 7065 203d 2072 6563 6f72  s; shape = recor
+0007bc20: 643b 2022 0a20 2020 2020 2020 2020 2020  d; ".           
+0007bc30: 2020 2020 2020 2020 2022 6c61 6265 6c3d           "label=
+0007bc40: 5c22 222c 0a20 2020 2020 2020 2020 2020  \"",.           
+0007bc50: 2020 2020 2028 766f 6964 202a 2920 6e6f       (void *) no
+0007bc60: 6465 2c20 636f 6c6f 7229 3b0a 0a20 2020  de, color);..   
+0007bc70: 2020 2020 2069 6620 2873 7472 6c65 6e28       if (strlen(
+0007bc80: 6e6f 6465 2d3e 6e61 6d65 2920 3e20 3029  node->name) > 0)
+0007bc90: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0007bca0: 7072 696e 7466 2866 702c 2022 2573 207c  printf(fp, "%s |
+0007bcb0: 222c 206e 6f64 652d 3e6e 616d 6529 3b0a  ", node->name);.
+0007bcc0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0007bcd0: 2020 2069 6620 286e 6f64 652d 3e6e 5f64     if (node->n_d
+0007bce0: 696d 7320 3d3d 2032 2920 7b0a 2020 2020  ims == 2) {.    
+0007bcf0: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+0007bd00: 6670 2c20 2225 6420 5b25 6a64 2c20 256a  fp, "%d [%jd, %j
+0007bd10: 645d 207c 203c 783e 2573 222c 2069 2c20  d] | <x>%s", i, 
+0007bd20: 6e6f 6465 2d3e 6e65 5b30 5d2c 206e 6f64  node->ne[0], nod
+0007bd30: 652d 3e6e 655b 315d 2c20 4747 4d4c 5f4f  e->ne[1], GGML_O
+0007bd40: 505f 5359 4d42 4f4c 5b6e 6f64 652d 3e6f  P_SYMBOL[node->o
+0007bd50: 705d 293b 0a20 2020 2020 2020 207d 2065  p]);.        } e
+0007bd60: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+0007bd70: 2020 6670 7269 6e74 6628 6670 2c20 2225    fprintf(fp, "%
+0007bd80: 6420 5b25 6a64 2c20 256a 642c 2025 6a64  d [%jd, %jd, %jd
+0007bd90: 5d20 7c20 3c78 3e25 7322 2c20 692c 206e  ] | <x>%s", i, n
+0007bda0: 6f64 652d 3e6e 655b 305d 2c20 6e6f 6465  ode->ne[0], node
+0007bdb0: 2d3e 6e65 5b31 5d2c 206e 6f64 652d 3e6e  ->ne[1], node->n
+0007bdc0: 655b 325d 2c20 4747 4d4c 5f4f 505f 5359  e[2], GGML_OP_SY
+0007bdd0: 4d42 4f4c 5b6e 6f64 652d 3e6f 705d 293b  MBOL[node->op]);
+0007bde0: 0a20 2020 2020 2020 207d 0a0a 0a20 2020  .        }...   
+0007bdf0: 2020 2020 2069 6620 286e 6f64 652d 3e67       if (node->g
+0007be00: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0007be10: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+0007be20: 207c 203c 673e 2573 5c22 3b20 5d5c 6e22   | <g>%s\"; ]\n"
+0007be30: 2c20 4747 4d4c 5f4f 505f 5359 4d42 4f4c  , GGML_OP_SYMBOL
+0007be40: 5b6e 6f64 652d 3e67 7261 642d 3e6f 705d  [node->grad->op]
+0007be50: 293b 0a20 2020 2020 2020 207d 2065 6c73  );.        } els
+0007be60: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
+0007be70: 6670 7269 6e74 6628 6670 2c20 225c 223b  fprintf(fp, "\";
+0007be80: 205d 5c6e 2229 3b0a 2020 2020 2020 2020   ]\n");.        
+0007be90: 7d0a 2020 2020 7d0a 0a20 2020 2066 6f72  }.    }..    for
+0007bea0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0007beb0: 2067 622d 3e6e 5f6c 6561 6673 3b20 692b   gb->n_leafs; i+
+0007bec0: 2b29 207b 0a20 2020 2020 2020 2073 7472  +) {.        str
+0007bed0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0007bee0: 2a20 6e6f 6465 203d 2067 622d 3e6c 6561  * node = gb->lea
+0007bef0: 6673 5b69 5d3b 0a0a 2020 2020 2020 2020  fs[i];..        
+0007bf00: 736e 7072 696e 7466 2863 6f6c 6f72 2c20  snprintf(color, 
+0007bf10: 7369 7a65 6f66 2863 6f6c 6f72 292c 2022  sizeof(color), "
+0007bf20: 7069 6e6b 2229 3b0a 0a20 2020 2020 2020  pink");..       
+0007bf30: 2066 7072 696e 7466 2866 702c 2022 2020   fprintf(fp, "  
+0007bf40: 5c22 2570 5c22 205b 2022 0a20 2020 2020  \"%p\" [ ".     
+0007bf50: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0007bf60: 7374 796c 6520 3d20 6669 6c6c 6564 3b20  style = filled; 
+0007bf70: 6669 6c6c 636f 6c6f 7220 3d20 2573 3b20  fillcolor = %s; 
+0007bf80: 7368 6170 6520 3d20 7265 636f 7264 3b20  shape = record; 
+0007bf90: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0007bfa0: 2020 2020 2020 226c 6162 656c 3d5c 223c        "label=\"<
+0007bfb0: 783e 222c 0a20 2020 2020 2020 2020 2020  x>",.           
+0007bfc0: 2020 2020 2028 766f 6964 202a 2920 6e6f       (void *) no
+0007bfd0: 6465 2c20 636f 6c6f 7229 3b0a 0a20 2020  de, color);..   
+0007bfe0: 2020 2020 2069 6620 2873 7472 6c65 6e28       if (strlen(
+0007bff0: 6e6f 6465 2d3e 6e61 6d65 2920 3e20 3029  node->name) > 0)
+0007c000: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007c010: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+0007c020: 2573 207c 2022 2c20 6e6f 6465 2d3e 6e61  %s | ", node->na
+0007c030: 6d65 293b 0a20 2020 2020 2020 207d 0a20  me);.        }. 
+0007c040: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
+0007c050: 6e65 6c65 6d65 6e74 7328 6e6f 6465 2920  nelements(node) 
+0007c060: 3d3d 2031 2920 7b0a 2020 2020 2020 2020  == 1) {.        
+0007c070: 2020 2020 6966 2028 6e6f 6465 2d3e 7479      if (node->ty
+0007c080: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+0007c090: 4938 207c 7c20 6e6f 6465 2d3e 7479 7065  I8 || node->type
+0007c0a0: 203d 3d20 4747 4d4c 5f54 5950 455f 4931   == GGML_TYPE_I1
+0007c0b0: 3620 7c7c 206e 6f64 652d 3e74 7970 6520  6 || node->type 
+0007c0c0: 3d3d 2047 474d 4c5f 5459 5045 5f49 3332  == GGML_TYPE_I32
+0007c0d0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007c0e0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0007c0f0: 2225 6422 2c20 6767 6d6c 5f67 6574 5f69  "%d", ggml_get_i
+0007c100: 3332 5f31 6428 6e6f 6465 2c20 3029 293b  32_1d(node, 0));
+0007c110: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0007c120: 2020 2020 2020 2020 2020 2065 6c73 6520             else 
+0007c130: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c140: 2020 6670 7269 6e74 6628 6670 2c20 2225    fprintf(fp, "%
+0007c150: 2e31 6522 2c20 2864 6f75 626c 6529 6767  .1e", (double)gg
+0007c160: 6d6c 5f67 6574 5f66 3332 5f31 6428 6e6f  ml_get_f32_1d(no
+0007c170: 6465 2c20 3029 293b 0a20 2020 2020 2020  de, 0));.       
+0007c180: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+0007c190: 0a20 2020 2020 2020 2065 6c73 6520 7b0a  .        else {.
+0007c1a0: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
+0007c1b0: 6e74 6628 6670 2c20 2243 4f4e 5354 2025  ntf(fp, "CONST %
+0007c1c0: 6420 5b25 6a64 2c20 256a 645d 222c 2069  d [%jd, %jd]", i
+0007c1d0: 2c20 6e6f 6465 2d3e 6e65 5b30 5d2c 206e  , node->ne[0], n
+0007c1e0: 6f64 652d 3e6e 655b 315d 293b 0a20 2020  ode->ne[1]);.   
+0007c1f0: 2020 2020 207d 0a20 2020 2020 2020 2066       }.        f
+0007c200: 7072 696e 7466 2866 702c 2022 5c22 3b20  printf(fp, "\"; 
+0007c210: 5d5c 6e22 293b 0a20 2020 207d 0a0a 2020  ]\n");.    }..  
+0007c220: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0007c230: 3b20 6920 3c20 6762 2d3e 6e5f 6e6f 6465  ; i < gb->n_node
+0007c240: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
+0007c250: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0007c260: 6e73 6f72 202a 206e 6f64 6520 3d20 6762  nsor * node = gb
+0007c270: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
+0007c280: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0007c290: 5f74 656e 736f 7220 2a20 7061 7265 6e74  _tensor * parent
+0007c2a0: 203d 2067 676d 6c5f 6772 6170 685f 6765   = ggml_graph_ge
+0007c2b0: 745f 7061 7265 6e74 2867 622c 206e 6f64  t_parent(gb, nod
+0007c2c0: 6529 3b0a 0a20 2020 2020 2020 2069 6620  e);..        if 
+0007c2d0: 286e 6f64 652d 3e73 7263 3029 207b 0a20  (node->src0) {. 
+0007c2e0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
+0007c2f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0007c300: 7061 7265 6e74 3020 3d20 6767 6d6c 5f67  parent0 = ggml_g
+0007c310: 7261 7068 5f67 6574 5f70 6172 656e 7428  raph_get_parent(
+0007c320: 6762 2c20 6e6f 6465 2d3e 7372 6330 293b  gb, node->src0);
+0007c330: 0a0a 2020 2020 2020 2020 2020 2020 6670  ..            fp
+0007c340: 7269 6e74 6628 6670 2c20 2220 205c 2225  rintf(fp, "  \"%
+0007c350: 705c 223a 2573 202d 3e20 5c22 2570 5c22  p\":%s -> \"%p\"
+0007c360: 3a25 7320 5b20 6172 726f 7768 6561 6420  :%s [ arrowhead 
+0007c370: 3d20 2573 3b20 7374 796c 6520 3d20 2573  = %s; style = %s
+0007c380: 3b20 6c61 6265 6c20 3d20 5c22 785c 223b  ; label = \"x\";
+0007c390: 205d 5c6e 222c 0a20 2020 2020 2020 2020   ]\n",.         
+0007c3a0: 2020 2020 2020 2020 2020 2070 6172 656e             paren
+0007c3b0: 7430 203f 2028 766f 6964 202a 2920 7061  t0 ? (void *) pa
+0007c3c0: 7265 6e74 3020 3a20 2876 6f69 6420 2a29  rent0 : (void *)
+0007c3d0: 206e 6f64 652d 3e73 7263 302c 0a20 2020   node->src0,.   
+0007c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c3f0: 2070 6172 656e 7430 203f 2022 6722 203a   parent0 ? "g" :
+0007c400: 2022 7822 2c0a 2020 2020 2020 2020 2020   "x",.          
+0007c410: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+0007c420: 203f 2028 766f 6964 202a 2920 7061 7265   ? (void *) pare
+0007c430: 6e74 203a 2028 766f 6964 202a 2920 6e6f  nt : (void *) no
+0007c440: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
+0007c450: 2020 2020 2020 2020 7061 7265 6e74 203f          parent ?
+0007c460: 2022 6722 203a 2022 7822 2c0a 2020 2020   "g" : "x",.    
+0007c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c480: 7061 7265 6e74 203f 2022 656d 7074 7922  parent ? "empty"
+0007c490: 203a 2022 7665 6522 2c0a 2020 2020 2020   : "vee",.      
+0007c4a0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0007c4b0: 7265 6e74 203f 2022 6461 7368 6564 2220  rent ? "dashed" 
+0007c4c0: 3a20 2273 6f6c 6964 2229 3b0a 2020 2020  : "solid");.    
+0007c4d0: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+0007c4e0: 6620 286e 6f64 652d 3e73 7263 3129 207b  f (node->src1) {
+0007c4f0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+0007c500: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0007c510: 2a20 7061 7265 6e74 3120 3d20 6767 6d6c  * parent1 = ggml
+0007c520: 5f67 7261 7068 5f67 6574 5f70 6172 656e  _graph_get_paren
+0007c530: 7428 6762 2c20 6e6f 6465 2d3e 7372 6331  t(gb, node->src1
+0007c540: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0007c550: 6670 7269 6e74 6628 6670 2c20 2220 205c  fprintf(fp, "  \
+0007c560: 2225 705c 223a 2573 202d 3e20 5c22 2570  "%p\":%s -> \"%p
+0007c570: 5c22 3a25 7320 5b20 6172 726f 7768 6561  \":%s [ arrowhea
+0007c580: 6420 3d20 2573 3b20 7374 796c 6520 3d20  d = %s; style = 
+0007c590: 2573 3b20 6c61 6265 6c20 3d20 5c22 795c  %s; label = \"y\
+0007c5a0: 223b 205d 5c6e 222c 0a20 2020 2020 2020  "; ]\n",.       
+0007c5b0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0007c5c0: 656e 7431 203f 2028 766f 6964 202a 2920  ent1 ? (void *) 
+0007c5d0: 7061 7265 6e74 3120 3a20 2876 6f69 6420  parent1 : (void 
+0007c5e0: 2a29 206e 6f64 652d 3e73 7263 312c 0a20  *) node->src1,. 
+0007c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c600: 2020 2070 6172 656e 7431 203f 2022 6722     parent1 ? "g"
+0007c610: 203a 2022 7822 2c0a 2020 2020 2020 2020   : "x",.        
+0007c620: 2020 2020 2020 2020 2020 2020 7061 7265              pare
+0007c630: 6e74 203f 2028 766f 6964 202a 2920 7061  nt ? (void *) pa
+0007c640: 7265 6e74 203a 2028 766f 6964 202a 2920  rent : (void *) 
+0007c650: 6e6f 6465 2c0a 2020 2020 2020 2020 2020  node,.          
+0007c660: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
+0007c670: 203f 2022 6722 203a 2022 7822 2c0a 2020   ? "g" : "x",.  
+0007c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c690: 2020 7061 7265 6e74 203f 2022 656d 7074    parent ? "empt
+0007c6a0: 7922 203a 2022 7665 6522 2c0a 2020 2020  y" : "vee",.    
+0007c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c6c0: 7061 7265 6e74 203f 2022 6461 7368 6564  parent ? "dashed
+0007c6d0: 2220 3a20 2273 6f6c 6964 2229 3b0a 2020  " : "solid");.  
+0007c6e0: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+0007c6f0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+0007c700: 303b 2069 203c 2067 622d 3e6e 5f6c 6561  0; i < gb->n_lea
+0007c710: 6673 3b20 692b 2b29 207b 0a20 2020 2020  fs; i++) {.     
+0007c720: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0007c730: 656e 736f 7220 2a20 6e6f 6465 203d 2067  ensor * node = g
+0007c740: 622d 3e6c 6561 6673 5b69 5d3b 0a0a 2020  b->leafs[i];..  
+0007c750: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+0007c760: 7372 6330 2920 7b0a 2020 2020 2020 2020  src0) {.        
+0007c770: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0007c780: 2220 205c 2225 705c 223a 2573 202d 3e20  "  \"%p\":%s -> 
+0007c790: 5c22 2570 5c22 3a25 7320 5b20 6c61 6265  \"%p\":%s [ labe
+0007c7a0: 6c20 3d20 5c22 785c 223b 205d 5c6e 222c  l = \"x\"; ]\n",
+0007c7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c7c0: 2020 2020 2028 766f 6964 202a 2920 6e6f       (void *) no
+0007c7d0: 6465 2d3e 7372 6330 2c20 2278 222c 0a20  de->src0, "x",. 
+0007c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c7f0: 2020 2028 766f 6964 202a 2920 6e6f 6465     (void *) node
+0007c800: 2c20 2278 2229 3b0a 2020 2020 2020 2020  , "x");.        
+0007c810: 7d0a 0a20 2020 2020 2020 2069 6620 286e  }..        if (n
+0007c820: 6f64 652d 3e73 7263 3129 207b 0a20 2020  ode->src1) {.   
+0007c830: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
+0007c840: 2866 702c 2022 2020 5c22 2570 5c22 3a25  (fp, "  \"%p\":%
+0007c850: 7320 2d3e 205c 2225 705c 223a 2573 205b  s -> \"%p\":%s [
+0007c860: 206c 6162 656c 203d 205c 2279 5c22 3b20   label = \"y\"; 
+0007c870: 5d5c 6e22 2c0a 2020 2020 2020 2020 2020  ]\n",.          
+0007c880: 2020 2020 2020 2020 2020 2876 6f69 6420            (void 
+0007c890: 2a29 206e 6f64 652d 3e73 7263 312c 2022  *) node->src1, "
+0007c8a0: 7822 2c0a 2020 2020 2020 2020 2020 2020  x",.            
+0007c8b0: 2020 2020 2020 2020 2876 6f69 6420 2a29          (void *)
+0007c8c0: 206e 6f64 652c 2022 7822 293b 0a20 2020   node, "x");.   
+0007c8d0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
+0007c8e0: 2020 6670 7269 6e74 6628 6670 2c20 227d    fprintf(fp, "}
+0007c8f0: 5c6e 2229 3b0a 0a20 2020 2066 636c 6f73  \n");..    fclos
+0007c900: 6528 6670 293b 0a0a 2020 2020 4747 4d4c  e(fp);..    GGML
+0007c910: 5f50 5249 4e54 2822 2573 3a20 646f 7420  _PRINT("%s: dot 
+0007c920: 2d54 706e 6720 2573 202d 6f20 2573 2e70  -Tpng %s -o %s.p
+0007c930: 6e67 2026 2620 6f70 656e 2025 732e 706e  ng && open %s.pn
+0007c940: 675c 6e22 2c20 5f5f 6675 6e63 5f5f 2c20  g\n", __func__, 
+0007c950: 6669 6c65 6e61 6d65 2c20 6669 6c65 6e61  filename, filena
+0007c960: 6d65 2c20 6669 6c65 6e61 6d65 293b 0a7d  me, filename);.}
+0007c970: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
 0007c980: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 0007c990: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 0007c9a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0007c9b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a73  /////////////..s
-0007c9c0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0007c9d0: 6f70 745f 7365 745f 7061 7261 6d73 2869  opt_set_params(i
-0007c9e0: 6e74 206e 702c 2073 7472 7563 7420 6767  nt np, struct gg
-0007c9f0: 6d6c 5f74 656e 736f 7220 2a20 636f 6e73  ml_tensor * cons
-0007ca00: 7420 7073 5b5d 2c20 636f 6e73 7420 666c  t ps[], const fl
-0007ca10: 6f61 7420 2a20 7829 207b 0a20 2020 2069  oat * x) {.    i
-0007ca20: 6e74 2069 203d 2030 3b0a 2020 2020 666f  nt i = 0;.    fo
-0007ca30: 7220 2869 6e74 2070 203d 2030 3b20 7020  r (int p = 0; p 
-0007ca40: 3c20 6e70 3b20 2b2b 7029 207b 0a20 2020  < np; ++p) {.   
-0007ca50: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0007ca60: 5f74 206e 6520 3d20 6767 6d6c 5f6e 656c  _t ne = ggml_nel
-0007ca70: 656d 656e 7473 2870 735b 705d 2920 3b0a  ements(ps[p]) ;.
-0007ca80: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-0007ca90: 2061 6464 2066 756e 6374 696f 6e20 746f   add function to
-0007caa0: 2073 6574 2074 656e 736f 7220 6672 6f6d   set tensor from
-0007cab0: 2061 7272 6179 0a20 2020 2020 2020 2066   array.        f
-0007cac0: 6f72 2028 696e 7436 345f 7420 6a20 3d20  or (int64_t j = 
-0007cad0: 303b 206a 203c 206e 653b 202b 2b6a 2920  0; j < ne; ++j) 
-0007cae0: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
-0007caf0: 6d6c 5f73 6574 5f66 3332 5f31 6428 7073  ml_set_f32_1d(ps
-0007cb00: 5b70 5d2c 206a 2c20 785b 692b 2b5d 293b  [p], j, x[i++]);
-0007cb10: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0007cb20: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-0007cb30: 6767 6d6c 5f6f 7074 5f67 6574 5f70 6172  ggml_opt_get_par
-0007cb40: 616d 7328 696e 7420 6e70 2c20 7374 7275  ams(int np, stru
-0007cb50: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0007cb60: 2063 6f6e 7374 2070 735b 5d2c 2066 6c6f   const ps[], flo
-0007cb70: 6174 202a 2078 2920 7b0a 2020 2020 696e  at * x) {.    in
-0007cb80: 7420 6920 3d20 303b 0a20 2020 2066 6f72  t i = 0;.    for
-0007cb90: 2028 696e 7420 7020 3d20 303b 2070 203c   (int p = 0; p <
-0007cba0: 206e 703b 202b 2b70 2920 7b0a 2020 2020   np; ++p) {.    
-0007cbb0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0007cbc0: 7420 6e65 203d 2067 676d 6c5f 6e65 6c65  t ne = ggml_nele
-0007cbd0: 6d65 6e74 7328 7073 5b70 5d29 203b 0a20  ments(ps[p]) ;. 
-0007cbe0: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
-0007cbf0: 6164 6420 6675 6e63 7469 6f6e 2074 6f20  add function to 
-0007cc00: 6765 7420 616c 6c20 656c 656d 656e 7473  get all elements
-0007cc10: 2061 7420 6f6e 6365 0a20 2020 2020 2020   at once.       
-0007cc20: 2066 6f72 2028 696e 7436 345f 7420 6a20   for (int64_t j 
-0007cc30: 3d20 303b 206a 203c 206e 653b 202b 2b6a  = 0; j < ne; ++j
-0007cc40: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007cc50: 785b 692b 2b5d 203d 2067 676d 6c5f 6765  x[i++] = ggml_ge
-0007cc60: 745f 6633 325f 3164 2870 735b 705d 2c20  t_f32_1d(ps[p], 
-0007cc70: 6a29 3b0a 2020 2020 2020 2020 7d0a 2020  j);.        }.  
-0007cc80: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-0007cc90: 6964 2067 676d 6c5f 6f70 745f 6765 745f  id ggml_opt_get_
-0007cca0: 6772 6164 2869 6e74 206e 702c 2073 7472  grad(int np, str
-0007ccb0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0007ccc0: 2a20 636f 6e73 7420 7073 5b5d 2c20 666c  * const ps[], fl
-0007ccd0: 6f61 7420 2a20 6729 207b 0a20 2020 2069  oat * g) {.    i
-0007cce0: 6e74 2069 203d 2030 3b0a 2020 2020 666f  nt i = 0;.    fo
-0007ccf0: 7220 2869 6e74 2070 203d 2030 3b20 7020  r (int p = 0; p 
-0007cd00: 3c20 6e70 3b20 2b2b 7029 207b 0a20 2020  < np; ++p) {.   
-0007cd10: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0007cd20: 5f74 206e 6520 3d20 6767 6d6c 5f6e 656c  _t ne = ggml_nel
-0007cd30: 656d 656e 7473 2870 735b 705d 2920 3b0a  ements(ps[p]) ;.
-0007cd40: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-0007cd50: 2061 6464 2066 756e 6374 696f 6e20 746f   add function to
-0007cd60: 2067 6574 2061 6c6c 2065 6c65 6d65 6e74   get all element
-0007cd70: 7320 6174 206f 6e63 650a 2020 2020 2020  s at once.      
-0007cd80: 2020 666f 7220 2869 6e74 3634 5f74 206a    for (int64_t j
-0007cd90: 203d 2030 3b20 6a20 3c20 6e65 3b20 2b2b   = 0; j < ne; ++
-0007cda0: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-0007cdb0: 2067 5b69 2b2b 5d20 3d20 6767 6d6c 5f67   g[i++] = ggml_g
-0007cdc0: 6574 5f66 3332 5f31 6428 7073 5b70 5d2d  et_f32_1d(ps[p]-
-0007cdd0: 3e67 7261 642c 206a 293b 0a20 2020 2020  >grad, j);.     
-0007cde0: 2020 207d 0a20 2020 207d 0a7d 0a0a 2f2f     }.    }.}..//
-0007cdf0: 0a2f 2f20 4144 414d 0a2f 2f0a 2f2f 2020  .// ADAM.//.//  
-0007ce00: 2072 6566 3a20 6874 7470 733a 2f2f 6172   ref: https://ar
-0007ce10: 7869 762e 6f72 672f 7064 662f 3134 3132  xiv.org/pdf/1412
-0007ce20: 2e36 3938 302e 7064 660a 2f2f 0a0a 7374  .6980.pdf.//..st
-0007ce30: 6174 6963 2065 6e75 6d20 6767 6d6c 5f6f  atic enum ggml_o
-0007ce40: 7074 5f72 6573 756c 7420 6767 6d6c 5f6f  pt_result ggml_o
-0007ce50: 7074 5f61 6461 6d28 0a20 2020 2020 2020  pt_adam(.       
-0007ce60: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
-0007ce70: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
-0007ce80: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0007ce90: 6f70 745f 7061 7261 6d73 2070 6172 616d  opt_params param
-0007cea0: 732c 0a20 2020 2020 2020 2073 7472 7563  s,.        struc
-0007ceb0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0007cec0: 662c 0a20 2020 2020 2020 2073 7472 7563  f,.        struc
-0007ced0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-0007cee0: 6766 2c0a 2020 2020 2020 2020 7374 7275  gf,.        stru
-0007cef0: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
-0007cf00: 2067 6229 207b 0a20 2020 2047 474d 4c5f   gb) {.    GGML_
-0007cf10: 4153 5345 5254 2867 676d 6c5f 6973 5f73  ASSERT(ggml_is_s
-0007cf20: 6361 6c61 7228 6629 293b 0a0a 2020 2020  calar(f));..    
-0007cf30: 6766 2d3e 6e5f 7468 7265 6164 7320 3d20  gf->n_threads = 
-0007cf40: 7061 7261 6d73 2e6e 5f74 6872 6561 6473  params.n_threads
-0007cf50: 3b0a 2020 2020 6762 2d3e 6e5f 7468 7265  ;.    gb->n_thre
-0007cf60: 6164 7320 3d20 7061 7261 6d73 2e6e 5f74  ads = params.n_t
-0007cf70: 6872 6561 6473 3b0a 0a20 2020 202f 2f20  hreads;..    // 
-0007cf80: 7468 6573 6520 7769 6c6c 2073 746f 7265  these will store
-0007cf90: 2074 6865 2070 6172 616d 6574 6572 7320   the parameters 
-0007cfa0: 7765 2077 616e 7420 746f 206f 7074 696d  we want to optim
-0007cfb0: 697a 650a 2020 2020 7374 7275 6374 2067  ize.    struct g
-0007cfc0: 676d 6c5f 7465 6e73 6f72 202a 2070 735b  gml_tensor * ps[
-0007cfd0: 4747 4d4c 5f4d 4158 5f50 4152 414d 535d  GGML_MAX_PARAMS]
-0007cfe0: 3b0a 0a20 2020 2069 6e74 206e 7020 3d20  ;..    int np = 
-0007cff0: 303b 0a20 2020 2069 6e74 206e 7820 3d20  0;.    int nx = 
-0007d000: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
-0007d010: 6920 3d20 303b 2069 203c 2067 662d 3e6e  i = 0; i < gf->n
-0007d020: 5f6e 6f64 6573 3b20 2b2b 6929 207b 0a20  _nodes; ++i) {. 
-0007d030: 2020 2020 2020 2069 6620 2867 662d 3e6e         if (gf->n
-0007d040: 6f64 6573 5b69 5d2d 3e69 735f 7061 7261  odes[i]->is_para
-0007d050: 6d29 207b 0a20 2020 2020 2020 2020 2020  m) {.           
-0007d060: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
-0007d070: 4728 2266 6f75 6e64 2070 6172 616d 2025  G("found param %
-0007d080: 643a 2067 7261 642d 3e6f 7020 3d20 2564  d: grad->op = %d
-0007d090: 5c6e 222c 206e 702c 2067 662d 3e6e 6f64  \n", np, gf->nod
-0007d0a0: 6573 5b69 5d2d 3e67 7261 642d 3e6f 7029  es[i]->grad->op)
-0007d0b0: 3b0a 0a20 2020 2020 2020 2020 2020 2047  ;..            G
-0007d0c0: 474d 4c5f 4153 5345 5254 286e 7020 3c20  GML_ASSERT(np < 
-0007d0d0: 4747 4d4c 5f4d 4158 5f50 4152 414d 5329  GGML_MAX_PARAMS)
-0007d0e0: 3b0a 0a20 2020 2020 2020 2020 2020 2070  ;..            p
-0007d0f0: 735b 6e70 2b2b 5d20 3d20 6766 2d3e 6e6f  s[np++] = gf->no
-0007d100: 6465 735b 695d 3b0a 2020 2020 2020 2020  des[i];.        
-0007d110: 2020 2020 6e78 202b 3d20 6767 6d6c 5f6e      nx += ggml_n
-0007d120: 656c 656d 656e 7473 2867 662d 3e6e 6f64  elements(gf->nod
-0007d130: 6573 5b69 5d29 3b0a 2020 2020 2020 2020  es[i]);.        
-0007d140: 7d0a 2020 2020 7d0a 0a20 2020 202f 2f20  }.    }..    // 
-0007d150: 636f 6e73 7461 6e74 730a 2020 2020 636f  constants.    co
-0007d160: 6e73 7420 666c 6f61 7420 616c 7068 6120  nst float alpha 
-0007d170: 3d20 7061 7261 6d73 2e61 6461 6d2e 616c  = params.adam.al
-0007d180: 7068 613b 0a20 2020 2063 6f6e 7374 2066  pha;.    const f
-0007d190: 6c6f 6174 2062 6574 6131 203d 2070 6172  loat beta1 = par
-0007d1a0: 616d 732e 6164 616d 2e62 6574 6131 3b0a  ams.adam.beta1;.
-0007d1b0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0007d1c0: 6265 7461 3220 3d20 7061 7261 6d73 2e61  beta2 = params.a
-0007d1d0: 6461 6d2e 6265 7461 323b 0a20 2020 2063  dam.beta2;.    c
-0007d1e0: 6f6e 7374 2066 6c6f 6174 2065 7073 2020  onst float eps  
-0007d1f0: 203d 2070 6172 616d 732e 6164 616d 2e65   = params.adam.e
-0007d200: 7073 3b0a 0a20 2020 2066 6c6f 6174 202a  ps;..    float *
-0007d210: 2078 2020 3d20 6767 6d6c 5f6e 6577 5f74   x  = ggml_new_t
-0007d220: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
-0007d230: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
-0007d240: 2d3e 6461 7461 3b20 2f2f 2076 6965 7720  ->data; // view 
-0007d250: 6f66 2074 6865 2070 6172 616d 6574 6572  of the parameter
-0007d260: 730a 2020 2020 666c 6f61 7420 2a20 6731  s.    float * g1
-0007d270: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
-0007d280: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
-0007d290: 5459 5045 5f46 3332 2c20 6e78 292d 3e64  TYPE_F32, nx)->d
-0007d2a0: 6174 613b 202f 2f20 6772 6164 6965 6e74  ata; // gradient
-0007d2b0: 0a20 2020 2066 6c6f 6174 202a 2067 3220  .    float * g2 
-0007d2c0: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0007d2d0: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0007d2e0: 5950 455f 4633 322c 206e 7829 2d3e 6461  YPE_F32, nx)->da
-0007d2f0: 7461 3b20 2f2f 2067 7261 6469 656e 7420  ta; // gradient 
-0007d300: 7371 7561 7265 640a 2020 2020 666c 6f61  squared.    floa
-0007d310: 7420 2a20 6d20 203d 2067 676d 6c5f 6e65  t * m  = ggml_ne
-0007d320: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-0007d330: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
-0007d340: 6e78 292d 3e64 6174 613b 202f 2f20 6669  nx)->data; // fi
-0007d350: 7273 7420 6d6f 6d65 6e74 0a20 2020 2066  rst moment.    f
-0007d360: 6c6f 6174 202a 2076 2020 3d20 6767 6d6c  loat * v  = ggml
-0007d370: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
-0007d380: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-0007d390: 322c 206e 7829 2d3e 6461 7461 3b20 2f2f  2, nx)->data; //
-0007d3a0: 2073 6563 6f6e 6420 6d6f 6d65 6e74 0a20   second moment. 
-0007d3b0: 2020 2066 6c6f 6174 202a 206d 6820 3d20     float * mh = 
-0007d3c0: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-0007d3d0: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-0007d3e0: 455f 4633 322c 206e 7829 2d3e 6461 7461  E_F32, nx)->data
-0007d3f0: 3b20 2f2f 2066 6972 7374 206d 6f6d 656e  ; // first momen
-0007d400: 7420 6861 740a 2020 2020 666c 6f61 7420  t hat.    float 
-0007d410: 2a20 7668 203d 2067 676d 6c5f 6e65 775f  * vh = ggml_new_
-0007d420: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-0007d430: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
-0007d440: 292d 3e64 6174 613b 202f 2f20 7365 636f  )->data; // seco
-0007d450: 6e64 206d 6f6d 656e 7420 6861 740a 0a20  nd moment hat.. 
-0007d460: 2020 2066 6c6f 6174 202a 2070 6620 3d20     float * pf = 
-0007d470: 7061 7261 6d73 2e70 6173 7420 3e20 3020  params.past > 0 
-0007d480: 3f20 6767 6d6c 5f6e 6577 5f74 656e 736f  ? ggml_new_tenso
-0007d490: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0007d4a0: 5950 455f 4633 322c 2070 6172 616d 732e  YPE_F32, params.
-0007d4b0: 7061 7374 292d 3e64 6174 6120 3a20 4e55  past)->data : NU
-0007d4c0: 4c4c 3b20 2f2f 2070 6173 7420 6675 6e63  LL; // past func
-0007d4d0: 7469 6f6e 2076 616c 7565 730a 0a20 2020  tion values..   
-0007d4e0: 202f 2f20 696e 6974 6961 6c69 7a65 0a20   // initialize. 
-0007d4f0: 2020 2067 676d 6c5f 7665 635f 7365 745f     ggml_vec_set_
-0007d500: 6633 3228 6e78 2c20 6d2c 2030 2e30 6629  f32(nx, m, 0.0f)
-0007d510: 3b0a 2020 2020 6767 6d6c 5f76 6563 5f73  ;.    ggml_vec_s
-0007d520: 6574 5f66 3332 286e 782c 2076 2c20 302e  et_f32(nx, v, 0.
-0007d530: 3066 293b 0a0a 2020 2020 2f2f 2075 7064  0f);..    // upd
-0007d540: 6174 6520 7669 6577 0a20 2020 2067 676d  ate view.    ggm
-0007d550: 6c5f 6f70 745f 6765 745f 7061 7261 6d73  l_opt_get_params
-0007d560: 286e 702c 2070 732c 2078 293b 0a0a 2020  (np, ps, x);..  
-0007d570: 2020 2f2f 2063 6f6d 7075 7465 2074 6865    // compute the
-0007d580: 2066 756e 6374 696f 6e20 7661 6c75 650a   function value.
-0007d590: 2020 2020 6767 6d6c 5f67 7261 7068 5f72      ggml_graph_r
-0007d5a0: 6573 6574 2020 2867 6629 3b0a 2020 2020  eset  (gf);.    
-0007d5b0: 6767 6d6c 5f73 6574 5f66 3332 2020 2020  ggml_set_f32    
-0007d5c0: 2020 2866 2d3e 6772 6164 2c20 312e 3066    (f->grad, 1.0f
-0007d5d0: 293b 0a20 2020 2067 676d 6c5f 6772 6170  );.    ggml_grap
-0007d5e0: 685f 636f 6d70 7574 6528 6374 782c 2067  h_compute(ctx, g
-0007d5f0: 6229 3b0a 0a20 2020 2066 6c6f 6174 2066  b);..    float f
-0007d600: 785f 7072 6576 203d 2067 676d 6c5f 6765  x_prev = ggml_ge
-0007d610: 745f 6633 325f 3164 2866 2c20 3029 3b0a  t_f32_1d(f, 0);.
-0007d620: 2020 2020 6966 2028 7066 2920 7b0a 2020      if (pf) {.  
-0007d630: 2020 2020 2020 7066 5b30 5d20 3d20 6678        pf[0] = fx
-0007d640: 5f70 7265 763b 0a20 2020 207d 0a0a 2020  _prev;.    }..  
-0007d650: 2020 696e 7420 6e5f 6e6f 5f69 6d70 726f    int n_no_impro
-0007d660: 7665 6d65 6e74 203d 2030 3b0a 2020 2020  vement = 0;.    
-0007d670: 666c 6f61 7420 6678 5f62 6573 7420 3d20  float fx_best = 
-0007d680: 6678 5f70 7265 763b 0a0a 2020 2020 2f2f  fx_prev;..    //
-0007d690: 2072 756e 2074 6865 206f 7074 696d 697a   run the optimiz
-0007d6a0: 6572 0a20 2020 2066 6f72 2028 696e 7420  er.    for (int 
-0007d6b0: 7420 3d20 303b 2074 203c 2070 6172 616d  t = 0; t < param
-0007d6c0: 732e 6164 616d 2e6e 5f69 7465 723b 202b  s.adam.n_iter; +
-0007d6d0: 2b74 2920 7b0a 2020 2020 2020 2020 4747  +t) {.        GG
-0007d6e0: 4d4c 5f50 5249 4e54 5f44 4542 5547 2020  ML_PRINT_DEBUG  
-0007d6f0: 2822 3d3d 3d20 6974 6572 2025 6420 3d3d  ("=== iter %d ==
-0007d700: 3d5c 6e22 2c20 7429 3b0a 0a20 2020 2020  =\n", t);..     
-0007d710: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
-0007d720: 4255 4720 2028 2266 2020 2020 2020 3d20  BUG  ("f      = 
-0007d730: 2531 302e 3666 5c6e 222c 2067 676d 6c5f  %10.6f\n", ggml_
-0007d740: 6765 745f 6633 325f 3164 2866 2c20 3029  get_f32_1d(f, 0)
-0007d750: 293b 0a20 2020 2020 2020 2047 474d 4c5f  );.        GGML_
-0007d760: 5052 494e 545f 4445 4255 475f 3528 2264  PRINT_DEBUG_5("d
-0007d770: 662f 6478 3020 3d20 2531 302e 3666 5c6e  f/dx0 = %10.6f\n
-0007d780: 222c 2067 676d 6c5f 6765 745f 6633 325f  ", ggml_get_f32_
-0007d790: 3164 2870 735b 305d 2d3e 6772 6164 2c20  1d(ps[0]->grad, 
-0007d7a0: 3029 293b 0a20 2020 2020 2020 2047 474d  0));.        GGM
-0007d7b0: 4c5f 5052 494e 545f 4445 4255 475f 3528  L_PRINT_DEBUG_5(
-0007d7c0: 2264 662f 6478 3120 3d20 2531 302e 3666  "df/dx1 = %10.6f
-0007d7d0: 5c6e 222c 2067 676d 6c5f 6765 745f 6633  \n", ggml_get_f3
-0007d7e0: 325f 3164 2870 735b 315d 2d3e 6772 6164  2_1d(ps[1]->grad
-0007d7f0: 2c20 3029 293b 0a0a 2020 2020 2020 2020  , 0));..        
-0007d800: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0007d810: 6920 3c20 6e70 3b20 2b2b 6929 207b 0a20  i < np; ++i) {. 
-0007d820: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0007d830: 5052 494e 545f 4445 4255 4728 2270 6172  PRINT_DEBUG("par
-0007d840: 616d 2025 643a 2025 3130 2e36 662c 2067  am %d: %10.6f, g
-0007d850: 203d 2025 3130 2e36 665c 6e22 2c20 692c   = %10.6f\n", i,
-0007d860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d870: 2020 2020 2067 676d 6c5f 6765 745f 6633       ggml_get_f3
-0007d880: 325f 3164 2870 735b 695d 2c20 3029 2c20  2_1d(ps[i], 0), 
-0007d890: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
-0007d8a0: 7073 5b69 5d2d 3e67 7261 642c 2030 2929  ps[i]->grad, 0))
-0007d8b0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-0007d8c0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0007d8d0: 5f74 2074 5f73 7461 7274 5f77 616c 6c20  _t t_start_wall 
-0007d8e0: 3d20 6767 6d6c 5f74 696d 655f 7573 2829  = ggml_time_us()
-0007d8f0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0007d900: 696e 7436 345f 7420 745f 7374 6172 745f  int64_t t_start_
-0007d910: 6370 7520 3d20 6767 6d6c 5f63 7963 6c65  cpu = ggml_cycle
-0007d920: 7328 293b 0a20 2020 2020 2020 2055 4e55  s();.        UNU
-0007d930: 5345 4428 745f 7374 6172 745f 7761 6c6c  SED(t_start_wall
-0007d940: 293b 0a20 2020 2020 2020 2055 4e55 5345  );.        UNUSE
-0007d950: 4428 745f 7374 6172 745f 6370 7529 3b0a  D(t_start_cpu);.
-0007d960: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-0007d970: 2020 2020 2020 202f 2f20 7570 6461 7465         // update
-0007d980: 2074 6865 2067 7261 6469 656e 740a 2020   the gradient.  
-0007d990: 2020 2020 2020 2020 2020 6767 6d6c 5f6f            ggml_o
-0007d9a0: 7074 5f67 6574 5f67 7261 6428 6e70 2c20  pt_get_grad(np, 
-0007d9b0: 7073 2c20 6731 293b 0a0a 2020 2020 2020  ps, g1);..      
-0007d9c0: 2020 2020 2020 2f2f 206d 5f74 203d 2062        // m_t = b
-0007d9d0: 6574 6131 2a6d 5f74 2d31 202b 2028 3120  eta1*m_t-1 + (1 
-0007d9e0: 2d20 6265 7461 3129 2a67 5f74 0a20 2020  - beta1)*g_t.   
-0007d9f0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0007da00: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
-0007da10: 6d2c 2062 6574 6131 293b 0a20 2020 2020  m, beta1);.     
-0007da20: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0007da30: 6d61 645f 6633 3220 2028 6e78 2c20 6d2c  mad_f32  (nx, m,
-0007da40: 2067 312c 2031 2e30 6620 2d20 6265 7461   g1, 1.0f - beta
-0007da50: 3129 3b0a 0a20 2020 2020 2020 2020 2020  1);..           
-0007da60: 202f 2f20 6732 203d 2067 315e 320a 2020   // g2 = g1^2.  
-0007da70: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0007da80: 6563 5f73 7172 5f66 3332 2020 286e 782c  ec_sqr_f32  (nx,
-0007da90: 2067 322c 2067 3129 3b0a 0a20 2020 2020   g2, g1);..     
-0007daa0: 2020 2020 2020 202f 2f20 765f 7420 3d20         // v_t = 
-0007dab0: 6265 7461 322a 765f 742d 3120 2b20 2831  beta2*v_t-1 + (1
-0007dac0: 202d 2062 6574 6132 292a 675f 745e 320a   - beta2)*g_t^2.
-0007dad0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007dae0: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
-0007daf0: 782c 2076 2c20 6265 7461 3229 3b0a 2020  x, v, beta2);.  
-0007db00: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0007db10: 6563 5f6d 6164 5f66 3332 2020 286e 782c  ec_mad_f32  (nx,
-0007db20: 2076 2c20 6732 2c20 312e 3066 202d 2062   v, g2, 1.0f - b
-0007db30: 6574 6132 293b 0a0a 2020 2020 2020 2020  eta2);..        
-0007db40: 2020 2020 2f2f 206d 5e68 6174 203d 206d      // m^hat = m
-0007db50: 5f74 202f 2028 3120 2d20 6265 7461 315e  _t / (1 - beta1^
-0007db60: 7429 0a20 2020 2020 2020 2020 2020 202f  t).            /
-0007db70: 2f20 765e 6861 7420 3d20 765f 7420 2f20  / v^hat = v_t / 
-0007db80: 2831 202d 2062 6574 6132 5e74 290a 2020  (1 - beta2^t).  
-0007db90: 2020 2020 2020 2020 2020 2f2f 2078 5f74            // x_t
-0007dba0: 203d 2078 5f74 2d31 202d 2061 6c70 6861   = x_t-1 - alpha
-0007dbb0: 2a6d 5e68 6174 2f28 7371 7274 2876 5e68  *m^hat/(sqrt(v^h
-0007dbc0: 6174 2920 2b20 6570 7329 0a20 2020 2020  at) + eps).     
-0007dbd0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0007dbe0: 6370 795f 6633 3220 2028 6e78 2c20 6d68  cpy_f32  (nx, mh
-0007dbf0: 2c20 6d29 3b0a 2020 2020 2020 2020 2020  , m);.          
-0007dc00: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
-0007dc10: 3332 2020 286e 782c 2076 682c 2076 293b  32  (nx, vh, v);
-0007dc20: 0a0a 2020 2020 2020 2020 2020 2020 6767  ..            gg
-0007dc30: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
-0007dc40: 286e 782c 206d 682c 2061 6c70 6861 2f28  (nx, mh, alpha/(
-0007dc50: 312e 3066 202d 2070 6f77 6628 6265 7461  1.0f - powf(beta
-0007dc60: 312c 2074 202b 2031 2929 293b 0a20 2020  1, t + 1)));.   
-0007dc70: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0007dc80: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
-0007dc90: 7668 2c20 2031 2e30 662f 2831 2e30 6620  vh,  1.0f/(1.0f 
-0007dca0: 2d20 706f 7766 2862 6574 6132 2c20 7420  - powf(beta2, t 
-0007dcb0: 2b20 3129 2929 3b0a 0a20 2020 2020 2020  + 1)));..       
-0007dcc0: 2020 2020 2067 676d 6c5f 7665 635f 7371       ggml_vec_sq
-0007dcd0: 7274 5f66 3332 2028 6e78 2c20 7668 2c20  rt_f32 (nx, vh, 
-0007dce0: 7668 293b 0a20 2020 2020 2020 2020 2020  vh);.           
-0007dcf0: 2067 676d 6c5f 7665 635f 6163 6331 5f66   ggml_vec_acc1_f
-0007dd00: 3332 2028 6e78 2c20 7668 2c20 6570 7329  32 (nx, vh, eps)
-0007dd10: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
-0007dd20: 676d 6c5f 7665 635f 6469 765f 6633 3220  gml_vec_div_f32 
-0007dd30: 2028 6e78 2c20 6d68 2c20 6d68 2c20 7668   (nx, mh, mh, vh
-0007dd40: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
-0007dd50: 676d 6c5f 7665 635f 7375 625f 6633 3220  gml_vec_sub_f32 
-0007dd60: 2028 6e78 2c20 782c 2020 782c 2020 6d68   (nx, x,  x,  mh
-0007dd70: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0007dd80: 2f2f 2075 7064 6174 6520 7468 6520 7061  // update the pa
-0007dd90: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-0007dda0: 2020 2020 2067 676d 6c5f 6f70 745f 7365       ggml_opt_se
-0007ddb0: 745f 7061 7261 6d73 286e 702c 2070 732c  t_params(np, ps,
-0007ddc0: 2078 293b 0a20 2020 2020 2020 207d 0a0a   x);.        }..
-0007ddd0: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
-0007dde0: 7068 5f72 6573 6574 2020 2867 6629 3b0a  ph_reset  (gf);.
-0007ddf0: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
-0007de00: 5f66 3332 2020 2020 2020 2866 2d3e 6772  _f32      (f->gr
-0007de10: 6164 2c20 312e 3066 293b 0a20 2020 2020  ad, 1.0f);.     
-0007de20: 2020 2067 676d 6c5f 6772 6170 685f 636f     ggml_graph_co
-0007de30: 6d70 7574 6528 6374 782c 2067 6229 3b0a  mpute(ctx, gb);.
-0007de40: 0a20 2020 2020 2020 2063 6f6e 7374 2066  .        const f
-0007de50: 6c6f 6174 2066 7820 3d20 6767 6d6c 5f67  loat fx = ggml_g
-0007de60: 6574 5f66 3332 5f31 6428 662c 2030 293b  et_f32_1d(f, 0);
-0007de70: 0a0a 2020 2020 2020 2020 2f2f 2063 6865  ..        // che
-0007de80: 636b 2063 6f6e 7665 7267 656e 6365 0a20  ck convergence. 
-0007de90: 2020 2020 2020 2069 6620 2866 6162 7366         if (fabsf
-0007dea0: 2866 7820 2d20 6678 5f70 7265 7629 2f66  (fx - fx_prev)/f
-0007deb0: 7820 3c20 7061 7261 6d73 2e61 6461 6d2e  x < params.adam.
-0007dec0: 6570 735f 6629 207b 0a20 2020 2020 2020  eps_f) {.       
-0007ded0: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
-0007dee0: 4445 4255 4728 2263 6f6e 7665 7267 6564  DEBUG("converged
-0007def0: 5c6e 2229 3b0a 0a20 2020 2020 2020 2020  \n");..         
-0007df00: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
-0007df10: 5054 5f4f 4b3b 0a20 2020 2020 2020 207d  PT_OK;.        }
-0007df20: 0a0a 2020 2020 2020 2020 2f2f 2064 656c  ..        // del
-0007df30: 7461 2d62 6173 6564 2063 6f6e 7665 7267  ta-based converg
-0007df40: 656e 6365 2074 6573 740a 2020 2020 2020  ence test.      
-0007df50: 2020 6966 2028 7066 2021 3d20 4e55 4c4c    if (pf != NULL
-0007df60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007df70: 2f2f 206e 6565 6420 6174 206c 6561 7374  // need at least
-0007df80: 2070 6172 616d 732e 7061 7374 2069 7465   params.past ite
-0007df90: 7261 7469 6f6e 7320 746f 2073 7461 7274  rations to start
-0007dfa0: 2063 6865 636b 696e 6720 666f 7220 636f   checking for co
-0007dfb0: 6e76 6572 6765 6e63 650a 2020 2020 2020  nvergence.      
-0007dfc0: 2020 2020 2020 6966 2028 7061 7261 6d73        if (params
-0007dfd0: 2e70 6173 7420 3c3d 2074 2920 7b0a 2020  .past <= t) {.  
-0007dfe0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0007dff0: 6e73 7420 666c 6f61 7420 7261 7465 203d  nst float rate =
-0007e000: 2028 7066 5b74 2570 6172 616d 732e 7061   (pf[t%params.pa
-0007e010: 7374 5d20 2d20 6678 292f 6678 3b0a 0a20  st] - fx)/fx;.. 
-0007e020: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007e030: 6620 2866 6162 7366 2872 6174 6529 203c  f (fabsf(rate) <
-0007e040: 2070 6172 616d 732e 6465 6c74 6129 207b   params.delta) {
-0007e050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007e060: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
-0007e070: 5f4f 5054 5f4f 4b3b 0a20 2020 2020 2020  _OPT_OK;.       
-0007e080: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007e090: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0007e0a0: 2020 2020 2020 7066 5b74 2570 6172 616d        pf[t%param
-0007e0b0: 732e 7061 7374 5d20 3d20 6678 3b0a 2020  s.past] = fx;.  
-0007e0c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0007e0d0: 202f 2f20 6368 6563 6b20 666f 7220 696d   // check for im
-0007e0e0: 7072 6f76 656d 656e 740a 2020 2020 2020  provement.      
-0007e0f0: 2020 6966 2028 7061 7261 6d73 2e6d 6178    if (params.max
-0007e100: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
-0007e110: 3e20 3029 207b 0a20 2020 2020 2020 2020  > 0) {.         
-0007e120: 2020 2069 6620 2866 785f 6265 7374 203e     if (fx_best >
-0007e130: 2066 7829 207b 0a20 2020 2020 2020 2020   fx) {.         
-0007e140: 2020 2020 2020 2066 785f 6265 7374 203d         fx_best =
-0007e150: 2066 783b 0a20 2020 2020 2020 2020 2020   fx;.           
-0007e160: 2020 2020 206e 5f6e 6f5f 696d 7072 6f76       n_no_improv
-0007e170: 656d 656e 7420 3d20 303b 0a20 2020 2020  ement = 0;.     
-0007e180: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-0007e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e1a0: 2b2b 6e5f 6e6f 5f69 6d70 726f 7665 6d65  ++n_no_improveme
-0007e1b0: 6e74 3b0a 0a20 2020 2020 2020 2020 2020  nt;..           
-0007e1c0: 2020 2020 2069 6620 286e 5f6e 6f5f 696d       if (n_no_im
-0007e1d0: 7072 6f76 656d 656e 7420 3e3d 2070 6172  provement >= par
-0007e1e0: 616d 732e 6d61 785f 6e6f 5f69 6d70 726f  ams.max_no_impro
-0007e1f0: 7665 6d65 6e74 2920 7b0a 2020 2020 2020  vement) {.      
-0007e200: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0007e210: 7475 726e 2047 474d 4c5f 4f50 545f 4f4b  turn GGML_OPT_OK
-0007e220: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007e230: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0007e240: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0007e250: 2020 2020 2066 785f 7072 6576 203d 2066       fx_prev = f
-0007e260: 783b 0a0a 2020 2020 2020 2020 7b0a 2020  x;..        {.  
-0007e270: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0007e280: 696e 7436 345f 7420 745f 656e 645f 6370  int64_t t_end_cp
-0007e290: 7520 3d20 6767 6d6c 5f63 7963 6c65 7328  u = ggml_cycles(
-0007e2a0: 293b 0a20 2020 2020 2020 2020 2020 2047  );.            G
-0007e2b0: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-0007e2c0: 2274 696d 6520 6974 6572 3a20 2020 2020  "time iter:     
-0007e2d0: 2025 352e 3366 2073 5c6e 222c 2028 2866   %5.3f s\n", ((f
-0007e2e0: 6c6f 6174 2928 745f 656e 645f 6370 7520  loat)(t_end_cpu 
-0007e2f0: 2d20 745f 7374 6172 745f 6370 7529 292f  - t_start_cpu))/
-0007e300: 434c 4f43 4b53 5f50 4552 5f53 4543 293b  CLOCKS_PER_SEC);
-0007e310: 0a20 2020 2020 2020 2020 2020 2055 4e55  .            UNU
-0007e320: 5345 4428 745f 656e 645f 6370 7529 3b0a  SED(t_end_cpu);.
-0007e330: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0007e340: 7374 2069 6e74 3634 5f74 2074 5f65 6e64  st int64_t t_end
-0007e350: 5f77 616c 6c20 3d20 6767 6d6c 5f74 696d  _wall = ggml_tim
-0007e360: 655f 7573 2829 3b0a 2020 2020 2020 2020  e_us();.        
-0007e370: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-0007e380: 4542 5547 2822 7761 6c6c 2074 696d 6520  EBUG("wall time 
-0007e390: 6974 6572 3a20 2535 2e33 6620 735c 6e22  iter: %5.3f s\n"
-0007e3a0: 2c20 2874 5f65 6e64 5f77 616c 6c20 2d20  , (t_end_wall - 
-0007e3b0: 745f 7374 6172 745f 7761 6c6c 292f 3165  t_start_wall)/1e
-0007e3c0: 3629 3b0a 2020 2020 2020 2020 2020 2020  6);.            
-0007e3d0: 554e 5553 4544 2874 5f65 6e64 5f77 616c  UNUSED(t_end_wal
-0007e3e0: 6c29 3b0a 2020 2020 2020 2020 7d0a 2020  l);.        }.  
-0007e3f0: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-0007e400: 4747 4d4c 5f4f 5054 5f44 4944 5f4e 4f54  GGML_OPT_DID_NOT
-0007e410: 5f43 4f4e 5645 5247 453b 0a7d 0a0a 2f2f  _CONVERGE;.}..//
-0007e420: 0a2f 2f20 4c2d 4246 4753 0a2f 2f0a 2f2f  .// L-BFGS.//.//
-0007e430: 2074 6865 204c 2d42 4647 5320 696d 706c   the L-BFGS impl
-0007e440: 656d 656e 7461 7469 6f6e 2062 656c 6f77  ementation below
-0007e450: 2069 7320 6261 7365 6420 6f6e 2074 6865   is based on the
-0007e460: 2066 6f6c 6c6f 7769 6e67 2069 6d70 6c65   following imple
-0007e470: 6d65 6e74 6174 696f 6e3a 0a2f 2f0a 2f2f  mentation:.//.//
-0007e480: 2020 2068 7474 7073 3a2f 2f67 6974 6875     https://githu
-0007e490: 622e 636f 6d2f 6368 6f6b 6b61 6e2f 6c69  b.com/chokkan/li
-0007e4a0: 626c 6266 6773 0a2f 2f0a 0a73 7472 7563  blbfgs.//..struc
-0007e4b0: 7420 6767 6d6c 5f6c 6266 6773 5f69 7465  t ggml_lbfgs_ite
-0007e4c0: 7261 7469 6f6e 5f64 6174 6120 7b0a 2020  ration_data {.  
-0007e4d0: 2020 666c 6f61 7420 616c 7068 613b 0a20    float alpha;. 
-0007e4e0: 2020 2066 6c6f 6174 2079 733b 0a20 2020     float ys;.   
-0007e4f0: 2066 6c6f 6174 202a 2073 3b0a 2020 2020   float * s;.    
-0007e500: 666c 6f61 7420 2a20 793b 0a7d 3b0a 0a73  float * y;.};..s
-0007e510: 7461 7469 6320 656e 756d 2067 676d 6c5f  tatic enum ggml_
-0007e520: 6f70 745f 7265 7375 6c74 206c 696e 6573  opt_result lines
-0007e530: 6561 7263 685f 6261 636b 7472 6163 6b69  earch_backtracki
-0007e540: 6e67 280a 2020 2020 2020 2020 7374 7275  ng(.        stru
-0007e550: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
-0007e560: 2a20 6374 782c 0a20 2020 2020 2020 2063  * ctx,.        c
-0007e570: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0007e580: 5f6f 7074 5f70 6172 616d 7320 2a20 7061  _opt_params * pa
-0007e590: 7261 6d73 2c0a 2020 2020 2020 2020 696e  rams,.        in
-0007e5a0: 7420 6e78 2c0a 2020 2020 2020 2020 666c  t nx,.        fl
-0007e5b0: 6f61 7420 2a20 782c 0a20 2020 2020 2020  oat * x,.       
-0007e5c0: 2066 6c6f 6174 202a 2066 782c 0a20 2020   float * fx,.   
-0007e5d0: 2020 2020 2066 6c6f 6174 202a 2067 2c0a       float * g,.
-0007e5e0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-0007e5f0: 642c 0a20 2020 2020 2020 2066 6c6f 6174  d,.        float
-0007e600: 202a 2073 7465 702c 0a20 2020 2020 2020   * step,.       
-0007e610: 2063 6f6e 7374 2066 6c6f 6174 202a 2078   const float * x
-0007e620: 702c 0a20 2020 2020 2020 2073 7472 7563  p,.        struc
-0007e630: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0007e640: 662c 0a20 2020 2020 2020 2073 7472 7563  f,.        struc
-0007e650: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-0007e660: 6766 2c0a 2020 2020 2020 2020 7374 7275  gf,.        stru
-0007e670: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
-0007e680: 2067 622c 0a20 2020 2020 2020 2063 6f6e   gb,.        con
-0007e690: 7374 2069 6e74 206e 702c 0a20 2020 2020  st int np,.     
-0007e6a0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0007e6b0: 656e 736f 7220 2a20 7073 5b5d 2920 7b0a  ensor * ps[]) {.
-0007e6c0: 2020 2020 696e 7420 636f 756e 7420 3d20      int count = 
-0007e6d0: 303b 0a0a 2020 2020 666c 6f61 7420 7769  0;..    float wi
-0007e6e0: 6474 6820 203d 2030 2e30 663b 0a20 2020  dth  = 0.0f;.   
-0007e6f0: 2066 6c6f 6174 2064 6720 2020 2020 3d20   float dg     = 
-0007e700: 302e 3066 3b0a 2020 2020 666c 6f61 7420  0.0f;.    float 
-0007e710: 6669 6e69 7420 203d 2030 2e30 663b 0a20  finit  = 0.0f;. 
-0007e720: 2020 2066 6c6f 6174 2064 6769 6e69 7420     float dginit 
-0007e730: 3d20 302e 3066 3b0a 2020 2020 666c 6f61  = 0.0f;.    floa
-0007e740: 7420 6467 7465 7374 203d 2030 2e30 663b  t dgtest = 0.0f;
-0007e750: 0a0a 2020 2020 636f 6e73 7420 666c 6f61  ..    const floa
-0007e760: 7420 6465 6320 3d20 302e 3566 3b0a 2020  t dec = 0.5f;.  
-0007e770: 2020 636f 6e73 7420 666c 6f61 7420 696e    const float in
-0007e780: 6320 3d20 322e 3166 3b0a 0a20 2020 2069  c = 2.1f;..    i
-0007e790: 6620 282a 7374 6570 203c 3d20 302e 6629  f (*step <= 0.f)
-0007e7a0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-0007e7b0: 6e20 4747 4d4c 5f4c 494e 4553 4541 5243  n GGML_LINESEARC
-0007e7c0: 485f 494e 5641 4c49 445f 5041 5241 4d45  H_INVALID_PARAME
-0007e7d0: 5445 5253 3b0a 2020 2020 7d0a 0a20 2020  TERS;.    }..   
-0007e7e0: 202f 2f20 636f 6d70 7574 6520 7468 6520   // compute the 
-0007e7f0: 696e 6974 6961 6c20 6772 6164 6965 6e74  initial gradient
-0007e800: 2069 6e20 7468 6520 7365 6172 6368 2064   in the search d
-0007e810: 6972 6563 7469 6f6e 0a20 2020 2067 676d  irection.    ggm
-0007e820: 6c5f 7665 635f 646f 745f 6633 3228 6e78  l_vec_dot_f32(nx
-0007e830: 2c20 2664 6769 6e69 742c 2067 2c20 6429  , &dginit, g, d)
-0007e840: 3b0a 0a20 2020 202f 2f20 6d61 6b65 2073  ;..    // make s
-0007e850: 7572 6520 7468 6174 2064 2070 6f69 6e74  ure that d point
-0007e860: 7320 746f 2061 2064 6573 6365 6e74 2064  s to a descent d
-0007e870: 6972 6563 7469 6f6e 0a20 2020 2069 6620  irection.    if 
-0007e880: 2830 203c 2064 6769 6e69 7429 207b 0a20  (0 < dginit) {. 
-0007e890: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
-0007e8a0: 4d4c 5f4c 494e 4553 4541 5243 485f 4641  ML_LINESEARCH_FA
-0007e8b0: 494c 3b0a 2020 2020 7d0a 0a20 2020 202f  IL;.    }..    /
-0007e8c0: 2f20 696e 6974 6961 6c69 7a65 206c 6f63  / initialize loc
-0007e8d0: 616c 2076 6172 6961 626c 6573 0a20 2020  al variables.   
-0007e8e0: 2066 696e 6974 203d 202a 6678 3b0a 2020   finit = *fx;.  
-0007e8f0: 2020 6467 7465 7374 203d 2070 6172 616d    dgtest = param
-0007e900: 732d 3e6c 6266 6773 2e66 746f 6c2a 6467  s->lbfgs.ftol*dg
-0007e910: 696e 6974 3b0a 0a20 2020 2077 6869 6c65  init;..    while
-0007e920: 2028 7472 7565 2920 7b0a 2020 2020 2020   (true) {.      
-0007e930: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
-0007e940: 3332 286e 782c 2078 2c20 7870 293b 0a20  32(nx, x, xp);. 
-0007e950: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0007e960: 6d61 645f 6633 3228 6e78 2c20 782c 2064  mad_f32(nx, x, d
-0007e970: 2c20 2a73 7465 7029 3b0a 0a20 2020 2020  , *step);..     
-0007e980: 2020 202f 2f20 6576 616c 7561 7465 2074     // evaluate t
-0007e990: 6865 2066 756e 6374 696f 6e20 616e 6420  he function and 
-0007e9a0: 6772 6164 6965 6e74 2076 616c 7565 730a  gradient values.
-0007e9b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007e9c0: 2020 2020 2020 6767 6d6c 5f6f 7074 5f73        ggml_opt_s
-0007e9d0: 6574 5f70 6172 616d 7328 6e70 2c20 7073  et_params(np, ps
-0007e9e0: 2c20 7829 3b0a 0a20 2020 2020 2020 2020  , x);..         
-0007e9f0: 2020 2067 676d 6c5f 6772 6170 685f 7265     ggml_graph_re
-0007ea00: 7365 7420 2028 6766 293b 0a20 2020 2020  set  (gf);.     
-0007ea10: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
-0007ea20: 6633 3220 2020 2020 2028 662d 3e67 7261  f32      (f->gra
-0007ea30: 642c 2031 2e30 6629 3b0a 2020 2020 2020  d, 1.0f);.      
-0007ea40: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-0007ea50: 5f63 6f6d 7075 7465 2863 7478 2c20 6762  _compute(ctx, gb
-0007ea60: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0007ea70: 6767 6d6c 5f6f 7074 5f67 6574 5f67 7261  ggml_opt_get_gra
-0007ea80: 6428 6e70 2c20 7073 2c20 6729 3b0a 0a20  d(np, ps, g);.. 
-0007ea90: 2020 2020 2020 2020 2020 202a 6678 203d             *fx =
-0007eaa0: 2067 676d 6c5f 6765 745f 6633 325f 3164   ggml_get_f32_1d
-0007eab0: 2866 2c20 3029 3b0a 2020 2020 2020 2020  (f, 0);.        
-0007eac0: 7d0a 0a20 2020 2020 2020 202b 2b63 6f75  }..        ++cou
-0007ead0: 6e74 3b0a 0a20 2020 2020 2020 2069 6620  nt;..        if 
-0007eae0: 282a 6678 203e 2066 696e 6974 202b 2028  (*fx > finit + (
-0007eaf0: 2a73 7465 7029 2a64 6774 6573 7429 207b  *step)*dgtest) {
-0007eb00: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-0007eb10: 7468 203d 2064 6563 3b0a 2020 2020 2020  th = dec;.      
-0007eb20: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0007eb30: 2020 2020 2020 202f 2f20 4172 6d69 6a6f         // Armijo
-0007eb40: 2063 6f6e 6469 7469 6f6e 2069 7320 7361   condition is sa
-0007eb50: 7469 7366 6965 640a 2020 2020 2020 2020  tisfied.        
-0007eb60: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0007eb70: 6c62 6667 732e 6c69 6e65 7365 6172 6368  lbfgs.linesearch
-0007eb80: 203d 3d20 4747 4d4c 5f4c 494e 4553 4541   == GGML_LINESEA
-0007eb90: 5243 485f 4241 434b 5452 4143 4b49 4e47  RCH_BACKTRACKING
-0007eba0: 5f41 524d 494a 4f29 207b 0a20 2020 2020  _ARMIJO) {.     
-0007ebb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0007ebc0: 6e20 636f 756e 743b 0a20 2020 2020 2020  n count;.       
-0007ebd0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0007ebe0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
-0007ebf0: 5f66 3332 286e 782c 2026 6467 2c20 672c  _f32(nx, &dg, g,
-0007ec00: 2064 293b 0a0a 2020 2020 2020 2020 2020   d);..          
-0007ec10: 2020 2f2f 2063 6865 636b 2074 6865 2057    // check the W
-0007ec20: 6f6c 6665 2063 6f6e 6469 7469 6f6e 0a20  olfe condition. 
-0007ec30: 2020 2020 2020 2020 2020 2069 6620 2864             if (d
-0007ec40: 6720 3c20 7061 7261 6d73 2d3e 6c62 6667  g < params->lbfg
-0007ec50: 732e 776f 6c66 6520 2a20 6467 696e 6974  s.wolfe * dginit
-0007ec60: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007ec70: 2020 2020 7769 6474 6820 3d20 696e 633b      width = inc;
-0007ec80: 0a20 2020 2020 2020 2020 2020 207d 2065  .            } e
-0007ec90: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-0007eca0: 2020 2020 2020 6966 2870 6172 616d 732d        if(params-
-0007ecb0: 3e6c 6266 6773 2e6c 696e 6573 6561 7263  >lbfgs.linesearc
-0007ecc0: 6820 3d3d 2047 474d 4c5f 4c49 4e45 5345  h == GGML_LINESE
-0007ecd0: 4152 4348 5f42 4143 4b54 5241 434b 494e  ARCH_BACKTRACKIN
-0007ece0: 475f 574f 4c46 4529 207b 0a20 2020 2020  G_WOLFE) {.     
-0007ecf0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007ed00: 2f20 7265 6775 6c61 7220 576f 6c66 6520  / regular Wolfe 
-0007ed10: 636f 6e64 6974 696f 6e73 0a20 2020 2020  conditions.     
-0007ed20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0007ed30: 6574 7572 6e20 636f 756e 743b 0a20 2020  eturn count;.   
-0007ed40: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0007ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ed60: 6966 2864 6720 3e20 2d70 6172 616d 732d  if(dg > -params-
-0007ed70: 3e6c 6266 6773 2e77 6f6c 6665 2a64 6769  >lbfgs.wolfe*dgi
-0007ed80: 6e69 7429 207b 0a20 2020 2020 2020 2020  nit) {.         
-0007ed90: 2020 2020 2020 2020 2020 2077 6964 7468             width
-0007eda0: 203d 2064 6563 3b0a 2020 2020 2020 2020   = dec;.        
-0007edb0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-0007edc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007edd0: 2020 2020 202f 2f20 7374 726f 6e67 2057       // strong W
-0007ede0: 6f6c 6665 2063 6f6e 6469 7469 6f6e 2028  olfe condition (
-0007edf0: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
-0007ee00: 4241 434b 5452 4143 4b49 4e47 5f53 5452  BACKTRACKING_STR
-0007ee10: 4f4e 475f 574f 4c46 4529 0a20 2020 2020  ONG_WOLFE).     
-0007ee20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0007ee30: 6574 7572 6e20 636f 756e 743b 0a20 2020  eturn count;.   
-0007ee40: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0007ee50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0007ee60: 6574 7572 6e20 636f 756e 743b 0a20 2020  eturn count;.   
-0007ee70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007ee80: 2020 207d 0a0a 2020 2020 2020 2020 6966     }..        if
-0007ee90: 2028 2a73 7465 7020 3c20 7061 7261 6d73   (*step < params
-0007eea0: 2d3e 6c62 6667 732e 6d69 6e5f 7374 6570  ->lbfgs.min_step
-0007eeb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007eec0: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
-0007eed0: 5345 4152 4348 5f4d 494e 494d 554d 5f53  SEARCH_MINIMUM_S
-0007eee0: 5445 503b 0a20 2020 2020 2020 207d 0a20  TEP;.        }. 
-0007eef0: 2020 2020 2020 2069 6620 282a 7374 6570         if (*step
-0007ef00: 203e 2070 6172 616d 732d 3e6c 6266 6773   > params->lbfgs
-0007ef10: 2e6d 6178 5f73 7465 7029 207b 0a20 2020  .max_step) {.   
-0007ef20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0007ef30: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
-0007ef40: 4d41 5849 4d55 4d5f 5354 4550 3b0a 2020  MAXIMUM_STEP;.  
-0007ef50: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0007ef60: 6966 2028 7061 7261 6d73 2d3e 6c62 6667  if (params->lbfg
-0007ef70: 732e 6d61 785f 6c69 6e65 7365 6172 6368  s.max_linesearch
-0007ef80: 203c 3d20 636f 756e 7429 207b 0a20 2020   <= count) {.   
-0007ef90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0007efa0: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
-0007efb0: 4d41 5849 4d55 4d5f 4954 4552 4154 494f  MAXIMUM_ITERATIO
-0007efc0: 4e53 3b0a 2020 2020 2020 2020 7d0a 0a20  NS;.        }.. 
-0007efd0: 2020 2020 2020 2028 2a73 7465 7029 202a         (*step) *
-0007efe0: 3d20 7769 6474 683b 0a20 2020 207d 0a0a  = width;.    }..
-0007eff0: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
-0007f000: 4c49 4e45 5345 4152 4348 5f46 4149 4c3b  LINESEARCH_FAIL;
-0007f010: 0a7d 0a0a 7374 6174 6963 2065 6e75 6d20  .}..static enum 
-0007f020: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
-0007f030: 6767 6d6c 5f6f 7074 5f6c 6266 6773 280a  ggml_opt_lbfgs(.
-0007f040: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0007f050: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-0007f060: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-0007f070: 7420 6767 6d6c 5f6f 7074 5f70 6172 616d  t ggml_opt_param
-0007f080: 7320 7061 7261 6d73 2c0a 2020 2020 2020  s params,.      
-0007f090: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0007f0a0: 6e73 6f72 202a 2066 2c0a 2020 2020 2020  nsor * f,.      
-0007f0b0: 2020 7374 7275 6374 2067 676d 6c5f 6367    struct ggml_cg
-0007f0c0: 7261 7068 202a 2067 662c 0a20 2020 2020  raph * gf,.     
-0007f0d0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-0007f0e0: 6772 6170 6820 2a20 6762 2920 7b0a 2020  graph * gb) {.  
-0007f0f0: 2020 6966 2028 7061 7261 6d73 2e6c 6266    if (params.lbf
-0007f100: 6773 2e6c 696e 6573 6561 7263 6820 3d3d  gs.linesearch ==
-0007f110: 2047 474d 4c5f 4c49 4e45 5345 4152 4348   GGML_LINESEARCH
-0007f120: 5f42 4143 4b54 5241 434b 494e 475f 574f  _BACKTRACKING_WO
-0007f130: 4c46 4520 7c7c 0a20 2020 2020 2020 2070  LFE ||.        p
-0007f140: 6172 616d 732e 6c62 6667 732e 6c69 6e65  arams.lbfgs.line
-0007f150: 7365 6172 6368 203d 3d20 4747 4d4c 5f4c  search == GGML_L
-0007f160: 494e 4553 4541 5243 485f 4241 434b 5452  INESEARCH_BACKTR
-0007f170: 4143 4b49 4e47 5f53 5452 4f4e 475f 574f  ACKING_STRONG_WO
-0007f180: 4c46 4529 207b 0a20 2020 2020 2020 2069  LFE) {.        i
-0007f190: 6620 2870 6172 616d 732e 6c62 6667 732e  f (params.lbfgs.
-0007f1a0: 776f 6c66 6520 3c3d 2070 6172 616d 732e  wolfe <= params.
-0007f1b0: 6c62 6667 732e 6674 6f6c 207c 7c20 312e  lbfgs.ftol || 1.
-0007f1c0: 6620 3c3d 2070 6172 616d 732e 6c62 6667  f <= params.lbfg
-0007f1d0: 732e 776f 6c66 6529 207b 0a20 2020 2020  s.wolfe) {.     
-0007f1e0: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
-0007f1f0: 4d4c 5f4f 5054 5f49 4e56 414c 4944 5f57  ML_OPT_INVALID_W
-0007f200: 4f4c 4645 3b0a 2020 2020 2020 2020 7d0a  OLFE;.        }.
-0007f210: 2020 2020 7d0a 0a20 2020 2067 662d 3e6e      }..    gf->n
-0007f220: 5f74 6872 6561 6473 203d 2070 6172 616d  _threads = param
-0007f230: 732e 6e5f 7468 7265 6164 733b 0a20 2020  s.n_threads;.   
-0007f240: 2067 622d 3e6e 5f74 6872 6561 6473 203d   gb->n_threads =
-0007f250: 2070 6172 616d 732e 6e5f 7468 7265 6164   params.n_thread
-0007f260: 733b 0a0a 2020 2020 636f 6e73 7420 696e  s;..    const in
-0007f270: 7420 6d20 3d20 7061 7261 6d73 2e6c 6266  t m = params.lbf
-0007f280: 6773 2e6d 3b0a 0a20 2020 202f 2f20 7468  gs.m;..    // th
-0007f290: 6573 6520 7769 6c6c 2073 746f 7265 2074  ese will store t
-0007f2a0: 6865 2070 6172 616d 6574 6572 7320 7765  he parameters we
-0007f2b0: 2077 616e 7420 746f 206f 7074 696d 697a   want to optimiz
-0007f2c0: 650a 2020 2020 7374 7275 6374 2067 676d  e.    struct ggm
-0007f2d0: 6c5f 7465 6e73 6f72 202a 2070 735b 4747  l_tensor * ps[GG
-0007f2e0: 4d4c 5f4d 4158 5f50 4152 414d 535d 3b0a  ML_MAX_PARAMS];.
-0007f2f0: 0a20 2020 2069 6e74 206e 7020 3d20 303b  .    int np = 0;
-0007f300: 0a20 2020 2069 6e74 206e 7820 3d20 303b  .    int nx = 0;
-0007f310: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0007f320: 3d20 303b 2069 203c 2067 662d 3e6e 5f6e  = 0; i < gf->n_n
-0007f330: 6f64 6573 3b20 2b2b 6929 207b 0a20 2020  odes; ++i) {.   
-0007f340: 2020 2020 2069 6620 2867 662d 3e6e 6f64       if (gf->nod
-0007f350: 6573 5b69 5d2d 3e69 735f 7061 7261 6d29  es[i]->is_param)
-0007f360: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
-0007f370: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-0007f380: 2266 6f75 6e64 2070 6172 616d 2025 643a  "found param %d:
-0007f390: 2067 7261 642d 3e6f 7020 3d20 2564 5c6e   grad->op = %d\n
-0007f3a0: 222c 206e 702c 2067 662d 3e6e 6f64 6573  ", np, gf->nodes
-0007f3b0: 5b69 5d2d 3e67 7261 642d 3e6f 7029 3b0a  [i]->grad->op);.
-0007f3c0: 0a20 2020 2020 2020 2020 2020 2047 474d  .            GGM
-0007f3d0: 4c5f 4153 5345 5254 286e 7020 3c20 4747  L_ASSERT(np < GG
-0007f3e0: 4d4c 5f4d 4158 5f50 4152 414d 5329 3b0a  ML_MAX_PARAMS);.
-0007f3f0: 0a20 2020 2020 2020 2020 2020 2070 735b  .            ps[
-0007f400: 6e70 2b2b 5d20 3d20 6766 2d3e 6e6f 6465  np++] = gf->node
-0007f410: 735b 695d 3b0a 2020 2020 2020 2020 2020  s[i];.          
-0007f420: 2020 6e78 202b 3d20 6767 6d6c 5f6e 656c    nx += ggml_nel
-0007f430: 656d 656e 7473 2867 662d 3e6e 6f64 6573  ements(gf->nodes
-0007f440: 5b69 5d29 3b0a 2020 2020 2020 2020 7d0a  [i]);.        }.
-0007f450: 2020 2020 7d0a 0a20 2020 2066 6c6f 6174      }..    float
-0007f460: 202a 2078 2020 3d20 6767 6d6c 5f6e 6577   * x  = ggml_new
-0007f470: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-0007f480: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
-0007f490: 7829 2d3e 6461 7461 3b20 2f2f 2063 7572  x)->data; // cur
-0007f4a0: 7265 6e74 2070 6172 616d 6574 6572 730a  rent parameters.
-0007f4b0: 2020 2020 666c 6f61 7420 2a20 7870 203d      float * xp =
-0007f4c0: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-0007f4d0: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
-0007f4e0: 5045 5f46 3332 2c20 6e78 292d 3e64 6174  PE_F32, nx)->dat
-0007f4f0: 613b 202f 2f20 7072 6576 696f 7573 2070  a; // previous p
-0007f500: 6172 616d 6574 6572 730a 2020 2020 666c  arameters.    fl
-0007f510: 6f61 7420 2a20 6720 203d 2067 676d 6c5f  oat * g  = ggml_
-0007f520: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-0007f530: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-0007f540: 2c20 6e78 292d 3e64 6174 613b 202f 2f20  , nx)->data; // 
-0007f550: 6375 7272 656e 7420 6772 6164 6965 6e74  current gradient
-0007f560: 0a20 2020 2066 6c6f 6174 202a 2067 7020  .    float * gp 
-0007f570: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-0007f580: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-0007f590: 5950 455f 4633 322c 206e 7829 2d3e 6461  YPE_F32, nx)->da
-0007f5a0: 7461 3b20 2f2f 2070 7265 7669 6f75 7320  ta; // previous 
-0007f5b0: 6772 6164 6965 6e74 0a20 2020 2066 6c6f  gradient.    flo
-0007f5c0: 6174 202a 2064 2020 3d20 6767 6d6c 5f6e  at * d  = ggml_n
-0007f5d0: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-0007f5e0: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-0007f5f0: 206e 7829 2d3e 6461 7461 3b20 2f2f 2073   nx)->data; // s
-0007f600: 6561 7263 6820 6469 7265 6374 696f 6e0a  earch direction.
-0007f610: 0a20 2020 2066 6c6f 6174 202a 2070 6620  .    float * pf 
-0007f620: 3d20 7061 7261 6d73 2e70 6173 7420 3e20  = params.past > 
-0007f630: 3020 3f20 6767 6d6c 5f6e 6577 5f74 656e  0 ? ggml_new_ten
-0007f640: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-0007f650: 5f54 5950 455f 4633 322c 2070 6172 616d  _TYPE_F32, param
-0007f660: 732e 7061 7374 292d 3e64 6174 6120 3a20  s.past)->data : 
-0007f670: 4e55 4c4c 3b20 2f2f 2070 6173 7420 6675  NULL; // past fu
-0007f680: 6e63 7469 6f6e 2076 616c 7565 730a 0a20  nction values.. 
-0007f690: 2020 2066 6c6f 6174 2066 7820 2020 203d     float fx    =
-0007f6a0: 2030 2e30 663b 202f 2f20 636f 7374 2066   0.0f; // cost f
-0007f6b0: 756e 6374 696f 6e20 7661 6c75 650a 2020  unction value.  
-0007f6c0: 2020 666c 6f61 7420 786e 6f72 6d20 3d20    float xnorm = 
-0007f6d0: 302e 3066 3b20 2f2f 207c 7c78 7c7c 0a20  0.0f; // ||x||. 
-0007f6e0: 2020 2066 6c6f 6174 2067 6e6f 726d 203d     float gnorm =
-0007f6f0: 2030 2e30 663b 202f 2f20 7c7c 677c 7c0a   0.0f; // ||g||.
-0007f700: 2020 2020 666c 6f61 7420 7374 6570 2020      float step  
-0007f710: 3d20 302e 3066 3b0a 0a20 2020 202f 2f20  = 0.0f;..    // 
-0007f720: 696e 6974 6961 6c69 7a65 2078 2066 726f  initialize x fro
-0007f730: 6d20 7468 6520 6772 6170 6820 6e6f 6465  m the graph node
-0007f740: 730a 2020 2020 6767 6d6c 5f6f 7074 5f67  s.    ggml_opt_g
-0007f750: 6574 5f70 6172 616d 7328 6e70 2c20 7073  et_params(np, ps
-0007f760: 2c20 7829 3b0a 0a20 2020 202f 2f20 7468  , x);..    // th
-0007f770: 6520 4c2d 4246 4753 206d 656d 6f72 790a  e L-BFGS memory.
-0007f780: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0007f790: 6c62 6667 735f 6974 6572 6174 696f 6e5f  lbfgs_iteration_
-0007f7a0: 6461 7461 202a 206c 6d20 3d20 616c 6c6f  data * lm = allo
-0007f7b0: 6361 2873 697a 656f 6628 7374 7275 6374  ca(sizeof(struct
-0007f7c0: 2067 676d 6c5f 6c62 6667 735f 6974 6572   ggml_lbfgs_iter
-0007f7d0: 6174 696f 6e5f 6461 7461 292a 6d29 3b0a  ation_data)*m);.
-0007f7e0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0007f7f0: 3d20 303b 2069 203c 206d 3b20 2b2b 6929  = 0; i < m; ++i)
-0007f800: 207b 0a20 2020 2020 2020 206c 6d5b 695d   {.        lm[i]
-0007f810: 2e61 6c70 6861 203d 2030 2e30 663b 0a20  .alpha = 0.0f;. 
-0007f820: 2020 2020 2020 206c 6d5b 695d 2e79 7320         lm[i].ys 
-0007f830: 2020 203d 2030 2e30 663b 0a20 2020 2020     = 0.0f;.     
-0007f840: 2020 206c 6d5b 695d 2e73 2020 2020 203d     lm[i].s     =
-0007f850: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
-0007f860: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
-0007f870: 5045 5f46 3332 2c20 6e78 292d 3e64 6174  PE_F32, nx)->dat
-0007f880: 613b 0a20 2020 2020 2020 206c 6d5b 695d  a;.        lm[i]
-0007f890: 2e79 2020 2020 203d 2067 676d 6c5f 6e65  .y     = ggml_ne
-0007f8a0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-0007f8b0: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
-0007f8c0: 6e78 292d 3e64 6174 613b 0a20 2020 207d  nx)->data;.    }
-0007f8d0: 0a0a 2020 2020 2f2f 2065 7661 6c75 6174  ..    // evaluat
-0007f8e0: 6520 7468 6520 6675 6e63 7469 6f6e 2076  e the function v
-0007f8f0: 616c 7565 2061 6e64 2069 7473 2067 7261  alue and its gra
-0007f900: 6469 656e 740a 2020 2020 7b0a 2020 2020  dient.    {.    
-0007f910: 2020 2020 6767 6d6c 5f6f 7074 5f73 6574      ggml_opt_set
-0007f920: 5f70 6172 616d 7328 6e70 2c20 7073 2c20  _params(np, ps, 
-0007f930: 7829 3b0a 0a20 2020 2020 2020 2067 676d  x);..        ggm
-0007f940: 6c5f 6772 6170 685f 7265 7365 7420 2028  l_graph_reset  (
-0007f950: 6766 293b 0a20 2020 2020 2020 2067 676d  gf);.        ggm
-0007f960: 6c5f 7365 745f 6633 3220 2020 2020 2028  l_set_f32      (
-0007f970: 662d 3e67 7261 642c 2031 2e30 6629 3b0a  f->grad, 1.0f);.
-0007f980: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
-0007f990: 7068 5f63 6f6d 7075 7465 2863 7478 2c20  ph_compute(ctx, 
-0007f9a0: 6762 293b 0a0a 2020 2020 2020 2020 6767  gb);..        gg
-0007f9b0: 6d6c 5f6f 7074 5f67 6574 5f67 7261 6428  ml_opt_get_grad(
-0007f9c0: 6e70 2c20 7073 2c20 6729 3b0a 0a20 2020  np, ps, g);..   
-0007f9d0: 2020 2020 2066 7820 3d20 6767 6d6c 5f67       fx = ggml_g
-0007f9e0: 6574 5f66 3332 5f31 6428 662c 2030 293b  et_f32_1d(f, 0);
-0007f9f0: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-0007fa00: 7066 2920 7b0a 2020 2020 2020 2020 7066  pf) {.        pf
-0007fa10: 5b30 5d20 3d20 6678 3b0a 2020 2020 7d0a  [0] = fx;.    }.
-0007fa20: 0a20 2020 2066 6c6f 6174 2066 785f 6265  .    float fx_be
-0007fa30: 7374 203d 2066 783b 0a0a 2020 2020 2f2f  st = fx;..    //
-0007fa40: 2073 6561 7263 6820 6469 7265 6374 696f   search directio
-0007fa50: 6e20 3d20 2d67 7261 6469 656e 740a 2020  n = -gradient.  
-0007fa60: 2020 6767 6d6c 5f76 6563 5f6e 6567 5f66    ggml_vec_neg_f
-0007fa70: 3332 286e 782c 2064 2c20 6729 3b0a 0a20  32(nx, d, g);.. 
-0007fa80: 2020 202f 2f20 7c7c 787c 7c2c 207c 7c67     // ||x||, ||g
-0007fa90: 7c7c 0a20 2020 2067 676d 6c5f 7665 635f  ||.    ggml_vec_
-0007faa0: 6e6f 726d 5f66 3332 286e 782c 2026 786e  norm_f32(nx, &xn
-0007fab0: 6f72 6d2c 2078 293b 0a20 2020 2067 676d  orm, x);.    ggm
-0007fac0: 6c5f 7665 635f 6e6f 726d 5f66 3332 286e  l_vec_norm_f32(n
-0007fad0: 782c 2026 676e 6f72 6d2c 2067 293b 0a0a  x, &gnorm, g);..
-0007fae0: 2020 2020 6966 2028 786e 6f72 6d20 3c20      if (xnorm < 
-0007faf0: 312e 3066 2920 7b0a 2020 2020 2020 2020  1.0f) {.        
-0007fb00: 786e 6f72 6d20 3d20 312e 3066 3b0a 2020  xnorm = 1.0f;.  
-0007fb10: 2020 7d0a 0a20 2020 202f 2f20 616c 7265    }..    // alre
-0007fb20: 6164 7920 6f70 7469 6d69 7a65 640a 2020  ady optimized.  
-0007fb30: 2020 6966 2028 676e 6f72 6d2f 786e 6f72    if (gnorm/xnor
-0007fb40: 6d20 3c3d 2070 6172 616d 732e 6c62 6667  m <= params.lbfg
-0007fb50: 732e 6570 7329 207b 0a20 2020 2020 2020  s.eps) {.       
-0007fb60: 2072 6574 7572 6e20 4747 4d4c 5f4f 5054   return GGML_OPT
-0007fb70: 5f4f 4b3b 0a20 2020 207d 0a0a 2020 2020  _OK;.    }..    
-0007fb80: 2f2f 2069 6e69 7469 616c 2073 7465 700a  // initial step.
-0007fb90: 2020 2020 6767 6d6c 5f76 6563 5f6e 6f72      ggml_vec_nor
-0007fba0: 6d5f 696e 765f 6633 3228 6e78 2c20 2673  m_inv_f32(nx, &s
-0007fbb0: 7465 702c 2064 293b 0a0a 2020 2020 696e  tep, d);..    in
-0007fbc0: 7420 6a20 2020 2020 2020 2020 2020 2020  t j             
-0007fbd0: 2020 203d 2030 3b0a 2020 2020 696e 7420     = 0;.    int 
-0007fbe0: 6b20 2020 2020 2020 2020 2020 2020 2020  k               
-0007fbf0: 203d 2031 3b0a 2020 2020 696e 7420 6c73   = 1;.    int ls
-0007fc00: 2020 2020 2020 2020 2020 2020 2020 203d                 =
-0007fc10: 2030 3b0a 2020 2020 696e 7420 656e 6420   0;.    int end 
-0007fc20: 2020 2020 2020 2020 2020 2020 203d 2030               = 0
-0007fc30: 3b0a 2020 2020 696e 7420 626f 756e 6420  ;.    int bound 
-0007fc40: 2020 2020 2020 2020 2020 203d 2030 3b0a             = 0;.
-0007fc50: 2020 2020 696e 7420 6e5f 6e6f 5f69 6d70      int n_no_imp
-0007fc60: 726f 7665 6d65 6e74 203d 2030 3b0a 0a20  rovement = 0;.. 
-0007fc70: 2020 2066 6c6f 6174 2079 7320 2020 3d20     float ys   = 
-0007fc80: 302e 3066 3b0a 2020 2020 666c 6f61 7420  0.0f;.    float 
-0007fc90: 7979 2020 203d 2030 2e30 663b 0a20 2020  yy   = 0.0f;.   
-0007fca0: 2066 6c6f 6174 2062 6574 6120 3d20 302e   float beta = 0.
-0007fcb0: 3066 3b0a 0a20 2020 2077 6869 6c65 2028  0f;..    while (
-0007fcc0: 7472 7565 2920 7b0a 2020 2020 2020 2020  true) {.        
-0007fcd0: 2f2f 2073 746f 7265 2074 6865 2063 7572  // store the cur
-0007fce0: 7265 6e74 2070 6f73 6974 696f 6e20 616e  rent position an
-0007fcf0: 6420 6772 6164 6965 6e74 2076 6563 746f  d gradient vecto
-0007fd00: 7273 0a20 2020 2020 2020 2067 676d 6c5f  rs.        ggml_
-0007fd10: 7665 635f 6370 795f 6633 3228 6e78 2c20  vec_cpy_f32(nx, 
-0007fd20: 7870 2c20 7829 3b0a 2020 2020 2020 2020  xp, x);.        
-0007fd30: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-0007fd40: 286e 782c 2067 702c 2067 293b 0a0a 2020  (nx, gp, g);..  
-0007fd50: 2020 2020 2020 6c73 203d 206c 696e 6573        ls = lines
-0007fd60: 6561 7263 685f 6261 636b 7472 6163 6b69  earch_backtracki
-0007fd70: 6e67 2863 7478 2c20 2670 6172 616d 732c  ng(ctx, &params,
-0007fd80: 206e 782c 2078 2c20 2666 782c 2067 2c20   nx, x, &fx, g, 
-0007fd90: 642c 2026 7374 6570 2c20 7870 2c20 662c  d, &step, xp, f,
-0007fda0: 2067 662c 2067 622c 206e 702c 2070 7329   gf, gb, np, ps)
-0007fdb0: 3b0a 0a20 2020 2020 2020 2069 6620 286c  ;..        if (l
-0007fdc0: 7320 3c20 3029 207b 0a20 2020 2020 2020  s < 0) {.       
-0007fdd0: 2020 2020 202f 2f20 6c69 6e65 7365 6172       // linesear
-0007fde0: 6368 2066 6169 6c65 6420 2d20 676f 2062  ch failed - go b
-0007fdf0: 6163 6b20 746f 2074 6865 2070 7265 7669  ack to the previ
-0007fe00: 6f75 7320 706f 696e 7420 616e 6420 7265  ous point and re
-0007fe10: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
-0007fe20: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
-0007fe30: 3228 6e78 2c20 782c 2078 7029 3b0a 2020  2(nx, x, xp);.  
-0007fe40: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
-0007fe50: 6563 5f63 7079 5f66 3332 286e 782c 2067  ec_cpy_f32(nx, g
-0007fe60: 2c20 6770 293b 0a0a 2020 2020 2020 2020  , gp);..        
-0007fe70: 2020 2020 7265 7475 726e 206c 733b 0a20      return ls;. 
-0007fe80: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0007fe90: 2020 6767 6d6c 5f76 6563 5f6e 6f72 6d5f    ggml_vec_norm_
-0007fea0: 6633 3228 6e78 2c20 2678 6e6f 726d 2c20  f32(nx, &xnorm, 
-0007feb0: 7829 3b0a 2020 2020 2020 2020 6767 6d6c  x);.        ggml
-0007fec0: 5f76 6563 5f6e 6f72 6d5f 6633 3228 6e78  _vec_norm_f32(nx
-0007fed0: 2c20 2667 6e6f 726d 2c20 6729 3b0a 0a20  , &gnorm, g);.. 
-0007fee0: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-0007fef0: 545f 4445 4255 4728 2266 203d 2025 3130  T_DEBUG("f = %10
-0007ff00: 2e36 665c 6e22 2c20 6767 6d6c 5f67 6574  .6f\n", ggml_get
-0007ff10: 5f66 3332 5f31 6428 662c 2030 2929 3b0a  _f32_1d(f, 0));.
-0007ff20: 0a20 2020 2020 2020 2069 6620 2878 6e6f  .        if (xno
-0007ff30: 726d 203c 2031 2e30 6629 207b 0a20 2020  rm < 1.0f) {.   
-0007ff40: 2020 2020 2020 2020 2078 6e6f 726d 203d           xnorm =
-0007ff50: 2031 2e30 663b 0a20 2020 2020 2020 207d   1.0f;.        }
-0007ff60: 0a20 2020 2020 2020 2069 6620 2867 6e6f  .        if (gno
-0007ff70: 726d 2f78 6e6f 726d 203c 3d20 7061 7261  rm/xnorm <= para
-0007ff80: 6d73 2e6c 6266 6773 2e65 7073 2920 7b0a  ms.lbfgs.eps) {.
-0007ff90: 2020 2020 2020 2020 2020 2020 2f2f 2063              // c
-0007ffa0: 6f6e 7665 7267 6564 0a20 2020 2020 2020  onverged.       
-0007ffb0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
-0007ffc0: 5f4f 5054 5f4f 4b3b 0a20 2020 2020 2020  _OPT_OK;.       
-0007ffd0: 207d 0a0a 2020 2020 2020 2020 2f2f 2064   }..        // d
-0007ffe0: 656c 7461 2d62 6173 6564 2063 6f6e 7665  elta-based conve
-0007fff0: 7267 656e 6365 2074 6573 740a 2020 2020  rgence test.    
-00080000: 2020 2020 6966 2028 7066 2021 3d20 4e55      if (pf != NU
-00080010: 4c4c 2920 7b0a 2020 2020 2020 2020 2020  LL) {.          
-00080020: 2020 2f2f 206e 6565 6420 6174 206c 6561    // need at lea
-00080030: 7374 2070 6172 616d 732e 7061 7374 2069  st params.past i
-00080040: 7465 7261 7469 6f6e 7320 746f 2073 7461  terations to sta
-00080050: 7274 2063 6865 636b 696e 6720 666f 7220  rt checking for 
-00080060: 636f 6e76 6572 6765 6e63 650a 2020 2020  convergence.    
-00080070: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
-00080080: 6d73 2e70 6173 7420 3c3d 206b 2920 7b0a  ms.past <= k) {.
-00080090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000800a0: 636f 6e73 7420 666c 6f61 7420 7261 7465  const float rate
-000800b0: 203d 2028 7066 5b6b 2570 6172 616d 732e   = (pf[k%params.
-000800c0: 7061 7374 5d20 2d20 6678 292f 6678 3b0a  past] - fx)/fx;.
-000800d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000800e0: 2069 6620 2866 6162 7366 2872 6174 6529   if (fabsf(rate)
-000800f0: 203c 2070 6172 616d 732e 6465 6c74 6129   < params.delta)
-00080100: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00080110: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
-00080120: 4d4c 5f4f 5054 5f4f 4b3b 0a20 2020 2020  ML_OPT_OK;.     
-00080130: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00080140: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00080150: 2020 2020 2020 2020 7066 5b6b 2570 6172          pf[k%par
-00080160: 616d 732e 7061 7374 5d20 3d20 6678 3b0a  ams.past] = fx;.
-00080170: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00080180: 2020 202f 2f20 6368 6563 6b20 666f 7220     // check for 
-00080190: 696d 7072 6f76 656d 656e 740a 2020 2020  improvement.    
-000801a0: 2020 2020 6966 2028 7061 7261 6d73 2e6d      if (params.m
-000801b0: 6178 5f6e 6f5f 696d 7072 6f76 656d 656e  ax_no_improvemen
-000801c0: 7420 3e20 3029 207b 0a20 2020 2020 2020  t > 0) {.       
-000801d0: 2020 2020 2069 6620 2866 7820 3c20 6678       if (fx < fx
-000801e0: 5f62 6573 7429 207b 0a20 2020 2020 2020  _best) {.       
-000801f0: 2020 2020 2020 2020 2066 785f 6265 7374           fx_best
-00080200: 203d 2066 783b 0a20 2020 2020 2020 2020   = fx;.         
-00080210: 2020 2020 2020 206e 5f6e 6f5f 696d 7072         n_no_impr
-00080220: 6f76 656d 656e 7420 3d20 303b 0a20 2020  ovement = 0;.   
-00080230: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-00080240: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00080250: 2020 6e5f 6e6f 5f69 6d70 726f 7665 6d65    n_no_improveme
-00080260: 6e74 2b2b 3b0a 0a20 2020 2020 2020 2020  nt++;..         
-00080270: 2020 2020 2020 2069 6620 286e 5f6e 6f5f         if (n_no_
-00080280: 696d 7072 6f76 656d 656e 7420 3e3d 2070  improvement >= p
-00080290: 6172 616d 732e 6d61 785f 6e6f 5f69 6d70  arams.max_no_imp
-000802a0: 726f 7665 6d65 6e74 2920 7b0a 2020 2020  rovement) {.    
-000802b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000802c0: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
-000802d0: 4f4b 3b0a 2020 2020 2020 2020 2020 2020  OK;.            
-000802e0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000802f0: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
-00080300: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
-00080310: 732e 6c62 6667 732e 6e5f 6974 6572 2021  s.lbfgs.n_iter !
-00080320: 3d20 3020 2626 2070 6172 616d 732e 6c62  = 0 && params.lb
-00080330: 6667 732e 6e5f 6974 6572 203c 206b 202b  fgs.n_iter < k +
-00080340: 2031 2920 7b0a 2020 2020 2020 2020 2020   1) {.          
-00080350: 2020 2f2f 2072 6561 6368 6564 2074 6865    // reached the
-00080360: 206d 6178 696d 756d 206e 756d 6265 7220   maximum number 
-00080370: 6f66 2069 7465 7261 7469 6f6e 730a 2020  of iterations.  
-00080380: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00080390: 2047 474d 4c5f 4f50 545f 4449 445f 4e4f   GGML_OPT_DID_NO
-000803a0: 545f 434f 4e56 4552 4745 3b0a 2020 2020  T_CONVERGE;.    
-000803b0: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-000803c0: 2f20 7570 6461 7465 2076 6563 746f 7273  / update vectors
-000803d0: 2073 2061 6e64 2079 3a0a 2020 2020 2020   s and y:.      
-000803e0: 2020 2f2f 2020 2073 5f7b 6b2b 317d 203d    //   s_{k+1} =
-000803f0: 2078 5f7b 6b2b 317d 202d 2078 5f7b 6b7d   x_{k+1} - x_{k}
-00080400: 203d 205c 7374 6570 202a 2064 5f7b 6b7d   = \step * d_{k}
-00080410: 2e0a 2020 2020 2020 2020 2f2f 2020 2079  ..        //   y
-00080420: 5f7b 6b2b 317d 203d 2067 5f7b 6b2b 317d  _{k+1} = g_{k+1}
-00080430: 202d 2067 5f7b 6b7d 2e0a 2020 2020 2020   - g_{k}..      
-00080440: 2020 2f2f 0a20 2020 2020 2020 2067 676d    //.        ggm
-00080450: 6c5f 7665 635f 7375 625f 6633 3228 6e78  l_vec_sub_f32(nx
-00080460: 2c20 6c6d 5b65 6e64 5d2e 732c 2078 2c20  , lm[end].s, x, 
-00080470: 7870 293b 0a20 2020 2020 2020 2067 676d  xp);.        ggm
-00080480: 6c5f 7665 635f 7375 625f 6633 3228 6e78  l_vec_sub_f32(nx
-00080490: 2c20 6c6d 5b65 6e64 5d2e 792c 2067 2c20  , lm[end].y, g, 
-000804a0: 6770 293b 0a0a 2020 2020 2020 2020 2f2f  gp);..        //
-000804b0: 2063 6f6d 7075 7465 2073 6361 6c61 7273   compute scalars
-000804c0: 2079 7320 616e 6420 7979 3a0a 2020 2020   ys and yy:.    
-000804d0: 2020 2020 2f2f 2020 2020 2079 7320 3d20      //     ys = 
-000804e0: 795e 7420 5c63 646f 7420 7320 2020 202d  y^t \cdot s    -
-000804f0: 3e20 3120 2f20 5c72 686f 2e0a 2020 2020  > 1 / \rho..    
-00080500: 2020 2020 2f2f 2020 2020 2079 7920 3d20      //     yy = 
-00080510: 795e 7420 5c63 646f 7420 792e 0a20 2020  y^t \cdot y..   
-00080520: 2020 2020 202f 2f0a 2020 2020 2020 2020       //.        
-00080530: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3332  ggml_vec_dot_f32
-00080540: 286e 782c 2026 7973 2c20 6c6d 5b65 6e64  (nx, &ys, lm[end
-00080550: 5d2e 792c 206c 6d5b 656e 645d 2e73 293b  ].y, lm[end].s);
-00080560: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00080570: 635f 646f 745f 6633 3228 6e78 2c20 2679  c_dot_f32(nx, &y
-00080580: 792c 206c 6d5b 656e 645d 2e79 2c20 6c6d  y, lm[end].y, lm
-00080590: 5b65 6e64 5d2e 7929 3b0a 0a20 2020 2020  [end].y);..     
-000805a0: 2020 206c 6d5b 656e 645d 2e79 7320 3d20     lm[end].ys = 
-000805b0: 7973 3b0a 0a20 2020 2020 2020 202f 2f20  ys;..        // 
-000805c0: 6669 6e64 206e 6577 2073 6561 7263 6820  find new search 
-000805d0: 6469 7265 6374 696f 6e0a 2020 2020 2020  direction.      
-000805e0: 2020 2f2f 2020 2072 6566 3a20 6874 7470    //   ref: http
-000805f0: 733a 2f2f 656e 2e77 696b 6970 6564 6961  s://en.wikipedia
-00080600: 2e6f 7267 2f77 696b 692f 4c69 6d69 7465  .org/wiki/Limite
-00080610: 642d 6d65 6d6f 7279 5f42 4647 530a 0a20  d-memory_BFGS.. 
-00080620: 2020 2020 2020 2062 6f75 6e64 203d 2028         bound = (
-00080630: 6d20 3c3d 206b 2920 3f20 6d20 3a20 6b3b  m <= k) ? m : k;
-00080640: 0a20 2020 2020 2020 206b 2b2b 3b0a 2020  .        k++;.  
-00080650: 2020 2020 2020 656e 6420 3d20 2865 6e64        end = (end
-00080660: 202b 2031 2925 6d3b 0a0a 2020 2020 2020   + 1)%m;..      
-00080670: 2020 2f2f 2069 6e69 7469 616c 697a 6520    // initialize 
-00080680: 7365 6172 6368 2064 6972 6563 7469 6f6e  search direction
-00080690: 2077 6974 6820 2d67 0a20 2020 2020 2020   with -g.       
-000806a0: 2067 676d 6c5f 7665 635f 6e65 675f 6633   ggml_vec_neg_f3
-000806b0: 3228 6e78 2c20 642c 2067 293b 0a0a 2020  2(nx, d, g);..  
-000806c0: 2020 2020 2020 6a20 3d20 656e 643b 0a20        j = end;. 
-000806d0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000806e0: 6920 3d20 303b 2069 203c 2062 6f75 6e64  i = 0; i < bound
-000806f0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00080700: 2020 2020 206a 203d 2028 6a20 2b20 6d20       j = (j + m 
-00080710: 2d20 3129 2025 206d 3b0a 2020 2020 2020  - 1) % m;.      
-00080720: 2020 2020 2020 2f2f 205c 616c 7068 615f        // \alpha_
-00080730: 7b6a 7d20 3d20 5c72 686f 5f7b 6a7d 2073  {j} = \rho_{j} s
-00080740: 5e7b 747d 5f7b 6a7d 205c 6364 6f74 2071  ^{t}_{j} \cdot q
-00080750: 5f7b 6b2b 317d 0a20 2020 2020 2020 2020  _{k+1}.         
-00080760: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
-00080770: 6633 3228 6e78 2c20 266c 6d5b 6a5d 2e61  f32(nx, &lm[j].a
-00080780: 6c70 6861 2c20 6c6d 5b6a 5d2e 732c 2064  lpha, lm[j].s, d
-00080790: 293b 0a20 2020 2020 2020 2020 2020 206c  );.            l
-000807a0: 6d5b 6a5d 2e61 6c70 6861 202f 3d20 6c6d  m[j].alpha /= lm
-000807b0: 5b6a 5d2e 7973 3b0a 2020 2020 2020 2020  [j].ys;.        
-000807c0: 2020 2020 2f2f 2071 5f7b 697d 203d 2071      // q_{i} = q
-000807d0: 5f7b 692b 317d 202d 205c 616c 7068 615f  _{i+1} - \alpha_
-000807e0: 7b69 7d20 795f 7b69 7d0a 2020 2020 2020  {i} y_{i}.      
-000807f0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-00080800: 6164 5f66 3332 286e 782c 2064 2c20 6c6d  ad_f32(nx, d, lm
-00080810: 5b6a 5d2e 792c 202d 6c6d 5b6a 5d2e 616c  [j].y, -lm[j].al
-00080820: 7068 6129 3b0a 2020 2020 2020 2020 7d0a  pha);.        }.
-00080830: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00080840: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
-00080850: 642c 2079 732f 7979 293b 0a0a 2020 2020  d, ys/yy);..    
-00080860: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00080870: 2030 3b20 6920 3c20 626f 756e 643b 202b   0; i < bound; +
-00080880: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
-00080890: 2020 2f2f 205c 6265 7461 5f7b 6a7d 203d    // \beta_{j} =
-000808a0: 205c 7268 6f5f 7b6a 7d20 795e 745f 7b6a   \rho_{j} y^t_{j
-000808b0: 7d20 5c63 646f 7420 5c67 616d 6d61 5f7b  } \cdot \gamma_{
-000808c0: 697d 0a20 2020 2020 2020 2020 2020 2067  i}.            g
-000808d0: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
-000808e0: 6e78 2c20 2662 6574 612c 206c 6d5b 6a5d  nx, &beta, lm[j]
-000808f0: 2e79 2c20 6429 3b0a 2020 2020 2020 2020  .y, d);.        
-00080900: 2020 2020 6265 7461 202f 3d20 6c6d 5b6a      beta /= lm[j
-00080910: 5d2e 7973 3b0a 2020 2020 2020 2020 2020  ].ys;.          
-00080920: 2020 2f2f 205c 6761 6d6d 615f 7b69 2b31    // \gamma_{i+1
-00080930: 7d20 3d20 5c67 616d 6d61 5f7b 697d 202b  } = \gamma_{i} +
-00080940: 2028 5c61 6c70 6861 5f7b 6a7d 202d 205c   (\alpha_{j} - \
-00080950: 6265 7461 5f7b 6a7d 2920 735f 7b6a 7d0a  beta_{j}) s_{j}.
-00080960: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00080970: 5f76 6563 5f6d 6164 5f66 3332 286e 782c  _vec_mad_f32(nx,
-00080980: 2064 2c20 6c6d 5b6a 5d2e 732c 206c 6d5b   d, lm[j].s, lm[
-00080990: 6a5d 2e61 6c70 6861 202d 2062 6574 6129  j].alpha - beta)
-000809a0: 3b0a 2020 2020 2020 2020 2020 2020 6a20  ;.            j 
-000809b0: 3d20 286a 202b 2031 2925 6d3b 0a20 2020  = (j + 1)%m;.   
-000809c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000809d0: 7374 6570 203d 2031 2e30 3b0a 2020 2020  step = 1.0;.    
-000809e0: 7d0a 0a20 2020 2072 6574 7572 6e20 4747  }..    return GG
-000809f0: 4d4c 5f4f 5054 5f44 4944 5f4e 4f54 5f43  ML_OPT_DID_NOT_C
-00080a00: 4f4e 5645 5247 453b 0a7d 0a0a 7374 7275  ONVERGE;.}..stru
-00080a10: 6374 2067 676d 6c5f 6f70 745f 7061 7261  ct ggml_opt_para
-00080a20: 6d73 2067 676d 6c5f 6f70 745f 6465 6661  ms ggml_opt_defa
-00080a30: 756c 745f 7061 7261 6d73 2865 6e75 6d20  ult_params(enum 
-00080a40: 6767 6d6c 5f6f 7074 5f74 7970 6520 7479  ggml_opt_type ty
-00080a50: 7065 2920 7b0a 2020 2020 7374 7275 6374  pe) {.    struct
-00080a60: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
-00080a70: 2072 6573 756c 743b 0a0a 2020 2020 7377   result;..    sw
-00080a80: 6974 6368 2028 7479 7065 2920 7b0a 2020  itch (type) {.  
-00080a90: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00080aa0: 4f50 545f 4144 414d 3a0a 2020 2020 2020  OPT_ADAM:.      
-00080ab0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00080ac0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00080ad0: 2028 7374 7275 6374 2067 676d 6c5f 6f70   (struct ggml_op
-00080ae0: 745f 7061 7261 6d73 2920 7b0a 2020 2020  t_params) {.    
-00080af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080b00: 2e74 7970 6520 2020 2020 203d 2047 474d  .type      = GGM
-00080b10: 4c5f 4f50 545f 4144 414d 2c0a 2020 2020  L_OPT_ADAM,.    
-00080b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080b30: 2e6e 5f74 6872 6561 6473 203d 2031 2c0a  .n_threads = 1,.
-00080b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080b50: 2020 2020 2e70 6173 7420 2020 2020 203d      .past      =
-00080b60: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-00080b70: 2020 2020 2020 2020 2e64 656c 7461 2020          .delta  
-00080b80: 2020 203d 2031 652d 3566 2c0a 0a20 2020     = 1e-5f,..   
-00080b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ba0: 202e 6d61 785f 6e6f 5f69 6d70 726f 7665   .max_no_improve
-00080bb0: 6d65 6e74 203d 2031 3030 2c0a 0a20 2020  ment = 100,..   
-00080bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080bd0: 202e 7072 696e 745f 666f 7277 6172 645f   .print_forward_
-00080be0: 6772 6170 6820 203d 2074 7275 652c 0a20  graph  = true,. 
-00080bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080c00: 2020 202e 7072 696e 745f 6261 636b 7761     .print_backwa
-00080c10: 7264 5f67 7261 7068 203d 2074 7275 652c  rd_graph = true,
-00080c20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00080c30: 2020 2020 2020 2e61 6461 6d20 3d20 7b0a        .adam = {.
-00080c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080c50: 2020 2020 2020 2020 2e6e 5f69 7465 7220          .n_iter 
-00080c60: 3d20 3130 3030 302c 0a20 2020 2020 2020  = 10000,.       
+0007c9b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0007c9c0: 2f2f 0a0a 7374 6174 6963 2076 6f69 6420  //..static void 
+0007c9d0: 6767 6d6c 5f6f 7074 5f73 6574 5f70 6172  ggml_opt_set_par
+0007c9e0: 616d 7328 696e 7420 6e70 2c20 7374 7275  ams(int np, stru
+0007c9f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0007ca00: 2063 6f6e 7374 2070 735b 5d2c 2063 6f6e   const ps[], con
+0007ca10: 7374 2066 6c6f 6174 202a 2078 2920 7b0a  st float * x) {.
+0007ca20: 2020 2020 696e 7420 6920 3d20 303b 0a20      int i = 0;. 
+0007ca30: 2020 2066 6f72 2028 696e 7420 7020 3d20     for (int p = 
+0007ca40: 303b 2070 203c 206e 703b 202b 2b70 2920  0; p < np; ++p) 
+0007ca50: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
+0007ca60: 696e 7436 345f 7420 6e65 203d 2067 676d  int64_t ne = ggm
+0007ca70: 6c5f 6e65 6c65 6d65 6e74 7328 7073 5b70  l_nelements(ps[p
+0007ca80: 5d29 203b 0a20 2020 2020 2020 202f 2f20  ]) ;.        // 
+0007ca90: 544f 444f 3a20 6164 6420 6675 6e63 7469  TODO: add functi
+0007caa0: 6f6e 2074 6f20 7365 7420 7465 6e73 6f72  on to set tensor
+0007cab0: 2066 726f 6d20 6172 7261 790a 2020 2020   from array.    
+0007cac0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0007cad0: 206a 203d 2030 3b20 6a20 3c20 6e65 3b20   j = 0; j < ne; 
+0007cae0: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
+0007caf0: 2020 2067 676d 6c5f 7365 745f 6633 325f     ggml_set_f32_
+0007cb00: 3164 2870 735b 705d 2c20 6a2c 2078 5b69  1d(ps[p], j, x[i
+0007cb10: 2b2b 5d29 3b0a 2020 2020 2020 2020 7d0a  ++]);.        }.
+0007cb20: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+0007cb30: 766f 6964 2067 676d 6c5f 6f70 745f 6765  void ggml_opt_ge
+0007cb40: 745f 7061 7261 6d73 2869 6e74 206e 702c  t_params(int np,
+0007cb50: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0007cb60: 736f 7220 2a20 636f 6e73 7420 7073 5b5d  sor * const ps[]
+0007cb70: 2c20 666c 6f61 7420 2a20 7829 207b 0a20  , float * x) {. 
+0007cb80: 2020 2069 6e74 2069 203d 2030 3b0a 2020     int i = 0;.  
+0007cb90: 2020 666f 7220 2869 6e74 2070 203d 2030    for (int p = 0
+0007cba0: 3b20 7020 3c20 6e70 3b20 2b2b 7029 207b  ; p < np; ++p) {
+0007cbb0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+0007cbc0: 6e74 3634 5f74 206e 6520 3d20 6767 6d6c  nt64_t ne = ggml
+0007cbd0: 5f6e 656c 656d 656e 7473 2870 735b 705d  _nelements(ps[p]
+0007cbe0: 2920 3b0a 2020 2020 2020 2020 2f2f 2054  ) ;.        // T
+0007cbf0: 4f44 4f3a 2061 6464 2066 756e 6374 696f  ODO: add functio
+0007cc00: 6e20 746f 2067 6574 2061 6c6c 2065 6c65  n to get all ele
+0007cc10: 6d65 6e74 7320 6174 206f 6e63 650a 2020  ments at once.  
+0007cc20: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0007cc30: 5f74 206a 203d 2030 3b20 6a20 3c20 6e65  _t j = 0; j < ne
+0007cc40: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
+0007cc50: 2020 2020 2078 5b69 2b2b 5d20 3d20 6767       x[i++] = gg
+0007cc60: 6d6c 5f67 6574 5f66 3332 5f31 6428 7073  ml_get_f32_1d(ps
+0007cc70: 5b70 5d2c 206a 293b 0a20 2020 2020 2020  [p], j);.       
+0007cc80: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
+0007cc90: 6963 2076 6f69 6420 6767 6d6c 5f6f 7074  ic void ggml_opt
+0007cca0: 5f67 6574 5f67 7261 6428 696e 7420 6e70  _get_grad(int np
+0007ccb0: 2c20 7374 7275 6374 2067 676d 6c5f 7465  , struct ggml_te
+0007ccc0: 6e73 6f72 202a 2063 6f6e 7374 2070 735b  nsor * const ps[
+0007ccd0: 5d2c 2066 6c6f 6174 202a 2067 2920 7b0a  ], float * g) {.
+0007cce0: 2020 2020 696e 7420 6920 3d20 303b 0a20      int i = 0;. 
+0007ccf0: 2020 2066 6f72 2028 696e 7420 7020 3d20     for (int p = 
+0007cd00: 303b 2070 203c 206e 703b 202b 2b70 2920  0; p < np; ++p) 
+0007cd10: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
+0007cd20: 696e 7436 345f 7420 6e65 203d 2067 676d  int64_t ne = ggm
+0007cd30: 6c5f 6e65 6c65 6d65 6e74 7328 7073 5b70  l_nelements(ps[p
+0007cd40: 5d29 203b 0a20 2020 2020 2020 202f 2f20  ]) ;.        // 
+0007cd50: 544f 444f 3a20 6164 6420 6675 6e63 7469  TODO: add functi
+0007cd60: 6f6e 2074 6f20 6765 7420 616c 6c20 656c  on to get all el
+0007cd70: 656d 656e 7473 2061 7420 6f6e 6365 0a20  ements at once. 
+0007cd80: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0007cd90: 345f 7420 6a20 3d20 303b 206a 203c 206e  4_t j = 0; j < n
+0007cda0: 653b 202b 2b6a 2920 7b0a 2020 2020 2020  e; ++j) {.      
+0007cdb0: 2020 2020 2020 675b 692b 2b5d 203d 2067        g[i++] = g
+0007cdc0: 676d 6c5f 6765 745f 6633 325f 3164 2870  gml_get_f32_1d(p
+0007cdd0: 735b 705d 2d3e 6772 6164 2c20 6a29 3b0a  s[p]->grad, j);.
+0007cde0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0007cdf0: 7d0a 0a2f 2f0a 2f2f 2041 4441 4d0a 2f2f  }..//.// ADAM.//
+0007ce00: 0a2f 2f20 2020 7265 663a 2068 7474 7073  .//   ref: https
+0007ce10: 3a2f 2f61 7278 6976 2e6f 7267 2f70 6466  ://arxiv.org/pdf
+0007ce20: 2f31 3431 322e 3639 3830 2e70 6466 0a2f  /1412.6980.pdf./
+0007ce30: 2f0a 0a73 7461 7469 6320 656e 756d 2067  /..static enum g
+0007ce40: 676d 6c5f 6f70 745f 7265 7375 6c74 2067  gml_opt_result g
+0007ce50: 676d 6c5f 6f70 745f 6164 616d 280a 2020  gml_opt_adam(.  
+0007ce60: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0007ce70: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0007ce80: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0007ce90: 6767 6d6c 5f6f 7074 5f70 6172 616d 7320  ggml_opt_params 
+0007cea0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0007ceb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007cec0: 6f72 202a 2066 2c0a 2020 2020 2020 2020  or * f,.        
+0007ced0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+0007cee0: 7068 202a 2067 662c 0a20 2020 2020 2020  ph * gf,.       
+0007cef0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+0007cf00: 6170 6820 2a20 6762 2920 7b0a 2020 2020  aph * gb) {.    
+0007cf10: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+0007cf20: 5f69 735f 7363 616c 6172 2866 2929 3b0a  _is_scalar(f));.
+0007cf30: 0a20 2020 2067 662d 3e6e 5f74 6872 6561  .    gf->n_threa
+0007cf40: 6473 203d 2070 6172 616d 732e 6e5f 7468  ds = params.n_th
+0007cf50: 7265 6164 733b 0a20 2020 2067 622d 3e6e  reads;.    gb->n
+0007cf60: 5f74 6872 6561 6473 203d 2070 6172 616d  _threads = param
+0007cf70: 732e 6e5f 7468 7265 6164 733b 0a0a 2020  s.n_threads;..  
+0007cf80: 2020 2f2f 2074 6865 7365 2077 696c 6c20    // these will 
+0007cf90: 7374 6f72 6520 7468 6520 7061 7261 6d65  store the parame
+0007cfa0: 7465 7273 2077 6520 7761 6e74 2074 6f20  ters we want to 
+0007cfb0: 6f70 7469 6d69 7a65 0a20 2020 2073 7472  optimize.    str
+0007cfc0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0007cfd0: 2a20 7073 5b47 474d 4c5f 4d41 585f 5041  * ps[GGML_MAX_PA
+0007cfe0: 5241 4d53 5d3b 0a0a 2020 2020 696e 7420  RAMS];..    int 
+0007cff0: 6e70 203d 2030 3b0a 2020 2020 696e 7420  np = 0;.    int 
+0007d000: 6e78 203d 2030 3b0a 2020 2020 666f 7220  nx = 0;.    for 
+0007d010: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+0007d020: 6766 2d3e 6e5f 6e6f 6465 733b 202b 2b69  gf->n_nodes; ++i
+0007d030: 2920 7b0a 2020 2020 2020 2020 6966 2028  ) {.        if (
+0007d040: 6766 2d3e 6e6f 6465 735b 695d 2d3e 6973  gf->nodes[i]->is
+0007d050: 5f70 6172 616d 2920 7b0a 2020 2020 2020  _param) {.      
+0007d060: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+0007d070: 5f44 4542 5547 2822 666f 756e 6420 7061  _DEBUG("found pa
+0007d080: 7261 6d20 2564 3a20 6772 6164 2d3e 6f70  ram %d: grad->op
+0007d090: 203d 2025 645c 6e22 2c20 6e70 2c20 6766   = %d\n", np, gf
+0007d0a0: 2d3e 6e6f 6465 735b 695d 2d3e 6772 6164  ->nodes[i]->grad
+0007d0b0: 2d3e 6f70 293b 0a0a 2020 2020 2020 2020  ->op);..        
+0007d0c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0007d0d0: 6e70 203c 2047 474d 4c5f 4d41 585f 5041  np < GGML_MAX_PA
+0007d0e0: 5241 4d53 293b 0a0a 2020 2020 2020 2020  RAMS);..        
+0007d0f0: 2020 2020 7073 5b6e 702b 2b5d 203d 2067      ps[np++] = g
+0007d100: 662d 3e6e 6f64 6573 5b69 5d3b 0a20 2020  f->nodes[i];.   
+0007d110: 2020 2020 2020 2020 206e 7820 2b3d 2067           nx += g
+0007d120: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6766  gml_nelements(gf
+0007d130: 2d3e 6e6f 6465 735b 695d 293b 0a20 2020  ->nodes[i]);.   
+0007d140: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
+0007d150: 2020 2f2f 2063 6f6e 7374 616e 7473 0a20    // constants. 
+0007d160: 2020 2063 6f6e 7374 2066 6c6f 6174 2061     const float a
+0007d170: 6c70 6861 203d 2070 6172 616d 732e 6164  lpha = params.ad
+0007d180: 616d 2e61 6c70 6861 3b0a 2020 2020 636f  am.alpha;.    co
+0007d190: 6e73 7420 666c 6f61 7420 6265 7461 3120  nst float beta1 
+0007d1a0: 3d20 7061 7261 6d73 2e61 6461 6d2e 6265  = params.adam.be
+0007d1b0: 7461 313b 0a20 2020 2063 6f6e 7374 2066  ta1;.    const f
+0007d1c0: 6c6f 6174 2062 6574 6132 203d 2070 6172  loat beta2 = par
+0007d1d0: 616d 732e 6164 616d 2e62 6574 6132 3b0a  ams.adam.beta2;.
+0007d1e0: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+0007d1f0: 6570 7320 2020 3d20 7061 7261 6d73 2e61  eps   = params.a
+0007d200: 6461 6d2e 6570 733b 0a0a 2020 2020 666c  dam.eps;..    fl
+0007d210: 6f61 7420 2a20 7820 203d 2067 676d 6c5f  oat * x  = ggml_
+0007d220: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
+0007d230: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+0007d240: 2c20 6e78 292d 3e64 6174 613b 202f 2f20  , nx)->data; // 
+0007d250: 7669 6577 206f 6620 7468 6520 7061 7261  view of the para
+0007d260: 6d65 7465 7273 0a20 2020 2066 6c6f 6174  meters.    float
+0007d270: 202a 2067 3120 3d20 6767 6d6c 5f6e 6577   * g1 = ggml_new
+0007d280: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+0007d290: 4747 4d4c 5f54 5950 455f 4633 322c 206e  GGML_TYPE_F32, n
+0007d2a0: 7829 2d3e 6461 7461 3b20 2f2f 2067 7261  x)->data; // gra
+0007d2b0: 6469 656e 740a 2020 2020 666c 6f61 7420  dient.    float 
+0007d2c0: 2a20 6732 203d 2067 676d 6c5f 6e65 775f  * g2 = ggml_new_
+0007d2d0: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
+0007d2e0: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
+0007d2f0: 292d 3e64 6174 613b 202f 2f20 6772 6164  )->data; // grad
+0007d300: 6965 6e74 2073 7175 6172 6564 0a20 2020  ient squared.   
+0007d310: 2066 6c6f 6174 202a 206d 2020 3d20 6767   float * m  = gg
+0007d320: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+0007d330: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+0007d340: 4633 322c 206e 7829 2d3e 6461 7461 3b20  F32, nx)->data; 
+0007d350: 2f2f 2066 6972 7374 206d 6f6d 656e 740a  // first moment.
+0007d360: 2020 2020 666c 6f61 7420 2a20 7620 203d      float * v  =
+0007d370: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+0007d380: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
+0007d390: 5045 5f46 3332 2c20 6e78 292d 3e64 6174  PE_F32, nx)->dat
+0007d3a0: 613b 202f 2f20 7365 636f 6e64 206d 6f6d  a; // second mom
+0007d3b0: 656e 740a 2020 2020 666c 6f61 7420 2a20  ent.    float * 
+0007d3c0: 6d68 203d 2067 676d 6c5f 6e65 775f 7465  mh = ggml_new_te
+0007d3d0: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+0007d3e0: 4c5f 5459 5045 5f46 3332 2c20 6e78 292d  L_TYPE_F32, nx)-
+0007d3f0: 3e64 6174 613b 202f 2f20 6669 7273 7420  >data; // first 
+0007d400: 6d6f 6d65 6e74 2068 6174 0a20 2020 2066  moment hat.    f
+0007d410: 6c6f 6174 202a 2076 6820 3d20 6767 6d6c  loat * vh = ggml
+0007d420: 5f6e 6577 5f74 656e 736f 725f 3164 2863  _new_tensor_1d(c
+0007d430: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
+0007d440: 322c 206e 7829 2d3e 6461 7461 3b20 2f2f  2, nx)->data; //
+0007d450: 2073 6563 6f6e 6420 6d6f 6d65 6e74 2068   second moment h
+0007d460: 6174 0a0a 2020 2020 666c 6f61 7420 2a20  at..    float * 
+0007d470: 7066 203d 2070 6172 616d 732e 7061 7374  pf = params.past
+0007d480: 203e 2030 203f 2067 676d 6c5f 6e65 775f   > 0 ? ggml_new_
+0007d490: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
+0007d4a0: 474d 4c5f 5459 5045 5f46 3332 2c20 7061  GML_TYPE_F32, pa
+0007d4b0: 7261 6d73 2e70 6173 7429 2d3e 6461 7461  rams.past)->data
+0007d4c0: 203a 204e 554c 4c3b 202f 2f20 7061 7374   : NULL; // past
+0007d4d0: 2066 756e 6374 696f 6e20 7661 6c75 6573   function values
+0007d4e0: 0a0a 2020 2020 2f2f 2069 6e69 7469 616c  ..    // initial
+0007d4f0: 697a 650a 2020 2020 6767 6d6c 5f76 6563  ize.    ggml_vec
+0007d500: 5f73 6574 5f66 3332 286e 782c 206d 2c20  _set_f32(nx, m, 
+0007d510: 302e 3066 293b 0a20 2020 2067 676d 6c5f  0.0f);.    ggml_
+0007d520: 7665 635f 7365 745f 6633 3228 6e78 2c20  vec_set_f32(nx, 
+0007d530: 762c 2030 2e30 6629 3b0a 0a20 2020 202f  v, 0.0f);..    /
+0007d540: 2f20 7570 6461 7465 2076 6965 770a 2020  / update view.  
+0007d550: 2020 6767 6d6c 5f6f 7074 5f67 6574 5f70    ggml_opt_get_p
+0007d560: 6172 616d 7328 6e70 2c20 7073 2c20 7829  arams(np, ps, x)
+0007d570: 3b0a 0a20 2020 202f 2f20 636f 6d70 7574  ;..    // comput
+0007d580: 6520 7468 6520 6675 6e63 7469 6f6e 2076  e the function v
+0007d590: 616c 7565 0a20 2020 2067 676d 6c5f 6772  alue.    ggml_gr
+0007d5a0: 6170 685f 7265 7365 7420 2028 6766 293b  aph_reset  (gf);
+0007d5b0: 0a20 2020 2067 676d 6c5f 7365 745f 6633  .    ggml_set_f3
+0007d5c0: 3220 2020 2020 2028 662d 3e67 7261 642c  2      (f->grad,
+0007d5d0: 2031 2e30 6629 3b0a 2020 2020 6767 6d6c   1.0f);.    ggml
+0007d5e0: 5f67 7261 7068 5f63 6f6d 7075 7465 2863  _graph_compute(c
+0007d5f0: 7478 2c20 6762 293b 0a0a 2020 2020 666c  tx, gb);..    fl
+0007d600: 6f61 7420 6678 5f70 7265 7620 3d20 6767  oat fx_prev = gg
+0007d610: 6d6c 5f67 6574 5f66 3332 5f31 6428 662c  ml_get_f32_1d(f,
+0007d620: 2030 293b 0a20 2020 2069 6620 2870 6629   0);.    if (pf)
+0007d630: 207b 0a20 2020 2020 2020 2070 665b 305d   {.        pf[0]
+0007d640: 203d 2066 785f 7072 6576 3b0a 2020 2020   = fx_prev;.    
+0007d650: 7d0a 0a20 2020 2069 6e74 206e 5f6e 6f5f  }..    int n_no_
+0007d660: 696d 7072 6f76 656d 656e 7420 3d20 303b  improvement = 0;
+0007d670: 0a20 2020 2066 6c6f 6174 2066 785f 6265  .    float fx_be
+0007d680: 7374 203d 2066 785f 7072 6576 3b0a 0a20  st = fx_prev;.. 
+0007d690: 2020 202f 2f20 7275 6e20 7468 6520 6f70     // run the op
+0007d6a0: 7469 6d69 7a65 720a 2020 2020 666f 7220  timizer.    for 
+0007d6b0: 2869 6e74 2074 203d 2030 3b20 7420 3c20  (int t = 0; t < 
+0007d6c0: 7061 7261 6d73 2e61 6461 6d2e 6e5f 6974  params.adam.n_it
+0007d6d0: 6572 3b20 2b2b 7429 207b 0a20 2020 2020  er; ++t) {.     
+0007d6e0: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
+0007d6f0: 4255 4720 2028 223d 3d3d 2069 7465 7220  BUG  ("=== iter 
+0007d700: 2564 203d 3d3d 5c6e 222c 2074 293b 0a0a  %d ===\n", t);..
+0007d710: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
+0007d720: 4e54 5f44 4542 5547 2020 2822 6620 2020  NT_DEBUG  ("f   
+0007d730: 2020 203d 2025 3130 2e36 665c 6e22 2c20     = %10.6f\n", 
+0007d740: 6767 6d6c 5f67 6574 5f66 3332 5f31 6428  ggml_get_f32_1d(
+0007d750: 662c 2030 2929 3b0a 2020 2020 2020 2020  f, 0));.        
+0007d760: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+0007d770: 5f35 2822 6466 2f64 7830 203d 2025 3130  _5("df/dx0 = %10
+0007d780: 2e36 665c 6e22 2c20 6767 6d6c 5f67 6574  .6f\n", ggml_get
+0007d790: 5f66 3332 5f31 6428 7073 5b30 5d2d 3e67  _f32_1d(ps[0]->g
+0007d7a0: 7261 642c 2030 2929 3b0a 2020 2020 2020  rad, 0));.      
+0007d7b0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
+0007d7c0: 5547 5f35 2822 6466 2f64 7831 203d 2025  UG_5("df/dx1 = %
+0007d7d0: 3130 2e36 665c 6e22 2c20 6767 6d6c 5f67  10.6f\n", ggml_g
+0007d7e0: 6574 5f66 3332 5f31 6428 7073 5b31 5d2d  et_f32_1d(ps[1]-
+0007d7f0: 3e67 7261 642c 2030 2929 3b0a 0a20 2020  >grad, 0));..   
+0007d800: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+0007d810: 3d20 303b 2069 203c 206e 703b 202b 2b69  = 0; i < np; ++i
+0007d820: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007d830: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+0007d840: 2822 7061 7261 6d20 2564 3a20 2531 302e  ("param %d: %10.
+0007d850: 3666 2c20 6720 3d20 2531 302e 3666 5c6e  6f, g = %10.6f\n
+0007d860: 222c 2069 2c0a 2020 2020 2020 2020 2020  ", i,.          
+0007d870: 2020 2020 2020 2020 2020 6767 6d6c 5f67            ggml_g
+0007d880: 6574 5f66 3332 5f31 6428 7073 5b69 5d2c  et_f32_1d(ps[i],
+0007d890: 2030 292c 2067 676d 6c5f 6765 745f 6633   0), ggml_get_f3
+0007d8a0: 325f 3164 2870 735b 695d 2d3e 6772 6164  2_1d(ps[i]->grad
+0007d8b0: 2c20 3029 293b 0a20 2020 2020 2020 207d  , 0));.        }
+0007d8c0: 0a0a 2020 2020 2020 2020 636f 6e73 7420  ..        const 
+0007d8d0: 696e 7436 345f 7420 745f 7374 6172 745f  int64_t t_start_
+0007d8e0: 7761 6c6c 203d 2067 676d 6c5f 7469 6d65  wall = ggml_time
+0007d8f0: 5f75 7328 293b 0a20 2020 2020 2020 2063  _us();.        c
+0007d900: 6f6e 7374 2069 6e74 3634 5f74 2074 5f73  onst int64_t t_s
+0007d910: 7461 7274 5f63 7075 203d 2067 676d 6c5f  tart_cpu = ggml_
+0007d920: 6379 636c 6573 2829 3b0a 2020 2020 2020  cycles();.      
+0007d930: 2020 554e 5553 4544 2874 5f73 7461 7274    UNUSED(t_start
+0007d940: 5f77 616c 6c29 3b0a 2020 2020 2020 2020  _wall);.        
+0007d950: 554e 5553 4544 2874 5f73 7461 7274 5f63  UNUSED(t_start_c
+0007d960: 7075 293b 0a0a 2020 2020 2020 2020 7b0a  pu);..        {.
+0007d970: 2020 2020 2020 2020 2020 2020 2f2f 2075              // u
+0007d980: 7064 6174 6520 7468 6520 6772 6164 6965  pdate the gradie
+0007d990: 6e74 0a20 2020 2020 2020 2020 2020 2067  nt.            g
+0007d9a0: 676d 6c5f 6f70 745f 6765 745f 6772 6164  gml_opt_get_grad
+0007d9b0: 286e 702c 2070 732c 2067 3129 3b0a 0a20  (np, ps, g1);.. 
+0007d9c0: 2020 2020 2020 2020 2020 202f 2f20 6d5f             // m_
+0007d9d0: 7420 3d20 6265 7461 312a 6d5f 742d 3120  t = beta1*m_t-1 
+0007d9e0: 2b20 2831 202d 2062 6574 6131 292a 675f  + (1 - beta1)*g_
+0007d9f0: 740a 2020 2020 2020 2020 2020 2020 6767  t.            gg
+0007da00: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+0007da10: 286e 782c 206d 2c20 6265 7461 3129 3b0a  (nx, m, beta1);.
+0007da20: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007da30: 5f76 6563 5f6d 6164 5f66 3332 2020 286e  _vec_mad_f32  (n
+0007da40: 782c 206d 2c20 6731 2c20 312e 3066 202d  x, m, g1, 1.0f -
+0007da50: 2062 6574 6131 293b 0a0a 2020 2020 2020   beta1);..      
+0007da60: 2020 2020 2020 2f2f 2067 3220 3d20 6731        // g2 = g1
+0007da70: 5e32 0a20 2020 2020 2020 2020 2020 2067  ^2.            g
+0007da80: 676d 6c5f 7665 635f 7371 725f 6633 3220  gml_vec_sqr_f32 
+0007da90: 2028 6e78 2c20 6732 2c20 6731 293b 0a0a   (nx, g2, g1);..
+0007daa0: 2020 2020 2020 2020 2020 2020 2f2f 2076              // v
+0007dab0: 5f74 203d 2062 6574 6132 2a76 5f74 2d31  _t = beta2*v_t-1
+0007dac0: 202b 2028 3120 2d20 6265 7461 3229 2a67   + (1 - beta2)*g
+0007dad0: 5f74 5e32 0a20 2020 2020 2020 2020 2020  _t^2.           
+0007dae0: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
+0007daf0: 6633 3228 6e78 2c20 762c 2062 6574 6132  f32(nx, v, beta2
+0007db00: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
+0007db10: 676d 6c5f 7665 635f 6d61 645f 6633 3220  gml_vec_mad_f32 
+0007db20: 2028 6e78 2c20 762c 2067 322c 2031 2e30   (nx, v, g2, 1.0
+0007db30: 6620 2d20 6265 7461 3229 3b0a 0a20 2020  f - beta2);..   
+0007db40: 2020 2020 2020 2020 202f 2f20 6d5e 6861           // m^ha
+0007db50: 7420 3d20 6d5f 7420 2f20 2831 202d 2062  t = m_t / (1 - b
+0007db60: 6574 6131 5e74 290a 2020 2020 2020 2020  eta1^t).        
+0007db70: 2020 2020 2f2f 2076 5e68 6174 203d 2076      // v^hat = v
+0007db80: 5f74 202f 2028 3120 2d20 6265 7461 325e  _t / (1 - beta2^
+0007db90: 7429 0a20 2020 2020 2020 2020 2020 202f  t).            /
+0007dba0: 2f20 785f 7420 3d20 785f 742d 3120 2d20  / x_t = x_t-1 - 
+0007dbb0: 616c 7068 612a 6d5e 6861 742f 2873 7172  alpha*m^hat/(sqr
+0007dbc0: 7428 765e 6861 7429 202b 2065 7073 290a  t(v^hat) + eps).
+0007dbd0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007dbe0: 5f76 6563 5f63 7079 5f66 3332 2020 286e  _vec_cpy_f32  (n
+0007dbf0: 782c 206d 682c 206d 293b 0a20 2020 2020  x, mh, m);.     
+0007dc00: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0007dc10: 6370 795f 6633 3220 2028 6e78 2c20 7668  cpy_f32  (nx, vh
+0007dc20: 2c20 7629 3b0a 0a20 2020 2020 2020 2020  , v);..         
+0007dc30: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
+0007dc40: 655f 6633 3228 6e78 2c20 6d68 2c20 616c  e_f32(nx, mh, al
+0007dc50: 7068 612f 2831 2e30 6620 2d20 706f 7766  pha/(1.0f - powf
+0007dc60: 2862 6574 6131 2c20 7420 2b20 3129 2929  (beta1, t + 1)))
+0007dc70: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
+0007dc80: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+0007dc90: 286e 782c 2076 682c 2020 312e 3066 2f28  (nx, vh,  1.0f/(
+0007dca0: 312e 3066 202d 2070 6f77 6628 6265 7461  1.0f - powf(beta
+0007dcb0: 322c 2074 202b 2031 2929 293b 0a0a 2020  2, t + 1)));..  
+0007dcc0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+0007dcd0: 6563 5f73 7172 745f 6633 3220 286e 782c  ec_sqrt_f32 (nx,
+0007dce0: 2076 682c 2076 6829 3b0a 2020 2020 2020   vh, vh);.      
+0007dcf0: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
+0007dd00: 6363 315f 6633 3220 286e 782c 2076 682c  cc1_f32 (nx, vh,
+0007dd10: 2065 7073 293b 0a0a 2020 2020 2020 2020   eps);..        
+0007dd20: 2020 2020 6767 6d6c 5f76 6563 5f64 6976      ggml_vec_div
+0007dd30: 5f66 3332 2020 286e 782c 206d 682c 206d  _f32  (nx, mh, m
+0007dd40: 682c 2076 6829 3b0a 2020 2020 2020 2020  h, vh);.        
+0007dd50: 2020 2020 6767 6d6c 5f76 6563 5f73 7562      ggml_vec_sub
+0007dd60: 5f66 3332 2020 286e 782c 2078 2c20 2078  _f32  (nx, x,  x
+0007dd70: 2c20 206d 6829 3b0a 0a20 2020 2020 2020  ,  mh);..       
+0007dd80: 2020 2020 202f 2f20 7570 6461 7465 2074       // update t
+0007dd90: 6865 2070 6172 616d 6574 6572 730a 2020  he parameters.  
+0007dda0: 2020 2020 2020 2020 2020 6767 6d6c 5f6f            ggml_o
+0007ddb0: 7074 5f73 6574 5f70 6172 616d 7328 6e70  pt_set_params(np
+0007ddc0: 2c20 7073 2c20 7829 3b0a 2020 2020 2020  , ps, x);.      
+0007ddd0: 2020 7d0a 0a20 2020 2020 2020 2067 676d    }..        ggm
+0007dde0: 6c5f 6772 6170 685f 7265 7365 7420 2028  l_graph_reset  (
+0007ddf0: 6766 293b 0a20 2020 2020 2020 2067 676d  gf);.        ggm
+0007de00: 6c5f 7365 745f 6633 3220 2020 2020 2028  l_set_f32      (
+0007de10: 662d 3e67 7261 642c 2031 2e30 6629 3b0a  f->grad, 1.0f);.
+0007de20: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
+0007de30: 7068 5f63 6f6d 7075 7465 2863 7478 2c20  ph_compute(ctx, 
+0007de40: 6762 293b 0a0a 2020 2020 2020 2020 636f  gb);..        co
+0007de50: 6e73 7420 666c 6f61 7420 6678 203d 2067  nst float fx = g
+0007de60: 676d 6c5f 6765 745f 6633 325f 3164 2866  gml_get_f32_1d(f
+0007de70: 2c20 3029 3b0a 0a20 2020 2020 2020 202f  , 0);..        /
+0007de80: 2f20 6368 6563 6b20 636f 6e76 6572 6765  / check converge
+0007de90: 6e63 650a 2020 2020 2020 2020 6966 2028  nce.        if (
+0007dea0: 6661 6273 6628 6678 202d 2066 785f 7072  fabsf(fx - fx_pr
+0007deb0: 6576 292f 6678 203c 2070 6172 616d 732e  ev)/fx < params.
+0007dec0: 6164 616d 2e65 7073 5f66 2920 7b0a 2020  adam.eps_f) {.  
+0007ded0: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
+0007dee0: 5249 4e54 5f44 4542 5547 2822 636f 6e76  RINT_DEBUG("conv
+0007def0: 6572 6765 645c 6e22 293b 0a0a 2020 2020  erged\n");..    
+0007df00: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+0007df10: 474d 4c5f 4f50 545f 4f4b 3b0a 2020 2020  GML_OPT_OK;.    
+0007df20: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
+0007df30: 2f20 6465 6c74 612d 6261 7365 6420 636f  / delta-based co
+0007df40: 6e76 6572 6765 6e63 6520 7465 7374 0a20  nvergence test. 
+0007df50: 2020 2020 2020 2069 6620 2870 6620 213d         if (pf !=
+0007df60: 204e 554c 4c29 207b 0a20 2020 2020 2020   NULL) {.       
+0007df70: 2020 2020 202f 2f20 6e65 6564 2061 7420       // need at 
+0007df80: 6c65 6173 7420 7061 7261 6d73 2e70 6173  least params.pas
+0007df90: 7420 6974 6572 6174 696f 6e73 2074 6f20  t iterations to 
+0007dfa0: 7374 6172 7420 6368 6563 6b69 6e67 2066  start checking f
+0007dfb0: 6f72 2063 6f6e 7665 7267 656e 6365 0a20  or convergence. 
+0007dfc0: 2020 2020 2020 2020 2020 2069 6620 2870             if (p
+0007dfd0: 6172 616d 732e 7061 7374 203c 3d20 7429  arams.past <= t)
+0007dfe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0007dff0: 2020 2063 6f6e 7374 2066 6c6f 6174 2072     const float r
+0007e000: 6174 6520 3d20 2870 665b 7425 7061 7261  ate = (pf[t%para
+0007e010: 6d73 2e70 6173 745d 202d 2066 7829 2f66  ms.past] - fx)/f
+0007e020: 783b 0a0a 2020 2020 2020 2020 2020 2020  x;..            
+0007e030: 2020 2020 6966 2028 6661 6273 6628 7261      if (fabsf(ra
+0007e040: 7465 2920 3c20 7061 7261 6d73 2e64 656c  te) < params.del
+0007e050: 7461 2920 7b0a 2020 2020 2020 2020 2020  ta) {.          
+0007e060: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0007e070: 2047 474d 4c5f 4f50 545f 4f4b 3b0a 2020   GGML_OPT_OK;.  
+0007e080: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007e090: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0007e0a0: 2020 2020 2020 2020 2020 2070 665b 7425             pf[t%
+0007e0b0: 7061 7261 6d73 2e70 6173 745d 203d 2066  params.past] = f
+0007e0c0: 783b 0a20 2020 2020 2020 207d 0a0a 2020  x;.        }..  
+0007e0d0: 2020 2020 2020 2f2f 2063 6865 636b 2066        // check f
+0007e0e0: 6f72 2069 6d70 726f 7665 6d65 6e74 0a20  or improvement. 
+0007e0f0: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
+0007e100: 732e 6d61 785f 6e6f 5f69 6d70 726f 7665  s.max_no_improve
+0007e110: 6d65 6e74 203e 2030 2920 7b0a 2020 2020  ment > 0) {.    
+0007e120: 2020 2020 2020 2020 6966 2028 6678 5f62          if (fx_b
+0007e130: 6573 7420 3e20 6678 2920 7b0a 2020 2020  est > fx) {.    
+0007e140: 2020 2020 2020 2020 2020 2020 6678 5f62              fx_b
+0007e150: 6573 7420 3d20 6678 3b0a 2020 2020 2020  est = fx;.      
+0007e160: 2020 2020 2020 2020 2020 6e5f 6e6f 5f69            n_no_i
+0007e170: 6d70 726f 7665 6d65 6e74 203d 2030 3b0a  mprovement = 0;.
+0007e180: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+0007e190: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+0007e1a0: 2020 2020 202b 2b6e 5f6e 6f5f 696d 7072       ++n_no_impr
+0007e1b0: 6f76 656d 656e 743b 0a0a 2020 2020 2020  ovement;..      
+0007e1c0: 2020 2020 2020 2020 2020 6966 2028 6e5f            if (n_
+0007e1d0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203e  no_improvement >
+0007e1e0: 3d20 7061 7261 6d73 2e6d 6178 5f6e 6f5f  = params.max_no_
+0007e1f0: 696d 7072 6f76 656d 656e 7429 207b 0a20  improvement) {. 
+0007e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e210: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+0007e220: 5054 5f4f 4b3b 0a20 2020 2020 2020 2020  PT_OK;.         
+0007e230: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0007e240: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+0007e250: 0a0a 2020 2020 2020 2020 6678 5f70 7265  ..        fx_pre
+0007e260: 7620 3d20 6678 3b0a 0a20 2020 2020 2020  v = fx;..       
+0007e270: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
+0007e280: 6f6e 7374 2069 6e74 3634 5f74 2074 5f65  onst int64_t t_e
+0007e290: 6e64 5f63 7075 203d 2067 676d 6c5f 6379  nd_cpu = ggml_cy
+0007e2a0: 636c 6573 2829 3b0a 2020 2020 2020 2020  cles();.        
+0007e2b0: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+0007e2c0: 4542 5547 2822 7469 6d65 2069 7465 723a  EBUG("time iter:
+0007e2d0: 2020 2020 2020 2535 2e33 6620 735c 6e22        %5.3f s\n"
+0007e2e0: 2c20 2828 666c 6f61 7429 2874 5f65 6e64  , ((float)(t_end
+0007e2f0: 5f63 7075 202d 2074 5f73 7461 7274 5f63  _cpu - t_start_c
+0007e300: 7075 2929 2f43 4c4f 434b 535f 5045 525f  pu))/CLOCKS_PER_
+0007e310: 5345 4329 3b0a 2020 2020 2020 2020 2020  SEC);.          
+0007e320: 2020 554e 5553 4544 2874 5f65 6e64 5f63    UNUSED(t_end_c
+0007e330: 7075 293b 0a0a 2020 2020 2020 2020 2020  pu);..          
+0007e340: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0007e350: 745f 656e 645f 7761 6c6c 203d 2067 676d  t_end_wall = ggm
+0007e360: 6c5f 7469 6d65 5f75 7328 293b 0a20 2020  l_time_us();.   
+0007e370: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
+0007e380: 494e 545f 4445 4255 4728 2277 616c 6c20  INT_DEBUG("wall 
+0007e390: 7469 6d65 2069 7465 723a 2025 352e 3366  time iter: %5.3f
+0007e3a0: 2073 5c6e 222c 2028 745f 656e 645f 7761   s\n", (t_end_wa
+0007e3b0: 6c6c 202d 2074 5f73 7461 7274 5f77 616c  ll - t_start_wal
+0007e3c0: 6c29 2f31 6536 293b 0a20 2020 2020 2020  l)/1e6);.       
+0007e3d0: 2020 2020 2055 4e55 5345 4428 745f 656e       UNUSED(t_en
+0007e3e0: 645f 7761 6c6c 293b 0a20 2020 2020 2020  d_wall);.       
+0007e3f0: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
+0007e400: 7475 726e 2047 474d 4c5f 4f50 545f 4449  turn GGML_OPT_DI
+0007e410: 445f 4e4f 545f 434f 4e56 4552 4745 3b0a  D_NOT_CONVERGE;.
+0007e420: 7d0a 0a2f 2f0a 2f2f 204c 2d42 4647 530a  }..//.// L-BFGS.
+0007e430: 2f2f 0a2f 2f20 7468 6520 4c2d 4246 4753  //.// the L-BFGS
+0007e440: 2069 6d70 6c65 6d65 6e74 6174 696f 6e20   implementation 
+0007e450: 6265 6c6f 7720 6973 2062 6173 6564 206f  below is based o
+0007e460: 6e20 7468 6520 666f 6c6c 6f77 696e 6720  n the following 
+0007e470: 696d 706c 656d 656e 7461 7469 6f6e 3a0a  implementation:.
+0007e480: 2f2f 0a2f 2f20 2020 6874 7470 733a 2f2f  //.//   https://
+0007e490: 6769 7468 7562 2e63 6f6d 2f63 686f 6b6b  github.com/chokk
+0007e4a0: 616e 2f6c 6962 6c62 6667 730a 2f2f 0a0a  an/liblbfgs.//..
+0007e4b0: 7374 7275 6374 2067 676d 6c5f 6c62 6667  struct ggml_lbfg
+0007e4c0: 735f 6974 6572 6174 696f 6e5f 6461 7461  s_iteration_data
+0007e4d0: 207b 0a20 2020 2066 6c6f 6174 2061 6c70   {.    float alp
+0007e4e0: 6861 3b0a 2020 2020 666c 6f61 7420 7973  ha;.    float ys
+0007e4f0: 3b0a 2020 2020 666c 6f61 7420 2a20 733b  ;.    float * s;
+0007e500: 0a20 2020 2066 6c6f 6174 202a 2079 3b0a  .    float * y;.
+0007e510: 7d3b 0a0a 7374 6174 6963 2065 6e75 6d20  };..static enum 
+0007e520: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
+0007e530: 6c69 6e65 7365 6172 6368 5f62 6163 6b74  linesearch_backt
+0007e540: 7261 636b 696e 6728 0a20 2020 2020 2020  racking(.       
+0007e550: 2073 7472 7563 7420 6767 6d6c 5f63 6f6e   struct ggml_con
+0007e560: 7465 7874 202a 2063 7478 2c0a 2020 2020  text * ctx,.    
+0007e570: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0007e580: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
+0007e590: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+0007e5a0: 2020 2069 6e74 206e 782c 0a20 2020 2020     int nx,.     
+0007e5b0: 2020 2066 6c6f 6174 202a 2078 2c0a 2020     float * x,.  
+0007e5c0: 2020 2020 2020 666c 6f61 7420 2a20 6678        float * fx
+0007e5d0: 2c0a 2020 2020 2020 2020 666c 6f61 7420  ,.        float 
+0007e5e0: 2a20 672c 0a20 2020 2020 2020 2066 6c6f  * g,.        flo
+0007e5f0: 6174 202a 2064 2c0a 2020 2020 2020 2020  at * d,.        
+0007e600: 666c 6f61 7420 2a20 7374 6570 2c0a 2020  float * step,.  
+0007e610: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+0007e620: 7420 2a20 7870 2c0a 2020 2020 2020 2020  t * xp,.        
+0007e630: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007e640: 6f72 202a 2066 2c0a 2020 2020 2020 2020  or * f,.        
+0007e650: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+0007e660: 7068 202a 2067 662c 0a20 2020 2020 2020  ph * gf,.       
+0007e670: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+0007e680: 6170 6820 2a20 6762 2c0a 2020 2020 2020  aph * gb,.      
+0007e690: 2020 636f 6e73 7420 696e 7420 6e70 2c0a    const int np,.
+0007e6a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0007e6b0: 676d 6c5f 7465 6e73 6f72 202a 2070 735b  gml_tensor * ps[
+0007e6c0: 5d29 207b 0a20 2020 2069 6e74 2063 6f75  ]) {.    int cou
+0007e6d0: 6e74 203d 2030 3b0a 0a20 2020 2066 6c6f  nt = 0;..    flo
+0007e6e0: 6174 2077 6964 7468 2020 3d20 302e 3066  at width  = 0.0f
+0007e6f0: 3b0a 2020 2020 666c 6f61 7420 6467 2020  ;.    float dg  
+0007e700: 2020 203d 2030 2e30 663b 0a20 2020 2066     = 0.0f;.    f
+0007e710: 6c6f 6174 2066 696e 6974 2020 3d20 302e  loat finit  = 0.
+0007e720: 3066 3b0a 2020 2020 666c 6f61 7420 6467  0f;.    float dg
+0007e730: 696e 6974 203d 2030 2e30 663b 0a20 2020  init = 0.0f;.   
+0007e740: 2066 6c6f 6174 2064 6774 6573 7420 3d20   float dgtest = 
+0007e750: 302e 3066 3b0a 0a20 2020 2063 6f6e 7374  0.0f;..    const
+0007e760: 2066 6c6f 6174 2064 6563 203d 2030 2e35   float dec = 0.5
+0007e770: 663b 0a20 2020 2063 6f6e 7374 2066 6c6f  f;.    const flo
+0007e780: 6174 2069 6e63 203d 2032 2e31 663b 0a0a  at inc = 2.1f;..
+0007e790: 2020 2020 6966 2028 2a73 7465 7020 3c3d      if (*step <=
+0007e7a0: 2030 2e66 2920 7b0a 2020 2020 2020 2020   0.f) {.        
+0007e7b0: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
+0007e7c0: 5345 4152 4348 5f49 4e56 414c 4944 5f50  SEARCH_INVALID_P
+0007e7d0: 4152 414d 4554 4552 533b 0a20 2020 207d  ARAMETERS;.    }
+0007e7e0: 0a0a 2020 2020 2f2f 2063 6f6d 7075 7465  ..    // compute
+0007e7f0: 2074 6865 2069 6e69 7469 616c 2067 7261   the initial gra
+0007e800: 6469 656e 7420 696e 2074 6865 2073 6561  dient in the sea
+0007e810: 7263 6820 6469 7265 6374 696f 6e0a 2020  rch direction.  
+0007e820: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+0007e830: 3332 286e 782c 2026 6467 696e 6974 2c20  32(nx, &dginit, 
+0007e840: 672c 2064 293b 0a0a 2020 2020 2f2f 206d  g, d);..    // m
+0007e850: 616b 6520 7375 7265 2074 6861 7420 6420  ake sure that d 
+0007e860: 706f 696e 7473 2074 6f20 6120 6465 7363  points to a desc
+0007e870: 656e 7420 6469 7265 6374 696f 6e0a 2020  ent direction.  
+0007e880: 2020 6966 2028 3020 3c20 6467 696e 6974    if (0 < dginit
+0007e890: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+0007e8a0: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
+0007e8b0: 4348 5f46 4149 4c3b 0a20 2020 207d 0a0a  CH_FAIL;.    }..
+0007e8c0: 2020 2020 2f2f 2069 6e69 7469 616c 697a      // initializ
+0007e8d0: 6520 6c6f 6361 6c20 7661 7269 6162 6c65  e local variable
+0007e8e0: 730a 2020 2020 6669 6e69 7420 3d20 2a66  s.    finit = *f
+0007e8f0: 783b 0a20 2020 2064 6774 6573 7420 3d20  x;.    dgtest = 
+0007e900: 7061 7261 6d73 2d3e 6c62 6667 732e 6674  params->lbfgs.ft
+0007e910: 6f6c 2a64 6769 6e69 743b 0a0a 2020 2020  ol*dginit;..    
+0007e920: 7768 696c 6520 2874 7275 6529 207b 0a20  while (true) {. 
+0007e930: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0007e940: 6370 795f 6633 3228 6e78 2c20 782c 2078  cpy_f32(nx, x, x
+0007e950: 7029 3b0a 2020 2020 2020 2020 6767 6d6c  p);.        ggml
+0007e960: 5f76 6563 5f6d 6164 5f66 3332 286e 782c  _vec_mad_f32(nx,
+0007e970: 2078 2c20 642c 202a 7374 6570 293b 0a0a   x, d, *step);..
+0007e980: 2020 2020 2020 2020 2f2f 2065 7661 6c75          // evalu
+0007e990: 6174 6520 7468 6520 6675 6e63 7469 6f6e  ate the function
+0007e9a0: 2061 6e64 2067 7261 6469 656e 7420 7661   and gradient va
+0007e9b0: 6c75 6573 0a20 2020 2020 2020 207b 0a20  lues.        {. 
+0007e9c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0007e9d0: 6f70 745f 7365 745f 7061 7261 6d73 286e  opt_set_params(n
+0007e9e0: 702c 2070 732c 2078 293b 0a0a 2020 2020  p, ps, x);..    
+0007e9f0: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
+0007ea00: 7068 5f72 6573 6574 2020 2867 6629 3b0a  ph_reset  (gf);.
+0007ea10: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007ea20: 5f73 6574 5f66 3332 2020 2020 2020 2866  _set_f32      (f
+0007ea30: 2d3e 6772 6164 2c20 312e 3066 293b 0a20  ->grad, 1.0f);. 
+0007ea40: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0007ea50: 6772 6170 685f 636f 6d70 7574 6528 6374  graph_compute(ct
+0007ea60: 782c 2067 6229 3b0a 0a20 2020 2020 2020  x, gb);..       
+0007ea70: 2020 2020 2067 676d 6c5f 6f70 745f 6765       ggml_opt_ge
+0007ea80: 745f 6772 6164 286e 702c 2070 732c 2067  t_grad(np, ps, g
+0007ea90: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0007eaa0: 2a66 7820 3d20 6767 6d6c 5f67 6574 5f66  *fx = ggml_get_f
+0007eab0: 3332 5f31 6428 662c 2030 293b 0a20 2020  32_1d(f, 0);.   
+0007eac0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0007ead0: 2b2b 636f 756e 743b 0a0a 2020 2020 2020  ++count;..      
+0007eae0: 2020 6966 2028 2a66 7820 3e20 6669 6e69    if (*fx > fini
+0007eaf0: 7420 2b20 282a 7374 6570 292a 6467 7465  t + (*step)*dgte
+0007eb00: 7374 2920 7b0a 2020 2020 2020 2020 2020  st) {.          
+0007eb10: 2020 7769 6474 6820 3d20 6465 633b 0a20    width = dec;. 
+0007eb20: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+0007eb30: 2020 2020 2020 2020 2020 2020 2f2f 2041              // A
+0007eb40: 726d 696a 6f20 636f 6e64 6974 696f 6e20  rmijo condition 
+0007eb50: 6973 2073 6174 6973 6669 6564 0a20 2020  is satisfied.   
+0007eb60: 2020 2020 2020 2020 2069 6620 2870 6172           if (par
+0007eb70: 616d 732d 3e6c 6266 6773 2e6c 696e 6573  ams->lbfgs.lines
+0007eb80: 6561 7263 6820 3d3d 2047 474d 4c5f 4c49  earch == GGML_LI
+0007eb90: 4e45 5345 4152 4348 5f42 4143 4b54 5241  NESEARCH_BACKTRA
+0007eba0: 434b 494e 475f 4152 4d49 4a4f 2920 7b0a  CKING_ARMIJO) {.
+0007ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ebc0: 7265 7475 726e 2063 6f75 6e74 3b0a 2020  return count;.  
+0007ebd0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0007ebe0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+0007ebf0: 635f 646f 745f 6633 3228 6e78 2c20 2664  c_dot_f32(nx, &d
+0007ec00: 672c 2067 2c20 6429 3b0a 0a20 2020 2020  g, g, d);..     
+0007ec10: 2020 2020 2020 202f 2f20 6368 6563 6b20         // check 
+0007ec20: 7468 6520 576f 6c66 6520 636f 6e64 6974  the Wolfe condit
+0007ec30: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0007ec40: 6966 2028 6467 203c 2070 6172 616d 732d  if (dg < params-
+0007ec50: 3e6c 6266 6773 2e77 6f6c 6665 202a 2064  >lbfgs.wolfe * d
+0007ec60: 6769 6e69 7429 207b 0a20 2020 2020 2020  ginit) {.       
+0007ec70: 2020 2020 2020 2020 2077 6964 7468 203d           width =
+0007ec80: 2069 6e63 3b0a 2020 2020 2020 2020 2020   inc;.          
+0007ec90: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+0007eca0: 2020 2020 2020 2020 2020 2069 6628 7061             if(pa
+0007ecb0: 7261 6d73 2d3e 6c62 6667 732e 6c69 6e65  rams->lbfgs.line
+0007ecc0: 7365 6172 6368 203d 3d20 4747 4d4c 5f4c  search == GGML_L
+0007ecd0: 494e 4553 4541 5243 485f 4241 434b 5452  INESEARCH_BACKTR
+0007ece0: 4143 4b49 4e47 5f57 4f4c 4645 2920 7b0a  ACKING_WOLFE) {.
+0007ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ed00: 2020 2020 2f2f 2072 6567 756c 6172 2057      // regular W
+0007ed10: 6f6c 6665 2063 6f6e 6469 7469 6f6e 730a  olfe conditions.
+0007ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ed30: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
+0007ed40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007ed50: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+0007ed60: 2020 2020 2069 6628 6467 203e 202d 7061       if(dg > -pa
+0007ed70: 7261 6d73 2d3e 6c62 6667 732e 776f 6c66  rams->lbfgs.wolf
+0007ed80: 652a 6467 696e 6974 2920 7b0a 2020 2020  e*dginit) {.    
+0007ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eda0: 7769 6474 6820 3d20 6465 633b 0a20 2020  width = dec;.   
+0007edb0: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+0007edc0: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+0007edd0: 2020 2020 2020 2020 2020 2f2f 2073 7472            // str
+0007ede0: 6f6e 6720 576f 6c66 6520 636f 6e64 6974  ong Wolfe condit
+0007edf0: 696f 6e20 2847 474d 4c5f 4c49 4e45 5345  ion (GGML_LINESE
+0007ee00: 4152 4348 5f42 4143 4b54 5241 434b 494e  ARCH_BACKTRACKIN
+0007ee10: 475f 5354 524f 4e47 5f57 4f4c 4645 290a  G_STRONG_WOLFE).
+0007ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee30: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
+0007ee40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007ee50: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0007ee60: 2020 2020 7265 7475 726e 2063 6f75 6e74      return count
+0007ee70: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+0007ee80: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0007ee90: 2020 2069 6620 282a 7374 6570 203c 2070     if (*step < p
+0007eea0: 6172 616d 732d 3e6c 6266 6773 2e6d 696e  arams->lbfgs.min
+0007eeb0: 5f73 7465 7029 207b 0a20 2020 2020 2020  _step) {.       
+0007eec0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+0007eed0: 5f4c 494e 4553 4541 5243 485f 4d49 4e49  _LINESEARCH_MINI
+0007eee0: 4d55 4d5f 5354 4550 3b0a 2020 2020 2020  MUM_STEP;.      
+0007eef0: 2020 7d0a 2020 2020 2020 2020 6966 2028    }.        if (
+0007ef00: 2a73 7465 7020 3e20 7061 7261 6d73 2d3e  *step > params->
+0007ef10: 6c62 6667 732e 6d61 785f 7374 6570 2920  lbfgs.max_step) 
+0007ef20: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+0007ef30: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
+0007ef40: 4152 4348 5f4d 4158 494d 554d 5f53 5445  ARCH_MAXIMUM_STE
+0007ef50: 503b 0a20 2020 2020 2020 207d 0a20 2020  P;.        }.   
+0007ef60: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
+0007ef70: 3e6c 6266 6773 2e6d 6178 5f6c 696e 6573  >lbfgs.max_lines
+0007ef80: 6561 7263 6820 3c3d 2063 6f75 6e74 2920  earch <= count) 
+0007ef90: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
+0007efa0: 7475 726e 2047 474d 4c5f 4c49 4e45 5345  turn GGML_LINESE
+0007efb0: 4152 4348 5f4d 4158 494d 554d 5f49 5445  ARCH_MAXIMUM_ITE
+0007efc0: 5241 5449 4f4e 533b 0a20 2020 2020 2020  RATIONS;.       
+0007efd0: 207d 0a0a 2020 2020 2020 2020 282a 7374   }..        (*st
+0007efe0: 6570 2920 2a3d 2077 6964 7468 3b0a 2020  ep) *= width;.  
+0007eff0: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
+0007f000: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
+0007f010: 4641 494c 3b0a 7d0a 0a73 7461 7469 6320  FAIL;.}..static 
+0007f020: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
+0007f030: 7375 6c74 2067 676d 6c5f 6f70 745f 6c62  sult ggml_opt_lb
+0007f040: 6667 7328 0a20 2020 2020 2020 2073 7472  fgs(.        str
+0007f050: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0007f060: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0007f070: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
+0007f080: 7061 7261 6d73 2070 6172 616d 732c 0a20  params params,. 
+0007f090: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0007f0a0: 6d6c 5f74 656e 736f 7220 2a20 662c 0a20  ml_tensor * f,. 
+0007f0b0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0007f0c0: 6d6c 5f63 6772 6170 6820 2a20 6766 2c0a  ml_cgraph * gf,.
+0007f0d0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0007f0e0: 676d 6c5f 6367 7261 7068 202a 2067 6229  gml_cgraph * gb)
+0007f0f0: 207b 0a20 2020 2069 6620 2870 6172 616d   {.    if (param
+0007f100: 732e 6c62 6667 732e 6c69 6e65 7365 6172  s.lbfgs.linesear
+0007f110: 6368 203d 3d20 4747 4d4c 5f4c 494e 4553  ch == GGML_LINES
+0007f120: 4541 5243 485f 4241 434b 5452 4143 4b49  EARCH_BACKTRACKI
+0007f130: 4e47 5f57 4f4c 4645 207c 7c0a 2020 2020  NG_WOLFE ||.    
+0007f140: 2020 2020 7061 7261 6d73 2e6c 6266 6773      params.lbfgs
+0007f150: 2e6c 696e 6573 6561 7263 6820 3d3d 2047  .linesearch == G
+0007f160: 474d 4c5f 4c49 4e45 5345 4152 4348 5f42  GML_LINESEARCH_B
+0007f170: 4143 4b54 5241 434b 494e 475f 5354 524f  ACKTRACKING_STRO
+0007f180: 4e47 5f57 4f4c 4645 2920 7b0a 2020 2020  NG_WOLFE) {.    
+0007f190: 2020 2020 6966 2028 7061 7261 6d73 2e6c      if (params.l
+0007f1a0: 6266 6773 2e77 6f6c 6665 203c 3d20 7061  bfgs.wolfe <= pa
+0007f1b0: 7261 6d73 2e6c 6266 6773 2e66 746f 6c20  rams.lbfgs.ftol 
+0007f1c0: 7c7c 2031 2e66 203c 3d20 7061 7261 6d73  || 1.f <= params
+0007f1d0: 2e6c 6266 6773 2e77 6f6c 6665 2920 7b0a  .lbfgs.wolfe) {.
+0007f1e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0007f1f0: 726e 2047 474d 4c5f 4f50 545f 494e 5641  rn GGML_OPT_INVA
+0007f200: 4c49 445f 574f 4c46 453b 0a20 2020 2020  LID_WOLFE;.     
+0007f210: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+0007f220: 6766 2d3e 6e5f 7468 7265 6164 7320 3d20  gf->n_threads = 
+0007f230: 7061 7261 6d73 2e6e 5f74 6872 6561 6473  params.n_threads
+0007f240: 3b0a 2020 2020 6762 2d3e 6e5f 7468 7265  ;.    gb->n_thre
+0007f250: 6164 7320 3d20 7061 7261 6d73 2e6e 5f74  ads = params.n_t
+0007f260: 6872 6561 6473 3b0a 0a20 2020 2063 6f6e  hreads;..    con
+0007f270: 7374 2069 6e74 206d 203d 2070 6172 616d  st int m = param
+0007f280: 732e 6c62 6667 732e 6d3b 0a0a 2020 2020  s.lbfgs.m;..    
+0007f290: 2f2f 2074 6865 7365 2077 696c 6c20 7374  // these will st
+0007f2a0: 6f72 6520 7468 6520 7061 7261 6d65 7465  ore the paramete
+0007f2b0: 7273 2077 6520 7761 6e74 2074 6f20 6f70  rs we want to op
+0007f2c0: 7469 6d69 7a65 0a20 2020 2073 7472 7563  timize.    struc
+0007f2d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0007f2e0: 7073 5b47 474d 4c5f 4d41 585f 5041 5241  ps[GGML_MAX_PARA
+0007f2f0: 4d53 5d3b 0a0a 2020 2020 696e 7420 6e70  MS];..    int np
+0007f300: 203d 2030 3b0a 2020 2020 696e 7420 6e78   = 0;.    int nx
+0007f310: 203d 2030 3b0a 2020 2020 666f 7220 2869   = 0;.    for (i
+0007f320: 6e74 2069 203d 2030 3b20 6920 3c20 6766  nt i = 0; i < gf
+0007f330: 2d3e 6e5f 6e6f 6465 733b 202b 2b69 2920  ->n_nodes; ++i) 
+0007f340: 7b0a 2020 2020 2020 2020 6966 2028 6766  {.        if (gf
+0007f350: 2d3e 6e6f 6465 735b 695d 2d3e 6973 5f70  ->nodes[i]->is_p
+0007f360: 6172 616d 2920 7b0a 2020 2020 2020 2020  aram) {.        
+0007f370: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+0007f380: 4542 5547 2822 666f 756e 6420 7061 7261  EBUG("found para
+0007f390: 6d20 2564 3a20 6772 6164 2d3e 6f70 203d  m %d: grad->op =
+0007f3a0: 2025 645c 6e22 2c20 6e70 2c20 6766 2d3e   %d\n", np, gf->
+0007f3b0: 6e6f 6465 735b 695d 2d3e 6772 6164 2d3e  nodes[i]->grad->
+0007f3c0: 6f70 293b 0a0a 2020 2020 2020 2020 2020  op);..          
+0007f3d0: 2020 4747 4d4c 5f41 5353 4552 5428 6e70    GGML_ASSERT(np
+0007f3e0: 203c 2047 474d 4c5f 4d41 585f 5041 5241   < GGML_MAX_PARA
+0007f3f0: 4d53 293b 0a0a 2020 2020 2020 2020 2020  MS);..          
+0007f400: 2020 7073 5b6e 702b 2b5d 203d 2067 662d    ps[np++] = gf-
+0007f410: 3e6e 6f64 6573 5b69 5d3b 0a20 2020 2020  >nodes[i];.     
+0007f420: 2020 2020 2020 206e 7820 2b3d 2067 676d         nx += ggm
+0007f430: 6c5f 6e65 6c65 6d65 6e74 7328 6766 2d3e  l_nelements(gf->
+0007f440: 6e6f 6465 735b 695d 293b 0a20 2020 2020  nodes[i]);.     
+0007f450: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
+0007f460: 666c 6f61 7420 2a20 7820 203d 2067 676d  float * x  = ggm
+0007f470: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
+0007f480: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
+0007f490: 3332 2c20 6e78 292d 3e64 6174 613b 202f  32, nx)->data; /
+0007f4a0: 2f20 6375 7272 656e 7420 7061 7261 6d65  / current parame
+0007f4b0: 7465 7273 0a20 2020 2066 6c6f 6174 202a  ters.    float *
+0007f4c0: 2078 7020 3d20 6767 6d6c 5f6e 6577 5f74   xp = ggml_new_t
+0007f4d0: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
+0007f4e0: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
+0007f4f0: 2d3e 6461 7461 3b20 2f2f 2070 7265 7669  ->data; // previ
+0007f500: 6f75 7320 7061 7261 6d65 7465 7273 0a20  ous parameters. 
+0007f510: 2020 2066 6c6f 6174 202a 2067 2020 3d20     float * g  = 
+0007f520: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
+0007f530: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
+0007f540: 455f 4633 322c 206e 7829 2d3e 6461 7461  E_F32, nx)->data
+0007f550: 3b20 2f2f 2063 7572 7265 6e74 2067 7261  ; // current gra
+0007f560: 6469 656e 740a 2020 2020 666c 6f61 7420  dient.    float 
+0007f570: 2a20 6770 203d 2067 676d 6c5f 6e65 775f  * gp = ggml_new_
+0007f580: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
+0007f590: 474d 4c5f 5459 5045 5f46 3332 2c20 6e78  GML_TYPE_F32, nx
+0007f5a0: 292d 3e64 6174 613b 202f 2f20 7072 6576  )->data; // prev
+0007f5b0: 696f 7573 2067 7261 6469 656e 740a 2020  ious gradient.  
+0007f5c0: 2020 666c 6f61 7420 2a20 6420 203d 2067    float * d  = g
+0007f5d0: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+0007f5e0: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+0007f5f0: 5f46 3332 2c20 6e78 292d 3e64 6174 613b  _F32, nx)->data;
+0007f600: 202f 2f20 7365 6172 6368 2064 6972 6563   // search direc
+0007f610: 7469 6f6e 0a0a 2020 2020 666c 6f61 7420  tion..    float 
+0007f620: 2a20 7066 203d 2070 6172 616d 732e 7061  * pf = params.pa
+0007f630: 7374 203e 2030 203f 2067 676d 6c5f 6e65  st > 0 ? ggml_ne
+0007f640: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+0007f650: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+0007f660: 7061 7261 6d73 2e70 6173 7429 2d3e 6461  params.past)->da
+0007f670: 7461 203a 204e 554c 4c3b 202f 2f20 7061  ta : NULL; // pa
+0007f680: 7374 2066 756e 6374 696f 6e20 7661 6c75  st function valu
+0007f690: 6573 0a0a 2020 2020 666c 6f61 7420 6678  es..    float fx
+0007f6a0: 2020 2020 3d20 302e 3066 3b20 2f2f 2063      = 0.0f; // c
+0007f6b0: 6f73 7420 6675 6e63 7469 6f6e 2076 616c  ost function val
+0007f6c0: 7565 0a20 2020 2066 6c6f 6174 2078 6e6f  ue.    float xno
+0007f6d0: 726d 203d 2030 2e30 663b 202f 2f20 7c7c  rm = 0.0f; // ||
+0007f6e0: 787c 7c0a 2020 2020 666c 6f61 7420 676e  x||.    float gn
+0007f6f0: 6f72 6d20 3d20 302e 3066 3b20 2f2f 207c  orm = 0.0f; // |
+0007f700: 7c67 7c7c 0a20 2020 2066 6c6f 6174 2073  |g||.    float s
+0007f710: 7465 7020 203d 2030 2e30 663b 0a0a 2020  tep  = 0.0f;..  
+0007f720: 2020 2f2f 2069 6e69 7469 616c 697a 6520    // initialize 
+0007f730: 7820 6672 6f6d 2074 6865 2067 7261 7068  x from the graph
+0007f740: 206e 6f64 6573 0a20 2020 2067 676d 6c5f   nodes.    ggml_
+0007f750: 6f70 745f 6765 745f 7061 7261 6d73 286e  opt_get_params(n
+0007f760: 702c 2070 732c 2078 293b 0a0a 2020 2020  p, ps, x);..    
+0007f770: 2f2f 2074 6865 204c 2d42 4647 5320 6d65  // the L-BFGS me
+0007f780: 6d6f 7279 0a20 2020 2073 7472 7563 7420  mory.    struct 
+0007f790: 6767 6d6c 5f6c 6266 6773 5f69 7465 7261  ggml_lbfgs_itera
+0007f7a0: 7469 6f6e 5f64 6174 6120 2a20 6c6d 203d  tion_data * lm =
+0007f7b0: 2061 6c6c 6f63 6128 7369 7a65 6f66 2873   alloca(sizeof(s
+0007f7c0: 7472 7563 7420 6767 6d6c 5f6c 6266 6773  truct ggml_lbfgs
+0007f7d0: 5f69 7465 7261 7469 6f6e 5f64 6174 6129  _iteration_data)
+0007f7e0: 2a6d 293b 0a0a 2020 2020 666f 7220 2869  *m);..    for (i
+0007f7f0: 6e74 2069 203d 2030 3b20 6920 3c20 6d3b  nt i = 0; i < m;
+0007f800: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+0007f810: 6c6d 5b69 5d2e 616c 7068 6120 3d20 302e  lm[i].alpha = 0.
+0007f820: 3066 3b0a 2020 2020 2020 2020 6c6d 5b69  0f;.        lm[i
+0007f830: 5d2e 7973 2020 2020 3d20 302e 3066 3b0a  ].ys    = 0.0f;.
+0007f840: 2020 2020 2020 2020 6c6d 5b69 5d2e 7320          lm[i].s 
+0007f850: 2020 2020 3d20 6767 6d6c 5f6e 6577 5f74      = ggml_new_t
+0007f860: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
+0007f870: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
+0007f880: 2d3e 6461 7461 3b0a 2020 2020 2020 2020  ->data;.        
+0007f890: 6c6d 5b69 5d2e 7920 2020 2020 3d20 6767  lm[i].y     = gg
+0007f8a0: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+0007f8b0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+0007f8c0: 4633 322c 206e 7829 2d3e 6461 7461 3b0a  F32, nx)->data;.
+0007f8d0: 2020 2020 7d0a 0a20 2020 202f 2f20 6576      }..    // ev
+0007f8e0: 616c 7561 7465 2074 6865 2066 756e 6374  aluate the funct
+0007f8f0: 696f 6e20 7661 6c75 6520 616e 6420 6974  ion value and it
+0007f900: 7320 6772 6164 6965 6e74 0a20 2020 207b  s gradient.    {
+0007f910: 0a20 2020 2020 2020 2067 676d 6c5f 6f70  .        ggml_op
+0007f920: 745f 7365 745f 7061 7261 6d73 286e 702c  t_set_params(np,
+0007f930: 2070 732c 2078 293b 0a0a 2020 2020 2020   ps, x);..      
+0007f940: 2020 6767 6d6c 5f67 7261 7068 5f72 6573    ggml_graph_res
+0007f950: 6574 2020 2867 6629 3b0a 2020 2020 2020  et  (gf);.      
+0007f960: 2020 6767 6d6c 5f73 6574 5f66 3332 2020    ggml_set_f32  
+0007f970: 2020 2020 2866 2d3e 6772 6164 2c20 312e      (f->grad, 1.
+0007f980: 3066 293b 0a20 2020 2020 2020 2067 676d  0f);.        ggm
+0007f990: 6c5f 6772 6170 685f 636f 6d70 7574 6528  l_graph_compute(
+0007f9a0: 6374 782c 2067 6229 3b0a 0a20 2020 2020  ctx, gb);..     
+0007f9b0: 2020 2067 676d 6c5f 6f70 745f 6765 745f     ggml_opt_get_
+0007f9c0: 6772 6164 286e 702c 2070 732c 2067 293b  grad(np, ps, g);
+0007f9d0: 0a0a 2020 2020 2020 2020 6678 203d 2067  ..        fx = g
+0007f9e0: 676d 6c5f 6765 745f 6633 325f 3164 2866  gml_get_f32_1d(f
+0007f9f0: 2c20 3029 3b0a 2020 2020 7d0a 0a20 2020  , 0);.    }..   
+0007fa00: 2069 6620 2870 6629 207b 0a20 2020 2020   if (pf) {.     
+0007fa10: 2020 2070 665b 305d 203d 2066 783b 0a20     pf[0] = fx;. 
+0007fa20: 2020 207d 0a0a 2020 2020 666c 6f61 7420     }..    float 
+0007fa30: 6678 5f62 6573 7420 3d20 6678 3b0a 0a20  fx_best = fx;.. 
+0007fa40: 2020 202f 2f20 7365 6172 6368 2064 6972     // search dir
+0007fa50: 6563 7469 6f6e 203d 202d 6772 6164 6965  ection = -gradie
+0007fa60: 6e74 0a20 2020 2067 676d 6c5f 7665 635f  nt.    ggml_vec_
+0007fa70: 6e65 675f 6633 3228 6e78 2c20 642c 2067  neg_f32(nx, d, g
+0007fa80: 293b 0a0a 2020 2020 2f2f 207c 7c78 7c7c  );..    // ||x||
+0007fa90: 2c20 7c7c 677c 7c0a 2020 2020 6767 6d6c  , ||g||.    ggml
+0007faa0: 5f76 6563 5f6e 6f72 6d5f 6633 3228 6e78  _vec_norm_f32(nx
+0007fab0: 2c20 2678 6e6f 726d 2c20 7829 3b0a 2020  , &xnorm, x);.  
+0007fac0: 2020 6767 6d6c 5f76 6563 5f6e 6f72 6d5f    ggml_vec_norm_
+0007fad0: 6633 3228 6e78 2c20 2667 6e6f 726d 2c20  f32(nx, &gnorm, 
+0007fae0: 6729 3b0a 0a20 2020 2069 6620 2878 6e6f  g);..    if (xno
+0007faf0: 726d 203c 2031 2e30 6629 207b 0a20 2020  rm < 1.0f) {.   
+0007fb00: 2020 2020 2078 6e6f 726d 203d 2031 2e30       xnorm = 1.0
+0007fb10: 663b 0a20 2020 207d 0a0a 2020 2020 2f2f  f;.    }..    //
+0007fb20: 2061 6c72 6561 6479 206f 7074 696d 697a   already optimiz
+0007fb30: 6564 0a20 2020 2069 6620 2867 6e6f 726d  ed.    if (gnorm
+0007fb40: 2f78 6e6f 726d 203c 3d20 7061 7261 6d73  /xnorm <= params
+0007fb50: 2e6c 6266 6773 2e65 7073 2920 7b0a 2020  .lbfgs.eps) {.  
+0007fb60: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
+0007fb70: 4c5f 4f50 545f 4f4b 3b0a 2020 2020 7d0a  L_OPT_OK;.    }.
+0007fb80: 0a20 2020 202f 2f20 696e 6974 6961 6c20  .    // initial 
+0007fb90: 7374 6570 0a20 2020 2067 676d 6c5f 7665  step.    ggml_ve
+0007fba0: 635f 6e6f 726d 5f69 6e76 5f66 3332 286e  c_norm_inv_f32(n
+0007fbb0: 782c 2026 7374 6570 2c20 6429 3b0a 0a20  x, &step, d);.. 
+0007fbc0: 2020 2069 6e74 206a 2020 2020 2020 2020     int j        
+0007fbd0: 2020 2020 2020 2020 3d20 303b 0a20 2020          = 0;.   
+0007fbe0: 2069 6e74 206b 2020 2020 2020 2020 2020   int k          
+0007fbf0: 2020 2020 2020 3d20 313b 0a20 2020 2069        = 1;.    i
+0007fc00: 6e74 206c 7320 2020 2020 2020 2020 2020  nt ls           
+0007fc10: 2020 2020 3d20 303b 0a20 2020 2069 6e74      = 0;.    int
+0007fc20: 2065 6e64 2020 2020 2020 2020 2020 2020   end            
+0007fc30: 2020 3d20 303b 0a20 2020 2069 6e74 2062    = 0;.    int b
+0007fc40: 6f75 6e64 2020 2020 2020 2020 2020 2020  ound            
+0007fc50: 3d20 303b 0a20 2020 2069 6e74 206e 5f6e  = 0;.    int n_n
+0007fc60: 6f5f 696d 7072 6f76 656d 656e 7420 3d20  o_improvement = 
+0007fc70: 303b 0a0a 2020 2020 666c 6f61 7420 7973  0;..    float ys
+0007fc80: 2020 203d 2030 2e30 663b 0a20 2020 2066     = 0.0f;.    f
+0007fc90: 6c6f 6174 2079 7920 2020 3d20 302e 3066  loat yy   = 0.0f
+0007fca0: 3b0a 2020 2020 666c 6f61 7420 6265 7461  ;.    float beta
+0007fcb0: 203d 2030 2e30 663b 0a0a 2020 2020 7768   = 0.0f;..    wh
+0007fcc0: 696c 6520 2874 7275 6529 207b 0a20 2020  ile (true) {.   
+0007fcd0: 2020 2020 202f 2f20 7374 6f72 6520 7468       // store th
+0007fce0: 6520 6375 7272 656e 7420 706f 7369 7469  e current positi
+0007fcf0: 6f6e 2061 6e64 2067 7261 6469 656e 7420  on and gradient 
+0007fd00: 7665 6374 6f72 730a 2020 2020 2020 2020  vectors.        
+0007fd10: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
+0007fd20: 286e 782c 2078 702c 2078 293b 0a20 2020  (nx, xp, x);.   
+0007fd30: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
+0007fd40: 795f 6633 3228 6e78 2c20 6770 2c20 6729  y_f32(nx, gp, g)
+0007fd50: 3b0a 0a20 2020 2020 2020 206c 7320 3d20  ;..        ls = 
+0007fd60: 6c69 6e65 7365 6172 6368 5f62 6163 6b74  linesearch_backt
+0007fd70: 7261 636b 696e 6728 6374 782c 2026 7061  racking(ctx, &pa
+0007fd80: 7261 6d73 2c20 6e78 2c20 782c 2026 6678  rams, nx, x, &fx
+0007fd90: 2c20 672c 2064 2c20 2673 7465 702c 2078  , g, d, &step, x
+0007fda0: 702c 2066 2c20 6766 2c20 6762 2c20 6e70  p, f, gf, gb, np
+0007fdb0: 2c20 7073 293b 0a0a 2020 2020 2020 2020  , ps);..        
+0007fdc0: 6966 2028 6c73 203c 2030 2920 7b0a 2020  if (ls < 0) {.  
+0007fdd0: 2020 2020 2020 2020 2020 2f2f 206c 696e            // lin
+0007fde0: 6573 6561 7263 6820 6661 696c 6564 202d  esearch failed -
+0007fdf0: 2067 6f20 6261 636b 2074 6f20 7468 6520   go back to the 
+0007fe00: 7072 6576 696f 7573 2070 6f69 6e74 2061  previous point a
+0007fe10: 6e64 2072 6574 7572 6e0a 2020 2020 2020  nd return.      
+0007fe20: 2020 2020 2020 6767 6d6c 5f76 6563 5f63        ggml_vec_c
+0007fe30: 7079 5f66 3332 286e 782c 2078 2c20 7870  py_f32(nx, x, xp
+0007fe40: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
+0007fe50: 676d 6c5f 7665 635f 6370 795f 6633 3228  gml_vec_cpy_f32(
+0007fe60: 6e78 2c20 672c 2067 7029 3b0a 0a20 2020  nx, g, gp);..   
+0007fe70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0007fe80: 6c73 3b0a 2020 2020 2020 2020 7d0a 0a20  ls;.        }.. 
+0007fe90: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0007fea0: 6e6f 726d 5f66 3332 286e 782c 2026 786e  norm_f32(nx, &xn
+0007feb0: 6f72 6d2c 2078 293b 0a20 2020 2020 2020  orm, x);.       
+0007fec0: 2067 676d 6c5f 7665 635f 6e6f 726d 5f66   ggml_vec_norm_f
+0007fed0: 3332 286e 782c 2026 676e 6f72 6d2c 2067  32(nx, &gnorm, g
+0007fee0: 293b 0a0a 2020 2020 2020 2020 4747 4d4c  );..        GGML
+0007fef0: 5f50 5249 4e54 5f44 4542 5547 2822 6620  _PRINT_DEBUG("f 
+0007ff00: 3d20 2531 302e 3666 5c6e 222c 2067 676d  = %10.6f\n", ggm
+0007ff10: 6c5f 6765 745f 6633 325f 3164 2866 2c20  l_get_f32_1d(f, 
+0007ff20: 3029 293b 0a0a 2020 2020 2020 2020 6966  0));..        if
+0007ff30: 2028 786e 6f72 6d20 3c20 312e 3066 2920   (xnorm < 1.0f) 
+0007ff40: 7b0a 2020 2020 2020 2020 2020 2020 786e  {.            xn
+0007ff50: 6f72 6d20 3d20 312e 3066 3b0a 2020 2020  orm = 1.0f;.    
+0007ff60: 2020 2020 7d0a 2020 2020 2020 2020 6966      }.        if
+0007ff70: 2028 676e 6f72 6d2f 786e 6f72 6d20 3c3d   (gnorm/xnorm <=
+0007ff80: 2070 6172 616d 732e 6c62 6667 732e 6570   params.lbfgs.ep
+0007ff90: 7329 207b 0a20 2020 2020 2020 2020 2020  s) {.           
+0007ffa0: 202f 2f20 636f 6e76 6572 6765 640a 2020   // converged.  
+0007ffb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0007ffc0: 2047 474d 4c5f 4f50 545f 4f4b 3b0a 2020   GGML_OPT_OK;.  
+0007ffd0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0007ffe0: 202f 2f20 6465 6c74 612d 6261 7365 6420   // delta-based 
+0007fff0: 636f 6e76 6572 6765 6e63 6520 7465 7374  convergence test
+00080000: 0a20 2020 2020 2020 2069 6620 2870 6620  .        if (pf 
+00080010: 213d 204e 554c 4c29 207b 0a20 2020 2020  != NULL) {.     
+00080020: 2020 2020 2020 202f 2f20 6e65 6564 2061         // need a
+00080030: 7420 6c65 6173 7420 7061 7261 6d73 2e70  t least params.p
+00080040: 6173 7420 6974 6572 6174 696f 6e73 2074  ast iterations t
+00080050: 6f20 7374 6172 7420 6368 6563 6b69 6e67  o start checking
+00080060: 2066 6f72 2063 6f6e 7665 7267 656e 6365   for convergence
+00080070: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00080080: 2870 6172 616d 732e 7061 7374 203c 3d20  (params.past <= 
+00080090: 6b29 207b 0a20 2020 2020 2020 2020 2020  k) {.           
+000800a0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+000800b0: 2072 6174 6520 3d20 2870 665b 6b25 7061   rate = (pf[k%pa
+000800c0: 7261 6d73 2e70 6173 745d 202d 2066 7829  rams.past] - fx)
+000800d0: 2f66 783b 0a0a 2020 2020 2020 2020 2020  /fx;..          
+000800e0: 2020 2020 2020 6966 2028 6661 6273 6628        if (fabsf(
+000800f0: 7261 7465 2920 3c20 7061 7261 6d73 2e64  rate) < params.d
+00080100: 656c 7461 2920 7b0a 2020 2020 2020 2020  elta) {.        
+00080110: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00080120: 726e 2047 474d 4c5f 4f50 545f 4f4b 3b0a  rn GGML_OPT_OK;.
+00080130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080140: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+00080150: 0a20 2020 2020 2020 2020 2020 2070 665b  .            pf[
+00080160: 6b25 7061 7261 6d73 2e70 6173 745d 203d  k%params.past] =
+00080170: 2066 783b 0a20 2020 2020 2020 207d 0a0a   fx;.        }..
+00080180: 2020 2020 2020 2020 2f2f 2063 6865 636b          // check
+00080190: 2066 6f72 2069 6d70 726f 7665 6d65 6e74   for improvement
+000801a0: 0a20 2020 2020 2020 2069 6620 2870 6172  .        if (par
+000801b0: 616d 732e 6d61 785f 6e6f 5f69 6d70 726f  ams.max_no_impro
+000801c0: 7665 6d65 6e74 203e 2030 2920 7b0a 2020  vement > 0) {.  
+000801d0: 2020 2020 2020 2020 2020 6966 2028 6678            if (fx
+000801e0: 203c 2066 785f 6265 7374 2920 7b0a 2020   < fx_best) {.  
+000801f0: 2020 2020 2020 2020 2020 2020 2020 6678                fx
+00080200: 5f62 6573 7420 3d20 6678 3b0a 2020 2020  _best = fx;.    
+00080210: 2020 2020 2020 2020 2020 2020 6e5f 6e6f              n_no
+00080220: 5f69 6d70 726f 7665 6d65 6e74 203d 2030  _improvement = 0
+00080230: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00080240: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+00080250: 2020 2020 2020 206e 5f6e 6f5f 696d 7072         n_no_impr
+00080260: 6f76 656d 656e 742b 2b3b 0a0a 2020 2020  ovement++;..    
+00080270: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00080280: 6e5f 6e6f 5f69 6d70 726f 7665 6d65 6e74  n_no_improvement
+00080290: 203e 3d20 7061 7261 6d73 2e6d 6178 5f6e   >= params.max_n
+000802a0: 6f5f 696d 7072 6f76 656d 656e 7429 207b  o_improvement) {
+000802b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000802c0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+000802d0: 5f4f 5054 5f4f 4b3b 0a20 2020 2020 2020  _OPT_OK;.       
+000802e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000802f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00080300: 207d 0a0a 2020 2020 2020 2020 6966 2028   }..        if (
+00080310: 7061 7261 6d73 2e6c 6266 6773 2e6e 5f69  params.lbfgs.n_i
+00080320: 7465 7220 213d 2030 2026 2620 7061 7261  ter != 0 && para
+00080330: 6d73 2e6c 6266 6773 2e6e 5f69 7465 7220  ms.lbfgs.n_iter 
+00080340: 3c20 6b20 2b20 3129 207b 0a20 2020 2020  < k + 1) {.     
+00080350: 2020 2020 2020 202f 2f20 7265 6163 6865         // reache
+00080360: 6420 7468 6520 6d61 7869 6d75 6d20 6e75  d the maximum nu
+00080370: 6d62 6572 206f 6620 6974 6572 6174 696f  mber of iteratio
+00080380: 6e73 0a20 2020 2020 2020 2020 2020 2072  ns.            r
+00080390: 6574 7572 6e20 4747 4d4c 5f4f 5054 5f44  eturn GGML_OPT_D
+000803a0: 4944 5f4e 4f54 5f43 4f4e 5645 5247 453b  ID_NOT_CONVERGE;
+000803b0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+000803c0: 2020 2020 2f2f 2075 7064 6174 6520 7665      // update ve
+000803d0: 6374 6f72 7320 7320 616e 6420 793a 0a20  ctors s and y:. 
+000803e0: 2020 2020 2020 202f 2f20 2020 735f 7b6b         //   s_{k
+000803f0: 2b31 7d20 3d20 785f 7b6b 2b31 7d20 2d20  +1} = x_{k+1} - 
+00080400: 785f 7b6b 7d20 3d20 5c73 7465 7020 2a20  x_{k} = \step * 
+00080410: 645f 7b6b 7d2e 0a20 2020 2020 2020 202f  d_{k}..        /
+00080420: 2f20 2020 795f 7b6b 2b31 7d20 3d20 675f  /   y_{k+1} = g_
+00080430: 7b6b 2b31 7d20 2d20 675f 7b6b 7d2e 0a20  {k+1} - g_{k}.. 
+00080440: 2020 2020 2020 202f 2f0a 2020 2020 2020         //.      
+00080450: 2020 6767 6d6c 5f76 6563 5f73 7562 5f66    ggml_vec_sub_f
+00080460: 3332 286e 782c 206c 6d5b 656e 645d 2e73  32(nx, lm[end].s
+00080470: 2c20 782c 2078 7029 3b0a 2020 2020 2020  , x, xp);.      
+00080480: 2020 6767 6d6c 5f76 6563 5f73 7562 5f66    ggml_vec_sub_f
+00080490: 3332 286e 782c 206c 6d5b 656e 645d 2e79  32(nx, lm[end].y
+000804a0: 2c20 672c 2067 7029 3b0a 0a20 2020 2020  , g, gp);..     
+000804b0: 2020 202f 2f20 636f 6d70 7574 6520 7363     // compute sc
+000804c0: 616c 6172 7320 7973 2061 6e64 2079 793a  alars ys and yy:
+000804d0: 0a20 2020 2020 2020 202f 2f20 2020 2020  .        //     
+000804e0: 7973 203d 2079 5e74 205c 6364 6f74 2073  ys = y^t \cdot s
+000804f0: 2020 2020 2d3e 2031 202f 205c 7268 6f2e      -> 1 / \rho.
+00080500: 0a20 2020 2020 2020 202f 2f20 2020 2020  .        //     
+00080510: 7979 203d 2079 5e74 205c 6364 6f74 2079  yy = y^t \cdot y
+00080520: 2e0a 2020 2020 2020 2020 2f2f 0a20 2020  ..        //.   
+00080530: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
+00080540: 745f 6633 3228 6e78 2c20 2679 732c 206c  t_f32(nx, &ys, l
+00080550: 6d5b 656e 645d 2e79 2c20 6c6d 5b65 6e64  m[end].y, lm[end
+00080560: 5d2e 7329 3b0a 2020 2020 2020 2020 6767  ].s);.        gg
+00080570: 6d6c 5f76 6563 5f64 6f74 5f66 3332 286e  ml_vec_dot_f32(n
+00080580: 782c 2026 7979 2c20 6c6d 5b65 6e64 5d2e  x, &yy, lm[end].
+00080590: 792c 206c 6d5b 656e 645d 2e79 293b 0a0a  y, lm[end].y);..
+000805a0: 2020 2020 2020 2020 6c6d 5b65 6e64 5d2e          lm[end].
+000805b0: 7973 203d 2079 733b 0a0a 2020 2020 2020  ys = ys;..      
+000805c0: 2020 2f2f 2066 696e 6420 6e65 7720 7365    // find new se
+000805d0: 6172 6368 2064 6972 6563 7469 6f6e 0a20  arch direction. 
+000805e0: 2020 2020 2020 202f 2f20 2020 7265 663a         //   ref:
+000805f0: 2068 7474 7073 3a2f 2f65 6e2e 7769 6b69   https://en.wiki
+00080600: 7065 6469 612e 6f72 672f 7769 6b69 2f4c  pedia.org/wiki/L
+00080610: 696d 6974 6564 2d6d 656d 6f72 795f 4246  imited-memory_BF
+00080620: 4753 0a0a 2020 2020 2020 2020 626f 756e  GS..        boun
+00080630: 6420 3d20 286d 203c 3d20 6b29 203f 206d  d = (m <= k) ? m
+00080640: 203a 206b 3b0a 2020 2020 2020 2020 6b2b   : k;.        k+
+00080650: 2b3b 0a20 2020 2020 2020 2065 6e64 203d  +;.        end =
+00080660: 2028 656e 6420 2b20 3129 256d 3b0a 0a20   (end + 1)%m;.. 
+00080670: 2020 2020 2020 202f 2f20 696e 6974 6961         // initia
+00080680: 6c69 7a65 2073 6561 7263 6820 6469 7265  lize search dire
+00080690: 6374 696f 6e20 7769 7468 202d 670a 2020  ction with -g.  
+000806a0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6e        ggml_vec_n
+000806b0: 6567 5f66 3332 286e 782c 2064 2c20 6729  eg_f32(nx, d, g)
+000806c0: 3b0a 0a20 2020 2020 2020 206a 203d 2065  ;..        j = e
+000806d0: 6e64 3b0a 2020 2020 2020 2020 666f 7220  nd;.        for 
+000806e0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+000806f0: 626f 756e 643b 202b 2b69 2920 7b0a 2020  bound; ++i) {.  
+00080700: 2020 2020 2020 2020 2020 6a20 3d20 286a            j = (j
+00080710: 202b 206d 202d 2031 2920 2520 6d3b 0a20   + m - 1) % m;. 
+00080720: 2020 2020 2020 2020 2020 202f 2f20 5c61             // \a
+00080730: 6c70 6861 5f7b 6a7d 203d 205c 7268 6f5f  lpha_{j} = \rho_
+00080740: 7b6a 7d20 735e 7b74 7d5f 7b6a 7d20 5c63  {j} s^{t}_{j} \c
+00080750: 646f 7420 715f 7b6b 2b31 7d0a 2020 2020  dot q_{k+1}.    
+00080760: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00080770: 5f64 6f74 5f66 3332 286e 782c 2026 6c6d  _dot_f32(nx, &lm
+00080780: 5b6a 5d2e 616c 7068 612c 206c 6d5b 6a5d  [j].alpha, lm[j]
+00080790: 2e73 2c20 6429 3b0a 2020 2020 2020 2020  .s, d);.        
+000807a0: 2020 2020 6c6d 5b6a 5d2e 616c 7068 6120      lm[j].alpha 
+000807b0: 2f3d 206c 6d5b 6a5d 2e79 733b 0a20 2020  /= lm[j].ys;.   
+000807c0: 2020 2020 2020 2020 202f 2f20 715f 7b69           // q_{i
+000807d0: 7d20 3d20 715f 7b69 2b31 7d20 2d20 5c61  } = q_{i+1} - \a
+000807e0: 6c70 6861 5f7b 697d 2079 5f7b 697d 0a20  lpha_{i} y_{i}. 
+000807f0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00080800: 7665 635f 6d61 645f 6633 3228 6e78 2c20  vec_mad_f32(nx, 
+00080810: 642c 206c 6d5b 6a5d 2e79 2c20 2d6c 6d5b  d, lm[j].y, -lm[
+00080820: 6a5d 2e61 6c70 6861 293b 0a20 2020 2020  j].alpha);.     
+00080830: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
+00080840: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+00080850: 286e 782c 2064 2c20 7973 2f79 7929 3b0a  (nx, d, ys/yy);.
+00080860: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00080870: 7420 6920 3d20 303b 2069 203c 2062 6f75  t i = 0; i < bou
+00080880: 6e64 3b20 2b2b 6929 207b 0a20 2020 2020  nd; ++i) {.     
+00080890: 2020 2020 2020 202f 2f20 5c62 6574 615f         // \beta_
+000808a0: 7b6a 7d20 3d20 5c72 686f 5f7b 6a7d 2079  {j} = \rho_{j} y
+000808b0: 5e74 5f7b 6a7d 205c 6364 6f74 205c 6761  ^t_{j} \cdot \ga
+000808c0: 6d6d 615f 7b69 7d0a 2020 2020 2020 2020  mma_{i}.        
+000808d0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+000808e0: 5f66 3332 286e 782c 2026 6265 7461 2c20  _f32(nx, &beta, 
+000808f0: 6c6d 5b6a 5d2e 792c 2064 293b 0a20 2020  lm[j].y, d);.   
+00080900: 2020 2020 2020 2020 2062 6574 6120 2f3d           beta /=
+00080910: 206c 6d5b 6a5d 2e79 733b 0a20 2020 2020   lm[j].ys;.     
+00080920: 2020 2020 2020 202f 2f20 5c67 616d 6d61         // \gamma
+00080930: 5f7b 692b 317d 203d 205c 6761 6d6d 615f  _{i+1} = \gamma_
+00080940: 7b69 7d20 2b20 285c 616c 7068 615f 7b6a  {i} + (\alpha_{j
+00080950: 7d20 2d20 5c62 6574 615f 7b6a 7d29 2073  } - \beta_{j}) s
+00080960: 5f7b 6a7d 0a20 2020 2020 2020 2020 2020  _{j}.           
+00080970: 2067 676d 6c5f 7665 635f 6d61 645f 6633   ggml_vec_mad_f3
+00080980: 3228 6e78 2c20 642c 206c 6d5b 6a5d 2e73  2(nx, d, lm[j].s
+00080990: 2c20 6c6d 5b6a 5d2e 616c 7068 6120 2d20  , lm[j].alpha - 
+000809a0: 6265 7461 293b 0a20 2020 2020 2020 2020  beta);.         
+000809b0: 2020 206a 203d 2028 6a20 2b20 3129 256d     j = (j + 1)%m
+000809c0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+000809d0: 2020 2020 2073 7465 7020 3d20 312e 303b       step = 1.0;
+000809e0: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
+000809f0: 726e 2047 474d 4c5f 4f50 545f 4449 445f  rn GGML_OPT_DID_
+00080a00: 4e4f 545f 434f 4e56 4552 4745 3b0a 7d0a  NOT_CONVERGE;.}.
+00080a10: 0a73 7472 7563 7420 6767 6d6c 5f6f 7074  .struct ggml_opt
+00080a20: 5f70 6172 616d 7320 6767 6d6c 5f6f 7074  _params ggml_opt
+00080a30: 5f64 6566 6175 6c74 5f70 6172 616d 7328  _default_params(
+00080a40: 656e 756d 2067 676d 6c5f 6f70 745f 7479  enum ggml_opt_ty
+00080a50: 7065 2074 7970 6529 207b 0a20 2020 2073  pe type) {.    s
+00080a60: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
+00080a70: 6172 616d 7320 7265 7375 6c74 3b0a 0a20  arams result;.. 
+00080a80: 2020 2073 7769 7463 6820 2874 7970 6529     switch (type)
+00080a90: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+00080aa0: 4747 4d4c 5f4f 5054 5f41 4441 4d3a 0a20  GGML_OPT_ADAM:. 
+00080ab0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00080ac0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00080ad0: 756c 7420 3d20 2873 7472 7563 7420 6767  ult = (struct gg
+00080ae0: 6d6c 5f6f 7074 5f70 6172 616d 7329 207b  ml_opt_params) {
+00080af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080b00: 2020 2020 202e 7479 7065 2020 2020 2020       .type      
+00080b10: 3d20 4747 4d4c 5f4f 5054 5f41 4441 4d2c  = GGML_OPT_ADAM,
+00080b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00080b30: 2020 2020 202e 6e5f 7468 7265 6164 7320       .n_threads 
+00080b40: 3d20 312c 0a20 2020 2020 2020 2020 2020  = 1,.           
+00080b50: 2020 2020 2020 2020 202e 7061 7374 2020           .past  
+00080b60: 2020 2020 3d20 302c 0a20 2020 2020 2020      = 0,.       
+00080b70: 2020 2020 2020 2020 2020 2020 202e 6465               .de
+00080b80: 6c74 6120 2020 2020 3d20 3165 2d35 662c  lta     = 1e-5f,
+00080b90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00080ba0: 2020 2020 2020 2e6d 6178 5f6e 6f5f 696d        .max_no_im
+00080bb0: 7072 6f76 656d 656e 7420 3d20 3130 302c  provement = 100,
+00080bc0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00080bd0: 2020 2020 2020 2e70 7269 6e74 5f66 6f72        .print_for
+00080be0: 7761 7264 5f67 7261 7068 2020 3d20 7472  ward_graph  = tr
+00080bf0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00080c00: 2020 2020 2020 2020 2e70 7269 6e74 5f62          .print_b
+00080c10: 6163 6b77 6172 645f 6772 6170 6820 3d20  ackward_graph = 
+00080c20: 7472 7565 2c0a 0a20 2020 2020 2020 2020  true,..         
+00080c30: 2020 2020 2020 2020 2020 202e 6164 616d             .adam
+00080c40: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00080c50: 2020 2020 2020 2020 2020 2020 202e 6e5f               .n_
+00080c60: 6974 6572 203d 2031 3030 3030 2c0a 2020  iter = 10000,.  
 00080c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080c80: 202e 616c 7068 6120 203d 2030 2e30 3031   .alpha  = 0.001
-00080c90: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
-00080ca0: 2020 2020 2020 2020 2020 202e 6265 7461             .beta
-00080cb0: 3120 203d 2030 2e39 662c 0a20 2020 2020  1  = 0.9f,.     
+00080c80: 2020 2020 2020 2e61 6c70 6861 2020 3d20        .alpha  = 
+00080c90: 302e 3030 3166 2c0a 2020 2020 2020 2020  0.001f,.        
+00080ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080cb0: 2e62 6574 6131 2020 3d20 302e 3966 2c0a  .beta1  = 0.9f,.
 00080cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080cd0: 2020 202e 6265 7461 3220 203d 2030 2e39     .beta2  = 0.9
-00080ce0: 3939 662c 0a20 2020 2020 2020 2020 2020  99f,.           
-00080cf0: 2020 2020 2020 2020 2020 2020 202e 6570               .ep
-00080d00: 7320 2020 203d 2031 652d 3866 2c0a 2020  s    = 1e-8f,.  
-00080d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080d20: 2020 2020 2020 2e65 7073 5f66 2020 3d20        .eps_f  = 
-00080d30: 3165 2d35 662c 0a20 2020 2020 2020 2020  1e-5f,.         
-00080d40: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00080d50: 6570 735f 6720 203d 2031 652d 3366 2c0a  eps_g  = 1e-3f,.
-00080d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080d70: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00080d80: 2020 2020 2020 207d 3b0a 2020 2020 2020         };.      
-00080d90: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00080da0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00080db0: 5f4f 5054 5f4c 4246 4753 3a0a 2020 2020  _OPT_LBFGS:.    
-00080dc0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00080dd0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00080de0: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
-00080df0: 6f70 745f 7061 7261 6d73 2920 7b0a 2020  opt_params) {.  
-00080e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080e10: 2020 2e74 7970 6520 2020 2020 203d 2047    .type      = G
-00080e20: 474d 4c5f 4f50 545f 4c42 4647 532c 0a20  GML_OPT_LBFGS,. 
-00080e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080e40: 2020 202e 6e5f 7468 7265 6164 7320 3d20     .n_threads = 
-00080e50: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00080e60: 2020 2020 2020 202e 7061 7374 2020 2020         .past    
-00080e70: 2020 3d20 302c 0a20 2020 2020 2020 2020    = 0,.         
-00080e80: 2020 2020 2020 2020 2020 202e 6465 6c74             .delt
-00080e90: 6120 2020 2020 3d20 3165 2d35 662c 0a0a  a     = 1e-5f,..
-00080ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080eb0: 2020 2020 2e6d 6178 5f6e 6f5f 696d 7072      .max_no_impr
-00080ec0: 6f76 656d 656e 7420 3d20 302c 0a0a 2020  ovement = 0,..  
-00080ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ee0: 2020 2e70 7269 6e74 5f66 6f72 7761 7264    .print_forward
-00080ef0: 5f67 7261 7068 2020 3d20 7472 7565 2c0a  _graph  = true,.
-00080f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080f10: 2020 2020 2e70 7269 6e74 5f62 6163 6b77      .print_backw
-00080f20: 6172 645f 6772 6170 6820 3d20 7472 7565  ard_graph = true
-00080f30: 2c0a 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00080f40: 2020 2020 2020 202e 6c62 6667 7320 3d20         .lbfgs = 
-00080f50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00080f60: 2020 2020 2020 2020 2020 2e6d 2020 2020            .m    
-00080f70: 2020 2020 2020 2020 2020 3d20 362c 0a20            = 6,. 
-00080f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080f90: 2020 2020 2020 202e 6e5f 6974 6572 2020         .n_iter  
-00080fa0: 2020 2020 2020 203d 2031 3030 2c0a 2020         = 100,.  
-00080fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080fc0: 2020 2020 2020 2e6d 6178 5f6c 696e 6573        .max_lines
-00080fd0: 6561 7263 6820 3d20 3230 2c0a 0a20 2020  earch = 20,..   
-00080fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00080ff0: 2020 2020 202e 6570 7320 2020 2020 203d       .eps      =
-00081000: 2031 652d 3566 2c0a 2020 2020 2020 2020   1e-5f,.        
+00080cd0: 2020 2020 2020 2020 2e62 6574 6132 2020          .beta2  
+00080ce0: 3d20 302e 3939 3966 2c0a 2020 2020 2020  = 0.999f,.      
+00080cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080d00: 2020 2e65 7073 2020 2020 3d20 3165 2d38    .eps    = 1e-8
+00080d10: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+00080d20: 2020 2020 2020 2020 2020 202e 6570 735f             .eps_
+00080d30: 6620 203d 2031 652d 3566 2c0a 2020 2020  f  = 1e-5f,.    
+00080d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080d50: 2020 2020 2e65 7073 5f67 2020 3d20 3165      .eps_g  = 1e
+00080d60: 2d33 662c 0a20 2020 2020 2020 2020 2020  -3f,.           
+00080d70: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+00080d80: 2020 2020 2020 2020 2020 2020 7d3b 0a20              };. 
+00080d90: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00080da0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00080db0: 2047 474d 4c5f 4f50 545f 4c42 4647 533a   GGML_OPT_LBFGS:
+00080dc0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00080dd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00080de0: 6573 756c 7420 3d20 2873 7472 7563 7420  esult = (struct 
+00080df0: 6767 6d6c 5f6f 7074 5f70 6172 616d 7329  ggml_opt_params)
+00080e00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00080e10: 2020 2020 2020 202e 7479 7065 2020 2020         .type    
+00080e20: 2020 3d20 4747 4d4c 5f4f 5054 5f4c 4246    = GGML_OPT_LBF
+00080e30: 4753 2c0a 2020 2020 2020 2020 2020 2020  GS,.            
+00080e40: 2020 2020 2020 2020 2e6e 5f74 6872 6561          .n_threa
+00080e50: 6473 203d 2031 2c0a 2020 2020 2020 2020  ds = 1,.        
+00080e60: 2020 2020 2020 2020 2020 2020 2e70 6173              .pas
+00080e70: 7420 2020 2020 203d 2030 2c0a 2020 2020  t      = 0,.    
+00080e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00080e90: 2e64 656c 7461 2020 2020 203d 2031 652d  .delta     = 1e-
+00080ea0: 3566 2c0a 0a20 2020 2020 2020 2020 2020  5f,..           
+00080eb0: 2020 2020 2020 2020 202e 6d61 785f 6e6f           .max_no
+00080ec0: 5f69 6d70 726f 7665 6d65 6e74 203d 2030  _improvement = 0
+00080ed0: 2c0a 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00080ee0: 2020 2020 2020 202e 7072 696e 745f 666f         .print_fo
+00080ef0: 7277 6172 645f 6772 6170 6820 203d 2074  rward_graph  = t
+00080f00: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00080f10: 2020 2020 2020 2020 202e 7072 696e 745f           .print_
+00080f20: 6261 636b 7761 7264 5f67 7261 7068 203d  backward_graph =
+00080f30: 2074 7275 652c 0a0a 2020 2020 2020 2020   true,..        
+00080f40: 2020 2020 2020 2020 2020 2020 2e6c 6266              .lbf
+00080f50: 6773 203d 207b 0a20 2020 2020 2020 2020  gs = {.         
+00080f60: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00080f70: 6d20 2020 2020 2020 2020 2020 2020 203d  m              =
+00080f80: 2036 2c0a 2020 2020 2020 2020 2020 2020   6,.            
+00080f90: 2020 2020 2020 2020 2020 2020 2e6e 5f69              .n_i
+00080fa0: 7465 7220 2020 2020 2020 2020 3d20 3130  ter         = 10
+00080fb0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00080fc0: 2020 2020 2020 2020 2020 202e 6d61 785f             .max_
+00080fd0: 6c69 6e65 7365 6172 6368 203d 2032 302c  linesearch = 20,
+00080fe0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00080ff0: 2020 2020 2020 2020 2020 2e65 7073 2020            .eps  
+00081000: 2020 2020 3d20 3165 2d35 662c 0a20 2020      = 1e-5f,.   
 00081010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081020: 2e66 746f 6c20 2020 2020 3d20 3165 2d34  .ftol     = 1e-4
-00081030: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
-00081040: 2020 2020 2020 2020 2020 202e 776f 6c66             .wolf
-00081050: 6520 2020 203d 2030 2e39 662c 0a20 2020  e    = 0.9f,.   
-00081060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081070: 2020 2020 202e 6d69 6e5f 7374 6570 203d       .min_step =
-00081080: 2031 652d 3230 662c 0a20 2020 2020 2020   1e-20f,.       
+00081020: 2020 2020 202e 6674 6f6c 2020 2020 203d       .ftol     =
+00081030: 2031 652d 3466 2c0a 2020 2020 2020 2020   1e-4f,.        
+00081040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081050: 2e77 6f6c 6665 2020 2020 3d20 302e 3966  .wolfe    = 0.9f
+00081060: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00081070: 2020 2020 2020 2020 2020 2e6d 696e 5f73            .min_s
+00081080: 7465 7020 3d20 3165 2d32 3066 2c0a 2020  tep = 1e-20f,.  
 00081090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000810a0: 202e 6d61 785f 7374 6570 203d 2031 652b   .max_step = 1e+
-000810b0: 3230 662c 0a0a 2020 2020 2020 2020 2020  20f,..          
-000810c0: 2020 2020 2020 2020 2020 2020 2020 2e6c                .l
-000810d0: 696e 6573 6561 7263 6820 3d20 4747 4d4c  inesearch = GGML
-000810e0: 5f4c 494e 4553 4541 5243 485f 4445 4641  _LINESEARCH_DEFA
-000810f0: 554c 542c 0a20 2020 2020 2020 2020 2020  ULT,.           
-00081100: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-00081110: 2020 2020 2020 2020 2020 2020 7d3b 0a20              };. 
-00081120: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00081130: 616b 3b0a 2020 2020 7d0a 0a20 2020 2072  ak;.    }..    r
-00081140: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-00081150: 0a65 6e75 6d20 6767 6d6c 5f6f 7074 5f72  .enum ggml_opt_r
-00081160: 6573 756c 7420 6767 6d6c 5f6f 7074 280a  esult ggml_opt(.
-00081170: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00081180: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
-00081190: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
-000811a0: 7420 6767 6d6c 5f6f 7074 5f70 6172 616d  t ggml_opt_param
-000811b0: 7320 7061 7261 6d73 2c0a 2020 2020 2020  s params,.      
-000811c0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000811d0: 6e73 6f72 202a 2066 2920 7b0a 2020 2020  nsor * f) {.    
-000811e0: 626f 6f6c 2066 7265 655f 6374 7820 3d20  bool free_ctx = 
-000811f0: 6661 6c73 653b 0a20 2020 2069 6620 2863  false;.    if (c
-00081200: 7478 203d 3d20 4e55 4c4c 2920 7b0a 2020  tx == NULL) {.  
-00081210: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00081220: 6c5f 696e 6974 5f70 6172 616d 7320 7061  l_init_params pa
-00081230: 7261 6d73 5f63 7478 203d 207b 0a20 2020  rams_ctx = {.   
-00081240: 2020 2020 2020 2020 202e 6d65 6d5f 7369           .mem_si
-00081250: 7a65 2020 203d 2031 362a 3130 3234 2a31  ze   = 16*1024*1
-00081260: 3032 342c 0a20 2020 2020 2020 2020 2020  024,.           
-00081270: 202e 6d65 6d5f 6275 6666 6572 203d 204e   .mem_buffer = N
-00081280: 554c 4c2c 0a20 2020 2020 2020 2020 2020  ULL,.           
-00081290: 202e 6e6f 5f61 6c6c 6f63 2020 203d 2066   .no_alloc   = f
-000812a0: 616c 7365 2c0a 2020 2020 2020 2020 7d3b  alse,.        };
-000812b0: 0a0a 2020 2020 2020 2020 6374 7820 3d20  ..        ctx = 
-000812c0: 6767 6d6c 5f69 6e69 7428 7061 7261 6d73  ggml_init(params
-000812d0: 5f63 7478 293b 0a20 2020 2020 2020 2069  _ctx);.        i
-000812e0: 6620 2863 7478 203d 3d20 4e55 4c4c 2920  f (ctx == NULL) 
-000812f0: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-00081300: 7475 726e 2047 474d 4c5f 4f50 545f 4e4f  turn GGML_OPT_NO
-00081310: 5f43 4f4e 5445 5854 3b0a 2020 2020 2020  _CONTEXT;.      
-00081320: 2020 7d0a 0a20 2020 2020 2020 2066 7265    }..        fre
-00081330: 655f 6374 7820 3d20 7472 7565 3b0a 2020  e_ctx = true;.  
-00081340: 2020 7d0a 0a20 2020 2065 6e75 6d20 6767    }..    enum gg
-00081350: 6d6c 5f6f 7074 5f72 6573 756c 7420 7265  ml_opt_result re
-00081360: 7375 6c74 203d 2047 474d 4c5f 4f50 545f  sult = GGML_OPT_
-00081370: 4f4b 3b0a 0a20 2020 202f 2f20 6275 696c  OK;..    // buil
-00081380: 6420 666f 7277 6172 6420 2b20 6261 636b  d forward + back
-00081390: 7761 7264 2063 6f6d 7075 7465 2067 7261  ward compute gra
-000813a0: 7068 730a 2020 2020 7374 7275 6374 2067  phs.    struct g
-000813b0: 676d 6c5f 6367 7261 7068 2067 6620 3d20  gml_cgraph gf = 
-000813c0: 6767 6d6c 5f62 7569 6c64 5f66 6f72 7761  ggml_build_forwa
-000813d0: 7264 2028 6629 3b0a 2020 2020 7374 7275  rd (f);.    stru
-000813e0: 6374 2067 676d 6c5f 6367 7261 7068 2067  ct ggml_cgraph g
-000813f0: 6220 3d20 6767 6d6c 5f62 7569 6c64 5f62  b = ggml_build_b
-00081400: 6163 6b77 6172 6428 6374 782c 2026 6766  ackward(ctx, &gf
-00081410: 2c20 7472 7565 293b 0a0a 2020 2020 7377  , true);..    sw
-00081420: 6974 6368 2028 7061 7261 6d73 2e74 7970  itch (params.typ
-00081430: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
-00081440: 6520 4747 4d4c 5f4f 5054 5f41 4441 4d3a  e GGML_OPT_ADAM:
-00081450: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00081460: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00081470: 6573 756c 7420 3d20 6767 6d6c 5f6f 7074  esult = ggml_opt
-00081480: 5f61 6461 6d28 6374 782c 2070 6172 616d  _adam(ctx, param
-00081490: 732c 2066 2c20 2667 662c 2026 6762 293b  s, f, &gf, &gb);
-000814a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000814b0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000814c0: 7365 2047 474d 4c5f 4f50 545f 4c42 4647  se GGML_OPT_LBFG
-000814d0: 533a 0a20 2020 2020 2020 2020 2020 207b  S:.            {
-000814e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000814f0: 2072 6573 756c 7420 3d20 6767 6d6c 5f6f   result = ggml_o
-00081500: 7074 5f6c 6266 6773 2863 7478 2c20 7061  pt_lbfgs(ctx, pa
-00081510: 7261 6d73 2c20 662c 2026 6766 2c20 2667  rams, f, &gf, &g
-00081520: 6229 3b0a 2020 2020 2020 2020 2020 2020  b);.            
-00081530: 7d20 6272 6561 6b3b 0a20 2020 207d 0a0a  } break;.    }..
-00081540: 2020 2020 6966 2028 7061 7261 6d73 2e70      if (params.p
-00081550: 7269 6e74 5f66 6f72 7761 7264 5f67 7261  rint_forward_gra
-00081560: 7068 2920 7b0a 2020 2020 2020 2020 6767  ph) {.        gg
-00081570: 6d6c 5f67 7261 7068 5f70 7269 6e74 2020  ml_graph_print  
-00081580: 2028 2667 6629 3b0a 2020 2020 2020 2020   (&gf);.        
-00081590: 6767 6d6c 5f67 7261 7068 5f64 756d 705f  ggml_graph_dump_
-000815a0: 646f 7428 2667 662c 204e 554c 4c2c 2022  dot(&gf, NULL, "
-000815b0: 6f70 742d 666f 7277 6172 642e 646f 7422  opt-forward.dot"
-000815c0: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
-000815d0: 2028 7061 7261 6d73 2e70 7269 6e74 5f62   (params.print_b
-000815e0: 6163 6b77 6172 645f 6772 6170 6829 207b  ackward_graph) {
-000815f0: 0a20 2020 2020 2020 2067 676d 6c5f 6772  .        ggml_gr
-00081600: 6170 685f 7072 696e 7420 2020 2826 6762  aph_print   (&gb
-00081610: 293b 0a20 2020 2020 2020 2067 676d 6c5f  );.        ggml_
-00081620: 6772 6170 685f 6475 6d70 5f64 6f74 2826  graph_dump_dot(&
-00081630: 6762 2c20 2667 662c 2022 6f70 742d 6261  gb, &gf, "opt-ba
-00081640: 636b 7761 7264 2e64 6f74 2229 3b0a 2020  ckward.dot");.  
-00081650: 2020 7d0a 0a20 2020 2069 6620 2866 7265    }..    if (fre
-00081660: 655f 6374 7829 207b 0a20 2020 2020 2020  e_ctx) {.       
-00081670: 2067 676d 6c5f 6672 6565 2863 7478 293b   ggml_free(ctx);
-00081680: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-00081690: 726e 2072 6573 756c 743b 0a7d 0a0a 2f2f  rn result;.}..//
-000816a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000810a0: 2020 2020 2020 2e6d 6178 5f73 7465 7020        .max_step 
+000810b0: 3d20 3165 2b32 3066 2c0a 0a20 2020 2020  = 1e+20f,..     
+000810c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000810d0: 2020 202e 6c69 6e65 7365 6172 6368 203d     .linesearch =
+000810e0: 2047 474d 4c5f 4c49 4e45 5345 4152 4348   GGML_LINESEARCH
+000810f0: 5f44 4546 4155 4c54 2c0a 2020 2020 2020  _DEFAULT,.      
+00081100: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+00081110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081120: 207d 3b0a 2020 2020 2020 2020 2020 2020   };.            
+00081130: 7d20 6272 6561 6b3b 0a20 2020 207d 0a0a  } break;.    }..
+00081140: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+00081150: 743b 0a7d 0a0a 656e 756d 2067 676d 6c5f  t;.}..enum ggml_
+00081160: 6f70 745f 7265 7375 6c74 2067 676d 6c5f  opt_result ggml_
+00081170: 6f70 7428 0a20 2020 2020 2020 2073 7472  opt(.        str
+00081180: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+00081190: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+000811a0: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
+000811b0: 7061 7261 6d73 2070 6172 616d 732c 0a20  params params,. 
+000811c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+000811d0: 6d6c 5f74 656e 736f 7220 2a20 6629 207b  ml_tensor * f) {
+000811e0: 0a20 2020 2062 6f6f 6c20 6672 6565 5f63  .    bool free_c
+000811f0: 7478 203d 2066 616c 7365 3b0a 2020 2020  tx = false;.    
+00081200: 6966 2028 6374 7820 3d3d 204e 554c 4c29  if (ctx == NULL)
+00081210: 207b 0a20 2020 2020 2020 2073 7472 7563   {.        struc
+00081220: 7420 6767 6d6c 5f69 6e69 745f 7061 7261  t ggml_init_para
+00081230: 6d73 2070 6172 616d 735f 6374 7820 3d20  ms params_ctx = 
+00081240: 7b0a 2020 2020 2020 2020 2020 2020 2e6d  {.            .m
+00081250: 656d 5f73 697a 6520 2020 3d20 3136 2a31  em_size   = 16*1
+00081260: 3032 342a 3130 3234 2c0a 2020 2020 2020  024*1024,.      
+00081270: 2020 2020 2020 2e6d 656d 5f62 7566 6665        .mem_buffe
+00081280: 7220 3d20 4e55 4c4c 2c0a 2020 2020 2020  r = NULL,.      
+00081290: 2020 2020 2020 2e6e 6f5f 616c 6c6f 6320        .no_alloc 
+000812a0: 2020 3d20 6661 6c73 652c 0a20 2020 2020    = false,.     
+000812b0: 2020 207d 3b0a 0a20 2020 2020 2020 2063     };..        c
+000812c0: 7478 203d 2067 676d 6c5f 696e 6974 2870  tx = ggml_init(p
+000812d0: 6172 616d 735f 6374 7829 3b0a 2020 2020  arams_ctx);.    
+000812e0: 2020 2020 6966 2028 6374 7820 3d3d 204e      if (ctx == N
+000812f0: 554c 4c29 207b 0a20 2020 2020 2020 2020  ULL) {.         
+00081300: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+00081310: 5054 5f4e 4f5f 434f 4e54 4558 543b 0a20  PT_NO_CONTEXT;. 
+00081320: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00081330: 2020 6672 6565 5f63 7478 203d 2074 7275    free_ctx = tru
+00081340: 653b 0a20 2020 207d 0a0a 2020 2020 656e  e;.    }..    en
+00081350: 756d 2067 676d 6c5f 6f70 745f 7265 7375  um ggml_opt_resu
+00081360: 6c74 2072 6573 756c 7420 3d20 4747 4d4c  lt result = GGML
+00081370: 5f4f 5054 5f4f 4b3b 0a0a 2020 2020 2f2f  _OPT_OK;..    //
+00081380: 2062 7569 6c64 2066 6f72 7761 7264 202b   build forward +
+00081390: 2062 6163 6b77 6172 6420 636f 6d70 7574   backward comput
+000813a0: 6520 6772 6170 6873 0a20 2020 2073 7472  e graphs.    str
+000813b0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+000813c0: 6766 203d 2067 676d 6c5f 6275 696c 645f  gf = ggml_build_
+000813d0: 666f 7277 6172 6420 2866 293b 0a20 2020  forward (f);.   
+000813e0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+000813f0: 6170 6820 6762 203d 2067 676d 6c5f 6275  aph gb = ggml_bu
+00081400: 696c 645f 6261 636b 7761 7264 2863 7478  ild_backward(ctx
+00081410: 2c20 2667 662c 2074 7275 6529 3b0a 0a20  , &gf, true);.. 
+00081420: 2020 2073 7769 7463 6820 2870 6172 616d     switch (param
+00081430: 732e 7479 7065 2920 7b0a 2020 2020 2020  s.type) {.      
+00081440: 2020 6361 7365 2047 474d 4c5f 4f50 545f    case GGML_OPT_
+00081450: 4144 414d 3a0a 2020 2020 2020 2020 2020  ADAM:.          
+00081460: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00081470: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
+00081480: 6c5f 6f70 745f 6164 616d 2863 7478 2c20  l_opt_adam(ctx, 
+00081490: 7061 7261 6d73 2c20 662c 2026 6766 2c20  params, f, &gf, 
+000814a0: 2667 6229 3b0a 2020 2020 2020 2020 2020  &gb);.          
+000814b0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000814c0: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
+000814d0: 5f4c 4246 4753 3a0a 2020 2020 2020 2020  _LBFGS:.        
+000814e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000814f0: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
+00081500: 676d 6c5f 6f70 745f 6c62 6667 7328 6374  gml_opt_lbfgs(ct
+00081510: 782c 2070 6172 616d 732c 2066 2c20 2667  x, params, f, &g
+00081520: 662c 2026 6762 293b 0a20 2020 2020 2020  f, &gb);.       
+00081530: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00081540: 2020 7d0a 0a20 2020 2069 6620 2870 6172    }..    if (par
+00081550: 616d 732e 7072 696e 745f 666f 7277 6172  ams.print_forwar
+00081560: 645f 6772 6170 6829 207b 0a20 2020 2020  d_graph) {.     
+00081570: 2020 2067 676d 6c5f 6772 6170 685f 7072     ggml_graph_pr
+00081580: 696e 7420 2020 2826 6766 293b 0a20 2020  int   (&gf);.   
+00081590: 2020 2020 2067 676d 6c5f 6772 6170 685f       ggml_graph_
+000815a0: 6475 6d70 5f64 6f74 2826 6766 2c20 4e55  dump_dot(&gf, NU
+000815b0: 4c4c 2c20 226f 7074 2d66 6f72 7761 7264  LL, "opt-forward
+000815c0: 2e64 6f74 2229 3b0a 2020 2020 7d0a 0a20  .dot");.    }.. 
+000815d0: 2020 2069 6620 2870 6172 616d 732e 7072     if (params.pr
+000815e0: 696e 745f 6261 636b 7761 7264 5f67 7261  int_backward_gra
+000815f0: 7068 2920 7b0a 2020 2020 2020 2020 6767  ph) {.        gg
+00081600: 6d6c 5f67 7261 7068 5f70 7269 6e74 2020  ml_graph_print  
+00081610: 2028 2667 6229 3b0a 2020 2020 2020 2020   (&gb);.        
+00081620: 6767 6d6c 5f67 7261 7068 5f64 756d 705f  ggml_graph_dump_
+00081630: 646f 7428 2667 622c 2026 6766 2c20 226f  dot(&gb, &gf, "o
+00081640: 7074 2d62 6163 6b77 6172 642e 646f 7422  pt-backward.dot"
+00081650: 293b 0a20 2020 207d 0a0a 2020 2020 6966  );.    }..    if
+00081660: 2028 6672 6565 5f63 7478 2920 7b0a 2020   (free_ctx) {.  
+00081670: 2020 2020 2020 6767 6d6c 5f66 7265 6528        ggml_free(
+00081680: 6374 7829 3b0a 2020 2020 7d0a 0a20 2020  ctx);.    }..   
+00081690: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
+000816a0: 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  }../////////////
 000816b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 000816c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 000816d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000816e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a  //////////////..
-000816f0: 7369 7a65 5f74 2067 676d 6c5f 7175 616e  size_t ggml_quan
-00081700: 7469 7a65 5f71 345f 3028 636f 6e73 7420  tize_q4_0(const 
-00081710: 666c 6f61 7420 2a20 7372 632c 2076 6f69  float * src, voi
-00081720: 6420 2a20 6473 742c 2069 6e74 206e 2c20  d * dst, int n, 
-00081730: 696e 7420 6b2c 2069 6e74 3634 5f74 202a  int k, int64_t *
-00081740: 2068 6973 7429 207b 0a20 2020 2061 7373   hist) {.    ass
-00081750: 6572 7428 6b20 2520 514b 345f 3020 3d3d  ert(k % QK4_0 ==
-00081760: 2030 293b 0a20 2020 2063 6f6e 7374 2069   0);.    const i
-00081770: 6e74 206e 6220 3d20 6b20 2f20 514b 345f  nt nb = k / QK4_
-00081780: 303b 0a0a 2020 2020 666f 7220 2869 6e74  0;..    for (int
-00081790: 2062 203d 2030 3b20 6220 3c20 6e3b 2062   b = 0; b < n; b
-000817a0: 202b 3d20 6b29 207b 0a20 2020 2020 2020   += k) {.       
-000817b0: 2062 6c6f 636b 5f71 345f 3020 2a20 7265   block_q4_0 * re
-000817c0: 7374 7269 6374 2079 203d 2028 626c 6f63  strict y = (bloc
-000817d0: 6b5f 7134 5f30 202a 2920 6473 7420 2b20  k_q4_0 *) dst + 
-000817e0: 622f 514b 345f 303b 0a0a 2020 2020 2020  b/QK4_0;..      
-000817f0: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
-00081800: 345f 305f 7265 6665 7265 6e63 6528 7372  4_0_reference(sr
-00081810: 6320 2b20 622c 2079 2c20 6b29 3b0a 0a20  c + b, y, k);.. 
-00081820: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00081830: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
-00081840: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-00081850: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-00081860: 3b20 6a20 3c20 514b 345f 303b 206a 202b  ; j < QK4_0; j +
-00081870: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
-00081880: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-00081890: 7438 5f74 2076 6930 203d 2079 5b69 5d2e  t8_t vi0 = y[i].
-000818a0: 7173 5b6a 2f32 5d20 2620 3078 3046 3b0a  qs[j/2] & 0x0F;.
-000818b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000818c0: 636f 6e73 7420 7569 6e74 385f 7420 7669  const uint8_t vi
-000818d0: 3120 3d20 795b 695d 2e71 735b 6a2f 325d  1 = y[i].qs[j/2]
-000818e0: 203e 3e20 343b 0a0a 2020 2020 2020 2020   >> 4;..        
-000818f0: 2020 2020 2020 2020 6869 7374 5b76 6930          hist[vi0
-00081900: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
-00081910: 2020 2020 2068 6973 745b 7669 315d 2b2b       hist[vi1]++
-00081920: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00081930: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00081940: 0a20 2020 2072 6574 7572 6e20 286e 2f51  .    return (n/Q
-00081950: 4b34 5f30 2a73 697a 656f 6628 626c 6f63  K4_0*sizeof(bloc
-00081960: 6b5f 7134 5f30 2929 3b0a 7d0a 0a73 697a  k_q4_0));.}..siz
-00081970: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
-00081980: 655f 7134 5f31 2863 6f6e 7374 2066 6c6f  e_q4_1(const flo
-00081990: 6174 202a 2073 7263 2c20 766f 6964 202a  at * src, void *
-000819a0: 2064 7374 2c20 696e 7420 6e2c 2069 6e74   dst, int n, int
-000819b0: 206b 2c20 696e 7436 345f 7420 2a20 6869   k, int64_t * hi
-000819c0: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-000819d0: 286b 2025 2051 4b34 5f31 203d 3d20 3029  (k % QK4_1 == 0)
-000819e0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000819f0: 6e62 203d 206b 202f 2051 4b34 5f31 3b0a  nb = k / QK4_1;.
-00081a00: 0a20 2020 2066 6f72 2028 696e 7420 6220  .    for (int b 
-00081a10: 3d20 303b 2062 203c 206e 3b20 6220 2b3d  = 0; b < n; b +=
-00081a20: 206b 2920 7b0a 2020 2020 2020 2020 626c   k) {.        bl
-00081a30: 6f63 6b5f 7134 5f31 202a 2072 6573 7472  ock_q4_1 * restr
-00081a40: 6963 7420 7920 3d20 2862 6c6f 636b 5f71  ict y = (block_q
-00081a50: 345f 3120 2a29 2064 7374 202b 2062 2f51  4_1 *) dst + b/Q
-00081a60: 4b34 5f31 3b0a 0a20 2020 2020 2020 2071  K4_1;..        q
-00081a70: 7561 6e74 697a 655f 726f 775f 7134 5f31  uantize_row_q4_1
-00081a80: 5f72 6566 6572 656e 6365 2873 7263 202b  _reference(src +
-00081a90: 2062 2c20 792c 206b 293b 0a0a 2020 2020   b, y, k);..    
-00081aa0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00081ab0: 2030 3b20 6920 3c20 6e62 3b20 692b 2b29   0; i < nb; i++)
-00081ac0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-00081ad0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-00081ae0: 203c 2051 4b34 5f31 3b20 6a20 2b3d 2032   < QK4_1; j += 2
-00081af0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00081b00: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-00081b10: 7420 7669 3020 3d20 795b 695d 2e71 735b  t vi0 = y[i].qs[
-00081b20: 6a2f 325d 2026 2030 7830 463b 0a20 2020  j/2] & 0x0F;.   
-00081b30: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00081b40: 7374 2075 696e 7438 5f74 2076 6931 203d  st uint8_t vi1 =
-00081b50: 2079 5b69 5d2e 7173 5b6a 2f32 5d20 3e3e   y[i].qs[j/2] >>
-00081b60: 2034 3b0a 0a20 2020 2020 2020 2020 2020   4;..           
-00081b70: 2020 2020 2068 6973 745b 7669 305d 2b2b       hist[vi0]++
-00081b80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00081b90: 2020 6869 7374 5b76 6931 5d2b 2b3b 0a20    hist[vi1]++;. 
-00081ba0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00081bb0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-00081bc0: 2020 7265 7475 726e 2028 6e2f 514b 345f    return (n/QK4_
-00081bd0: 312a 7369 7a65 6f66 2862 6c6f 636b 5f71  1*sizeof(block_q
-00081be0: 345f 3129 293b 0a7d 0a0a 7369 7a65 5f74  4_1));.}..size_t
-00081bf0: 2067 676d 6c5f 7175 616e 7469 7a65 5f71   ggml_quantize_q
-00081c00: 355f 3028 636f 6e73 7420 666c 6f61 7420  5_0(const float 
-00081c10: 2a20 7372 632c 2076 6f69 6420 2a20 6473  * src, void * ds
-00081c20: 742c 2069 6e74 206e 2c20 696e 7420 6b2c  t, int n, int k,
-00081c30: 2069 6e74 3634 5f74 202a 2068 6973 7429   int64_t * hist)
-00081c40: 207b 0a20 2020 2061 7373 6572 7428 6b20   {.    assert(k 
-00081c50: 2520 514b 355f 3020 3d3d 2030 293b 0a20  % QK5_0 == 0);. 
-00081c60: 2020 2063 6f6e 7374 2069 6e74 206e 6220     const int nb 
-00081c70: 3d20 6b20 2f20 514b 355f 303b 0a0a 2020  = k / QK5_0;..  
-00081c80: 2020 666f 7220 2869 6e74 2062 203d 2030    for (int b = 0
-00081c90: 3b20 6220 3c20 6e3b 2062 202b 3d20 6b29  ; b < n; b += k)
-00081ca0: 207b 0a20 2020 2020 2020 2062 6c6f 636b   {.        block
-00081cb0: 5f71 355f 3020 2a20 7265 7374 7269 6374  _q5_0 * restrict
-00081cc0: 2079 203d 2028 626c 6f63 6b5f 7135 5f30   y = (block_q5_0
-00081cd0: 202a 2964 7374 202b 2062 2f51 4b35 5f30   *)dst + b/QK5_0
-00081ce0: 3b0a 0a20 2020 2020 2020 2071 7561 6e74  ;..        quant
-00081cf0: 697a 655f 726f 775f 7135 5f30 5f72 6566  ize_row_q5_0_ref
-00081d00: 6572 656e 6365 2873 7263 202b 2062 2c20  erence(src + b, 
-00081d10: 792c 206b 293b 0a0a 2020 2020 2020 2020  y, k);..        
-00081d20: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00081d30: 6920 3c20 6e62 3b20 692b 2b29 207b 0a20  i < nb; i++) {. 
-00081d40: 2020 2020 2020 2020 2020 2075 696e 7433             uint3
-00081d50: 325f 7420 7168 3b0a 2020 2020 2020 2020  2_t qh;.        
-00081d60: 2020 2020 6d65 6d63 7079 2826 7168 2c20      memcpy(&qh, 
-00081d70: 2679 5b69 5d2e 7168 2c20 7369 7a65 6f66  &y[i].qh, sizeof
-00081d80: 2871 6829 293b 0a0a 2020 2020 2020 2020  (qh));..        
-00081d90: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-00081da0: 2030 3b20 6a20 3c20 514b 355f 303b 206a   0; j < QK5_0; j
-00081db0: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
-00081dc0: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-00081dd0: 696e 7438 5f74 2076 6830 203d 2028 2871  int8_t vh0 = ((q
-00081de0: 6820 2620 2831 7520 3c3c 2028 6a20 2b20  h & (1u << (j + 
-00081df0: 3020 2929 2920 3e3e 2028 6a20 2b20 3020  0 ))) >> (j + 0 
-00081e00: 2929 203c 3c20 343b 0a20 2020 2020 2020  )) << 4;.       
-00081e10: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
-00081e20: 696e 7438 5f74 2076 6831 203d 2028 2871  int8_t vh1 = ((q
-00081e30: 6820 2620 2831 7520 3c3c 2028 6a20 2b20  h & (1u << (j + 
-00081e40: 3136 2929 2920 3e3e 2028 6a20 2b20 3132  16))) >> (j + 12
-00081e50: 2929 3b0a 0a20 2020 2020 2020 2020 2020  ));..           
-00081e60: 2020 2020 202f 2f20 6361 7374 2074 6f20       // cast to 
-00081e70: 3136 2062 696e 730a 2020 2020 2020 2020  16 bins.        
-00081e80: 2020 2020 2020 2020 636f 6e73 7420 7569          const ui
-00081e90: 6e74 385f 7420 7669 3020 3d20 2828 795b  nt8_t vi0 = ((y[
-00081ea0: 695d 2e71 735b 6a2f 325d 2026 2030 7830  i].qs[j/2] & 0x0
-00081eb0: 4629 207c 2076 6830 2920 2f20 323b 0a20  F) | vh0) / 2;. 
-00081ec0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00081ed0: 6f6e 7374 2075 696e 7438 5f74 2076 6931  onst uint8_t vi1
-00081ee0: 203d 2028 2879 5b69 5d2e 7173 5b6a 2f32   = ((y[i].qs[j/2
-00081ef0: 5d20 3e3e 2020 2034 2920 7c20 7668 3129  ] >>   4) | vh1)
-00081f00: 202f 2032 3b0a 0a20 2020 2020 2020 2020   / 2;..         
-00081f10: 2020 2020 2020 2068 6973 745b 7669 305d         hist[vi0]
-00081f20: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
-00081f30: 2020 2020 6869 7374 5b76 6931 5d2b 2b3b      hist[vi1]++;
-00081f40: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-00081f50: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-00081f60: 2020 2020 7265 7475 726e 2028 6e2f 514b      return (n/QK
-00081f70: 355f 302a 7369 7a65 6f66 2862 6c6f 636b  5_0*sizeof(block
-00081f80: 5f71 355f 3029 293b 0a7d 0a0a 7369 7a65  _q5_0));.}..size
-00081f90: 5f74 2067 676d 6c5f 7175 616e 7469 7a65  _t ggml_quantize
-00081fa0: 5f71 355f 3128 636f 6e73 7420 666c 6f61  _q5_1(const floa
-00081fb0: 7420 2a20 7372 632c 2076 6f69 6420 2a20  t * src, void * 
-00081fc0: 6473 742c 2069 6e74 206e 2c20 696e 7420  dst, int n, int 
-00081fd0: 6b2c 2069 6e74 3634 5f74 202a 2068 6973  k, int64_t * his
-00081fe0: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-00081ff0: 6b20 2520 514b 355f 3120 3d3d 2030 293b  k % QK5_1 == 0);
-00082000: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00082010: 6220 3d20 6b20 2f20 514b 355f 313b 0a0a  b = k / QK5_1;..
-00082020: 2020 2020 666f 7220 2869 6e74 2062 203d      for (int b =
-00082030: 2030 3b20 6220 3c20 6e3b 2062 202b 3d20   0; b < n; b += 
-00082040: 6b29 207b 0a20 2020 2020 2020 2062 6c6f  k) {.        blo
-00082050: 636b 5f71 355f 3120 2a20 7265 7374 7269  ck_q5_1 * restri
-00082060: 6374 2079 203d 2028 626c 6f63 6b5f 7135  ct y = (block_q5
-00082070: 5f31 202a 2964 7374 202b 2062 2f51 4b35  _1 *)dst + b/QK5
-00082080: 5f31 3b0a 0a20 2020 2020 2020 2071 7561  _1;..        qua
-00082090: 6e74 697a 655f 726f 775f 7135 5f31 5f72  ntize_row_q5_1_r
-000820a0: 6566 6572 656e 6365 2873 7263 202b 2062  eference(src + b
-000820b0: 2c20 792c 206b 293b 0a0a 2020 2020 2020  , y, k);..      
-000820c0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-000820d0: 3b20 6920 3c20 6e62 3b20 692b 2b29 207b  ; i < nb; i++) {
-000820e0: 0a20 2020 2020 2020 2020 2020 2075 696e  .            uin
-000820f0: 7433 325f 7420 7168 3b0a 2020 2020 2020  t32_t qh;.      
-00082100: 2020 2020 2020 6d65 6d63 7079 2826 7168        memcpy(&qh
-00082110: 2c20 2679 5b69 5d2e 7168 2c20 7369 7a65  , &y[i].qh, size
-00082120: 6f66 2871 6829 293b 0a0a 2020 2020 2020  of(qh));..      
-00082130: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-00082140: 203d 2030 3b20 6a20 3c20 514b 355f 313b   = 0; j < QK5_1;
-00082150: 206a 202b 3d20 3229 207b 0a20 2020 2020   j += 2) {.     
-00082160: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00082170: 2075 696e 7438 5f74 2076 6830 203d 2028   uint8_t vh0 = (
-00082180: 2871 6820 2620 2831 7520 3c3c 2028 6a20  (qh & (1u << (j 
-00082190: 2b20 3020 2929 2920 3e3e 2028 6a20 2b20  + 0 ))) >> (j + 
-000821a0: 3020 2929 203c 3c20 343b 0a20 2020 2020  0 )) << 4;.     
-000821b0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000821c0: 2075 696e 7438 5f74 2076 6831 203d 2028   uint8_t vh1 = (
-000821d0: 2871 6820 2620 2831 7520 3c3c 2028 6a20  (qh & (1u << (j 
-000821e0: 2b20 3136 2929 2920 3e3e 2028 6a20 2b20  + 16))) >> (j + 
-000821f0: 3132 2929 3b0a 0a20 2020 2020 2020 2020  12));..         
-00082200: 2020 2020 2020 202f 2f20 6361 7374 2074         // cast t
-00082210: 6f20 3136 2062 696e 730a 2020 2020 2020  o 16 bins.      
-00082220: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00082230: 7569 6e74 385f 7420 7669 3020 3d20 2828  uint8_t vi0 = ((
-00082240: 795b 695d 2e71 735b 6a2f 325d 2026 2030  y[i].qs[j/2] & 0
-00082250: 7830 4629 207c 2076 6830 2920 2f20 323b  x0F) | vh0) / 2;
-00082260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082270: 2063 6f6e 7374 2075 696e 7438 5f74 2076   const uint8_t v
-00082280: 6931 203d 2028 2879 5b69 5d2e 7173 5b6a  i1 = ((y[i].qs[j
-00082290: 2f32 5d20 3e3e 2020 2034 2920 7c20 7668  /2] >>   4) | vh
-000822a0: 3129 202f 2032 3b0a 0a20 2020 2020 2020  1) / 2;..       
-000822b0: 2020 2020 2020 2020 2068 6973 745b 7669           hist[vi
-000822c0: 305d 2b2b 3b0a 2020 2020 2020 2020 2020  0]++;.          
-000822d0: 2020 2020 2020 6869 7374 5b76 6931 5d2b        hist[vi1]+
-000822e0: 2b3b 0a20 2020 2020 2020 2020 2020 207d  +;.            }
-000822f0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00082300: 0a0a 2020 2020 7265 7475 726e 2028 6e2f  ..    return (n/
-00082310: 514b 355f 312a 7369 7a65 6f66 2862 6c6f  QK5_1*sizeof(blo
-00082320: 636b 5f71 355f 3129 293b 0a7d 0a0a 7369  ck_q5_1));.}..si
-00082330: 7a65 5f74 2067 676d 6c5f 7175 616e 7469  ze_t ggml_quanti
-00082340: 7a65 5f71 385f 3028 636f 6e73 7420 666c  ze_q8_0(const fl
-00082350: 6f61 7420 2a20 7372 632c 2076 6f69 6420  oat * src, void 
-00082360: 2a20 6473 742c 2069 6e74 206e 2c20 696e  * dst, int n, in
-00082370: 7420 6b2c 2069 6e74 3634 5f74 202a 2068  t k, int64_t * h
-00082380: 6973 7429 207b 0a20 2020 2061 7373 6572  ist) {.    asser
-00082390: 7428 6b20 2520 514b 385f 3020 3d3d 2030  t(k % QK8_0 == 0
-000823a0: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
-000823b0: 206e 6220 3d20 6b20 2f20 514b 385f 303b   nb = k / QK8_0;
-000823c0: 0a0a 2020 2020 666f 7220 2869 6e74 2062  ..    for (int b
-000823d0: 203d 2030 3b20 6220 3c20 6e3b 2062 202b   = 0; b < n; b +
-000823e0: 3d20 6b29 207b 0a20 2020 2020 2020 2062  = k) {.        b
-000823f0: 6c6f 636b 5f71 385f 3020 2a20 7265 7374  lock_q8_0 * rest
-00082400: 7269 6374 2079 203d 2028 626c 6f63 6b5f  rict y = (block_
-00082410: 7138 5f30 202a 2964 7374 202b 2062 2f51  q8_0 *)dst + b/Q
-00082420: 4b38 5f30 3b0a 0a20 2020 2020 2020 2071  K8_0;..        q
-00082430: 7561 6e74 697a 655f 726f 775f 7138 5f30  uantize_row_q8_0
-00082440: 5f72 6566 6572 656e 6365 2873 7263 202b  _reference(src +
-00082450: 2062 2c20 792c 206b 293b 0a0a 2020 2020   b, y, k);..    
-00082460: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-00082470: 2030 3b20 6920 3c20 6e62 3b20 692b 2b29   0; i < nb; i++)
-00082480: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-00082490: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-000824a0: 203c 2051 4b38 5f30 3b20 2b2b 6a29 207b   < QK8_0; ++j) {
-000824b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000824c0: 2063 6f6e 7374 2069 6e74 385f 7420 7669   const int8_t vi
-000824d0: 203d 2079 5b69 5d2e 7173 5b6a 5d3b 0a0a   = y[i].qs[j];..
-000824e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000824f0: 6869 7374 5b76 692f 3136 202b 2038 5d2b  hist[vi/16 + 8]+
-00082500: 2b3b 0a20 2020 2020 2020 2020 2020 207d  +;.            }
-00082510: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00082520: 0a0a 2020 2020 7265 7475 726e 2028 6e2f  ..    return (n/
-00082530: 514b 385f 302a 7369 7a65 6f66 2862 6c6f  QK8_0*sizeof(blo
-00082540: 636b 5f71 385f 3029 293b 0a7d 0a0a 7369  ck_q8_0));.}..si
-00082550: 7a65 5f74 2067 676d 6c5f 7175 616e 7469  ze_t ggml_quanti
-00082560: 7a65 5f63 6875 6e6b 2865 6e75 6d20 6767  ze_chunk(enum gg
-00082570: 6d6c 5f74 7970 6520 7479 7065 2c20 636f  ml_type type, co
-00082580: 6e73 7420 666c 6f61 7420 2a20 7372 632c  nst float * src,
-00082590: 2076 6f69 6420 2a20 6473 742c 2069 6e74   void * dst, int
-000825a0: 2073 7461 7274 2c20 696e 7420 6e2c 2069   start, int n, i
-000825b0: 6e74 3634 5f74 202a 2068 6973 7429 207b  nt64_t * hist) {
-000825c0: 0a20 2020 2073 697a 655f 7420 7265 7375  .    size_t resu
-000825d0: 6c74 203d 2030 3b0a 2020 2020 7377 6974  lt = 0;.    swit
-000825e0: 6368 2028 7479 7065 2920 7b0a 2020 2020  ch (type) {.    
-000825f0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00082600: 5045 5f51 345f 303a 0a20 2020 2020 2020  PE_Q4_0:.       
-00082610: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00082620: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00082630: 5254 2873 7461 7274 2025 2051 4b34 5f30  RT(start % QK4_0
-00082640: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
-00082650: 2020 2020 2020 2020 626c 6f63 6b5f 7134          block_q4
-00082660: 5f30 202a 2062 6c6f 636b 203d 2028 626c  _0 * block = (bl
-00082670: 6f63 6b5f 7134 5f30 2a29 6473 7420 2b20  ock_q4_0*)dst + 
-00082680: 7374 6172 7420 2f20 514b 345f 303b 0a20  start / QK4_0;. 
-00082690: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000826a0: 6573 756c 7420 3d20 6767 6d6c 5f71 7561  esult = ggml_qua
-000826b0: 6e74 697a 655f 7134 5f30 2873 7263 202b  ntize_q4_0(src +
-000826c0: 2073 7461 7274 2c20 626c 6f63 6b2c 206e   start, block, n
-000826d0: 2c20 6e2c 2068 6973 7429 3b0a 2020 2020  , n, hist);.    
-000826e0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000826f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00082700: 4d4c 5f54 5950 455f 5134 5f31 3a0a 2020  ML_TYPE_Q4_1:.  
-00082710: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00082720: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00082730: 5f41 5353 4552 5428 7374 6172 7420 2520  _ASSERT(start % 
-00082740: 514b 345f 3120 3d3d 2030 293b 0a20 2020  QK4_1 == 0);.   
-00082750: 2020 2020 2020 2020 2020 2020 2062 6c6f               blo
-00082760: 636b 5f71 345f 3120 2a20 626c 6f63 6b20  ck_q4_1 * block 
-00082770: 3d20 2862 6c6f 636b 5f71 345f 312a 2964  = (block_q4_1*)d
-00082780: 7374 202b 2073 7461 7274 202f 2051 4b34  st + start / QK4
-00082790: 5f31 3b0a 2020 2020 2020 2020 2020 2020  _1;.            
-000827a0: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
-000827b0: 6c5f 7175 616e 7469 7a65 5f71 345f 3128  l_quantize_q4_1(
-000827c0: 7372 6320 2b20 7374 6172 742c 2062 6c6f  src + start, blo
-000827d0: 636b 2c20 6e2c 206e 2c20 6869 7374 293b  ck, n, n, hist);
-000827e0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000827f0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00082800: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-00082810: 303a 0a20 2020 2020 2020 2020 2020 207b  0:.            {
-00082820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082830: 2047 474d 4c5f 4153 5345 5254 2873 7461   GGML_ASSERT(sta
-00082840: 7274 2025 2051 4b35 5f30 203d 3d20 3029  rt % QK5_0 == 0)
-00082850: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00082860: 2020 626c 6f63 6b5f 7135 5f30 202a 2062    block_q5_0 * b
-00082870: 6c6f 636b 203d 2028 626c 6f63 6b5f 7135  lock = (block_q5
-00082880: 5f30 2a29 6473 7420 2b20 7374 6172 7420  _0*)dst + start 
-00082890: 2f20 514b 355f 303b 0a20 2020 2020 2020  / QK5_0;.       
-000828a0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-000828b0: 3d20 6767 6d6c 5f71 7561 6e74 697a 655f  = ggml_quantize_
-000828c0: 7135 5f30 2873 7263 202b 2073 7461 7274  q5_0(src + start
-000828d0: 2c20 626c 6f63 6b2c 206e 2c20 6e2c 2068  , block, n, n, h
-000828e0: 6973 7429 3b0a 2020 2020 2020 2020 2020  ist);.          
-000828f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00082900: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00082910: 455f 5135 5f31 3a0a 2020 2020 2020 2020  E_Q5_1:.        
-00082920: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00082930: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00082940: 5428 7374 6172 7420 2520 514b 355f 3120  T(start % QK5_1 
-00082950: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
-00082960: 2020 2020 2020 2062 6c6f 636b 5f71 355f         block_q5_
-00082970: 3120 2a20 626c 6f63 6b20 3d20 2862 6c6f  1 * block = (blo
-00082980: 636b 5f71 355f 312a 2964 7374 202b 2073  ck_q5_1*)dst + s
-00082990: 7461 7274 202f 2051 4b35 5f31 3b0a 2020  tart / QK5_1;.  
-000829a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000829b0: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
-000829c0: 7469 7a65 5f71 355f 3128 7372 6320 2b20  tize_q5_1(src + 
-000829d0: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
-000829e0: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
-000829f0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00082a00: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00082a10: 4c5f 5459 5045 5f51 385f 303a 0a20 2020  L_TYPE_Q8_0:.   
-00082a20: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00082a30: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00082a40: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
-00082a50: 4b38 5f30 203d 3d20 3029 3b0a 2020 2020  K8_0 == 0);.    
-00082a60: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-00082a70: 6b5f 7138 5f30 202a 2062 6c6f 636b 203d  k_q8_0 * block =
-00082a80: 2028 626c 6f63 6b5f 7138 5f30 2a29 6473   (block_q8_0*)ds
-00082a90: 7420 2b20 7374 6172 7420 2f20 514b 385f  t + start / QK8_
-00082aa0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00082ab0: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
-00082ac0: 5f71 7561 6e74 697a 655f 7138 5f30 2873  _quantize_q8_0(s
-00082ad0: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
-00082ae0: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
-00082af0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00082b00: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
-00082b10: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
-00082b20: 2020 6173 7365 7274 2866 616c 7365 293b    assert(false);
-00082b30: 0a20 2020 207d 0a20 2020 2072 6574 7572  .    }.    retur
-00082b40: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f2f  n result;.}..///
-00082b50: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000816e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000816f0: 2f2f 2f0a 0a73 697a 655f 7420 6767 6d6c  ///..size_t ggml
+00081700: 5f71 7561 6e74 697a 655f 7134 5f30 2863  _quantize_q4_0(c
+00081710: 6f6e 7374 2066 6c6f 6174 202a 2073 7263  onst float * src
+00081720: 2c20 766f 6964 202a 2064 7374 2c20 696e  , void * dst, in
+00081730: 7420 6e2c 2069 6e74 206b 2c20 696e 7436  t n, int k, int6
+00081740: 345f 7420 2a20 6869 7374 2920 7b0a 2020  4_t * hist) {.  
+00081750: 2020 6173 7365 7274 286b 2025 2051 4b34    assert(k % QK4
+00081760: 5f30 203d 3d20 3029 3b0a 2020 2020 636f  _0 == 0);.    co
+00081770: 6e73 7420 696e 7420 6e62 203d 206b 202f  nst int nb = k /
+00081780: 2051 4b34 5f30 3b0a 0a20 2020 2066 6f72   QK4_0;..    for
+00081790: 2028 696e 7420 6220 3d20 303b 2062 203c   (int b = 0; b <
+000817a0: 206e 3b20 6220 2b3d 206b 2920 7b0a 2020   n; b += k) {.  
+000817b0: 2020 2020 2020 626c 6f63 6b5f 7134 5f30        block_q4_0
+000817c0: 202a 2072 6573 7472 6963 7420 7920 3d20   * restrict y = 
+000817d0: 2862 6c6f 636b 5f71 345f 3020 2a29 2064  (block_q4_0 *) d
+000817e0: 7374 202b 2062 2f51 4b34 5f30 3b0a 0a20  st + b/QK4_0;.. 
+000817f0: 2020 2020 2020 2071 7561 6e74 697a 655f         quantize_
+00081800: 726f 775f 7134 5f30 5f72 6566 6572 656e  row_q4_0_referen
+00081810: 6365 2873 7263 202b 2062 2c20 792c 206b  ce(src + b, y, k
+00081820: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
+00081830: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00081840: 6e62 3b20 692b 2b29 207b 0a20 2020 2020  nb; i++) {.     
+00081850: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00081860: 6a20 3d20 303b 206a 203c 2051 4b34 5f30  j = 0; j < QK4_0
+00081870: 3b20 6a20 2b3d 2032 2920 7b0a 2020 2020  ; j += 2) {.    
+00081880: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00081890: 7420 7569 6e74 385f 7420 7669 3020 3d20  t uint8_t vi0 = 
+000818a0: 795b 695d 2e71 735b 6a2f 325d 2026 2030  y[i].qs[j/2] & 0
+000818b0: 7830 463b 0a20 2020 2020 2020 2020 2020  x0F;.           
+000818c0: 2020 2020 2063 6f6e 7374 2075 696e 7438       const uint8
+000818d0: 5f74 2076 6931 203d 2079 5b69 5d2e 7173  _t vi1 = y[i].qs
+000818e0: 5b6a 2f32 5d20 3e3e 2034 3b0a 0a20 2020  [j/2] >> 4;..   
+000818f0: 2020 2020 2020 2020 2020 2020 2068 6973               his
+00081900: 745b 7669 305d 2b2b 3b0a 2020 2020 2020  t[vi0]++;.      
+00081910: 2020 2020 2020 2020 2020 6869 7374 5b76            hist[v
+00081920: 6931 5d2b 2b3b 0a20 2020 2020 2020 2020  i1]++;.         
+00081930: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
+00081940: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
+00081950: 2028 6e2f 514b 345f 302a 7369 7a65 6f66   (n/QK4_0*sizeof
+00081960: 2862 6c6f 636b 5f71 345f 3029 293b 0a7d  (block_q4_0));.}
+00081970: 0a0a 7369 7a65 5f74 2067 676d 6c5f 7175  ..size_t ggml_qu
+00081980: 616e 7469 7a65 5f71 345f 3128 636f 6e73  antize_q4_1(cons
+00081990: 7420 666c 6f61 7420 2a20 7372 632c 2076  t float * src, v
+000819a0: 6f69 6420 2a20 6473 742c 2069 6e74 206e  oid * dst, int n
+000819b0: 2c20 696e 7420 6b2c 2069 6e74 3634 5f74  , int k, int64_t
+000819c0: 202a 2068 6973 7429 207b 0a20 2020 2061   * hist) {.    a
+000819d0: 7373 6572 7428 6b20 2520 514b 345f 3120  ssert(k % QK4_1 
+000819e0: 3d3d 2030 293b 0a20 2020 2063 6f6e 7374  == 0);.    const
+000819f0: 2069 6e74 206e 6220 3d20 6b20 2f20 514b   int nb = k / QK
+00081a00: 345f 313b 0a0a 2020 2020 666f 7220 2869  4_1;..    for (i
+00081a10: 6e74 2062 203d 2030 3b20 6220 3c20 6e3b  nt b = 0; b < n;
+00081a20: 2062 202b 3d20 6b29 207b 0a20 2020 2020   b += k) {.     
+00081a30: 2020 2062 6c6f 636b 5f71 345f 3120 2a20     block_q4_1 * 
+00081a40: 7265 7374 7269 6374 2079 203d 2028 626c  restrict y = (bl
+00081a50: 6f63 6b5f 7134 5f31 202a 2920 6473 7420  ock_q4_1 *) dst 
+00081a60: 2b20 622f 514b 345f 313b 0a0a 2020 2020  + b/QK4_1;..    
+00081a70: 2020 2020 7175 616e 7469 7a65 5f72 6f77      quantize_row
+00081a80: 5f71 345f 315f 7265 6665 7265 6e63 6528  _q4_1_reference(
+00081a90: 7372 6320 2b20 622c 2079 2c20 6b29 3b0a  src + b, y, k);.
+00081aa0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00081ab0: 7420 6920 3d20 303b 2069 203c 206e 623b  t i = 0; i < nb;
+00081ac0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00081ad0: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+00081ae0: 2030 3b20 6a20 3c20 514b 345f 313b 206a   0; j < QK4_1; j
+00081af0: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
+00081b00: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+00081b10: 696e 7438 5f74 2076 6930 203d 2079 5b69  int8_t vi0 = y[i
+00081b20: 5d2e 7173 5b6a 2f32 5d20 2620 3078 3046  ].qs[j/2] & 0x0F
+00081b30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00081b40: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
+00081b50: 7669 3120 3d20 795b 695d 2e71 735b 6a2f  vi1 = y[i].qs[j/
+00081b60: 325d 203e 3e20 343b 0a0a 2020 2020 2020  2] >> 4;..      
+00081b70: 2020 2020 2020 2020 2020 6869 7374 5b76            hist[v
+00081b80: 6930 5d2b 2b3b 0a20 2020 2020 2020 2020  i0]++;.         
+00081b90: 2020 2020 2020 2068 6973 745b 7669 315d         hist[vi1]
+00081ba0: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
+00081bb0: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+00081bc0: 7d0a 0a20 2020 2072 6574 7572 6e20 286e  }..    return (n
+00081bd0: 2f51 4b34 5f31 2a73 697a 656f 6628 626c  /QK4_1*sizeof(bl
+00081be0: 6f63 6b5f 7134 5f31 2929 3b0a 7d0a 0a73  ock_q4_1));.}..s
+00081bf0: 697a 655f 7420 6767 6d6c 5f71 7561 6e74  ize_t ggml_quant
+00081c00: 697a 655f 7135 5f30 2863 6f6e 7374 2066  ize_q5_0(const f
+00081c10: 6c6f 6174 202a 2073 7263 2c20 766f 6964  loat * src, void
+00081c20: 202a 2064 7374 2c20 696e 7420 6e2c 2069   * dst, int n, i
+00081c30: 6e74 206b 2c20 696e 7436 345f 7420 2a20  nt k, int64_t * 
+00081c40: 6869 7374 2920 7b0a 2020 2020 6173 7365  hist) {.    asse
+00081c50: 7274 286b 2025 2051 4b35 5f30 203d 3d20  rt(k % QK5_0 == 
+00081c60: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+00081c70: 7420 6e62 203d 206b 202f 2051 4b35 5f30  t nb = k / QK5_0
+00081c80: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00081c90: 6220 3d20 303b 2062 203c 206e 3b20 6220  b = 0; b < n; b 
+00081ca0: 2b3d 206b 2920 7b0a 2020 2020 2020 2020  += k) {.        
+00081cb0: 626c 6f63 6b5f 7135 5f30 202a 2072 6573  block_q5_0 * res
+00081cc0: 7472 6963 7420 7920 3d20 2862 6c6f 636b  trict y = (block
+00081cd0: 5f71 355f 3020 2a29 6473 7420 2b20 622f  _q5_0 *)dst + b/
+00081ce0: 514b 355f 303b 0a0a 2020 2020 2020 2020  QK5_0;..        
+00081cf0: 7175 616e 7469 7a65 5f72 6f77 5f71 355f  quantize_row_q5_
+00081d00: 305f 7265 6665 7265 6e63 6528 7372 6320  0_reference(src 
+00081d10: 2b20 622c 2079 2c20 6b29 3b0a 0a20 2020  + b, y, k);..   
+00081d20: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00081d30: 3d20 303b 2069 203c 206e 623b 2069 2b2b  = 0; i < nb; i++
+00081d40: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00081d50: 7569 6e74 3332 5f74 2071 683b 0a20 2020  uint32_t qh;.   
+00081d60: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+00081d70: 2671 682c 2026 795b 695d 2e71 682c 2073  &qh, &y[i].qh, s
+00081d80: 697a 656f 6628 7168 2929 3b0a 0a20 2020  izeof(qh));..   
+00081d90: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00081da0: 7420 6a20 3d20 303b 206a 203c 2051 4b35  t j = 0; j < QK5
+00081db0: 5f30 3b20 6a20 2b3d 2032 2920 7b0a 2020  _0; j += 2) {.  
+00081dc0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00081dd0: 6e73 7420 7569 6e74 385f 7420 7668 3020  nst uint8_t vh0 
+00081de0: 3d20 2828 7168 2026 2028 3175 203c 3c20  = ((qh & (1u << 
+00081df0: 286a 202b 2030 2029 2929 203e 3e20 286a  (j + 0 ))) >> (j
+00081e00: 202b 2030 2029 2920 3c3c 2034 3b0a 2020   + 0 )) << 4;.  
+00081e10: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00081e20: 6e73 7420 7569 6e74 385f 7420 7668 3120  nst uint8_t vh1 
+00081e30: 3d20 2828 7168 2026 2028 3175 203c 3c20  = ((qh & (1u << 
+00081e40: 286a 202b 2031 3629 2929 203e 3e20 286a  (j + 16))) >> (j
+00081e50: 202b 2031 3229 293b 0a0a 2020 2020 2020   + 12));..      
+00081e60: 2020 2020 2020 2020 2020 2f2f 2063 6173            // cas
+00081e70: 7420 746f 2031 3620 6269 6e73 0a20 2020  t to 16 bins.   
+00081e80: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00081e90: 7374 2075 696e 7438 5f74 2076 6930 203d  st uint8_t vi0 =
+00081ea0: 2028 2879 5b69 5d2e 7173 5b6a 2f32 5d20   ((y[i].qs[j/2] 
+00081eb0: 2620 3078 3046 2920 7c20 7668 3029 202f  & 0x0F) | vh0) /
+00081ec0: 2032 3b0a 2020 2020 2020 2020 2020 2020   2;.            
+00081ed0: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
+00081ee0: 7420 7669 3120 3d20 2828 795b 695d 2e71  t vi1 = ((y[i].q
+00081ef0: 735b 6a2f 325d 203e 3e20 2020 3429 207c  s[j/2] >>   4) |
+00081f00: 2076 6831 2920 2f20 323b 0a0a 2020 2020   vh1) / 2;..    
+00081f10: 2020 2020 2020 2020 2020 2020 6869 7374              hist
+00081f20: 5b76 6930 5d2b 2b3b 0a20 2020 2020 2020  [vi0]++;.       
+00081f30: 2020 2020 2020 2020 2068 6973 745b 7669           hist[vi
+00081f40: 315d 2b2b 3b0a 2020 2020 2020 2020 2020  1]++;.          
+00081f50: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+00081f60: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
+00081f70: 286e 2f51 4b35 5f30 2a73 697a 656f 6628  (n/QK5_0*sizeof(
+00081f80: 626c 6f63 6b5f 7135 5f30 2929 3b0a 7d0a  block_q5_0));.}.
+00081f90: 0a73 697a 655f 7420 6767 6d6c 5f71 7561  .size_t ggml_qua
+00081fa0: 6e74 697a 655f 7135 5f31 2863 6f6e 7374  ntize_q5_1(const
+00081fb0: 2066 6c6f 6174 202a 2073 7263 2c20 766f   float * src, vo
+00081fc0: 6964 202a 2064 7374 2c20 696e 7420 6e2c  id * dst, int n,
+00081fd0: 2069 6e74 206b 2c20 696e 7436 345f 7420   int k, int64_t 
+00081fe0: 2a20 6869 7374 2920 7b0a 2020 2020 6173  * hist) {.    as
+00081ff0: 7365 7274 286b 2025 2051 4b35 5f31 203d  sert(k % QK5_1 =
+00082000: 3d20 3029 3b0a 2020 2020 636f 6e73 7420  = 0);.    const 
+00082010: 696e 7420 6e62 203d 206b 202f 2051 4b35  int nb = k / QK5
+00082020: 5f31 3b0a 0a20 2020 2066 6f72 2028 696e  _1;..    for (in
+00082030: 7420 6220 3d20 303b 2062 203c 206e 3b20  t b = 0; b < n; 
+00082040: 6220 2b3d 206b 2920 7b0a 2020 2020 2020  b += k) {.      
+00082050: 2020 626c 6f63 6b5f 7135 5f31 202a 2072    block_q5_1 * r
+00082060: 6573 7472 6963 7420 7920 3d20 2862 6c6f  estrict y = (blo
+00082070: 636b 5f71 355f 3120 2a29 6473 7420 2b20  ck_q5_1 *)dst + 
+00082080: 622f 514b 355f 313b 0a0a 2020 2020 2020  b/QK5_1;..      
+00082090: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
+000820a0: 355f 315f 7265 6665 7265 6e63 6528 7372  5_1_reference(sr
+000820b0: 6320 2b20 622c 2079 2c20 6b29 3b0a 0a20  c + b, y, k);.. 
+000820c0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+000820d0: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
+000820e0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+000820f0: 2020 7569 6e74 3332 5f74 2071 683b 0a20    uint32_t qh;. 
+00082100: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
+00082110: 7928 2671 682c 2026 795b 695d 2e71 682c  y(&qh, &y[i].qh,
+00082120: 2073 697a 656f 6628 7168 2929 3b0a 0a20   sizeof(qh));.. 
+00082130: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00082140: 696e 7420 6a20 3d20 303b 206a 203c 2051  int j = 0; j < Q
+00082150: 4b35 5f31 3b20 6a20 2b3d 2032 2920 7b0a  K5_1; j += 2) {.
+00082160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082170: 636f 6e73 7420 7569 6e74 385f 7420 7668  const uint8_t vh
+00082180: 3020 3d20 2828 7168 2026 2028 3175 203c  0 = ((qh & (1u <
+00082190: 3c20 286a 202b 2030 2029 2929 203e 3e20  < (j + 0 ))) >> 
+000821a0: 286a 202b 2030 2029 2920 3c3c 2034 3b0a  (j + 0 )) << 4;.
+000821b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000821c0: 636f 6e73 7420 7569 6e74 385f 7420 7668  const uint8_t vh
+000821d0: 3120 3d20 2828 7168 2026 2028 3175 203c  1 = ((qh & (1u <
+000821e0: 3c20 286a 202b 2031 3629 2929 203e 3e20  < (j + 16))) >> 
+000821f0: 286a 202b 2031 3229 293b 0a0a 2020 2020  (j + 12));..    
+00082200: 2020 2020 2020 2020 2020 2020 2f2f 2063              // c
+00082210: 6173 7420 746f 2031 3620 6269 6e73 0a20  ast to 16 bins. 
+00082220: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00082230: 6f6e 7374 2075 696e 7438 5f74 2076 6930  onst uint8_t vi0
+00082240: 203d 2028 2879 5b69 5d2e 7173 5b6a 2f32   = ((y[i].qs[j/2
+00082250: 5d20 2620 3078 3046 2920 7c20 7668 3029  ] & 0x0F) | vh0)
+00082260: 202f 2032 3b0a 2020 2020 2020 2020 2020   / 2;.          
+00082270: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+00082280: 385f 7420 7669 3120 3d20 2828 795b 695d  8_t vi1 = ((y[i]
+00082290: 2e71 735b 6a2f 325d 203e 3e20 2020 3429  .qs[j/2] >>   4)
+000822a0: 207c 2076 6831 2920 2f20 323b 0a0a 2020   | vh1) / 2;..  
+000822b0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+000822c0: 7374 5b76 6930 5d2b 2b3b 0a20 2020 2020  st[vi0]++;.     
+000822d0: 2020 2020 2020 2020 2020 2068 6973 745b             hist[
+000822e0: 7669 315d 2b2b 3b0a 2020 2020 2020 2020  vi1]++;.        
+000822f0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+00082300: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
+00082310: 6e20 286e 2f51 4b35 5f31 2a73 697a 656f  n (n/QK5_1*sizeo
+00082320: 6628 626c 6f63 6b5f 7135 5f31 2929 3b0a  f(block_q5_1));.
+00082330: 7d0a 0a73 697a 655f 7420 6767 6d6c 5f71  }..size_t ggml_q
+00082340: 7561 6e74 697a 655f 7138 5f30 2863 6f6e  uantize_q8_0(con
+00082350: 7374 2066 6c6f 6174 202a 2073 7263 2c20  st float * src, 
+00082360: 766f 6964 202a 2064 7374 2c20 696e 7420  void * dst, int 
+00082370: 6e2c 2069 6e74 206b 2c20 696e 7436 345f  n, int k, int64_
+00082380: 7420 2a20 6869 7374 2920 7b0a 2020 2020  t * hist) {.    
+00082390: 6173 7365 7274 286b 2025 2051 4b38 5f30  assert(k % QK8_0
+000823a0: 203d 3d20 3029 3b0a 2020 2020 636f 6e73   == 0);.    cons
+000823b0: 7420 696e 7420 6e62 203d 206b 202f 2051  t int nb = k / Q
+000823c0: 4b38 5f30 3b0a 0a20 2020 2066 6f72 2028  K8_0;..    for (
+000823d0: 696e 7420 6220 3d20 303b 2062 203c 206e  int b = 0; b < n
+000823e0: 3b20 6220 2b3d 206b 2920 7b0a 2020 2020  ; b += k) {.    
+000823f0: 2020 2020 626c 6f63 6b5f 7138 5f30 202a      block_q8_0 *
+00082400: 2072 6573 7472 6963 7420 7920 3d20 2862   restrict y = (b
+00082410: 6c6f 636b 5f71 385f 3020 2a29 6473 7420  lock_q8_0 *)dst 
+00082420: 2b20 622f 514b 385f 303b 0a0a 2020 2020  + b/QK8_0;..    
+00082430: 2020 2020 7175 616e 7469 7a65 5f72 6f77      quantize_row
+00082440: 5f71 385f 305f 7265 6665 7265 6e63 6528  _q8_0_reference(
+00082450: 7372 6320 2b20 622c 2079 2c20 6b29 3b0a  src + b, y, k);.
+00082460: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00082470: 7420 6920 3d20 303b 2069 203c 206e 623b  t i = 0; i < nb;
+00082480: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00082490: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+000824a0: 2030 3b20 6a20 3c20 514b 385f 303b 202b   0; j < QK8_0; +
+000824b0: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+000824c0: 2020 2020 2020 636f 6e73 7420 696e 7438        const int8
+000824d0: 5f74 2076 6920 3d20 795b 695d 2e71 735b  _t vi = y[i].qs[
+000824e0: 6a5d 3b0a 0a20 2020 2020 2020 2020 2020  j];..           
+000824f0: 2020 2020 2068 6973 745b 7669 2f31 3620       hist[vi/16 
+00082500: 2b20 385d 2b2b 3b0a 2020 2020 2020 2020  + 8]++;.        
+00082510: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+00082520: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
+00082530: 6e20 286e 2f51 4b38 5f30 2a73 697a 656f  n (n/QK8_0*sizeo
+00082540: 6628 626c 6f63 6b5f 7138 5f30 2929 3b0a  f(block_q8_0));.
+00082550: 7d0a 0a73 697a 655f 7420 6767 6d6c 5f71  }..size_t ggml_q
+00082560: 7561 6e74 697a 655f 6368 756e 6b28 656e  uantize_chunk(en
+00082570: 756d 2067 676d 6c5f 7479 7065 2074 7970  um ggml_type typ
+00082580: 652c 2063 6f6e 7374 2066 6c6f 6174 202a  e, const float *
+00082590: 2073 7263 2c20 766f 6964 202a 2064 7374   src, void * dst
+000825a0: 2c20 696e 7420 7374 6172 742c 2069 6e74  , int start, int
+000825b0: 206e 2c20 696e 7436 345f 7420 2a20 6869   n, int64_t * hi
+000825c0: 7374 2920 7b0a 2020 2020 7369 7a65 5f74  st) {.    size_t
+000825d0: 2072 6573 756c 7420 3d20 303b 0a20 2020   result = 0;.   
+000825e0: 2073 7769 7463 6820 2874 7970 6529 207b   switch (type) {
+000825f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00082600: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
+00082610: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00082620: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00082630: 5f41 5353 4552 5428 7374 6172 7420 2520  _ASSERT(start % 
+00082640: 514b 345f 3020 3d3d 2030 293b 0a20 2020  QK4_0 == 0);.   
+00082650: 2020 2020 2020 2020 2020 2020 2062 6c6f               blo
+00082660: 636b 5f71 345f 3020 2a20 626c 6f63 6b20  ck_q4_0 * block 
+00082670: 3d20 2862 6c6f 636b 5f71 345f 302a 2964  = (block_q4_0*)d
+00082680: 7374 202b 2073 7461 7274 202f 2051 4b34  st + start / QK4
+00082690: 5f30 3b0a 2020 2020 2020 2020 2020 2020  _0;.            
+000826a0: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
+000826b0: 6c5f 7175 616e 7469 7a65 5f71 345f 3028  l_quantize_q4_0(
+000826c0: 7372 6320 2b20 7374 6172 742c 2062 6c6f  src + start, blo
+000826d0: 636b 2c20 6e2c 206e 2c20 6869 7374 293b  ck, n, n, hist);
+000826e0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000826f0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00082700: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
+00082710: 313a 0a20 2020 2020 2020 2020 2020 207b  1:.            {
+00082720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082730: 2047 474d 4c5f 4153 5345 5254 2873 7461   GGML_ASSERT(sta
+00082740: 7274 2025 2051 4b34 5f31 203d 3d20 3029  rt % QK4_1 == 0)
+00082750: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00082760: 2020 626c 6f63 6b5f 7134 5f31 202a 2062    block_q4_1 * b
+00082770: 6c6f 636b 203d 2028 626c 6f63 6b5f 7134  lock = (block_q4
+00082780: 5f31 2a29 6473 7420 2b20 7374 6172 7420  _1*)dst + start 
+00082790: 2f20 514b 345f 313b 0a20 2020 2020 2020  / QK4_1;.       
+000827a0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+000827b0: 3d20 6767 6d6c 5f71 7561 6e74 697a 655f  = ggml_quantize_
+000827c0: 7134 5f31 2873 7263 202b 2073 7461 7274  q4_1(src + start
+000827d0: 2c20 626c 6f63 6b2c 206e 2c20 6e2c 2068  , block, n, n, h
+000827e0: 6973 7429 3b0a 2020 2020 2020 2020 2020  ist);.          
+000827f0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00082800: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00082810: 455f 5135 5f30 3a0a 2020 2020 2020 2020  E_Q5_0:.        
+00082820: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00082830: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00082840: 5428 7374 6172 7420 2520 514b 355f 3020  T(start % QK5_0 
+00082850: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
+00082860: 2020 2020 2020 2062 6c6f 636b 5f71 355f         block_q5_
+00082870: 3020 2a20 626c 6f63 6b20 3d20 2862 6c6f  0 * block = (blo
+00082880: 636b 5f71 355f 302a 2964 7374 202b 2073  ck_q5_0*)dst + s
+00082890: 7461 7274 202f 2051 4b35 5f30 3b0a 2020  tart / QK5_0;.  
+000828a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000828b0: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
+000828c0: 7469 7a65 5f71 355f 3028 7372 6320 2b20  tize_q5_0(src + 
+000828d0: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
+000828e0: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
+000828f0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00082900: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00082910: 4c5f 5459 5045 5f51 355f 313a 0a20 2020  L_TYPE_Q5_1:.   
+00082920: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00082930: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00082940: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
+00082950: 4b35 5f31 203d 3d20 3029 3b0a 2020 2020  K5_1 == 0);.    
+00082960: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
+00082970: 6b5f 7135 5f31 202a 2062 6c6f 636b 203d  k_q5_1 * block =
+00082980: 2028 626c 6f63 6b5f 7135 5f31 2a29 6473   (block_q5_1*)ds
+00082990: 7420 2b20 7374 6172 7420 2f20 514b 355f  t + start / QK5_
+000829a0: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+000829b0: 2020 2072 6573 756c 7420 3d20 6767 6d6c     result = ggml
+000829c0: 5f71 7561 6e74 697a 655f 7135 5f31 2873  _quantize_q5_1(s
+000829d0: 7263 202b 2073 7461 7274 2c20 626c 6f63  rc + start, bloc
+000829e0: 6b2c 206e 2c20 6e2c 2068 6973 7429 3b0a  k, n, n, hist);.
+000829f0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00082a00: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00082a10: 6520 4747 4d4c 5f54 5950 455f 5138 5f30  e GGML_TYPE_Q8_0
+00082a20: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00082a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082a40: 4747 4d4c 5f41 5353 4552 5428 7374 6172  GGML_ASSERT(star
+00082a50: 7420 2520 514b 385f 3020 3d3d 2030 293b  t % QK8_0 == 0);
+00082a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082a70: 2062 6c6f 636b 5f71 385f 3020 2a20 626c   block_q8_0 * bl
+00082a80: 6f63 6b20 3d20 2862 6c6f 636b 5f71 385f  ock = (block_q8_
+00082a90: 302a 2964 7374 202b 2073 7461 7274 202f  0*)dst + start /
+00082aa0: 2051 4b38 5f30 3b0a 2020 2020 2020 2020   QK8_0;.        
+00082ab0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00082ac0: 2067 676d 6c5f 7175 616e 7469 7a65 5f71   ggml_quantize_q
+00082ad0: 385f 3028 7372 6320 2b20 7374 6172 742c  8_0(src + start,
+00082ae0: 2062 6c6f 636b 2c20 6e2c 206e 2c20 6869   block, n, n, hi
+00082af0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
+00082b00: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00082b10: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
+00082b20: 2020 2020 2020 2061 7373 6572 7428 6661         assert(fa
+00082b30: 6c73 6529 3b0a 2020 2020 7d0a 2020 2020  lse);.    }.    
+00082b40: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
+00082b50: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
 00082b60: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00082b70: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00082b80: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00082b90: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a 0a69  /////////////..i
-00082ba0: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
-00082bb0: 6176 7828 766f 6964 2920 7b0a 2369 6620  avx(void) {.#if 
-00082bc0: 6465 6669 6e65 6428 5f5f 4156 585f 5f29  defined(__AVX__)
-00082bd0: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
-00082be0: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
-00082bf0: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
-00082c00: 2067 676d 6c5f 6370 755f 6861 735f 6176   ggml_cpu_has_av
-00082c10: 7832 2876 6f69 6429 207b 0a23 6966 2064  x2(void) {.#if d
-00082c20: 6566 696e 6564 285f 5f41 5658 325f 5f29  efined(__AVX2__)
-00082c30: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
-00082c40: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
-00082c50: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
-00082c60: 2067 676d 6c5f 6370 755f 6861 735f 6176   ggml_cpu_has_av
-00082c70: 7835 3132 2876 6f69 6429 207b 0a23 6966  x512(void) {.#if
-00082c80: 2064 6566 696e 6564 285f 5f41 5658 3531   defined(__AVX51
-00082c90: 3246 5f5f 290a 2020 2020 7265 7475 726e  2F__).    return
-00082ca0: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
-00082cb0: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
-00082cc0: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
-00082cd0: 6173 5f61 7678 3531 325f 7662 6d69 2876  as_avx512_vbmi(v
-00082ce0: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
-00082cf0: 6564 285f 5f41 5658 3531 3256 424d 495f  ed(__AVX512VBMI_
-00082d00: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
-00082d10: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
-00082d20: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
-00082d30: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
-00082d40: 6176 7835 3132 5f76 6e6e 6928 766f 6964  avx512_vnni(void
-00082d50: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
-00082d60: 5f5f 4156 5835 3132 564e 4e49 5f5f 290a  __AVX512VNNI__).
-00082d70: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
-00082d80: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
-00082d90: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
-00082da0: 6767 6d6c 5f63 7075 5f68 6173 5f66 6d61  ggml_cpu_has_fma
-00082db0: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
-00082dc0: 696e 6564 285f 5f46 4d41 5f5f 290a 2020  ined(__FMA__).  
-00082dd0: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
-00082de0: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
-00082df0: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
-00082e00: 6d6c 5f63 7075 5f68 6173 5f6e 656f 6e28  ml_cpu_has_neon(
-00082e10: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
-00082e20: 6e65 6428 5f5f 4152 4d5f 4e45 4f4e 290a  ned(__ARM_NEON).
-00082e30: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
-00082e40: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
-00082e50: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
-00082e60: 6767 6d6c 5f63 7075 5f68 6173 5f61 726d  ggml_cpu_has_arm
-00082e70: 5f66 6d61 2876 6f69 6429 207b 0a23 6966  _fma(void) {.#if
-00082e80: 2064 6566 696e 6564 285f 5f41 524d 5f46   defined(__ARM_F
-00082e90: 4541 5455 5245 5f46 4d41 290a 2020 2020  EATURE_FMA).    
-00082ea0: 7265 7475 726e 2031 3b0a 2365 6c73 650a  return 1;.#else.
-00082eb0: 2020 2020 7265 7475 726e 2030 3b0a 2365      return 0;.#e
-00082ec0: 6e64 6966 0a7d 0a0a 696e 7420 6767 6d6c  ndif.}..int ggml
-00082ed0: 5f63 7075 5f68 6173 5f66 3136 6328 766f  _cpu_has_f16c(vo
-00082ee0: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
-00082ef0: 6428 5f5f 4631 3643 5f5f 290a 2020 2020  d(__F16C__).    
-00082f00: 7265 7475 726e 2031 3b0a 2365 6c73 650a  return 1;.#else.
-00082f10: 2020 2020 7265 7475 726e 2030 3b0a 2365      return 0;.#e
-00082f20: 6e64 6966 0a7d 0a0a 696e 7420 6767 6d6c  ndif.}..int ggml
-00082f30: 5f63 7075 5f68 6173 5f66 7031 365f 7661  _cpu_has_fp16_va
-00082f40: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
-00082f50: 696e 6564 285f 5f41 524d 5f46 4541 5455  ined(__ARM_FEATU
-00082f60: 5245 5f46 5031 365f 5645 4354 4f52 5f41  RE_FP16_VECTOR_A
-00082f70: 5249 5448 4d45 5449 4329 0a20 2020 2072  RITHMETIC).    r
-00082f80: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
-00082f90: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
-00082fa0: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
-00082fb0: 6370 755f 6861 735f 7761 736d 5f73 696d  cpu_has_wasm_sim
-00082fc0: 6428 766f 6964 2920 7b0a 2369 6620 6465  d(void) {.#if de
-00082fd0: 6669 6e65 6428 5f5f 7761 736d 5f73 696d  fined(__wasm_sim
-00082fe0: 6431 3238 5f5f 290a 2020 2020 7265 7475  d128__).    retu
-00082ff0: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
-00083000: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
-00083010: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
-00083020: 5f68 6173 5f62 6c61 7328 766f 6964 2920  _has_blas(void) 
-00083030: 7b0a 2369 6620 6465 6669 6e65 6428 4747  {.#if defined(GG
-00083040: 4d4c 5f55 5345 5f41 4343 454c 4552 4154  ML_USE_ACCELERAT
-00083050: 4529 207c 7c20 6465 6669 6e65 6428 4747  E) || defined(GG
-00083060: 4d4c 5f55 5345 5f4f 5045 4e42 4c41 5329  ML_USE_OPENBLAS)
-00083070: 207c 7c20 6465 6669 6e65 6428 4747 4d4c   || defined(GGML
-00083080: 5f55 5345 5f43 5542 4c41 5329 207c 7c20  _USE_CUBLAS) || 
-00083090: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-000830a0: 5f43 4c42 4c41 5354 290a 2020 2020 7265  _CLBLAST).    re
-000830b0: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
-000830c0: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
-000830d0: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
-000830e0: 7075 5f68 6173 5f63 7562 6c61 7328 766f  pu_has_cublas(vo
-000830f0: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
-00083100: 6428 4747 4d4c 5f55 5345 5f43 5542 4c41  d(GGML_USE_CUBLA
-00083110: 5329 0a20 2020 2072 6574 7572 6e20 313b  S).    return 1;
-00083120: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
-00083130: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
-00083140: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
-00083150: 636c 626c 6173 7428 766f 6964 2920 7b0a  clblast(void) {.
-00083160: 2369 6620 6465 6669 6e65 6428 4747 4d4c  #if defined(GGML
-00083170: 5f55 5345 5f43 4c42 4c41 5354 290a 2020  _USE_CLBLAST).  
-00083180: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
-00083190: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
-000831a0: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
-000831b0: 6d6c 5f63 7075 5f68 6173 5f67 7075 626c  ml_cpu_has_gpubl
-000831c0: 6173 2876 6f69 6429 207b 0a20 2020 2072  as(void) {.    r
-000831d0: 6574 7572 6e20 6767 6d6c 5f63 7075 5f68  eturn ggml_cpu_h
-000831e0: 6173 5f63 7562 6c61 7328 2920 7c7c 2067  as_cublas() || g
-000831f0: 676d 6c5f 6370 755f 6861 735f 636c 626c  gml_cpu_has_clbl
-00083200: 6173 7428 293b 0a7d 0a0a 696e 7420 6767  ast();.}..int gg
-00083210: 6d6c 5f63 7075 5f68 6173 5f73 7365 3328  ml_cpu_has_sse3(
-00083220: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
-00083230: 6e65 6428 5f5f 5353 4533 5f5f 290a 2020  ned(__SSE3__).  
-00083240: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
-00083250: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
-00083260: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
-00083270: 6d6c 5f63 7075 5f68 6173 5f76 7378 2876  ml_cpu_has_vsx(v
-00083280: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
-00083290: 6564 285f 5f50 4f57 4552 395f 5645 4354  ed(__POWER9_VECT
-000832a0: 4f52 5f5f 290a 2020 2020 7265 7475 726e  OR__).    return
-000832b0: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
-000832c0: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
-000832d0: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
+00082b90: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00082ba0: 2f2f 0a0a 696e 7420 6767 6d6c 5f63 7075  //..int ggml_cpu
+00082bb0: 5f68 6173 5f61 7678 2876 6f69 6429 207b  _has_avx(void) {
+00082bc0: 0a23 6966 2064 6566 696e 6564 285f 5f41  .#if defined(__A
+00082bd0: 5658 5f5f 290a 2020 2020 7265 7475 726e  VX__).    return
+00082be0: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
+00082bf0: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
+00082c00: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
+00082c10: 6173 5f61 7678 3228 766f 6964 2920 7b0a  as_avx2(void) {.
+00082c20: 2369 6620 6465 6669 6e65 6428 5f5f 4156  #if defined(__AV
+00082c30: 5832 5f5f 290a 2020 2020 7265 7475 726e  X2__).    return
+00082c40: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
+00082c50: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
+00082c60: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
+00082c70: 6173 5f61 7678 3531 3228 766f 6964 2920  as_avx512(void) 
+00082c80: 7b0a 2369 6620 6465 6669 6e65 6428 5f5f  {.#if defined(__
+00082c90: 4156 5835 3132 465f 5f29 0a20 2020 2072  AVX512F__).    r
+00082ca0: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+00082cb0: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+00082cc0: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
+00082cd0: 6370 755f 6861 735f 6176 7835 3132 5f76  cpu_has_avx512_v
+00082ce0: 626d 6928 766f 6964 2920 7b0a 2369 6620  bmi(void) {.#if 
+00082cf0: 6465 6669 6e65 6428 5f5f 4156 5835 3132  defined(__AVX512
+00082d00: 5642 4d49 5f5f 290a 2020 2020 7265 7475  VBMI__).    retu
+00082d10: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
+00082d20: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
+00082d30: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
+00082d40: 5f68 6173 5f61 7678 3531 325f 766e 6e69  _has_avx512_vnni
+00082d50: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
+00082d60: 696e 6564 285f 5f41 5658 3531 3256 4e4e  ined(__AVX512VNN
+00082d70: 495f 5f29 0a20 2020 2072 6574 7572 6e20  I__).    return 
+00082d80: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
+00082d90: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
+00082da0: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
+00082db0: 735f 666d 6128 766f 6964 2920 7b0a 2369  s_fma(void) {.#i
+00082dc0: 6620 6465 6669 6e65 6428 5f5f 464d 415f  f defined(__FMA_
+00082dd0: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
+00082de0: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+00082df0: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+00082e00: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+00082e10: 6e65 6f6e 2876 6f69 6429 207b 0a23 6966  neon(void) {.#if
+00082e20: 2064 6566 696e 6564 285f 5f41 524d 5f4e   defined(__ARM_N
+00082e30: 454f 4e29 0a20 2020 2072 6574 7572 6e20  EON).    return 
+00082e40: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
+00082e50: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
+00082e60: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
+00082e70: 735f 6172 6d5f 666d 6128 766f 6964 2920  s_arm_fma(void) 
+00082e80: 7b0a 2369 6620 6465 6669 6e65 6428 5f5f  {.#if defined(__
+00082e90: 4152 4d5f 4645 4154 5552 455f 464d 4129  ARM_FEATURE_FMA)
+00082ea0: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
+00082eb0: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
+00082ec0: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
+00082ed0: 2067 676d 6c5f 6370 755f 6861 735f 6631   ggml_cpu_has_f1
+00082ee0: 3663 2876 6f69 6429 207b 0a23 6966 2064  6c(void) {.#if d
+00082ef0: 6566 696e 6564 285f 5f46 3136 435f 5f29  efined(__F16C__)
+00082f00: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
+00082f10: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
+00082f20: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
+00082f30: 2067 676d 6c5f 6370 755f 6861 735f 6670   ggml_cpu_has_fp
+00082f40: 3136 5f76 6128 766f 6964 2920 7b0a 2369  16_va(void) {.#i
+00082f50: 6620 6465 6669 6e65 6428 5f5f 4152 4d5f  f defined(__ARM_
+00082f60: 4645 4154 5552 455f 4650 3136 5f56 4543  FEATURE_FP16_VEC
+00082f70: 544f 525f 4152 4954 484d 4554 4943 290a  TOR_ARITHMETIC).
+00082f80: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+00082f90: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+00082fa0: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+00082fb0: 6767 6d6c 5f63 7075 5f68 6173 5f77 6173  ggml_cpu_has_was
+00082fc0: 6d5f 7369 6d64 2876 6f69 6429 207b 0a23  m_simd(void) {.#
+00082fd0: 6966 2064 6566 696e 6564 285f 5f77 6173  if defined(__was
+00082fe0: 6d5f 7369 6d64 3132 385f 5f29 0a20 2020  m_simd128__).   
+00082ff0: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+00083000: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+00083010: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+00083020: 6c5f 6370 755f 6861 735f 626c 6173 2876  l_cpu_has_blas(v
+00083030: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
+00083040: 6564 2847 474d 4c5f 5553 455f 4143 4345  ed(GGML_USE_ACCE
+00083050: 4c45 5241 5445 2920 7c7c 2064 6566 696e  LERATE) || defin
+00083060: 6564 2847 474d 4c5f 5553 455f 4f50 454e  ed(GGML_USE_OPEN
+00083070: 424c 4153 2920 7c7c 2064 6566 696e 6564  BLAS) || defined
+00083080: 2847 474d 4c5f 5553 455f 4355 424c 4153  (GGML_USE_CUBLAS
+00083090: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
+000830a0: 4c5f 5553 455f 434c 424c 4153 5429 0a20  L_USE_CLBLAST). 
+000830b0: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
+000830c0: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
+000830d0: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
+000830e0: 676d 6c5f 6370 755f 6861 735f 6375 626c  gml_cpu_has_cubl
+000830f0: 6173 2876 6f69 6429 207b 0a23 6966 2064  as(void) {.#if d
+00083100: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
+00083110: 4355 424c 4153 290a 2020 2020 7265 7475  CUBLAS).    retu
+00083120: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
+00083130: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
+00083140: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
+00083150: 5f68 6173 5f63 6c62 6c61 7374 2876 6f69  _has_clblast(voi
+00083160: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
+00083170: 2847 474d 4c5f 5553 455f 434c 424c 4153  (GGML_USE_CLBLAS
+00083180: 5429 0a20 2020 2072 6574 7572 6e20 313b  T).    return 1;
+00083190: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+000831a0: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+000831b0: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+000831c0: 6770 7562 6c61 7328 766f 6964 2920 7b0a  gpublas(void) {.
+000831d0: 2020 2020 7265 7475 726e 2067 676d 6c5f      return ggml_
+000831e0: 6370 755f 6861 735f 6375 626c 6173 2829  cpu_has_cublas()
+000831f0: 207c 7c20 6767 6d6c 5f63 7075 5f68 6173   || ggml_cpu_has
+00083200: 5f63 6c62 6c61 7374 2829 3b0a 7d0a 0a69  _clblast();.}..i
+00083210: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+00083220: 7373 6533 2876 6f69 6429 207b 0a23 6966  sse3(void) {.#if
+00083230: 2064 6566 696e 6564 285f 5f53 5345 335f   defined(__SSE3_
+00083240: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
+00083250: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+00083260: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+00083270: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+00083280: 7673 7828 766f 6964 2920 7b0a 2369 6620  vsx(void) {.#if 
+00083290: 6465 6669 6e65 6428 5f5f 504f 5745 5239  defined(__POWER9
+000832a0: 5f56 4543 544f 525f 5f29 0a20 2020 2072  _VECTOR__).    r
+000832b0: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
+000832c0: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
+000832d0: 6469 660a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f  dif.}../////////
 000832e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 000832f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00083300: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
 00083310: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00083320: 2f2f 0a                                  //.
+00083320: 2f2f 2f2f 2f2f 2f0a                      ///////.
```

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/CMakeLists.txt` & `ggml-python-0.0.6/vendor/ggml/tests/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-blas0.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-blas0.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-grad0.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-grad0.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-mul-mat0.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-mul-mat0.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-mul-mat1.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-mul-mat1.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-mul-mat2.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-mul-mat2.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-svd0.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-svd0.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-vec0.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-vec0.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-vec1.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-vec1.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test-vec2.c` & `ggml-python-0.0.6/vendor/ggml/tests/test-vec2.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test0.c` & `ggml-python-0.0.6/vendor/ggml/tests/test0.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test1.c` & `ggml-python-0.0.6/vendor/ggml/tests/test1.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test2.c` & `ggml-python-0.0.6/vendor/ggml/tests/test2.c`

 * *Files identical despite different names*

### Comparing `ggml_python-0.0.4/vendor/ggml/tests/test3.c` & `ggml-python-0.0.6/vendor/ggml/tests/test3.c`

 * *Files identical despite different names*

