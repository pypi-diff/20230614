# Comparing `tmp/odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4-py3-none-any.whl.zip` & `tmp/odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,23 +1,24 @@
-Zip file size: 16623 bytes, number of entries: 21
--rw-r--r--  2.0 unx     2094 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/README.rst
--rw-r--r--  2.0 unx      164 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/__init__.py
--rw-r--r--  2.0 unx      609 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/__manifest__.py
--rw-r--r--  2.0 unx      765 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/data/ir_cron.xml
--rw-r--r--  2.0 unx      356 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/data/queue_job_function_data.xml
--rw-r--r--  2.0 unx     4489 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/i18n/shopinvader_cart_expiry.pot
--rw-r--r--  2.0 unx      179 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/models/__init__.py
--rw-r--r--  2.0 unx     1442 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/models/sale_order.py
--rw-r--r--  2.0 unx     2219 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/models/shopinvader_backend.py
--rw-r--r--  2.0 unx       43 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      213 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx       28 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/services/__init__.py
--rw-r--r--  2.0 unx      472 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/services/abstract_sale.py
--rw-r--r--  2.0 unx    11049 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/static/description/index.html
--rw-r--r--  2.0 unx      151 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/tests/__init__.py
--rw-r--r--  2.0 unx     6023 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/tests/test_cart_expiry.py
--rw-r--r--  2.0 unx     1195 b- defN 22-Feb-11 07:45 odoo/addons/shopinvader_cart_expiry/views/shopinvader_backend.xml
--rw-r--r--  2.0 unx     2652 b- defN 22-Feb-11 07:45 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Feb-11 07:45 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 22-Feb-11 07:45 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     2396 b- defN 22-Feb-11 07:45 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/RECORD
-21 files, 36636 bytes uncompressed, 12467 bytes compressed:  66.0%
+Zip file size: 17287 bytes, number of entries: 22
+-rw-r--r--  2.0 unx     2094 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/README.rst
+-rw-r--r--  2.0 unx      164 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/__init__.py
+-rw-r--r--  2.0 unx      609 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/__manifest__.py
+-rw-r--r--  2.0 unx      765 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/data/ir_cron.xml
+-rw-r--r--  2.0 unx      356 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/data/queue_job_function_data.xml
+-rw-r--r--  2.0 unx     4489 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/i18n/shopinvader_cart_expiry.pot
+-rw-r--r--  2.0 unx      645 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/migrations/14.0.1.0.1/post-migrate.py
+-rw-r--r--  2.0 unx      179 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/models/__init__.py
+-rw-r--r--  2.0 unx     1442 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/models/sale_order.py
+-rw-r--r--  2.0 unx     2173 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/models/shopinvader_backend.py
+-rw-r--r--  2.0 unx       43 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      213 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx       28 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/services/__init__.py
+-rw-r--r--  2.0 unx      472 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/services/abstract_sale.py
+-rw-r--r--  2.0 unx    11049 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/static/description/index.html
+-rw-r--r--  2.0 unx      151 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/tests/__init__.py
+-rw-r--r--  2.0 unx     6366 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/tests/test_cart_expiry.py
+-rw-r--r--  2.0 unx     1195 b- defN 23-Jun-14 14:26 odoo/addons/shopinvader_cart_expiry/views/shopinvader_backend.xml
+-rw-r--r--  2.0 unx     2647 b- defN 23-Jun-14 14:26 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-14 14:26 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jun-14 14:26 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     2505 b- defN 23-Jun-14 14:26 odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/RECORD
+22 files, 37682 bytes uncompressed, 12949 bytes compressed:  65.6%
```

## zipnote {}

```diff
@@ -12,14 +12,17 @@
 
 Filename: odoo/addons/shopinvader_cart_expiry/data/queue_job_function_data.xml
 Comment: 
 
 Filename: odoo/addons/shopinvader_cart_expiry/i18n/shopinvader_cart_expiry.pot
 Comment: 
 
+Filename: odoo/addons/shopinvader_cart_expiry/migrations/14.0.1.0.1/post-migrate.py
+Comment: 
+
 Filename: odoo/addons/shopinvader_cart_expiry/models/__init__.py
 Comment: 
 
 Filename: odoo/addons/shopinvader_cart_expiry/models/sale_order.py
 Comment: 
 
 Filename: odoo/addons/shopinvader_cart_expiry/models/shopinvader_backend.py
@@ -45,20 +48,20 @@
 
 Filename: odoo/addons/shopinvader_cart_expiry/tests/test_cart_expiry.py
 Comment: 
 
 Filename: odoo/addons/shopinvader_cart_expiry/views/shopinvader_backend.xml
 Comment: 
 
-Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/METADATA
+Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/METADATA
 Comment: 
 
-Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/WHEEL
+Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/WHEEL
 Comment: 
 
-Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/top_level.txt
+Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/RECORD
+Filename: odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/shopinvader_cart_expiry/__manifest__.py

```diff
@@ -2,15 +2,15 @@
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl.html).
 {
     "name": "Shopinvader cart expiry",
     "summary": """Shopinvader module to manage an expiry delay on cart""",
     "author": "ACSONE SA/NV",
     "website": "https://github.com/shopinvader/odoo-shopinvader",
     "category": "e-commerce",
-    "version": "14.0.1.0.0",
+    "version": "14.0.1.0.2",
     "license": "AGPL-3",
     "depends": ["shopinvader"],
     "data": [
         "data/ir_cron.xml",
         "views/shopinvader_backend.xml",
         "data/queue_job_function_data.xml",
     ],
```

## odoo/addons/shopinvader_cart_expiry/models/shopinvader_backend.py

```diff
@@ -37,20 +37,19 @@
             description = _("Manage cart expired for backend %s") % backend.name
             backend.with_delay(description=description).manage_cart_expiry()
 
     def _get_cart_expiry_delay_domain(self):
         expiry_date = fields.Datetime.from_string(fields.Datetime.now())
         delta_arg = {self.cart_expiry_delay_unit: self.cart_expiry_delay}
         expiry_date -= timedelta(**delta_arg)
-        expiry_date = fields.Datetime.to_string(expiry_date)
         domain = [
             ("shopinvader_backend_id", "=", self.id),
             ("typology", "=", "cart"),
             ("state", "=", "draft"),
-            ("write_date", "<=", expiry_date),
+            ("last_external_update_date", "<=", expiry_date),
         ]
         return domain
 
     def manage_cart_expiry(self):
         self.ensure_one()
         cart_expired = self.env["sale.order"].search(
             self._get_cart_expiry_delay_domain()
```

## odoo/addons/shopinvader_cart_expiry/tests/test_cart_expiry.py

```diff
@@ -14,16 +14,17 @@
     Tests for cart expiry
     """
 
     def setUp(self):
         super().setUp()
         self.sale_obj = self.env["sale.order"]
         self.partner = self.env.ref("shopinvader.partner_1")
-        self.sale = self.env.ref("shopinvader.sale_order_2")
-        self.cart = self.env.ref("shopinvader.sale_order_2")
+        self.sale = self.cart = self.env.ref("shopinvader.sale_order_1")
+        self.cart.write({"last_external_update_date": fields.Datetime.now()})
+        self.so_date = self.cart.last_external_update_date
         self.shopinvader_session = {"cart_id": self.cart.id}
         with self.work_on_services(
             partner=None, shopinvader_session=self.shopinvader_session
         ) as work:
             self.service = work.component(usage="cart")
 
     def test_cart_expiry_scheduler(self):
@@ -47,35 +48,36 @@
         self.backend.write({"cart_expiry_delay": 1, "cart_expiry_policy": "cancel"})
         now_method = "odoo.fields.Datetime.now"
         with mock.patch(now_method) as mock_now:
             mock_now.return_value = today
             expiration_date = so_date + timedelta(days=1)
             self.assertEqual(expiration_date, self.sale.cart_expiration_date)
             cart = self.service.search()
-            self.assertDictContainsSubset(
-                {"expiration_date": expiration_date}, cart.get("data")
+            self.assertEqual(
+                self.sale.cart_expiration_date,
+                cart.get("data", {}).get("expiration_date"),
             )
 
     def test_cart_expiry_cancel(self):
-        so_date = fields.Datetime.from_string(self.sale.write_date)
+        so_date = fields.Datetime.from_string(self.so_date)
         today = fields.Datetime.to_string(so_date + timedelta(hours=5))
         self.backend.write({"cart_expiry_delay": 1, "cart_expiry_policy": "cancel"})
         now_method = "odoo.fields.Datetime.now"
         with mock.patch(now_method) as mock_now:
             mock_now.return_value = today
             self.backend.manage_cart_expiry()
             self.assertEqual(self.sale.state, "draft")
         today = fields.Datetime.to_string(so_date + timedelta(days=2))
         with mock.patch(now_method) as mock_now:
             mock_now.return_value = today
             self.backend.manage_cart_expiry()
             self.assertEqual(self.sale.state, "cancel")
 
     def test_cart_expiry_delete(self):
-        so_date = fields.Datetime.from_string(self.sale.write_date)
+        so_date = fields.Datetime.from_string(self.so_date)
         today = fields.Datetime.to_string(so_date + timedelta(hours=5))
         self.backend.write({"cart_expiry_delay": 1, "cart_expiry_policy": "delete"})
         now_method = "odoo.fields.Datetime.now"
         with mock.patch(now_method) as mock_now:
             mock_now.return_value = today
             self.backend.manage_cart_expiry()
             self.assertEqual(self.sale.state, "draft")
@@ -108,38 +110,45 @@
                 },
             )
             self.shopinvader_session["cart_id"] = response["set_session"]["cart_id"]
             sale = self.env["sale.order"].browse(
                 self.shopinvader_session.get("cart_id")
             )
             cart = self.service.search()
-            self.assertDictContainsSubset(
-                {"expiration_date": sale.cart_expiration_date},
-                cart.get("data"),
+            self.assertEqual(
+                sale.cart_expiration_date, cart.get("data", {}).get("expiration_date")
             )
 
     def test_cart_expiry_not_draft(self):
         """
         Ensure the cart is not deleted/canceled when the state is not draft.
         :return:
         """
-        so_date = fields.Datetime.from_string(self.sale.write_date)
+        so_date = fields.Datetime.from_string(self.so_date)
         today = fields.Datetime.to_string(so_date + timedelta(hours=5))
         self.sale.write({"state": "sent"})
         self.backend.write({"cart_expiry_delay": 1, "cart_expiry_policy": "cancel"})
         now_method = "odoo.fields.Datetime.now"
         with mock.patch(now_method) as mock_now:
             mock_now.return_value = today
             self.backend.manage_cart_expiry()
             # The state still "sent"
             self.assertEqual(self.sale.state, "sent")
 
-        today = fields.Datetime.to_string(so_date + timedelta(days=2))
+        today = fields.Datetime.to_string(so_date + timedelta(days=3))
         with mock.patch(now_method) as mock_now:
             mock_now.return_value = today
             self.backend.manage_cart_expiry()
             self.assertTrue(self.sale.exists())
             self.assertEqual(self.sale.state, "sent")
             # Then re-update the cart to draft state
-            self.sale.write({"state": "draft"})
+        self.sale.write(
+            {
+                "state": "draft",
+                "last_external_update_date": so_date - timedelta(days=1),
+            }
+        )
+        self.sale.flush(["state", "last_external_update_date"])
+        with mock.patch(now_method) as mock_now:
+            mock_now.return_value = today
             self.backend.manage_cart_expiry()
             self.assertEqual(self.sale.state, "cancel")
```

## Comparing `odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/METADATA` & `odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/METADATA`

 * *Files 4% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo14-addon-shopinvader-cart-expiry
-Version: 14.0.1.0.1.dev4
+Version: 14.0.1.0.2
 Summary: Shopinvader module to manage an expiry delay on cart
 Home-page: https://github.com/shopinvader/odoo-shopinvader
 Author: ACSONE SA/NV
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
 Classifier: Framework :: Odoo
```

## Comparing `odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/RECORD` & `odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/RECORD`

 * *Files 12% similar despite different names*

```diff
@@ -1,21 +1,22 @@
 odoo/addons/shopinvader_cart_expiry/README.rst,sha256=zF4pwkWJZs-2eSnQoEpWkTG7XNWy8bs1Oy4EYOBZGQM,2094
 odoo/addons/shopinvader_cart_expiry/__init__.py,sha256=mBM0FKHUfBqYEHxJaazM5eOTP71V1G7g0LQKRmwHcLA,164
-odoo/addons/shopinvader_cart_expiry/__manifest__.py,sha256=ZztD3saJQoGnZoFw5CbtlVR3dcz5uGH_1gqDAKOwH4Q,609
+odoo/addons/shopinvader_cart_expiry/__manifest__.py,sha256=mira1dDkn1S79pAOr27S6m2UEMwhRZoltO1Is4F-bEo,609
 odoo/addons/shopinvader_cart_expiry/data/ir_cron.xml,sha256=_OG0UNNlAfq_RpXXkyMDcJaCtxh5J1czhEvB34R7RsM,765
 odoo/addons/shopinvader_cart_expiry/data/queue_job_function_data.xml,sha256=GDO2jAcbESsj6_tFkBQ-qEbMZIY0iKWx2HGIMvbvtYM,356
 odoo/addons/shopinvader_cart_expiry/i18n/shopinvader_cart_expiry.pot,sha256=3po5_wsIpMF4QlI9C-LkA9pG68B1M3JIF5811rMP-gs,4489
+odoo/addons/shopinvader_cart_expiry/migrations/14.0.1.0.1/post-migrate.py,sha256=p5Cyn135U_z0tNi5dfMyClaRxgse4BJ5joK7IwHDfYg,645
 odoo/addons/shopinvader_cart_expiry/models/__init__.py,sha256=L_q6kopRo8aIaIAFMmXSndgwi-DCfQcR40Wivi7y-MQ,179
 odoo/addons/shopinvader_cart_expiry/models/sale_order.py,sha256=oidORs4G4vIt7ifLjDjhNnpUSqEgFIArQjKfLOS7BRw,1442
-odoo/addons/shopinvader_cart_expiry/models/shopinvader_backend.py,sha256=5dN0c_oH7hKuWrZEVXjerokukhRdenPDUK26FT7M-zg,2219
+odoo/addons/shopinvader_cart_expiry/models/shopinvader_backend.py,sha256=wJ_ksxePVMbFZDnfn3o3J-4IqA4fgkgR0fEErUuvPTU,2173
 odoo/addons/shopinvader_cart_expiry/readme/CONTRIBUTORS.rst,sha256=YuP5LI_dAp9nvlxIK-hAvAWgEcMAd3a5p1me0RiEUMs,43
 odoo/addons/shopinvader_cart_expiry/readme/DESCRIPTION.rst,sha256=_iBrsPXuaQghgY_K5CWcskaASxeoop0MnVq8xDZHlhs,213
 odoo/addons/shopinvader_cart_expiry/services/__init__.py,sha256=M10sPi1VlX7vB6rEf4EegMae-btiTh2xlShiKfuMXpU,28
 odoo/addons/shopinvader_cart_expiry/services/abstract_sale.py,sha256=mz19ibJXu2SYlRSqAvUd9pmmWR3BI2pyUywrXivlgRI,472
 odoo/addons/shopinvader_cart_expiry/static/description/index.html,sha256=nza6XcpEIhE2u-mtdCvBJX9i5-OrMNQ4hnFXMMv5Y5o,11049
 odoo/addons/shopinvader_cart_expiry/tests/__init__.py,sha256=yKjeWJe3bXCLvsSlNlK5V0sWcqXvilTPLhCtiR9KljA,151
-odoo/addons/shopinvader_cart_expiry/tests/test_cart_expiry.py,sha256=BiBp3s6-40qTv8m6y6Z5U8WSHWJHblJ0Lze4NxhdaQ0,6023
+odoo/addons/shopinvader_cart_expiry/tests/test_cart_expiry.py,sha256=c6_U7OB8IyQh5uHIxqmdmwD8m0MnI29sOZLY5eH9z-4,6366
 odoo/addons/shopinvader_cart_expiry/views/shopinvader_backend.xml,sha256=wlcyJrPK86t_e4V-sOJ7o-tA7H1KcuPNXwu3Yigd3i0,1195
-odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/METADATA,sha256=fDSzSJAcm0Dr-NhIo56v43y54VnSMxg0aK130J-1xeQ,2652
-odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/WHEEL,sha256=ewwEueio1C2XeHTvT17n8dZUJgOvyCWCt0WVNLClP9o,92
-odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo14_addon_shopinvader_cart_expiry-14.0.1.0.1.dev4.dist-info/RECORD,,
+odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/METADATA,sha256=NkK22LMHm5UZdNj8nYZSoHmjWOAXDDqKmhdSh9FxAuA,2647
+odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/WHEEL,sha256=ewwEueio1C2XeHTvT17n8dZUJgOvyCWCt0WVNLClP9o,92
+odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo14_addon_shopinvader_cart_expiry-14.0.1.0.2.dist-info/RECORD,,
```

